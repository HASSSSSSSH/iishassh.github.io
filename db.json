{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon.svg","path":"images/apple-touch-icon.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.jpg","path":"images/avatar.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/images/blog-avatar.jpg","path":"images/blog-avatar.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/default-avatar.gif","path":"images/default-avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-battery-three-quarters-solid.svg","path":"images/favicon-battery-three-quarters-solid.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/grin-beam-sweat-regular.svg","path":"images/grin-beam-sweat-regular.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo-battery-three-quarters-solid.svg","path":"images/logo-battery-three-quarters-solid.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/js/algolia-search.js","path":"js/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/bookmark.js","path":"js/bookmark.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/local-search.js","path":"js/local-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/motion.js","path":"js/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/next-boot.js","path":"js/next-boot.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/anime.min.js","path":"lib/anime.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/pisces.js","path":"js/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/all.min.css","path":"lib/font-awesome/css/all.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","path":"lib/font-awesome/webfonts/fa-brands-400.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","path":"lib/font-awesome/webfonts/fa-regular-400.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","path":"lib/font-awesome/webfonts/fa-solid-900.woff2","modified":0,"renderable":1}],"Cache":[{"_id":"source/_drafts/time-complexity.md","hash":"bd7a14baa9ecb9814b3b215ead85290a5298ea36","modified":1616143136046},{"_id":"source/_posts/2021-02-18-hello-world.md","hash":"375cabeccbb68577dd2bf0875e0e91cc0c240681","modified":1615277369854},{"_id":"source/_posts/2021-02-19-signed-number-representations.md","hash":"ec841ab335d62609b221e8cb463f9d3368de8d97","modified":1616765079315},{"_id":"source/_posts/2021-03-10-elementary-function.md","hash":"0d7f40a41b3f73cdd8fc2dfcdca11bff510ca44d","modified":1616765423792},{"_id":"source/_posts/2021-03-18-hello-world.md","hash":"43859b8a4425f3e136daf4da5baa6b6b557bab1b","modified":1616764061868},{"_id":"source/_posts/2021-03-24-android-display-refresh.md","hash":"6a6702fcc021171c38cd6db995ef95a2285c79a2","modified":1617010195302},{"_id":"source/_posts/2021-03-25-android-sync-barrier.md","hash":"d5da4815228e4962617af7ba4bacacd1ce5b144a","modified":1616764506555},{"_id":"source/categories/index.md","hash":"29e653793b807ae1c092a4e1e000e3143c18b34f","modified":1615277369854},{"_id":"source/tags/index.md","hash":"47f28e8150e19e9fca41b4ada4d07b10b5d3ccc8","modified":1615277369855},{"_id":"source/_posts/2021-03-10-elementary-function/constant-function-example-1.png","hash":"55c373adc656ab40de3d6254caa3889f83daf30d","modified":1615463242154},{"_id":"source/_posts/2021-03-10-elementary-function/exponential-function-example-1.png","hash":"5414817c47e8074111a09cfc262354c5e89c7ec3","modified":1615865031412},{"_id":"source/_posts/2021-03-10-elementary-function/exponential-function-example-2.png","hash":"e07d060308e0fe9565a2bc7159d6f71d116d61e3","modified":1615865491659},{"_id":"source/_posts/2021-03-10-elementary-function/logarithmic-function-example-1.png","hash":"aa4861ff8de3896b9a56191f4ffb362bc17c1862","modified":1615985075948},{"_id":"source/_posts/2021-03-10-elementary-function/logarithmic-function-example-2.png","hash":"d44781054882732d63cf4d091f55ad791aff6553","modified":1615985453826},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-1.png","hash":"3f476e9bbe7f0660cdb591a8852d0cf4c4d26d9b","modified":1615462750860},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-3.png","hash":"c6cf26bc00b680a675ea0fb67753ad28e182a2da","modified":1615532219227},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-4.png","hash":"5c98bc47edb22e4f29362aea7fbe742cbddba10d","modified":1615532273687},{"_id":"source/.DS_Store","hash":"91cb1e82549470603862b9e72a2cf083413daf53","modified":1636529842205},{"_id":"source/_posts/.DS_Store","hash":"9c0d907de7a04fae1856acd79f6aae2806856125","modified":1636530043090},{"_id":"source/_posts/2021-03-10-elementary-function/.DS_Store","hash":"e7e1d82885f856c4df675eed58e30e3c2f73fe3a","modified":1616053765333},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-7.png","hash":"9eeb028343bc4861d960fb0555885aa38eb56d6e","modified":1615795241661},{"_id":"source/_posts/2021-03-10-elementary-function/logarithmic-function-example-3.png","hash":"e96d95ece9a7c6c4cd9b9406046bbba6bb66420a","modified":1616053740900},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-2.png","hash":"a165e01dfc0a34615eb0d16138e56194dae0996c","modified":1615464078663},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-5.png","hash":"0d3924bb93913b1219297b81f530b3619ba601f0","modified":1615532750674},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-6.png","hash":"668098f02428d80435c283f45d388902be161dec","modified":1615532929622},{"_id":"themes/next/_config.yml","hash":"62d4eab09d9a160fc6ab4a312f14e8e3c1c2bfd1","modified":1616747926042},{"_id":"themes/next/.DS_Store","hash":"7606faed203a263021bc6e703c7182abd99eede6","modified":1614254822809},{"_id":"themes/next/LICENSE.md","hash":"18144d8ed58c75af66cb419d54f3f63374cd5c5b","modified":1615277369855},{"_id":"themes/next/package.json","hash":"62fad6de02adbbba9fb096cbe2dcc15fe25f2435","modified":1615277369887},{"_id":"themes/next/README.md","hash":"9b4b7d66aca47f9c65d6321b14eef48d95c4dff1","modified":1615277369855},{"_id":"themes/next/crowdin.yml","hash":"e026078448c77dcdd9ef50256bb6635a8f83dca6","modified":1615277369856},{"_id":"themes/next/gulpfile.js","hash":"1b4fc262b89948937b9e3794de812a7c1f2f3592","modified":1615277369862},{"_id":"themes/next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1615277369856},{"_id":"themes/next/docs/INSTALLATION.md","hash":"af88bcce035780aaa061261ed9d0d6c697678618","modified":1615277369857},{"_id":"themes/next/docs/LICENSE.txt","hash":"368bf2c29d70f27d8726dd914f1b3211cae4bbab","modified":1615277369858},{"_id":"themes/next/docs/MATH.md","hash":"d645b025ec7fb9fbf799b9bb76af33b9f5b9ed93","modified":1615277369858},{"_id":"themes/next/languages/ar.yml","hash":"9815e84e53d750c8bcbd9193c2d44d8d910e3444","modified":1615277369862},{"_id":"themes/next/docs/LEANCLOUD-COUNTER-SECURITY.md","hash":"94dc3404ccb0e5f663af2aa883c1af1d6eae553d","modified":1615277369858},{"_id":"themes/next/languages/de.yml","hash":"74c59f2744217003b717b59d96e275b54635abf5","modified":1615277369862},{"_id":"themes/next/languages/es.yml","hash":"c64cf05f356096f1464b4b1439da3c6c9b941062","modified":1615277369863},{"_id":"themes/next/languages/default.yml","hash":"45bc5118828bdc72dcaa25282cd367c8622758cb","modified":1615277369863},{"_id":"themes/next/languages/fa.yml","hash":"3676b32fda37e122f3c1a655085a1868fb6ad66b","modified":1615277369863},{"_id":"themes/next/languages/hu.yml","hash":"b1ebb77a5fd101195b79f94de293bcf9001d996f","modified":1615277369864},{"_id":"themes/next/languages/fr.yml","hash":"752bf309f46a2cd43890b82300b342d7218d625f","modified":1615277369863},{"_id":"themes/next/languages/en.yml","hash":"45bc5118828bdc72dcaa25282cd367c8622758cb","modified":1615277369863},{"_id":"themes/next/languages/id.yml","hash":"572ed855d47aafe26f58c73b1394530754881ec2","modified":1615277369864},{"_id":"themes/next/languages/it.yml","hash":"44759f779ce9c260b895532de1d209ad4bd144bf","modified":1615277369864},{"_id":"themes/next/languages/ja.yml","hash":"0cf0baa663d530f22ff380a051881216d6adcdd8","modified":1615277369864},{"_id":"themes/next/languages/ko.yml","hash":"0feea9e43cd399f3610b94d755a39fff1d371e97","modified":1615277369864},{"_id":"themes/next/languages/nl.yml","hash":"5af3473d9f22897204afabc08bb984b247493330","modified":1615277369865},{"_id":"themes/next/languages/pt-BR.yml","hash":"67555b1ba31a0242b12fc6ce3add28531160e35b","modified":1615277369865},{"_id":"themes/next/languages/pt.yml","hash":"718d131f42f214842337776e1eaddd1e9a584054","modified":1615277369865},{"_id":"themes/next/languages/tr.yml","hash":"fe793f4c2608e3f85f0b872fd0ac1fb93e6155e2","modified":1615277369866},{"_id":"themes/next/languages/uk.yml","hash":"3a6d635b1035423b22fc86d9455dba9003724de9","modified":1615277369866},{"_id":"themes/next/languages/ru.yml","hash":"e993d5ca072f7f6887e30fc0c19b4da791ca7a88","modified":1615277369865},{"_id":"themes/next/languages/vi.yml","hash":"93393b01df148dcbf0863f6eee8e404e2d94ef9e","modified":1615277369866},{"_id":"themes/next/languages/zh-CN.yml","hash":"ccfa3076422eb3176f6437d1726c8bdfb47d515d","modified":1628232825050},{"_id":"themes/next/languages/zh-TW.yml","hash":"8c09da7c4ec3fca2c6ee897b2eea260596a2baa1","modified":1615277369867},{"_id":"themes/next/layout/_layout.swig","hash":"6a6e92a4664cdb981890a27ac11fd057f44de1d5","modified":1615277369867},{"_id":"themes/next/languages/zh-HK.yml","hash":"3789f94010f948e9f23e21235ef422a191753c65","modified":1615277369867},{"_id":"themes/next/layout/archive.swig","hash":"654c8c3183141f1d33854abf932ce65276874567","modified":1615277369885},{"_id":"themes/next/docs/UPDATE-FROM-5.1.X.md","hash":"8b6e4b2c9cfcb969833092bdeaed78534082e3e6","modified":1615277369858},{"_id":"themes/next/layout/category.swig","hash":"1bde61cf4d2d171647311a0ac2c5c7933f6a53b0","modified":1615277369885},{"_id":"themes/next/layout/index.swig","hash":"7f403a18a68e6d662ae3e154b2c1d3bbe0801a23","modified":1615277369886},{"_id":"themes/next/layout/page.swig","hash":"db581bdeac5c75fabb0f17d7c5e746e47f2a9168","modified":1615277369886},{"_id":"themes/next/layout/tag.swig","hash":"0dfb653bd5de980426d55a0606d1ab122bd8c017","modified":1615277369887},{"_id":"themes/next/layout/post.swig","hash":"2f6d992ced7e067521fdce05ffe4fd75481f41c5","modified":1615277369886},{"_id":"themes/next/scripts/renderer.js","hash":"49a65df2028a1bc24814dc72fa50d52231ca4f05","modified":1615277369894},{"_id":"themes/next/docs/ru/DATA-FILES.md","hash":"0bd2d696f62a997a11a7d84fec0130122234174e","modified":1615277369859},{"_id":"themes/next/docs/ru/README.md","hash":"85dd68ed1250897a8e4a444a53a68c1d49eb7e11","modified":1615277369859},{"_id":"themes/next/source/.DS_Store","hash":"4d0efe53164d971f7998dc349a83838666784a10","modified":1614254824883},{"_id":"themes/next/docs/ru/INSTALLATION.md","hash":"9c4fe2873123bf9ceacab5c50d17d8a0f1baef27","modified":1615277369859},{"_id":"themes/next/docs/ru/UPDATE-FROM-5.1.X.md","hash":"5237a368ab99123749d724b6c379415f2c142a96","modified":1615277369859},{"_id":"themes/next/docs/zh-CN/ALGOLIA-SEARCH.md","hash":"34b88784ec120dfdc20fa82aadeb5f64ef614d14","modified":1615277369860},{"_id":"themes/next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"fb23b85db6f7d8279d73ae1f41631f92f64fc864","modified":1615277369860},{"_id":"themes/next/docs/zh-CN/CONTRIBUTING.md","hash":"d3f03be036b75dc71cf3c366cd75aee7c127c874","modified":1615277369860},{"_id":"themes/next/docs/zh-CN/DATA-FILES.md","hash":"ca1030efdfca5e20f9db2e7a428998e66a24c0d0","modified":1615277369860},{"_id":"themes/next/docs/zh-CN/INSTALLATION.md","hash":"579c7bd8341873fb8be4732476d412814f1a3df7","modified":1615277369861},{"_id":"themes/next/docs/zh-CN/LEANCLOUD-COUNTER-SECURITY.md","hash":"8b18f84503a361fc712b0fe4d4568e2f086ca97d","modified":1615277369861},{"_id":"themes/next/docs/zh-CN/MATH.md","hash":"b92585d251f1f9ebe401abb5d932cb920f9b8b10","modified":1615277369861},{"_id":"themes/next/docs/zh-CN/README.md","hash":"c038629ff8f3f24e8593c4c8ecf0bef3a35c750d","modified":1615277369861},{"_id":"themes/next/docs/zh-CN/UPDATE-FROM-5.1.X.md","hash":"d9ce7331c1236bbe0a551d56cef2405e47e65325","modified":1615277369862},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"9c8dc0b8170679cdc1ee9ee8dbcbaebf3f42897b","modified":1615277369868},{"_id":"themes/next/layout/_macro/post.swig","hash":"b16867f15b537012c91880d1629343242cd11fdf","modified":1628232783756},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"71655ca21907e9061b6e8ac52d0d8fbf54d0062b","modified":1615277369868},{"_id":"themes/next/layout/_partials/comments.swig","hash":"db6ab5421b5f4b7cb32ac73ad0e053fdf065f83e","modified":1615277369868},{"_id":"themes/next/layout/_partials/footer.swig","hash":"4369b313cbbeae742cb35f86d23d99d4285f7359","modified":1615277369869},{"_id":"themes/next/layout/_partials/languages.swig","hash":"ba9e272f1065b8f0e8848648caa7dea3f02c6be1","modified":1615277369870},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"9876dbfc15713c7a47d4bcaa301f4757bd978269","modified":1615277369871},{"_id":"themes/next/layout/_partials/widgets.swig","hash":"83a40ce83dfd5cada417444fb2d6f5470aae6bb0","modified":1615277369873},{"_id":"themes/next/layout/_scripts/index.swig","hash":"cea942b450bcb0f352da78d76dc6d6f1d23d5029","modified":1615277369873},{"_id":"themes/next/layout/_scripts/noscript.swig","hash":"d1f2bfde6f1da51a2b35a7ab9e7e8eb6eefd1c6b","modified":1615277369873},{"_id":"themes/next/layout/_scripts/pjax.swig","hash":"4d2c93c66e069852bb0e3ea2e268d213d07bfa3f","modified":1615277369874},{"_id":"themes/next/layout/_scripts/three.swig","hash":"a4f42f2301866bd25a784a2281069d8b66836d0b","modified":1615277369875},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"ef38c213679e7b6d2a4116f56c9e55d678446069","modified":1615277369875},{"_id":"themes/next/layout/_third-party/baidu-push.swig","hash":"b782eb2e34c0c15440837040b5d65b093ab6ec04","modified":1615277369876},{"_id":"themes/next/layout/_third-party/index.swig","hash":"70c3c01dd181de81270c57f3d99b6d8f4c723404","modified":1615277369879},{"_id":"themes/next/layout/_third-party/quicklink.swig","hash":"311e5eceec9e949f1ea8d623b083cec0b8700ff2","modified":1615277369881},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"2731e262a6b88eaee2a3ca61e6a3583a7f594702","modified":1615277369881},{"_id":"themes/next/scripts/events/index.js","hash":"5743cde07f3d2aa11532a168a652e52ec28514fd","modified":1615277369887},{"_id":"themes/next/scripts/filters/default-injects.js","hash":"aec50ed57b9d5d3faf2db3c88374f107203617e0","modified":1615277369891},{"_id":"themes/next/scripts/filters/front-matter.js","hash":"703bdd142a671b4b67d3d9dfb4a19d1dd7e7e8f7","modified":1615277369892},{"_id":"themes/next/scripts/filters/locals.js","hash":"b193a936ee63451f09f8886343dcfdca577c0141","modified":1615277369892},{"_id":"themes/next/scripts/filters/minify.js","hash":"19985723b9f677ff775f3b17dcebf314819a76ac","modified":1615277369892},{"_id":"themes/next/scripts/filters/post.js","hash":"44ba9b1c0bdda57590b53141306bb90adf0678db","modified":1615277369892},{"_id":"themes/next/scripts/helpers/engine.js","hash":"bdb424c3cc0d145bd0c6015bb1d2443c8a9c6cda","modified":1615277369893},{"_id":"themes/next/scripts/helpers/font.js","hash":"40cf00e9f2b7aa6e5f33d412e03ed10304b15fd7","modified":1615277369893},{"_id":"themes/next/scripts/helpers/next-config.js","hash":"5e11f30ddb5093a88a687446617a46b048fa02e5","modified":1615277369893},{"_id":"themes/next/scripts/helpers/next-url.js","hash":"958e86b2bd24e4fdfcbf9ce73e998efe3491a71f","modified":1615277369894},{"_id":"themes/next/scripts/tags/button.js","hash":"8c6b45f36e324820c919a822674703769e6da32c","modified":1615277369894},{"_id":"themes/next/scripts/tags/caniuse.js","hash":"94e0bbc7999b359baa42fa3731bdcf89c79ae2b3","modified":1615277369894},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"f1826ade2d135e2f60e2d95cb035383685b3370c","modified":1615277369895},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"d902fd313e8d35c3cc36f237607c2a0536c9edf1","modified":1615277369895},{"_id":"themes/next/scripts/tags/label.js","hash":"fc5b267d903facb7a35001792db28b801cccb1f8","modified":1615277369895},{"_id":"themes/next/scripts/tags/mermaid.js","hash":"983c6c4adea86160ecc0ba2204bc312aa338121d","modified":1615277369895},{"_id":"themes/next/scripts/tags/note.js","hash":"0a02bb4c15aec41f6d5f1271cdb5c65889e265d9","modified":1615277369895},{"_id":"themes/next/scripts/tags/pdf.js","hash":"8c613b39e7bff735473e35244b5629d02ee20618","modified":1615277369896},{"_id":"themes/next/scripts/tags/tabs.js","hash":"93d8a734a3035c1d3f04933167b500517557ba3e","modified":1615277369896},{"_id":"themes/next/scripts/tags/video.js","hash":"e5ff4c44faee604dd3ea9db6b222828c4750c227","modified":1615277369896},{"_id":"themes/next/source/css/_colors.styl","hash":"a8442520f719d3d7a19811cb3b85bcfd4a596e1f","modified":1615277369896},{"_id":"themes/next/source/css/_mixins.styl","hash":"e31a557f8879c2f4d8d5567ee1800b3e03f91f6e","modified":1615277369911},{"_id":"themes/next/source/css/main.styl","hash":"a3a3bbb5a973052f0186b3523911cb2539ff7b88","modified":1615277369917},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1615277369918},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1615277369918},{"_id":"themes/next/source/images/apple-touch-icon.svg","hash":"8293fb6815dd0d4a0024233dea9e884a54692c60","modified":1615277369918},{"_id":"themes/next/source/images/.DS_Store","hash":"294a69515384b339cd3a962a16c9f903a5649162","modified":1614307452503},{"_id":"themes/next/source/images/avatar.jpg","hash":"69ade96200fc246b4380344045d4fe941e76e969","modified":1615277369918},{"_id":"themes/next/source/images/blog-avatar.jpg","hash":"5b33e00552a500b4524574c02fec40717cd16cc7","modified":1615277369919},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1615277369919},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1615277369919},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1615277369920},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1615277369920},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1615277369920},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1615277369920},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1615277369921},{"_id":"themes/next/source/images/default-avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1615277369921},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1615277369921},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1615277369921},{"_id":"themes/next/source/images/favicon-battery-three-quarters-solid.svg","hash":"8293fb6815dd0d4a0024233dea9e884a54692c60","modified":1615277369921},{"_id":"themes/next/source/images/grin-beam-sweat-regular.svg","hash":"a2bd6f9258b83d9a4f18d34930cbf1638b3385aa","modified":1615277369922},{"_id":"themes/next/source/images/logo-battery-three-quarters-solid.svg","hash":"8293fb6815dd0d4a0024233dea9e884a54692c60","modified":1615277369922},{"_id":"themes/next/source/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1615277369922},{"_id":"themes/next/source/js/algolia-search.js","hash":"498d233eb5c7af6940baf94c1a1c36fdf1dd2636","modified":1615277369922},{"_id":"themes/next/source/js/bookmark.js","hash":"9734ebcb9b83489686f5c2da67dc9e6157e988ad","modified":1615277369922},{"_id":"themes/next/source/js/local-search.js","hash":"35ccf100d8f9c0fd6bfbb7fa88c2a76c42a69110","modified":1615277369923},{"_id":"themes/next/source/js/motion.js","hash":"72df86f6dfa29cce22abeff9d814c9dddfcf13a9","modified":1615277369923},{"_id":"themes/next/source/js/next-boot.js","hash":"a1b0636423009d4a4e4cea97bcbf1842bfab582c","modified":1615277369923},{"_id":"themes/next/source/js/utils.js","hash":"730cca7f164eaf258661a61ff3f769851ff1e5da","modified":1615277369924},{"_id":"themes/next/source/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1615277369924},{"_id":"themes/next/layout/_partials/head/head-unique.swig","hash":"000bad572d76ee95d9c0a78f9ccdc8d97cc7d4b4","modified":1615277369869},{"_id":"themes/next/layout/_partials/head/head.swig","hash":"810d544019e4a8651b756dd23e5592ee851eda71","modified":1615277369869},{"_id":"themes/next/layout/_partials/header/index.swig","hash":"7dbe93b8297b746afb89700b4d29289556e85267","modified":1615277369869},{"_id":"themes/next/layout/_partials/header/brand.swig","hash":"c70f8e71e026e878a4e9d5ab3bbbf9b0b23c240c","modified":1615277369869},{"_id":"themes/next/layout/_partials/header/menu-item.swig","hash":"9440d8a3a181698b80e1fa47f5104f4565d8cdf3","modified":1615277369870},{"_id":"themes/next/layout/_partials/header/menu.swig","hash":"d31f896680a6c2f2c3f5128b4d4dd46c87ce2130","modified":1615277369870},{"_id":"themes/next/layout/_partials/header/sub-menu.swig","hash":"ae2261bea836581918a1c2b0d1028a78718434e0","modified":1615277369870},{"_id":"themes/next/layout/_partials/page/page-header.swig","hash":"9b7a66791d7822c52117fe167612265356512477","modified":1615277369871},{"_id":"themes/next/layout/_partials/page/breadcrumb.swig","hash":"c851717497ca64789f2176c9ecd1dedab237b752","modified":1615277369870},{"_id":"themes/next/layout/_partials/post/post-followme.swig","hash":"ceba16b9bd3a0c5c8811af7e7e49d0f9dcb2f41e","modified":1615277369871},{"_id":"themes/next/layout/_partials/post/post-copyright.swig","hash":"954ad71536b6eb08bd1f30ac6e2f5493b69d1c04","modified":1615277369871},{"_id":"themes/next/layout/_partials/post/post-related.swig","hash":"f79c44692451db26efce704813f7a8872b7e63a0","modified":1615277369872},{"_id":"themes/next/layout/_partials/post/post-footer.swig","hash":"8f14f3f8a1b2998d5114cc56b680fb5c419a6b07","modified":1615277369871},{"_id":"themes/next/layout/_partials/post/post-reward.swig","hash":"2b1a73556595c37951e39574df5a3f20b2edeaef","modified":1615277369872},{"_id":"themes/next/layout/_partials/search/index.swig","hash":"2be50f9bfb1c56b85b3b6910a7df27f51143632c","modified":1615277369872},{"_id":"themes/next/layout/_partials/search/algolia-search.swig","hash":"48430bd03b8f19c9b8cdb2642005ed67d56c6e0b","modified":1615277369872},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"f48a6a8eba04eb962470ce76dd731e13074d4c45","modified":1615277369872},{"_id":"themes/next/layout/_partials/sidebar/site-overview.swig","hash":"c46849e0af8f8fb78baccd40d2af14df04a074af","modified":1615277369873},{"_id":"themes/next/layout/_scripts/pages/schedule.swig","hash":"077b5d66f6309f2e7dcf08645058ff2e03143e6c","modified":1615277369874},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1615277369874},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1615277369874},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1615277369875},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1615277369875},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"4790058691b7d36cf6d2d6b4e93795a7b8d608ad","modified":1615277369875},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"2fa2b51d56bfac6a1ea76d651c93b9c20b01c09b","modified":1615277369876},{"_id":"themes/next/layout/_third-party/analytics/growingio.swig","hash":"5adea065641e8c55994dd2328ddae53215604928","modified":1615277369876},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"1472cabb0181f60a6a0b7fec8899a4d03dfb2040","modified":1615277369876},{"_id":"themes/next/layout/_third-party/chat/tidio.swig","hash":"cba0e6e0fad08568a9e74ba9a5bee5341cfc04c1","modified":1615277369877},{"_id":"themes/next/layout/_third-party/chat/chatra.swig","hash":"f910618292c63871ca2e6c6e66c491f344fa7b1f","modified":1615277369876},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"f39a5bf3ce9ee9adad282501235e0c588e4356ec","modified":1615277369877},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"b14908644225d78c864cd0a9b60c52407de56183","modified":1615277369878},{"_id":"themes/next/layout/_third-party/comments/disqusjs.swig","hash":"82f5b6822aa5ec958aa987b101ef860494c6cf1f","modified":1615277369878},{"_id":"themes/next/layout/_third-party/comments/gitalk.swig","hash":"d6ceb70648555338a80ae5724b778c8c58d7060d","modified":1615277369878},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"f7a9eca599a682479e8ca863db59be7c9c7508c8","modified":1615277369879},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"be0a8eccf1f6dc21154af297fc79555343031277","modified":1615277369879},{"_id":"themes/next/layout/_third-party/math/index.swig","hash":"6c5976621efd5db5f7c4c6b4f11bc79d6554885f","modified":1615277369880},{"_id":"themes/next/layout/_third-party/math/katex.swig","hash":"4791c977a730f29c846efcf6c9c15131b9400ead","modified":1615277369880},{"_id":"themes/next/layout/_third-party/math/mathjax.swig","hash":"ecf751321e799f0fb3bf94d049e535130e2547aa","modified":1615277369880},{"_id":"themes/next/layout/_third-party/search/algolia-search.swig","hash":"d35a999d67f4c302f76fdf13744ceef3c6506481","modified":1615277369881},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"767b6c714c22588bcd26ba70b0fc19b6810cbacd","modified":1615277369882},{"_id":"themes/next/layout/_third-party/search/swiftype.swig","hash":"ba0dbc06b9d244073a1c681ff7a722dcbf920b51","modified":1615277369882},{"_id":"themes/next/layout/_third-party/statistics/busuanzi-counter.swig","hash":"06aa847371cc5a412dfb4751b354d65f6af7830c","modified":1615277369882},{"_id":"themes/next/layout/_third-party/statistics/cnzz-analytics.swig","hash":"a17ace37876822327a2f9306a472974442c9005d","modified":1615277369883},{"_id":"themes/next/layout/_third-party/statistics/firestore.swig","hash":"b26ac2bfbe91dd88267f8b96aee6bb222b265b7a","modified":1615277369883},{"_id":"themes/next/layout/_third-party/statistics/index.swig","hash":"5f6a966c509680dbfa70433f9d658cee59c304d7","modified":1615277369883},{"_id":"themes/next/layout/_third-party/statistics/lean-analytics.swig","hash":"d56d5af427cdfecc33a0f62ee62c056b4e33d095","modified":1615277369884},{"_id":"themes/next/layout/_third-party/tags/mermaid.swig","hash":"f3c43664a071ff3c0b28bd7e59b5523446829576","modified":1615277369884},{"_id":"themes/next/layout/_third-party/tags/pdf.swig","hash":"d30b0e255a8092043bac46441243f943ed6fb09b","modified":1615277369885},{"_id":"themes/next/scripts/events/lib/config.js","hash":"d34c6040b13649714939f59be5175e137de65ede","modified":1615277369888},{"_id":"themes/next/scripts/events/lib/injects-point.js","hash":"6661c1c91c7cbdefc6a5e6a034b443b8811235a1","modified":1615277369888},{"_id":"themes/next/scripts/events/lib/injects.js","hash":"f233d8d0103ae7f9b861344aa65c1a3c1de8a845","modified":1615277369888},{"_id":"themes/next/scripts/filters/comment/changyan.js","hash":"a54708fd9309b4357c423a3730eb67f395344a5e","modified":1615277369889},{"_id":"themes/next/scripts/filters/comment/common.js","hash":"2486f3e0150c753e5f3af1a3665d074704b8ee2c","modified":1615277369889},{"_id":"themes/next/scripts/filters/comment/default-config.js","hash":"7f2d93af012c1e14b8596fecbfc7febb43d9b7f5","modified":1615277369889},{"_id":"themes/next/scripts/filters/comment/disqus.js","hash":"4c0c99c7e0f00849003dfce02a131104fb671137","modified":1615277369890},{"_id":"themes/next/scripts/filters/comment/disqusjs.js","hash":"7f8b92913d21070b489457fa5ed996d2a55f2c32","modified":1615277369890},{"_id":"themes/next/scripts/filters/comment/gitalk.js","hash":"e51dc3072c1ba0ea3008f09ecae8b46242ec6021","modified":1615277369890},{"_id":"themes/next/scripts/filters/comment/livere.js","hash":"d5fefc31fba4ab0188305b1af1feb61da49fdeb0","modified":1615277369891},{"_id":"themes/next/scripts/filters/comment/valine.js","hash":"ad00812024767f227066722203a34b0875461cb1","modified":1615277369891},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"612ec843372dae709acb17112c1145a53450cc59","modified":1615277369917},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"f4e694e5db81e57442c7e34505a416d818b3044a","modified":1615277369916},{"_id":"themes/next/source/css/_variables/base.styl","hash":"818508748b7a62e02035e87fe58e75b603ed56dc","modified":1615277369917},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"f70be8e229da7e1715c11dd0e975a2e71e453ac8","modified":1615277369916},{"_id":"themes/next/source/js/schemes/muse.js","hash":"1eb9b88103ddcf8827b1a7cbc56471a9c5592d53","modified":1615277369923},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"62df49459d552bbf73841753da8011a1f5e875c8","modified":1615277369917},{"_id":"themes/next/source/js/schemes/pisces.js","hash":"0ac5ce155bc58c972fe21c4c447f85e6f8755c62","modified":1615277369924},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1615277369927},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1615277369926},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"a47725574e1bee3bc3b63b0ff2039cc982b17eff","modified":1615277369897},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"8e7b57a72e757cf95278239641726bb2d5b869d1","modified":1615277369897},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"ca5e70662dcfb261c25191cc5db5084dcf661c76","modified":1615277369897},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"a1690e035b505d28bdef2b4424c13fc6312ab049","modified":1615277369905},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"0b2c4b78eead410020d7c4ded59c75592a648df8","modified":1615277369907},{"_id":"themes/next/source/css/_common/components/reading-progress.styl","hash":"2e3bf7baf383c9073ec5e67f157d3cb3823c0957","modified":1615277369902},{"_id":"themes/next/source/css/_common/outline/mobile.styl","hash":"681d33e3bc85bdca407d93b134c089264837378c","modified":1615277369905},{"_id":"themes/next/source/css/_common/scaffolding/buttons.styl","hash":"a2e9e00962e43e98ec2614d6d248ef1773bb9b78","modified":1615277369907},{"_id":"themes/next/source/css/_common/scaffolding/comments.styl","hash":"b1f0fab7344a20ed6748b04065b141ad423cf4d9","modified":1615277369908},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"b56367ea676ea8e8783ea89cd4ab150c7da7a060","modified":1615277369909},{"_id":"themes/next/source/css/_common/scaffolding/pagination.styl","hash":"8f58570a1bbc34c4989a47a1b7d42a8030f38b06","modified":1615277369909},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"523fb7b653b87ae37fc91fc8813e4ffad87b0d7e","modified":1615277369909},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"18ce72d90459c9aa66910ac64eae115f2dde3767","modified":1615277369909},{"_id":"themes/next/source/css/_common/scaffolding/toggles.styl","hash":"179e33b8ac7f4d8a8e76736a7e4f965fe9ab8b42","modified":1615277369911},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"7785bd756e0c4acede3a47fec1ed7b55988385a5","modified":1615277369912},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"f6516d0f7d89dc7b6c6e143a5af54b926f585d82","modified":1615277369912},{"_id":"themes/next/source/css/_schemes/Mist/_layout.styl","hash":"bb7ace23345364eb14983e860a7172e1683a4c94","modified":1615277369912},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"7104b9cef90ca3b140d7a7afcf15540a250218fc","modified":1615277369912},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expand.styl","hash":"6136da4bbb7e70cec99f5c7ae8c7e74f5e7c261a","modified":1615277369912},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"a717969829fa6ef88225095737df3f8ee86c286b","modified":1615277369913},{"_id":"themes/next/source/css/_schemes/Muse/_header.styl","hash":"f0131db6275ceaecae7e1a6a3798b8f89f6c850d","modified":1615277369913},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"4d1c17345d2d39ef7698f7acf82dfc0f59308c34","modified":1615277369913},{"_id":"themes/next/source/css/_schemes/Muse/_sidebar.styl","hash":"2b2e7b5cea7783c9c8bb92655e26a67c266886f0","modified":1615277369913},{"_id":"themes/next/source/css/_schemes/Pisces/_header.styl","hash":"e282df938bd029f391c466168d0e68389978f120","modified":1615277369914},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"93db5dafe9294542a6b5f647643cb9deaced8e06","modified":1615277369913},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"70a4324b70501132855b5e59029acfc5d3da1ebd","modified":1615277369914},{"_id":"themes/next/source/css/_schemes/Muse/_sub-menu.styl","hash":"c48ccd8d6651fe1a01faff8f01179456d39ba9b1","modified":1615277369914},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1615277369914},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"85da2f3006f4bef9a2199416ecfab4d288f848c4","modified":1615277369914},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"44f47c88c06d89d06f220f102649057118715828","modified":1615277369915},{"_id":"themes/next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"e740deadcfc4f29c5cb01e40f9df6277262ba4e3","modified":1615277369915},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1615277369915},{"_id":"themes/next/source/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1615277369925},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1615277369925},{"_id":"themes/next/source/css/_common/components/pages/breadcrumb.styl","hash":"fafc96c86926b22afba8bb9418c05e6afbc05a57","modified":1615277369898},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"2bd0eb1512415325653b26d62a4463e6de83c5ac","modified":1615277369898},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"e771dcb0b4673e063c0f3e2d73e7336ac05bcd57","modified":1615277369898},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"7504dbc5c70262b048143b2c37d2b5aa2809afa2","modified":1615277369898},{"_id":"themes/next/source/css/_common/components/pages/tag-cloud.styl","hash":"d21d4ac1982c13d02f125a67c065412085a92ff2","modified":1615277369898},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"e75693f33dbc92afc55489438267869ae2f3db54","modified":1615277369899},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"902569a9dea90548bec21a823dd3efd94ff7c133","modified":1615277369899},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"ded41fd9d20a5e8db66aaff7cc50f105f5ef2952","modified":1615277369900},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"f49ca072b5a800f735e8f01fc3518f885951dd8e","modified":1615277369899},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"72d495a88f7d6515af425c12cbc67308a57d88ea","modified":1615277369900},{"_id":"themes/next/source/css/_common/components/post/post-header.styl","hash":"65cb6edb69e94e70e3291e9132408361148d41d5","modified":1615277369900},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"6a97bcfa635d637dc59005be3b931109e0d1ead5","modified":1615277369901},{"_id":"themes/next/source/css/_common/components/post/post-followme.styl","hash":"1e4190c10c9e0c9ce92653b0dbcec21754b0b69d","modified":1615277369900},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"d114b2a531129e739a27ba6271cfe6857aa9a865","modified":1615277369901},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"f5c2788a78790aca1a2f37f7149d6058afb539e0","modified":1615277369901},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"99e12c9ce3d14d4837e3d3f12fc867ba9c565317","modified":1615277369901},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"5b5649b9749e3fd8b63aef22ceeece0a6e1df605","modified":1615277369901},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"a760ee83ba6216871a9f14c5e56dc9bd0d9e2103","modified":1615277369901},{"_id":"themes/next/source/css/_common/components/third-party/math.styl","hash":"b49e9fbd3c182b8fc066b8c2caf248e3eb748619","modified":1615277369902},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"9a878d0119785a2316f42aebcceaa05a120b9a7a","modified":1615277369903},{"_id":"themes/next/source/css/_common/components/third-party/gitalk.styl","hash":"8a7fc03a568b95be8d3337195e38bc7ec5ba2b23","modified":1615277369902},{"_id":"themes/next/source/css/_common/outline/footer/footer.styl","hash":"454a4aebfabb4469b92a8cbb49f46c49ac9bf165","modified":1615277369903},{"_id":"themes/next/source/css/_common/components/third-party/related-posts.styl","hash":"e2992846b39bf3857b5104675af02ba73e72eed5","modified":1615277369902},{"_id":"themes/next/source/css/_common/components/third-party/search.styl","hash":"9f0b93d109c9aec79450c8a0cf4a4eab717d674d","modified":1615277369903},{"_id":"themes/next/source/css/_common/outline/header/github-banner.styl","hash":"e7a9fdb6478b8674b1cdf94de4f8052843fb71d9","modified":1615277369903},{"_id":"themes/next/source/css/_common/outline/header/header.styl","hash":"a793cfff86ad4af818faef04c18013077873f8f0","modified":1615277369904},{"_id":"themes/next/source/css/_common/outline/header/bookmark.styl","hash":"e2d606f1ac343e9be4f15dbbaf3464bc4df8bf81","modified":1615277369903},{"_id":"themes/next/source/css/_common/outline/header/headerband.styl","hash":"0caf32492692ba8e854da43697a2ec8a41612194","modified":1615277369904},{"_id":"themes/next/source/css/_common/outline/header/menu.styl","hash":"5f432a6ed9ca80a413c68b00e93d4a411abf280a","modified":1615277369904},{"_id":"themes/next/source/css/_common/outline/header/site-meta.styl","hash":"45a239edca44acecf971d99b04f30a1aafbf6906","modified":1615277369904},{"_id":"themes/next/source/css/_common/outline/header/site-nav.styl","hash":"b2fc519828fe89a1f8f03ff7b809ad68cd46f3d7","modified":1615277369904},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"2cb1876e9e0c9ac32160888af27b1178dbcb0616","modified":1615277369905},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"fa0222197b5eee47e18ac864cdc6eac75678b8fe","modified":1615277369905},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"44487d9ab290dc97871fa8dd4487016deb56e123","modified":1615277369906},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"1f0e7fbe80956f47087c2458ea880acf7a83078b","modified":1615277369906},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-dimmer.styl","hash":"9b479c2f9a9bfed77885e5093b8245cc5d768ec7","modified":1615277369906},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"a960a2dd587b15d3b3fe1b59525d6fa971c6a6ec","modified":1615277369906},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"a05a4031e799bc864a4536f9ef61fe643cd421af","modified":1615277369906},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"b3220db827e1adbca7880c2bb23e78fa7cbe95cb","modified":1615277369907},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar.styl","hash":"a9cd93c36bae5af9223e7804963096274e8a4f03","modified":1615277369907},{"_id":"themes/next/source/css/_common/outline/sidebar/site-state.styl","hash":"2a47f8a6bb589c2fb635e6c1e4a2563c7f63c407","modified":1615277369907},{"_id":"themes/next/source/css/_common/scaffolding/highlight/diff.styl","hash":"d3f73688bb7423e3ab0de1efdf6db46db5e34f80","modified":1615277369908},{"_id":"themes/next/source/css/_common/scaffolding/highlight/highlight.styl","hash":"35c871a809afa8306c8cde13651010e282548bc6","modified":1615277369908},{"_id":"themes/next/source/css/_common/scaffolding/highlight/theme.styl","hash":"3b3acc5caa0b95a2598bef4eeacb21bab21bea56","modified":1615277369908},{"_id":"themes/next/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"f71a3e86c05ea668b008cf05a81f67d92b6d65e4","modified":1615277369908},{"_id":"themes/next/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"1d2778ca5aeeeafaa690dc2766b01b352ab76a02","modified":1615277369910},{"_id":"themes/next/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"709d10f763e357e1472d6471f8be384ec9e2d983","modified":1615277369910},{"_id":"themes/next/source/css/_common/scaffolding/tags/label.styl","hash":"d7fce4b51b5f4b7c31d93a9edb6c6ce740aa0d6b","modified":1615277369910},{"_id":"themes/next/source/css/_common/scaffolding/tags/note.styl","hash":"e4d9a77ffe98e851c1202676940097ba28253313","modified":1615277369910},{"_id":"themes/next/source/css/_common/scaffolding/tags/tabs.styl","hash":"f23670f1d8e749f3e83766d446790d8fd9620278","modified":1615277369911},{"_id":"themes/next/source/css/_common/scaffolding/tags/tags.styl","hash":"9e4c0653cfd3cc6908fa0d97581bcf80861fb1e7","modified":1615277369911},{"_id":"themes/next/source/css/_common/scaffolding/tags/pdf.styl","hash":"b49c64f8e9a6ca1c45c0ba98febf1974fdd03616","modified":1615277369911},{"_id":"themes/next/docs/ALGOLIA-SEARCH.md","hash":"c7a994b9542040317d8f99affa1405c143a94a38","modified":1615277369856},{"_id":"themes/next/docs/DATA-FILES.md","hash":"cddbdc91ee9e65c37a50bec12194f93d36161616","modified":1615277369857},{"_id":"themes/next/docs/AUTHORS.md","hash":"10135a2f78ac40e9f46b3add3e360c025400752f","modified":1615277369857},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1615277369925},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1615277369926},{"_id":"source/_posts/2021-03-29-android-graphics-basis.md","hash":"99e9052cedf5f329978fb526f577e49084a0b747","modified":1621342732143},{"_id":"source/_posts/2021-03-29-android-graphics-basis/6i6h11.jpg","hash":"6aeade75afe32f850d4cf8a1d437d85b64b7d940","modified":1617075522430},{"_id":"source/_drafts/.DS_Store","hash":"b540356ea528d09939a02a6e38949b964272eb15","modified":1636460942632},{"_id":"source/_drafts/android-app-process-creation.md","hash":"d3eac187190b3ecbd9ed5d594081a2c1689022dd","modified":1629189261662},{"_id":"source/_drafts/my-understand-of-Binder.md","hash":"aef63d42cfcca4121843f799747b2b7c68d58751","modified":1628232259503},{"_id":"source/_posts/2021-03-29-graphics-basis.md","hash":"fc49ddf634475b550cdc31cb9169c1522bf8ef82","modified":1621338553773},{"_id":"source/_drafts/tcp-connection-establishment-and-termination.md","hash":"9776d9040c9d8d6debb5dbd07ec4211ae2b33225","modified":1636460396518},{"_id":"source/_drafts/tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p4.jpg","hash":"a330a80eb334c290f81669de9a57ff36ee1f3852","modified":1628670702478},{"_id":"source/_drafts/tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p3.jpg","hash":"65a340bf42ebc21079817c4cd2897c0b78261493","modified":1628670696519},{"_id":"source/_drafts/tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p2.jpg","hash":"99098ee45ff1bb614ce7f5b66a0d901f288701a1","modified":1628670667818},{"_id":"source/_drafts/tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p1.jpg","hash":"5c3f635bebbd13c821f3404eb95e0b56bad0f2a9","modified":1628670632876},{"_id":"source/_posts/2021-08-11-img-test.md","hash":"d05cd6c0ebb98acd76cef6ad725813d4c2576c88","modified":1628670981261},{"_id":"source/_posts/2021-08-11-img-test/zhihu_xiaolincoding_ans_p1.jpg","hash":"5c3f635bebbd13c821f3404eb95e0b56bad0f2a9","modified":1628670632876},{"_id":"source/_posts/2021-08-11-img-test/IMG_0105.PNG","hash":"272ed0c65ad6cf2326149f217c8f1aafe3e21829","modified":1628668207023},{"_id":"source/_posts/tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p2.jpg","hash":"99098ee45ff1bb614ce7f5b66a0d901f288701a1","modified":1628670667818},{"_id":"source/_posts/tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p4.jpg","hash":"a330a80eb334c290f81669de9a57ff36ee1f3852","modified":1628670702478},{"_id":"source/_posts/tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p3.jpg","hash":"65a340bf42ebc21079817c4cd2897c0b78261493","modified":1628670696519},{"_id":"source/_posts/tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p1.jpg","hash":"5c3f635bebbd13c821f3404eb95e0b56bad0f2a9","modified":1628670632876},{"_id":"source/_posts/tcp-connection-establishment-and-termination.md","hash":"64b7ac7e0b047b6d5a48a83b6ae545b565fae274","modified":1628670869706},{"_id":"source/_posts/2020-01-01-tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p2.jpg","hash":"99098ee45ff1bb614ce7f5b66a0d901f288701a1","modified":1628670667818},{"_id":"source/_posts/2020-01-01-tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p3.jpg","hash":"65a340bf42ebc21079817c4cd2897c0b78261493","modified":1628670696519},{"_id":"source/_posts/2020-01-01-tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p4.jpg","hash":"a330a80eb334c290f81669de9a57ff36ee1f3852","modified":1628670702478},{"_id":"source/_posts/2020-01-01-tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p1.jpg","hash":"5c3f635bebbd13c821f3404eb95e0b56bad0f2a9","modified":1628670632876},{"_id":"source/_drafts/file-descriptor.md","hash":"24627a19d1692d8f9b08588b23930f00f63602e4","modified":1629116801879},{"_id":"source/_posts/2020-01-01-tcp-connection-establishment-and-termination.md","hash":"7f4b758efd75aeaba767ed6c9d558d141ce61770","modified":1628673143439},{"_id":"source/_drafts/Exploring-Android-Binder.md","hash":"aef63d42cfcca4121843f799747b2b7c68d58751","modified":1628232259503},{"_id":"source/_drafts/Exploring-Zygote-Startup-Process.md","hash":"245ab47151c5dccb57b2ff15c98f4369f9c468e2","modified":1629268432897},{"_id":"source/_drafts/Understand-File-Descriptor.md","hash":"24627a19d1692d8f9b08588b23930f00f63602e4","modified":1629116801879},{"_id":"source/_drafts/Exploring-Android-App-Process-Startup-Process.md","hash":"babf78ad6495ec12ec6af4c07481c1ba44e0458a","modified":1629194094844},{"_id":"source/_drafts/exploring-android-binder.md","hash":"f7acd357a025254d5720dbd1669f81461649d650","modified":1629269351269},{"_id":"source/_drafts/exploring-zygote-startup-process.md","hash":"33f4fab549ad150d451261667dc79730a2b5f6d2","modified":1629712652453},{"_id":"source/_drafts/understand-file-descriptor.md","hash":"24627a19d1692d8f9b08588b23930f00f63602e4","modified":1629116801879},{"_id":"source/_drafts/exploring-android-app-process-startup-process.md","hash":"540665e56419514c5cffa4690ff1ec436ca7de24","modified":1629342358376},{"_id":"source/_drafts/exploring-init-process-startup-process.md","hash":"1da6a3a5b7e44d9bfdeb95e6d278a4d9d6dcf2bc","modified":1636458974735},{"_id":"source/_drafts/android-display-refresh.md","hash":"3f883d2632a0d223d7c9bac0406534541968f189","modified":1636460857503},{"_id":"source/_drafts/android-graphics-basis.md","hash":"1c030984ca544a08592f5a1dd8bd6a21c3b4b2ea","modified":1636460744683},{"_id":"source/_drafts/graphics-basis.md","hash":"3fd8559b47acf3517f276523695d452bb9b4be81","modified":1636460890293},{"_id":"source/_posts/2021-07-10-exploring-init-process-startup-process.md","hash":"5ad89faf8c768eed321896e75b74d7db992b6aea","modified":1636529961588}],"Category":[{"name":"ComputerScience","_id":"ckmsyc4ra00055nprdp3d27gx"},{"name":"Mathematics","_id":"ckmsyc4re00095npr7a605gff"},{"name":"Algorithm","parent":"ckmsyc4ra00055nprdp3d27gx","_id":"ckmsyc4rh000f5npr8h940wmh"},{"name":"Android","_id":"ckmsyc4ri000i5nprffv13va1"},{"name":"Framework","parent":"ckmsyc4ri000i5nprffv13va1","_id":"ckmsyc4rk000m5npr6wjm0y3r"},{"name":"Graphics","parent":"ckmsyc4rk000m5npr6wjm0y3r","_id":"ckmsyc4rl000o5npr0v7gbch2"},{"name":"Handler","parent":"ckmsyc4rk000m5npr6wjm0y3r","_id":"ckmsyc4rl000p5npr5xe96pw7"},{"name":"Graphics","_id":"ckoifpt4j0006m1pr7zm18tlb"},{"name":"Process","parent":"ckmsyc4ri000i5nprffv13va1","_id":"ckrzsw1zy00036sprcyf3beh5"},{"name":"Binder","parent":"ckmsyc4rk000m5npr6wjm0y3r","_id":"ckrzsw20000076spr2i0g1ol0"},{"name":"Linux","_id":"cksftg56z0001hlpr9ry98ndj"}],"Data":[],"Page":[{"date":"2021-02-23T09:18:35.000Z","type":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ndate: 2021-02-23 17:18:35\ntype: categories\ncomments: false\n---\n","updated":"2021-03-09T08:09:29.854Z","path":"categories/index.html","title":"","layout":"page","_id":"ckmsyc4r100005npr28fl6ktw","content":"","site":{"data":{}},"excerpt":"","more":""},{"date":"2021-02-23T09:07:17.000Z","type":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ndate: 2021-02-23 17:07:17\ntype: tags\ncomments: false\n---\n","updated":"2021-03-09T08:09:29.855Z","path":"tags/index.html","title":"","layout":"page","_id":"ckmsyc4r700025npr2rum6aq2","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"","date":"2021-03-19T07:19:50.000Z","mathjax":true,"_content":"\n\n\n\n\n# \n\n\n\n\n\n# \n\n\n\n**** $O$ \n\n\n\n","source":"_drafts/time-complexity.md","raw":"---\ntitle: \ndate: 2021-03-19 15:19:50\ncategories:\n- [ComputerScience, Algorithm]\nmathjax: true\n---\n\n\n\n\n\n# \n\n\n\n\n\n# \n\n\n\n**** $O$ \n\n\n\n","slug":"time-complexity","published":0,"updated":"2021-03-19T08:38:56.046Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckmsyc4r400015nprahox2qqz","content":"<p></p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p></p>\n<p><strong></strong> $O$ </p>\n","site":{"data":{}},"excerpt":"","more":"<p></p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p></p>\n<p><strong></strong> $O$ </p>\n"},{"title":"Hello World","date":"2021-02-18T03:49:09.000Z","_content":"Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n<!-- more -->\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","source":"_posts/2021-02-18-hello-world.md","raw":"---\ntitle: Hello World\ndate: 2021-02-18 11:49:09\ntags: Test\n---\nWelcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n<!-- more -->\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","slug":"hello-world","published":1,"updated":"2021-03-09T08:09:29.854Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckmsyc4r700035npr5dbfdrkh","content":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<a id=\"more\"></a>\n\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n","site":{"data":{}},"excerpt":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>","more":"<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>"},{"title":"","date":"2021-02-19T03:49:09.000Z","mathjax":true,"_content":"\n\n\n- \n- \n- \n\n 0  \"+\" 1  \"-\"\n\n<!-- more -->\n\n## 1. \n\n\n\n-  0  0\n\n-  0  1\n\n-  +0  0\n\n-  -0  1\n\n\n\n 8 \n\n```\n+10D = 00001010B\n\n-10D = 10001010B\n\n+127D = 01111111B\n```\n\n\n\n n  ${2}^n$  +0  -0 \n\n $\\[\\-\\(\\{2}^{n-1} - 1\\)\\,\\{2}^{n-1} - 1\\]$\n\n\n## 2. \n\n\n\n 10001010 \n\n```\n10001010() = 11110101()\n```\n\n\n\n\n\n## 3. \n\n\n\n```\n00000010 + 00000010 = 00000100 2 + 2 = 4\n00000010 + 10000010 = 10000100 2 + (-2) = -4\n```\n\n\n\n### 3.1 \n\n 0  1\n\n\n\n### 3.2 \n\n\n\n```\n  (0000) 0000 0010 (2D)\n+ (0000) 1111 1110 (-2D)\n------------------------\n  (0001) 0000 0000 (0D)\n\n\n```\n\n```\n  (0000) 0000 0010 (2D)\n+ (0000) 1111 1111 (-1D)\n------------------------\n  (0001) 0000 0001 (1D)\n\n\n```\n\n```\n  (0000) 0000 0010 (2D)\n+ (0000) 1111 1101 (-3D)\n------------------------\n  (0000) 1111 1111 (-1D)\n\n\n```\n\n\n\n### 3.3 \n\n0  32 \n\n```\n0000 0000 0000 0000 0000 0000 0000 0000\n\n1000 0000 0000 0000 0000 0000 0000 0000\n```\n\n 1\n\n```\n(0001) 0000 0000 0000 0000 0000 0000 0000 0000\n```\n\n\n\n**0**\n\n\n\n32\n\n```\n1000 0000 0000 0000 0000 0000 0000 0000\n```\n\n\n\n```\n  (0000) 1000 0000 0000 0000 0000 0000 0000 0001 (-2147483647D)\n+ (0000) 1111 1111 1111 1111 1111 1111 1111 1111 (-1D)\n---------------------------------------------------------------\n  (0001) 1000 0000 0000 0000 0000 0000 0000 0000 (-2147483648D)\n```\n$1$$\\underbrace{ 00\\cdots00 }_{n-1}$  n \n\n** n  $2^n$  $\\[\\{-2}^{n-1}\\,\\{2}^{n-1} - 1\\]$**\n\n> \n>\n> https://en.wikipedia.org/wiki/Signed_number_representations\n>\n> https://zh.wikipedia.org/wiki/%E6%9C%89%E7%AC%A6%E8%99%9F%E6%95%B8%E8%99%95%E7%90%86\n","source":"_posts/2021-02-19-signed-number-representations.md","raw":"---\ntitle: \ndate: 2021-02-19 11:49:09\ntags:\n- ComputerScience\nmathjax: true\n---\n\n\n\n- \n- \n- \n\n 0  \"+\" 1  \"-\"\n\n<!-- more -->\n\n## 1. \n\n\n\n-  0  0\n\n-  0  1\n\n-  +0  0\n\n-  -0  1\n\n\n\n 8 \n\n```\n+10D = 00001010B\n\n-10D = 10001010B\n\n+127D = 01111111B\n```\n\n\n\n n  ${2}^n$  +0  -0 \n\n $\\[\\-\\(\\{2}^{n-1} - 1\\)\\,\\{2}^{n-1} - 1\\]$\n\n\n## 2. \n\n\n\n 10001010 \n\n```\n10001010() = 11110101()\n```\n\n\n\n\n\n## 3. \n\n\n\n```\n00000010 + 00000010 = 00000100 2 + 2 = 4\n00000010 + 10000010 = 10000100 2 + (-2) = -4\n```\n\n\n\n### 3.1 \n\n 0  1\n\n\n\n### 3.2 \n\n\n\n```\n  (0000) 0000 0010 (2D)\n+ (0000) 1111 1110 (-2D)\n------------------------\n  (0001) 0000 0000 (0D)\n\n\n```\n\n```\n  (0000) 0000 0010 (2D)\n+ (0000) 1111 1111 (-1D)\n------------------------\n  (0001) 0000 0001 (1D)\n\n\n```\n\n```\n  (0000) 0000 0010 (2D)\n+ (0000) 1111 1101 (-3D)\n------------------------\n  (0000) 1111 1111 (-1D)\n\n\n```\n\n\n\n### 3.3 \n\n0  32 \n\n```\n0000 0000 0000 0000 0000 0000 0000 0000\n\n1000 0000 0000 0000 0000 0000 0000 0000\n```\n\n 1\n\n```\n(0001) 0000 0000 0000 0000 0000 0000 0000 0000\n```\n\n\n\n**0**\n\n\n\n32\n\n```\n1000 0000 0000 0000 0000 0000 0000 0000\n```\n\n\n\n```\n  (0000) 1000 0000 0000 0000 0000 0000 0000 0001 (-2147483647D)\n+ (0000) 1111 1111 1111 1111 1111 1111 1111 1111 (-1D)\n---------------------------------------------------------------\n  (0001) 1000 0000 0000 0000 0000 0000 0000 0000 (-2147483648D)\n```\n$1$$\\underbrace{ 00\\cdots00 }_{n-1}$  n \n\n** n  $2^n$  $\\[\\{-2}^{n-1}\\,\\{2}^{n-1} - 1\\]$**\n\n> \n>\n> https://en.wikipedia.org/wiki/Signed_number_representations\n>\n> https://zh.wikipedia.org/wiki/%E6%9C%89%E7%AC%A6%E8%99%9F%E6%95%B8%E8%99%95%E7%90%86\n","slug":"signed-number-representations","published":1,"updated":"2021-03-26T13:24:39.315Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckmsyc4r900045nprbgj32va1","content":"<p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p> 0  + 1  -</p>\n<a id=\"more\"></a>\n\n<h2 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h2><p></p>\n<ul>\n<li><p> 0  0</p>\n</li>\n<li><p> 0  1</p>\n</li>\n<li><p> +0  0</p>\n</li>\n<li><p> -0  1</p>\n</li>\n</ul>\n<p> 8 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+10D &#x3D; 00001010B</span><br><span class=\"line\"></span><br><span class=\"line\">-10D &#x3D; 10001010B</span><br><span class=\"line\"></span><br><span class=\"line\">+127D &#x3D; 01111111B</span><br></pre></td></tr></table></figure>\n\n\n<p> n  ${2}^n$  +0  -0 </p>\n<p> $[-({2}^{n-1} - 1),{2}^{n-1} - 1]$</p>\n<h2 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h2><p></p>\n<p> 10001010 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10001010() &#x3D; 11110101()</span><br></pre></td></tr></table></figure>\n<p></p>\n<h2 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3. \"></a>3. </h2><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00000010 + 00000010 &#x3D; 00000100 2 + 2 &#x3D; 4</span><br><span class=\"line\">00000010 + 10000010 &#x3D; 10000100 2 + (-2) &#x3D; -4</span><br></pre></td></tr></table></figure>\n<p></p>\n<h3 id=\"3-1-\"><a href=\"#3-1-\" class=\"headerlink\" title=\"3.1 \"></a>3.1 </h3><p> 0  1</p>\n<h3 id=\"3-2-\"><a href=\"#3-2-\" class=\"headerlink\" title=\"3.2 \"></a>3.2 </h3><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  (0000) 0000 0010 (2D)</span><br><span class=\"line\">+ (0000) 1111 1110 (-2D)</span><br><span class=\"line\">------------------------</span><br><span class=\"line\">  (0001) 0000 0000 (0D)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  (0000) 0000 0010 (2D)</span><br><span class=\"line\">+ (0000) 1111 1111 (-1D)</span><br><span class=\"line\">------------------------</span><br><span class=\"line\">  (0001) 0000 0001 (1D)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  (0000) 0000 0010 (2D)</span><br><span class=\"line\">+ (0000) 1111 1101 (-3D)</span><br><span class=\"line\">------------------------</span><br><span class=\"line\">  (0000) 1111 1111 (-1D)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"3-3-\"><a href=\"#3-3-\" class=\"headerlink\" title=\"3.3 \"></a>3.3 </h3><p>0  32 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class=\"line\"></span><br><span class=\"line\">1000 0000 0000 0000 0000 0000 0000 0000</span><br></pre></td></tr></table></figure>\n<p> 1</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(0001) 0000 0000 0000 0000 0000 0000 0000 0000</span><br></pre></td></tr></table></figure>\n<p></p>\n<p><strong>0</strong></p>\n<p>32</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1000 0000 0000 0000 0000 0000 0000 0000</span><br></pre></td></tr></table></figure>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  (0000) 1000 0000 0000 0000 0000 0000 0000 0001 (-2147483647D)</span><br><span class=\"line\">+ (0000) 1111 1111 1111 1111 1111 1111 1111 1111 (-1D)</span><br><span class=\"line\">---------------------------------------------------------------</span><br><span class=\"line\">  (0001) 1000 0000 0000 0000 0000 0000 0000 0000 (-2147483648D)</span><br></pre></td></tr></table></figure>\n<p>$1$$\\underbrace{ 00\\cdots00 }_{n-1}$  n </p>\n<p><strong> n  $2^n$  $[{-2}^{n-1},{2}^{n-1} - 1]$</strong></p>\n<blockquote>\n<p></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Signed_number_representations\">https://en.wikipedia.org/wiki/Signed_number_representations</a></p>\n<p><a href=\"https://zh.wikipedia.org/wiki/%E6%9C%89%E7%AC%A6%E8%99%9F%E6%95%B8%E8%99%95%E7%90%86\">https://zh.wikipedia.org/wiki/%E6%9C%89%E7%AC%A6%E8%99%9F%E6%95%B8%E8%99%95%E7%90%86</a></p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p> 0  + 1  -</p>","more":"<h2 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h2><p></p>\n<ul>\n<li><p> 0  0</p>\n</li>\n<li><p> 0  1</p>\n</li>\n<li><p> +0  0</p>\n</li>\n<li><p> -0  1</p>\n</li>\n</ul>\n<p> 8 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+10D &#x3D; 00001010B</span><br><span class=\"line\"></span><br><span class=\"line\">-10D &#x3D; 10001010B</span><br><span class=\"line\"></span><br><span class=\"line\">+127D &#x3D; 01111111B</span><br></pre></td></tr></table></figure>\n\n\n<p> n  ${2}^n$  +0  -0 </p>\n<p> $[-({2}^{n-1} - 1),{2}^{n-1} - 1]$</p>\n<h2 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h2><p></p>\n<p> 10001010 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10001010() &#x3D; 11110101()</span><br></pre></td></tr></table></figure>\n<p></p>\n<h2 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3. \"></a>3. </h2><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00000010 + 00000010 &#x3D; 00000100 2 + 2 &#x3D; 4</span><br><span class=\"line\">00000010 + 10000010 &#x3D; 10000100 2 + (-2) &#x3D; -4</span><br></pre></td></tr></table></figure>\n<p></p>\n<h3 id=\"3-1-\"><a href=\"#3-1-\" class=\"headerlink\" title=\"3.1 \"></a>3.1 </h3><p> 0  1</p>\n<h3 id=\"3-2-\"><a href=\"#3-2-\" class=\"headerlink\" title=\"3.2 \"></a>3.2 </h3><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  (0000) 0000 0010 (2D)</span><br><span class=\"line\">+ (0000) 1111 1110 (-2D)</span><br><span class=\"line\">------------------------</span><br><span class=\"line\">  (0001) 0000 0000 (0D)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  (0000) 0000 0010 (2D)</span><br><span class=\"line\">+ (0000) 1111 1111 (-1D)</span><br><span class=\"line\">------------------------</span><br><span class=\"line\">  (0001) 0000 0001 (1D)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  (0000) 0000 0010 (2D)</span><br><span class=\"line\">+ (0000) 1111 1101 (-3D)</span><br><span class=\"line\">------------------------</span><br><span class=\"line\">  (0000) 1111 1111 (-1D)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"3-3-\"><a href=\"#3-3-\" class=\"headerlink\" title=\"3.3 \"></a>3.3 </h3><p>0  32 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class=\"line\"></span><br><span class=\"line\">1000 0000 0000 0000 0000 0000 0000 0000</span><br></pre></td></tr></table></figure>\n<p> 1</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(0001) 0000 0000 0000 0000 0000 0000 0000 0000</span><br></pre></td></tr></table></figure>\n<p></p>\n<p><strong>0</strong></p>\n<p>32</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1000 0000 0000 0000 0000 0000 0000 0000</span><br></pre></td></tr></table></figure>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  (0000) 1000 0000 0000 0000 0000 0000 0000 0001 (-2147483647D)</span><br><span class=\"line\">+ (0000) 1111 1111 1111 1111 1111 1111 1111 1111 (-1D)</span><br><span class=\"line\">---------------------------------------------------------------</span><br><span class=\"line\">  (0001) 1000 0000 0000 0000 0000 0000 0000 0000 (-2147483648D)</span><br></pre></td></tr></table></figure>\n<p>$1$$\\underbrace{ 00\\cdots00 }_{n-1}$  n </p>\n<p><strong> n  $2^n$  $[{-2}^{n-1},{2}^{n-1} - 1]$</strong></p>\n<blockquote>\n<p></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Signed_number_representations\">https://en.wikipedia.org/wiki/Signed_number_representations</a></p>\n<p><a href=\"https://zh.wikipedia.org/wiki/%E6%9C%89%E7%AC%A6%E8%99%9F%E6%95%B8%E8%99%95%E7%90%86\">https://zh.wikipedia.org/wiki/%E6%9C%89%E7%AC%A6%E8%99%9F%E6%95%B8%E8%99%95%E7%90%86</a></p>\n</blockquote>"},{"title":"","date":"2021-03-10T07:54:36.000Z","mathjax":true,"_content":"\n****\n****\n****\n\n\n\n<!-- more -->\n\n# 1. \n\n## 1.1 \n\n\n\n $f(x)=C$ $C$ $(-\\infty,+\\infty)$\n\n### 1.1.1 \n\n{% asset_img constant-function-example-1.png 300 300 %}\n\n$$f(x)=1$$\n\n\n\n## 1.2 \n\n\n\n $f(x)=x^$$a$ \n\n### 1.2.1 \n\n $a$ \n\n$f(x)=x^{k\\frac{m}{n}}(k\\in\\lbrace-1,1,0\\rbrace,m,n\\in{N}^{*})$\n\n|       |     |     |  |  |\n| :---: | :----: | :----: | :----: | ------ |\n| $k=1,m,n$  | $R$ | $R$ |  | {% asset_img power-function-example-1.png 300 300 %} $$red:f(x)=x^\\frac{1}{3}$$$$blue:f(x)=x^{3}$$ |\n| $k=-1,m,n$  | $(-\\infty,0)\\cup(0,+\\infty)$ | $(-\\infty,0)\\cup(0,+\\infty)$ |  | {% asset_img power-function-example-2.png 300 300 %} $$red:f(x)=x^{-\\frac{1}{3}}$$$$blue:f(x)=x^{-3}$$ |\n| $k=1,m$ $,n$  | $[0,+\\infty)$ | $[0,+\\infty)$ |  | {% asset_img power-function-example-3.png 300 300 %} $$red:f(x)=x^{\\frac{3}{2}}$$$$blue:f(x)=x^{\\frac{1}{2}}$$$$green:f(x)=x^{\\frac{5}{2}}$$ |\n| $k=-1,m$ $,n$  | $(0,+\\infty)$ | $(0,+\\infty)$ |  | {% asset_img power-function-example-4.png 300 300 %} $$red:f(x)=x^{-\\frac{3}{2}}$$$$blue:f(x)=x^{-\\frac{1}{2}}$$$$green:f(x)=x^{-\\frac{5}{2}}$$ |\n| $k=1,m$ $,n$  | $R$ | $[0,+\\infty)$ |  | {% asset_img power-function-example-5.png 300 300 %} $$red:f(x)=x^{\\frac{4}{3}}$$$$blue:f(x)=x^{\\frac{2}{3}}$$$$green:f(x)=x^{2}$$ |\n| $k=-1,m$ $,n$  | $(-\\infty,0)\\cup(0,+\\infty)$ | $(0,+\\infty)$ |  | {% asset_img power-function-example-6.png 300 300 %} $$red:f(x)=x^{-\\frac{4}{3}}$$$$blue:f(x)=x^{-\\frac{2}{3}}$$$$green:f(x)=x^{-2}$$ |\n| $k=0$ | $(-\\infty,0)\\cup(0,+\\infty)$ | $\\lbrace1\\rbrace$ |  | {% asset_img power-function-example-7.png 300 300 %} $$red:f(x)=x^{0}$$$f(x)=x^{0}$  $y=1$  $(0,1)$ |\n\n\n\n## 1.3 \n\n $f(x)=b^x$$b$  $b\\in(0,1)\\cup(1,+\\infty)$ $R$ $(0,+\\infty)$\n\n $b^x$  $1$ $x$  $x$ \n\n### 1.3.1 \n|       |     |  |\n| :---: | :----: | ------ |\n| $0<b<1$ | $(0,+\\infty)$ | {% asset_img exponential-function-example-1.png 300 300 %} $$red:f(x)=\\frac{1}{2}^x$$$$blue:f(x)=\\frac{1}{4}^x$$ |\n| $b>1$ | $(0,+\\infty)$ | {% asset_img exponential-function-example-2.png 300 300 %} $$red:f(x)=2^x$$$$blue:f(x)=4^x$$ |\n\n### 1.3.2 \n\n#### 1.3.2.1  1\n\n\n\n\t$e^x=\\lim_{n \\to \\infty}(1+\\frac{x}{n})^{n}$\n\n\n\n\t$e^0=1$\n\n\t$e^1=e$\n\n\t$e^{x+y}=e^xe^y$\n\n\t$e^{xy}=(e^x)^y$\n\n\t$\\frac{e^x}{e^y}=e^{x-y}$\n\n\t$e^{-x}=e^{0-x}=\\frac{e^0}{e^x}=\\frac{1}{e^x}$\n\n $x\\in{R},y\\in{R}$\n\n\n\n#### 1.3.2.2  2\n\n $x$  $e$\n\n$b^x=(e^{\\ln{b}})^x=e^{x\\ln{b}}$\n\n\n\n#### 1.3.2.3  3\n\n $b>0$ $x$\" $b$ \"\n\n$b^{\\frac{m}{n}=\\sqrt[n]{b^m}}$\n\n\n\n$\\sqrt[n]{b}=b^{\\frac{1}{n}}=(e^{\\ln{b}})^{\\frac{1}{n}}=e^{\\frac{\\ln{b}}{n}}$\n\n\n\n## 1.4 \n\n\n\n $b^x=N(b>0,b\\neq1)$ $x$  $b$  $N$  $x=\\log_{b}{N}$ $b$  $N$  $b$ $N$ \n\n $f(x)=\\log_{b}{x}(b>0,b\\neq1)$ $(0,+\\infty)$ $R$ \n\n $x=b^y$ $b$ \n\n### 1.4.1 \n|       |     |  |\n| :---: | :----: | ------ |\n| $0<b<1$ | $R$ | {% asset_img logarithmic-function-example-1.png 300 300 %} $$red:f(x)=\\log_{\\frac{1}{2}}{x}$$$$blue:f(x)=\\log_{\\frac{1}{4}}{x}$$ |\n| $b>1$ | $R$ | {% asset_img logarithmic-function-example-2.png 300 300 %} $$red:f(x)=\\log_{2}{x}$$$$blue:f(x)=\\log_{4}{x}$$ |\n\n### 1.4.2 \n\n- $(1,0)$\n\n-  $0<b<1$  $(0,+\\infty)$ $b>1$  $(0,+\\infty)$ \n\n-  $f(x)=\\log_{b}{x}(b>0,b\\neq1,x>0)$\n\n   $0<b<1,0<x<1$ $f(x)=\\log_{b}{x}>0$\n  \n   $b>1, x>1$ $f(x)=\\log_{b}{x}>0$\n  \n   $0<b<1, x>1$ $f(x)=\\log_{b}{x}<0$\n  \n   $b>1, 0<x<1$ $f(x)=\\log_{b}{x}<0$\n  \n-  $b$ $f(x)=\\log_{b}{x}$ $f(x)=b^x$  $y = x$ \n\n{% asset_img logarithmic-function-example-3.png 300 300 %} $$red:f(x)=\\log_{2}{x}$$$$blue:f(x)=2^{x}$$$$green:f(x)=\\log_{\\frac{1}{2}}{x}$$$$blue:f(x)={\\frac{1}{2}}^{x}$$\n\n### 1.4.3 \n\n#### 1.4.3.1 \n\n$\\log_{b}{x}=\\frac{\\log_{k}{x}}{\\log_{k}{b}}$\n\n##### 1.4.3.1.1 \n\n\n\n$x=b^{\\log_{b}{x}}$\n\n $k$ \n\n$\\log_{k}{x}=\\log_{k}({b^{\\log_{b}{x}})}$\n\n$\\because b^x=N(b>0,b\\neq1)$ $x=\\log_{b}{N}$\n\n $(b^x)^t=b^{xt}=N^t\\ (t\\in{R})$\n\n$xt=\\log_{b}{N^t}=t\\log_{b}{N}\\ (t\\in{R})$\n\n$\\therefore\\log_{k}{x}=\\log_{k}{b^{\\log_{b}{x}}}=\\log_{b}{x}\\log_{k}{b}$\n\n$\\log_{b}{x}=\\frac{\\log_{k}{x}}{\\log_{k}{b}}$ \n\n\n\n#### 1.4.3.2 \n\n$\\log_{b}{MN}=\\log_{b}{M}+\\log_{b}{N}$\n\n$\\log_{b}{\\frac{M}{N}}=\\log_{b}{M}-\\log_{b}{N}$\n\n##### 1.4.3.2.1 \n\n $M=\\beta^{m},N=\\beta^{n}$\n\n $\\log_{b}{MN}=\\log_{b}({\\beta^{m}\\beta^{n}})$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}({\\beta^{m+n}})$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =(m+n)\\log_{b}{\\beta}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =m\\log_{b}{\\beta}+n\\log_{b}{\\beta}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{\\beta^m}+\\log_{b}{\\beta^n}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}+\\log_{b}{N}$\n\n$\\log_{b}{\\frac{M}{N}}=\\log_{b}{M}+\\log_{b}{\\frac{1}{N}}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}+\\log_{b}{N^{-1}}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}-\\log_{b}{N}$\n\n\n\n#### 1.4.3.3 \n\n$\\log_{b^N}({x^M})=\\frac{M}{N}\\log_{b}{x}$\n\n##### 1.4.3.3.1 \n\n\n\n$\\log_{b^N}({x^M})=\\frac{\\ln{b^N}}{\\ln{x^M}}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\frac{N\\ln{b}}{M\\ln{x}}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\frac{M}{N}\\log_{b}{x}$\n\n##### \n\n#### 1.4.3.4 \n\n$b^{\\log_{b}{x}}=x$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{b^x}$\n\n\n\n#### 1.4.3.5 \n\n$M^{\\log_{b}{N}} = N^{\\log_{b}{M}}$\n\n##### 1.4.3.5.1 \n\n $\\alpha=\\log_{b}{N},\\  \\beta=\\log_{b}{M}$ $b^\\alpha=N,\\ b^\\beta=M, \\ (b^\\beta)^\\alpha=(b^\\alpha)^\\beta$\n\n$\\therefore M^{\\log_{b}{N}} = N^{\\log_{b}{M}}$\n\n\n\n#### 1.4.3.6 \n\n$\\log_{b}{\\theta}=\\frac{\\ln \\theta}{\\ln b}=\\frac{1}{\\frac{\\ln b}{\\ln \\theta}}=\\frac{1}{\\log_{\\theta}{b}}$\n\n\n\n## 1.5 \n\n<!--TODO-->\n\n\n\n## 1.6 \n\n<!--TODO-->\n\n\n\n# 2. \n\n****\n\n****\n\n\n\n\n\n\n> \n>\n> https://baike.baidu.com/item/%E5%9F%BA%E6%9C%AC%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0\n>\n> https://zh.wikipedia.org/wiki/%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0\n\n\n<style>\n  table {\n    width: 1100px; /**/\n    max-width: 1100px; /**/\n    border: 1px solid #dedede; /**/\n    margin: 1px auto; /**/\n    border-collapse: collapse; /**/\n    empty-cells: show; /**/\n  }\n  table th,\n  table td {\n    height: 35px; /**/\n    border: 1px solid #dedede; /**/\n    padding: 0 10px; /**/\n  }\n  table th {\n    font-weight: bold; /**/\n    text-align: center !important; /* !important  Markdown */\n    background: #F8F8F8; /**/\n  }\n  table tbody tr:nth-child(n) {\n    background: #FFFFFF; \n  }\n  table tr:hover {\n    background: #EFEFEF; \n}\n  table th {\n    white-space: nowrap; /**/\n  }\n  table td:nth-child(1) {\n    white-space: nowrap; /**/\n  }\n</style>\n","source":"_posts/2021-03-10-elementary-function.md","raw":"---\ntitle: \ndate: 2021-03-10 15:54:36\ncategories:\n- Mathematics\nmathjax: true\n---\n\n****\n****\n****\n\n\n\n<!-- more -->\n\n# 1. \n\n## 1.1 \n\n\n\n $f(x)=C$ $C$ $(-\\infty,+\\infty)$\n\n### 1.1.1 \n\n{% asset_img constant-function-example-1.png 300 300 %}\n\n$$f(x)=1$$\n\n\n\n## 1.2 \n\n\n\n $f(x)=x^$$a$ \n\n### 1.2.1 \n\n $a$ \n\n$f(x)=x^{k\\frac{m}{n}}(k\\in\\lbrace-1,1,0\\rbrace,m,n\\in{N}^{*})$\n\n|       |     |     |  |  |\n| :---: | :----: | :----: | :----: | ------ |\n| $k=1,m,n$  | $R$ | $R$ |  | {% asset_img power-function-example-1.png 300 300 %} $$red:f(x)=x^\\frac{1}{3}$$$$blue:f(x)=x^{3}$$ |\n| $k=-1,m,n$  | $(-\\infty,0)\\cup(0,+\\infty)$ | $(-\\infty,0)\\cup(0,+\\infty)$ |  | {% asset_img power-function-example-2.png 300 300 %} $$red:f(x)=x^{-\\frac{1}{3}}$$$$blue:f(x)=x^{-3}$$ |\n| $k=1,m$ $,n$  | $[0,+\\infty)$ | $[0,+\\infty)$ |  | {% asset_img power-function-example-3.png 300 300 %} $$red:f(x)=x^{\\frac{3}{2}}$$$$blue:f(x)=x^{\\frac{1}{2}}$$$$green:f(x)=x^{\\frac{5}{2}}$$ |\n| $k=-1,m$ $,n$  | $(0,+\\infty)$ | $(0,+\\infty)$ |  | {% asset_img power-function-example-4.png 300 300 %} $$red:f(x)=x^{-\\frac{3}{2}}$$$$blue:f(x)=x^{-\\frac{1}{2}}$$$$green:f(x)=x^{-\\frac{5}{2}}$$ |\n| $k=1,m$ $,n$  | $R$ | $[0,+\\infty)$ |  | {% asset_img power-function-example-5.png 300 300 %} $$red:f(x)=x^{\\frac{4}{3}}$$$$blue:f(x)=x^{\\frac{2}{3}}$$$$green:f(x)=x^{2}$$ |\n| $k=-1,m$ $,n$  | $(-\\infty,0)\\cup(0,+\\infty)$ | $(0,+\\infty)$ |  | {% asset_img power-function-example-6.png 300 300 %} $$red:f(x)=x^{-\\frac{4}{3}}$$$$blue:f(x)=x^{-\\frac{2}{3}}$$$$green:f(x)=x^{-2}$$ |\n| $k=0$ | $(-\\infty,0)\\cup(0,+\\infty)$ | $\\lbrace1\\rbrace$ |  | {% asset_img power-function-example-7.png 300 300 %} $$red:f(x)=x^{0}$$$f(x)=x^{0}$  $y=1$  $(0,1)$ |\n\n\n\n## 1.3 \n\n $f(x)=b^x$$b$  $b\\in(0,1)\\cup(1,+\\infty)$ $R$ $(0,+\\infty)$\n\n $b^x$  $1$ $x$  $x$ \n\n### 1.3.1 \n|       |     |  |\n| :---: | :----: | ------ |\n| $0<b<1$ | $(0,+\\infty)$ | {% asset_img exponential-function-example-1.png 300 300 %} $$red:f(x)=\\frac{1}{2}^x$$$$blue:f(x)=\\frac{1}{4}^x$$ |\n| $b>1$ | $(0,+\\infty)$ | {% asset_img exponential-function-example-2.png 300 300 %} $$red:f(x)=2^x$$$$blue:f(x)=4^x$$ |\n\n### 1.3.2 \n\n#### 1.3.2.1  1\n\n\n\n\t$e^x=\\lim_{n \\to \\infty}(1+\\frac{x}{n})^{n}$\n\n\n\n\t$e^0=1$\n\n\t$e^1=e$\n\n\t$e^{x+y}=e^xe^y$\n\n\t$e^{xy}=(e^x)^y$\n\n\t$\\frac{e^x}{e^y}=e^{x-y}$\n\n\t$e^{-x}=e^{0-x}=\\frac{e^0}{e^x}=\\frac{1}{e^x}$\n\n $x\\in{R},y\\in{R}$\n\n\n\n#### 1.3.2.2  2\n\n $x$  $e$\n\n$b^x=(e^{\\ln{b}})^x=e^{x\\ln{b}}$\n\n\n\n#### 1.3.2.3  3\n\n $b>0$ $x$\" $b$ \"\n\n$b^{\\frac{m}{n}=\\sqrt[n]{b^m}}$\n\n\n\n$\\sqrt[n]{b}=b^{\\frac{1}{n}}=(e^{\\ln{b}})^{\\frac{1}{n}}=e^{\\frac{\\ln{b}}{n}}$\n\n\n\n## 1.4 \n\n\n\n $b^x=N(b>0,b\\neq1)$ $x$  $b$  $N$  $x=\\log_{b}{N}$ $b$  $N$  $b$ $N$ \n\n $f(x)=\\log_{b}{x}(b>0,b\\neq1)$ $(0,+\\infty)$ $R$ \n\n $x=b^y$ $b$ \n\n### 1.4.1 \n|       |     |  |\n| :---: | :----: | ------ |\n| $0<b<1$ | $R$ | {% asset_img logarithmic-function-example-1.png 300 300 %} $$red:f(x)=\\log_{\\frac{1}{2}}{x}$$$$blue:f(x)=\\log_{\\frac{1}{4}}{x}$$ |\n| $b>1$ | $R$ | {% asset_img logarithmic-function-example-2.png 300 300 %} $$red:f(x)=\\log_{2}{x}$$$$blue:f(x)=\\log_{4}{x}$$ |\n\n### 1.4.2 \n\n- $(1,0)$\n\n-  $0<b<1$  $(0,+\\infty)$ $b>1$  $(0,+\\infty)$ \n\n-  $f(x)=\\log_{b}{x}(b>0,b\\neq1,x>0)$\n\n   $0<b<1,0<x<1$ $f(x)=\\log_{b}{x}>0$\n  \n   $b>1, x>1$ $f(x)=\\log_{b}{x}>0$\n  \n   $0<b<1, x>1$ $f(x)=\\log_{b}{x}<0$\n  \n   $b>1, 0<x<1$ $f(x)=\\log_{b}{x}<0$\n  \n-  $b$ $f(x)=\\log_{b}{x}$ $f(x)=b^x$  $y = x$ \n\n{% asset_img logarithmic-function-example-3.png 300 300 %} $$red:f(x)=\\log_{2}{x}$$$$blue:f(x)=2^{x}$$$$green:f(x)=\\log_{\\frac{1}{2}}{x}$$$$blue:f(x)={\\frac{1}{2}}^{x}$$\n\n### 1.4.3 \n\n#### 1.4.3.1 \n\n$\\log_{b}{x}=\\frac{\\log_{k}{x}}{\\log_{k}{b}}$\n\n##### 1.4.3.1.1 \n\n\n\n$x=b^{\\log_{b}{x}}$\n\n $k$ \n\n$\\log_{k}{x}=\\log_{k}({b^{\\log_{b}{x}})}$\n\n$\\because b^x=N(b>0,b\\neq1)$ $x=\\log_{b}{N}$\n\n $(b^x)^t=b^{xt}=N^t\\ (t\\in{R})$\n\n$xt=\\log_{b}{N^t}=t\\log_{b}{N}\\ (t\\in{R})$\n\n$\\therefore\\log_{k}{x}=\\log_{k}{b^{\\log_{b}{x}}}=\\log_{b}{x}\\log_{k}{b}$\n\n$\\log_{b}{x}=\\frac{\\log_{k}{x}}{\\log_{k}{b}}$ \n\n\n\n#### 1.4.3.2 \n\n$\\log_{b}{MN}=\\log_{b}{M}+\\log_{b}{N}$\n\n$\\log_{b}{\\frac{M}{N}}=\\log_{b}{M}-\\log_{b}{N}$\n\n##### 1.4.3.2.1 \n\n $M=\\beta^{m},N=\\beta^{n}$\n\n $\\log_{b}{MN}=\\log_{b}({\\beta^{m}\\beta^{n}})$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}({\\beta^{m+n}})$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =(m+n)\\log_{b}{\\beta}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =m\\log_{b}{\\beta}+n\\log_{b}{\\beta}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{\\beta^m}+\\log_{b}{\\beta^n}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}+\\log_{b}{N}$\n\n$\\log_{b}{\\frac{M}{N}}=\\log_{b}{M}+\\log_{b}{\\frac{1}{N}}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}+\\log_{b}{N^{-1}}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}-\\log_{b}{N}$\n\n\n\n#### 1.4.3.3 \n\n$\\log_{b^N}({x^M})=\\frac{M}{N}\\log_{b}{x}$\n\n##### 1.4.3.3.1 \n\n\n\n$\\log_{b^N}({x^M})=\\frac{\\ln{b^N}}{\\ln{x^M}}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\frac{N\\ln{b}}{M\\ln{x}}$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\frac{M}{N}\\log_{b}{x}$\n\n##### \n\n#### 1.4.3.4 \n\n$b^{\\log_{b}{x}}=x$\n\n$\\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{b^x}$\n\n\n\n#### 1.4.3.5 \n\n$M^{\\log_{b}{N}} = N^{\\log_{b}{M}}$\n\n##### 1.4.3.5.1 \n\n $\\alpha=\\log_{b}{N},\\  \\beta=\\log_{b}{M}$ $b^\\alpha=N,\\ b^\\beta=M, \\ (b^\\beta)^\\alpha=(b^\\alpha)^\\beta$\n\n$\\therefore M^{\\log_{b}{N}} = N^{\\log_{b}{M}}$\n\n\n\n#### 1.4.3.6 \n\n$\\log_{b}{\\theta}=\\frac{\\ln \\theta}{\\ln b}=\\frac{1}{\\frac{\\ln b}{\\ln \\theta}}=\\frac{1}{\\log_{\\theta}{b}}$\n\n\n\n## 1.5 \n\n<!--TODO-->\n\n\n\n## 1.6 \n\n<!--TODO-->\n\n\n\n# 2. \n\n****\n\n****\n\n\n\n\n\n\n> \n>\n> https://baike.baidu.com/item/%E5%9F%BA%E6%9C%AC%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0\n>\n> https://zh.wikipedia.org/wiki/%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0\n\n\n<style>\n  table {\n    width: 1100px; /**/\n    max-width: 1100px; /**/\n    border: 1px solid #dedede; /**/\n    margin: 1px auto; /**/\n    border-collapse: collapse; /**/\n    empty-cells: show; /**/\n  }\n  table th,\n  table td {\n    height: 35px; /**/\n    border: 1px solid #dedede; /**/\n    padding: 0 10px; /**/\n  }\n  table th {\n    font-weight: bold; /**/\n    text-align: center !important; /* !important  Markdown */\n    background: #F8F8F8; /**/\n  }\n  table tbody tr:nth-child(n) {\n    background: #FFFFFF; \n  }\n  table tr:hover {\n    background: #EFEFEF; \n}\n  table th {\n    white-space: nowrap; /**/\n  }\n  table td:nth-child(1) {\n    white-space: nowrap; /**/\n  }\n</style>\n","slug":"elementary-function","published":1,"updated":"2021-03-26T13:30:23.792Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckmsyc4rc00075npr842r5mu3","content":"<p><strong></strong><br><strong></strong><br><strong></strong></p>\n<a id=\"more\"></a>\n\n<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><h2 id=\"1-1-\"><a href=\"#1-1-\" class=\"headerlink\" title=\"1.1 \"></a>1.1 </h2><p></p>\n<p> $f(x)=C$ $C$ $(-\\infty,+\\infty)$</p>\n<h3 id=\"1-1-1-\"><a href=\"#1-1-1-\" class=\"headerlink\" title=\"1.1.1 \"></a>1.1.1 </h3><img src=\"/2021/03/10/elementary-function/constant-function-example-1.png\" class=\"\" width=\"300\" height=\"300\">\n\n<p>$$f(x)=1$$</p>\n<h2 id=\"1-2-\"><a href=\"#1-2-\" class=\"headerlink\" title=\"1.2 \"></a>1.2 </h2><p></p>\n<p> $f(x)=x^$$a$ </p>\n<h3 id=\"1-2-1-\"><a href=\"#1-2-1-\" class=\"headerlink\" title=\"1.2.1 \"></a>1.2.1 </h3><p> $a$ </p>\n<p>$f(x)=x^{k\\frac{m}{n}}(k\\in\\lbrace-1,1,0\\rbrace,m,n\\in{N}^{*})$</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">$k=1,m,n$ </td>\n<td align=\"center\">$R$</td>\n<td align=\"center\">$R$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-1.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^\\frac{1}{3}$$$$blue:f(x)=x^{3}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=-1,m,n$ </td>\n<td align=\"center\">$(-\\infty,0)\\cup(0,+\\infty)$</td>\n<td align=\"center\">$(-\\infty,0)\\cup(0,+\\infty)$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-2.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{-\\frac{1}{3}}$$$$blue:f(x)=x^{-3}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=1,m$ $,n$ </td>\n<td align=\"center\">$[0,+\\infty)$</td>\n<td align=\"center\">$[0,+\\infty)$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-3.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{\\frac{3}{2}}$$$$blue:f(x)=x^{\\frac{1}{2}}$$$$green:f(x)=x^{\\frac{5}{2}}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=-1,m$ $,n$ </td>\n<td align=\"center\">$(0,+\\infty)$</td>\n<td align=\"center\">$(0,+\\infty)$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-4.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{-\\frac{3}{2}}$$$$blue:f(x)=x^{-\\frac{1}{2}}$$$$green:f(x)=x^{-\\frac{5}{2}}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=1,m$ $,n$ </td>\n<td align=\"center\">$R$</td>\n<td align=\"center\">$[0,+\\infty)$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-5.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{\\frac{4}{3}}$$$$blue:f(x)=x^{\\frac{2}{3}}$$$$green:f(x)=x^{2}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=-1,m$ $,n$ </td>\n<td align=\"center\">$(-\\infty,0)\\cup(0,+\\infty)$</td>\n<td align=\"center\">$(0,+\\infty)$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-6.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{-\\frac{4}{3}}$$$$blue:f(x)=x^{-\\frac{2}{3}}$$$$green:f(x)=x^{-2}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=0$</td>\n<td align=\"center\">$(-\\infty,0)\\cup(0,+\\infty)$</td>\n<td align=\"center\">$\\lbrace1\\rbrace$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-7.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{0}$$$f(x)=x^{0}$  $y=1$  $(0,1)$</td>\n</tr>\n</tbody></table>\n<h2 id=\"1-3-\"><a href=\"#1-3-\" class=\"headerlink\" title=\"1.3 \"></a>1.3 </h2><p> $f(x)=b^x$$b$  $b\\in(0,1)\\cup(1,+\\infty)$ $R$ $(0,+\\infty)$</p>\n<p> $b^x$  $1$ $x$  $x$ </p>\n<h3 id=\"1-3-1-\"><a href=\"#1-3-1-\" class=\"headerlink\" title=\"1.3.1 \"></a>1.3.1 </h3><table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">$0&lt;b&lt;1$</td>\n<td align=\"center\">$(0,+\\infty)$</td>\n<td><img src=\"/2021/03/10/elementary-function/exponential-function-example-1.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=\\frac{1}{2}^x$$$$blue:f(x)=\\frac{1}{4}^x$$</td>\n</tr>\n<tr>\n<td align=\"center\">$b&gt;1$</td>\n<td align=\"center\">$(0,+\\infty)$</td>\n<td><img src=\"/2021/03/10/elementary-function/exponential-function-example-2.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=2^x$$$$blue:f(x)=4^x$$</td>\n</tr>\n</tbody></table>\n<h3 id=\"1-3-2-\"><a href=\"#1-3-2-\" class=\"headerlink\" title=\"1.3.2 \"></a>1.3.2 </h3><h4 id=\"1-3-2-1--1\"><a href=\"#1-3-2-1--1\" class=\"headerlink\" title=\"1.3.2.1  1\"></a>1.3.2.1  1</h4><p></p>\n<p>    $e^x=\\lim_{n \\to \\infty}(1+\\frac{x}{n})^{n}$</p>\n<p></p>\n<p>    $e^0=1$</p>\n<p>    $e^1=e$</p>\n<p>    $e^{x+y}=e^xe^y$</p>\n<p>    $e^{xy}=(e^x)^y$</p>\n<p>    $\\frac{e^x}{e^y}=e^{x-y}$</p>\n<p>    $e^{-x}=e^{0-x}=\\frac{e^0}{e^x}=\\frac{1}{e^x}$</p>\n<p> $x\\in{R},y\\in{R}$</p>\n<h4 id=\"1-3-2-2--2\"><a href=\"#1-3-2-2--2\" class=\"headerlink\" title=\"1.3.2.2  2\"></a>1.3.2.2  2</h4><p> $x$  $e$</p>\n<p>$b^x=(e^{\\ln{b}})^x=e^{x\\ln{b}}$</p>\n<h4 id=\"1-3-2-3--3\"><a href=\"#1-3-2-3--3\" class=\"headerlink\" title=\"1.3.2.3  3\"></a>1.3.2.3  3</h4><p> $b&gt;0$ $x$ $b$ </p>\n<p>$b^{\\frac{m}{n}=\\sqrt[n]{b^m}}$</p>\n<p></p>\n<p>$\\sqrt[n]{b}=b^{\\frac{1}{n}}=(e^{\\ln{b}})^{\\frac{1}{n}}=e^{\\frac{\\ln{b}}{n}}$</p>\n<h2 id=\"1-4-\"><a href=\"#1-4-\" class=\"headerlink\" title=\"1.4 \"></a>1.4 </h2><p></p>\n<p> $b^x=N(b&gt;0,b\\neq1)$ $x$  $b$  $N$  $x=\\log_{b}{N}$ $b$  $N$  $b$ $N$ </p>\n<p> $f(x)=\\log_{b}{x}(b&gt;0,b\\neq1)$ $(0,+\\infty)$ $R$ </p>\n<p> $x=b^y$ $b$ </p>\n<h3 id=\"1-4-1-\"><a href=\"#1-4-1-\" class=\"headerlink\" title=\"1.4.1 \"></a>1.4.1 </h3><table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">$0&lt;b&lt;1$</td>\n<td align=\"center\">$R$</td>\n<td><img src=\"/2021/03/10/elementary-function/logarithmic-function-example-1.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=\\log_{\\frac{1}{2}}{x}$$$$blue:f(x)=\\log_{\\frac{1}{4}}{x}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$b&gt;1$</td>\n<td align=\"center\">$R$</td>\n<td><img src=\"/2021/03/10/elementary-function/logarithmic-function-example-2.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=\\log_{2}{x}$$$$blue:f(x)=\\log_{4}{x}$$</td>\n</tr>\n</tbody></table>\n<h3 id=\"1-4-2-\"><a href=\"#1-4-2-\" class=\"headerlink\" title=\"1.4.2 \"></a>1.4.2 </h3><ul>\n<li><p>$(1,0)$</p>\n</li>\n<li><p> $0&lt;b&lt;1$  $(0,+\\infty)$ $b&gt;1$  $(0,+\\infty)$ </p>\n</li>\n<li><p> $f(x)=\\log_{b}{x}(b&gt;0,b\\neq1,x&gt;0)$</p>\n<p> $0&lt;b&lt;1,0&lt;x&lt;1$ $f(x)=\\log_{b}{x}&gt;0$</p>\n<p> $b&gt;1, x&gt;1$ $f(x)=\\log_{b}{x}&gt;0$</p>\n<p> $0&lt;b&lt;1, x&gt;1$ $f(x)=\\log_{b}{x}&lt;0$</p>\n<p> $b&gt;1, 0&lt;x&lt;1$ $f(x)=\\log_{b}{x}&lt;0$</p>\n</li>\n<li><p> $b$ $f(x)=\\log_{b}{x}$ $f(x)=b^x$  $y = x$ </p>\n</li>\n</ul>\n<img src=\"/2021/03/10/elementary-function/logarithmic-function-example-3.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=\\log_{2}{x}$$$$blue:f(x)=2^{x}$$$$green:f(x)=\\log_{\\frac{1}{2}}{x}$$$$blue:f(x)={\\frac{1}{2}}^{x}$$\n\n<h3 id=\"1-4-3-\"><a href=\"#1-4-3-\" class=\"headerlink\" title=\"1.4.3 \"></a>1.4.3 </h3><h4 id=\"1-4-3-1-\"><a href=\"#1-4-3-1-\" class=\"headerlink\" title=\"1.4.3.1 \"></a>1.4.3.1 </h4><p>$\\log_{b}{x}=\\frac{\\log_{k}{x}}{\\log_{k}{b}}$</p>\n<h5 id=\"1-4-3-1-1-\"><a href=\"#1-4-3-1-1-\" class=\"headerlink\" title=\"1.4.3.1.1 \"></a>1.4.3.1.1 </h5><p></p>\n<p>$x=b^{\\log_{b}{x}}$</p>\n<p> $k$ </p>\n<p>$\\log_{k}{x}=\\log_{k}({b^{\\log_{b}{x}})}$</p>\n<p>$\\because b^x=N(b&gt;0,b\\neq1)$ $x=\\log_{b}{N}$</p>\n<p> $(b^x)^t=b^{xt}=N^t\\ (t\\in{R})$</p>\n<p>$xt=\\log_{b}{N^t}=t\\log_{b}{N}\\ (t\\in{R})$</p>\n<p>$\\therefore\\log_{k}{x}=\\log_{k}{b^{\\log_{b}{x}}}=\\log_{b}{x}\\log_{k}{b}$</p>\n<p>$\\log_{b}{x}=\\frac{\\log_{k}{x}}{\\log_{k}{b}}$ </p>\n<h4 id=\"1-4-3-2-\"><a href=\"#1-4-3-2-\" class=\"headerlink\" title=\"1.4.3.2 \"></a>1.4.3.2 </h4><p>$\\log_{b}{MN}=\\log_{b}{M}+\\log_{b}{N}$</p>\n<p>$\\log_{b}{\\frac{M}{N}}=\\log_{b}{M}-\\log_{b}{N}$</p>\n<h5 id=\"1-4-3-2-1-\"><a href=\"#1-4-3-2-1-\" class=\"headerlink\" title=\"1.4.3.2.1 \"></a>1.4.3.2.1 </h5><p> $M=\\beta^{m},N=\\beta^{n}$</p>\n<p> $\\log_{b}{MN}=\\log_{b}({\\beta^{m}\\beta^{n}})$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}({\\beta^{m+n}})$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =(m+n)\\log_{b}{\\beta}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =m\\log_{b}{\\beta}+n\\log_{b}{\\beta}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{\\beta^m}+\\log_{b}{\\beta^n}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}+\\log_{b}{N}$</p>\n<p>$\\log_{b}{\\frac{M}{N}}=\\log_{b}{M}+\\log_{b}{\\frac{1}{N}}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}+\\log_{b}{N^{-1}}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}-\\log_{b}{N}$</p>\n<h4 id=\"1-4-3-3-\"><a href=\"#1-4-3-3-\" class=\"headerlink\" title=\"1.4.3.3 \"></a>1.4.3.3 </h4><p>$\\log_{b^N}({x^M})=\\frac{M}{N}\\log_{b}{x}$</p>\n<h5 id=\"1-4-3-3-1-\"><a href=\"#1-4-3-3-1-\" class=\"headerlink\" title=\"1.4.3.3.1 \"></a>1.4.3.3.1 </h5><p></p>\n<p>$\\log_{b^N}({x^M})=\\frac{\\ln{b^N}}{\\ln{x^M}}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\frac{N\\ln{b}}{M\\ln{x}}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\frac{M}{N}\\log_{b}{x}$</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><h4 id=\"1-4-3-4-\"><a href=\"#1-4-3-4-\" class=\"headerlink\" title=\"1.4.3.4 \"></a>1.4.3.4 </h4><p>$b^{\\log_{b}{x}}=x$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{b^x}$</p>\n<h4 id=\"1-4-3-5-\"><a href=\"#1-4-3-5-\" class=\"headerlink\" title=\"1.4.3.5 \"></a>1.4.3.5 </h4><p>$M^{\\log_{b}{N}} = N^{\\log_{b}{M}}$</p>\n<h5 id=\"1-4-3-5-1-\"><a href=\"#1-4-3-5-1-\" class=\"headerlink\" title=\"1.4.3.5.1 \"></a>1.4.3.5.1 </h5><p> $\\alpha=\\log_{b}{N},\\  \\beta=\\log_{b}{M}$ $b^\\alpha=N,\\ b^\\beta=M, \\ (b^\\beta)^\\alpha=(b^\\alpha)^\\beta$</p>\n<p>$\\therefore M^{\\log_{b}{N}} = N^{\\log_{b}{M}}$</p>\n<h4 id=\"1-4-3-6-\"><a href=\"#1-4-3-6-\" class=\"headerlink\" title=\"1.4.3.6 \"></a>1.4.3.6 </h4><p>$\\log_{b}{\\theta}=\\frac{\\ln \\theta}{\\ln b}=\\frac{1}{\\frac{\\ln b}{\\ln \\theta}}=\\frac{1}{\\log_{\\theta}{b}}$</p>\n<h2 id=\"1-5-\"><a href=\"#1-5-\" class=\"headerlink\" title=\"1.5 \"></a>1.5 </h2><!--TODO-->\n\n\n\n<h2 id=\"1-6-\"><a href=\"#1-6-\" class=\"headerlink\" title=\"1.6 \"></a>1.6 </h2><!--TODO-->\n\n\n\n<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><p><strong></strong></p>\n<p><strong></strong></p>\n<p></p>\n<blockquote>\n<p></p>\n<p><a href=\"https://baike.baidu.com/item/%E5%9F%BA%E6%9C%AC%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0\">https://baike.baidu.com/item/%E5%9F%BA%E6%9C%AC%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0</a></p>\n<p><a href=\"https://zh.wikipedia.org/wiki/%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0\">https://zh.wikipedia.org/wiki/%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0</a></p>\n</blockquote>\n<style>\n  table {\n    width: 1100px; /**/\n    max-width: 1100px; /**/\n    border: 1px solid #dedede; /**/\n    margin: 1px auto; /**/\n    border-collapse: collapse; /**/\n    empty-cells: show; /**/\n  }\n  table th,\n  table td {\n    height: 35px; /**/\n    border: 1px solid #dedede; /**/\n    padding: 0 10px; /**/\n  }\n  table th {\n    font-weight: bold; /**/\n    text-align: center !important; /* !important  Markdown */\n    background: #F8F8F8; /**/\n  }\n  table tbody tr:nth-child(n) {\n    background: #FFFFFF; \n  }\n  table tr:hover {\n    background: #EFEFEF; \n}\n  table th {\n    white-space: nowrap; /**/\n  }\n  table td:nth-child(1) {\n    white-space: nowrap; /**/\n  }\n</style>\n","site":{"data":{}},"excerpt":"<p><strong></strong><br><strong></strong><br><strong></strong></p>","more":"<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><h2 id=\"1-1-\"><a href=\"#1-1-\" class=\"headerlink\" title=\"1.1 \"></a>1.1 </h2><p></p>\n<p> $f(x)=C$ $C$ $(-\\infty,+\\infty)$</p>\n<h3 id=\"1-1-1-\"><a href=\"#1-1-1-\" class=\"headerlink\" title=\"1.1.1 \"></a>1.1.1 </h3><img src=\"/2021/03/10/elementary-function/constant-function-example-1.png\" class=\"\" width=\"300\" height=\"300\">\n\n<p>$$f(x)=1$$</p>\n<h2 id=\"1-2-\"><a href=\"#1-2-\" class=\"headerlink\" title=\"1.2 \"></a>1.2 </h2><p></p>\n<p> $f(x)=x^$$a$ </p>\n<h3 id=\"1-2-1-\"><a href=\"#1-2-1-\" class=\"headerlink\" title=\"1.2.1 \"></a>1.2.1 </h3><p> $a$ </p>\n<p>$f(x)=x^{k\\frac{m}{n}}(k\\in\\lbrace-1,1,0\\rbrace,m,n\\in{N}^{*})$</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">$k=1,m,n$ </td>\n<td align=\"center\">$R$</td>\n<td align=\"center\">$R$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-1.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^\\frac{1}{3}$$$$blue:f(x)=x^{3}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=-1,m,n$ </td>\n<td align=\"center\">$(-\\infty,0)\\cup(0,+\\infty)$</td>\n<td align=\"center\">$(-\\infty,0)\\cup(0,+\\infty)$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-2.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{-\\frac{1}{3}}$$$$blue:f(x)=x^{-3}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=1,m$ $,n$ </td>\n<td align=\"center\">$[0,+\\infty)$</td>\n<td align=\"center\">$[0,+\\infty)$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-3.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{\\frac{3}{2}}$$$$blue:f(x)=x^{\\frac{1}{2}}$$$$green:f(x)=x^{\\frac{5}{2}}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=-1,m$ $,n$ </td>\n<td align=\"center\">$(0,+\\infty)$</td>\n<td align=\"center\">$(0,+\\infty)$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-4.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{-\\frac{3}{2}}$$$$blue:f(x)=x^{-\\frac{1}{2}}$$$$green:f(x)=x^{-\\frac{5}{2}}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=1,m$ $,n$ </td>\n<td align=\"center\">$R$</td>\n<td align=\"center\">$[0,+\\infty)$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-5.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{\\frac{4}{3}}$$$$blue:f(x)=x^{\\frac{2}{3}}$$$$green:f(x)=x^{2}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=-1,m$ $,n$ </td>\n<td align=\"center\">$(-\\infty,0)\\cup(0,+\\infty)$</td>\n<td align=\"center\">$(0,+\\infty)$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-6.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{-\\frac{4}{3}}$$$$blue:f(x)=x^{-\\frac{2}{3}}$$$$green:f(x)=x^{-2}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$k=0$</td>\n<td align=\"center\">$(-\\infty,0)\\cup(0,+\\infty)$</td>\n<td align=\"center\">$\\lbrace1\\rbrace$</td>\n<td align=\"center\"></td>\n<td><img src=\"/2021/03/10/elementary-function/power-function-example-7.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=x^{0}$$$f(x)=x^{0}$  $y=1$  $(0,1)$</td>\n</tr>\n</tbody></table>\n<h2 id=\"1-3-\"><a href=\"#1-3-\" class=\"headerlink\" title=\"1.3 \"></a>1.3 </h2><p> $f(x)=b^x$$b$  $b\\in(0,1)\\cup(1,+\\infty)$ $R$ $(0,+\\infty)$</p>\n<p> $b^x$  $1$ $x$  $x$ </p>\n<h3 id=\"1-3-1-\"><a href=\"#1-3-1-\" class=\"headerlink\" title=\"1.3.1 \"></a>1.3.1 </h3><table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">$0&lt;b&lt;1$</td>\n<td align=\"center\">$(0,+\\infty)$</td>\n<td><img src=\"/2021/03/10/elementary-function/exponential-function-example-1.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=\\frac{1}{2}^x$$$$blue:f(x)=\\frac{1}{4}^x$$</td>\n</tr>\n<tr>\n<td align=\"center\">$b&gt;1$</td>\n<td align=\"center\">$(0,+\\infty)$</td>\n<td><img src=\"/2021/03/10/elementary-function/exponential-function-example-2.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=2^x$$$$blue:f(x)=4^x$$</td>\n</tr>\n</tbody></table>\n<h3 id=\"1-3-2-\"><a href=\"#1-3-2-\" class=\"headerlink\" title=\"1.3.2 \"></a>1.3.2 </h3><h4 id=\"1-3-2-1--1\"><a href=\"#1-3-2-1--1\" class=\"headerlink\" title=\"1.3.2.1  1\"></a>1.3.2.1  1</h4><p></p>\n<p>    $e^x=\\lim_{n \\to \\infty}(1+\\frac{x}{n})^{n}$</p>\n<p></p>\n<p>    $e^0=1$</p>\n<p>    $e^1=e$</p>\n<p>    $e^{x+y}=e^xe^y$</p>\n<p>    $e^{xy}=(e^x)^y$</p>\n<p>    $\\frac{e^x}{e^y}=e^{x-y}$</p>\n<p>    $e^{-x}=e^{0-x}=\\frac{e^0}{e^x}=\\frac{1}{e^x}$</p>\n<p> $x\\in{R},y\\in{R}$</p>\n<h4 id=\"1-3-2-2--2\"><a href=\"#1-3-2-2--2\" class=\"headerlink\" title=\"1.3.2.2  2\"></a>1.3.2.2  2</h4><p> $x$  $e$</p>\n<p>$b^x=(e^{\\ln{b}})^x=e^{x\\ln{b}}$</p>\n<h4 id=\"1-3-2-3--3\"><a href=\"#1-3-2-3--3\" class=\"headerlink\" title=\"1.3.2.3  3\"></a>1.3.2.3  3</h4><p> $b&gt;0$ $x$ $b$ </p>\n<p>$b^{\\frac{m}{n}=\\sqrt[n]{b^m}}$</p>\n<p></p>\n<p>$\\sqrt[n]{b}=b^{\\frac{1}{n}}=(e^{\\ln{b}})^{\\frac{1}{n}}=e^{\\frac{\\ln{b}}{n}}$</p>\n<h2 id=\"1-4-\"><a href=\"#1-4-\" class=\"headerlink\" title=\"1.4 \"></a>1.4 </h2><p></p>\n<p> $b^x=N(b&gt;0,b\\neq1)$ $x$  $b$  $N$  $x=\\log_{b}{N}$ $b$  $N$  $b$ $N$ </p>\n<p> $f(x)=\\log_{b}{x}(b&gt;0,b\\neq1)$ $(0,+\\infty)$ $R$ </p>\n<p> $x=b^y$ $b$ </p>\n<h3 id=\"1-4-1-\"><a href=\"#1-4-1-\" class=\"headerlink\" title=\"1.4.1 \"></a>1.4.1 </h3><table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">$0&lt;b&lt;1$</td>\n<td align=\"center\">$R$</td>\n<td><img src=\"/2021/03/10/elementary-function/logarithmic-function-example-1.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=\\log_{\\frac{1}{2}}{x}$$$$blue:f(x)=\\log_{\\frac{1}{4}}{x}$$</td>\n</tr>\n<tr>\n<td align=\"center\">$b&gt;1$</td>\n<td align=\"center\">$R$</td>\n<td><img src=\"/2021/03/10/elementary-function/logarithmic-function-example-2.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=\\log_{2}{x}$$$$blue:f(x)=\\log_{4}{x}$$</td>\n</tr>\n</tbody></table>\n<h3 id=\"1-4-2-\"><a href=\"#1-4-2-\" class=\"headerlink\" title=\"1.4.2 \"></a>1.4.2 </h3><ul>\n<li><p>$(1,0)$</p>\n</li>\n<li><p> $0&lt;b&lt;1$  $(0,+\\infty)$ $b&gt;1$  $(0,+\\infty)$ </p>\n</li>\n<li><p> $f(x)=\\log_{b}{x}(b&gt;0,b\\neq1,x&gt;0)$</p>\n<p> $0&lt;b&lt;1,0&lt;x&lt;1$ $f(x)=\\log_{b}{x}&gt;0$</p>\n<p> $b&gt;1, x&gt;1$ $f(x)=\\log_{b}{x}&gt;0$</p>\n<p> $0&lt;b&lt;1, x&gt;1$ $f(x)=\\log_{b}{x}&lt;0$</p>\n<p> $b&gt;1, 0&lt;x&lt;1$ $f(x)=\\log_{b}{x}&lt;0$</p>\n</li>\n<li><p> $b$ $f(x)=\\log_{b}{x}$ $f(x)=b^x$  $y = x$ </p>\n</li>\n</ul>\n<img src=\"/2021/03/10/elementary-function/logarithmic-function-example-3.png\" class=\"\" width=\"300\" height=\"300\"> $$red:f(x)=\\log_{2}{x}$$$$blue:f(x)=2^{x}$$$$green:f(x)=\\log_{\\frac{1}{2}}{x}$$$$blue:f(x)={\\frac{1}{2}}^{x}$$\n\n<h3 id=\"1-4-3-\"><a href=\"#1-4-3-\" class=\"headerlink\" title=\"1.4.3 \"></a>1.4.3 </h3><h4 id=\"1-4-3-1-\"><a href=\"#1-4-3-1-\" class=\"headerlink\" title=\"1.4.3.1 \"></a>1.4.3.1 </h4><p>$\\log_{b}{x}=\\frac{\\log_{k}{x}}{\\log_{k}{b}}$</p>\n<h5 id=\"1-4-3-1-1-\"><a href=\"#1-4-3-1-1-\" class=\"headerlink\" title=\"1.4.3.1.1 \"></a>1.4.3.1.1 </h5><p></p>\n<p>$x=b^{\\log_{b}{x}}$</p>\n<p> $k$ </p>\n<p>$\\log_{k}{x}=\\log_{k}({b^{\\log_{b}{x}})}$</p>\n<p>$\\because b^x=N(b&gt;0,b\\neq1)$ $x=\\log_{b}{N}$</p>\n<p> $(b^x)^t=b^{xt}=N^t\\ (t\\in{R})$</p>\n<p>$xt=\\log_{b}{N^t}=t\\log_{b}{N}\\ (t\\in{R})$</p>\n<p>$\\therefore\\log_{k}{x}=\\log_{k}{b^{\\log_{b}{x}}}=\\log_{b}{x}\\log_{k}{b}$</p>\n<p>$\\log_{b}{x}=\\frac{\\log_{k}{x}}{\\log_{k}{b}}$ </p>\n<h4 id=\"1-4-3-2-\"><a href=\"#1-4-3-2-\" class=\"headerlink\" title=\"1.4.3.2 \"></a>1.4.3.2 </h4><p>$\\log_{b}{MN}=\\log_{b}{M}+\\log_{b}{N}$</p>\n<p>$\\log_{b}{\\frac{M}{N}}=\\log_{b}{M}-\\log_{b}{N}$</p>\n<h5 id=\"1-4-3-2-1-\"><a href=\"#1-4-3-2-1-\" class=\"headerlink\" title=\"1.4.3.2.1 \"></a>1.4.3.2.1 </h5><p> $M=\\beta^{m},N=\\beta^{n}$</p>\n<p> $\\log_{b}{MN}=\\log_{b}({\\beta^{m}\\beta^{n}})$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}({\\beta^{m+n}})$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =(m+n)\\log_{b}{\\beta}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =m\\log_{b}{\\beta}+n\\log_{b}{\\beta}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{\\beta^m}+\\log_{b}{\\beta^n}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}+\\log_{b}{N}$</p>\n<p>$\\log_{b}{\\frac{M}{N}}=\\log_{b}{M}+\\log_{b}{\\frac{1}{N}}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}+\\log_{b}{N^{-1}}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{M}-\\log_{b}{N}$</p>\n<h4 id=\"1-4-3-3-\"><a href=\"#1-4-3-3-\" class=\"headerlink\" title=\"1.4.3.3 \"></a>1.4.3.3 </h4><p>$\\log_{b^N}({x^M})=\\frac{M}{N}\\log_{b}{x}$</p>\n<h5 id=\"1-4-3-3-1-\"><a href=\"#1-4-3-3-1-\" class=\"headerlink\" title=\"1.4.3.3.1 \"></a>1.4.3.3.1 </h5><p></p>\n<p>$\\log_{b^N}({x^M})=\\frac{\\ln{b^N}}{\\ln{x^M}}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\frac{N\\ln{b}}{M\\ln{x}}$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ =\\frac{M}{N}\\log_{b}{x}$</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><h4 id=\"1-4-3-4-\"><a href=\"#1-4-3-4-\" class=\"headerlink\" title=\"1.4.3.4 \"></a>1.4.3.4 </h4><p>$b^{\\log_{b}{x}}=x$</p>\n<p>$\\ \\ \\ \\ \\ \\ \\ \\ =\\log_{b}{b^x}$</p>\n<h4 id=\"1-4-3-5-\"><a href=\"#1-4-3-5-\" class=\"headerlink\" title=\"1.4.3.5 \"></a>1.4.3.5 </h4><p>$M^{\\log_{b}{N}} = N^{\\log_{b}{M}}$</p>\n<h5 id=\"1-4-3-5-1-\"><a href=\"#1-4-3-5-1-\" class=\"headerlink\" title=\"1.4.3.5.1 \"></a>1.4.3.5.1 </h5><p> $\\alpha=\\log_{b}{N},\\  \\beta=\\log_{b}{M}$ $b^\\alpha=N,\\ b^\\beta=M, \\ (b^\\beta)^\\alpha=(b^\\alpha)^\\beta$</p>\n<p>$\\therefore M^{\\log_{b}{N}} = N^{\\log_{b}{M}}$</p>\n<h4 id=\"1-4-3-6-\"><a href=\"#1-4-3-6-\" class=\"headerlink\" title=\"1.4.3.6 \"></a>1.4.3.6 </h4><p>$\\log_{b}{\\theta}=\\frac{\\ln \\theta}{\\ln b}=\\frac{1}{\\frac{\\ln b}{\\ln \\theta}}=\\frac{1}{\\log_{\\theta}{b}}$</p>\n<h2 id=\"1-5-\"><a href=\"#1-5-\" class=\"headerlink\" title=\"1.5 \"></a>1.5 </h2><!--TODO-->\n\n\n\n<h2 id=\"1-6-\"><a href=\"#1-6-\" class=\"headerlink\" title=\"1.6 \"></a>1.6 </h2><!--TODO-->\n\n\n\n<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><p><strong></strong></p>\n<p><strong></strong></p>\n<p></p>\n<blockquote>\n<p></p>\n<p><a href=\"https://baike.baidu.com/item/%E5%9F%BA%E6%9C%AC%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0\">https://baike.baidu.com/item/%E5%9F%BA%E6%9C%AC%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0</a></p>\n<p><a href=\"https://zh.wikipedia.org/wiki/%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0\">https://zh.wikipedia.org/wiki/%E5%88%9D%E7%AD%89%E5%87%BD%E6%95%B0</a></p>\n</blockquote>\n<style>\n  table {\n    width: 1100px; /**/\n    max-width: 1100px; /**/\n    border: 1px solid #dedede; /**/\n    margin: 1px auto; /**/\n    border-collapse: collapse; /**/\n    empty-cells: show; /**/\n  }\n  table th,\n  table td {\n    height: 35px; /**/\n    border: 1px solid #dedede; /**/\n    padding: 0 10px; /**/\n  }\n  table th {\n    font-weight: bold; /**/\n    text-align: center !important; /* !important  Markdown */\n    background: #F8F8F8; /**/\n  }\n  table tbody tr:nth-child(n) {\n    background: #FFFFFF; \n  }\n  table tr:hover {\n    background: #EFEFEF; \n}\n  table th {\n    white-space: nowrap; /**/\n  }\n  table td:nth-child(1) {\n    white-space: nowrap; /**/\n  }\n</style>"},{"title":"Hello World","date":"2021-03-18T03:49:09.000Z","_content":"Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n<!-- more -->\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","source":"_posts/2021-03-18-hello-world.md","raw":"---\ntitle: Hello World\ndate: 2021-03-18 11:49:09\ntags: Test\n---\nWelcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n<!-- more -->\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","slug":"hello-world","published":1,"updated":"2021-03-26T13:07:41.868Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckmsyc4rd00085npr5cpiccvy","content":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<a id=\"more\"></a>\n\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n","site":{"data":{}},"excerpt":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>","more":"<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>"},{"title":"Android ","date":"2021-03-25T07:34:53.000Z","_content":"\n Android \n\n```java\n// ViewRootImpl.java\n\nvoid scheduleTraversals() {\n    if (!mTraversalScheduled) {\n        mTraversalScheduled = true;\n\n        // \n        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();\n\n        // \n        mChoreographer.postCallback(\n                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);\n\n        // ...\n    }\n}\n```\n\n Android  postCallback(int, Runnable, Object) \n\n\n\n\n\n<!-- more -->\n\n# 1. Message \n\nMessage  flag  Message \n\n## 1.1 Message::setAsynchronous(boolean)\n\n```java\npublic void setAsynchronous(boolean async) {\n    if (async) {\n        // ,  FLAG_ASYNCHRONOUS \n        flags |= FLAG_ASYNCHRONOUS;\n    } else {\n        // ,  FLAG_ASYNCHRONOUS \n        flags &= ~FLAG_ASYNCHRONOUS;\n    }\n}\n```\n\n setAsynchronous(boolean)  Message ********\n\n## 1.2 Message::isAsynchronous()\n\n```java\npublic boolean isAsynchronous() {\n    //  flags  FLAG_ASYNCHRONOUS \n    return (flags & FLAG_ASYNCHRONOUS) != 0;\n}\n```\n\n isAsynchronous()  Message ********\n\nMessage \n\n- \n- \n\n\n\n# 2. \n\n MessageQueue::postSyncBarrier()  MessageQueue::postSyncBarrier(long) \n\n```java\npublic int postSyncBarrier() {\n    return postSyncBarrier(SystemClock.uptimeMillis());\n}\n```\n\n SystemClock.uptimeMillis() \n\n```java\nprivate int postSyncBarrier(long when) {\n    // ,  postSyncBarrier() \n    synchronized (this) {\n\n        // mNextBarrierToken  int , token \n        final int token = mNextBarrierToken++;\n\n        //  Message  Message.obtain() , 2.1\n        final Message msg = Message.obtain();\n        msg.markInUse();\n        msg.when = when;\n        msg.arg1 = token;\n\n        //  when ,  Message \n        // ,  p,  p.when <= when,  p  Message ,  p\n        Message prev = null;\n        Message p = mMessages;\n        if (when != 0) {\n            while (p != null && p.when <= when) {\n                prev = p;\n                p = p.next;\n            }\n        }\n        if (prev != null) { // invariant: p == prev.next\n            msg.next = p;\n            prev.next = msg;\n        } else {\n            msg.next = p;\n            mMessages = msg;\n        }\n\n        //  token, , [4]\n        return token;\n    }\n}\n```\n\n## 2.1  Message \n\n```java\nfinal Message msg = Message.obtain();\nmsg.markInUse();\nmsg.when = when;\nmsg.arg1 = token;\n```\n\nMessage  Message.obtain() \n\n```java\npublic static Message obtain() {\n    synchronized (sPoolSync) {\n        if (sPool != null) {\n            Message m = sPool;\n            sPool = m.next;\n            m.next = null;\n            m.flags = 0; // clear in-use flag\n            sPoolSize--;\n            return m;\n        }\n    }\n    return new Message();\n}\n```\n\nMessage  Message  Message \n\n Message  Message  when  arg1 \n\nMessage  target Handler Handler  message.target  Handler\n\n Message  target message.target = null\n\n\n\n## 2.2 \n\n** target  Message ()** \n\n Android \n\n\n\n# 3. \n\n Android Handler Looper  Message  Handler Looper::loop()  for   Message\n\n## 3.1 Looper::loop()\n\n```java\npublic static void loop() {\n    final Looper me = myLooper();\n\n    // ...\n\n    final MessageQueue queue = me.mQueue;\n\n    // ...\n\n    for (;;) {\n        Message msg = queue.next();\n\n        // \n    }\n}\n```\n\nLooper  MessageQueue  Message Message \n\n MessageQueue::next()  Message \n\n\n\n## 3.2 MessageQueue::next()\n\n Message **** Message \n\n```java\nMessage next() {\n    // ...\n\n    for (;;) {\n        // ...\n\n        synchronized (this) {\n            final long now = SystemClock.uptimeMillis();\n\n            Message prevMsg = null;\n\n            // mMessages  Message\n            Message msg = mMessages;\n\n            // ,  msg , msg.target = null , \n            if (msg != null && msg.target == null) {\n                // isAsynchronous()  Message \n                // ,  msg\n                do {\n                    prevMsg = msg;\n                    msg = msg.next;\n                } while (msg != null && !msg.isAsynchronous());\n            }\n\n            if (msg != null) {\n                //  Message, \n                if (now < msg.when) {\n                    //  Message , \n                    nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);\n                } else {\n                    //  Message \n                    mBlocked = false;\n\n                    // ,  Message \n                    if (prevMsg != null) {\n                        // , , prevMsg  null, \n                        // , \n                        prevMsg.next = msg.next;\n                    } else {\n                        mMessages = msg.next;\n                    }\n                    msg.next = null;\n\n                    if (DEBUG) Log.v(TAG, \"Returning message: \" + msg);\n                    msg.markInUse();\n\n                    // \n                    return msg;\n                }\n            } else {\n                // \n                nextPollTimeoutMillis = -1;\n            }\n\n            // ...\n        }\n\n        // ...\n    }\n}\n```\n\n\n\n## 3.3 \n\n\n\n- ****\n- ****\n- ****\n\n\n\n# 4. \n\n****Android  MessageQueue::removeSyncBarrier(int) \n\n## 4.1 MessageQueue::removeSyncBarrier(int)\n\n```java\npublic void removeSyncBarrier(int token) {\n    // ,  removeSyncBarrier(int) \n    synchronized (this) {\n        Message prev = null;\n\n      \t// mMessages  Message\n        Message p = mMessages;\n\n      \t// ,  Message  arg1  token\n      \t// :  token ,  p\n        while (p != null && (p.target != null || p.arg1 != token)) {\n            prev = p;\n            p = p.next;\n        }\n\n        if (p == null) {\n            // , \n            throw new IllegalStateException(\"The specified message queue synchronization \"\n                    + \" barrier token has not been posted or has already been removed.\");\n        }\n\n        final boolean needWake;\n\n      \t// \n        if (prev != null) {\n            prev.next = p.next;\n            needWake = false;\n        } else {\n            mMessages = p.next;\n            needWake = mMessages == null || mMessages.target != null;\n        }\n        p.recycleUnchecked();\n\n        // ...\n    }\n}\n```\n\n\n\n## 4.2 \n\n postSyncBarrier()  token token \n\n\n","source":"_posts/2021-03-25-android-sync-barrier.md","raw":"---\ntitle: Android \ndate: 2021-03-25 15:34:53\ntags:\ncategories:\n- [Android, Framework, Handler]\n---\n\n Android \n\n```java\n// ViewRootImpl.java\n\nvoid scheduleTraversals() {\n    if (!mTraversalScheduled) {\n        mTraversalScheduled = true;\n\n        // \n        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();\n\n        // \n        mChoreographer.postCallback(\n                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);\n\n        // ...\n    }\n}\n```\n\n Android  postCallback(int, Runnable, Object) \n\n\n\n\n\n<!-- more -->\n\n# 1. Message \n\nMessage  flag  Message \n\n## 1.1 Message::setAsynchronous(boolean)\n\n```java\npublic void setAsynchronous(boolean async) {\n    if (async) {\n        // ,  FLAG_ASYNCHRONOUS \n        flags |= FLAG_ASYNCHRONOUS;\n    } else {\n        // ,  FLAG_ASYNCHRONOUS \n        flags &= ~FLAG_ASYNCHRONOUS;\n    }\n}\n```\n\n setAsynchronous(boolean)  Message ********\n\n## 1.2 Message::isAsynchronous()\n\n```java\npublic boolean isAsynchronous() {\n    //  flags  FLAG_ASYNCHRONOUS \n    return (flags & FLAG_ASYNCHRONOUS) != 0;\n}\n```\n\n isAsynchronous()  Message ********\n\nMessage \n\n- \n- \n\n\n\n# 2. \n\n MessageQueue::postSyncBarrier()  MessageQueue::postSyncBarrier(long) \n\n```java\npublic int postSyncBarrier() {\n    return postSyncBarrier(SystemClock.uptimeMillis());\n}\n```\n\n SystemClock.uptimeMillis() \n\n```java\nprivate int postSyncBarrier(long when) {\n    // ,  postSyncBarrier() \n    synchronized (this) {\n\n        // mNextBarrierToken  int , token \n        final int token = mNextBarrierToken++;\n\n        //  Message  Message.obtain() , 2.1\n        final Message msg = Message.obtain();\n        msg.markInUse();\n        msg.when = when;\n        msg.arg1 = token;\n\n        //  when ,  Message \n        // ,  p,  p.when <= when,  p  Message ,  p\n        Message prev = null;\n        Message p = mMessages;\n        if (when != 0) {\n            while (p != null && p.when <= when) {\n                prev = p;\n                p = p.next;\n            }\n        }\n        if (prev != null) { // invariant: p == prev.next\n            msg.next = p;\n            prev.next = msg;\n        } else {\n            msg.next = p;\n            mMessages = msg;\n        }\n\n        //  token, , [4]\n        return token;\n    }\n}\n```\n\n## 2.1  Message \n\n```java\nfinal Message msg = Message.obtain();\nmsg.markInUse();\nmsg.when = when;\nmsg.arg1 = token;\n```\n\nMessage  Message.obtain() \n\n```java\npublic static Message obtain() {\n    synchronized (sPoolSync) {\n        if (sPool != null) {\n            Message m = sPool;\n            sPool = m.next;\n            m.next = null;\n            m.flags = 0; // clear in-use flag\n            sPoolSize--;\n            return m;\n        }\n    }\n    return new Message();\n}\n```\n\nMessage  Message  Message \n\n Message  Message  when  arg1 \n\nMessage  target Handler Handler  message.target  Handler\n\n Message  target message.target = null\n\n\n\n## 2.2 \n\n** target  Message ()** \n\n Android \n\n\n\n# 3. \n\n Android Handler Looper  Message  Handler Looper::loop()  for   Message\n\n## 3.1 Looper::loop()\n\n```java\npublic static void loop() {\n    final Looper me = myLooper();\n\n    // ...\n\n    final MessageQueue queue = me.mQueue;\n\n    // ...\n\n    for (;;) {\n        Message msg = queue.next();\n\n        // \n    }\n}\n```\n\nLooper  MessageQueue  Message Message \n\n MessageQueue::next()  Message \n\n\n\n## 3.2 MessageQueue::next()\n\n Message **** Message \n\n```java\nMessage next() {\n    // ...\n\n    for (;;) {\n        // ...\n\n        synchronized (this) {\n            final long now = SystemClock.uptimeMillis();\n\n            Message prevMsg = null;\n\n            // mMessages  Message\n            Message msg = mMessages;\n\n            // ,  msg , msg.target = null , \n            if (msg != null && msg.target == null) {\n                // isAsynchronous()  Message \n                // ,  msg\n                do {\n                    prevMsg = msg;\n                    msg = msg.next;\n                } while (msg != null && !msg.isAsynchronous());\n            }\n\n            if (msg != null) {\n                //  Message, \n                if (now < msg.when) {\n                    //  Message , \n                    nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);\n                } else {\n                    //  Message \n                    mBlocked = false;\n\n                    // ,  Message \n                    if (prevMsg != null) {\n                        // , , prevMsg  null, \n                        // , \n                        prevMsg.next = msg.next;\n                    } else {\n                        mMessages = msg.next;\n                    }\n                    msg.next = null;\n\n                    if (DEBUG) Log.v(TAG, \"Returning message: \" + msg);\n                    msg.markInUse();\n\n                    // \n                    return msg;\n                }\n            } else {\n                // \n                nextPollTimeoutMillis = -1;\n            }\n\n            // ...\n        }\n\n        // ...\n    }\n}\n```\n\n\n\n## 3.3 \n\n\n\n- ****\n- ****\n- ****\n\n\n\n# 4. \n\n****Android  MessageQueue::removeSyncBarrier(int) \n\n## 4.1 MessageQueue::removeSyncBarrier(int)\n\n```java\npublic void removeSyncBarrier(int token) {\n    // ,  removeSyncBarrier(int) \n    synchronized (this) {\n        Message prev = null;\n\n      \t// mMessages  Message\n        Message p = mMessages;\n\n      \t// ,  Message  arg1  token\n      \t// :  token ,  p\n        while (p != null && (p.target != null || p.arg1 != token)) {\n            prev = p;\n            p = p.next;\n        }\n\n        if (p == null) {\n            // , \n            throw new IllegalStateException(\"The specified message queue synchronization \"\n                    + \" barrier token has not been posted or has already been removed.\");\n        }\n\n        final boolean needWake;\n\n      \t// \n        if (prev != null) {\n            prev.next = p.next;\n            needWake = false;\n        } else {\n            mMessages = p.next;\n            needWake = mMessages == null || mMessages.target != null;\n        }\n        p.recycleUnchecked();\n\n        // ...\n    }\n}\n```\n\n\n\n## 4.2 \n\n postSyncBarrier()  token token \n\n\n","slug":"android-sync-barrier","published":1,"updated":"2021-03-26T13:15:06.555Z","_id":"ckmsyc4rg000d5nprei90h7bk","comments":1,"layout":"post","photos":[],"link":"","content":"<p> Android </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ViewRootImpl.java</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">scheduleTraversals</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!mTraversalScheduled) &#123;</span><br><span class=\"line\">        mTraversalScheduled = <span class=\"keyword\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        mChoreographer.postCallback(</span><br><span class=\"line\">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Android  postCallback(int, Runnable, Object) </p>\n<p></p>\n<a id=\"more\"></a>\n\n<h1 id=\"1-Message-\"><a href=\"#1-Message-\" class=\"headerlink\" title=\"1. Message \"></a>1. Message </h1><p>Message  flag  Message </p>\n<h2 id=\"1-1-Message-setAsynchronous-boolean\"><a href=\"#1-1-Message-setAsynchronous-boolean\" class=\"headerlink\" title=\"1.1 Message::setAsynchronous(boolean)\"></a>1.1 Message::setAsynchronous(boolean)</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setAsynchronous</span><span class=\"params\">(<span class=\"keyword\">boolean</span> async)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (async) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  FLAG_ASYNCHRONOUS </span></span><br><span class=\"line\">        flags |= FLAG_ASYNCHRONOUS;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  FLAG_ASYNCHRONOUS </span></span><br><span class=\"line\">        flags &amp;= ~FLAG_ASYNCHRONOUS;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> setAsynchronous(boolean)  Message <strong></strong><strong></strong></p>\n<h2 id=\"1-2-Message-isAsynchronous\"><a href=\"#1-2-Message-isAsynchronous\" class=\"headerlink\" title=\"1.2 Message::isAsynchronous()\"></a>1.2 Message::isAsynchronous()</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isAsynchronous</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  flags  FLAG_ASYNCHRONOUS </span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (flags &amp; FLAG_ASYNCHRONOUS) != <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> isAsynchronous()  Message <strong></strong><strong></strong></p>\n<p>Message </p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><p> MessageQueue::postSyncBarrier()  MessageQueue::postSyncBarrier(long) </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">postSyncBarrier</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> postSyncBarrier(SystemClock.uptimeMillis());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> SystemClock.uptimeMillis() </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">postSyncBarrier</span><span class=\"params\">(<span class=\"keyword\">long</span> when)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ,  postSyncBarrier() </span></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// mNextBarrierToken  int , token </span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> token = mNextBarrierToken++;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  Message  Message.obtain() , 2.1</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> Message msg = Message.obtain();</span><br><span class=\"line\">        msg.markInUse();</span><br><span class=\"line\">        msg.when = when;</span><br><span class=\"line\">        msg.arg1 = token;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  when ,  Message </span></span><br><span class=\"line\">        <span class=\"comment\">// ,  p,  p.when &lt;= when,  p  Message ,  p</span></span><br><span class=\"line\">        Message prev = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Message p = mMessages;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (when != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (p != <span class=\"keyword\">null</span> &amp;&amp; p.when &lt;= when) &#123;</span><br><span class=\"line\">                prev = p;</span><br><span class=\"line\">                p = p.next;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (prev != <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// invariant: p == prev.next</span></span><br><span class=\"line\">            msg.next = p;</span><br><span class=\"line\">            prev.next = msg;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            msg.next = p;</span><br><span class=\"line\">            mMessages = msg;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  token, , [4]</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> token;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"2-1--Message-\"><a href=\"#2-1--Message-\" class=\"headerlink\" title=\"2.1  Message \"></a>2.1  Message </h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Message msg = Message.obtain();</span><br><span class=\"line\">msg.markInUse();</span><br><span class=\"line\">msg.when = when;</span><br><span class=\"line\">msg.arg1 = token;</span><br></pre></td></tr></table></figure>\n<p>Message  Message.obtain() </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Message <span class=\"title\">obtain</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (sPoolSync) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sPool != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            Message m = sPool;</span><br><span class=\"line\">            sPool = m.next;</span><br><span class=\"line\">            m.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            m.flags = <span class=\"number\">0</span>; <span class=\"comment\">// clear in-use flag</span></span><br><span class=\"line\">            sPoolSize--;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> m;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Message();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Message  Message  Message </p>\n<p> Message  Message  when  arg1 </p>\n<p>Message  target Handler Handler  message.target  Handler</p>\n<p> Message  target message.target = null</p>\n<h2 id=\"2-2-\"><a href=\"#2-2-\" class=\"headerlink\" title=\"2.2 \"></a>2.2 </h2><p><strong> target  Message ()</strong> </p>\n<p> Android </p>\n<h1 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3. \"></a>3. </h1><p> Android Handler Looper  Message  Handler Looper::loop()  for   Message</p>\n<h2 id=\"3-1-Looper-loop\"><a href=\"#3-1-Looper-loop\" class=\"headerlink\" title=\"3.1 Looper::loop()\"></a>3.1 Looper::loop()</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">loop</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Looper me = myLooper();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> MessageQueue queue = me.mQueue;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">        Message msg = queue.next();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Looper  MessageQueue  Message Message </p>\n<p> MessageQueue::next()  Message </p>\n<h2 id=\"3-2-MessageQueue-next\"><a href=\"#3-2-MessageQueue-next\" class=\"headerlink\" title=\"3.2 MessageQueue::next()\"></a>3.2 MessageQueue::next()</h2><p> Message <strong></strong> Message </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Message <span class=\"title\">next</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> now = SystemClock.uptimeMillis();</span><br><span class=\"line\"></span><br><span class=\"line\">            Message prevMsg = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// mMessages  Message</span></span><br><span class=\"line\">            Message msg = mMessages;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// ,  msg , msg.target = null , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (msg != <span class=\"keyword\">null</span> &amp;&amp; msg.target == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// isAsynchronous()  Message </span></span><br><span class=\"line\">                <span class=\"comment\">// ,  msg</span></span><br><span class=\"line\">                <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">                    prevMsg = msg;</span><br><span class=\"line\">                    msg = msg.next;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">while</span> (msg != <span class=\"keyword\">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (msg != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//  Message, </span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (now &lt; msg.when) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//  Message , </span></span><br><span class=\"line\">                    nextPollTimeoutMillis = (<span class=\"keyword\">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//  Message </span></span><br><span class=\"line\">                    mBlocked = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// ,  Message </span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (prevMsg != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// , , prevMsg  null, </span></span><br><span class=\"line\">                        <span class=\"comment\">// , </span></span><br><span class=\"line\">                        prevMsg.next = msg.next;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        mMessages = msg.next;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    msg.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (DEBUG) Log.v(TAG, <span class=\"string\">&quot;Returning message: &quot;</span> + msg);</span><br><span class=\"line\">                    msg.markInUse();</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// </span></span><br><span class=\"line\">                    <span class=\"keyword\">return</span> msg;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// </span></span><br><span class=\"line\">                nextPollTimeoutMillis = -<span class=\"number\">1</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// ...</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"3-3-\"><a href=\"#3-3-\" class=\"headerlink\" title=\"3.3 \"></a>3.3 </h2><p></p>\n<ul>\n<li><strong></strong></li>\n<li><strong></strong></li>\n<li><strong></strong></li>\n</ul>\n<h1 id=\"4-\"><a href=\"#4-\" class=\"headerlink\" title=\"4. \"></a>4. </h1><p><strong></strong>Android  MessageQueue::removeSyncBarrier(int) </p>\n<h2 id=\"4-1-MessageQueue-removeSyncBarrier-int\"><a href=\"#4-1-MessageQueue-removeSyncBarrier-int\" class=\"headerlink\" title=\"4.1 MessageQueue::removeSyncBarrier(int)\"></a>4.1 MessageQueue::removeSyncBarrier(int)</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">removeSyncBarrier</span><span class=\"params\">(<span class=\"keyword\">int</span> token)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ,  removeSyncBarrier(int) </span></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">        Message prev = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// mMessages  Message</span></span><br><span class=\"line\">        Message p = mMessages;</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// ,  Message  arg1  token</span></span><br><span class=\"line\">      \t<span class=\"comment\">// :  token ,  p</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (p != <span class=\"keyword\">null</span> &amp;&amp; (p.target != <span class=\"keyword\">null</span> || p.arg1 != token)) &#123;</span><br><span class=\"line\">            prev = p;</span><br><span class=\"line\">            p = p.next;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// , </span></span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">&quot;The specified message queue synchronization &quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot; barrier token has not been posted or has already been removed.&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> needWake;</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (prev != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            prev.next = p.next;</span><br><span class=\"line\">            needWake = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            mMessages = p.next;</span><br><span class=\"line\">            needWake = mMessages == <span class=\"keyword\">null</span> || mMessages.target != <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        p.recycleUnchecked();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"4-2-\"><a href=\"#4-2-\" class=\"headerlink\" title=\"4.2 \"></a>4.2 </h2><p> postSyncBarrier()  token token </p>\n","site":{"data":{}},"excerpt":"<p> Android </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ViewRootImpl.java</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">scheduleTraversals</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!mTraversalScheduled) &#123;</span><br><span class=\"line\">        mTraversalScheduled = <span class=\"keyword\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        mChoreographer.postCallback(</span><br><span class=\"line\">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Android  postCallback(int, Runnable, Object) </p>\n<p></p>","more":"<h1 id=\"1-Message-\"><a href=\"#1-Message-\" class=\"headerlink\" title=\"1. Message \"></a>1. Message </h1><p>Message  flag  Message </p>\n<h2 id=\"1-1-Message-setAsynchronous-boolean\"><a href=\"#1-1-Message-setAsynchronous-boolean\" class=\"headerlink\" title=\"1.1 Message::setAsynchronous(boolean)\"></a>1.1 Message::setAsynchronous(boolean)</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setAsynchronous</span><span class=\"params\">(<span class=\"keyword\">boolean</span> async)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (async) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  FLAG_ASYNCHRONOUS </span></span><br><span class=\"line\">        flags |= FLAG_ASYNCHRONOUS;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  FLAG_ASYNCHRONOUS </span></span><br><span class=\"line\">        flags &amp;= ~FLAG_ASYNCHRONOUS;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> setAsynchronous(boolean)  Message <strong></strong><strong></strong></p>\n<h2 id=\"1-2-Message-isAsynchronous\"><a href=\"#1-2-Message-isAsynchronous\" class=\"headerlink\" title=\"1.2 Message::isAsynchronous()\"></a>1.2 Message::isAsynchronous()</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isAsynchronous</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  flags  FLAG_ASYNCHRONOUS </span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (flags &amp; FLAG_ASYNCHRONOUS) != <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> isAsynchronous()  Message <strong></strong><strong></strong></p>\n<p>Message </p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><p> MessageQueue::postSyncBarrier()  MessageQueue::postSyncBarrier(long) </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">postSyncBarrier</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> postSyncBarrier(SystemClock.uptimeMillis());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> SystemClock.uptimeMillis() </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">postSyncBarrier</span><span class=\"params\">(<span class=\"keyword\">long</span> when)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ,  postSyncBarrier() </span></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// mNextBarrierToken  int , token </span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> token = mNextBarrierToken++;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  Message  Message.obtain() , 2.1</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> Message msg = Message.obtain();</span><br><span class=\"line\">        msg.markInUse();</span><br><span class=\"line\">        msg.when = when;</span><br><span class=\"line\">        msg.arg1 = token;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  when ,  Message </span></span><br><span class=\"line\">        <span class=\"comment\">// ,  p,  p.when &lt;= when,  p  Message ,  p</span></span><br><span class=\"line\">        Message prev = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Message p = mMessages;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (when != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (p != <span class=\"keyword\">null</span> &amp;&amp; p.when &lt;= when) &#123;</span><br><span class=\"line\">                prev = p;</span><br><span class=\"line\">                p = p.next;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (prev != <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// invariant: p == prev.next</span></span><br><span class=\"line\">            msg.next = p;</span><br><span class=\"line\">            prev.next = msg;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            msg.next = p;</span><br><span class=\"line\">            mMessages = msg;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  token, , [4]</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> token;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"2-1--Message-\"><a href=\"#2-1--Message-\" class=\"headerlink\" title=\"2.1  Message \"></a>2.1  Message </h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Message msg = Message.obtain();</span><br><span class=\"line\">msg.markInUse();</span><br><span class=\"line\">msg.when = when;</span><br><span class=\"line\">msg.arg1 = token;</span><br></pre></td></tr></table></figure>\n<p>Message  Message.obtain() </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Message <span class=\"title\">obtain</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (sPoolSync) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sPool != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            Message m = sPool;</span><br><span class=\"line\">            sPool = m.next;</span><br><span class=\"line\">            m.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            m.flags = <span class=\"number\">0</span>; <span class=\"comment\">// clear in-use flag</span></span><br><span class=\"line\">            sPoolSize--;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> m;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Message();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Message  Message  Message </p>\n<p> Message  Message  when  arg1 </p>\n<p>Message  target Handler Handler  message.target  Handler</p>\n<p> Message  target message.target = null</p>\n<h2 id=\"2-2-\"><a href=\"#2-2-\" class=\"headerlink\" title=\"2.2 \"></a>2.2 </h2><p><strong> target  Message ()</strong> </p>\n<p> Android </p>\n<h1 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3. \"></a>3. </h1><p> Android Handler Looper  Message  Handler Looper::loop()  for   Message</p>\n<h2 id=\"3-1-Looper-loop\"><a href=\"#3-1-Looper-loop\" class=\"headerlink\" title=\"3.1 Looper::loop()\"></a>3.1 Looper::loop()</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">loop</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Looper me = myLooper();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> MessageQueue queue = me.mQueue;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">        Message msg = queue.next();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Looper  MessageQueue  Message Message </p>\n<p> MessageQueue::next()  Message </p>\n<h2 id=\"3-2-MessageQueue-next\"><a href=\"#3-2-MessageQueue-next\" class=\"headerlink\" title=\"3.2 MessageQueue::next()\"></a>3.2 MessageQueue::next()</h2><p> Message <strong></strong> Message </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Message <span class=\"title\">next</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> now = SystemClock.uptimeMillis();</span><br><span class=\"line\"></span><br><span class=\"line\">            Message prevMsg = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// mMessages  Message</span></span><br><span class=\"line\">            Message msg = mMessages;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// ,  msg , msg.target = null , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (msg != <span class=\"keyword\">null</span> &amp;&amp; msg.target == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// isAsynchronous()  Message </span></span><br><span class=\"line\">                <span class=\"comment\">// ,  msg</span></span><br><span class=\"line\">                <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">                    prevMsg = msg;</span><br><span class=\"line\">                    msg = msg.next;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">while</span> (msg != <span class=\"keyword\">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (msg != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//  Message, </span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (now &lt; msg.when) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//  Message , </span></span><br><span class=\"line\">                    nextPollTimeoutMillis = (<span class=\"keyword\">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//  Message </span></span><br><span class=\"line\">                    mBlocked = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// ,  Message </span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (prevMsg != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// , , prevMsg  null, </span></span><br><span class=\"line\">                        <span class=\"comment\">// , </span></span><br><span class=\"line\">                        prevMsg.next = msg.next;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        mMessages = msg.next;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    msg.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (DEBUG) Log.v(TAG, <span class=\"string\">&quot;Returning message: &quot;</span> + msg);</span><br><span class=\"line\">                    msg.markInUse();</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// </span></span><br><span class=\"line\">                    <span class=\"keyword\">return</span> msg;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// </span></span><br><span class=\"line\">                nextPollTimeoutMillis = -<span class=\"number\">1</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// ...</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"3-3-\"><a href=\"#3-3-\" class=\"headerlink\" title=\"3.3 \"></a>3.3 </h2><p></p>\n<ul>\n<li><strong></strong></li>\n<li><strong></strong></li>\n<li><strong></strong></li>\n</ul>\n<h1 id=\"4-\"><a href=\"#4-\" class=\"headerlink\" title=\"4. \"></a>4. </h1><p><strong></strong>Android  MessageQueue::removeSyncBarrier(int) </p>\n<h2 id=\"4-1-MessageQueue-removeSyncBarrier-int\"><a href=\"#4-1-MessageQueue-removeSyncBarrier-int\" class=\"headerlink\" title=\"4.1 MessageQueue::removeSyncBarrier(int)\"></a>4.1 MessageQueue::removeSyncBarrier(int)</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">removeSyncBarrier</span><span class=\"params\">(<span class=\"keyword\">int</span> token)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// ,  removeSyncBarrier(int) </span></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">        Message prev = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// mMessages  Message</span></span><br><span class=\"line\">        Message p = mMessages;</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// ,  Message  arg1  token</span></span><br><span class=\"line\">      \t<span class=\"comment\">// :  token ,  p</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (p != <span class=\"keyword\">null</span> &amp;&amp; (p.target != <span class=\"keyword\">null</span> || p.arg1 != token)) &#123;</span><br><span class=\"line\">            prev = p;</span><br><span class=\"line\">            p = p.next;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (p == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// , </span></span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">&quot;The specified message queue synchronization &quot;</span></span><br><span class=\"line\">                    + <span class=\"string\">&quot; barrier token has not been posted or has already been removed.&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> needWake;</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (prev != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            prev.next = p.next;</span><br><span class=\"line\">            needWake = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            mMessages = p.next;</span><br><span class=\"line\">            needWake = mMessages == <span class=\"keyword\">null</span> || mMessages.target != <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        p.recycleUnchecked();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"4-2-\"><a href=\"#4-2-\" class=\"headerlink\" title=\"4.2 \"></a>4.2 </h2><p> postSyncBarrier()  token token </p>"},{"title":"TCP ","_content":"\n\n\n![zhihu_xiaolincoding_ans_p1](tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p1.jpg)\n\n![zhihu_xiaolincoding_ans_p2](tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p2.jpg)\n\n![zhihu_xiaolincoding_ans_p3](tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p3.jpg)\n\n![zhihu_xiaolincoding_ans_p4](tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p4.jpg)\n\n\n## \nhttps://www.zhihu.com/question/63264012/answer/298264454\n\nTCP\n1     FIN    2     ACKFIN   \n3    FINFINLAST_ACK   \n4    ACK\n\nack1)A,2)BackA3)BA4)ABBB\n\n\n\nfin=1\n\ntcp[]\n\n\n# \n\n[Transmission_Control_Protocol](https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Connection_establishment)\n\n[socket ](https://www.zhihu.com/question/29637351/answer/1934423848)\n\n","source":"_drafts/tcp-connection-establishment-and-termination.md","raw":"---\ntitle: TCP \ntags:\n---\n\n\n\n![zhihu_xiaolincoding_ans_p1](tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p1.jpg)\n\n![zhihu_xiaolincoding_ans_p2](tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p2.jpg)\n\n![zhihu_xiaolincoding_ans_p3](tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p3.jpg)\n\n![zhihu_xiaolincoding_ans_p4](tcp-connection-establishment-and-termination/zhihu_xiaolincoding_ans_p4.jpg)\n\n\n## \nhttps://www.zhihu.com/question/63264012/answer/298264454\n\nTCP\n1     FIN    2     ACKFIN   \n3    FINFINLAST_ACK   \n4    ACK\n\nack1)A,2)BackA3)BA4)ABBB\n\n\n\nfin=1\n\ntcp[]\n\n\n# \n\n[Transmission_Control_Protocol](https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Connection_establishment)\n\n[socket ](https://www.zhihu.com/question/29637351/answer/1934423848)\n\n","slug":"tcp-connection-establishment-and-termination","published":0,"date":"2021-08-11T08:19:13.862Z","updated":"2021-11-09T12:19:56.518Z","_id":"cks78k24o0000i4prf8971erh","comments":1,"layout":"post","photos":[],"link":"","content":"\n\n\n\n\n\n\n\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://www.zhihu.com/question/63264012/answer/298264454\">https://www.zhihu.com/question/63264012/answer/298264454</a></p>\n<p>TCP<br>1     FIN    2     ACKFIN<br>3    FINFINLAST_ACK<br>4    ACK</p>\n<p>ack1)A,2)BackA3)BA4)ABBB</p>\n<p><br><br>fin=1<br><br>tcp[]</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Connection_establishment\">Transmission_Control_Protocol</a></p>\n<p><a href=\"https://www.zhihu.com/question/29637351/answer/1934423848\">socket </a></p>\n","site":{"data":{}},"excerpt":"","more":"\n\n\n\n\n\n\n\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"https://www.zhihu.com/question/63264012/answer/298264454\">https://www.zhihu.com/question/63264012/answer/298264454</a></p>\n<p>TCP<br>1     FIN    2     ACKFIN<br>3    FINFINLAST_ACK<br>4    ACK</p>\n<p>ack1)A,2)BackA3)BA4)ABBB</p>\n<p><br><br>fin=1<br><br>tcp[]</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Connection_establishment\">Transmission_Control_Protocol</a></p>\n<p><a href=\"https://www.zhihu.com/question/29637351/answer/1934423848\">socket </a></p>\n"},{"title":"","date":"2021-08-16T09:45:00.000Z","_content":"\n\n\n# \n\n Unix  Unix  (file descriptor) \n\n\n\n Linux : \n\n I/O \n\n\n\n### \n\n- \n- \n-  i-node \n\n\n\n### inode\n\n#### inode\n\ninode\n\nSector5120.5KB\n\nblock4KB sector block\n\ninode\n\ninode\n\n#### inode\n\ninode\n\n- \n- User ID\n- Group ID\n- \n- ctimeinodemtimeatime\n- inode\n- block\n\n `stat` inode\n\ninode\n\n#### inode\n\ninode inodeinode tableinode\n\ninode128256inode1KB2KBinode1GBinode1281KBinodeinode table128MB12.8%\n\ninodedf\n\n```shell\ndf -i\n```\n\n\n\ninode\n\n```\nsudo dumpe2fs -h /dev/hda | grep \"Inode size\"\n```\n\ninodeinode\n\n#### inode\n\ninodeinode\n\nUnix/Linuxinodeinode\n\ninodeinodeinodeinodeblock\n\n `ls -i` inode\n\n#### \n\nUnix/Linuxdirectory\n\ndirentinode\n\nls\n\n```\nls /etc\n```\n\nls -iinode\n\n```\nls -i /etc\n```\n\ninodeinodels -l\n\n```\nls -l /etc\n```\n\nrwinodeinodeinodex\n\n\n\n### \n\ninodeinodeUnix/Linuxinode\n\nhard link\n\nln\n\n```\nln  \n```\n\ninodeinodeinodeinode1\n\ninode10inodeinodeblock\n\n...inodeinodeinodeinode2\n\n\n\n### \n\n\n\nABinodeABABBABsoft linksymbolic link\n\nABBANo such file or directoryABBinodeBinode\n\n**ln -s**\n\n```\nln -s  \n```\n\n\n\n### inode\n\ninodeUnix/Linux\n\n- inode\n- inode\n- inodeinode\n\n3inodeinodeinode\n\n\n\n# \n\n[LinuxFDInode](https://zhuanlan.zhihu.com/p/143430585)\n\n[File Descriptor](https://segmentfault.com/a/1190000009724931)\n\n[Linux](http://blog.csdn.net/cywosp/article/details/38965239)\n\n[File descriptor](https://en.wikipedia.org/wiki/File_descriptor)\n\n","source":"_drafts/understand-file-descriptor.md","raw":"---\ntitle: \ndate: 2021-08-16 17:45:00\ncategories:\n- [Linux]\n---\n\n\n\n# \n\n Unix  Unix  (file descriptor) \n\n\n\n Linux : \n\n I/O \n\n\n\n### \n\n- \n- \n-  i-node \n\n\n\n### inode\n\n#### inode\n\ninode\n\nSector5120.5KB\n\nblock4KB sector block\n\ninode\n\ninode\n\n#### inode\n\ninode\n\n- \n- User ID\n- Group ID\n- \n- ctimeinodemtimeatime\n- inode\n- block\n\n `stat` inode\n\ninode\n\n#### inode\n\ninode inodeinode tableinode\n\ninode128256inode1KB2KBinode1GBinode1281KBinodeinode table128MB12.8%\n\ninodedf\n\n```shell\ndf -i\n```\n\n\n\ninode\n\n```\nsudo dumpe2fs -h /dev/hda | grep \"Inode size\"\n```\n\ninodeinode\n\n#### inode\n\ninodeinode\n\nUnix/Linuxinodeinode\n\ninodeinodeinodeinodeblock\n\n `ls -i` inode\n\n#### \n\nUnix/Linuxdirectory\n\ndirentinode\n\nls\n\n```\nls /etc\n```\n\nls -iinode\n\n```\nls -i /etc\n```\n\ninodeinodels -l\n\n```\nls -l /etc\n```\n\nrwinodeinodeinodex\n\n\n\n### \n\ninodeinodeUnix/Linuxinode\n\nhard link\n\nln\n\n```\nln  \n```\n\ninodeinodeinodeinode1\n\ninode10inodeinodeblock\n\n...inodeinodeinodeinode2\n\n\n\n### \n\n\n\nABinodeABABBABsoft linksymbolic link\n\nABBANo such file or directoryABBinodeBinode\n\n**ln -s**\n\n```\nln -s  \n```\n\n\n\n### inode\n\ninodeUnix/Linux\n\n- inode\n- inode\n- inodeinode\n\n3inodeinodeinode\n\n\n\n# \n\n[LinuxFDInode](https://zhuanlan.zhihu.com/p/143430585)\n\n[File Descriptor](https://segmentfault.com/a/1190000009724931)\n\n[Linux](http://blog.csdn.net/cywosp/article/details/38965239)\n\n[File descriptor](https://en.wikipedia.org/wiki/File_descriptor)\n\n","slug":"understand-file-descriptor","published":0,"updated":"2021-08-16T12:26:41.879Z","_id":"cksh4umd7000cqkprfer8avcg","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p> Unix  Unix  (file descriptor) </p>\n<p></p>\n<p> Linux : </p>\n<p> I/O </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li></li>\n<li> i-node </li>\n</ul>\n<h3 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h3><h4 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h4><p>inode</p>\n<p>Sector5120.5KB</p>\n<p>block4KB sector block</p>\n<p>inode</p>\n<p>inode</p>\n<h4 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h4><p>inode</p>\n<ul>\n<li></li>\n<li>User ID</li>\n<li>Group ID</li>\n<li></li>\n<li>ctimeinodemtimeatime</li>\n<li>inode</li>\n<li>block</li>\n</ul>\n<p> <code>stat</code> inode</p>\n<p>inode</p>\n<h4 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h4><p>inode inodeinode tableinode</p>\n<p>inode128256inode1KB2KBinode1GBinode1281KBinodeinode table128MB12.8%</p>\n<p>inodedf</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df -i</span><br></pre></td></tr></table></figure>\n\n\n<p>inode</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo dumpe2fs -h &#x2F;dev&#x2F;hda | grep &quot;Inode size&quot;</span><br></pre></td></tr></table></figure>\n<p>inodeinode</p>\n<h4 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h4><p>inodeinode</p>\n<p>Unix/Linuxinodeinode</p>\n<p>inodeinodeinodeinodeblock</p>\n<p> <code>ls -i</code> inode</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Unix/Linuxdirectory</p>\n<p>direntinode</p>\n<p>ls</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls &#x2F;etc</span><br></pre></td></tr></table></figure>\n<p>ls -iinode</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls -i &#x2F;etc</span><br></pre></td></tr></table></figure>\n<p>inodeinodels -l</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls -l &#x2F;etc</span><br></pre></td></tr></table></figure>\n<p>rwinodeinodeinodex</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>inodeinodeUnix/Linuxinode</p>\n<p>hard link</p>\n<p>ln</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln  </span><br></pre></td></tr></table></figure>\n<p>inodeinodeinodeinode1</p>\n<p>inode10inodeinodeblock</p>\n<p>...inodeinodeinodeinode2</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>ABinodeABABBABsoft linksymbolic link</p>\n<p>ABBANo such file or directoryABBinodeBinode</p>\n<p><strong>ln -s</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln -s  </span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h3><p>inodeUnix/Linux</p>\n<ul>\n<li>inode</li>\n<li>inode</li>\n<li>inodeinode</li>\n</ul>\n<p>3inodeinodeinode</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"https://zhuanlan.zhihu.com/p/143430585\">LinuxFDInode</a></p>\n<p><a href=\"https://segmentfault.com/a/1190000009724931\">File Descriptor</a></p>\n<p><a href=\"http://blog.csdn.net/cywosp/article/details/38965239\">Linux</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/File_descriptor\">File descriptor</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p> Unix  Unix  (file descriptor) </p>\n<p></p>\n<p> Linux : </p>\n<p> I/O </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li></li>\n<li></li>\n<li> i-node </li>\n</ul>\n<h3 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h3><h4 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h4><p>inode</p>\n<p>Sector5120.5KB</p>\n<p>block4KB sector block</p>\n<p>inode</p>\n<p>inode</p>\n<h4 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h4><p>inode</p>\n<ul>\n<li></li>\n<li>User ID</li>\n<li>Group ID</li>\n<li></li>\n<li>ctimeinodemtimeatime</li>\n<li>inode</li>\n<li>block</li>\n</ul>\n<p> <code>stat</code> inode</p>\n<p>inode</p>\n<h4 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h4><p>inode inodeinode tableinode</p>\n<p>inode128256inode1KB2KBinode1GBinode1281KBinodeinode table128MB12.8%</p>\n<p>inodedf</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df -i</span><br></pre></td></tr></table></figure>\n\n\n<p>inode</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo dumpe2fs -h &#x2F;dev&#x2F;hda | grep &quot;Inode size&quot;</span><br></pre></td></tr></table></figure>\n<p>inodeinode</p>\n<h4 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h4><p>inodeinode</p>\n<p>Unix/Linuxinodeinode</p>\n<p>inodeinodeinodeinodeblock</p>\n<p> <code>ls -i</code> inode</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Unix/Linuxdirectory</p>\n<p>direntinode</p>\n<p>ls</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls &#x2F;etc</span><br></pre></td></tr></table></figure>\n<p>ls -iinode</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls -i &#x2F;etc</span><br></pre></td></tr></table></figure>\n<p>inodeinodels -l</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ls -l &#x2F;etc</span><br></pre></td></tr></table></figure>\n<p>rwinodeinodeinodex</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>inodeinodeUnix/Linuxinode</p>\n<p>hard link</p>\n<p>ln</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln  </span><br></pre></td></tr></table></figure>\n<p>inodeinodeinodeinode1</p>\n<p>inode10inodeinodeblock</p>\n<p>...inodeinodeinodeinode2</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>ABinodeABABBABsoft linksymbolic link</p>\n<p>ABBANo such file or directoryABBinodeBinode</p>\n<p><strong>ln -s</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln -s  </span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h3><p>inodeUnix/Linux</p>\n<ul>\n<li>inode</li>\n<li>inode</li>\n<li>inodeinode</li>\n</ul>\n<p>3inodeinodeinode</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"https://zhuanlan.zhihu.com/p/143430585\">LinuxFDInode</a></p>\n<p><a href=\"https://segmentfault.com/a/1190000009724931\">File Descriptor</a></p>\n<p><a href=\"http://blog.csdn.net/cywosp/article/details/38965239\">Linux</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/File_descriptor\">File descriptor</a></p>\n"},{"title":" Zygote ","_content":"\n\n\n> : android-security-10.0.0_r56\n\n\n\n# 1. \n\nAndroid  Linux  init init  `init.rc`  Zygote Zygote \n\n<!-- TODO -->\n\n<!-- more -->\n\n\n\n# 2.  init \n\ninit  pid  1\n\n\n\n## 2.1 init \n\n Android 9init  `system/core/init/init.cpp`  main \n\n Android 10 init  `system/core/init/main.cpp`  main \n\n```c++\nint main(int argc, char** argv) {\n    \n    ...\n\n    if (!strcmp(basename(argv[0]), \"ueventd\")) {\n        return ueventd_main(argc, argv);\n    }\n\n    if (argc > 1) {\n        if (!strcmp(argv[1], \"subcontext\")) {\n            android::base::InitLogging(argv, &android::base::KernelLogger);\n            const BuiltinFunctionMap& function_map = GetBuiltinFunctionMap();\n\n            return SubcontextMain(argc, argv, &function_map);\n        }\n\n        if (!strcmp(argv[1], \"selinux_setup\")) {\n            return SetupSelinux(argv);\n        }\n\n        if (!strcmp(argv[1], \"second_stage\")) {\n            return SecondStageMain(argc, argv);\n        }\n    }\n\n    return FirstStageMain(argc, argv);\n}\n```\n\n`argc` `argv` `argv[0]` `arg[1]` \n\n> `strcmp(str1, str2)`  0\n>\n> `basename(path)`  \"/system/bin/ueventd\" \"ueventd\"\n\n`main` \n\n1.  `argv[0]`  \"ueventd\" `ueventd_main(argc, argv)`\n2.  `init` `SubcontextMain(argc, argv, &function_map)``SetupSelinux(argv)``SecondStageMain(argc, argv)` \n3.  `FirstStageMain(argc, argv)`\n\n\n\n## 2.2 \n\n `int FirstStageMain(int argc, char** argv)` `system/core/init/first_stage_init.cpp`\n\n```c++\nint FirstStageMain(int argc, char** argv) {\n\n    ...\n\n    CHECKCALL(clearenv());\n    CHECKCALL(setenv(\"PATH\", _PATH_DEFPATH, 1));\n    // Get the basic filesystem setup we need put together in the initramdisk\n    // on / and then we'll let the rc file figure out the rest.\n    CHECKCALL(mount(\"tmpfs\", \"/dev\", \"tmpfs\", MS_NOSUID, \"mode=0755\"));\n    CHECKCALL(mkdir(\"/dev/pts\", 0755));\n    CHECKCALL(mkdir(\"/dev/socket\", 0755));\n    CHECKCALL(mkdir(\"/dev/dm-user\", 0755));\n    CHECKCALL(mount(\"devpts\", \"/dev/pts\", \"devpts\", 0, NULL));\n#define MAKE_STR(x) __STRING(x)\n    CHECKCALL(mount(\"proc\", \"/proc\", \"proc\", 0, \"hidepid=2,gid=\" MAKE_STR(AID_READPROC)));\n#undef MAKE_STR\n\n    // Don't expose the raw commandline to unprivileged processes.\n    // ,  2.2.1\n    CHECKCALL(chmod(\"/proc/cmdline\", 0440));\n    std::string cmdline;\n    android::base::ReadFileToString(\"/proc/cmdline\", &cmdline);\n    // Don't expose the raw bootconfig to unprivileged processes.\n    chmod(\"/proc/bootconfig\", 0440);\n    std::string bootconfig;\n    android::base::ReadFileToString(\"/proc/bootconfig\", &bootconfig);\n    gid_t groups[] = {AID_READPROC};\n    CHECKCALL(setgroups(arraysize(groups), groups));\n    CHECKCALL(mount(\"sysfs\", \"/sys\", \"sysfs\", 0, NULL));\n    CHECKCALL(mount(\"selinuxfs\", \"/sys/fs/selinux\", \"selinuxfs\", 0, NULL));\n\n    CHECKCALL(mknod(\"/dev/kmsg\", S_IFCHR | 0600, makedev(1, 11)));\n\n    if constexpr (WORLD_WRITABLE_KMSG) {\n        CHECKCALL(mknod(\"/dev/kmsg_debug\", S_IFCHR | 0622, makedev(1, 11)));\n    }\n\n    CHECKCALL(mknod(\"/dev/random\", S_IFCHR | 0666, makedev(1, 8)));\n    CHECKCALL(mknod(\"/dev/urandom\", S_IFCHR | 0666, makedev(1, 9)));\n\n    // This is needed for log wrapper, which gets called before ueventd runs.\n    CHECKCALL(mknod(\"/dev/ptmx\", S_IFCHR | 0666, makedev(5, 2)));\n    CHECKCALL(mknod(\"/dev/null\", S_IFCHR | 0666, makedev(1, 3)));\n\n    // These below mounts are done in first stage init so that first stage mount can mount\n    // subdirectories of /mnt/{vendor,product}/.  Other mounts, not required by first stage mount,\n    // should be done in rc files.\n    // Mount staging areas for devices managed by vold\n    // See storage config details at http://source.android.com/devices/storage/\n    CHECKCALL(mount(\"tmpfs\", \"/mnt\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=1000\"));\n    // /mnt/vendor is used to mount vendor-specific partitions that can not be\n    // part of the vendor partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/vendor\", 0755));\n    // /mnt/product is used to mount product-specific partitions that can not be\n    // part of the product partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/product\", 0755));\n\n    // /debug_ramdisk is used to preserve additional files from the debug ramdisk\n    CHECKCALL(mount(\"tmpfs\", \"/debug_ramdisk\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"));\n\n    // /second_stage_resources is used to preserve files from first to second\n    // stage init\n    CHECKCALL(mount(\"tmpfs\", kSecondStageRes, \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"))\n#undef CHECKCALL\n\n    SetStdioToDevNull(argv);\n    // Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually\n    // talk to the outside world...\n    InitKernelLogging(argv);\n\n    if (!errors.empty()) {\n        for (const auto& [error_string, error_errno] : errors) {\n            LOG(ERROR) << error_string << \" \" << strerror(error_errno);\n        }\n        LOG(FATAL) << \"Init encountered errors starting first stage, aborting\";\n    }\n\n    LOG(INFO) << \"init first stage started!\";\n\n    ...\n\n    //  /system/bin/init/selinux_setup,  SELinux\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"selinux_setup\", nullptr};\n    auto fd = open(\"/dev/kmsg\", O_WRONLY | O_CLOEXEC);\n    dup2(fd, STDOUT_FILENO);\n    dup2(fd, STDERR_FILENO);\n    close(fd);\n    execv(path, const_cast<char**>(args));\n\n    // execv() only returns if an error happened, in which case we\n    // panic and never fall through this conditional.\n    PLOG(FATAL) << \"execv(\\\"\" << path << \"\\\") failed\";\n\n    return 1;\n}\n```\n\n SELinux\n\n\n\n### 2.2.1 \n\n Linux `chmod` \n\n\n\n\n\n#### 2.2.1.1 \n\n 10 \n\n```\n-rwxrwxrwx\n```\n\n\n\n- `-`\n- `d`\n- `c`\n\n 9  3 \n\n3  1  2  3 \n\n-  1  `r` `-`\n-  2  `w` `-`\n-  3  `r` `-`\n\n\n\n\n\n`-rwxrw-r--`\n\n\n\n#### 2.2.1.2 \n\n 4  1  3 \n\n 3  3 \n\n|                    |  |\n| :--------------------: | :--: |\n| 1004 |  r   |\n| 0102 |  w   |\n| 0011 |  x   |\n| 0000 |  -   |\n\n 0~7\n\n|                    |  |\n| :--------------------: | :--: |\n| 1117 | rwx  |\n| 1106 | rw-  |\n| 1015 | r-x  |\n| 0000 | ---  |\n\n\n\n|  |  |                                                          |\n| :--------: | :--------: | :----------------------------------------------------------: |\n| -rwxrwxrwx |    0777    |    |\n| -rwxrw-r-- |    0764    |  |\n\n\n\n#### 2.2.1.3 \n\n```c++\n// Don't expose the raw commandline to unprivileged processes.\nCHECKCALL(chmod(\"/proc/cmdline\", 0440));\n\n// Don't expose the raw bootconfig to unprivileged processes.\nchmod(\"/proc/bootconfig\", 0440);\n```\n\n `chmod`  `/proc/cmdline, /proc/bootconfig`  `0440`root \n\n\n\n## 2.3  SELinux\n\n SELinux  `int SetupSelinux(char** argv)` `system/core/init/selinux.cpp`\n\n```c++\n// This function initializes SELinux then execs init to run in the init SELinux context.\nint SetupSelinux(char** argv) {\n    InitKernelLogging(argv);\n\n    if (REBOOT_BOOTLOADER_ON_PANIC) {\n        InstallRebootSignalHandlers();\n    }\n\n    // Set up SELinux, loading the SELinux policy.\n    //  SELinux\n    SelinuxSetupKernelLogging();\n    SelinuxInitialize();\n\n    ...\n\n    //  /system/bin/init/second_stage, \n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"second_stage\", nullptr};\n    execv(path, const_cast<char**>(args));\n\n    ...\n\n    return 1;\n}\n```\n\n SELinux `/system/bin/init/second_stage`\n\n\n\n## 2.4 \n\n `int SecondStageMain(int argc, char** argv)` `system/core/init/init.cpp`\n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    if (REBOOT_BOOTLOADER_ON_PANIC) {\n        InstallRebootSignalHandlers();\n    }\n\n    SetStdioToDevNull(argv);\n    InitKernelLogging(argv);\n    LOG(INFO) << \"init second stage started!\";\n\n    ...\n\n    // Now set up SELinux for second stage.\n    //  SeLinux\n    SelinuxSetupKernelLogging();\n    SelabelInitialize();\n    SelinuxRestoreContext();\n\n    ...\n\n    subcontexts = InitializeSubcontexts();\n\n    ActionManager& am = ActionManager::GetInstance();\n    ServiceList& sm = ServiceList::GetInstance();\n\n    //  init.rc ,  2.4.1\n    LoadBootScripts(am, sm);\n\n    ...\n\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n\n    am.QueueEventTrigger(\"early-init\");\n\n    // Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...\n    am.QueueBuiltinAction(wait_for_coldboot_done_action, \"wait_for_coldboot_done\");\n    // ... so that we can start queuing up actions that require stuff from /dev.\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n    am.QueueBuiltinAction(SetMmapRndBitsAction, \"SetMmapRndBits\");\n    am.QueueBuiltinAction(SetKptrRestrictAction, \"SetKptrRestrict\");\n    Keychords keychords;\n    am.QueueBuiltinAction(\n        [&epoll, &keychords](const BuiltinArguments& args) -> Result<Success> {\n            for (const auto& svc : ServiceList::GetInstance()) {\n                keychords.Register(svc->keycodes());\n            }\n            keychords.Start(&epoll, HandleKeychord);\n            return Success();\n        },\n        \"KeychordInit\");\n    am.QueueBuiltinAction(console_init_action, \"console_init\");\n\n    // Trigger all the boot actions to get us started.\n    am.QueueEventTrigger(\"init\");\n\n    // Starting the BoringSSL self test, for NIAP certification compliance.\n    am.QueueBuiltinAction(StartBoringSslSelfTest, \"StartBoringSslSelfTest\");\n\n    // Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random\n    // wasn't ready immediately after wait_for_coldboot_done\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n\n    // Initialize binder before bringing up other system services\n    am.QueueBuiltinAction(InitBinder, \"InitBinder\");\n\n    // Don't mount filesystems or start core system services in charger mode.\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        am.QueueEventTrigger(\"charger\");\n    } else {\n        am.QueueEventTrigger(\"late-init\");\n    }\n\n    // Run all property triggers based on current state of the properties.\n    am.QueueBuiltinAction(queue_property_triggers_action, \"queue_property_triggers\");\n\n    while (true) {\n        // By default, sleep until something happens.\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{};\n\n        if (do_shutdown && !shutting_down) {\n            do_shutdown = false;\n            if (HandlePowerctlMessage(shutdown_command)) {\n                shutting_down = true;\n            }\n        }\n\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            am.ExecuteOneCommand();\n        }\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            if (!shutting_down) {\n                auto next_process_action_time = HandleProcessActions();\n\n                // If there's a process that needs restarting, wake up in time for that.\n                if (next_process_action_time) {\n                    epoll_timeout = std::chrono::ceil<std::chrono::milliseconds>(\n                            *next_process_action_time - boot_clock::now());\n                    if (*epoll_timeout < 0ms) epoll_timeout = 0ms;\n                }\n            }\n\n            // If there's more work to do, wake up again immediately.\n            if (am.HasMoreCommands()) epoll_timeout = 0ms;\n        }\n\n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\n\n\n### 2.4.1  init.rc \n\n init.rc  `void LoadBootScripts(ActionManager& action_manager, ServiceList& service_list)` `system/core/init/init.cpp`\n\n```c++\nstatic void LoadBootScripts(ActionManager& action_manager, ServiceList& service_list) {\n    Parser parser = CreateParser(action_manager, service_list);\n\n    std::string bootscript = GetProperty(\"ro.boot.init_rc\", \"\");\n    if (bootscript.empty()) {\n        parser.ParseConfig(\"/init.rc\");\n        if (!parser.ParseConfig(\"/system/etc/init\")) {\n            late_import_paths.emplace_back(\"/system/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/product/etc/init\")) {\n            late_import_paths.emplace_back(\"/product/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/product_services/etc/init\")) {\n            late_import_paths.emplace_back(\"/product_services/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/odm/etc/init\")) {\n            late_import_paths.emplace_back(\"/odm/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/vendor/etc/init\")) {\n            late_import_paths.emplace_back(\"/vendor/etc/init\");\n        }\n    } else {\n        parser.ParseConfig(bootscript);\n    }\n}\n```\n\n\n\n\n\n# \n\n[Android-](http://gityuan.com/2016/02/01/android-booting/)\n\n[Android-zygote](http://gityuan.com/2016/02/13/android-zygote/)\n\n","source":"_drafts/exploring-zygote-startup-process.md","raw":"---\ntitle:  Zygote \ntags:\n- Zygote\ncategories:\n- [Android]\n---\n\n\n\n> : android-security-10.0.0_r56\n\n\n\n# 1. \n\nAndroid  Linux  init init  `init.rc`  Zygote Zygote \n\n<!-- TODO -->\n\n<!-- more -->\n\n\n\n# 2.  init \n\ninit  pid  1\n\n\n\n## 2.1 init \n\n Android 9init  `system/core/init/init.cpp`  main \n\n Android 10 init  `system/core/init/main.cpp`  main \n\n```c++\nint main(int argc, char** argv) {\n    \n    ...\n\n    if (!strcmp(basename(argv[0]), \"ueventd\")) {\n        return ueventd_main(argc, argv);\n    }\n\n    if (argc > 1) {\n        if (!strcmp(argv[1], \"subcontext\")) {\n            android::base::InitLogging(argv, &android::base::KernelLogger);\n            const BuiltinFunctionMap& function_map = GetBuiltinFunctionMap();\n\n            return SubcontextMain(argc, argv, &function_map);\n        }\n\n        if (!strcmp(argv[1], \"selinux_setup\")) {\n            return SetupSelinux(argv);\n        }\n\n        if (!strcmp(argv[1], \"second_stage\")) {\n            return SecondStageMain(argc, argv);\n        }\n    }\n\n    return FirstStageMain(argc, argv);\n}\n```\n\n`argc` `argv` `argv[0]` `arg[1]` \n\n> `strcmp(str1, str2)`  0\n>\n> `basename(path)`  \"/system/bin/ueventd\" \"ueventd\"\n\n`main` \n\n1.  `argv[0]`  \"ueventd\" `ueventd_main(argc, argv)`\n2.  `init` `SubcontextMain(argc, argv, &function_map)``SetupSelinux(argv)``SecondStageMain(argc, argv)` \n3.  `FirstStageMain(argc, argv)`\n\n\n\n## 2.2 \n\n `int FirstStageMain(int argc, char** argv)` `system/core/init/first_stage_init.cpp`\n\n```c++\nint FirstStageMain(int argc, char** argv) {\n\n    ...\n\n    CHECKCALL(clearenv());\n    CHECKCALL(setenv(\"PATH\", _PATH_DEFPATH, 1));\n    // Get the basic filesystem setup we need put together in the initramdisk\n    // on / and then we'll let the rc file figure out the rest.\n    CHECKCALL(mount(\"tmpfs\", \"/dev\", \"tmpfs\", MS_NOSUID, \"mode=0755\"));\n    CHECKCALL(mkdir(\"/dev/pts\", 0755));\n    CHECKCALL(mkdir(\"/dev/socket\", 0755));\n    CHECKCALL(mkdir(\"/dev/dm-user\", 0755));\n    CHECKCALL(mount(\"devpts\", \"/dev/pts\", \"devpts\", 0, NULL));\n#define MAKE_STR(x) __STRING(x)\n    CHECKCALL(mount(\"proc\", \"/proc\", \"proc\", 0, \"hidepid=2,gid=\" MAKE_STR(AID_READPROC)));\n#undef MAKE_STR\n\n    // Don't expose the raw commandline to unprivileged processes.\n    // ,  2.2.1\n    CHECKCALL(chmod(\"/proc/cmdline\", 0440));\n    std::string cmdline;\n    android::base::ReadFileToString(\"/proc/cmdline\", &cmdline);\n    // Don't expose the raw bootconfig to unprivileged processes.\n    chmod(\"/proc/bootconfig\", 0440);\n    std::string bootconfig;\n    android::base::ReadFileToString(\"/proc/bootconfig\", &bootconfig);\n    gid_t groups[] = {AID_READPROC};\n    CHECKCALL(setgroups(arraysize(groups), groups));\n    CHECKCALL(mount(\"sysfs\", \"/sys\", \"sysfs\", 0, NULL));\n    CHECKCALL(mount(\"selinuxfs\", \"/sys/fs/selinux\", \"selinuxfs\", 0, NULL));\n\n    CHECKCALL(mknod(\"/dev/kmsg\", S_IFCHR | 0600, makedev(1, 11)));\n\n    if constexpr (WORLD_WRITABLE_KMSG) {\n        CHECKCALL(mknod(\"/dev/kmsg_debug\", S_IFCHR | 0622, makedev(1, 11)));\n    }\n\n    CHECKCALL(mknod(\"/dev/random\", S_IFCHR | 0666, makedev(1, 8)));\n    CHECKCALL(mknod(\"/dev/urandom\", S_IFCHR | 0666, makedev(1, 9)));\n\n    // This is needed for log wrapper, which gets called before ueventd runs.\n    CHECKCALL(mknod(\"/dev/ptmx\", S_IFCHR | 0666, makedev(5, 2)));\n    CHECKCALL(mknod(\"/dev/null\", S_IFCHR | 0666, makedev(1, 3)));\n\n    // These below mounts are done in first stage init so that first stage mount can mount\n    // subdirectories of /mnt/{vendor,product}/.  Other mounts, not required by first stage mount,\n    // should be done in rc files.\n    // Mount staging areas for devices managed by vold\n    // See storage config details at http://source.android.com/devices/storage/\n    CHECKCALL(mount(\"tmpfs\", \"/mnt\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=1000\"));\n    // /mnt/vendor is used to mount vendor-specific partitions that can not be\n    // part of the vendor partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/vendor\", 0755));\n    // /mnt/product is used to mount product-specific partitions that can not be\n    // part of the product partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/product\", 0755));\n\n    // /debug_ramdisk is used to preserve additional files from the debug ramdisk\n    CHECKCALL(mount(\"tmpfs\", \"/debug_ramdisk\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"));\n\n    // /second_stage_resources is used to preserve files from first to second\n    // stage init\n    CHECKCALL(mount(\"tmpfs\", kSecondStageRes, \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"))\n#undef CHECKCALL\n\n    SetStdioToDevNull(argv);\n    // Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually\n    // talk to the outside world...\n    InitKernelLogging(argv);\n\n    if (!errors.empty()) {\n        for (const auto& [error_string, error_errno] : errors) {\n            LOG(ERROR) << error_string << \" \" << strerror(error_errno);\n        }\n        LOG(FATAL) << \"Init encountered errors starting first stage, aborting\";\n    }\n\n    LOG(INFO) << \"init first stage started!\";\n\n    ...\n\n    //  /system/bin/init/selinux_setup,  SELinux\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"selinux_setup\", nullptr};\n    auto fd = open(\"/dev/kmsg\", O_WRONLY | O_CLOEXEC);\n    dup2(fd, STDOUT_FILENO);\n    dup2(fd, STDERR_FILENO);\n    close(fd);\n    execv(path, const_cast<char**>(args));\n\n    // execv() only returns if an error happened, in which case we\n    // panic and never fall through this conditional.\n    PLOG(FATAL) << \"execv(\\\"\" << path << \"\\\") failed\";\n\n    return 1;\n}\n```\n\n SELinux\n\n\n\n### 2.2.1 \n\n Linux `chmod` \n\n\n\n\n\n#### 2.2.1.1 \n\n 10 \n\n```\n-rwxrwxrwx\n```\n\n\n\n- `-`\n- `d`\n- `c`\n\n 9  3 \n\n3  1  2  3 \n\n-  1  `r` `-`\n-  2  `w` `-`\n-  3  `r` `-`\n\n\n\n\n\n`-rwxrw-r--`\n\n\n\n#### 2.2.1.2 \n\n 4  1  3 \n\n 3  3 \n\n|                    |  |\n| :--------------------: | :--: |\n| 1004 |  r   |\n| 0102 |  w   |\n| 0011 |  x   |\n| 0000 |  -   |\n\n 0~7\n\n|                    |  |\n| :--------------------: | :--: |\n| 1117 | rwx  |\n| 1106 | rw-  |\n| 1015 | r-x  |\n| 0000 | ---  |\n\n\n\n|  |  |                                                          |\n| :--------: | :--------: | :----------------------------------------------------------: |\n| -rwxrwxrwx |    0777    |    |\n| -rwxrw-r-- |    0764    |  |\n\n\n\n#### 2.2.1.3 \n\n```c++\n// Don't expose the raw commandline to unprivileged processes.\nCHECKCALL(chmod(\"/proc/cmdline\", 0440));\n\n// Don't expose the raw bootconfig to unprivileged processes.\nchmod(\"/proc/bootconfig\", 0440);\n```\n\n `chmod`  `/proc/cmdline, /proc/bootconfig`  `0440`root \n\n\n\n## 2.3  SELinux\n\n SELinux  `int SetupSelinux(char** argv)` `system/core/init/selinux.cpp`\n\n```c++\n// This function initializes SELinux then execs init to run in the init SELinux context.\nint SetupSelinux(char** argv) {\n    InitKernelLogging(argv);\n\n    if (REBOOT_BOOTLOADER_ON_PANIC) {\n        InstallRebootSignalHandlers();\n    }\n\n    // Set up SELinux, loading the SELinux policy.\n    //  SELinux\n    SelinuxSetupKernelLogging();\n    SelinuxInitialize();\n\n    ...\n\n    //  /system/bin/init/second_stage, \n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"second_stage\", nullptr};\n    execv(path, const_cast<char**>(args));\n\n    ...\n\n    return 1;\n}\n```\n\n SELinux `/system/bin/init/second_stage`\n\n\n\n## 2.4 \n\n `int SecondStageMain(int argc, char** argv)` `system/core/init/init.cpp`\n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    if (REBOOT_BOOTLOADER_ON_PANIC) {\n        InstallRebootSignalHandlers();\n    }\n\n    SetStdioToDevNull(argv);\n    InitKernelLogging(argv);\n    LOG(INFO) << \"init second stage started!\";\n\n    ...\n\n    // Now set up SELinux for second stage.\n    //  SeLinux\n    SelinuxSetupKernelLogging();\n    SelabelInitialize();\n    SelinuxRestoreContext();\n\n    ...\n\n    subcontexts = InitializeSubcontexts();\n\n    ActionManager& am = ActionManager::GetInstance();\n    ServiceList& sm = ServiceList::GetInstance();\n\n    //  init.rc ,  2.4.1\n    LoadBootScripts(am, sm);\n\n    ...\n\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n\n    am.QueueEventTrigger(\"early-init\");\n\n    // Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...\n    am.QueueBuiltinAction(wait_for_coldboot_done_action, \"wait_for_coldboot_done\");\n    // ... so that we can start queuing up actions that require stuff from /dev.\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n    am.QueueBuiltinAction(SetMmapRndBitsAction, \"SetMmapRndBits\");\n    am.QueueBuiltinAction(SetKptrRestrictAction, \"SetKptrRestrict\");\n    Keychords keychords;\n    am.QueueBuiltinAction(\n        [&epoll, &keychords](const BuiltinArguments& args) -> Result<Success> {\n            for (const auto& svc : ServiceList::GetInstance()) {\n                keychords.Register(svc->keycodes());\n            }\n            keychords.Start(&epoll, HandleKeychord);\n            return Success();\n        },\n        \"KeychordInit\");\n    am.QueueBuiltinAction(console_init_action, \"console_init\");\n\n    // Trigger all the boot actions to get us started.\n    am.QueueEventTrigger(\"init\");\n\n    // Starting the BoringSSL self test, for NIAP certification compliance.\n    am.QueueBuiltinAction(StartBoringSslSelfTest, \"StartBoringSslSelfTest\");\n\n    // Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random\n    // wasn't ready immediately after wait_for_coldboot_done\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n\n    // Initialize binder before bringing up other system services\n    am.QueueBuiltinAction(InitBinder, \"InitBinder\");\n\n    // Don't mount filesystems or start core system services in charger mode.\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        am.QueueEventTrigger(\"charger\");\n    } else {\n        am.QueueEventTrigger(\"late-init\");\n    }\n\n    // Run all property triggers based on current state of the properties.\n    am.QueueBuiltinAction(queue_property_triggers_action, \"queue_property_triggers\");\n\n    while (true) {\n        // By default, sleep until something happens.\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{};\n\n        if (do_shutdown && !shutting_down) {\n            do_shutdown = false;\n            if (HandlePowerctlMessage(shutdown_command)) {\n                shutting_down = true;\n            }\n        }\n\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            am.ExecuteOneCommand();\n        }\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            if (!shutting_down) {\n                auto next_process_action_time = HandleProcessActions();\n\n                // If there's a process that needs restarting, wake up in time for that.\n                if (next_process_action_time) {\n                    epoll_timeout = std::chrono::ceil<std::chrono::milliseconds>(\n                            *next_process_action_time - boot_clock::now());\n                    if (*epoll_timeout < 0ms) epoll_timeout = 0ms;\n                }\n            }\n\n            // If there's more work to do, wake up again immediately.\n            if (am.HasMoreCommands()) epoll_timeout = 0ms;\n        }\n\n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\n\n\n### 2.4.1  init.rc \n\n init.rc  `void LoadBootScripts(ActionManager& action_manager, ServiceList& service_list)` `system/core/init/init.cpp`\n\n```c++\nstatic void LoadBootScripts(ActionManager& action_manager, ServiceList& service_list) {\n    Parser parser = CreateParser(action_manager, service_list);\n\n    std::string bootscript = GetProperty(\"ro.boot.init_rc\", \"\");\n    if (bootscript.empty()) {\n        parser.ParseConfig(\"/init.rc\");\n        if (!parser.ParseConfig(\"/system/etc/init\")) {\n            late_import_paths.emplace_back(\"/system/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/product/etc/init\")) {\n            late_import_paths.emplace_back(\"/product/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/product_services/etc/init\")) {\n            late_import_paths.emplace_back(\"/product_services/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/odm/etc/init\")) {\n            late_import_paths.emplace_back(\"/odm/etc/init\");\n        }\n        if (!parser.ParseConfig(\"/vendor/etc/init\")) {\n            late_import_paths.emplace_back(\"/vendor/etc/init\");\n        }\n    } else {\n        parser.ParseConfig(bootscript);\n    }\n}\n```\n\n\n\n\n\n# \n\n[Android-](http://gityuan.com/2016/02/01/android-booting/)\n\n[Android-zygote](http://gityuan.com/2016/02/13/android-zygote/)\n\n","slug":"exploring-zygote-startup-process","published":0,"date":"2021-08-17T09:00:08.586Z","updated":"2021-08-23T09:57:32.453Z","_id":"cksh4vd82000eqkpr503zbpok","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>: android-security-10.0.0_r56</p>\n</blockquote>\n<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><p>Android  Linux  init init  <code>init.rc</code>  Zygote Zygote </p>\n<!-- TODO -->\n\n<a id=\"more\"></a>\n\n\n\n<h1 id=\"2--init-\"><a href=\"#2--init-\" class=\"headerlink\" title=\"2.  init \"></a>2.  init </h1><p>init  pid  1</p>\n<h2 id=\"2-1-init-\"><a href=\"#2-1-init-\" class=\"headerlink\" title=\"2.1 init \"></a>2.1 init </h2><p> Android 9init  <code>system/core/init/init.cpp</code>  main </p>\n<p> Android 10 init  <code>system/core/init/main.cpp</code>  main </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(basename(argv[<span class=\"number\">0</span>]), <span class=\"string\">&quot;ueventd&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ueventd_main(argc, argv);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;subcontext&quot;</span>)) &#123;</span><br><span class=\"line\">            android::base::InitLogging(argv, &amp;android::base::KernelLogger);</span><br><span class=\"line\">            <span class=\"keyword\">const</span> BuiltinFunctionMap&amp; function_map = GetBuiltinFunctionMap();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> SubcontextMain(argc, argv, &amp;function_map);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;selinux_setup&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SetupSelinux(argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;second_stage&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SecondStageMain(argc, argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> FirstStageMain(argc, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>argc</code> <code>argv</code> <code>argv[0]</code> <code>arg[1]</code> </p>\n<blockquote>\n<p><code>strcmp(str1, str2)</code>  0</p>\n<p><code>basename(path)</code>  /system/bin/ueventd ueventd</p>\n</blockquote>\n<p><code>main</code> </p>\n<ol>\n<li> <code>argv[0]</code>  ueventd <code>ueventd_main(argc, argv)</code></li>\n<li> <code>init</code> <code>SubcontextMain(argc, argv, &amp;function_map)</code><code>SetupSelinux(argv)</code><code>SecondStageMain(argc, argv)</code> </li>\n<li> <code>FirstStageMain(argc, argv)</code></li>\n</ol>\n<h2 id=\"2-2-\"><a href=\"#2-2-\" class=\"headerlink\" title=\"2.2 \"></a>2.2 </h2><p> <code>int FirstStageMain(int argc, char** argv)</code> <code>system/core/init/first_stage_init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">FirstStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(clearenv());</span><br><span class=\"line\">    CHECKCALL(setenv(<span class=\"string\">&quot;PATH&quot;</span>, _PATH_DEFPATH, <span class=\"number\">1</span>));</span><br><span class=\"line\">    <span class=\"comment\">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class=\"line\">    <span class=\"comment\">// on / and then we&#x27;ll let the rc file figure out the rest.</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/dev&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class=\"string\">&quot;mode=0755&quot;</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/socket&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/dm-user&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;devpts&quot;</span>, <span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"string\">&quot;devpts&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> MAKE_STR(x) __STRING(x)</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;proc&quot;</span>, <span class=\"string\">&quot;/proc&quot;</span>, <span class=\"string\">&quot;proc&quot;</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;hidepid=2,gid=&quot;</span> MAKE_STR(AID_READPROC)));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> MAKE_STR</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">    <span class=\"comment\">// ,  2.2.1</span></span><br><span class=\"line\">    CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> cmdline;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, &amp;cmdline);</span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">    chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootconfig;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, &amp;bootconfig);</span><br><span class=\"line\">    <span class=\"keyword\">gid_t</span> groups[] = &#123;AID_READPROC&#125;;</span><br><span class=\"line\">    CHECKCALL(setgroups(arraysize(groups), groups));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"string\">&quot;/sys&quot;</span>, <span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"string\">&quot;/sys/fs/selinux&quot;</span>, <span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, S_IFCHR | <span class=\"number\">0600</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">if</span> <span class=\"title\">constexpr</span> <span class=\"params\">(WORLD_WRITABLE_KMSG)</span> </span>&#123;</span><br><span class=\"line\">        CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg_debug&quot;</span>, S_IFCHR | <span class=\"number\">0622</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/random&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">8</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/urandom&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">9</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// This is needed for log wrapper, which gets called before ueventd runs.</span></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/ptmx&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">5</span>, <span class=\"number\">2</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/null&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">3</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// These below mounts are done in first stage init so that first stage mount can mount</span></span><br><span class=\"line\">    <span class=\"comment\">// subdirectories of /mnt/&#123;vendor,product&#125;/.  Other mounts, not required by first stage mount,</span></span><br><span class=\"line\">    <span class=\"comment\">// should be done in rc files.</span></span><br><span class=\"line\">    <span class=\"comment\">// Mount staging areas for devices managed by vold</span></span><br><span class=\"line\">    <span class=\"comment\">// See storage config details at http://source.android.com/devices/storage/</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/mnt&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=1000&quot;</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/vendor is used to mount vendor-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the vendor partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/vendor&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/product is used to mount product-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the product partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/product&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /debug_ramdisk is used to preserve additional files from the debug ramdisk</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/debug_ramdisk&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /second_stage_resources is used to preserve files from first to second</span></span><br><span class=\"line\">    <span class=\"comment\">// stage init</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, kSecondStageRes, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>))</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> CHECKCALL</span></span><br><span class=\"line\"></span><br><span class=\"line\">    SetStdioToDevNull(argv);</span><br><span class=\"line\">    <span class=\"comment\">// Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually</span></span><br><span class=\"line\">    <span class=\"comment\">// talk to the outside world...</span></span><br><span class=\"line\">    InitKernelLogging(argv);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!errors.empty()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; [error_string, error_errno] : errors) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; error_string &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; strerror(error_errno);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Init encountered errors starting first stage, aborting&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    LOG(INFO) &lt;&lt; <span class=\"string\">&quot;init first stage started!&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init/selinux_setup,  SELinux</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;selinux_setup&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">auto</span> fd = open(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, O_WRONLY | O_CLOEXEC);</span><br><span class=\"line\">    dup2(fd, STDOUT_FILENO);</span><br><span class=\"line\">    dup2(fd, STDERR_FILENO);</span><br><span class=\"line\">    close(fd);</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// execv() only returns if an error happened, in which case we</span></span><br><span class=\"line\">    <span class=\"comment\">// panic and never fall through this conditional.</span></span><br><span class=\"line\">    PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;execv(\\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class=\"string\">&quot;\\&quot;) failed&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> SELinux</p>\n<h3 id=\"2-2-1-\"><a href=\"#2-2-1-\" class=\"headerlink\" title=\"2.2.1 \"></a>2.2.1 </h3><p> Linux <code>chmod</code> </p>\n<p></p>\n<h4 id=\"2-2-1-1-\"><a href=\"#2-2-1-1-\" class=\"headerlink\" title=\"2.2.1.1 \"></a>2.2.1.1 </h4><p> 10 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-rwxrwxrwx</span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li><code>-</code></li>\n<li><code>d</code></li>\n<li><code>c</code></li>\n</ul>\n<p> 9  3 </p>\n<p>3  1  2  3 </p>\n<ul>\n<li> 1  <code>r</code> <code>-</code></li>\n<li> 2  <code>w</code> <code>-</code></li>\n<li> 3  <code>r</code> <code>-</code></li>\n</ul>\n<p></p>\n<p><code>-rwxrw-r--</code></p>\n<h4 id=\"2-2-1-2-\"><a href=\"#2-2-1-2-\" class=\"headerlink\" title=\"2.2.1.2 \"></a>2.2.1.2 </h4><p> 4  1  3 </p>\n<p> 3  3 </p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1004</td>\n<td align=\"center\">r</td>\n</tr>\n<tr>\n<td align=\"center\">0102</td>\n<td align=\"center\">w</td>\n</tr>\n<tr>\n<td align=\"center\">0011</td>\n<td align=\"center\">x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\">-</td>\n</tr>\n</tbody></table>\n<p> 0~7</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1117</td>\n<td align=\"center\">rwx</td>\n</tr>\n<tr>\n<td align=\"center\">1106</td>\n<td align=\"center\">rw-</td>\n</tr>\n<tr>\n<td align=\"center\">1015</td>\n<td align=\"center\">r-x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">-rwxrwxrwx</td>\n<td align=\"center\">0777</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">-rwxrw-r</td>\n<td align=\"center\">0764</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<h4 id=\"2-2-1-3-\"><a href=\"#2-2-1-3-\" class=\"headerlink\" title=\"2.2.1.3 \"></a>2.2.1.3 </h4><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br></pre></td></tr></table></figure>\n<p> <code>chmod</code>  <code>/proc/cmdline, /proc/bootconfig</code>  <code>0440</code>root </p>\n<h2 id=\"2-3--SELinux\"><a href=\"#2-3--SELinux\" class=\"headerlink\" title=\"2.3  SELinux\"></a>2.3  SELinux</h2><p> SELinux  <code>int SetupSelinux(char** argv)</code> <code>system/core/init/selinux.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// This function initializes SELinux then execs init to run in the init SELinux context.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SetupSelinux</span><span class=\"params\">(<span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    InitKernelLogging(argv);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;</span><br><span class=\"line\">        InstallRebootSignalHandlers();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Set up SELinux, loading the SELinux policy.</span></span><br><span class=\"line\">    <span class=\"comment\">//  SELinux</span></span><br><span class=\"line\">    SelinuxSetupKernelLogging();</span><br><span class=\"line\">    SelinuxInitialize();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init/second_stage, </span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;second_stage&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> SELinux <code>/system/bin/init/second_stage</code></p>\n<h2 id=\"2-4-\"><a href=\"#2-4-\" class=\"headerlink\" title=\"2.4 \"></a>2.4 </h2><p> <code>int SecondStageMain(int argc, char** argv)</code> <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;</span><br><span class=\"line\">        InstallRebootSignalHandlers();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    SetStdioToDevNull(argv);</span><br><span class=\"line\">    InitKernelLogging(argv);</span><br><span class=\"line\">    LOG(INFO) &lt;&lt; <span class=\"string\">&quot;init second stage started!&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Now set up SELinux for second stage.</span></span><br><span class=\"line\">    <span class=\"comment\">//  SeLinux</span></span><br><span class=\"line\">    SelinuxSetupKernelLogging();</span><br><span class=\"line\">    SelabelInitialize();</span><br><span class=\"line\">    SelinuxRestoreContext();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    subcontexts = InitializeSubcontexts();</span><br><span class=\"line\"></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\">    ServiceList&amp; sm = ServiceList::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  init.rc ,  2.4.1</span></span><br><span class=\"line\">    LoadBootScripts(am, sm);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span></span><br><span class=\"line\">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class=\"string\">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class=\"line\">    <span class=\"comment\">// ... so that we can start queuing up actions that require stuff from /dev.</span></span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetMmapRndBitsAction, <span class=\"string\">&quot;SetMmapRndBits&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetKptrRestrictAction, <span class=\"string\">&quot;SetKptrRestrict&quot;</span>);</span><br><span class=\"line\">    Keychords keychords;</span><br><span class=\"line\">    am.QueueBuiltinAction(</span><br><span class=\"line\">        [&amp;epoll, &amp;keychords](<span class=\"keyword\">const</span> BuiltinArguments&amp; args) -&gt; Result&lt;Success&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; svc : ServiceList::GetInstance()) &#123;</span><br><span class=\"line\">                keychords.Register(svc-&gt;keycodes());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            keychords.Start(&amp;epoll, HandleKeychord);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;KeychordInit&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(console_init_action, <span class=\"string\">&quot;console_init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Trigger all the boot actions to get us started.</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Starting the BoringSSL self test, for NIAP certification compliance.</span></span><br><span class=\"line\">    am.QueueBuiltinAction(StartBoringSslSelfTest, <span class=\"string\">&quot;StartBoringSslSelfTest&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span></span><br><span class=\"line\">    <span class=\"comment\">// wasn&#x27;t ready immediately after wait_for_coldboot_done</span></span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Initialize binder before bringing up other system services</span></span><br><span class=\"line\">    am.QueueBuiltinAction(InitBinder, <span class=\"string\">&quot;InitBinder&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t mount filesystems or start core system services in charger mode.</span></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootmode = GetProperty(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Run all property triggers based on current state of the properties.</span></span><br><span class=\"line\">    am.QueueBuiltinAction(queue_property_triggers_action, <span class=\"string\">&quot;queue_property_triggers&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// By default, sleep until something happens.</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = <span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (do_shutdown &amp;&amp; !shutting_down) &#123;</span><br><span class=\"line\">            do_shutdown = <span class=\"literal\">false</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (HandlePowerctlMessage(shutdown_command)) &#123;</span><br><span class=\"line\">                shutting_down = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            am.ExecuteOneCommand();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!shutting_down) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">auto</span> next_process_action_time = HandleProcessActions();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// If there&#x27;s a process that needs restarting, wake up in time for that.</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (next_process_action_time) &#123;</span><br><span class=\"line\">                    epoll_timeout = <span class=\"built_in\">std</span>::chrono::<span class=\"built_in\">ceil</span>&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;(</span><br><span class=\"line\">                            *next_process_action_time - boot_clock::now());</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (*epoll_timeout &lt; <span class=\"number\">0</span>ms) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// If there&#x27;s more work to do, wake up again immediately.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (am.HasMoreCommands()) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"2-4-1--init-rc-\"><a href=\"#2-4-1--init-rc-\" class=\"headerlink\" title=\"2.4.1  init.rc \"></a>2.4.1  init.rc </h3><p> init.rc  <code>void LoadBootScripts(ActionManager&amp; action_manager, ServiceList&amp; service_list)</code> <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">LoadBootScripts</span><span class=\"params\">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> </span>&#123;</span><br><span class=\"line\">    Parser parser = CreateParser(action_manager, service_list);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootscript = GetProperty(<span class=\"string\">&quot;ro.boot.init_rc&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootscript.empty()) &#123;</span><br><span class=\"line\">        parser.ParseConfig(<span class=\"string\">&quot;/init.rc&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/system/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/system/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/odm/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/odm/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        parser.ParseConfig(bootscript);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"http://gityuan.com/2016/02/01/android-booting/\">Android-</a></p>\n<p><a href=\"http://gityuan.com/2016/02/13/android-zygote/\">Android-zygote</a></p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>: android-security-10.0.0_r56</p>\n</blockquote>\n<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><p>Android  Linux  init init  <code>init.rc</code>  Zygote Zygote </p>\n<!-- TODO -->","more":"<h1 id=\"2--init-\"><a href=\"#2--init-\" class=\"headerlink\" title=\"2.  init \"></a>2.  init </h1><p>init  pid  1</p>\n<h2 id=\"2-1-init-\"><a href=\"#2-1-init-\" class=\"headerlink\" title=\"2.1 init \"></a>2.1 init </h2><p> Android 9init  <code>system/core/init/init.cpp</code>  main </p>\n<p> Android 10 init  <code>system/core/init/main.cpp</code>  main </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(basename(argv[<span class=\"number\">0</span>]), <span class=\"string\">&quot;ueventd&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ueventd_main(argc, argv);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;subcontext&quot;</span>)) &#123;</span><br><span class=\"line\">            android::base::InitLogging(argv, &amp;android::base::KernelLogger);</span><br><span class=\"line\">            <span class=\"keyword\">const</span> BuiltinFunctionMap&amp; function_map = GetBuiltinFunctionMap();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> SubcontextMain(argc, argv, &amp;function_map);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;selinux_setup&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SetupSelinux(argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;second_stage&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SecondStageMain(argc, argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> FirstStageMain(argc, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>argc</code> <code>argv</code> <code>argv[0]</code> <code>arg[1]</code> </p>\n<blockquote>\n<p><code>strcmp(str1, str2)</code>  0</p>\n<p><code>basename(path)</code>  /system/bin/ueventd ueventd</p>\n</blockquote>\n<p><code>main</code> </p>\n<ol>\n<li> <code>argv[0]</code>  ueventd <code>ueventd_main(argc, argv)</code></li>\n<li> <code>init</code> <code>SubcontextMain(argc, argv, &amp;function_map)</code><code>SetupSelinux(argv)</code><code>SecondStageMain(argc, argv)</code> </li>\n<li> <code>FirstStageMain(argc, argv)</code></li>\n</ol>\n<h2 id=\"2-2-\"><a href=\"#2-2-\" class=\"headerlink\" title=\"2.2 \"></a>2.2 </h2><p> <code>int FirstStageMain(int argc, char** argv)</code> <code>system/core/init/first_stage_init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">FirstStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(clearenv());</span><br><span class=\"line\">    CHECKCALL(setenv(<span class=\"string\">&quot;PATH&quot;</span>, _PATH_DEFPATH, <span class=\"number\">1</span>));</span><br><span class=\"line\">    <span class=\"comment\">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class=\"line\">    <span class=\"comment\">// on / and then we&#x27;ll let the rc file figure out the rest.</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/dev&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class=\"string\">&quot;mode=0755&quot;</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/socket&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/dm-user&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;devpts&quot;</span>, <span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"string\">&quot;devpts&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> MAKE_STR(x) __STRING(x)</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;proc&quot;</span>, <span class=\"string\">&quot;/proc&quot;</span>, <span class=\"string\">&quot;proc&quot;</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;hidepid=2,gid=&quot;</span> MAKE_STR(AID_READPROC)));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> MAKE_STR</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">    <span class=\"comment\">// ,  2.2.1</span></span><br><span class=\"line\">    CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> cmdline;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, &amp;cmdline);</span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">    chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootconfig;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, &amp;bootconfig);</span><br><span class=\"line\">    <span class=\"keyword\">gid_t</span> groups[] = &#123;AID_READPROC&#125;;</span><br><span class=\"line\">    CHECKCALL(setgroups(arraysize(groups), groups));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"string\">&quot;/sys&quot;</span>, <span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"string\">&quot;/sys/fs/selinux&quot;</span>, <span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, S_IFCHR | <span class=\"number\">0600</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">if</span> <span class=\"title\">constexpr</span> <span class=\"params\">(WORLD_WRITABLE_KMSG)</span> </span>&#123;</span><br><span class=\"line\">        CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg_debug&quot;</span>, S_IFCHR | <span class=\"number\">0622</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/random&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">8</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/urandom&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">9</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// This is needed for log wrapper, which gets called before ueventd runs.</span></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/ptmx&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">5</span>, <span class=\"number\">2</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/null&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">3</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// These below mounts are done in first stage init so that first stage mount can mount</span></span><br><span class=\"line\">    <span class=\"comment\">// subdirectories of /mnt/&#123;vendor,product&#125;/.  Other mounts, not required by first stage mount,</span></span><br><span class=\"line\">    <span class=\"comment\">// should be done in rc files.</span></span><br><span class=\"line\">    <span class=\"comment\">// Mount staging areas for devices managed by vold</span></span><br><span class=\"line\">    <span class=\"comment\">// See storage config details at http://source.android.com/devices/storage/</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/mnt&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=1000&quot;</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/vendor is used to mount vendor-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the vendor partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/vendor&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/product is used to mount product-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the product partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/product&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /debug_ramdisk is used to preserve additional files from the debug ramdisk</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/debug_ramdisk&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /second_stage_resources is used to preserve files from first to second</span></span><br><span class=\"line\">    <span class=\"comment\">// stage init</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, kSecondStageRes, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>))</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> CHECKCALL</span></span><br><span class=\"line\"></span><br><span class=\"line\">    SetStdioToDevNull(argv);</span><br><span class=\"line\">    <span class=\"comment\">// Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually</span></span><br><span class=\"line\">    <span class=\"comment\">// talk to the outside world...</span></span><br><span class=\"line\">    InitKernelLogging(argv);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!errors.empty()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; [error_string, error_errno] : errors) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; error_string &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; strerror(error_errno);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Init encountered errors starting first stage, aborting&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    LOG(INFO) &lt;&lt; <span class=\"string\">&quot;init first stage started!&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init/selinux_setup,  SELinux</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;selinux_setup&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">auto</span> fd = open(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, O_WRONLY | O_CLOEXEC);</span><br><span class=\"line\">    dup2(fd, STDOUT_FILENO);</span><br><span class=\"line\">    dup2(fd, STDERR_FILENO);</span><br><span class=\"line\">    close(fd);</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// execv() only returns if an error happened, in which case we</span></span><br><span class=\"line\">    <span class=\"comment\">// panic and never fall through this conditional.</span></span><br><span class=\"line\">    PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;execv(\\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class=\"string\">&quot;\\&quot;) failed&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> SELinux</p>\n<h3 id=\"2-2-1-\"><a href=\"#2-2-1-\" class=\"headerlink\" title=\"2.2.1 \"></a>2.2.1 </h3><p> Linux <code>chmod</code> </p>\n<p></p>\n<h4 id=\"2-2-1-1-\"><a href=\"#2-2-1-1-\" class=\"headerlink\" title=\"2.2.1.1 \"></a>2.2.1.1 </h4><p> 10 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-rwxrwxrwx</span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li><code>-</code></li>\n<li><code>d</code></li>\n<li><code>c</code></li>\n</ul>\n<p> 9  3 </p>\n<p>3  1  2  3 </p>\n<ul>\n<li> 1  <code>r</code> <code>-</code></li>\n<li> 2  <code>w</code> <code>-</code></li>\n<li> 3  <code>r</code> <code>-</code></li>\n</ul>\n<p></p>\n<p><code>-rwxrw-r--</code></p>\n<h4 id=\"2-2-1-2-\"><a href=\"#2-2-1-2-\" class=\"headerlink\" title=\"2.2.1.2 \"></a>2.2.1.2 </h4><p> 4  1  3 </p>\n<p> 3  3 </p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1004</td>\n<td align=\"center\">r</td>\n</tr>\n<tr>\n<td align=\"center\">0102</td>\n<td align=\"center\">w</td>\n</tr>\n<tr>\n<td align=\"center\">0011</td>\n<td align=\"center\">x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\">-</td>\n</tr>\n</tbody></table>\n<p> 0~7</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1117</td>\n<td align=\"center\">rwx</td>\n</tr>\n<tr>\n<td align=\"center\">1106</td>\n<td align=\"center\">rw-</td>\n</tr>\n<tr>\n<td align=\"center\">1015</td>\n<td align=\"center\">r-x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">-rwxrwxrwx</td>\n<td align=\"center\">0777</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">-rwxrw-r</td>\n<td align=\"center\">0764</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<h4 id=\"2-2-1-3-\"><a href=\"#2-2-1-3-\" class=\"headerlink\" title=\"2.2.1.3 \"></a>2.2.1.3 </h4><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br></pre></td></tr></table></figure>\n<p> <code>chmod</code>  <code>/proc/cmdline, /proc/bootconfig</code>  <code>0440</code>root </p>\n<h2 id=\"2-3--SELinux\"><a href=\"#2-3--SELinux\" class=\"headerlink\" title=\"2.3  SELinux\"></a>2.3  SELinux</h2><p> SELinux  <code>int SetupSelinux(char** argv)</code> <code>system/core/init/selinux.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// This function initializes SELinux then execs init to run in the init SELinux context.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SetupSelinux</span><span class=\"params\">(<span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    InitKernelLogging(argv);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;</span><br><span class=\"line\">        InstallRebootSignalHandlers();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Set up SELinux, loading the SELinux policy.</span></span><br><span class=\"line\">    <span class=\"comment\">//  SELinux</span></span><br><span class=\"line\">    SelinuxSetupKernelLogging();</span><br><span class=\"line\">    SelinuxInitialize();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init/second_stage, </span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;second_stage&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> SELinux <code>/system/bin/init/second_stage</code></p>\n<h2 id=\"2-4-\"><a href=\"#2-4-\" class=\"headerlink\" title=\"2.4 \"></a>2.4 </h2><p> <code>int SecondStageMain(int argc, char** argv)</code> <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;</span><br><span class=\"line\">        InstallRebootSignalHandlers();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    SetStdioToDevNull(argv);</span><br><span class=\"line\">    InitKernelLogging(argv);</span><br><span class=\"line\">    LOG(INFO) &lt;&lt; <span class=\"string\">&quot;init second stage started!&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Now set up SELinux for second stage.</span></span><br><span class=\"line\">    <span class=\"comment\">//  SeLinux</span></span><br><span class=\"line\">    SelinuxSetupKernelLogging();</span><br><span class=\"line\">    SelabelInitialize();</span><br><span class=\"line\">    SelinuxRestoreContext();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    subcontexts = InitializeSubcontexts();</span><br><span class=\"line\"></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\">    ServiceList&amp; sm = ServiceList::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  init.rc ,  2.4.1</span></span><br><span class=\"line\">    LoadBootScripts(am, sm);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span></span><br><span class=\"line\">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class=\"string\">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class=\"line\">    <span class=\"comment\">// ... so that we can start queuing up actions that require stuff from /dev.</span></span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetMmapRndBitsAction, <span class=\"string\">&quot;SetMmapRndBits&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetKptrRestrictAction, <span class=\"string\">&quot;SetKptrRestrict&quot;</span>);</span><br><span class=\"line\">    Keychords keychords;</span><br><span class=\"line\">    am.QueueBuiltinAction(</span><br><span class=\"line\">        [&amp;epoll, &amp;keychords](<span class=\"keyword\">const</span> BuiltinArguments&amp; args) -&gt; Result&lt;Success&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; svc : ServiceList::GetInstance()) &#123;</span><br><span class=\"line\">                keychords.Register(svc-&gt;keycodes());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            keychords.Start(&amp;epoll, HandleKeychord);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;KeychordInit&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(console_init_action, <span class=\"string\">&quot;console_init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Trigger all the boot actions to get us started.</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Starting the BoringSSL self test, for NIAP certification compliance.</span></span><br><span class=\"line\">    am.QueueBuiltinAction(StartBoringSslSelfTest, <span class=\"string\">&quot;StartBoringSslSelfTest&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span></span><br><span class=\"line\">    <span class=\"comment\">// wasn&#x27;t ready immediately after wait_for_coldboot_done</span></span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Initialize binder before bringing up other system services</span></span><br><span class=\"line\">    am.QueueBuiltinAction(InitBinder, <span class=\"string\">&quot;InitBinder&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t mount filesystems or start core system services in charger mode.</span></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootmode = GetProperty(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Run all property triggers based on current state of the properties.</span></span><br><span class=\"line\">    am.QueueBuiltinAction(queue_property_triggers_action, <span class=\"string\">&quot;queue_property_triggers&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// By default, sleep until something happens.</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = <span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (do_shutdown &amp;&amp; !shutting_down) &#123;</span><br><span class=\"line\">            do_shutdown = <span class=\"literal\">false</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (HandlePowerctlMessage(shutdown_command)) &#123;</span><br><span class=\"line\">                shutting_down = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            am.ExecuteOneCommand();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!shutting_down) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">auto</span> next_process_action_time = HandleProcessActions();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// If there&#x27;s a process that needs restarting, wake up in time for that.</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (next_process_action_time) &#123;</span><br><span class=\"line\">                    epoll_timeout = <span class=\"built_in\">std</span>::chrono::<span class=\"built_in\">ceil</span>&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;(</span><br><span class=\"line\">                            *next_process_action_time - boot_clock::now());</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (*epoll_timeout &lt; <span class=\"number\">0</span>ms) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// If there&#x27;s more work to do, wake up again immediately.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (am.HasMoreCommands()) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"2-4-1--init-rc-\"><a href=\"#2-4-1--init-rc-\" class=\"headerlink\" title=\"2.4.1  init.rc \"></a>2.4.1  init.rc </h3><p> init.rc  <code>void LoadBootScripts(ActionManager&amp; action_manager, ServiceList&amp; service_list)</code> <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">LoadBootScripts</span><span class=\"params\">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> </span>&#123;</span><br><span class=\"line\">    Parser parser = CreateParser(action_manager, service_list);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootscript = GetProperty(<span class=\"string\">&quot;ro.boot.init_rc&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootscript.empty()) &#123;</span><br><span class=\"line\">        parser.ParseConfig(<span class=\"string\">&quot;/init.rc&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/system/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/system/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/odm/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/odm/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        parser.ParseConfig(bootscript);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"http://gityuan.com/2016/02/01/android-booting/\">Android-</a></p>\n<p><a href=\"http://gityuan.com/2016/02/13/android-zygote/\">Android-zygote</a></p>"},{"title":" Android Binder","mathjax":true,"_content":"","source":"_drafts/exploring-android-binder.md","raw":"---\ntitle:  Android Binder\ncategories:\n- [Android, Framework, Binder]\nmathjax: true\n---\n","slug":"exploring-android-binder","published":0,"date":"2021-06-23T12:56:57.338Z","updated":"2021-08-18T06:49:11.269Z","_id":"cksh4vtpi000hqkprcbem8gz5","comments":1,"layout":"post","photos":[],"link":"","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":" Android app ","_content":"\n\n\n> : android-security-10.0.0_r56\n\n\n\n## 1. \n\n<!-- more -->\n\n\n\n### 1.1 \n\n<!-- TODO -->\n\n\n\n#### 1.1.1 Android \n\n<!-- TODO -->\n\n\n\n#### 1.1.2 Linux fork\n\n<!-- TODO -->\n\n\n\n## 2. system_server \n\n<!-- TODO -->\n\nsystem_server  ProcessList  `ProcessList.startProcess` \n\n\n\n### 2.1 ProcessList.startProcess(HostingRecord, String, ProcessRecord, int, int[], int, int, String, String, String, String, long)\n\n```java\nprivate Process.ProcessStartResult startProcess(HostingRecord hostingRecord, String entryPoint,\n        ProcessRecord app, int uid, int[] gids, int runtimeFlags, int mountExternal,\n        String seInfo, String requiredAbi, String instructionSet, String invokeWith,\n        long startTime) {\n    try {\n        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"Start proc: \" +\n                app.processName);\n        checkSlow(startTime, \"startProcess: asking zygote to start proc\");\n        final Process.ProcessStartResult startResult;\n        if (hostingRecord.usesWebviewZygote()) {\n            startResult = startWebView(entryPoint,\n                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,\n                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,\n                    app.info.dataDir, null, app.info.packageName,\n                    new String[] {PROC_START_SEQ_IDENT + app.startSeq});\n        } else if (hostingRecord.usesAppZygote()) {\n            final AppZygote appZygote = createAppZygoteForProcessIfNeeded(app);\n\n            startResult = appZygote.getProcess().start(entryPoint,\n                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,\n                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,\n                    app.info.dataDir, null, app.info.packageName,\n                    /*useUsapPool=*/ false,\n                    new String[] {PROC_START_SEQ_IDENT + app.startSeq});\n        } else {\n            // \n            startResult = Process.start(entryPoint,\n                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,\n                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,\n                    app.info.dataDir, invokeWith, app.info.packageName,\n                    new String[] {PROC_START_SEQ_IDENT + app.startSeq});\n        }\n        checkSlow(startTime, \"startProcess: returned from zygote!\");\n        return startResult;\n    } finally {\n        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);\n    }\n}\n```\n\n `Process.start` \n\n\n\n### 2.2 Process.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, String[])\n\n```java\npublic static ProcessStartResult start(@NonNull final String processClass,\n                                       @Nullable final String niceName,\n                                       int uid, int gid, @Nullable int[] gids,\n                                       int runtimeFlags,\n                                       int mountExternal,\n                                       int targetSdkVersion,\n                                       @Nullable String seInfo,\n                                       @NonNull String abi,\n                                       @Nullable String instructionSet,\n                                       @Nullable String appDataDir,\n                                       @Nullable String invokeWith,\n                                       @Nullable String packageName,\n                                       @Nullable String[] zygoteArgs) {\n    return ZYGOTE_PROCESS.start(processClass, niceName, uid, gid, gids,\n                runtimeFlags, mountExternal, targetSdkVersion, seInfo,\n                abi, instructionSet, appDataDir, invokeWith, packageName,\n                /*useUsapPool=*/ true, zygoteArgs);\n}\n```\n\n`ZYGOTE_PROCESS`  ZygoteProcess \n\n```java\n/**\n * State associated with the zygote process.\n * @hide\n */\npublic static final ZygoteProcess ZYGOTE_PROCESS = new ZygoteProcess();\n```\n\n ZygoteProcess \n\n```java\npublic ZygoteProcess() {\n    mZygoteSocketAddress =\n            new LocalSocketAddress(Zygote.PRIMARY_SOCKET_NAME,\n                                   LocalSocketAddress.Namespace.RESERVED);\n    mZygoteSecondarySocketAddress =\n            new LocalSocketAddress(Zygote.SECONDARY_SOCKET_NAME,\n                                   LocalSocketAddress.Namespace.RESERVED);\n\n    mUsapPoolSocketAddress =\n            new LocalSocketAddress(Zygote.USAP_POOL_PRIMARY_SOCKET_NAME,\n                                   LocalSocketAddress.Namespace.RESERVED);\n    mUsapPoolSecondarySocketAddress =\n            new LocalSocketAddress(Zygote.USAP_POOL_SECONDARY_SOCKET_NAME,\n                                   LocalSocketAddress.Namespace.RESERVED);\n}\n```\n\nZygoteProcess  Socket  Zygote \n\n `ZygoteProcess.start` \n\n\n\n### 2.3 ZygoteProcess.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, boolean, String[])\n\n```java\npublic final Process.ProcessStartResult start(@NonNull final String processClass,\n                                              final String niceName,\n                                              int uid, int gid, @Nullable int[] gids,\n                                              int runtimeFlags, int mountExternal,\n                                              int targetSdkVersion,\n                                              @Nullable String seInfo,\n                                              @NonNull String abi,\n                                              @Nullable String instructionSet,\n                                              @Nullable String appDataDir,\n                                              @Nullable String invokeWith,\n                                              @Nullable String packageName,\n                                              boolean useUsapPool,\n                                              @Nullable String[] zygoteArgs) {\n    // UASP ,  2.3.1\n    if (fetchUsapPoolEnabledPropWithMinInterval()) {\n        informZygotesOfUsapPoolStatus();\n    }\n\n    try {\n        return startViaZygote(processClass, niceName, uid, gid, gids,\n                runtimeFlags, mountExternal, targetSdkVersion, seInfo,\n                abi, instructionSet, appDataDir, invokeWith, /*startChildZygote=*/ false,\n                packageName, useUsapPool, zygoteArgs);\n    } catch (ZygoteStartFailedEx ex) {\n        Log.e(LOG_TAG,\n                \"Starting VM process through Zygote failed\");\n        throw new RuntimeException(\n                \"Starting VM process through Zygote failed\", ex);\n    }\n}\n```\n\n UASP  2.3.1 `ZygoteProcess.startViaZygote` \n\n `ZygoteProcess.startViaZygote`  `ZygoteStartFailedEx`  `RuntimeException`\n\n\n\n#### 2.3.1 ZygoteProcess.fetchUsapPoolEnabledPropWithMinInterval()\n\n```java\nprivate boolean fetchUsapPoolEnabledPropWithMinInterval() {\n    final long currentTimestamp = SystemClock.elapsedRealtime();\n\n    if (SystemProperties.get(\"dalvik.vm.boot-image\", \"\").endsWith(\"apex.art\")) {\n        if (currentTimestamp <= 15000) {\n            return false;\n        }\n    }\n\n    if (mIsFirstPropCheck\n            || (currentTimestamp - mLastPropCheckTimestamp >= Zygote.PROPERTY_CHECK_INTERVAL)) {\n        mIsFirstPropCheck = false;\n        mLastPropCheckTimestamp = currentTimestamp;\n      \n      \t//  UsapPool ,  2.3.1.1\n        return fetchUsapPoolEnabledProp();\n    }\n\n    return false;\n}\n```\n\n\n\n##### 2.3.1.1 ZygoteProcess.fetchUsapPoolEnabledProp()\n\n```java\nprivate boolean fetchUsapPoolEnabledProp() {\n    boolean origVal = mUsapPoolEnabled;\n\n    final String propertyString = Zygote.getConfigurationProperty(\n            ZygoteConfig.USAP_POOL_ENABLED, USAP_POOL_ENABLED_DEFAULT);\n\n    if (!propertyString.isEmpty()) {\n        mUsapPoolEnabled = Zygote.getConfigurationPropertyBoolean(\n              ZygoteConfig.USAP_POOL_ENABLED,\n              Boolean.parseBoolean(USAP_POOL_ENABLED_DEFAULT));\n    }\n\n    boolean valueChanged = origVal != mUsapPoolEnabled;\n\n    if (valueChanged) {\n        Log.i(LOG_TAG, \"usapPoolEnabled = \" + mUsapPoolEnabled);\n    }\n\n    return valueChanged;\n}\n```\n\n UsapPool  `USAP_POOL_ENABLED_DEFAULT`  false UsapPool \n\n UASP \n\n\n\n### 2.4 ZygoteProcess.startViaZygote(String, String, int, int, int[], int, int, int, String, String, String, String, String, boolean, String, boolean, String[])\n\n```java\nprivate Process.ProcessStartResult startViaZygote(@NonNull final String processClass,\n                                                  @Nullable final String niceName,\n                                                  final int uid, final int gid,\n                                                  @Nullable final int[] gids,\n                                                  int runtimeFlags, int mountExternal,\n                                                  int targetSdkVersion,\n                                                  @Nullable String seInfo,\n                                                  @NonNull String abi,\n                                                  @Nullable String instructionSet,\n                                                  @Nullable String appDataDir,\n                                                  @Nullable String invokeWith,\n                                                  boolean startChildZygote,\n                                                  @Nullable String packageName,\n                                                  boolean useUsapPool,\n                                                  @Nullable String[] extraArgs)\n                                                  throws ZygoteStartFailedEx {\n    ArrayList<String> argsForZygote = new ArrayList<>();\n\n    // --runtime-args, --setuid=, --setgid=,\n    // and --setgroups= must go first\n    argsForZygote.add(\"--runtime-args\");\n    argsForZygote.add(\"--setuid=\" + uid);\n    argsForZygote.add(\"--setgid=\" + gid);\n    argsForZygote.add(\"--runtime-flags=\" + runtimeFlags);\n\n    ...\n\n    synchronized(mLock) {\n      \t// openZygoteSocketIfNeeded  2.4.1\n        return zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi),\n                                          useUsapPool,\n                                          argsForZygote);\n    }\n}\n```\n\n uid, gid  `argsForZygote` \n\n\n\n#### 2.4.1 ZygoteProcess.openZygoteSocketIfNeeded(String)\n\n```java\n@GuardedBy(\"mLock\")\nprivate ZygoteState openZygoteSocketIfNeeded(String abi) throws ZygoteStartFailedEx {\n    try {\n        attemptConnectionToPrimaryZygote();\n\n        if (primaryZygoteState.matches(abi)) {\n            return primaryZygoteState;\n        }\n\n        if (mZygoteSecondarySocketAddress != null) {\n            // The primary zygote didn't match. Try the secondary.\n            attemptConnectionToSecondaryZygote();\n\n            if (secondaryZygoteState.matches(abi)) {\n                return secondaryZygoteState;\n            }\n        }\n    } catch (IOException ioe) {\n        throw new ZygoteStartFailedEx(\"Error connecting to zygote\", ioe);\n    }\n\n    throw new ZygoteStartFailedEx(\"Unsupported zygote ABI: \" + abi);\n}\n```\n\n Zygote \n\n `@GuardedBy(\"mLock\")`  `mLock` \n\n\n\n### 2.5 ZygoteProcess.zygoteSendArgsAndGetResult(ZygoteState, boolean, ArrayList)\n\n```java\n@GuardedBy(\"mLock\")\nprivate Process.ProcessStartResult zygoteSendArgsAndGetResult(\n        ZygoteState zygoteState, boolean useUsapPool, @NonNull ArrayList<String> args)\n        throws ZygoteStartFailedEx {\n\n    // \n    for (String arg : args) {\n        if (arg.indexOf('\\n') >= 0) {\n            throw new ZygoteStartFailedEx(\"Embedded newlines not allowed\");\n        } else if (arg.indexOf('\\r') >= 0) {\n            throw new ZygoteStartFailedEx(\"Embedded carriage returns not allowed\");\n        }\n    }\n\n    String msgStr = args.size() + \"\\n\" + String.join(\"\\n\", args) + \"\\n\";\n\n  \t...\n\n    return attemptZygoteSendArgsAndGetResult(zygoteState, msgStr);\n}\n```\n\n `ZygoteProcess.attemptZygoteSendArgsAndGetResult` \n\n\n\n### 2.6 ZygoteProcess.attemptZygoteSendArgsAndGetResult(ZygoteState, String)\n\n```java\nprivate Process.ProcessStartResult attemptZygoteSendArgsAndGetResult(\n        ZygoteState zygoteState, String msgStr) throws ZygoteStartFailedEx {\n    try {\n      \t//  Zygote  Socket , \n        final BufferedWriter zygoteWriter = zygoteState.mZygoteOutputWriter;\n        final DataInputStream zygoteInputStream = zygoteState.mZygoteInputStream;\n\n      \t//  Zygote \n        zygoteWriter.write(msgStr);\n        zygoteWriter.flush();\n\n      \t// \n        Process.ProcessStartResult result = new Process.ProcessStartResult();\n        result.pid = zygoteInputStream.readInt();\n        result.usingWrapper = zygoteInputStream.readBoolean();\n\n        if (result.pid < 0) {\n            //  pid  0, \n            throw new ZygoteStartFailedEx(\"fork() failed\");\n        }\n\n        return result;\n    } catch (IOException ex) {\n      \t//  IOException,  Zygote \n        zygoteState.close();\n\n        Log.e(LOG_TAG, \"IO Exception while communicating with Zygote - \"\n                + ex.toString());\n        throw new ZygoteStartFailedEx(ex);\n    }\n  \n    // ,  zygoteState.close(),  Zygote \n}\n```\n\n Zygote  Zygote  Zygote \n\n Zygote  pid < 0 `Process.ProcessStartResult` \n\n\n\n## 3. Zygote \n\n<!-- TODO -->\n\n\n\n### 3.1 Zygote \n\nZygote  init  Zygote  `ZygoteInit.main` \n\n\n\n#### 3.1.1 ZygoteInit.main(String)\n\n```java\npublic static void main(String argv[]) {\n    ZygoteServer zygoteServer = null;\n\n    //  Zygote , \n    ZygoteHooks.startZygoteNoThreadCreation();\n\n    try {\n      \t//  3.1.1.1\n        Os.setpgid(0, 0);\n    } catch (ErrnoException ex) {\n        throw new RuntimeException(\"Failed to setpgid(0,0)\", ex);\n    }\n\n    Runnable caller;\n    try {\n        \n      \t...\n\n      \t//  DDMS\n        RuntimeInit.enableDdms();\n\n      \t// , \n        boolean startSystemServer = false;\n        String zygoteSocketName = \"zygote\";\n        String abiList = null;\n        boolean enableLazyPreload = false;\n        for (int i = 1; i < argv.length; i++) {\n            if (\"start-system-server\".equals(argv[i])) {\n                startSystemServer = true;\n            } else if (\"--enable-lazy-preload\".equals(argv[i])) {\n                enableLazyPreload = true;\n            } else if (argv[i].startsWith(ABI_LIST_ARG)) {\n                abiList = argv[i].substring(ABI_LIST_ARG.length());\n            } else if (argv[i].startsWith(SOCKET_NAME_ARG)) {\n                zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length());\n            } else {\n                throw new RuntimeException(\"Unknown command line argument: \" + argv[i]);\n            }\n        }\n\n      \t// Zygote.PRIMARY_SOCKET_NAME = \"zygote\"\n        final boolean isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME);\n\n        if (abiList == null) {\n            throw new RuntimeException(\"No ABI list supplied.\");\n        }\n\n        if (!enableLazyPreload) {\n            bootTimingsTraceLog.traceBegin(\"ZygotePreload\");\n            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,\n                    SystemClock.uptimeMillis());\n          \n            // \n            preload(bootTimingsTraceLog);\n          \n            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,\n                    SystemClock.uptimeMillis());\n            bootTimingsTraceLog.traceEnd();\n        } else {\n            Zygote.resetNicePriority();\n        }\n\n        bootTimingsTraceLog.traceBegin(\"PostZygoteInitGC\");\n      \t// Zygote ,  GC\n        gcAndFinalize();\n        bootTimingsTraceLog.traceEnd();\n\n        bootTimingsTraceLog.traceEnd(); // ZygoteInit\n        \n      \t// TODO: \n        Trace.setTracingEnabled(false, 0);\n\n\n      \t// TODO: \n        Zygote.initNativeState(isPrimaryZygote);\n\n      \t//  Zygote ,  ZygoteHooks.startZygoteNoThreadCreation() \n        // \n        ZygoteHooks.stopZygoteNoThreadCreation();\n\n      \t// ZygoteServer  3.1.1.2\n        zygoteServer = new ZygoteServer(isPrimaryZygote);\n\n      \t//  system_server \n        if (startSystemServer) {\n            Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer);\n\n          \t//  forkSystemServer  fork \n          \t// ,  zygote ,  Runnable  null\n          \t// ,  system_server ,  null  Runnable\n            if (r != null) {\n              \t//  r.run() ,  return\n              \t// \n                r.run();\n                return;\n            }\n        }\n\n        Log.i(TAG, \"Accepting command socket connections\");\n\n      \t//  3.1.1.3\n        caller = zygoteServer.runSelectLoop(abiList);\n    } catch (Throwable ex) {\n        Log.e(TAG, \"System zygote died with exception\", ex);\n        throw ex;\n    } finally {\n        if (zygoteServer != null) {\n            zygoteServer.closeServerSocket();\n        }\n    }\n\n    if (caller != null) {\n        caller.run();\n    }\n}\n```\n\n Zygote  Socket system_server  `ZygoteServer.runSelectLoop` \n\n\n\n##### 3.1.1.1 Os.setpgid(int, int)\n\n```java\n/**\n * See <a href=\"http://man7.org/linux/man-pages/man2/setpgid.2.html\">setpgid(2)</a>.\n * @hide\n */\n@libcore.api.CorePlatformApi\npublic static void setpgid(int pid, int pgid) throws ErrnoException { Libcore.os.setpgid(pid, pgid); }\n```\n\n `pid`, `pgid`  0\n\n `pid`  0  ID `pgid`  0  PGID  ID \n\n\n\n##### 3.1.1.2 ZygoteServer(boolean)\n\n```java\nZygoteServer(boolean isPrimaryZygote) {\n    mUsapPoolEventFD = Zygote.getUsapPoolEventFD();\n\n    if (isPrimaryZygote) {\n        mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME);\n        mUsapPoolSocket =\n                Zygote.createManagedSocketFromInitSocket(\n                        Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);\n    } else {\n        mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.SECONDARY_SOCKET_NAME);\n        mUsapPoolSocket =\n                Zygote.createManagedSocketFromInitSocket(\n                        Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);\n    }\n\n    fetchUsapPoolPolicyProps();\n\n    mUsapPoolSupported = true;\n}\n```\n\nZygoteServer  Zygote  Socket \n\n\n\n##### 3.1.1.3 ZygoteServer.runSelectLoop(String)\n\n```java\nRunnable runSelectLoop(String abiList) {\n    ArrayList<FileDescriptor> socketFDs = new ArrayList<FileDescriptor>();\n    ArrayList<ZygoteConnection> peers = new ArrayList<ZygoteConnection>();\n\n    socketFDs.add(mZygoteSocket.getFileDescriptor());\n    peers.add(null);\n\n    while (true) {\n        fetchUsapPoolPolicyPropsWithMinInterval();\n\n        int[] usapPipeFDs = null;\n        StructPollfd[] pollFDs = null;\n\n        if (mUsapPoolEnabled) {\n            usapPipeFDs = Zygote.getUsapPipeFDs();\n            pollFDs = new StructPollfd[socketFDs.size() + 1 + usapPipeFDs.length];\n        } else {\n            pollFDs = new StructPollfd[socketFDs.size()];\n        }\n\n        int pollIndex = 0;\n        for (FileDescriptor socketFD : socketFDs) {\n            pollFDs[pollIndex] = new StructPollfd();\n            pollFDs[pollIndex].fd = socketFD;\n            pollFDs[pollIndex].events = (short) POLLIN;\n            ++pollIndex;\n        }\n\n        ...\n\n        try {\n            Os.poll(pollFDs, -1);\n        } catch (ErrnoException ex) {\n            throw new RuntimeException(\"poll failed\", ex);\n        }\n\n        boolean usapPoolFDRead = false;\n\n        while (--pollIndex >= 0) {\n            if ((pollFDs[pollIndex].revents & POLLIN) == 0) {\n                continue;\n            }\n\n            if (pollIndex == 0) {\n                // Zygote server socket\n\n                ZygoteConnection newPeer = acceptCommandPeer(abiList);\n                peers.add(newPeer);\n                socketFDs.add(newPeer.getFileDescriptor());\n\n            } else if (pollIndex < usapPoolEventFDIndex) {\n                // Session socket accepted from the Zygote server socket\n\n                try {\n                    ZygoteConnection connection = peers.get(pollIndex);\n                    final Runnable command = connection.processOneCommand(this);\n\n                    // TODO (chriswailes): Is this extra check necessary?\n                    if (mIsForkChild) {\n                        // We're in the child. We should always have a command to run at this\n                        // stage if processOneCommand hasn't called \"exec\".\n                        if (command == null) {\n                            throw new IllegalStateException(\"command == null\");\n                        }\n\n                        return command;\n                    } else {\n                        // We're in the server - we should never have any commands to run.\n                        if (command != null) {\n                            throw new IllegalStateException(\"command != null\");\n                        }\n\n                        if (connection.isClosedByPeer()) {\n                            connection.closeSocket();\n                            peers.remove(pollIndex);\n                            socketFDs.remove(pollIndex);\n                        }\n                    }\n                } catch (Exception e) {\n                    if (!mIsForkChild) {\n\n                        Slog.e(TAG, \"Exception executing zygote command: \", e);\n\n                        ZygoteConnection conn = peers.remove(pollIndex);\n                        conn.closeSocket();\n\n                        socketFDs.remove(pollIndex);\n                    } else {\n                        Log.e(TAG, \"Caught post-fork exception in child process.\", e);\n                        throw e;\n                    }\n                } finally {\n                    mIsForkChild = false;\n                }\n            } else {\n                long messagePayload = -1;\n\n                try {\n                    byte[] buffer = new byte[Zygote.USAP_MANAGEMENT_MESSAGE_BYTES];\n                    int readBytes = Os.read(pollFDs[pollIndex].fd, buffer, 0, buffer.length);\n\n                    if (readBytes == Zygote.USAP_MANAGEMENT_MESSAGE_BYTES) {\n                        DataInputStream inputStream =\n                                new DataInputStream(new ByteArrayInputStream(buffer));\n\n                        messagePayload = inputStream.readLong();\n                    } else {\n                        Log.e(TAG, \"Incomplete read from USAP management FD of size \"\n                                + readBytes);\n                        continue;\n                    }\n                } catch (Exception ex) {\n                    if (pollIndex == usapPoolEventFDIndex) {\n                        Log.e(TAG, \"Failed to read from USAP pool event FD: \"\n                                + ex.getMessage());\n                    } else {\n                        Log.e(TAG, \"Failed to read from USAP reporting pipe: \"\n                                + ex.getMessage());\n                    }\n\n                    continue;\n                }\n\n                if (pollIndex > usapPoolEventFDIndex) {\n                    Zygote.removeUsapTableEntry((int) messagePayload);\n                }\n\n                usapPoolFDRead = true;\n            }\n        }\n\n        ...\n\n    }\n}\n```\n\n\n\n## \n\n[Android-](http://gityuan.com/2016/02/01/android-booting/)\n\n[Android](http://gityuan.com/2016/03/26/app-process-create/)\n\n[AndroidZygote(api 29)](https://www.jianshu.com/p/47d0121484fc)\n\n","source":"_drafts/exploring-android-app-process-startup-process.md","raw":"---\ntitle:  Android app \ntags:\n- Zygote\ncategories:\n- [Android]\n---\n\n\n\n> : android-security-10.0.0_r56\n\n\n\n## 1. \n\n<!-- more -->\n\n\n\n### 1.1 \n\n<!-- TODO -->\n\n\n\n#### 1.1.1 Android \n\n<!-- TODO -->\n\n\n\n#### 1.1.2 Linux fork\n\n<!-- TODO -->\n\n\n\n## 2. system_server \n\n<!-- TODO -->\n\nsystem_server  ProcessList  `ProcessList.startProcess` \n\n\n\n### 2.1 ProcessList.startProcess(HostingRecord, String, ProcessRecord, int, int[], int, int, String, String, String, String, long)\n\n```java\nprivate Process.ProcessStartResult startProcess(HostingRecord hostingRecord, String entryPoint,\n        ProcessRecord app, int uid, int[] gids, int runtimeFlags, int mountExternal,\n        String seInfo, String requiredAbi, String instructionSet, String invokeWith,\n        long startTime) {\n    try {\n        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"Start proc: \" +\n                app.processName);\n        checkSlow(startTime, \"startProcess: asking zygote to start proc\");\n        final Process.ProcessStartResult startResult;\n        if (hostingRecord.usesWebviewZygote()) {\n            startResult = startWebView(entryPoint,\n                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,\n                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,\n                    app.info.dataDir, null, app.info.packageName,\n                    new String[] {PROC_START_SEQ_IDENT + app.startSeq});\n        } else if (hostingRecord.usesAppZygote()) {\n            final AppZygote appZygote = createAppZygoteForProcessIfNeeded(app);\n\n            startResult = appZygote.getProcess().start(entryPoint,\n                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,\n                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,\n                    app.info.dataDir, null, app.info.packageName,\n                    /*useUsapPool=*/ false,\n                    new String[] {PROC_START_SEQ_IDENT + app.startSeq});\n        } else {\n            // \n            startResult = Process.start(entryPoint,\n                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,\n                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,\n                    app.info.dataDir, invokeWith, app.info.packageName,\n                    new String[] {PROC_START_SEQ_IDENT + app.startSeq});\n        }\n        checkSlow(startTime, \"startProcess: returned from zygote!\");\n        return startResult;\n    } finally {\n        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);\n    }\n}\n```\n\n `Process.start` \n\n\n\n### 2.2 Process.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, String[])\n\n```java\npublic static ProcessStartResult start(@NonNull final String processClass,\n                                       @Nullable final String niceName,\n                                       int uid, int gid, @Nullable int[] gids,\n                                       int runtimeFlags,\n                                       int mountExternal,\n                                       int targetSdkVersion,\n                                       @Nullable String seInfo,\n                                       @NonNull String abi,\n                                       @Nullable String instructionSet,\n                                       @Nullable String appDataDir,\n                                       @Nullable String invokeWith,\n                                       @Nullable String packageName,\n                                       @Nullable String[] zygoteArgs) {\n    return ZYGOTE_PROCESS.start(processClass, niceName, uid, gid, gids,\n                runtimeFlags, mountExternal, targetSdkVersion, seInfo,\n                abi, instructionSet, appDataDir, invokeWith, packageName,\n                /*useUsapPool=*/ true, zygoteArgs);\n}\n```\n\n`ZYGOTE_PROCESS`  ZygoteProcess \n\n```java\n/**\n * State associated with the zygote process.\n * @hide\n */\npublic static final ZygoteProcess ZYGOTE_PROCESS = new ZygoteProcess();\n```\n\n ZygoteProcess \n\n```java\npublic ZygoteProcess() {\n    mZygoteSocketAddress =\n            new LocalSocketAddress(Zygote.PRIMARY_SOCKET_NAME,\n                                   LocalSocketAddress.Namespace.RESERVED);\n    mZygoteSecondarySocketAddress =\n            new LocalSocketAddress(Zygote.SECONDARY_SOCKET_NAME,\n                                   LocalSocketAddress.Namespace.RESERVED);\n\n    mUsapPoolSocketAddress =\n            new LocalSocketAddress(Zygote.USAP_POOL_PRIMARY_SOCKET_NAME,\n                                   LocalSocketAddress.Namespace.RESERVED);\n    mUsapPoolSecondarySocketAddress =\n            new LocalSocketAddress(Zygote.USAP_POOL_SECONDARY_SOCKET_NAME,\n                                   LocalSocketAddress.Namespace.RESERVED);\n}\n```\n\nZygoteProcess  Socket  Zygote \n\n `ZygoteProcess.start` \n\n\n\n### 2.3 ZygoteProcess.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, boolean, String[])\n\n```java\npublic final Process.ProcessStartResult start(@NonNull final String processClass,\n                                              final String niceName,\n                                              int uid, int gid, @Nullable int[] gids,\n                                              int runtimeFlags, int mountExternal,\n                                              int targetSdkVersion,\n                                              @Nullable String seInfo,\n                                              @NonNull String abi,\n                                              @Nullable String instructionSet,\n                                              @Nullable String appDataDir,\n                                              @Nullable String invokeWith,\n                                              @Nullable String packageName,\n                                              boolean useUsapPool,\n                                              @Nullable String[] zygoteArgs) {\n    // UASP ,  2.3.1\n    if (fetchUsapPoolEnabledPropWithMinInterval()) {\n        informZygotesOfUsapPoolStatus();\n    }\n\n    try {\n        return startViaZygote(processClass, niceName, uid, gid, gids,\n                runtimeFlags, mountExternal, targetSdkVersion, seInfo,\n                abi, instructionSet, appDataDir, invokeWith, /*startChildZygote=*/ false,\n                packageName, useUsapPool, zygoteArgs);\n    } catch (ZygoteStartFailedEx ex) {\n        Log.e(LOG_TAG,\n                \"Starting VM process through Zygote failed\");\n        throw new RuntimeException(\n                \"Starting VM process through Zygote failed\", ex);\n    }\n}\n```\n\n UASP  2.3.1 `ZygoteProcess.startViaZygote` \n\n `ZygoteProcess.startViaZygote`  `ZygoteStartFailedEx`  `RuntimeException`\n\n\n\n#### 2.3.1 ZygoteProcess.fetchUsapPoolEnabledPropWithMinInterval()\n\n```java\nprivate boolean fetchUsapPoolEnabledPropWithMinInterval() {\n    final long currentTimestamp = SystemClock.elapsedRealtime();\n\n    if (SystemProperties.get(\"dalvik.vm.boot-image\", \"\").endsWith(\"apex.art\")) {\n        if (currentTimestamp <= 15000) {\n            return false;\n        }\n    }\n\n    if (mIsFirstPropCheck\n            || (currentTimestamp - mLastPropCheckTimestamp >= Zygote.PROPERTY_CHECK_INTERVAL)) {\n        mIsFirstPropCheck = false;\n        mLastPropCheckTimestamp = currentTimestamp;\n      \n      \t//  UsapPool ,  2.3.1.1\n        return fetchUsapPoolEnabledProp();\n    }\n\n    return false;\n}\n```\n\n\n\n##### 2.3.1.1 ZygoteProcess.fetchUsapPoolEnabledProp()\n\n```java\nprivate boolean fetchUsapPoolEnabledProp() {\n    boolean origVal = mUsapPoolEnabled;\n\n    final String propertyString = Zygote.getConfigurationProperty(\n            ZygoteConfig.USAP_POOL_ENABLED, USAP_POOL_ENABLED_DEFAULT);\n\n    if (!propertyString.isEmpty()) {\n        mUsapPoolEnabled = Zygote.getConfigurationPropertyBoolean(\n              ZygoteConfig.USAP_POOL_ENABLED,\n              Boolean.parseBoolean(USAP_POOL_ENABLED_DEFAULT));\n    }\n\n    boolean valueChanged = origVal != mUsapPoolEnabled;\n\n    if (valueChanged) {\n        Log.i(LOG_TAG, \"usapPoolEnabled = \" + mUsapPoolEnabled);\n    }\n\n    return valueChanged;\n}\n```\n\n UsapPool  `USAP_POOL_ENABLED_DEFAULT`  false UsapPool \n\n UASP \n\n\n\n### 2.4 ZygoteProcess.startViaZygote(String, String, int, int, int[], int, int, int, String, String, String, String, String, boolean, String, boolean, String[])\n\n```java\nprivate Process.ProcessStartResult startViaZygote(@NonNull final String processClass,\n                                                  @Nullable final String niceName,\n                                                  final int uid, final int gid,\n                                                  @Nullable final int[] gids,\n                                                  int runtimeFlags, int mountExternal,\n                                                  int targetSdkVersion,\n                                                  @Nullable String seInfo,\n                                                  @NonNull String abi,\n                                                  @Nullable String instructionSet,\n                                                  @Nullable String appDataDir,\n                                                  @Nullable String invokeWith,\n                                                  boolean startChildZygote,\n                                                  @Nullable String packageName,\n                                                  boolean useUsapPool,\n                                                  @Nullable String[] extraArgs)\n                                                  throws ZygoteStartFailedEx {\n    ArrayList<String> argsForZygote = new ArrayList<>();\n\n    // --runtime-args, --setuid=, --setgid=,\n    // and --setgroups= must go first\n    argsForZygote.add(\"--runtime-args\");\n    argsForZygote.add(\"--setuid=\" + uid);\n    argsForZygote.add(\"--setgid=\" + gid);\n    argsForZygote.add(\"--runtime-flags=\" + runtimeFlags);\n\n    ...\n\n    synchronized(mLock) {\n      \t// openZygoteSocketIfNeeded  2.4.1\n        return zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi),\n                                          useUsapPool,\n                                          argsForZygote);\n    }\n}\n```\n\n uid, gid  `argsForZygote` \n\n\n\n#### 2.4.1 ZygoteProcess.openZygoteSocketIfNeeded(String)\n\n```java\n@GuardedBy(\"mLock\")\nprivate ZygoteState openZygoteSocketIfNeeded(String abi) throws ZygoteStartFailedEx {\n    try {\n        attemptConnectionToPrimaryZygote();\n\n        if (primaryZygoteState.matches(abi)) {\n            return primaryZygoteState;\n        }\n\n        if (mZygoteSecondarySocketAddress != null) {\n            // The primary zygote didn't match. Try the secondary.\n            attemptConnectionToSecondaryZygote();\n\n            if (secondaryZygoteState.matches(abi)) {\n                return secondaryZygoteState;\n            }\n        }\n    } catch (IOException ioe) {\n        throw new ZygoteStartFailedEx(\"Error connecting to zygote\", ioe);\n    }\n\n    throw new ZygoteStartFailedEx(\"Unsupported zygote ABI: \" + abi);\n}\n```\n\n Zygote \n\n `@GuardedBy(\"mLock\")`  `mLock` \n\n\n\n### 2.5 ZygoteProcess.zygoteSendArgsAndGetResult(ZygoteState, boolean, ArrayList)\n\n```java\n@GuardedBy(\"mLock\")\nprivate Process.ProcessStartResult zygoteSendArgsAndGetResult(\n        ZygoteState zygoteState, boolean useUsapPool, @NonNull ArrayList<String> args)\n        throws ZygoteStartFailedEx {\n\n    // \n    for (String arg : args) {\n        if (arg.indexOf('\\n') >= 0) {\n            throw new ZygoteStartFailedEx(\"Embedded newlines not allowed\");\n        } else if (arg.indexOf('\\r') >= 0) {\n            throw new ZygoteStartFailedEx(\"Embedded carriage returns not allowed\");\n        }\n    }\n\n    String msgStr = args.size() + \"\\n\" + String.join(\"\\n\", args) + \"\\n\";\n\n  \t...\n\n    return attemptZygoteSendArgsAndGetResult(zygoteState, msgStr);\n}\n```\n\n `ZygoteProcess.attemptZygoteSendArgsAndGetResult` \n\n\n\n### 2.6 ZygoteProcess.attemptZygoteSendArgsAndGetResult(ZygoteState, String)\n\n```java\nprivate Process.ProcessStartResult attemptZygoteSendArgsAndGetResult(\n        ZygoteState zygoteState, String msgStr) throws ZygoteStartFailedEx {\n    try {\n      \t//  Zygote  Socket , \n        final BufferedWriter zygoteWriter = zygoteState.mZygoteOutputWriter;\n        final DataInputStream zygoteInputStream = zygoteState.mZygoteInputStream;\n\n      \t//  Zygote \n        zygoteWriter.write(msgStr);\n        zygoteWriter.flush();\n\n      \t// \n        Process.ProcessStartResult result = new Process.ProcessStartResult();\n        result.pid = zygoteInputStream.readInt();\n        result.usingWrapper = zygoteInputStream.readBoolean();\n\n        if (result.pid < 0) {\n            //  pid  0, \n            throw new ZygoteStartFailedEx(\"fork() failed\");\n        }\n\n        return result;\n    } catch (IOException ex) {\n      \t//  IOException,  Zygote \n        zygoteState.close();\n\n        Log.e(LOG_TAG, \"IO Exception while communicating with Zygote - \"\n                + ex.toString());\n        throw new ZygoteStartFailedEx(ex);\n    }\n  \n    // ,  zygoteState.close(),  Zygote \n}\n```\n\n Zygote  Zygote  Zygote \n\n Zygote  pid < 0 `Process.ProcessStartResult` \n\n\n\n## 3. Zygote \n\n<!-- TODO -->\n\n\n\n### 3.1 Zygote \n\nZygote  init  Zygote  `ZygoteInit.main` \n\n\n\n#### 3.1.1 ZygoteInit.main(String)\n\n```java\npublic static void main(String argv[]) {\n    ZygoteServer zygoteServer = null;\n\n    //  Zygote , \n    ZygoteHooks.startZygoteNoThreadCreation();\n\n    try {\n      \t//  3.1.1.1\n        Os.setpgid(0, 0);\n    } catch (ErrnoException ex) {\n        throw new RuntimeException(\"Failed to setpgid(0,0)\", ex);\n    }\n\n    Runnable caller;\n    try {\n        \n      \t...\n\n      \t//  DDMS\n        RuntimeInit.enableDdms();\n\n      \t// , \n        boolean startSystemServer = false;\n        String zygoteSocketName = \"zygote\";\n        String abiList = null;\n        boolean enableLazyPreload = false;\n        for (int i = 1; i < argv.length; i++) {\n            if (\"start-system-server\".equals(argv[i])) {\n                startSystemServer = true;\n            } else if (\"--enable-lazy-preload\".equals(argv[i])) {\n                enableLazyPreload = true;\n            } else if (argv[i].startsWith(ABI_LIST_ARG)) {\n                abiList = argv[i].substring(ABI_LIST_ARG.length());\n            } else if (argv[i].startsWith(SOCKET_NAME_ARG)) {\n                zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length());\n            } else {\n                throw new RuntimeException(\"Unknown command line argument: \" + argv[i]);\n            }\n        }\n\n      \t// Zygote.PRIMARY_SOCKET_NAME = \"zygote\"\n        final boolean isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME);\n\n        if (abiList == null) {\n            throw new RuntimeException(\"No ABI list supplied.\");\n        }\n\n        if (!enableLazyPreload) {\n            bootTimingsTraceLog.traceBegin(\"ZygotePreload\");\n            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,\n                    SystemClock.uptimeMillis());\n          \n            // \n            preload(bootTimingsTraceLog);\n          \n            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,\n                    SystemClock.uptimeMillis());\n            bootTimingsTraceLog.traceEnd();\n        } else {\n            Zygote.resetNicePriority();\n        }\n\n        bootTimingsTraceLog.traceBegin(\"PostZygoteInitGC\");\n      \t// Zygote ,  GC\n        gcAndFinalize();\n        bootTimingsTraceLog.traceEnd();\n\n        bootTimingsTraceLog.traceEnd(); // ZygoteInit\n        \n      \t// TODO: \n        Trace.setTracingEnabled(false, 0);\n\n\n      \t// TODO: \n        Zygote.initNativeState(isPrimaryZygote);\n\n      \t//  Zygote ,  ZygoteHooks.startZygoteNoThreadCreation() \n        // \n        ZygoteHooks.stopZygoteNoThreadCreation();\n\n      \t// ZygoteServer  3.1.1.2\n        zygoteServer = new ZygoteServer(isPrimaryZygote);\n\n      \t//  system_server \n        if (startSystemServer) {\n            Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer);\n\n          \t//  forkSystemServer  fork \n          \t// ,  zygote ,  Runnable  null\n          \t// ,  system_server ,  null  Runnable\n            if (r != null) {\n              \t//  r.run() ,  return\n              \t// \n                r.run();\n                return;\n            }\n        }\n\n        Log.i(TAG, \"Accepting command socket connections\");\n\n      \t//  3.1.1.3\n        caller = zygoteServer.runSelectLoop(abiList);\n    } catch (Throwable ex) {\n        Log.e(TAG, \"System zygote died with exception\", ex);\n        throw ex;\n    } finally {\n        if (zygoteServer != null) {\n            zygoteServer.closeServerSocket();\n        }\n    }\n\n    if (caller != null) {\n        caller.run();\n    }\n}\n```\n\n Zygote  Socket system_server  `ZygoteServer.runSelectLoop` \n\n\n\n##### 3.1.1.1 Os.setpgid(int, int)\n\n```java\n/**\n * See <a href=\"http://man7.org/linux/man-pages/man2/setpgid.2.html\">setpgid(2)</a>.\n * @hide\n */\n@libcore.api.CorePlatformApi\npublic static void setpgid(int pid, int pgid) throws ErrnoException { Libcore.os.setpgid(pid, pgid); }\n```\n\n `pid`, `pgid`  0\n\n `pid`  0  ID `pgid`  0  PGID  ID \n\n\n\n##### 3.1.1.2 ZygoteServer(boolean)\n\n```java\nZygoteServer(boolean isPrimaryZygote) {\n    mUsapPoolEventFD = Zygote.getUsapPoolEventFD();\n\n    if (isPrimaryZygote) {\n        mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME);\n        mUsapPoolSocket =\n                Zygote.createManagedSocketFromInitSocket(\n                        Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);\n    } else {\n        mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.SECONDARY_SOCKET_NAME);\n        mUsapPoolSocket =\n                Zygote.createManagedSocketFromInitSocket(\n                        Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);\n    }\n\n    fetchUsapPoolPolicyProps();\n\n    mUsapPoolSupported = true;\n}\n```\n\nZygoteServer  Zygote  Socket \n\n\n\n##### 3.1.1.3 ZygoteServer.runSelectLoop(String)\n\n```java\nRunnable runSelectLoop(String abiList) {\n    ArrayList<FileDescriptor> socketFDs = new ArrayList<FileDescriptor>();\n    ArrayList<ZygoteConnection> peers = new ArrayList<ZygoteConnection>();\n\n    socketFDs.add(mZygoteSocket.getFileDescriptor());\n    peers.add(null);\n\n    while (true) {\n        fetchUsapPoolPolicyPropsWithMinInterval();\n\n        int[] usapPipeFDs = null;\n        StructPollfd[] pollFDs = null;\n\n        if (mUsapPoolEnabled) {\n            usapPipeFDs = Zygote.getUsapPipeFDs();\n            pollFDs = new StructPollfd[socketFDs.size() + 1 + usapPipeFDs.length];\n        } else {\n            pollFDs = new StructPollfd[socketFDs.size()];\n        }\n\n        int pollIndex = 0;\n        for (FileDescriptor socketFD : socketFDs) {\n            pollFDs[pollIndex] = new StructPollfd();\n            pollFDs[pollIndex].fd = socketFD;\n            pollFDs[pollIndex].events = (short) POLLIN;\n            ++pollIndex;\n        }\n\n        ...\n\n        try {\n            Os.poll(pollFDs, -1);\n        } catch (ErrnoException ex) {\n            throw new RuntimeException(\"poll failed\", ex);\n        }\n\n        boolean usapPoolFDRead = false;\n\n        while (--pollIndex >= 0) {\n            if ((pollFDs[pollIndex].revents & POLLIN) == 0) {\n                continue;\n            }\n\n            if (pollIndex == 0) {\n                // Zygote server socket\n\n                ZygoteConnection newPeer = acceptCommandPeer(abiList);\n                peers.add(newPeer);\n                socketFDs.add(newPeer.getFileDescriptor());\n\n            } else if (pollIndex < usapPoolEventFDIndex) {\n                // Session socket accepted from the Zygote server socket\n\n                try {\n                    ZygoteConnection connection = peers.get(pollIndex);\n                    final Runnable command = connection.processOneCommand(this);\n\n                    // TODO (chriswailes): Is this extra check necessary?\n                    if (mIsForkChild) {\n                        // We're in the child. We should always have a command to run at this\n                        // stage if processOneCommand hasn't called \"exec\".\n                        if (command == null) {\n                            throw new IllegalStateException(\"command == null\");\n                        }\n\n                        return command;\n                    } else {\n                        // We're in the server - we should never have any commands to run.\n                        if (command != null) {\n                            throw new IllegalStateException(\"command != null\");\n                        }\n\n                        if (connection.isClosedByPeer()) {\n                            connection.closeSocket();\n                            peers.remove(pollIndex);\n                            socketFDs.remove(pollIndex);\n                        }\n                    }\n                } catch (Exception e) {\n                    if (!mIsForkChild) {\n\n                        Slog.e(TAG, \"Exception executing zygote command: \", e);\n\n                        ZygoteConnection conn = peers.remove(pollIndex);\n                        conn.closeSocket();\n\n                        socketFDs.remove(pollIndex);\n                    } else {\n                        Log.e(TAG, \"Caught post-fork exception in child process.\", e);\n                        throw e;\n                    }\n                } finally {\n                    mIsForkChild = false;\n                }\n            } else {\n                long messagePayload = -1;\n\n                try {\n                    byte[] buffer = new byte[Zygote.USAP_MANAGEMENT_MESSAGE_BYTES];\n                    int readBytes = Os.read(pollFDs[pollIndex].fd, buffer, 0, buffer.length);\n\n                    if (readBytes == Zygote.USAP_MANAGEMENT_MESSAGE_BYTES) {\n                        DataInputStream inputStream =\n                                new DataInputStream(new ByteArrayInputStream(buffer));\n\n                        messagePayload = inputStream.readLong();\n                    } else {\n                        Log.e(TAG, \"Incomplete read from USAP management FD of size \"\n                                + readBytes);\n                        continue;\n                    }\n                } catch (Exception ex) {\n                    if (pollIndex == usapPoolEventFDIndex) {\n                        Log.e(TAG, \"Failed to read from USAP pool event FD: \"\n                                + ex.getMessage());\n                    } else {\n                        Log.e(TAG, \"Failed to read from USAP reporting pipe: \"\n                                + ex.getMessage());\n                    }\n\n                    continue;\n                }\n\n                if (pollIndex > usapPoolEventFDIndex) {\n                    Zygote.removeUsapTableEntry((int) messagePayload);\n                }\n\n                usapPoolFDRead = true;\n            }\n        }\n\n        ...\n\n    }\n}\n```\n\n\n\n## \n\n[Android-](http://gityuan.com/2016/02/01/android-booting/)\n\n[Android](http://gityuan.com/2016/03/26/app-process-create/)\n\n[AndroidZygote(api 29)](https://www.jianshu.com/p/47d0121484fc)\n\n","slug":"exploring-android-app-process-startup-process","published":0,"date":"2021-08-06T03:14:54.945Z","updated":"2021-08-19T03:05:58.376Z","_id":"cksh4x6tu000lqkprd6fo4ta8","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>: android-security-10.0.0_r56</p>\n</blockquote>\n<h2 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h2><a id=\"more\"></a>\n\n\n\n<h3 id=\"1-1-\"><a href=\"#1-1-\" class=\"headerlink\" title=\"1.1 \"></a>1.1 </h3><!-- TODO -->\n\n\n\n<h4 id=\"1-1-1-Android-\"><a href=\"#1-1-1-Android-\" class=\"headerlink\" title=\"1.1.1 Android \"></a>1.1.1 Android </h4><!-- TODO -->\n\n\n\n<h4 id=\"1-1-2-Linux-fork\"><a href=\"#1-1-2-Linux-fork\" class=\"headerlink\" title=\"1.1.2 Linux fork\"></a>1.1.2 Linux fork</h4><!-- TODO -->\n\n\n\n<h2 id=\"2-system-server-\"><a href=\"#2-system-server-\" class=\"headerlink\" title=\"2. system_server \"></a>2. system_server </h2><!-- TODO -->\n\n<p>system_server  ProcessList  <code>ProcessList.startProcess</code> </p>\n<h3 id=\"2-1-ProcessList-startProcess-HostingRecord-String-ProcessRecord-int-int-int-int-String-String-String-String-long\"><a href=\"#2-1-ProcessList-startProcess-HostingRecord-String-ProcessRecord-int-int-int-int-String-String-String-String-long\" class=\"headerlink\" title=\"2.1 ProcessList.startProcess(HostingRecord, String, ProcessRecord, int, int[], int, int, String, String, String, String, long)\"></a>2.1 ProcessList.startProcess(HostingRecord, String, ProcessRecord, int, int[], int, int, String, String, String, String, long)</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> Process.<span class=\"function\">ProcessStartResult <span class=\"title\">startProcess</span><span class=\"params\">(HostingRecord hostingRecord, String entryPoint,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ProcessRecord app, <span class=\"keyword\">int</span> uid, <span class=\"keyword\">int</span>[] gids, <span class=\"keyword\">int</span> runtimeFlags, <span class=\"keyword\">int</span> mountExternal,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        String seInfo, String requiredAbi, String instructionSet, String invokeWith,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">long</span> startTime)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class=\"string\">&quot;Start proc: &quot;</span> +</span><br><span class=\"line\">                app.processName);</span><br><span class=\"line\">        checkSlow(startTime, <span class=\"string\">&quot;startProcess: asking zygote to start proc&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Process.ProcessStartResult startResult;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hostingRecord.usesWebviewZygote()) &#123;</span><br><span class=\"line\">            startResult = startWebView(entryPoint,</span><br><span class=\"line\">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class=\"line\">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class=\"line\">                    app.info.dataDir, <span class=\"keyword\">null</span>, app.info.packageName,</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (hostingRecord.usesAppZygote()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> AppZygote appZygote = createAppZygoteForProcessIfNeeded(app);</span><br><span class=\"line\"></span><br><span class=\"line\">            startResult = appZygote.getProcess().start(entryPoint,</span><br><span class=\"line\">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class=\"line\">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class=\"line\">                    app.info.dataDir, <span class=\"keyword\">null</span>, app.info.packageName,</span><br><span class=\"line\">                    <span class=\"comment\">/*useUsapPool=*/</span> <span class=\"keyword\">false</span>,</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            startResult = Process.start(entryPoint,</span><br><span class=\"line\">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class=\"line\">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class=\"line\">                    app.info.dataDir, invokeWith, app.info.packageName,</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        checkSlow(startTime, <span class=\"string\">&quot;startProcess: returned from zygote!&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> startResult;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>Process.start</code> </p>\n<h3 id=\"2-2-Process-start-String-String-int-int-int-int-int-int-String-String-String-String-String-String-String\"><a href=\"#2-2-Process-start-String-String-int-int-int-int-int-int-String-String-String-String-String-String-String\" class=\"headerlink\" title=\"2.2 Process.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, String[])\"></a>2.2 Process.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, String[])</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ProcessStartResult <span class=\"title\">start</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> <span class=\"keyword\">final</span> String processClass,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> <span class=\"keyword\">final</span> String niceName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"keyword\">int</span> uid, <span class=\"keyword\">int</span> gid, <span class=\"meta\">@Nullable</span> <span class=\"keyword\">int</span>[] gids,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"keyword\">int</span> runtimeFlags,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"keyword\">int</span> mountExternal,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"keyword\">int</span> targetSdkVersion,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String seInfo,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@NonNull</span> String abi,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String instructionSet,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String appDataDir,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String invokeWith,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String packageName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String[] zygoteArgs)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ZYGOTE_PROCESS.start(processClass, niceName, uid, gid, gids,</span><br><span class=\"line\">                runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class=\"line\">                abi, instructionSet, appDataDir, invokeWith, packageName,</span><br><span class=\"line\">                <span class=\"comment\">/*useUsapPool=*/</span> <span class=\"keyword\">true</span>, zygoteArgs);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>ZYGOTE_PROCESS</code>  ZygoteProcess </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * State associated with the zygote process.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@hide</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> ZygoteProcess ZYGOTE_PROCESS = <span class=\"keyword\">new</span> ZygoteProcess();</span><br></pre></td></tr></table></figure>\n<p> ZygoteProcess </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ZygoteProcess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    mZygoteSocketAddress =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalSocketAddress(Zygote.PRIMARY_SOCKET_NAME,</span><br><span class=\"line\">                                   LocalSocketAddress.Namespace.RESERVED);</span><br><span class=\"line\">    mZygoteSecondarySocketAddress =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalSocketAddress(Zygote.SECONDARY_SOCKET_NAME,</span><br><span class=\"line\">                                   LocalSocketAddress.Namespace.RESERVED);</span><br><span class=\"line\"></span><br><span class=\"line\">    mUsapPoolSocketAddress =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalSocketAddress(Zygote.USAP_POOL_PRIMARY_SOCKET_NAME,</span><br><span class=\"line\">                                   LocalSocketAddress.Namespace.RESERVED);</span><br><span class=\"line\">    mUsapPoolSecondarySocketAddress =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalSocketAddress(Zygote.USAP_POOL_SECONDARY_SOCKET_NAME,</span><br><span class=\"line\">                                   LocalSocketAddress.Namespace.RESERVED);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ZygoteProcess  Socket  Zygote </p>\n<p> <code>ZygoteProcess.start</code> </p>\n<h3 id=\"2-3-ZygoteProcess-start-String-String-int-int-int-int-int-int-String-String-String-String-String-String-boolean-String\"><a href=\"#2-3-ZygoteProcess-start-String-String-int-int-int-int-int-int-String-String-String-String-String-String-boolean-String\" class=\"headerlink\" title=\"2.3 ZygoteProcess.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, boolean, String[])\"></a>2.3 ZygoteProcess.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, boolean, String[])</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Process.<span class=\"function\">ProcessStartResult <span class=\"title\">start</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> <span class=\"keyword\">final</span> String processClass,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"keyword\">final</span> String niceName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"keyword\">int</span> uid, <span class=\"keyword\">int</span> gid, <span class=\"meta\">@Nullable</span> <span class=\"keyword\">int</span>[] gids,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"keyword\">int</span> runtimeFlags, <span class=\"keyword\">int</span> mountExternal,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"keyword\">int</span> targetSdkVersion,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String seInfo,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@NonNull</span> String abi,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String instructionSet,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String appDataDir,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String invokeWith,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String packageName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"keyword\">boolean</span> useUsapPool,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String[] zygoteArgs)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// UASP ,  2.3.1</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fetchUsapPoolEnabledPropWithMinInterval()) &#123;</span><br><span class=\"line\">        informZygotesOfUsapPoolStatus();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</span><br><span class=\"line\">                runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class=\"line\">                abi, instructionSet, appDataDir, invokeWith, <span class=\"comment\">/*startChildZygote=*/</span> <span class=\"keyword\">false</span>,</span><br><span class=\"line\">                packageName, useUsapPool, zygoteArgs);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ZygoteStartFailedEx ex) &#123;</span><br><span class=\"line\">        Log.e(LOG_TAG,</span><br><span class=\"line\">                <span class=\"string\">&quot;Starting VM process through Zygote failed&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(</span><br><span class=\"line\">                <span class=\"string\">&quot;Starting VM process through Zygote failed&quot;</span>, ex);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> UASP  2.3.1 <code>ZygoteProcess.startViaZygote</code> </p>\n<p> <code>ZygoteProcess.startViaZygote</code>  <code>ZygoteStartFailedEx</code>  <code>RuntimeException</code></p>\n<h4 id=\"2-3-1-ZygoteProcess-fetchUsapPoolEnabledPropWithMinInterval\"><a href=\"#2-3-1-ZygoteProcess-fetchUsapPoolEnabledPropWithMinInterval\" class=\"headerlink\" title=\"2.3.1 ZygoteProcess.fetchUsapPoolEnabledPropWithMinInterval()\"></a>2.3.1 ZygoteProcess.fetchUsapPoolEnabledPropWithMinInterval()</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">fetchUsapPoolEnabledPropWithMinInterval</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentTimestamp = SystemClock.elapsedRealtime();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (SystemProperties.get(<span class=\"string\">&quot;dalvik.vm.boot-image&quot;</span>, <span class=\"string\">&quot;&quot;</span>).endsWith(<span class=\"string\">&quot;apex.art&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (currentTimestamp &lt;= <span class=\"number\">15000</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mIsFirstPropCheck</span><br><span class=\"line\">            || (currentTimestamp - mLastPropCheckTimestamp &gt;= Zygote.PROPERTY_CHECK_INTERVAL)) &#123;</span><br><span class=\"line\">        mIsFirstPropCheck = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        mLastPropCheckTimestamp = currentTimestamp;</span><br><span class=\"line\">      </span><br><span class=\"line\">      \t<span class=\"comment\">//  UsapPool ,  2.3.1.1</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> fetchUsapPoolEnabledProp();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h5 id=\"2-3-1-1-ZygoteProcess-fetchUsapPoolEnabledProp\"><a href=\"#2-3-1-1-ZygoteProcess-fetchUsapPoolEnabledProp\" class=\"headerlink\" title=\"2.3.1.1 ZygoteProcess.fetchUsapPoolEnabledProp()\"></a>2.3.1.1 ZygoteProcess.fetchUsapPoolEnabledProp()</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">fetchUsapPoolEnabledProp</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> origVal = mUsapPoolEnabled;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> String propertyString = Zygote.getConfigurationProperty(</span><br><span class=\"line\">            ZygoteConfig.USAP_POOL_ENABLED, USAP_POOL_ENABLED_DEFAULT);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!propertyString.isEmpty()) &#123;</span><br><span class=\"line\">        mUsapPoolEnabled = Zygote.getConfigurationPropertyBoolean(</span><br><span class=\"line\">              ZygoteConfig.USAP_POOL_ENABLED,</span><br><span class=\"line\">              Boolean.parseBoolean(USAP_POOL_ENABLED_DEFAULT));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> valueChanged = origVal != mUsapPoolEnabled;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (valueChanged) &#123;</span><br><span class=\"line\">        Log.i(LOG_TAG, <span class=\"string\">&quot;usapPoolEnabled = &quot;</span> + mUsapPoolEnabled);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> valueChanged;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> UsapPool  <code>USAP_POOL_ENABLED_DEFAULT</code>  false UsapPool </p>\n<p> UASP </p>\n<h3 id=\"2-4-ZygoteProcess-startViaZygote-String-String-int-int-int-int-int-int-String-String-String-String-String-boolean-String-boolean-String\"><a href=\"#2-4-ZygoteProcess-startViaZygote-String-String-int-int-int-int-int-int-String-String-String-String-String-boolean-String-boolean-String\" class=\"headerlink\" title=\"2.4 ZygoteProcess.startViaZygote(String, String, int, int, int[], int, int, int, String, String, String, String, String, boolean, String, boolean, String[])\"></a>2.4 ZygoteProcess.startViaZygote(String, String, int, int, int[], int, int, int, String, String, String, String, String, boolean, String, boolean, String[])</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> Process.<span class=\"function\">ProcessStartResult <span class=\"title\">startViaZygote</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> <span class=\"keyword\">final</span> String processClass,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> <span class=\"keyword\">final</span> String niceName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> uid, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> gid,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span>[] gids,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"keyword\">int</span> runtimeFlags, <span class=\"keyword\">int</span> mountExternal,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"keyword\">int</span> targetSdkVersion,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String seInfo,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@NonNull</span> String abi,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String instructionSet,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String appDataDir,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String invokeWith,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"keyword\">boolean</span> startChildZygote,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String packageName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"keyword\">boolean</span> useUsapPool,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String[] extraArgs)</span></span></span><br><span class=\"line\"><span class=\"function\">                                                  <span class=\"keyword\">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class=\"line\">    ArrayList&lt;String&gt; argsForZygote = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// --runtime-args, --setuid=, --setgid=,</span></span><br><span class=\"line\">    <span class=\"comment\">// and --setgroups= must go first</span></span><br><span class=\"line\">    argsForZygote.add(<span class=\"string\">&quot;--runtime-args&quot;</span>);</span><br><span class=\"line\">    argsForZygote.add(<span class=\"string\">&quot;--setuid=&quot;</span> + uid);</span><br><span class=\"line\">    argsForZygote.add(<span class=\"string\">&quot;--setgid=&quot;</span> + gid);</span><br><span class=\"line\">    argsForZygote.add(<span class=\"string\">&quot;--runtime-flags=&quot;</span> + runtimeFlags);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span>(mLock) &#123;</span><br><span class=\"line\">      \t<span class=\"comment\">// openZygoteSocketIfNeeded  2.4.1</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi),</span><br><span class=\"line\">                                          useUsapPool,</span><br><span class=\"line\">                                          argsForZygote);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> uid, gid  <code>argsForZygote</code> </p>\n<h4 id=\"2-4-1-ZygoteProcess-openZygoteSocketIfNeeded-String\"><a href=\"#2-4-1-ZygoteProcess-openZygoteSocketIfNeeded-String\" class=\"headerlink\" title=\"2.4.1 ZygoteProcess.openZygoteSocketIfNeeded(String)\"></a>2.4.1 ZygoteProcess.openZygoteSocketIfNeeded(String)</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@GuardedBy(&quot;mLock&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> ZygoteState <span class=\"title\">openZygoteSocketIfNeeded</span><span class=\"params\">(String abi)</span> <span class=\"keyword\">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        attemptConnectionToPrimaryZygote();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (primaryZygoteState.matches(abi)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> primaryZygoteState;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mZygoteSecondarySocketAddress != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// The primary zygote didn&#x27;t match. Try the secondary.</span></span><br><span class=\"line\">            attemptConnectionToSecondaryZygote();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (secondaryZygoteState.matches(abi)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> secondaryZygoteState;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException ioe) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(<span class=\"string\">&quot;Error connecting to zygote&quot;</span>, ioe);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(<span class=\"string\">&quot;Unsupported zygote ABI: &quot;</span> + abi);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Zygote </p>\n<p> <code>@GuardedBy(&quot;mLock&quot;)</code>  <code>mLock</code> </p>\n<h3 id=\"2-5-ZygoteProcess-zygoteSendArgsAndGetResult-ZygoteState-boolean-ArrayList\"><a href=\"#2-5-ZygoteProcess-zygoteSendArgsAndGetResult-ZygoteState-boolean-ArrayList\" class=\"headerlink\" title=\"2.5 ZygoteProcess.zygoteSendArgsAndGetResult(ZygoteState, boolean, ArrayList)\"></a>2.5 ZygoteProcess.zygoteSendArgsAndGetResult(ZygoteState, boolean, ArrayList)</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@GuardedBy(&quot;mLock&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Process.<span class=\"function\">ProcessStartResult <span class=\"title\">zygoteSendArgsAndGetResult</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ZygoteState zygoteState, <span class=\"keyword\">boolean</span> useUsapPool, <span class=\"meta\">@NonNull</span> ArrayList&lt;String&gt; args)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (String arg : args) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (arg.indexOf(<span class=\"string\">&#x27;\\n&#x27;</span>) &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(<span class=\"string\">&quot;Embedded newlines not allowed&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (arg.indexOf(<span class=\"string\">&#x27;\\r&#x27;</span>) &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(<span class=\"string\">&quot;Embedded carriage returns not allowed&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    String msgStr = args.size() + <span class=\"string\">&quot;\\n&quot;</span> + String.join(<span class=\"string\">&quot;\\n&quot;</span>, args) + <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  \t...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> attemptZygoteSendArgsAndGetResult(zygoteState, msgStr);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>ZygoteProcess.attemptZygoteSendArgsAndGetResult</code> </p>\n<h3 id=\"2-6-ZygoteProcess-attemptZygoteSendArgsAndGetResult-ZygoteState-String\"><a href=\"#2-6-ZygoteProcess-attemptZygoteSendArgsAndGetResult-ZygoteState-String\" class=\"headerlink\" title=\"2.6 ZygoteProcess.attemptZygoteSendArgsAndGetResult(ZygoteState, String)\"></a>2.6 ZygoteProcess.attemptZygoteSendArgsAndGetResult(ZygoteState, String)</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> Process.<span class=\"function\">ProcessStartResult <span class=\"title\">attemptZygoteSendArgsAndGetResult</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ZygoteState zygoteState, String msgStr)</span> <span class=\"keyword\">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      \t<span class=\"comment\">//  Zygote  Socket , </span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> BufferedWriter zygoteWriter = zygoteState.mZygoteOutputWriter;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> DataInputStream zygoteInputStream = zygoteState.mZygoteInputStream;</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">//  Zygote </span></span><br><span class=\"line\">        zygoteWriter.write(msgStr);</span><br><span class=\"line\">        zygoteWriter.flush();</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// </span></span><br><span class=\"line\">        Process.ProcessStartResult result = <span class=\"keyword\">new</span> Process.ProcessStartResult();</span><br><span class=\"line\">        result.pid = zygoteInputStream.readInt();</span><br><span class=\"line\">        result.usingWrapper = zygoteInputStream.readBoolean();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result.pid &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//  pid  0, </span></span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(<span class=\"string\">&quot;fork() failed&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException ex) &#123;</span><br><span class=\"line\">      \t<span class=\"comment\">//  IOException,  Zygote </span></span><br><span class=\"line\">        zygoteState.close();</span><br><span class=\"line\"></span><br><span class=\"line\">        Log.e(LOG_TAG, <span class=\"string\">&quot;IO Exception while communicating with Zygote - &quot;</span></span><br><span class=\"line\">                + ex.toString());</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(ex);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">// ,  zygoteState.close(),  Zygote </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Zygote  Zygote  Zygote </p>\n<p> Zygote  pid &lt; 0 <code>Process.ProcessStartResult</code> </p>\n<h2 id=\"3-Zygote-\"><a href=\"#3-Zygote-\" class=\"headerlink\" title=\"3. Zygote \"></a>3. Zygote </h2><!-- TODO -->\n\n\n\n<h3 id=\"3-1-Zygote-\"><a href=\"#3-1-Zygote-\" class=\"headerlink\" title=\"3.1 Zygote \"></a>3.1 Zygote </h3><p>Zygote  init  Zygote  <code>ZygoteInit.main</code> </p>\n<h4 id=\"3-1-1-ZygoteInit-main-String\"><a href=\"#3-1-1-ZygoteInit-main-String\" class=\"headerlink\" title=\"3.1.1 ZygoteInit.main(String)\"></a>3.1.1 ZygoteInit.main(String)</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String argv[])</span> </span>&#123;</span><br><span class=\"line\">    ZygoteServer zygoteServer = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Zygote , </span></span><br><span class=\"line\">    ZygoteHooks.startZygoteNoThreadCreation();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      \t<span class=\"comment\">//  3.1.1.1</span></span><br><span class=\"line\">        Os.setpgid(<span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ErrnoException ex) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;Failed to setpgid(0,0)&quot;</span>, ex);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Runnable caller;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">      \t...</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">//  DDMS</span></span><br><span class=\"line\">        RuntimeInit.enableDdms();</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// , </span></span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> startSystemServer = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        String zygoteSocketName = <span class=\"string\">&quot;zygote&quot;</span>;</span><br><span class=\"line\">        String abiList = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> enableLazyPreload = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"string\">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;</span><br><span class=\"line\">                startSystemServer = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"string\">&quot;--enable-lazy-preload&quot;</span>.equals(argv[i])) &#123;</span><br><span class=\"line\">                enableLazyPreload = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class=\"line\">                abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class=\"line\">                zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;Unknown command line argument: &quot;</span> + argv[i]);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// Zygote.PRIMARY_SOCKET_NAME = &quot;zygote&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (abiList == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;No ABI list supplied.&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!enableLazyPreload) &#123;</span><br><span class=\"line\">            bootTimingsTraceLog.traceBegin(<span class=\"string\">&quot;ZygotePreload&quot;</span>);</span><br><span class=\"line\">            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</span><br><span class=\"line\">                    SystemClock.uptimeMillis());</span><br><span class=\"line\">          </span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            preload(bootTimingsTraceLog);</span><br><span class=\"line\">          </span><br><span class=\"line\">            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</span><br><span class=\"line\">                    SystemClock.uptimeMillis());</span><br><span class=\"line\">            bootTimingsTraceLog.traceEnd();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Zygote.resetNicePriority();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        bootTimingsTraceLog.traceBegin(<span class=\"string\">&quot;PostZygoteInitGC&quot;</span>);</span><br><span class=\"line\">      \t<span class=\"comment\">// Zygote ,  GC</span></span><br><span class=\"line\">        gcAndFinalize();</span><br><span class=\"line\">        bootTimingsTraceLog.traceEnd();</span><br><span class=\"line\"></span><br><span class=\"line\">        bootTimingsTraceLog.traceEnd(); <span class=\"comment\">// ZygoteInit</span></span><br><span class=\"line\">        </span><br><span class=\"line\">      \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> </span></span><br><span class=\"line\">        Trace.setTracingEnabled(<span class=\"keyword\">false</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> </span></span><br><span class=\"line\">        Zygote.initNativeState(isPrimaryZygote);</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">//  Zygote ,  ZygoteHooks.startZygoteNoThreadCreation() </span></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        ZygoteHooks.stopZygoteNoThreadCreation();</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// ZygoteServer  3.1.1.2</span></span><br><span class=\"line\">        zygoteServer = <span class=\"keyword\">new</span> ZygoteServer(isPrimaryZygote);</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">//  system_server </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (startSystemServer) &#123;</span><br><span class=\"line\">            Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer);</span><br><span class=\"line\"></span><br><span class=\"line\">          \t<span class=\"comment\">//  forkSystemServer  fork </span></span><br><span class=\"line\">          \t<span class=\"comment\">// ,  zygote ,  Runnable  null</span></span><br><span class=\"line\">          \t<span class=\"comment\">// ,  system_server ,  null  Runnable</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (r != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">              \t<span class=\"comment\">//  r.run() ,  return</span></span><br><span class=\"line\">              \t<span class=\"comment\">// </span></span><br><span class=\"line\">                r.run();</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Log.i(TAG, <span class=\"string\">&quot;Accepting command socket connections&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">//  3.1.1.3</span></span><br><span class=\"line\">        caller = zygoteServer.runSelectLoop(abiList);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Throwable ex) &#123;</span><br><span class=\"line\">        Log.e(TAG, <span class=\"string\">&quot;System zygote died with exception&quot;</span>, ex);</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (zygoteServer != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            zygoteServer.closeServerSocket();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (caller != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        caller.run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Zygote  Socket system_server  <code>ZygoteServer.runSelectLoop</code> </p>\n<h5 id=\"3-1-1-1-Os-setpgid-int-int\"><a href=\"#3-1-1-1-Os-setpgid-int-int\" class=\"headerlink\" title=\"3.1.1.1 Os.setpgid(int, int)\"></a>3.1.1.1 Os.setpgid(int, int)</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * See &lt;a href=&quot;http://man7.org/linux/man-pages/man2/setpgid.2.html&quot;&gt;setpgid(2)&lt;/a&gt;.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@hide</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@libcore</span>.api.CorePlatformApi</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">setpgid</span><span class=\"params\">(<span class=\"keyword\">int</span> pid, <span class=\"keyword\">int</span> pgid)</span> <span class=\"keyword\">throws</span> ErrnoException </span>&#123; Libcore.os.setpgid(pid, pgid); &#125;</span><br></pre></td></tr></table></figure>\n<p> <code>pid</code>, <code>pgid</code>  0</p>\n<p> <code>pid</code>  0  ID <code>pgid</code>  0  PGID  ID </p>\n<h5 id=\"3-1-1-2-ZygoteServer-boolean\"><a href=\"#3-1-1-2-ZygoteServer-boolean\" class=\"headerlink\" title=\"3.1.1.2 ZygoteServer(boolean)\"></a>3.1.1.2 ZygoteServer(boolean)</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ZygoteServer(<span class=\"keyword\">boolean</span> isPrimaryZygote) &#123;</span><br><span class=\"line\">    mUsapPoolEventFD = Zygote.getUsapPoolEventFD();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isPrimaryZygote) &#123;</span><br><span class=\"line\">        mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class=\"line\">        mUsapPoolSocket =</span><br><span class=\"line\">                Zygote.createManagedSocketFromInitSocket(</span><br><span class=\"line\">                        Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.SECONDARY_SOCKET_NAME);</span><br><span class=\"line\">        mUsapPoolSocket =</span><br><span class=\"line\">                Zygote.createManagedSocketFromInitSocket(</span><br><span class=\"line\">                        Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fetchUsapPoolPolicyProps();</span><br><span class=\"line\"></span><br><span class=\"line\">    mUsapPoolSupported = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ZygoteServer  Zygote  Socket </p>\n<h5 id=\"3-1-1-3-ZygoteServer-runSelectLoop-String\"><a href=\"#3-1-1-3-ZygoteServer-runSelectLoop-String\" class=\"headerlink\" title=\"3.1.1.3 ZygoteServer.runSelectLoop(String)\"></a>3.1.1.3 ZygoteServer.runSelectLoop(String)</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Runnable <span class=\"title\">runSelectLoop</span><span class=\"params\">(String abiList)</span> </span>&#123;</span><br><span class=\"line\">    ArrayList&lt;FileDescriptor&gt; socketFDs = <span class=\"keyword\">new</span> ArrayList&lt;FileDescriptor&gt;();</span><br><span class=\"line\">    ArrayList&lt;ZygoteConnection&gt; peers = <span class=\"keyword\">new</span> ArrayList&lt;ZygoteConnection&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    socketFDs.add(mZygoteSocket.getFileDescriptor());</span><br><span class=\"line\">    peers.add(<span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">        fetchUsapPoolPolicyPropsWithMinInterval();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span>[] usapPipeFDs = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        StructPollfd[] pollFDs = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mUsapPoolEnabled) &#123;</span><br><span class=\"line\">            usapPipeFDs = Zygote.getUsapPipeFDs();</span><br><span class=\"line\">            pollFDs = <span class=\"keyword\">new</span> StructPollfd[socketFDs.size() + <span class=\"number\">1</span> + usapPipeFDs.length];</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            pollFDs = <span class=\"keyword\">new</span> StructPollfd[socketFDs.size()];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> pollIndex = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (FileDescriptor socketFD : socketFDs) &#123;</span><br><span class=\"line\">            pollFDs[pollIndex] = <span class=\"keyword\">new</span> StructPollfd();</span><br><span class=\"line\">            pollFDs[pollIndex].fd = socketFD;</span><br><span class=\"line\">            pollFDs[pollIndex].events = (<span class=\"keyword\">short</span>) POLLIN;</span><br><span class=\"line\">            ++pollIndex;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            Os.poll(pollFDs, -<span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (ErrnoException ex) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;poll failed&quot;</span>, ex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> usapPoolFDRead = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (--pollIndex &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((pollFDs[pollIndex].revents &amp; POLLIN) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (pollIndex == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Zygote server socket</span></span><br><span class=\"line\"></span><br><span class=\"line\">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class=\"line\">                peers.add(newPeer);</span><br><span class=\"line\">                socketFDs.add(newPeer.getFileDescriptor());</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pollIndex &lt; usapPoolEventFDIndex) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Session socket accepted from the Zygote server socket</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    ZygoteConnection connection = peers.get(pollIndex);</span><br><span class=\"line\">                    <span class=\"keyword\">final</span> Runnable command = connection.processOneCommand(<span class=\"keyword\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// TODO (chriswailes): Is this extra check necessary?</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (mIsForkChild) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// We&#x27;re in the child. We should always have a command to run at this</span></span><br><span class=\"line\">                        <span class=\"comment\">// stage if processOneCommand hasn&#x27;t called &quot;exec&quot;.</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (command == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">&quot;command == null&quot;</span>);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">return</span> command;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// We&#x27;re in the server - we should never have any commands to run.</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (command != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">&quot;command != null&quot;</span>);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (connection.isClosedByPeer()) &#123;</span><br><span class=\"line\">                            connection.closeSocket();</span><br><span class=\"line\">                            peers.remove(pollIndex);</span><br><span class=\"line\">                            socketFDs.remove(pollIndex);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (!mIsForkChild) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                        Slog.e(TAG, <span class=\"string\">&quot;Exception executing zygote command: &quot;</span>, e);</span><br><span class=\"line\"></span><br><span class=\"line\">                        ZygoteConnection conn = peers.remove(pollIndex);</span><br><span class=\"line\">                        conn.closeSocket();</span><br><span class=\"line\"></span><br><span class=\"line\">                        socketFDs.remove(pollIndex);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        Log.e(TAG, <span class=\"string\">&quot;Caught post-fork exception in child process.&quot;</span>, e);</span><br><span class=\"line\">                        <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                    mIsForkChild = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">long</span> messagePayload = -<span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[Zygote.USAP_MANAGEMENT_MESSAGE_BYTES];</span><br><span class=\"line\">                    <span class=\"keyword\">int</span> readBytes = Os.read(pollFDs[pollIndex].fd, buffer, <span class=\"number\">0</span>, buffer.length);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (readBytes == Zygote.USAP_MANAGEMENT_MESSAGE_BYTES) &#123;</span><br><span class=\"line\">                        DataInputStream inputStream =</span><br><span class=\"line\">                                <span class=\"keyword\">new</span> DataInputStream(<span class=\"keyword\">new</span> ByteArrayInputStream(buffer));</span><br><span class=\"line\"></span><br><span class=\"line\">                        messagePayload = inputStream.readLong();</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        Log.e(TAG, <span class=\"string\">&quot;Incomplete read from USAP management FD of size &quot;</span></span><br><span class=\"line\">                                + readBytes);</span><br><span class=\"line\">                        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (pollIndex == usapPoolEventFDIndex) &#123;</span><br><span class=\"line\">                        Log.e(TAG, <span class=\"string\">&quot;Failed to read from USAP pool event FD: &quot;</span></span><br><span class=\"line\">                                + ex.getMessage());</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        Log.e(TAG, <span class=\"string\">&quot;Failed to read from USAP reporting pipe: &quot;</span></span><br><span class=\"line\">                                + ex.getMessage());</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (pollIndex &gt; usapPoolEventFDIndex) &#123;</span><br><span class=\"line\">                    Zygote.removeUsapTableEntry((<span class=\"keyword\">int</span>) messagePayload);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                usapPoolFDRead = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"http://gityuan.com/2016/02/01/android-booting/\">Android-</a></p>\n<p><a href=\"http://gityuan.com/2016/03/26/app-process-create/\">Android</a></p>\n<p><a href=\"https://www.jianshu.com/p/47d0121484fc\">AndroidZygote(api 29)</a></p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>: android-security-10.0.0_r56</p>\n</blockquote>\n<h2 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h2>","more":"<h3 id=\"1-1-\"><a href=\"#1-1-\" class=\"headerlink\" title=\"1.1 \"></a>1.1 </h3><!-- TODO -->\n\n\n\n<h4 id=\"1-1-1-Android-\"><a href=\"#1-1-1-Android-\" class=\"headerlink\" title=\"1.1.1 Android \"></a>1.1.1 Android </h4><!-- TODO -->\n\n\n\n<h4 id=\"1-1-2-Linux-fork\"><a href=\"#1-1-2-Linux-fork\" class=\"headerlink\" title=\"1.1.2 Linux fork\"></a>1.1.2 Linux fork</h4><!-- TODO -->\n\n\n\n<h2 id=\"2-system-server-\"><a href=\"#2-system-server-\" class=\"headerlink\" title=\"2. system_server \"></a>2. system_server </h2><!-- TODO -->\n\n<p>system_server  ProcessList  <code>ProcessList.startProcess</code> </p>\n<h3 id=\"2-1-ProcessList-startProcess-HostingRecord-String-ProcessRecord-int-int-int-int-String-String-String-String-long\"><a href=\"#2-1-ProcessList-startProcess-HostingRecord-String-ProcessRecord-int-int-int-int-String-String-String-String-long\" class=\"headerlink\" title=\"2.1 ProcessList.startProcess(HostingRecord, String, ProcessRecord, int, int[], int, int, String, String, String, String, long)\"></a>2.1 ProcessList.startProcess(HostingRecord, String, ProcessRecord, int, int[], int, int, String, String, String, String, long)</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> Process.<span class=\"function\">ProcessStartResult <span class=\"title\">startProcess</span><span class=\"params\">(HostingRecord hostingRecord, String entryPoint,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ProcessRecord app, <span class=\"keyword\">int</span> uid, <span class=\"keyword\">int</span>[] gids, <span class=\"keyword\">int</span> runtimeFlags, <span class=\"keyword\">int</span> mountExternal,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        String seInfo, String requiredAbi, String instructionSet, String invokeWith,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        <span class=\"keyword\">long</span> startTime)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class=\"string\">&quot;Start proc: &quot;</span> +</span><br><span class=\"line\">                app.processName);</span><br><span class=\"line\">        checkSlow(startTime, <span class=\"string\">&quot;startProcess: asking zygote to start proc&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Process.ProcessStartResult startResult;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hostingRecord.usesWebviewZygote()) &#123;</span><br><span class=\"line\">            startResult = startWebView(entryPoint,</span><br><span class=\"line\">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class=\"line\">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class=\"line\">                    app.info.dataDir, <span class=\"keyword\">null</span>, app.info.packageName,</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (hostingRecord.usesAppZygote()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> AppZygote appZygote = createAppZygoteForProcessIfNeeded(app);</span><br><span class=\"line\"></span><br><span class=\"line\">            startResult = appZygote.getProcess().start(entryPoint,</span><br><span class=\"line\">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class=\"line\">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class=\"line\">                    app.info.dataDir, <span class=\"keyword\">null</span>, app.info.packageName,</span><br><span class=\"line\">                    <span class=\"comment\">/*useUsapPool=*/</span> <span class=\"keyword\">false</span>,</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            startResult = Process.start(entryPoint,</span><br><span class=\"line\">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class=\"line\">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class=\"line\">                    app.info.dataDir, invokeWith, app.info.packageName,</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        checkSlow(startTime, <span class=\"string\">&quot;startProcess: returned from zygote!&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> startResult;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>Process.start</code> </p>\n<h3 id=\"2-2-Process-start-String-String-int-int-int-int-int-int-String-String-String-String-String-String-String\"><a href=\"#2-2-Process-start-String-String-int-int-int-int-int-int-String-String-String-String-String-String-String\" class=\"headerlink\" title=\"2.2 Process.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, String[])\"></a>2.2 Process.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, String[])</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ProcessStartResult <span class=\"title\">start</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> <span class=\"keyword\">final</span> String processClass,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> <span class=\"keyword\">final</span> String niceName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"keyword\">int</span> uid, <span class=\"keyword\">int</span> gid, <span class=\"meta\">@Nullable</span> <span class=\"keyword\">int</span>[] gids,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"keyword\">int</span> runtimeFlags,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"keyword\">int</span> mountExternal,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"keyword\">int</span> targetSdkVersion,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String seInfo,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@NonNull</span> String abi,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String instructionSet,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String appDataDir,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String invokeWith,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String packageName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"meta\">@Nullable</span> String[] zygoteArgs)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ZYGOTE_PROCESS.start(processClass, niceName, uid, gid, gids,</span><br><span class=\"line\">                runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class=\"line\">                abi, instructionSet, appDataDir, invokeWith, packageName,</span><br><span class=\"line\">                <span class=\"comment\">/*useUsapPool=*/</span> <span class=\"keyword\">true</span>, zygoteArgs);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>ZYGOTE_PROCESS</code>  ZygoteProcess </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * State associated with the zygote process.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@hide</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> ZygoteProcess ZYGOTE_PROCESS = <span class=\"keyword\">new</span> ZygoteProcess();</span><br></pre></td></tr></table></figure>\n<p> ZygoteProcess </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ZygoteProcess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    mZygoteSocketAddress =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalSocketAddress(Zygote.PRIMARY_SOCKET_NAME,</span><br><span class=\"line\">                                   LocalSocketAddress.Namespace.RESERVED);</span><br><span class=\"line\">    mZygoteSecondarySocketAddress =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalSocketAddress(Zygote.SECONDARY_SOCKET_NAME,</span><br><span class=\"line\">                                   LocalSocketAddress.Namespace.RESERVED);</span><br><span class=\"line\"></span><br><span class=\"line\">    mUsapPoolSocketAddress =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalSocketAddress(Zygote.USAP_POOL_PRIMARY_SOCKET_NAME,</span><br><span class=\"line\">                                   LocalSocketAddress.Namespace.RESERVED);</span><br><span class=\"line\">    mUsapPoolSecondarySocketAddress =</span><br><span class=\"line\">            <span class=\"keyword\">new</span> LocalSocketAddress(Zygote.USAP_POOL_SECONDARY_SOCKET_NAME,</span><br><span class=\"line\">                                   LocalSocketAddress.Namespace.RESERVED);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ZygoteProcess  Socket  Zygote </p>\n<p> <code>ZygoteProcess.start</code> </p>\n<h3 id=\"2-3-ZygoteProcess-start-String-String-int-int-int-int-int-int-String-String-String-String-String-String-boolean-String\"><a href=\"#2-3-ZygoteProcess-start-String-String-int-int-int-int-int-int-String-String-String-String-String-String-boolean-String\" class=\"headerlink\" title=\"2.3 ZygoteProcess.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, boolean, String[])\"></a>2.3 ZygoteProcess.start(String, String, int, int, int[], int, int, int, String, String, String, String, String, String, boolean, String[])</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Process.<span class=\"function\">ProcessStartResult <span class=\"title\">start</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> <span class=\"keyword\">final</span> String processClass,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"keyword\">final</span> String niceName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"keyword\">int</span> uid, <span class=\"keyword\">int</span> gid, <span class=\"meta\">@Nullable</span> <span class=\"keyword\">int</span>[] gids,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"keyword\">int</span> runtimeFlags, <span class=\"keyword\">int</span> mountExternal,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"keyword\">int</span> targetSdkVersion,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String seInfo,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@NonNull</span> String abi,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String instructionSet,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String appDataDir,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String invokeWith,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String packageName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"keyword\">boolean</span> useUsapPool,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                              <span class=\"meta\">@Nullable</span> String[] zygoteArgs)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// UASP ,  2.3.1</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fetchUsapPoolEnabledPropWithMinInterval()) &#123;</span><br><span class=\"line\">        informZygotesOfUsapPoolStatus();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</span><br><span class=\"line\">                runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class=\"line\">                abi, instructionSet, appDataDir, invokeWith, <span class=\"comment\">/*startChildZygote=*/</span> <span class=\"keyword\">false</span>,</span><br><span class=\"line\">                packageName, useUsapPool, zygoteArgs);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ZygoteStartFailedEx ex) &#123;</span><br><span class=\"line\">        Log.e(LOG_TAG,</span><br><span class=\"line\">                <span class=\"string\">&quot;Starting VM process through Zygote failed&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(</span><br><span class=\"line\">                <span class=\"string\">&quot;Starting VM process through Zygote failed&quot;</span>, ex);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> UASP  2.3.1 <code>ZygoteProcess.startViaZygote</code> </p>\n<p> <code>ZygoteProcess.startViaZygote</code>  <code>ZygoteStartFailedEx</code>  <code>RuntimeException</code></p>\n<h4 id=\"2-3-1-ZygoteProcess-fetchUsapPoolEnabledPropWithMinInterval\"><a href=\"#2-3-1-ZygoteProcess-fetchUsapPoolEnabledPropWithMinInterval\" class=\"headerlink\" title=\"2.3.1 ZygoteProcess.fetchUsapPoolEnabledPropWithMinInterval()\"></a>2.3.1 ZygoteProcess.fetchUsapPoolEnabledPropWithMinInterval()</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">fetchUsapPoolEnabledPropWithMinInterval</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> currentTimestamp = SystemClock.elapsedRealtime();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (SystemProperties.get(<span class=\"string\">&quot;dalvik.vm.boot-image&quot;</span>, <span class=\"string\">&quot;&quot;</span>).endsWith(<span class=\"string\">&quot;apex.art&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (currentTimestamp &lt;= <span class=\"number\">15000</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mIsFirstPropCheck</span><br><span class=\"line\">            || (currentTimestamp - mLastPropCheckTimestamp &gt;= Zygote.PROPERTY_CHECK_INTERVAL)) &#123;</span><br><span class=\"line\">        mIsFirstPropCheck = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        mLastPropCheckTimestamp = currentTimestamp;</span><br><span class=\"line\">      </span><br><span class=\"line\">      \t<span class=\"comment\">//  UsapPool ,  2.3.1.1</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> fetchUsapPoolEnabledProp();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h5 id=\"2-3-1-1-ZygoteProcess-fetchUsapPoolEnabledProp\"><a href=\"#2-3-1-1-ZygoteProcess-fetchUsapPoolEnabledProp\" class=\"headerlink\" title=\"2.3.1.1 ZygoteProcess.fetchUsapPoolEnabledProp()\"></a>2.3.1.1 ZygoteProcess.fetchUsapPoolEnabledProp()</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">fetchUsapPoolEnabledProp</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> origVal = mUsapPoolEnabled;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> String propertyString = Zygote.getConfigurationProperty(</span><br><span class=\"line\">            ZygoteConfig.USAP_POOL_ENABLED, USAP_POOL_ENABLED_DEFAULT);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!propertyString.isEmpty()) &#123;</span><br><span class=\"line\">        mUsapPoolEnabled = Zygote.getConfigurationPropertyBoolean(</span><br><span class=\"line\">              ZygoteConfig.USAP_POOL_ENABLED,</span><br><span class=\"line\">              Boolean.parseBoolean(USAP_POOL_ENABLED_DEFAULT));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> valueChanged = origVal != mUsapPoolEnabled;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (valueChanged) &#123;</span><br><span class=\"line\">        Log.i(LOG_TAG, <span class=\"string\">&quot;usapPoolEnabled = &quot;</span> + mUsapPoolEnabled);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> valueChanged;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> UsapPool  <code>USAP_POOL_ENABLED_DEFAULT</code>  false UsapPool </p>\n<p> UASP </p>\n<h3 id=\"2-4-ZygoteProcess-startViaZygote-String-String-int-int-int-int-int-int-String-String-String-String-String-boolean-String-boolean-String\"><a href=\"#2-4-ZygoteProcess-startViaZygote-String-String-int-int-int-int-int-int-String-String-String-String-String-boolean-String-boolean-String\" class=\"headerlink\" title=\"2.4 ZygoteProcess.startViaZygote(String, String, int, int, int[], int, int, int, String, String, String, String, String, boolean, String, boolean, String[])\"></a>2.4 ZygoteProcess.startViaZygote(String, String, int, int, int[], int, int, int, String, String, String, String, String, boolean, String, boolean, String[])</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> Process.<span class=\"function\">ProcessStartResult <span class=\"title\">startViaZygote</span><span class=\"params\">(<span class=\"meta\">@NonNull</span> <span class=\"keyword\">final</span> String processClass,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> <span class=\"keyword\">final</span> String niceName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> uid, <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> gid,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span>[] gids,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"keyword\">int</span> runtimeFlags, <span class=\"keyword\">int</span> mountExternal,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"keyword\">int</span> targetSdkVersion,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String seInfo,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@NonNull</span> String abi,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String instructionSet,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String appDataDir,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String invokeWith,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"keyword\">boolean</span> startChildZygote,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String packageName,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"keyword\">boolean</span> useUsapPool,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                                  <span class=\"meta\">@Nullable</span> String[] extraArgs)</span></span></span><br><span class=\"line\"><span class=\"function\">                                                  <span class=\"keyword\">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class=\"line\">    ArrayList&lt;String&gt; argsForZygote = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// --runtime-args, --setuid=, --setgid=,</span></span><br><span class=\"line\">    <span class=\"comment\">// and --setgroups= must go first</span></span><br><span class=\"line\">    argsForZygote.add(<span class=\"string\">&quot;--runtime-args&quot;</span>);</span><br><span class=\"line\">    argsForZygote.add(<span class=\"string\">&quot;--setuid=&quot;</span> + uid);</span><br><span class=\"line\">    argsForZygote.add(<span class=\"string\">&quot;--setgid=&quot;</span> + gid);</span><br><span class=\"line\">    argsForZygote.add(<span class=\"string\">&quot;--runtime-flags=&quot;</span> + runtimeFlags);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span>(mLock) &#123;</span><br><span class=\"line\">      \t<span class=\"comment\">// openZygoteSocketIfNeeded  2.4.1</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi),</span><br><span class=\"line\">                                          useUsapPool,</span><br><span class=\"line\">                                          argsForZygote);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> uid, gid  <code>argsForZygote</code> </p>\n<h4 id=\"2-4-1-ZygoteProcess-openZygoteSocketIfNeeded-String\"><a href=\"#2-4-1-ZygoteProcess-openZygoteSocketIfNeeded-String\" class=\"headerlink\" title=\"2.4.1 ZygoteProcess.openZygoteSocketIfNeeded(String)\"></a>2.4.1 ZygoteProcess.openZygoteSocketIfNeeded(String)</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@GuardedBy(&quot;mLock&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> ZygoteState <span class=\"title\">openZygoteSocketIfNeeded</span><span class=\"params\">(String abi)</span> <span class=\"keyword\">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        attemptConnectionToPrimaryZygote();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (primaryZygoteState.matches(abi)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> primaryZygoteState;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mZygoteSecondarySocketAddress != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// The primary zygote didn&#x27;t match. Try the secondary.</span></span><br><span class=\"line\">            attemptConnectionToSecondaryZygote();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (secondaryZygoteState.matches(abi)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> secondaryZygoteState;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException ioe) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(<span class=\"string\">&quot;Error connecting to zygote&quot;</span>, ioe);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(<span class=\"string\">&quot;Unsupported zygote ABI: &quot;</span> + abi);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Zygote </p>\n<p> <code>@GuardedBy(&quot;mLock&quot;)</code>  <code>mLock</code> </p>\n<h3 id=\"2-5-ZygoteProcess-zygoteSendArgsAndGetResult-ZygoteState-boolean-ArrayList\"><a href=\"#2-5-ZygoteProcess-zygoteSendArgsAndGetResult-ZygoteState-boolean-ArrayList\" class=\"headerlink\" title=\"2.5 ZygoteProcess.zygoteSendArgsAndGetResult(ZygoteState, boolean, ArrayList)\"></a>2.5 ZygoteProcess.zygoteSendArgsAndGetResult(ZygoteState, boolean, ArrayList)</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@GuardedBy(&quot;mLock&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Process.<span class=\"function\">ProcessStartResult <span class=\"title\">zygoteSendArgsAndGetResult</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ZygoteState zygoteState, <span class=\"keyword\">boolean</span> useUsapPool, <span class=\"meta\">@NonNull</span> ArrayList&lt;String&gt; args)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (String arg : args) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (arg.indexOf(<span class=\"string\">&#x27;\\n&#x27;</span>) &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(<span class=\"string\">&quot;Embedded newlines not allowed&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (arg.indexOf(<span class=\"string\">&#x27;\\r&#x27;</span>) &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(<span class=\"string\">&quot;Embedded carriage returns not allowed&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    String msgStr = args.size() + <span class=\"string\">&quot;\\n&quot;</span> + String.join(<span class=\"string\">&quot;\\n&quot;</span>, args) + <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  \t...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> attemptZygoteSendArgsAndGetResult(zygoteState, msgStr);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>ZygoteProcess.attemptZygoteSendArgsAndGetResult</code> </p>\n<h3 id=\"2-6-ZygoteProcess-attemptZygoteSendArgsAndGetResult-ZygoteState-String\"><a href=\"#2-6-ZygoteProcess-attemptZygoteSendArgsAndGetResult-ZygoteState-String\" class=\"headerlink\" title=\"2.6 ZygoteProcess.attemptZygoteSendArgsAndGetResult(ZygoteState, String)\"></a>2.6 ZygoteProcess.attemptZygoteSendArgsAndGetResult(ZygoteState, String)</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> Process.<span class=\"function\">ProcessStartResult <span class=\"title\">attemptZygoteSendArgsAndGetResult</span><span class=\"params\">(</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">        ZygoteState zygoteState, String msgStr)</span> <span class=\"keyword\">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      \t<span class=\"comment\">//  Zygote  Socket , </span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> BufferedWriter zygoteWriter = zygoteState.mZygoteOutputWriter;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> DataInputStream zygoteInputStream = zygoteState.mZygoteInputStream;</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">//  Zygote </span></span><br><span class=\"line\">        zygoteWriter.write(msgStr);</span><br><span class=\"line\">        zygoteWriter.flush();</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// </span></span><br><span class=\"line\">        Process.ProcessStartResult result = <span class=\"keyword\">new</span> Process.ProcessStartResult();</span><br><span class=\"line\">        result.pid = zygoteInputStream.readInt();</span><br><span class=\"line\">        result.usingWrapper = zygoteInputStream.readBoolean();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result.pid &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//  pid  0, </span></span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(<span class=\"string\">&quot;fork() failed&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException ex) &#123;</span><br><span class=\"line\">      \t<span class=\"comment\">//  IOException,  Zygote </span></span><br><span class=\"line\">        zygoteState.close();</span><br><span class=\"line\"></span><br><span class=\"line\">        Log.e(LOG_TAG, <span class=\"string\">&quot;IO Exception while communicating with Zygote - &quot;</span></span><br><span class=\"line\">                + ex.toString());</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ZygoteStartFailedEx(ex);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">// ,  zygoteState.close(),  Zygote </span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Zygote  Zygote  Zygote </p>\n<p> Zygote  pid &lt; 0 <code>Process.ProcessStartResult</code> </p>\n<h2 id=\"3-Zygote-\"><a href=\"#3-Zygote-\" class=\"headerlink\" title=\"3. Zygote \"></a>3. Zygote </h2><!-- TODO -->\n\n\n\n<h3 id=\"3-1-Zygote-\"><a href=\"#3-1-Zygote-\" class=\"headerlink\" title=\"3.1 Zygote \"></a>3.1 Zygote </h3><p>Zygote  init  Zygote  <code>ZygoteInit.main</code> </p>\n<h4 id=\"3-1-1-ZygoteInit-main-String\"><a href=\"#3-1-1-ZygoteInit-main-String\" class=\"headerlink\" title=\"3.1.1 ZygoteInit.main(String)\"></a>3.1.1 ZygoteInit.main(String)</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String argv[])</span> </span>&#123;</span><br><span class=\"line\">    ZygoteServer zygoteServer = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Zygote , </span></span><br><span class=\"line\">    ZygoteHooks.startZygoteNoThreadCreation();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      \t<span class=\"comment\">//  3.1.1.1</span></span><br><span class=\"line\">        Os.setpgid(<span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ErrnoException ex) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;Failed to setpgid(0,0)&quot;</span>, ex);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Runnable caller;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">      \t...</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">//  DDMS</span></span><br><span class=\"line\">        RuntimeInit.enableDdms();</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// , </span></span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> startSystemServer = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        String zygoteSocketName = <span class=\"string\">&quot;zygote&quot;</span>;</span><br><span class=\"line\">        String abiList = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> enableLazyPreload = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"string\">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;</span><br><span class=\"line\">                startSystemServer = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"string\">&quot;--enable-lazy-preload&quot;</span>.equals(argv[i])) &#123;</span><br><span class=\"line\">                enableLazyPreload = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class=\"line\">                abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class=\"line\">                zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;Unknown command line argument: &quot;</span> + argv[i]);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// Zygote.PRIMARY_SOCKET_NAME = &quot;zygote&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (abiList == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;No ABI list supplied.&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!enableLazyPreload) &#123;</span><br><span class=\"line\">            bootTimingsTraceLog.traceBegin(<span class=\"string\">&quot;ZygotePreload&quot;</span>);</span><br><span class=\"line\">            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</span><br><span class=\"line\">                    SystemClock.uptimeMillis());</span><br><span class=\"line\">          </span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            preload(bootTimingsTraceLog);</span><br><span class=\"line\">          </span><br><span class=\"line\">            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</span><br><span class=\"line\">                    SystemClock.uptimeMillis());</span><br><span class=\"line\">            bootTimingsTraceLog.traceEnd();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Zygote.resetNicePriority();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        bootTimingsTraceLog.traceBegin(<span class=\"string\">&quot;PostZygoteInitGC&quot;</span>);</span><br><span class=\"line\">      \t<span class=\"comment\">// Zygote ,  GC</span></span><br><span class=\"line\">        gcAndFinalize();</span><br><span class=\"line\">        bootTimingsTraceLog.traceEnd();</span><br><span class=\"line\"></span><br><span class=\"line\">        bootTimingsTraceLog.traceEnd(); <span class=\"comment\">// ZygoteInit</span></span><br><span class=\"line\">        </span><br><span class=\"line\">      \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> </span></span><br><span class=\"line\">        Trace.setTracingEnabled(<span class=\"keyword\">false</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> </span></span><br><span class=\"line\">        Zygote.initNativeState(isPrimaryZygote);</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">//  Zygote ,  ZygoteHooks.startZygoteNoThreadCreation() </span></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        ZygoteHooks.stopZygoteNoThreadCreation();</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">// ZygoteServer  3.1.1.2</span></span><br><span class=\"line\">        zygoteServer = <span class=\"keyword\">new</span> ZygoteServer(isPrimaryZygote);</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">//  system_server </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (startSystemServer) &#123;</span><br><span class=\"line\">            Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer);</span><br><span class=\"line\"></span><br><span class=\"line\">          \t<span class=\"comment\">//  forkSystemServer  fork </span></span><br><span class=\"line\">          \t<span class=\"comment\">// ,  zygote ,  Runnable  null</span></span><br><span class=\"line\">          \t<span class=\"comment\">// ,  system_server ,  null  Runnable</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (r != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">              \t<span class=\"comment\">//  r.run() ,  return</span></span><br><span class=\"line\">              \t<span class=\"comment\">// </span></span><br><span class=\"line\">                r.run();</span><br><span class=\"line\">                <span class=\"keyword\">return</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Log.i(TAG, <span class=\"string\">&quot;Accepting command socket connections&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">      \t<span class=\"comment\">//  3.1.1.3</span></span><br><span class=\"line\">        caller = zygoteServer.runSelectLoop(abiList);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Throwable ex) &#123;</span><br><span class=\"line\">        Log.e(TAG, <span class=\"string\">&quot;System zygote died with exception&quot;</span>, ex);</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> ex;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (zygoteServer != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            zygoteServer.closeServerSocket();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (caller != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        caller.run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Zygote  Socket system_server  <code>ZygoteServer.runSelectLoop</code> </p>\n<h5 id=\"3-1-1-1-Os-setpgid-int-int\"><a href=\"#3-1-1-1-Os-setpgid-int-int\" class=\"headerlink\" title=\"3.1.1.1 Os.setpgid(int, int)\"></a>3.1.1.1 Os.setpgid(int, int)</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * See &lt;a href=&quot;http://man7.org/linux/man-pages/man2/setpgid.2.html&quot;&gt;setpgid(2)&lt;/a&gt;.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@hide</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@libcore</span>.api.CorePlatformApi</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">setpgid</span><span class=\"params\">(<span class=\"keyword\">int</span> pid, <span class=\"keyword\">int</span> pgid)</span> <span class=\"keyword\">throws</span> ErrnoException </span>&#123; Libcore.os.setpgid(pid, pgid); &#125;</span><br></pre></td></tr></table></figure>\n<p> <code>pid</code>, <code>pgid</code>  0</p>\n<p> <code>pid</code>  0  ID <code>pgid</code>  0  PGID  ID </p>\n<h5 id=\"3-1-1-2-ZygoteServer-boolean\"><a href=\"#3-1-1-2-ZygoteServer-boolean\" class=\"headerlink\" title=\"3.1.1.2 ZygoteServer(boolean)\"></a>3.1.1.2 ZygoteServer(boolean)</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ZygoteServer(<span class=\"keyword\">boolean</span> isPrimaryZygote) &#123;</span><br><span class=\"line\">    mUsapPoolEventFD = Zygote.getUsapPoolEventFD();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isPrimaryZygote) &#123;</span><br><span class=\"line\">        mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class=\"line\">        mUsapPoolSocket =</span><br><span class=\"line\">                Zygote.createManagedSocketFromInitSocket(</span><br><span class=\"line\">                        Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.SECONDARY_SOCKET_NAME);</span><br><span class=\"line\">        mUsapPoolSocket =</span><br><span class=\"line\">                Zygote.createManagedSocketFromInitSocket(</span><br><span class=\"line\">                        Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fetchUsapPoolPolicyProps();</span><br><span class=\"line\"></span><br><span class=\"line\">    mUsapPoolSupported = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ZygoteServer  Zygote  Socket </p>\n<h5 id=\"3-1-1-3-ZygoteServer-runSelectLoop-String\"><a href=\"#3-1-1-3-ZygoteServer-runSelectLoop-String\" class=\"headerlink\" title=\"3.1.1.3 ZygoteServer.runSelectLoop(String)\"></a>3.1.1.3 ZygoteServer.runSelectLoop(String)</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Runnable <span class=\"title\">runSelectLoop</span><span class=\"params\">(String abiList)</span> </span>&#123;</span><br><span class=\"line\">    ArrayList&lt;FileDescriptor&gt; socketFDs = <span class=\"keyword\">new</span> ArrayList&lt;FileDescriptor&gt;();</span><br><span class=\"line\">    ArrayList&lt;ZygoteConnection&gt; peers = <span class=\"keyword\">new</span> ArrayList&lt;ZygoteConnection&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    socketFDs.add(mZygoteSocket.getFileDescriptor());</span><br><span class=\"line\">    peers.add(<span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">        fetchUsapPoolPolicyPropsWithMinInterval();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span>[] usapPipeFDs = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        StructPollfd[] pollFDs = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mUsapPoolEnabled) &#123;</span><br><span class=\"line\">            usapPipeFDs = Zygote.getUsapPipeFDs();</span><br><span class=\"line\">            pollFDs = <span class=\"keyword\">new</span> StructPollfd[socketFDs.size() + <span class=\"number\">1</span> + usapPipeFDs.length];</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            pollFDs = <span class=\"keyword\">new</span> StructPollfd[socketFDs.size()];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> pollIndex = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (FileDescriptor socketFD : socketFDs) &#123;</span><br><span class=\"line\">            pollFDs[pollIndex] = <span class=\"keyword\">new</span> StructPollfd();</span><br><span class=\"line\">            pollFDs[pollIndex].fd = socketFD;</span><br><span class=\"line\">            pollFDs[pollIndex].events = (<span class=\"keyword\">short</span>) POLLIN;</span><br><span class=\"line\">            ++pollIndex;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            Os.poll(pollFDs, -<span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (ErrnoException ex) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;poll failed&quot;</span>, ex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> usapPoolFDRead = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (--pollIndex &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((pollFDs[pollIndex].revents &amp; POLLIN) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (pollIndex == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Zygote server socket</span></span><br><span class=\"line\"></span><br><span class=\"line\">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class=\"line\">                peers.add(newPeer);</span><br><span class=\"line\">                socketFDs.add(newPeer.getFileDescriptor());</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pollIndex &lt; usapPoolEventFDIndex) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Session socket accepted from the Zygote server socket</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    ZygoteConnection connection = peers.get(pollIndex);</span><br><span class=\"line\">                    <span class=\"keyword\">final</span> Runnable command = connection.processOneCommand(<span class=\"keyword\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">// TODO (chriswailes): Is this extra check necessary?</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (mIsForkChild) &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// We&#x27;re in the child. We should always have a command to run at this</span></span><br><span class=\"line\">                        <span class=\"comment\">// stage if processOneCommand hasn&#x27;t called &quot;exec&quot;.</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (command == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">&quot;command == null&quot;</span>);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">return</span> command;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// We&#x27;re in the server - we should never have any commands to run.</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (command != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">&quot;command != null&quot;</span>);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (connection.isClosedByPeer()) &#123;</span><br><span class=\"line\">                            connection.closeSocket();</span><br><span class=\"line\">                            peers.remove(pollIndex);</span><br><span class=\"line\">                            socketFDs.remove(pollIndex);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (!mIsForkChild) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                        Slog.e(TAG, <span class=\"string\">&quot;Exception executing zygote command: &quot;</span>, e);</span><br><span class=\"line\"></span><br><span class=\"line\">                        ZygoteConnection conn = peers.remove(pollIndex);</span><br><span class=\"line\">                        conn.closeSocket();</span><br><span class=\"line\"></span><br><span class=\"line\">                        socketFDs.remove(pollIndex);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        Log.e(TAG, <span class=\"string\">&quot;Caught post-fork exception in child process.&quot;</span>, e);</span><br><span class=\"line\">                        <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                    mIsForkChild = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">long</span> messagePayload = -<span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">byte</span>[] buffer = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[Zygote.USAP_MANAGEMENT_MESSAGE_BYTES];</span><br><span class=\"line\">                    <span class=\"keyword\">int</span> readBytes = Os.read(pollFDs[pollIndex].fd, buffer, <span class=\"number\">0</span>, buffer.length);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (readBytes == Zygote.USAP_MANAGEMENT_MESSAGE_BYTES) &#123;</span><br><span class=\"line\">                        DataInputStream inputStream =</span><br><span class=\"line\">                                <span class=\"keyword\">new</span> DataInputStream(<span class=\"keyword\">new</span> ByteArrayInputStream(buffer));</span><br><span class=\"line\"></span><br><span class=\"line\">                        messagePayload = inputStream.readLong();</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        Log.e(TAG, <span class=\"string\">&quot;Incomplete read from USAP management FD of size &quot;</span></span><br><span class=\"line\">                                + readBytes);</span><br><span class=\"line\">                        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (pollIndex == usapPoolEventFDIndex) &#123;</span><br><span class=\"line\">                        Log.e(TAG, <span class=\"string\">&quot;Failed to read from USAP pool event FD: &quot;</span></span><br><span class=\"line\">                                + ex.getMessage());</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        Log.e(TAG, <span class=\"string\">&quot;Failed to read from USAP reporting pipe: &quot;</span></span><br><span class=\"line\">                                + ex.getMessage());</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (pollIndex &gt; usapPoolEventFDIndex) &#123;</span><br><span class=\"line\">                    Zygote.removeUsapTableEntry((<span class=\"keyword\">int</span>) messagePayload);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                usapPoolFDRead = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><a href=\"http://gityuan.com/2016/02/01/android-booting/\">Android-</a></p>\n<p><a href=\"http://gityuan.com/2016/03/26/app-process-create/\">Android</a></p>\n<p><a href=\"https://www.jianshu.com/p/47d0121484fc\">AndroidZygote(api 29)</a></p>"},{"title":" init ","_content":"\n\n\n> android-security-10.0.0_r56\n\n\n\n# 1. \n\n<!-- TODO:  init  -->\n\nAndroid  Linux  init \n\ninit  pid = 1\n\n<!-- more -->\n\n\n\n# 2. \n\n<!-- TODO:  -->\n\n\n\n## 2.1 init \n\n<!-- TODO:  -->\n\n<!-- TODO: init ,  /system/core/init -->\n\n Android 9init  `system/core/init/init.cpp`  main \n\n Android 10 init  `system/core/init/main.cpp`  main \n\n```c++\nint main(int argc, char** argv) {\n    ...\n\n    if (!strcmp(basename(argv[0]), \"ueventd\")) {\n        return ueventd_main(argc, argv);\n    }\n\n    if (argc > 1) {\n        if (!strcmp(argv[1], \"subcontext\")) {\n            android::base::InitLogging(argv, &android::base::KernelLogger);\n            const BuiltinFunctionMap& function_map = GetBuiltinFunctionMap();\n\n            return SubcontextMain(argc, argv, &function_map);\n        }\n\n        if (!strcmp(argv[1], \"selinux_setup\")) {\n            return SetupSelinux(argv);\n        }\n\n        if (!strcmp(argv[1], \"second_stage\")) {\n            return SecondStageMain(argc, argv);\n        }\n    }\n\n    return FirstStageMain(argc, argv);\n}\n```\n\n`basename`  `strcmp` \n\n- `basename`  `char* basename(char* __path)` \"/system/bin/ueventd\" \"ueventd\"\n- `strcmp`  `int strcmp(const char* __lhs, const char* __rhs)` 0\n\n main  `argc`  `argv` `FirstStageMain` \n\n\n\n## 2.2 \n\n<!-- TODO: mkdir, mknod, tmpfs -->\n\n<!-- TODO:  -->\n\n<!-- TODO: KernelLogging(/dev/kmsg) -->\n\n<!-- TODO: InstallRebootSignalHandlers -->\n\n `int FirstStageMain(int argc, char** argv)`  `system/core/init/first_stage_init.cpp`\n\n```c++\nint FirstStageMain(int argc, char** argv) {\n    ...\n\n    CHECKCALL(clearenv());\n    CHECKCALL(setenv(\"PATH\", _PATH_DEFPATH, 1));\n    // Get the basic filesystem setup we need put together in the initramdisk\n    // on / and then we'll let the rc file figure out the rest.\n    CHECKCALL(mount(\"tmpfs\", \"/dev\", \"tmpfs\", MS_NOSUID, \"mode=0755\"));\n    CHECKCALL(mkdir(\"/dev/pts\", 0755));\n    CHECKCALL(mkdir(\"/dev/socket\", 0755));\n    CHECKCALL(mkdir(\"/dev/dm-user\", 0755));\n    CHECKCALL(mount(\"devpts\", \"/dev/pts\", \"devpts\", 0, NULL));\n#define MAKE_STR(x) __STRING(x)\n    CHECKCALL(mount(\"proc\", \"/proc\", \"proc\", 0, \"hidepid=2,gid=\" MAKE_STR(AID_READPROC)));\n#undef MAKE_STR\n\n    // Don't expose the raw commandline to unprivileged processes.\n    //  [2.2.1]\n    CHECKCALL(chmod(\"/proc/cmdline\", 0440));\n    std::string cmdline;\n    android::base::ReadFileToString(\"/proc/cmdline\", &cmdline);\n    // Don't expose the raw bootconfig to unprivileged processes.\n    chmod(\"/proc/bootconfig\", 0440);\n    std::string bootconfig;\n    android::base::ReadFileToString(\"/proc/bootconfig\", &bootconfig);\n    gid_t groups[] = {AID_READPROC};\n    CHECKCALL(setgroups(arraysize(groups), groups));\n    CHECKCALL(mount(\"sysfs\", \"/sys\", \"sysfs\", 0, NULL));\n    CHECKCALL(mount(\"selinuxfs\", \"/sys/fs/selinux\", \"selinuxfs\", 0, NULL));\n\n    CHECKCALL(mknod(\"/dev/kmsg\", S_IFCHR | 0600, makedev(1, 11)));\n\n    if constexpr (WORLD_WRITABLE_KMSG) {\n        CHECKCALL(mknod(\"/dev/kmsg_debug\", S_IFCHR | 0622, makedev(1, 11)));\n    }\n\n    CHECKCALL(mknod(\"/dev/random\", S_IFCHR | 0666, makedev(1, 8)));\n    CHECKCALL(mknod(\"/dev/urandom\", S_IFCHR | 0666, makedev(1, 9)));\n\n    // This is needed for log wrapper, which gets called before ueventd runs.\n    CHECKCALL(mknod(\"/dev/ptmx\", S_IFCHR | 0666, makedev(5, 2)));\n    CHECKCALL(mknod(\"/dev/null\", S_IFCHR | 0666, makedev(1, 3)));\n\n    // These below mounts are done in first stage init so that first stage mount can mount\n    // subdirectories of /mnt/{vendor,product}/.  Other mounts, not required by first stage mount,\n    // should be done in rc files.\n    // Mount staging areas for devices managed by vold\n    // See storage config details at http://source.android.com/devices/storage/\n    CHECKCALL(mount(\"tmpfs\", \"/mnt\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=1000\"));\n    // /mnt/vendor is used to mount vendor-specific partitions that can not be\n    // part of the vendor partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/vendor\", 0755));\n    // /mnt/product is used to mount product-specific partitions that can not be\n    // part of the product partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/product\", 0755));\n\n    // /debug_ramdisk is used to preserve additional files from the debug ramdisk\n    CHECKCALL(mount(\"tmpfs\", \"/debug_ramdisk\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"));\n\n    // /second_stage_resources is used to preserve files from first to second\n    // stage init\n    CHECKCALL(mount(\"tmpfs\", kSecondStageRes, \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"))\n#undef CHECKCALL\n\n    SetStdioToDevNull(argv);\n    // Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually\n    // talk to the outside world...\n    InitKernelLogging(argv);\n\n    if (!errors.empty()) {\n        for (const auto& [error_string, error_errno] : errors) {\n            LOG(ERROR) << error_string << \" \" << strerror(error_errno);\n        }\n        LOG(FATAL) << \"Init encountered errors starting first stage, aborting\";\n    }\n\n    LOG(INFO) << \"init first stage started!\";\n\n    ...\n\n    //  /system/bin/init\n    //  selinux_setup,  SetupSelinux  SELinux  [2.3]\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"selinux_setup\", nullptr};\n    auto fd = open(\"/dev/kmsg\", O_WRONLY | O_CLOEXEC);\n    dup2(fd, STDOUT_FILENO);\n    dup2(fd, STDERR_FILENO);\n    close(fd);\n    execv(path, const_cast<char**>(args));\n\n    // execv() only returns if an error happened, in which case we\n    // panic and never fall through this conditional.\n    PLOG(FATAL) << \"execv(\\\"\" << path << \"\\\") failed\";\n\n    return 1;\n}\n```\n\n `/system/bin/init` main  `\"selinux_setup\"` SetupSelinux  SELinux \n\n\n\n### 2.2.1 \n\n Linux `chmod` \n\n\n\n\n\n#### 2.2.1.1 \n\n 10 \n\n```\n-rwxrwxrwx\n```\n\n\n\n- `-`\n- `d`\n- `c`\n\n 9  3 \n\n3  1  2  3 \n\n-  1  `r` `-`\n-  2  `w` `-`\n-  3  `x` `-`\n\n`-rwxrw-r--` \n\n\n\n#### 2.2.1.2 \n\n 4  1  3 \n\n 3  3 \n\n|                    |  |\n| :--------------------: | :--: |\n| 1004 |  r   |\n| 0102 |  w   |\n| 0011 |  x   |\n| 0000 |  -   |\n\n 0~7\n\n|                    |  |\n| :--------------------: | :--: |\n| 1117 | rwx  |\n| 1106 | rw-  |\n| 1015 | r-x  |\n| 0000 | ---  |\n\n\n\n|  |  |                                                          |\n| :--------: | :--------: | :----------------------------------------------------------: |\n| -rwxrwxrwx |    0777    |  |\n| -rwxrw-r-- |    0764    |  |\n\n\n\n#### 2.2.1.3 \n\n```c++\n// Don't expose the raw commandline to unprivileged processes.\nCHECKCALL(chmod(\"/proc/cmdline\", 0440));\n\n// Don't expose the raw bootconfig to unprivileged processes.\nchmod(\"/proc/bootconfig\", 0440);\n```\n\n `chmod`  `/proc/cmdline``/proc/bootconfig`  `0440` root  () \n\n\n\n## 2.3  SELinux\n\n<!-- TODO:  SELinux -->\n\n `int SetupSelinux(char** argv)`  SELinux  `system/core/init/selinux.cpp`\n\n```c++\n// This function initializes SELinux then execs init to run in the init SELinux context.\nint SetupSelinux(char** argv) {\n    ...\n\n    // Set up SELinux, loading the SELinux policy.\n    //  SELinux\n    SelinuxSetupKernelLogging();\n    SelinuxInitialize();\n\n    ...\n\n    //  /system/bin/init\n    //  second_stage,  SecondStageMain  [2.4]\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"second_stage\", nullptr};\n    execv(path, const_cast<char**>(args));\n\n    ...\n\n    return 1;\n}\n```\n\n SELinux `/system/bin/init` main  `\"second_stage\"` SecondStageMain \n\n\n\n## 2.4 \n\n<!-- TODO: property_load_boot_defaults -->\n\n<!-- TODO: , android  build.prop  -->\n\n<!-- TODO: SELinux  -->\n\n<!-- TODO: keyctl_get_keyring_ID(KEY_SPEC_SESSION_KEYRING, 1) -->\n\n<!-- TODO: InitializeSubcontext() -->\n\n<!-- TODO: ActionManager  ServiceList  -->\n\n `int SecondStageMain(int argc, char** argv)`  `system/core/init/init.cpp`\n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    // Set init and its forked children's oom_adj.\n    //  init  fork  oom_score_adj \n    // , \n    if (auto result = WriteFile(\"/proc/1/oom_score_adj\", \"-1000\"); !result) {\n        LOG(ERROR) << \"Unable to write -1000 to /proc/1/oom_score_adj: \" << result.error();\n    }\n\n    ...\n\n    //  [2.4.2.1]\n    property_init();\n\n    ...\n\n    //  epoll [2.4.1.1]\n    Epoll epoll;\n    if (auto result = epoll.Open(); !result) {\n        PLOG(FATAL) << result.error();\n    }\n\n    //  epoll  init  [2.4.3.1.3]\n    // \n    InstallSignalFdHandler(&epoll);\n\n    ...\n\n    //  [2.4.2.2]\n    StartPropertyService(&epoll);\n\n    ...\n\n    ActionManager& am = ActionManager::GetInstance();\n    ServiceList& sm = ServiceList::GetInstance();\n\n    //  [2.4.4]\n    LoadBootScripts(am, sm);\n\n    ...\n\n    //  Action [2.4.5.1]\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n    am.QueueEventTrigger(\"early-init\");\n    am.QueueBuiltinAction(wait_for_coldboot_done_action, \"wait_for_coldboot_done\");\n    ...\n    am.QueueBuiltinAction(queue_property_triggers_action, \"queue_property_triggers\");\n\n    //  [2.4.5]\n    while (true) {\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{};\n\n        if (do_shutdown && !shutting_down) {\n            do_shutdown = false;\n            if (HandlePowerctlMessage(shutdown_command)) {\n                shutting_down = true;\n            }\n        }\n\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            am.ExecuteOneCommand();\n        }\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            if (!shutting_down) {\n                auto next_process_action_time = HandleProcessActions();\n\n                if (next_process_action_time) {\n                    epoll_timeout = std::chrono::ceil<std::chrono::milliseconds>(\n                            *next_process_action_time - boot_clock::now());\n                    if (*epoll_timeout < 0ms) epoll_timeout = 0ms;\n                }\n            }\n\n            if (am.HasMoreCommands()) epoll_timeout = 0ms;\n        }\n\n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\n 5 \n\n- epoll\n\n- \n\n- \n\n- \n\n- \n\n 5 \n\n\n\n### 2.4.1 epoll\n\nepoll  Linux  I/O epoll \n\n\n\n#### 2.4.1.1 \n\n init epoll \n\n```c++\nEpoll epoll;\nif (auto result = epoll.Open(); !result) {\n    PLOG(FATAL) << result.error();\n}\n```\n\nepoll  Open  `system/core/init/epoll.cpp`\n\n```c++\nResult<Success> Epoll::Open() {\n    if (epoll_fd_ >= 0) return Success();\n\n    // \n    epoll_fd_.reset(epoll_create1(EPOLL_CLOEXEC));\n\n    if (epoll_fd_ == -1) {\n        return ErrnoError() << \"epoll_create1 failed\";\n    }\n    return Success();\n}\n```\n\n `epoll_create1``epoll_create1`  epoll \n\n\n\n#### 2.4.1.2  epoll \n\n epoll  RegisterHandler  epoll\n\n `system/core/init/epoll.cpp` epoll_ctl\n\n```c++\nResult<Success> Epoll::RegisterHandler(int fd, std::function<void()> handler, uint32_t events) {\n    ...\n\n    // \n    if (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &ev) == -1) {\n\n        ...\n\n        return result;\n    }\n    return Success();\n}\n```\n\n epoll_ctl \n\n\n\n##### 2.4.1.2.1  epoll_ctl\n\n**epoll_ctl**  `int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)` fd \n\n\n\n###### 2.4.1.2.1.1 \n\n epoll_ctl \n\n- **epfd**  epoll \n\n- **op** \n\n  - **EPOLL_CTL_ADD**\n\n     epoll \n\n  - **EPOLL_CTL_MOD**\n\n     epoll \n\n  - **EPOLL_CTL_DEL**\n\n     epoll \n\n- **fd** \n\n- **event**  epoll_event  epoll_event \n\n  ```c++\n  struct epoll_event {\n     uint32_t     events;      /* Epoll events */\n     epoll_data_t data;        /* User data variable */\n  };\n  ```\n\n   `events` \n\n  - \u0015\u0015**EPOLLIN**\n    \n\n  - **EPOLLOUT**\n    \n\n  - **EPOLLPRI**\n    \n\n  - **EPOLLERR**\n    \n\n  - **EPOLLHUP**\n    \n\n  - **EPOLLONESHOT**\n    epoll \n     epoll_ctl EPOLL_CTL_MOD \n\n   `data`  [2.4.1.3]`epoll_data_t` \n\n  ```c++\n  typedef union epoll_data {\n     void        *ptr;\n     int          fd;\n     uint32_t     u32;\n     uint64_t     u64;\n  } epoll_data_t;\n  ```\n\n\n\n###### 2.4.1.2.1.2 \n\n epoll_ctl \n\n-  0\n\n-  -1\n\n\n\n##### 2.4.1.2.2  RegisterHandler \n\n epoll_ctl  RegisterHandler  `system/core/init/epoll.h`\n\n```c++\nclass Epoll {\n  public:\n    Result<Success> RegisterHandler(int fd, std::function<void()> handler,\n                                    uint32_t events = EPOLLIN);\n};\n```\n\n `events`  `EPOLLIN`\n\n RegisterHandler \n\n```c++\nResult<Success> Epoll::RegisterHandler(int fd, std::function<void()> handler, uint32_t events) {\n    ...\n\n    // handler \n    auto [it, inserted] = epoll_handlers_.emplace(fd, std::move(handler));\n\n    ...\n\n    epoll_event ev;\n\n    // \n    //  events  EPOLLIN, \n    ev.events = events;\n  \n    // ,  [2.4.1.3.2]\n    ev.data.ptr = reinterpret_cast<void*>(&it->second);\n\n    //  epoll_ctl \n    //  EPOLL_CTL_ADD, \n    if (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &ev) == -1) {\n        Result<Success> result = ErrnoError() << \"epoll_ctl failed to add fd\";\n        epoll_handlers_.erase(fd);\n        return result;\n    }\n    return Success();\n}\n```\n\n `events`  `handler` `epoll_ctl`  epoll \n\n\n\n#### 2.4.1.3 \n\n epoll  epoll \n\n init \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    while (true) {\n        ...\n\n        // \n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\n Wait \n\n\n\n##### 2.4.1.3.1  epoll_wait\n\n Wait  epoll_wait Wait \n\n**epoll_wait**  `int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout)` epoll \n\n epoll_wait \n\n- \n- \n- \n\n\n\n###### 2.4.1.3.1.1 \n\n epoll_wait \n\n- **epfd**  epoll \n\n- **events**  epoll_event  epoll_event  [2.4.1.2.1] \n\n   events  epoll_event  data  epoll_ctl  data  epoll_ctl  event.data  epoll_wait \n\n- **maxevents**  events  maxevents\n\n- **timeout**  timeout = -1  timeout = 0 \n\n\n\n###### 2.4.1.3.1.2 \n\n epoll_wait \n\n-  I/O \n\n   0\n\n-  -1\n\n\n\n##### 2.4.1.3.2  Wait \n\n epoll_wait  Wait  `system/core/init/epoll.cpp`\n\n```c++\nResult<Success> Epoll::Wait(std::optional<std::chrono::milliseconds> timeout) {\n    //  -1\n    int timeout_ms = -1;\n\n    if (timeout && timeout->count() < INT_MAX) {\n        //  timeout  0 , \n        timeout_ms = timeout->count();\n    }\n\n    epoll_event ev;\n\n    //  epoll_wait \n    //  1,  1 \n    auto nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd_, &ev, 1, timeout_ms));\n\n    if (nr == -1) {\n        //  -1, \n        return ErrnoError() << \"epoll_wait failed\";\n    } else if (nr == 1) {\n        //  1, ,  1 \n        // ev.data.ptr  epoll_ctl , \n        std::invoke(*reinterpret_cast<std::function<void()>*>(ev.data.ptr));\n    }\n    return Success();\n}\n```\n\n `epoll_wait`  `epoll_wait`  epoll_ctl \n\n\n\n### 2.4.2 \n\n Android  key-value \n\n adb `getprop`\n\n```\n[ro.product.brand]: [Redmi]\n[ro.product.manufacturer]: [Xiaomi]\n[ro.product.marketname]: [Redmi K30S Ultra]\n[ro.product.model]: [M2007J3SC]\n[ro.product.name]: [apollo]\n\n[ro.product.cpu.abi]: [arm64-v8a]\n[ro.product.cpu.abilist]: [arm64-v8a,armeabi-v7a,armeabi]\n[ro.product.cpu.abilist32]: [armeabi-v7a,armeabi]\n[ro.product.cpu.abilist64]: [arm64-v8a]\n\n[dalvik.vm.heapsize]: [512m]\n[dalvik.vm.heapstartsize]: [8m]\n```\n\nCPU \n\n Java  `SystemProperties.get(String, String)`  ActivityManager \n\n```java\nstatic public int staticGetLargeMemoryClass() {\n    //  dalvik.vm.heapsize, \n    String vmHeapSize = SystemProperties.get(\"dalvik.vm.heapsize\", \"16m\");\n\n    return Integer.parseInt(vmHeapSize.substring(0, vmHeapSize.length() - 1));\n}\n```\n\n `SystemProperties.set(String, String)`  ActivityManagerService \n\n```java\nfinal void finishBooting() {\n    ...\n\n    synchronized (this) {\n\n        ...\n\n        // Tell anyone interested that we are done booting!\n        //  sys.boot_completed = 1, \n        SystemProperties.set(\"sys.boot_completed\", \"1\");\n\n        ...\n    }\n\n    ...\n}\n```\n\n\n\n#### 2.4.2.1 \n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: CreateSerializedPropertyInfo() -->\n\n<!-- TODO: property_info_area.LoadDefaultPath() -->\n\n property_init  `system/core/init/property_service.cpp`\n\n```c++\nvoid property_init() {\n    mkdir(\"/dev/__properties__\", S_IRWXU | S_IXGRP | S_IXOTH);\n    CreateSerializedPropertyInfo();\n\n    // \n    if (__system_property_area_init()) {\n        LOG(FATAL) << \"Failed to initialize property area\";\n    }\n\n    if (!property_info_area.LoadDefaultPath()) {\n        LOG(FATAL) << \"Failed to load serialized property info file\";\n    }\n}\n```\n\n `__system_property_area_init` \n\n\n\n#### 2.4.2.2 \n\n<!-- TODO: socket  -->\n\n<!-- TODO: listen(property_set_fd, 8) -->\n\n<!-- TODO:  init  -->\n\n StartPropertyService  `system/core/init/property_service.cpp`\n\n```c++\nvoid StartPropertyService(Epoll* epoll) {\n\n    ...\n\n    //  socket ,  PROP_SERVICE_NAME = \"property_service\"\n    property_set_fd = CreateSocket(PROP_SERVICE_NAME, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK,\n                                   false, 0666, 0, 0, nullptr);\n    if (property_set_fd == -1) {\n        PLOG(FATAL) << \"start_property_service socket creation failed\";\n    }\n\n    listen(property_set_fd, 8);\n\n    //  socket  epoll,  [2.4.1.2]\n    // handle_property_set_fd  [2.4.2.3]\n    if (auto result = epoll->RegisterHandler(property_set_fd, handle_property_set_fd); !result) {\n        PLOG(FATAL) << result.error();\n    }\n}\n```\n\n property_service  socket socket  epoll\n\n `handle_property_set_fd`\n\n\n\n#### 2.4.2.3  handle_property_set_fd\n\n<!-- TODO: ucred cr; socklen_t cr_size = sizeof(cr); -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  init ,  -->\n\n<!-- TODO:  -->\n\n `system/core/init/property_service.cpp`\n\n```c++\nstatic void handle_property_set_fd() {\n    // 2000ms\n    static constexpr uint32_t kDefaultSocketTimeout = 2000; /* ms */\n\n    ...\n\n    SocketConnection socket(s, cr);\n\n    //  2000ms \n    uint32_t timeout_ms = kDefaultSocketTimeout;\n\n    uint32_t cmd = 0;\n    if (!socket.RecvUint32(&cmd, &timeout_ms)) {\n        PLOG(ERROR) << \"sys_prop: error while reading command from the socket\";\n        socket.SendUint32(PROP_ERROR_READ_CMD);\n        return;\n    }\n\n    switch (cmd) {\n    //  PROP_MSG_SETPROP \n    case PROP_MSG_SETPROP: {\n        // PROP_NAME_MAX = 32\n        char prop_name[PROP_NAME_MAX];\n        char prop_value[PROP_VALUE_MAX];\n\n        // ,  prop_name  prop_value \n        if (!socket.RecvChars(prop_name, PROP_NAME_MAX, &timeout_ms) ||\n            !socket.RecvChars(prop_value, PROP_VALUE_MAX, &timeout_ms)) {\n          PLOG(ERROR) << \"sys_prop(PROP_MSG_SETPROP): error while reading name/value from the socket\";\n          return;\n        }\n\n        //  0\n        prop_name[PROP_NAME_MAX-1] = 0;\n        prop_value[PROP_VALUE_MAX-1] = 0;\n\n        const auto& cr = socket.cred();\n        std::string error;\n\n        // \n        uint32_t result =\n            HandlePropertySet(prop_name, prop_value, socket.source_context(), cr, &error);\n\n        if (result != PROP_SUCCESS) {\n            LOG(ERROR) << \"Unable to set property '\" << prop_name << \"' to '\" << prop_value\n                       << \"' from uid:\" << cr.uid << \" gid:\" << cr.gid << \" pid:\" << cr.pid << \": \"\n                       << error;\n        }\n\n        break;\n      }\n\n    //  PROP_MSG_SETPROP2 \n    case PROP_MSG_SETPROP2: {\n        std::string name;\n        std::string value;\n\n        // \n        if (!socket.RecvString(&name, &timeout_ms) ||\n            !socket.RecvString(&value, &timeout_ms)) {\n          PLOG(ERROR) << \"sys_prop(PROP_MSG_SETPROP2): error while reading name/value from the socket\";\n          socket.SendUint32(PROP_ERROR_READ_DATA);\n          return;\n        }\n\n        const auto& cr = socket.cred();\n        std::string error;\n\n        // \n        uint32_t result = HandlePropertySet(name, value, socket.source_context(), cr, &error);\n\n        if (result != PROP_SUCCESS) {\n            LOG(ERROR) << \"Unable to set property '\" << name << \"' to '\" << value\n                       << \"' from uid:\" << cr.uid << \" gid:\" << cr.gid << \" pid:\" << cr.pid << \": \"\n                       << error;\n        }\n        socket.SendUint32(result);\n        break;\n      }\n\n    default:\n        LOG(ERROR) << \"sys_prop: invalid command \" << cmd;\n        socket.SendUint32(PROP_ERROR_INVALID_CMD);\n        break;\n    }\n}\n```\n\n socket  `cmd` \n\n-  `PROP_MSG_SETPROP`  `PROP_NAME_MAX`  0 `PROP_NAME_MAX - 1` \n-  `PROP_MSG_SETPROP2`  `std::string` \n\n `PROP_MSG_SETPROP`  `PROP_MSG_SETPROP2`  `HandlePropertySet` \n\n\n\n### 2.4.3 \n\n** (Signals)**  IPC \n\n****\n\n\n\n#### 2.4.3.1 \n\n Linux (PID) waitwaitpid  waitid ** (Zombie process)**\n\n init init \n\n [2.4.4] init  fork servicemanager zygote  Android init \n\ninit \n\n Android Linux \n\n\n\n##### 2.4.3.1.1 \n\n<!-- :  -->\n\n\n\n- \u0015\u0015****\n- ****\n- ****\n\ninit \n\n\n\n\n\n##### 2.4.3.1.2  sigaction\n\n init  sigaction\n\n**sigaction**  `int sigaction(int signum, const struct sigaction *restrict act, struct sigaction *restrict oldact)`\n\n\n\n###### 2.4.3.1.2.1 \n\n sigaction \n\n- **signum** \n\n   AndroidARM  `bionic/libc/kernel/uapi/asm-arm/asm/signal.h` \n\n- **act**  sigaction  sigaction \n\n  ```c++\n  struct sigaction {\n     void     (*sa_handler)(int);\n     void     (*sa_sigaction)(int, siginfo_t *, void *);\n     sigset_t   sa_mask;\n     int        sa_flags;\n     void     (*sa_restorer)(void);\n  };\n  ```\n\n   `sa_handler`  `sa_flags`\n\n   `sa_handler` \n\n  - **SIG_DFL**\n\n    \n\n  - **SIG_IGN**\n\n    \n\n  - ****\n\n     signum \n\n   `sa_flags` \n\n  - **SA_NOCLDSTOP**\n\n     signum = SIGCHLD \n\n  - **SA_RESETHAND**\n\n    \n\n  - **SA_SIGINFO**\n\n     sa_handler  sa_sigaction\n\n- **oldact**  sigaction  sigaction  act\n\n\n\n###### 2.4.3.1.2.2 \n\n sigaction \n\n-  0\n\n-  -1\n\n\n\n##### 2.4.3.1.3 init \n\n sigaction  init \n\n\n\n###### 2.4.3.1.3.1  sigaction\n\ninit  InstallSignalFdHandler  `system/core/init/init.cpp`\n\n```c++\nstatic void InstallSignalFdHandler(Epoll* epoll) {\n    //  sigaction\n    //  sa_handler ,  sa_handler = SIG_DFL \n    //  sa_flags ,  sa_flags = SA_NOCLDSTOP  init , \n    const struct sigaction act { .sa_handler = SIG_DFL, .sa_flags = SA_NOCLDSTOP };\n\n    // sigaction ,  [2.4.3.1.2]\n    //  SIGCHLD,  SIGCHLD, , , , \n    sigaction(SIGCHLD, &act, nullptr);\n\n    ...\n\n}\n```\n\n sigaction `SIGCHLD`  `SIGCHLD` \n\n `SIGCHLD`  `SA_NOCLDSTOP`  init \n\ninit  signal  InstallSignalFdHandler \n\n\n\n###### 2.4.3.1.3.2  signal \n\n\n\nLinux  signalfd\n\ninit \n\n```c++\nstatic void InstallSignalFdHandler(Epoll* epoll) {\n\n    ...\n\n    // mask , \n    // ,  SIGCHLD\n    sigset_t mask;\n    sigemptyset(&mask);\n    sigaddset(&mask, SIGCHLD);\n\n    ...\n\n    //  signal \n    // ,  signalfd ,  -1, \n    signal_fd = signalfd(-1, &mask, SFD_CLOEXEC);\n\n    if (signal_fd == -1) {\n        PLOG(FATAL) << \"failed to create signalfd\";\n    }\n\n    //  signal  epoll,  [2.4.1.2]\n    // HandleSignalFd  [2.4.3.1.4]\n    if (auto result = epoll->RegisterHandler(signal_fd, HandleSignalFd); !result) {\n        LOG(FATAL) << result.error();\n    }\n}\n```\n\n `SIGCHLD` signal  epoll\n\n signal  HandleSignalFd \n\n\n\n##### 2.4.3.1.4  HandleSignalFd\n\n `system/core/init/init.cpp`\n\n```c++\nstatic void HandleSignalFd() {\n    signalfd_siginfo siginfo;\n\n    //  signal  signalfd_siginfo, \n    ssize_t bytes_read = TEMP_FAILURE_RETRY(read(signal_fd, &siginfo, sizeof(siginfo)));\n\n    if (bytes_read != sizeof(siginfo)) {\n        PLOG(ERROR) << \"Failed to read siginfo from signal_fd\";\n        return;\n    }\n\n    // \n    switch (siginfo.ssi_signo) {\n        case SIGCHLD:\n            ReapAnyOutstandingChildren();\n            break;\n        case SIGTERM:\n            HandleSigtermSignal(siginfo);\n            break;\n        default:\n            PLOG(ERROR) << \"signal_fd: received unexpected signal \" << siginfo.ssi_signo;\n            break;\n    }\n}\n```\n\nsignal  signalfd_siginfo HandleSignalFd  signal  signalfd_siginfo\n\n `SIGCHLD` ReapAnyOutstandingChildren \n\n\n\n###### 2.4.3.1.4.1  ReapAnyOutstandingChildren \n\n `system/core/init/sigchld_handler.cpp`\n\n```c++\nvoid ReapAnyOutstandingChildren() {\n    while (ReapOneProcess()) {\n    }\n}\n```\n\n ReapOneProcess  ReapOneProcess  false  ReapOneProcess \n\n\n\n###### 2.4.3.1.4.2  ReapOneProcess \n\n<!-- TODO:  service->flags() -->\n\n<!-- TODO:  ServiceList::GetInstance().RemoveService(*service) -->\n\n `system/core/init/sigchld_handler.cpp`\n\n```c++\nstatic bool ReapOneProcess() {\n    siginfo_t siginfo = {};\n\n    //  waitid, \n    //  init , ,  siginfo \n    if (TEMP_FAILURE_RETRY(waitid(P_ALL, 0, &siginfo, WEXITED | WNOHANG | WNOWAIT)) != 0) {\n        // ,  false\n        PLOG(ERROR) << \"waitid failed\";\n        return false;\n    }\n\n    //  pid\n    auto pid = siginfo.si_pid;\n\n    //  pid ,  false\n    if (pid == 0) return false;\n\n    ...\n\n    std::string name;\n    std::string wait_string;\n    Service* service = nullptr;\n\n    if (PropertyChildReap(pid)) {\n        name = \"Async property child\";\n    } else if (SubcontextChildReap(pid)) {\n        name = \"Subcontext\";\n    } else {\n        //  pid  service\n        service = ServiceList::GetInstance().FindService(pid, &Service::pid);\n\n        if (service) {\n            name = StringPrintf(\"Service '%s' (pid %d)\", service->name().c_str(), pid);\n\n            ...\n\n        } else {\n            name = StringPrintf(\"Untracked pid %d\", pid);\n        }\n    }\n\n    ...\n\n    //  service,  true\n    if (!service) return true;\n\n    //  service  Reap \n    service->Reap(siginfo);\n\n    ...\n\n    return true;\n}\n```\n\nReapOneProcess  waitid pid  service service  service  Reap  Reap \n\n\n\n###### 2.4.3.1.4.3  Reap \n\n `system/core/init/service.cpp`\n\n```c++\nvoid Service::Reap(const siginfo_t& siginfo) {\n    if (!(flags_ & SVC_ONESHOT) || (flags_ & SVC_RESTART)) {\n        //  SVC_ONESHOT  SVC_RESTART, \n        KillProcessGroup(SIGKILL);\n    }\n\n    ...\n\n    //  SVC_TEMPORARY, \n    if (flags_ & SVC_TEMPORARY) return;\n\n    // \n    pid_ = 0;\n    flags_ &= (~SVC_RUNNING);\n    start_order_ = 0;\n\n    if ((flags_ & SVC_ONESHOT) && !(flags_ & SVC_RESTART) && !(flags_ & SVC_RESET)) {\n        //  SVC_ONESHOT \n        flags_ |= SVC_DISABLED;\n    }\n\n    if (flags_ & (SVC_DISABLED | SVC_RESET))  {\n        //  SVC_DISABLED  SVC_RESET,  stopped , \n        NotifyStateChange(\"stopped\");\n        return;\n    }\n\n    //  SVC_CRITICAL \n    //  4  4 , \n    //  bootloader \n    boot_clock::time_point now = boot_clock::now();\n    if (((flags_ & SVC_CRITICAL) || !pre_apexd_) && !(flags_ & SVC_RESTART)) {\n        bool boot_completed = android::base::GetBoolProperty(\"sys.boot_completed\", false);\n        if (now < time_crashed_ + 4min || !boot_completed) {\n            if (++crash_count_ > 4) {\n                if (flags_ & SVC_CRITICAL) {\n                    // Aborts into bootloader\n                    LOG(FATAL) << \"critical process '\" << name_ << \"' exited 4 times \"\n                               << (boot_completed ? \"in 4 minutes\" : \"before boot completed\");\n                } else {\n                    LOG(ERROR) << \"updatable process '\" << name_ << \"' exited 4 times \"\n                               << (boot_completed ? \"in 4 minutes\" : \"before boot completed\");\n                    // Notifies update_verifier and apexd\n                    property_set(\"ro.init.updatable_crashing\", \"1\");\n                }\n            }\n        } else {\n            time_crashed_ = now;\n            crash_count_ = 1;\n        }\n    }\n\n    //  SVC_RESTARTING, init  [2.4.5.2]\n    flags_ &= (~SVC_RESTART);\n    flags_ |= SVC_RESTARTING;\n\n    //  service  onrestart \n    onrestart_.ExecuteAllCommands();\n\n    //  restarting \n    NotifyStateChange(\"restarting\");\n    return;\n}\n```\n\nReap  NotifyStateChange \n\n\n\n###### 2.4.3.1.4.4  NotifyStateChange \n\n `system/core/init/service.cpp`\n\n```c++\nvoid Service::NotifyStateChange(const std::string& new_state) const {\n    if ((flags_ & SVC_TEMPORARY) != 0) {\n        //  SVC_TEMPORARY, \n        return;\n    }\n\n    // \n    std::string prop_name = \"init.svc.\" + name_;\n    property_set(prop_name, new_state);\n\n    ...\n}\n```\n\n key-value  key  init.svc.[service_name]value  adb `getprop | grep init.svc.` service \n\n```\n[init.svc.adbd]: [running]\n[init.svc.alarm-hal-1-0]: [running]\n[init.svc.android.thermal-hal]: [running]\n[init.svc.apexd]: [stopped]\n[init.svc.apexd-bootstrap]: [stopped]\n[init.svc.apexd-snapshotde]: [stopped]\n[init.svc.audioserver]: [running]\n[init.svc.wifidisplayhalservice]: [running]\n[init.svc.wpa_supplicant]: [running]\n[init.svc.zygote]: [running]\n[init.svc.zygote_secondary]: [running]\n```\n\n\n\n### 2.4.4 \n\n<!-- TODO:  CreateParser -->\n\n<!-- TODO: .rc  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: /system/etc/init -->\n\n<!-- TODO: /odm/etc/init -->\n\n<!-- TODO: /vendor/etc/init -->\n\n LoadBootScripts  `system/core/init/init.cpp`\n\n```c++\nstatic void LoadBootScripts(ActionManager& action_manager, ServiceList& service_list) {\n    Parser parser = CreateParser(action_manager, service_list);\n\n    std::string bootscript = GetProperty(\"ro.boot.init_rc\", \"\");\n    if (bootscript.empty()) {\n        //  init.rc  [2.4.4.1]\n        parser.ParseConfig(\"/init.rc\");\n\n        //  /system/etc/init \n        if (!parser.ParseConfig(\"/system/etc/init\")) {\n            late_import_paths.emplace_back(\"/system/etc/init\");\n        }\n\n        //  /product/etc/init \n        if (!parser.ParseConfig(\"/product/etc/init\")) {\n            late_import_paths.emplace_back(\"/product/etc/init\");\n        }\n\n        //  /product_services/etc/init \n        if (!parser.ParseConfig(\"/product_services/etc/init\")) {\n            late_import_paths.emplace_back(\"/product_services/etc/init\");\n        }\n\n        //  /odm/etc/init \n        if (!parser.ParseConfig(\"/odm/etc/init\")) {\n            late_import_paths.emplace_back(\"/odm/etc/init\");\n        }\n\n        //  /vendor/etc/init \n        if (!parser.ParseConfig(\"/vendor/etc/init\")) {\n            late_import_paths.emplace_back(\"/vendor/etc/init\");\n        }\n    } else {\n        parser.ParseConfig(bootscript);\n    }\n}\n```\n\n\n\n- `init.rc`  .rc \n- `/system/etc/init/` SurfaceFlinger, MediaService, logcatd\n- `/vendor/etc/init/`  SoC  SoC \n- `/odm/etc/init/` \n\ninit.rc \n\n\n\n#### 2.4.4.1 init.rc \n\n Android .rc  Android Init Language [ Android Init Language ](https://cs.android.com/android/platform/superproject/+/android-security-10.0.0_r56:system/core/init/README.md)  AOSP  `system/core/init/README.md`\n\n\n\n\n\n##### 2.4.4.1.1 Android Init Language\n\nAndroid Init Language `Actions``Commands``Services``Options``Imports`\n\n\n\n-  token token \n-  token  c  `\\`  token\n-  `\\`\n-  `#` \n-  `${property.name}` `import /init.recovery.${ro.hardware}.rc`\n-  section `Actions`  `Services`  section `Commands`  `Options`  section section  `Commands`  `Options` \n- `Services`  `Services` \n\n\n\n\n\n###### 2.4.4.1.1.1 Actions\n\n`Actions`   `Commands`  `Triggers`  `Actions` \n\n```\non <trigger> [&& <trigger>]*\n   <command>\n   <command>\n   <command>\n```\n\n `Actions`   `Triggers` `Actions` \n\n `Actions`  `Actions`  `Commands`\n\n Zygote \n\n```\non zygote-start && property:ro.crypto.state=unencrypted\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n```\n\n\n\n `Actions`  `Triggers` `zygote-start`  `property:ro.crypto.state=unencrypted` `Command`\n\n `zygote-start`  `property:ro.crypto.state=unencrypted` `Actions`  `Actions`  `Commands`  `Actions`  `Commands`\n\n\n\n###### 2.4.4.1.1.2 Triggers\n\n`Triggers`  `Actions`  `Commands`\n\nTriggers \n\n- **Event triggers**\n\n   `trigger`   `QueueEventTrigger()` \n\n- **Property triggers**\n\n   `property:<key>=<value>`\n\n `Actions` \n\n\n\n`on init && property:a=b``on property:a=b && property:c=d` \n\n`on boot && on init` \n\n\n\n###### 2.4.4.1.1.3 Commands\n\n `Commands`\n\n- **trigger <event>**\n\n  \n\n- **write <path> <content>**\n\n   path \n\n- **chown <owner> <group> <path>**\n\n  \n\n- **mkdir <path> [mode] [owner] [group]**\n\n   \n\n   755 root  root \n\n  \n\n- **start <service>**\n\n  \n\n- **exec_start <service>**\n\n  \n\n- **setprop <name> <value>**\n\n  \n\n- **symlink <target> <path>**\n\n   path  target \n\n\n\n###### 2.4.4.1.1.4 Services\n\n`Services`  init  init  init  `Services`  fork \n\n`Services` \n\n`Services` \n\n```\nservice <name> <pathname> [ <argument> ]*\n   <option>\n   <option>\n   ...\n```\n\n Zygote 64 \n\n```\nservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server\n    class main\n    priority -20\n    user root\n    group root readproc reserved_disk\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n    onrestart write /sys/android_power/request_state wake\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n    writepid /dev/cpuset/foreground/tasks\n```\n\n`zygote`  `Services` `/system/bin/app_process64` `-Xzygote /system/bin --zygote --start-system-server`  `Options`\n\n\n\n###### 2.4.4.1.1.5 Options\n\n`Options`  `Services`  init  `Services` \n\n  `Options`\n\n- **class <name> [ <name>\\* ]**\n\n   `Services`  `Services`  () `Services`  ()  default\n\n- **class_start <serviceclass>**\n\n   `serviceclass`  `Services`\n\n- **priority <priority>**\n\n   `Services`  -20 ~ 19 0\n\n- **user <username>**\n\n   `Services`  root\n\n- **group <groupname> [ <groupname>\\* ]**\n\n   `Services`  root\n\n- **socket <name> <type> <perm> [ <user> [ <group> [ <seclabel> ] ] ]**\n\n   unix  socket `/dev/socket/<name>` socket \n\n- **onrestart**\n\n   `Services`  `Commands`\n\n- **oneshot**\n\n   `Services` \n\n- **writepid <file> [ <file>\\* ]**\n\n   fork  pid \n\n\n\n##### 2.4.4.1.2  init.rc \n\n init.rc  `system/core/rootdir/init.rc`\n\n  `Actions`  `Services`  init.rc  `Actions` [2.4.4.1.1.2]  `QueueEventTrigger()`   `Actions`   `Triggers` `Actions` \n\n\n\n###### 2.4.4.1.2.1 \n\n init  `system/core/init/init.cpp`  SecondStageMain \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n\n    ...\n\n    ActionManager& am = ActionManager::GetInstance();\n\n    ...\n\n    //  early-init  ActionManager\n    am.QueueEventTrigger(\"early-init\");\n\n    ...\n\n    // Trigger all the boot actions to get us started.\n    //  init  ActionManager\n    am.QueueEventTrigger(\"init\");\n\n    ...\n\n    // Don't mount filesystems or start core system services in charger mode.\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        // ,  charger  ActionManager\n        // , \n        am.QueueEventTrigger(\"charger\");\n    } else {\n        // ,  late-init  ActionManager\n        am.QueueEventTrigger(\"late-init\");\n    }\n\n    ...\n\n    return 0;\n}\n```\n\nActionManager  [2.4.5.x]\n\n- early-init -> init -> late-init\n- early-init -> init -> charger\n\n\n\n\n\n###### 2.4.4.1.2.2 init.rc \n\n<!-- TODO: trigger boot -->\n\n\n\n```\non early-init\n    ...\n\n    #  start  ueventd\n    start ueventd\n\n    #  exec_start  apexd-bootstrap, ,  APEX \n    exec_start apexd-bootstrap\n\non init\n    ...\n\n    #  start \n    #  servicemanager [2.4.4.1.2.3]\n    start servicemanager\n    start hwservicemanager\n    start vndservicemanager\n\n# \n#  trigger  [2.4.4.1.1.2]\non late-init\n    trigger early-fs\n    trigger fs\n    trigger post-fs\n    trigger late-fs\n    trigger post-fs-data\n    trigger load_persist_props_action\n\n    #  zygote-start,  zygote [2.4.4.1.2.4]\n    trigger zygote-start\n\n    trigger firmware_mounts_complete\n    trigger early-boot\n    trigger boot\n```\n\n servicemanager  zygote \n\n\n\n###### 2.4.4.1.2.3  servicemanager\n\nservicemanager  `frameworks/native/cmds/servicemanager/servicemanager.rc`\n\n```\n# servicemanager  Services \n# /system/bin/servicemanager \nservice servicemanager /system/bin/servicemanager\n    #  core  animation\n    #  core  animation  () , servicemanager  ()\n    class core animation\n\n    #  system\n    user system\n\n    #  system  readproc\n    group system readproc\n\n    # \n    # ,  bootloader\n    critical\n\n    # \n    #  Commands\n    onrestart restart healthd\n    onrestart restart zygote\n    onrestart restart audioserver\n    onrestart restart media\n    onrestart restart surfaceflinger\n    onrestart restart inputflinger\n    onrestart restart drm\n    onrestart restart cameraserver\n    onrestart restart keystore\n    onrestart restart gatekeeperd\n    onrestart restart thermalservice\n\n    #  fork  pid  /dev/cpuset/system-background/tasks\n    writepid /dev/cpuset/system-background/tasks\n\n    # \n    # shutdown critical , \n    shutdown critical\n```\n\n servicemanager  `frameworks/native/cmds/servicemanager/service_manager.c`  main \n\n\n\n###### 2.4.4.1.2.4  zygote\n\n init.rc  `zygote-start`  3  `Actions`\n\n```\non zygote-start && property:ro.crypto.state=unencrypted\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n\non zygote-start && property:ro.crypto.state=unsupported\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n\non zygote-start && property:ro.crypto.state=encrypted && property:ro.crypto.type=file\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n```\n\nzygote \n\n```\nimport /init.${ro.zygote}.rc\n```\n\n `ro.zygote`\n\n```\nsystem/core/rootdir/init.zygote32.rc\nsystem/core/rootdir/init.zygote32_64.rc\nsystem/core/rootdir/init.zygote64.rc\nsystem/core/rootdir/init.zygote64_32.rc\n```\n\nzygote  `zygote-start`  `Actions`  zygote\n\n Zygote 64  `system/core/rootdir/init.zygote64.rc`\n\n```\n# zygote  Services \n# /system/bin/app_process64 \n# -Xzygote /system/bin --zygote --start-system-server \nservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server\n    #  main\n    #  main  () , zygote  ()\n    class main\n\n    #  -20\n    #  -20 ~ 19, , ,  zygote \n    priority -20\n\n    #  root\n    user root\n    group root readproc reserved_disk\n\n    #  socket\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n\n    # \n    #  Commands\n    onrestart write /sys/android_power/request_state wake\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n\n    #  zygote  fork  pid  /dev/cpuset/foreground/tasks\n    writepid /dev/cpuset/foreground/tasks\n```\n\n zygote  `frameworks/base/cmds/app_process/app_main.cpp`  main \n\n\n\n### 2.4.5 \n\ninit  `system/core/init/init.cpp`\n\n```c++\nint SecondStageMain(int argc, char** argv) {\n\n    ...\n\n    while (true) {\n        //  epoll \n        // , ,  epoll_timeout  -1\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{};\n\n        ...\n\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            // am ,  ActionManager \n            //  ActionManager  [2.4.5.1]\n            am.ExecuteOneCommand();\n        }\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            if (!shutting_down) {\n                //  HandleProcessActions  [2.4.5.2]\n                auto next_process_action_time = HandleProcessActions();\n\n                if (next_process_action_time) {\n                    //  next_process_action_time \n                    epoll_timeout = std::chrono::ceil<std::chrono::milliseconds>(\n                            *next_process_action_time - boot_clock::now());\n\n                    //  0, \n                    //  epoll  0,  Wait , \n                    if (*epoll_timeout < 0ms) epoll_timeout = 0ms;\n                }\n            }\n\n            //  ActionManager ,  init , \n            //  epoll  0,  Wait , \n            if (am.HasMoreCommands()) epoll_timeout = 0ms;\n        }\n\n        //  Wait ,  [2.4.1.3]\n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\ninit  3 \n\n-  ActionManager \n- \n-  epoll  init  init  `SIGCHLD` \n\n\n\n#### 2.4.5.1 ActionManager\n\n<!-- TODO:  Action? -->\n\n<!-- TODO: Action  Actions  -->\n\n<!-- TODO:  -->\n\nActionManager  Action  Action \n\n\n\n##### 2.4.5.1.1  Action\n\n<!-- TODO:  Action  -->\n\n init  Action Action \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    // am ,  ActionManager \n    ActionManager& am = ActionManager::GetInstance();\n\n    ...\n\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n\n    //  Action:  early-init [2.4.4.1.2.1]\n    am.QueueEventTrigger(\"early-init\");\n\n    //  Action:  coldboot \n    am.QueueBuiltinAction(wait_for_coldboot_done_action, \"wait_for_coldboot_done\");\n\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n    am.QueueBuiltinAction(SetMmapRndBitsAction, \"SetMmapRndBits\");\n    am.QueueBuiltinAction(SetKptrRestrictAction, \"SetKptrRestrict\");\n    Keychords keychords;\n    am.QueueBuiltinAction(\n        [&epoll, &keychords](const BuiltinArguments& args) -> Result<Success> {\n            for (const auto& svc : ServiceList::GetInstance()) {\n                keychords.Register(svc->keycodes());\n            }\n            keychords.Start(&epoll, HandleKeychord);\n            return Success();\n        },\n        \"KeychordInit\");\n    am.QueueBuiltinAction(console_init_action, \"console_init\");\n\n    //  Action:  init [2.4.4.1.2.1]\n    am.QueueEventTrigger(\"init\");\n\n    am.QueueBuiltinAction(StartBoringSslSelfTest, \"StartBoringSslSelfTest\");\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n\n    //  Action:  init  binder\n    am.QueueBuiltinAction(InitBinder, \"InitBinder\");\n\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        // ,  Action:  charger [2.4.4.1.2.1]\n        am.QueueEventTrigger(\"charger\");\n    } else {\n        // ,  Action:  late-init [2.4.4.1.2.1]\n        am.QueueEventTrigger(\"late-init\");\n    }\n\n    //  Action: \n    am.QueueBuiltinAction(queue_property_triggers_action, \"queue_property_triggers\");\n\n    ...\n\n}\n```\n\n ActionManager  Action\n\n\n\n#### 2.4.5.2 HandleProcessActions\n\n<!-- ((s->flags() & SVC_RUNNING) && s->timeout_period()) -->\n\n<!--  service  -->\n\n```c++\nstatic std::optional<boot_clock::time_point> HandleProcessActions() {\n    std::optional<boot_clock::time_point> next_process_action_time;\n\n    //  ServiceList\n    for (const auto& s : ServiceList::GetInstance()) {\n        // , \n        if ((s->flags() & SVC_RUNNING) && s->timeout_period()) {\n            // \n            auto timeout_time = s->time_started() + *s->timeout_period();\n\n            if (boot_clock::now() > timeout_time) {\n                // , \n                s->Timeout();\n            } else {\n                //  next_process_action_time\n                // , next_process_action_time , \n                if (!next_process_action_time || timeout_time < *next_process_action_time) {\n                    next_process_action_time = timeout_time;\n                }\n            }\n        }\n\n        //  SVC_RESTARTING, ,  for \n        if (!(s->flags() & SVC_RESTARTING)) continue;\n\n        // \n        auto restart_time = s->time_started() + s->restart_period();\n\n        // , \n        if (boot_clock::now() > restart_time) {\n            // , \n            if (auto result = s->Start(); !result) {\n                LOG(ERROR) << \"Could not restart process '\" << s->name() << \"': \" << result.error();\n            }\n        } else {\n            //  next_process_action_time\n            // , next_process_action_time , \n            if (!next_process_action_time || restart_time < *next_process_action_time) {\n                next_process_action_time = restart_time;\n            }\n        }\n    }\n    return next_process_action_time;\n}\n```\n\n\n\n1.  `SVC_RUNNING`  `Timeout` \n2.  `SVC_RESTARTING`  \n\n`next_process_action_time` \n\n [2.4.3.1.4.3]  init  `SVC_RESTARTING` init  `SVC_RESTARTING` \n\n\n\n# \n\n[Android-](http://gityuan.com/2016/02/01/android-booting/)\n\n[Android-Init](http://gityuan.com/2016/02/05/android-init/)\n\n[epoll(7)](https://man7.org/linux/man-pages/man7/epoll.7.html)\n\n[Signal](https://en.wikipedia.org/wiki/Signal_(IPC))\n\n[signal(7)](https://man7.org/linux/man-pages/man7/signal.7.html)\n\n[wait(2)](https://man7.org/linux/man-pages/man2/wait.2.html)\n\n[signalfd(2)](https://man7.org/linux/man-pages/man2/signalfd.2.html)\n\n","source":"_drafts/exploring-init-process-startup-process.md","raw":"---\ntitle:  init \ncategories:\n- [Android]\n---\n\n\n\n> android-security-10.0.0_r56\n\n\n\n# 1. \n\n<!-- TODO:  init  -->\n\nAndroid  Linux  init \n\ninit  pid = 1\n\n<!-- more -->\n\n\n\n# 2. \n\n<!-- TODO:  -->\n\n\n\n## 2.1 init \n\n<!-- TODO:  -->\n\n<!-- TODO: init ,  /system/core/init -->\n\n Android 9init  `system/core/init/init.cpp`  main \n\n Android 10 init  `system/core/init/main.cpp`  main \n\n```c++\nint main(int argc, char** argv) {\n    ...\n\n    if (!strcmp(basename(argv[0]), \"ueventd\")) {\n        return ueventd_main(argc, argv);\n    }\n\n    if (argc > 1) {\n        if (!strcmp(argv[1], \"subcontext\")) {\n            android::base::InitLogging(argv, &android::base::KernelLogger);\n            const BuiltinFunctionMap& function_map = GetBuiltinFunctionMap();\n\n            return SubcontextMain(argc, argv, &function_map);\n        }\n\n        if (!strcmp(argv[1], \"selinux_setup\")) {\n            return SetupSelinux(argv);\n        }\n\n        if (!strcmp(argv[1], \"second_stage\")) {\n            return SecondStageMain(argc, argv);\n        }\n    }\n\n    return FirstStageMain(argc, argv);\n}\n```\n\n`basename`  `strcmp` \n\n- `basename`  `char* basename(char* __path)` \"/system/bin/ueventd\" \"ueventd\"\n- `strcmp`  `int strcmp(const char* __lhs, const char* __rhs)` 0\n\n main  `argc`  `argv` `FirstStageMain` \n\n\n\n## 2.2 \n\n<!-- TODO: mkdir, mknod, tmpfs -->\n\n<!-- TODO:  -->\n\n<!-- TODO: KernelLogging(/dev/kmsg) -->\n\n<!-- TODO: InstallRebootSignalHandlers -->\n\n `int FirstStageMain(int argc, char** argv)`  `system/core/init/first_stage_init.cpp`\n\n```c++\nint FirstStageMain(int argc, char** argv) {\n    ...\n\n    CHECKCALL(clearenv());\n    CHECKCALL(setenv(\"PATH\", _PATH_DEFPATH, 1));\n    // Get the basic filesystem setup we need put together in the initramdisk\n    // on / and then we'll let the rc file figure out the rest.\n    CHECKCALL(mount(\"tmpfs\", \"/dev\", \"tmpfs\", MS_NOSUID, \"mode=0755\"));\n    CHECKCALL(mkdir(\"/dev/pts\", 0755));\n    CHECKCALL(mkdir(\"/dev/socket\", 0755));\n    CHECKCALL(mkdir(\"/dev/dm-user\", 0755));\n    CHECKCALL(mount(\"devpts\", \"/dev/pts\", \"devpts\", 0, NULL));\n#define MAKE_STR(x) __STRING(x)\n    CHECKCALL(mount(\"proc\", \"/proc\", \"proc\", 0, \"hidepid=2,gid=\" MAKE_STR(AID_READPROC)));\n#undef MAKE_STR\n\n    // Don't expose the raw commandline to unprivileged processes.\n    //  [2.2.1]\n    CHECKCALL(chmod(\"/proc/cmdline\", 0440));\n    std::string cmdline;\n    android::base::ReadFileToString(\"/proc/cmdline\", &cmdline);\n    // Don't expose the raw bootconfig to unprivileged processes.\n    chmod(\"/proc/bootconfig\", 0440);\n    std::string bootconfig;\n    android::base::ReadFileToString(\"/proc/bootconfig\", &bootconfig);\n    gid_t groups[] = {AID_READPROC};\n    CHECKCALL(setgroups(arraysize(groups), groups));\n    CHECKCALL(mount(\"sysfs\", \"/sys\", \"sysfs\", 0, NULL));\n    CHECKCALL(mount(\"selinuxfs\", \"/sys/fs/selinux\", \"selinuxfs\", 0, NULL));\n\n    CHECKCALL(mknod(\"/dev/kmsg\", S_IFCHR | 0600, makedev(1, 11)));\n\n    if constexpr (WORLD_WRITABLE_KMSG) {\n        CHECKCALL(mknod(\"/dev/kmsg_debug\", S_IFCHR | 0622, makedev(1, 11)));\n    }\n\n    CHECKCALL(mknod(\"/dev/random\", S_IFCHR | 0666, makedev(1, 8)));\n    CHECKCALL(mknod(\"/dev/urandom\", S_IFCHR | 0666, makedev(1, 9)));\n\n    // This is needed for log wrapper, which gets called before ueventd runs.\n    CHECKCALL(mknod(\"/dev/ptmx\", S_IFCHR | 0666, makedev(5, 2)));\n    CHECKCALL(mknod(\"/dev/null\", S_IFCHR | 0666, makedev(1, 3)));\n\n    // These below mounts are done in first stage init so that first stage mount can mount\n    // subdirectories of /mnt/{vendor,product}/.  Other mounts, not required by first stage mount,\n    // should be done in rc files.\n    // Mount staging areas for devices managed by vold\n    // See storage config details at http://source.android.com/devices/storage/\n    CHECKCALL(mount(\"tmpfs\", \"/mnt\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=1000\"));\n    // /mnt/vendor is used to mount vendor-specific partitions that can not be\n    // part of the vendor partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/vendor\", 0755));\n    // /mnt/product is used to mount product-specific partitions that can not be\n    // part of the product partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/product\", 0755));\n\n    // /debug_ramdisk is used to preserve additional files from the debug ramdisk\n    CHECKCALL(mount(\"tmpfs\", \"/debug_ramdisk\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"));\n\n    // /second_stage_resources is used to preserve files from first to second\n    // stage init\n    CHECKCALL(mount(\"tmpfs\", kSecondStageRes, \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"))\n#undef CHECKCALL\n\n    SetStdioToDevNull(argv);\n    // Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually\n    // talk to the outside world...\n    InitKernelLogging(argv);\n\n    if (!errors.empty()) {\n        for (const auto& [error_string, error_errno] : errors) {\n            LOG(ERROR) << error_string << \" \" << strerror(error_errno);\n        }\n        LOG(FATAL) << \"Init encountered errors starting first stage, aborting\";\n    }\n\n    LOG(INFO) << \"init first stage started!\";\n\n    ...\n\n    //  /system/bin/init\n    //  selinux_setup,  SetupSelinux  SELinux  [2.3]\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"selinux_setup\", nullptr};\n    auto fd = open(\"/dev/kmsg\", O_WRONLY | O_CLOEXEC);\n    dup2(fd, STDOUT_FILENO);\n    dup2(fd, STDERR_FILENO);\n    close(fd);\n    execv(path, const_cast<char**>(args));\n\n    // execv() only returns if an error happened, in which case we\n    // panic and never fall through this conditional.\n    PLOG(FATAL) << \"execv(\\\"\" << path << \"\\\") failed\";\n\n    return 1;\n}\n```\n\n `/system/bin/init` main  `\"selinux_setup\"` SetupSelinux  SELinux \n\n\n\n### 2.2.1 \n\n Linux `chmod` \n\n\n\n\n\n#### 2.2.1.1 \n\n 10 \n\n```\n-rwxrwxrwx\n```\n\n\n\n- `-`\n- `d`\n- `c`\n\n 9  3 \n\n3  1  2  3 \n\n-  1  `r` `-`\n-  2  `w` `-`\n-  3  `x` `-`\n\n`-rwxrw-r--` \n\n\n\n#### 2.2.1.2 \n\n 4  1  3 \n\n 3  3 \n\n|                    |  |\n| :--------------------: | :--: |\n| 1004 |  r   |\n| 0102 |  w   |\n| 0011 |  x   |\n| 0000 |  -   |\n\n 0~7\n\n|                    |  |\n| :--------------------: | :--: |\n| 1117 | rwx  |\n| 1106 | rw-  |\n| 1015 | r-x  |\n| 0000 | ---  |\n\n\n\n|  |  |                                                          |\n| :--------: | :--------: | :----------------------------------------------------------: |\n| -rwxrwxrwx |    0777    |  |\n| -rwxrw-r-- |    0764    |  |\n\n\n\n#### 2.2.1.3 \n\n```c++\n// Don't expose the raw commandline to unprivileged processes.\nCHECKCALL(chmod(\"/proc/cmdline\", 0440));\n\n// Don't expose the raw bootconfig to unprivileged processes.\nchmod(\"/proc/bootconfig\", 0440);\n```\n\n `chmod`  `/proc/cmdline``/proc/bootconfig`  `0440` root  () \n\n\n\n## 2.3  SELinux\n\n<!-- TODO:  SELinux -->\n\n `int SetupSelinux(char** argv)`  SELinux  `system/core/init/selinux.cpp`\n\n```c++\n// This function initializes SELinux then execs init to run in the init SELinux context.\nint SetupSelinux(char** argv) {\n    ...\n\n    // Set up SELinux, loading the SELinux policy.\n    //  SELinux\n    SelinuxSetupKernelLogging();\n    SelinuxInitialize();\n\n    ...\n\n    //  /system/bin/init\n    //  second_stage,  SecondStageMain  [2.4]\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"second_stage\", nullptr};\n    execv(path, const_cast<char**>(args));\n\n    ...\n\n    return 1;\n}\n```\n\n SELinux `/system/bin/init` main  `\"second_stage\"` SecondStageMain \n\n\n\n## 2.4 \n\n<!-- TODO: property_load_boot_defaults -->\n\n<!-- TODO: , android  build.prop  -->\n\n<!-- TODO: SELinux  -->\n\n<!-- TODO: keyctl_get_keyring_ID(KEY_SPEC_SESSION_KEYRING, 1) -->\n\n<!-- TODO: InitializeSubcontext() -->\n\n<!-- TODO: ActionManager  ServiceList  -->\n\n `int SecondStageMain(int argc, char** argv)`  `system/core/init/init.cpp`\n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    // Set init and its forked children's oom_adj.\n    //  init  fork  oom_score_adj \n    // , \n    if (auto result = WriteFile(\"/proc/1/oom_score_adj\", \"-1000\"); !result) {\n        LOG(ERROR) << \"Unable to write -1000 to /proc/1/oom_score_adj: \" << result.error();\n    }\n\n    ...\n\n    //  [2.4.2.1]\n    property_init();\n\n    ...\n\n    //  epoll [2.4.1.1]\n    Epoll epoll;\n    if (auto result = epoll.Open(); !result) {\n        PLOG(FATAL) << result.error();\n    }\n\n    //  epoll  init  [2.4.3.1.3]\n    // \n    InstallSignalFdHandler(&epoll);\n\n    ...\n\n    //  [2.4.2.2]\n    StartPropertyService(&epoll);\n\n    ...\n\n    ActionManager& am = ActionManager::GetInstance();\n    ServiceList& sm = ServiceList::GetInstance();\n\n    //  [2.4.4]\n    LoadBootScripts(am, sm);\n\n    ...\n\n    //  Action [2.4.5.1]\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n    am.QueueEventTrigger(\"early-init\");\n    am.QueueBuiltinAction(wait_for_coldboot_done_action, \"wait_for_coldboot_done\");\n    ...\n    am.QueueBuiltinAction(queue_property_triggers_action, \"queue_property_triggers\");\n\n    //  [2.4.5]\n    while (true) {\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{};\n\n        if (do_shutdown && !shutting_down) {\n            do_shutdown = false;\n            if (HandlePowerctlMessage(shutdown_command)) {\n                shutting_down = true;\n            }\n        }\n\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            am.ExecuteOneCommand();\n        }\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            if (!shutting_down) {\n                auto next_process_action_time = HandleProcessActions();\n\n                if (next_process_action_time) {\n                    epoll_timeout = std::chrono::ceil<std::chrono::milliseconds>(\n                            *next_process_action_time - boot_clock::now());\n                    if (*epoll_timeout < 0ms) epoll_timeout = 0ms;\n                }\n            }\n\n            if (am.HasMoreCommands()) epoll_timeout = 0ms;\n        }\n\n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\n 5 \n\n- epoll\n\n- \n\n- \n\n- \n\n- \n\n 5 \n\n\n\n### 2.4.1 epoll\n\nepoll  Linux  I/O epoll \n\n\n\n#### 2.4.1.1 \n\n init epoll \n\n```c++\nEpoll epoll;\nif (auto result = epoll.Open(); !result) {\n    PLOG(FATAL) << result.error();\n}\n```\n\nepoll  Open  `system/core/init/epoll.cpp`\n\n```c++\nResult<Success> Epoll::Open() {\n    if (epoll_fd_ >= 0) return Success();\n\n    // \n    epoll_fd_.reset(epoll_create1(EPOLL_CLOEXEC));\n\n    if (epoll_fd_ == -1) {\n        return ErrnoError() << \"epoll_create1 failed\";\n    }\n    return Success();\n}\n```\n\n `epoll_create1``epoll_create1`  epoll \n\n\n\n#### 2.4.1.2  epoll \n\n epoll  RegisterHandler  epoll\n\n `system/core/init/epoll.cpp` epoll_ctl\n\n```c++\nResult<Success> Epoll::RegisterHandler(int fd, std::function<void()> handler, uint32_t events) {\n    ...\n\n    // \n    if (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &ev) == -1) {\n\n        ...\n\n        return result;\n    }\n    return Success();\n}\n```\n\n epoll_ctl \n\n\n\n##### 2.4.1.2.1  epoll_ctl\n\n**epoll_ctl**  `int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)` fd \n\n\n\n###### 2.4.1.2.1.1 \n\n epoll_ctl \n\n- **epfd**  epoll \n\n- **op** \n\n  - **EPOLL_CTL_ADD**\n\n     epoll \n\n  - **EPOLL_CTL_MOD**\n\n     epoll \n\n  - **EPOLL_CTL_DEL**\n\n     epoll \n\n- **fd** \n\n- **event**  epoll_event  epoll_event \n\n  ```c++\n  struct epoll_event {\n     uint32_t     events;      /* Epoll events */\n     epoll_data_t data;        /* User data variable */\n  };\n  ```\n\n   `events` \n\n  - \u0015\u0015**EPOLLIN**\n    \n\n  - **EPOLLOUT**\n    \n\n  - **EPOLLPRI**\n    \n\n  - **EPOLLERR**\n    \n\n  - **EPOLLHUP**\n    \n\n  - **EPOLLONESHOT**\n    epoll \n     epoll_ctl EPOLL_CTL_MOD \n\n   `data`  [2.4.1.3]`epoll_data_t` \n\n  ```c++\n  typedef union epoll_data {\n     void        *ptr;\n     int          fd;\n     uint32_t     u32;\n     uint64_t     u64;\n  } epoll_data_t;\n  ```\n\n\n\n###### 2.4.1.2.1.2 \n\n epoll_ctl \n\n-  0\n\n-  -1\n\n\n\n##### 2.4.1.2.2  RegisterHandler \n\n epoll_ctl  RegisterHandler  `system/core/init/epoll.h`\n\n```c++\nclass Epoll {\n  public:\n    Result<Success> RegisterHandler(int fd, std::function<void()> handler,\n                                    uint32_t events = EPOLLIN);\n};\n```\n\n `events`  `EPOLLIN`\n\n RegisterHandler \n\n```c++\nResult<Success> Epoll::RegisterHandler(int fd, std::function<void()> handler, uint32_t events) {\n    ...\n\n    // handler \n    auto [it, inserted] = epoll_handlers_.emplace(fd, std::move(handler));\n\n    ...\n\n    epoll_event ev;\n\n    // \n    //  events  EPOLLIN, \n    ev.events = events;\n  \n    // ,  [2.4.1.3.2]\n    ev.data.ptr = reinterpret_cast<void*>(&it->second);\n\n    //  epoll_ctl \n    //  EPOLL_CTL_ADD, \n    if (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &ev) == -1) {\n        Result<Success> result = ErrnoError() << \"epoll_ctl failed to add fd\";\n        epoll_handlers_.erase(fd);\n        return result;\n    }\n    return Success();\n}\n```\n\n `events`  `handler` `epoll_ctl`  epoll \n\n\n\n#### 2.4.1.3 \n\n epoll  epoll \n\n init \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    while (true) {\n        ...\n\n        // \n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\n Wait \n\n\n\n##### 2.4.1.3.1  epoll_wait\n\n Wait  epoll_wait Wait \n\n**epoll_wait**  `int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout)` epoll \n\n epoll_wait \n\n- \n- \n- \n\n\n\n###### 2.4.1.3.1.1 \n\n epoll_wait \n\n- **epfd**  epoll \n\n- **events**  epoll_event  epoll_event  [2.4.1.2.1] \n\n   events  epoll_event  data  epoll_ctl  data  epoll_ctl  event.data  epoll_wait \n\n- **maxevents**  events  maxevents\n\n- **timeout**  timeout = -1  timeout = 0 \n\n\n\n###### 2.4.1.3.1.2 \n\n epoll_wait \n\n-  I/O \n\n   0\n\n-  -1\n\n\n\n##### 2.4.1.3.2  Wait \n\n epoll_wait  Wait  `system/core/init/epoll.cpp`\n\n```c++\nResult<Success> Epoll::Wait(std::optional<std::chrono::milliseconds> timeout) {\n    //  -1\n    int timeout_ms = -1;\n\n    if (timeout && timeout->count() < INT_MAX) {\n        //  timeout  0 , \n        timeout_ms = timeout->count();\n    }\n\n    epoll_event ev;\n\n    //  epoll_wait \n    //  1,  1 \n    auto nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd_, &ev, 1, timeout_ms));\n\n    if (nr == -1) {\n        //  -1, \n        return ErrnoError() << \"epoll_wait failed\";\n    } else if (nr == 1) {\n        //  1, ,  1 \n        // ev.data.ptr  epoll_ctl , \n        std::invoke(*reinterpret_cast<std::function<void()>*>(ev.data.ptr));\n    }\n    return Success();\n}\n```\n\n `epoll_wait`  `epoll_wait`  epoll_ctl \n\n\n\n### 2.4.2 \n\n Android  key-value \n\n adb `getprop`\n\n```\n[ro.product.brand]: [Redmi]\n[ro.product.manufacturer]: [Xiaomi]\n[ro.product.marketname]: [Redmi K30S Ultra]\n[ro.product.model]: [M2007J3SC]\n[ro.product.name]: [apollo]\n\n[ro.product.cpu.abi]: [arm64-v8a]\n[ro.product.cpu.abilist]: [arm64-v8a,armeabi-v7a,armeabi]\n[ro.product.cpu.abilist32]: [armeabi-v7a,armeabi]\n[ro.product.cpu.abilist64]: [arm64-v8a]\n\n[dalvik.vm.heapsize]: [512m]\n[dalvik.vm.heapstartsize]: [8m]\n```\n\nCPU \n\n Java  `SystemProperties.get(String, String)`  ActivityManager \n\n```java\nstatic public int staticGetLargeMemoryClass() {\n    //  dalvik.vm.heapsize, \n    String vmHeapSize = SystemProperties.get(\"dalvik.vm.heapsize\", \"16m\");\n\n    return Integer.parseInt(vmHeapSize.substring(0, vmHeapSize.length() - 1));\n}\n```\n\n `SystemProperties.set(String, String)`  ActivityManagerService \n\n```java\nfinal void finishBooting() {\n    ...\n\n    synchronized (this) {\n\n        ...\n\n        // Tell anyone interested that we are done booting!\n        //  sys.boot_completed = 1, \n        SystemProperties.set(\"sys.boot_completed\", \"1\");\n\n        ...\n    }\n\n    ...\n}\n```\n\n\n\n#### 2.4.2.1 \n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: CreateSerializedPropertyInfo() -->\n\n<!-- TODO: property_info_area.LoadDefaultPath() -->\n\n property_init  `system/core/init/property_service.cpp`\n\n```c++\nvoid property_init() {\n    mkdir(\"/dev/__properties__\", S_IRWXU | S_IXGRP | S_IXOTH);\n    CreateSerializedPropertyInfo();\n\n    // \n    if (__system_property_area_init()) {\n        LOG(FATAL) << \"Failed to initialize property area\";\n    }\n\n    if (!property_info_area.LoadDefaultPath()) {\n        LOG(FATAL) << \"Failed to load serialized property info file\";\n    }\n}\n```\n\n `__system_property_area_init` \n\n\n\n#### 2.4.2.2 \n\n<!-- TODO: socket  -->\n\n<!-- TODO: listen(property_set_fd, 8) -->\n\n<!-- TODO:  init  -->\n\n StartPropertyService  `system/core/init/property_service.cpp`\n\n```c++\nvoid StartPropertyService(Epoll* epoll) {\n\n    ...\n\n    //  socket ,  PROP_SERVICE_NAME = \"property_service\"\n    property_set_fd = CreateSocket(PROP_SERVICE_NAME, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK,\n                                   false, 0666, 0, 0, nullptr);\n    if (property_set_fd == -1) {\n        PLOG(FATAL) << \"start_property_service socket creation failed\";\n    }\n\n    listen(property_set_fd, 8);\n\n    //  socket  epoll,  [2.4.1.2]\n    // handle_property_set_fd  [2.4.2.3]\n    if (auto result = epoll->RegisterHandler(property_set_fd, handle_property_set_fd); !result) {\n        PLOG(FATAL) << result.error();\n    }\n}\n```\n\n property_service  socket socket  epoll\n\n `handle_property_set_fd`\n\n\n\n#### 2.4.2.3  handle_property_set_fd\n\n<!-- TODO: ucred cr; socklen_t cr_size = sizeof(cr); -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  init ,  -->\n\n<!-- TODO:  -->\n\n `system/core/init/property_service.cpp`\n\n```c++\nstatic void handle_property_set_fd() {\n    // 2000ms\n    static constexpr uint32_t kDefaultSocketTimeout = 2000; /* ms */\n\n    ...\n\n    SocketConnection socket(s, cr);\n\n    //  2000ms \n    uint32_t timeout_ms = kDefaultSocketTimeout;\n\n    uint32_t cmd = 0;\n    if (!socket.RecvUint32(&cmd, &timeout_ms)) {\n        PLOG(ERROR) << \"sys_prop: error while reading command from the socket\";\n        socket.SendUint32(PROP_ERROR_READ_CMD);\n        return;\n    }\n\n    switch (cmd) {\n    //  PROP_MSG_SETPROP \n    case PROP_MSG_SETPROP: {\n        // PROP_NAME_MAX = 32\n        char prop_name[PROP_NAME_MAX];\n        char prop_value[PROP_VALUE_MAX];\n\n        // ,  prop_name  prop_value \n        if (!socket.RecvChars(prop_name, PROP_NAME_MAX, &timeout_ms) ||\n            !socket.RecvChars(prop_value, PROP_VALUE_MAX, &timeout_ms)) {\n          PLOG(ERROR) << \"sys_prop(PROP_MSG_SETPROP): error while reading name/value from the socket\";\n          return;\n        }\n\n        //  0\n        prop_name[PROP_NAME_MAX-1] = 0;\n        prop_value[PROP_VALUE_MAX-1] = 0;\n\n        const auto& cr = socket.cred();\n        std::string error;\n\n        // \n        uint32_t result =\n            HandlePropertySet(prop_name, prop_value, socket.source_context(), cr, &error);\n\n        if (result != PROP_SUCCESS) {\n            LOG(ERROR) << \"Unable to set property '\" << prop_name << \"' to '\" << prop_value\n                       << \"' from uid:\" << cr.uid << \" gid:\" << cr.gid << \" pid:\" << cr.pid << \": \"\n                       << error;\n        }\n\n        break;\n      }\n\n    //  PROP_MSG_SETPROP2 \n    case PROP_MSG_SETPROP2: {\n        std::string name;\n        std::string value;\n\n        // \n        if (!socket.RecvString(&name, &timeout_ms) ||\n            !socket.RecvString(&value, &timeout_ms)) {\n          PLOG(ERROR) << \"sys_prop(PROP_MSG_SETPROP2): error while reading name/value from the socket\";\n          socket.SendUint32(PROP_ERROR_READ_DATA);\n          return;\n        }\n\n        const auto& cr = socket.cred();\n        std::string error;\n\n        // \n        uint32_t result = HandlePropertySet(name, value, socket.source_context(), cr, &error);\n\n        if (result != PROP_SUCCESS) {\n            LOG(ERROR) << \"Unable to set property '\" << name << \"' to '\" << value\n                       << \"' from uid:\" << cr.uid << \" gid:\" << cr.gid << \" pid:\" << cr.pid << \": \"\n                       << error;\n        }\n        socket.SendUint32(result);\n        break;\n      }\n\n    default:\n        LOG(ERROR) << \"sys_prop: invalid command \" << cmd;\n        socket.SendUint32(PROP_ERROR_INVALID_CMD);\n        break;\n    }\n}\n```\n\n socket  `cmd` \n\n-  `PROP_MSG_SETPROP`  `PROP_NAME_MAX`  0 `PROP_NAME_MAX - 1` \n-  `PROP_MSG_SETPROP2`  `std::string` \n\n `PROP_MSG_SETPROP`  `PROP_MSG_SETPROP2`  `HandlePropertySet` \n\n\n\n### 2.4.3 \n\n** (Signals)**  IPC \n\n****\n\n\n\n#### 2.4.3.1 \n\n Linux (PID) waitwaitpid  waitid ** (Zombie process)**\n\n init init \n\n [2.4.4] init  fork servicemanager zygote  Android init \n\ninit \n\n Android Linux \n\n\n\n##### 2.4.3.1.1 \n\n<!-- :  -->\n\n\n\n- \u0015\u0015****\n- ****\n- ****\n\ninit \n\n\n\n\n\n##### 2.4.3.1.2  sigaction\n\n init  sigaction\n\n**sigaction**  `int sigaction(int signum, const struct sigaction *restrict act, struct sigaction *restrict oldact)`\n\n\n\n###### 2.4.3.1.2.1 \n\n sigaction \n\n- **signum** \n\n   AndroidARM  `bionic/libc/kernel/uapi/asm-arm/asm/signal.h` \n\n- **act**  sigaction  sigaction \n\n  ```c++\n  struct sigaction {\n     void     (*sa_handler)(int);\n     void     (*sa_sigaction)(int, siginfo_t *, void *);\n     sigset_t   sa_mask;\n     int        sa_flags;\n     void     (*sa_restorer)(void);\n  };\n  ```\n\n   `sa_handler`  `sa_flags`\n\n   `sa_handler` \n\n  - **SIG_DFL**\n\n    \n\n  - **SIG_IGN**\n\n    \n\n  - ****\n\n     signum \n\n   `sa_flags` \n\n  - **SA_NOCLDSTOP**\n\n     signum = SIGCHLD \n\n  - **SA_RESETHAND**\n\n    \n\n  - **SA_SIGINFO**\n\n     sa_handler  sa_sigaction\n\n- **oldact**  sigaction  sigaction  act\n\n\n\n###### 2.4.3.1.2.2 \n\n sigaction \n\n-  0\n\n-  -1\n\n\n\n##### 2.4.3.1.3 init \n\n sigaction  init \n\n\n\n###### 2.4.3.1.3.1  sigaction\n\ninit  InstallSignalFdHandler  `system/core/init/init.cpp`\n\n```c++\nstatic void InstallSignalFdHandler(Epoll* epoll) {\n    //  sigaction\n    //  sa_handler ,  sa_handler = SIG_DFL \n    //  sa_flags ,  sa_flags = SA_NOCLDSTOP  init , \n    const struct sigaction act { .sa_handler = SIG_DFL, .sa_flags = SA_NOCLDSTOP };\n\n    // sigaction ,  [2.4.3.1.2]\n    //  SIGCHLD,  SIGCHLD, , , , \n    sigaction(SIGCHLD, &act, nullptr);\n\n    ...\n\n}\n```\n\n sigaction `SIGCHLD`  `SIGCHLD` \n\n `SIGCHLD`  `SA_NOCLDSTOP`  init \n\ninit  signal  InstallSignalFdHandler \n\n\n\n###### 2.4.3.1.3.2  signal \n\n\n\nLinux  signalfd\n\ninit \n\n```c++\nstatic void InstallSignalFdHandler(Epoll* epoll) {\n\n    ...\n\n    // mask , \n    // ,  SIGCHLD\n    sigset_t mask;\n    sigemptyset(&mask);\n    sigaddset(&mask, SIGCHLD);\n\n    ...\n\n    //  signal \n    // ,  signalfd ,  -1, \n    signal_fd = signalfd(-1, &mask, SFD_CLOEXEC);\n\n    if (signal_fd == -1) {\n        PLOG(FATAL) << \"failed to create signalfd\";\n    }\n\n    //  signal  epoll,  [2.4.1.2]\n    // HandleSignalFd  [2.4.3.1.4]\n    if (auto result = epoll->RegisterHandler(signal_fd, HandleSignalFd); !result) {\n        LOG(FATAL) << result.error();\n    }\n}\n```\n\n `SIGCHLD` signal  epoll\n\n signal  HandleSignalFd \n\n\n\n##### 2.4.3.1.4  HandleSignalFd\n\n `system/core/init/init.cpp`\n\n```c++\nstatic void HandleSignalFd() {\n    signalfd_siginfo siginfo;\n\n    //  signal  signalfd_siginfo, \n    ssize_t bytes_read = TEMP_FAILURE_RETRY(read(signal_fd, &siginfo, sizeof(siginfo)));\n\n    if (bytes_read != sizeof(siginfo)) {\n        PLOG(ERROR) << \"Failed to read siginfo from signal_fd\";\n        return;\n    }\n\n    // \n    switch (siginfo.ssi_signo) {\n        case SIGCHLD:\n            ReapAnyOutstandingChildren();\n            break;\n        case SIGTERM:\n            HandleSigtermSignal(siginfo);\n            break;\n        default:\n            PLOG(ERROR) << \"signal_fd: received unexpected signal \" << siginfo.ssi_signo;\n            break;\n    }\n}\n```\n\nsignal  signalfd_siginfo HandleSignalFd  signal  signalfd_siginfo\n\n `SIGCHLD` ReapAnyOutstandingChildren \n\n\n\n###### 2.4.3.1.4.1  ReapAnyOutstandingChildren \n\n `system/core/init/sigchld_handler.cpp`\n\n```c++\nvoid ReapAnyOutstandingChildren() {\n    while (ReapOneProcess()) {\n    }\n}\n```\n\n ReapOneProcess  ReapOneProcess  false  ReapOneProcess \n\n\n\n###### 2.4.3.1.4.2  ReapOneProcess \n\n<!-- TODO:  service->flags() -->\n\n<!-- TODO:  ServiceList::GetInstance().RemoveService(*service) -->\n\n `system/core/init/sigchld_handler.cpp`\n\n```c++\nstatic bool ReapOneProcess() {\n    siginfo_t siginfo = {};\n\n    //  waitid, \n    //  init , ,  siginfo \n    if (TEMP_FAILURE_RETRY(waitid(P_ALL, 0, &siginfo, WEXITED | WNOHANG | WNOWAIT)) != 0) {\n        // ,  false\n        PLOG(ERROR) << \"waitid failed\";\n        return false;\n    }\n\n    //  pid\n    auto pid = siginfo.si_pid;\n\n    //  pid ,  false\n    if (pid == 0) return false;\n\n    ...\n\n    std::string name;\n    std::string wait_string;\n    Service* service = nullptr;\n\n    if (PropertyChildReap(pid)) {\n        name = \"Async property child\";\n    } else if (SubcontextChildReap(pid)) {\n        name = \"Subcontext\";\n    } else {\n        //  pid  service\n        service = ServiceList::GetInstance().FindService(pid, &Service::pid);\n\n        if (service) {\n            name = StringPrintf(\"Service '%s' (pid %d)\", service->name().c_str(), pid);\n\n            ...\n\n        } else {\n            name = StringPrintf(\"Untracked pid %d\", pid);\n        }\n    }\n\n    ...\n\n    //  service,  true\n    if (!service) return true;\n\n    //  service  Reap \n    service->Reap(siginfo);\n\n    ...\n\n    return true;\n}\n```\n\nReapOneProcess  waitid pid  service service  service  Reap  Reap \n\n\n\n###### 2.4.3.1.4.3  Reap \n\n `system/core/init/service.cpp`\n\n```c++\nvoid Service::Reap(const siginfo_t& siginfo) {\n    if (!(flags_ & SVC_ONESHOT) || (flags_ & SVC_RESTART)) {\n        //  SVC_ONESHOT  SVC_RESTART, \n        KillProcessGroup(SIGKILL);\n    }\n\n    ...\n\n    //  SVC_TEMPORARY, \n    if (flags_ & SVC_TEMPORARY) return;\n\n    // \n    pid_ = 0;\n    flags_ &= (~SVC_RUNNING);\n    start_order_ = 0;\n\n    if ((flags_ & SVC_ONESHOT) && !(flags_ & SVC_RESTART) && !(flags_ & SVC_RESET)) {\n        //  SVC_ONESHOT \n        flags_ |= SVC_DISABLED;\n    }\n\n    if (flags_ & (SVC_DISABLED | SVC_RESET))  {\n        //  SVC_DISABLED  SVC_RESET,  stopped , \n        NotifyStateChange(\"stopped\");\n        return;\n    }\n\n    //  SVC_CRITICAL \n    //  4  4 , \n    //  bootloader \n    boot_clock::time_point now = boot_clock::now();\n    if (((flags_ & SVC_CRITICAL) || !pre_apexd_) && !(flags_ & SVC_RESTART)) {\n        bool boot_completed = android::base::GetBoolProperty(\"sys.boot_completed\", false);\n        if (now < time_crashed_ + 4min || !boot_completed) {\n            if (++crash_count_ > 4) {\n                if (flags_ & SVC_CRITICAL) {\n                    // Aborts into bootloader\n                    LOG(FATAL) << \"critical process '\" << name_ << \"' exited 4 times \"\n                               << (boot_completed ? \"in 4 minutes\" : \"before boot completed\");\n                } else {\n                    LOG(ERROR) << \"updatable process '\" << name_ << \"' exited 4 times \"\n                               << (boot_completed ? \"in 4 minutes\" : \"before boot completed\");\n                    // Notifies update_verifier and apexd\n                    property_set(\"ro.init.updatable_crashing\", \"1\");\n                }\n            }\n        } else {\n            time_crashed_ = now;\n            crash_count_ = 1;\n        }\n    }\n\n    //  SVC_RESTARTING, init  [2.4.5.2]\n    flags_ &= (~SVC_RESTART);\n    flags_ |= SVC_RESTARTING;\n\n    //  service  onrestart \n    onrestart_.ExecuteAllCommands();\n\n    //  restarting \n    NotifyStateChange(\"restarting\");\n    return;\n}\n```\n\nReap  NotifyStateChange \n\n\n\n###### 2.4.3.1.4.4  NotifyStateChange \n\n `system/core/init/service.cpp`\n\n```c++\nvoid Service::NotifyStateChange(const std::string& new_state) const {\n    if ((flags_ & SVC_TEMPORARY) != 0) {\n        //  SVC_TEMPORARY, \n        return;\n    }\n\n    // \n    std::string prop_name = \"init.svc.\" + name_;\n    property_set(prop_name, new_state);\n\n    ...\n}\n```\n\n key-value  key  init.svc.[service_name]value  adb `getprop | grep init.svc.` service \n\n```\n[init.svc.adbd]: [running]\n[init.svc.alarm-hal-1-0]: [running]\n[init.svc.android.thermal-hal]: [running]\n[init.svc.apexd]: [stopped]\n[init.svc.apexd-bootstrap]: [stopped]\n[init.svc.apexd-snapshotde]: [stopped]\n[init.svc.audioserver]: [running]\n[init.svc.wifidisplayhalservice]: [running]\n[init.svc.wpa_supplicant]: [running]\n[init.svc.zygote]: [running]\n[init.svc.zygote_secondary]: [running]\n```\n\n\n\n### 2.4.4 \n\n<!-- TODO:  CreateParser -->\n\n<!-- TODO: .rc  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: /system/etc/init -->\n\n<!-- TODO: /odm/etc/init -->\n\n<!-- TODO: /vendor/etc/init -->\n\n LoadBootScripts  `system/core/init/init.cpp`\n\n```c++\nstatic void LoadBootScripts(ActionManager& action_manager, ServiceList& service_list) {\n    Parser parser = CreateParser(action_manager, service_list);\n\n    std::string bootscript = GetProperty(\"ro.boot.init_rc\", \"\");\n    if (bootscript.empty()) {\n        //  init.rc  [2.4.4.1]\n        parser.ParseConfig(\"/init.rc\");\n\n        //  /system/etc/init \n        if (!parser.ParseConfig(\"/system/etc/init\")) {\n            late_import_paths.emplace_back(\"/system/etc/init\");\n        }\n\n        //  /product/etc/init \n        if (!parser.ParseConfig(\"/product/etc/init\")) {\n            late_import_paths.emplace_back(\"/product/etc/init\");\n        }\n\n        //  /product_services/etc/init \n        if (!parser.ParseConfig(\"/product_services/etc/init\")) {\n            late_import_paths.emplace_back(\"/product_services/etc/init\");\n        }\n\n        //  /odm/etc/init \n        if (!parser.ParseConfig(\"/odm/etc/init\")) {\n            late_import_paths.emplace_back(\"/odm/etc/init\");\n        }\n\n        //  /vendor/etc/init \n        if (!parser.ParseConfig(\"/vendor/etc/init\")) {\n            late_import_paths.emplace_back(\"/vendor/etc/init\");\n        }\n    } else {\n        parser.ParseConfig(bootscript);\n    }\n}\n```\n\n\n\n- `init.rc`  .rc \n- `/system/etc/init/` SurfaceFlinger, MediaService, logcatd\n- `/vendor/etc/init/`  SoC  SoC \n- `/odm/etc/init/` \n\ninit.rc \n\n\n\n#### 2.4.4.1 init.rc \n\n Android .rc  Android Init Language [ Android Init Language ](https://cs.android.com/android/platform/superproject/+/android-security-10.0.0_r56:system/core/init/README.md)  AOSP  `system/core/init/README.md`\n\n\n\n\n\n##### 2.4.4.1.1 Android Init Language\n\nAndroid Init Language `Actions``Commands``Services``Options``Imports`\n\n\n\n-  token token \n-  token  c  `\\`  token\n-  `\\`\n-  `#` \n-  `${property.name}` `import /init.recovery.${ro.hardware}.rc`\n-  section `Actions`  `Services`  section `Commands`  `Options`  section section  `Commands`  `Options` \n- `Services`  `Services` \n\n\n\n\n\n###### 2.4.4.1.1.1 Actions\n\n`Actions`   `Commands`  `Triggers`  `Actions` \n\n```\non <trigger> [&& <trigger>]*\n   <command>\n   <command>\n   <command>\n```\n\n `Actions`   `Triggers` `Actions` \n\n `Actions`  `Actions`  `Commands`\n\n Zygote \n\n```\non zygote-start && property:ro.crypto.state=unencrypted\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n```\n\n\n\n `Actions`  `Triggers` `zygote-start`  `property:ro.crypto.state=unencrypted` `Command`\n\n `zygote-start`  `property:ro.crypto.state=unencrypted` `Actions`  `Actions`  `Commands`  `Actions`  `Commands`\n\n\n\n###### 2.4.4.1.1.2 Triggers\n\n`Triggers`  `Actions`  `Commands`\n\nTriggers \n\n- **Event triggers**\n\n   `trigger`   `QueueEventTrigger()` \n\n- **Property triggers**\n\n   `property:<key>=<value>`\n\n `Actions` \n\n\n\n`on init && property:a=b``on property:a=b && property:c=d` \n\n`on boot && on init` \n\n\n\n###### 2.4.4.1.1.3 Commands\n\n `Commands`\n\n- **trigger <event>**\n\n  \n\n- **write <path> <content>**\n\n   path \n\n- **chown <owner> <group> <path>**\n\n  \n\n- **mkdir <path> [mode] [owner] [group]**\n\n   \n\n   755 root  root \n\n  \n\n- **start <service>**\n\n  \n\n- **exec_start <service>**\n\n  \n\n- **setprop <name> <value>**\n\n  \n\n- **symlink <target> <path>**\n\n   path  target \n\n\n\n###### 2.4.4.1.1.4 Services\n\n`Services`  init  init  init  `Services`  fork \n\n`Services` \n\n`Services` \n\n```\nservice <name> <pathname> [ <argument> ]*\n   <option>\n   <option>\n   ...\n```\n\n Zygote 64 \n\n```\nservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server\n    class main\n    priority -20\n    user root\n    group root readproc reserved_disk\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n    onrestart write /sys/android_power/request_state wake\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n    writepid /dev/cpuset/foreground/tasks\n```\n\n`zygote`  `Services` `/system/bin/app_process64` `-Xzygote /system/bin --zygote --start-system-server`  `Options`\n\n\n\n###### 2.4.4.1.1.5 Options\n\n`Options`  `Services`  init  `Services` \n\n  `Options`\n\n- **class <name> [ <name>\\* ]**\n\n   `Services`  `Services`  () `Services`  ()  default\n\n- **class_start <serviceclass>**\n\n   `serviceclass`  `Services`\n\n- **priority <priority>**\n\n   `Services`  -20 ~ 19 0\n\n- **user <username>**\n\n   `Services`  root\n\n- **group <groupname> [ <groupname>\\* ]**\n\n   `Services`  root\n\n- **socket <name> <type> <perm> [ <user> [ <group> [ <seclabel> ] ] ]**\n\n   unix  socket `/dev/socket/<name>` socket \n\n- **onrestart**\n\n   `Services`  `Commands`\n\n- **oneshot**\n\n   `Services` \n\n- **writepid <file> [ <file>\\* ]**\n\n   fork  pid \n\n\n\n##### 2.4.4.1.2  init.rc \n\n init.rc  `system/core/rootdir/init.rc`\n\n  `Actions`  `Services`  init.rc  `Actions` [2.4.4.1.1.2]  `QueueEventTrigger()`   `Actions`   `Triggers` `Actions` \n\n\n\n###### 2.4.4.1.2.1 \n\n init  `system/core/init/init.cpp`  SecondStageMain \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n\n    ...\n\n    ActionManager& am = ActionManager::GetInstance();\n\n    ...\n\n    //  early-init  ActionManager\n    am.QueueEventTrigger(\"early-init\");\n\n    ...\n\n    // Trigger all the boot actions to get us started.\n    //  init  ActionManager\n    am.QueueEventTrigger(\"init\");\n\n    ...\n\n    // Don't mount filesystems or start core system services in charger mode.\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        // ,  charger  ActionManager\n        // , \n        am.QueueEventTrigger(\"charger\");\n    } else {\n        // ,  late-init  ActionManager\n        am.QueueEventTrigger(\"late-init\");\n    }\n\n    ...\n\n    return 0;\n}\n```\n\nActionManager  [2.4.5.x]\n\n- early-init -> init -> late-init\n- early-init -> init -> charger\n\n\n\n\n\n###### 2.4.4.1.2.2 init.rc \n\n<!-- TODO: trigger boot -->\n\n\n\n```\non early-init\n    ...\n\n    #  start  ueventd\n    start ueventd\n\n    #  exec_start  apexd-bootstrap, ,  APEX \n    exec_start apexd-bootstrap\n\non init\n    ...\n\n    #  start \n    #  servicemanager [2.4.4.1.2.3]\n    start servicemanager\n    start hwservicemanager\n    start vndservicemanager\n\n# \n#  trigger  [2.4.4.1.1.2]\non late-init\n    trigger early-fs\n    trigger fs\n    trigger post-fs\n    trigger late-fs\n    trigger post-fs-data\n    trigger load_persist_props_action\n\n    #  zygote-start,  zygote [2.4.4.1.2.4]\n    trigger zygote-start\n\n    trigger firmware_mounts_complete\n    trigger early-boot\n    trigger boot\n```\n\n servicemanager  zygote \n\n\n\n###### 2.4.4.1.2.3  servicemanager\n\nservicemanager  `frameworks/native/cmds/servicemanager/servicemanager.rc`\n\n```\n# servicemanager  Services \n# /system/bin/servicemanager \nservice servicemanager /system/bin/servicemanager\n    #  core  animation\n    #  core  animation  () , servicemanager  ()\n    class core animation\n\n    #  system\n    user system\n\n    #  system  readproc\n    group system readproc\n\n    # \n    # ,  bootloader\n    critical\n\n    # \n    #  Commands\n    onrestart restart healthd\n    onrestart restart zygote\n    onrestart restart audioserver\n    onrestart restart media\n    onrestart restart surfaceflinger\n    onrestart restart inputflinger\n    onrestart restart drm\n    onrestart restart cameraserver\n    onrestart restart keystore\n    onrestart restart gatekeeperd\n    onrestart restart thermalservice\n\n    #  fork  pid  /dev/cpuset/system-background/tasks\n    writepid /dev/cpuset/system-background/tasks\n\n    # \n    # shutdown critical , \n    shutdown critical\n```\n\n servicemanager  `frameworks/native/cmds/servicemanager/service_manager.c`  main \n\n\n\n###### 2.4.4.1.2.4  zygote\n\n init.rc  `zygote-start`  3  `Actions`\n\n```\non zygote-start && property:ro.crypto.state=unencrypted\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n\non zygote-start && property:ro.crypto.state=unsupported\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n\non zygote-start && property:ro.crypto.state=encrypted && property:ro.crypto.type=file\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n```\n\nzygote \n\n```\nimport /init.${ro.zygote}.rc\n```\n\n `ro.zygote`\n\n```\nsystem/core/rootdir/init.zygote32.rc\nsystem/core/rootdir/init.zygote32_64.rc\nsystem/core/rootdir/init.zygote64.rc\nsystem/core/rootdir/init.zygote64_32.rc\n```\n\nzygote  `zygote-start`  `Actions`  zygote\n\n Zygote 64  `system/core/rootdir/init.zygote64.rc`\n\n```\n# zygote  Services \n# /system/bin/app_process64 \n# -Xzygote /system/bin --zygote --start-system-server \nservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server\n    #  main\n    #  main  () , zygote  ()\n    class main\n\n    #  -20\n    #  -20 ~ 19, , ,  zygote \n    priority -20\n\n    #  root\n    user root\n    group root readproc reserved_disk\n\n    #  socket\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n\n    # \n    #  Commands\n    onrestart write /sys/android_power/request_state wake\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n\n    #  zygote  fork  pid  /dev/cpuset/foreground/tasks\n    writepid /dev/cpuset/foreground/tasks\n```\n\n zygote  `frameworks/base/cmds/app_process/app_main.cpp`  main \n\n\n\n### 2.4.5 \n\ninit  `system/core/init/init.cpp`\n\n```c++\nint SecondStageMain(int argc, char** argv) {\n\n    ...\n\n    while (true) {\n        //  epoll \n        // , ,  epoll_timeout  -1\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{};\n\n        ...\n\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            // am ,  ActionManager \n            //  ActionManager  [2.4.5.1]\n            am.ExecuteOneCommand();\n        }\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            if (!shutting_down) {\n                //  HandleProcessActions  [2.4.5.2]\n                auto next_process_action_time = HandleProcessActions();\n\n                if (next_process_action_time) {\n                    //  next_process_action_time \n                    epoll_timeout = std::chrono::ceil<std::chrono::milliseconds>(\n                            *next_process_action_time - boot_clock::now());\n\n                    //  0, \n                    //  epoll  0,  Wait , \n                    if (*epoll_timeout < 0ms) epoll_timeout = 0ms;\n                }\n            }\n\n            //  ActionManager ,  init , \n            //  epoll  0,  Wait , \n            if (am.HasMoreCommands()) epoll_timeout = 0ms;\n        }\n\n        //  Wait ,  [2.4.1.3]\n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\ninit  3 \n\n-  ActionManager \n- \n-  epoll  init  init  `SIGCHLD` \n\n\n\n#### 2.4.5.1 ActionManager\n\n<!-- TODO:  Action? -->\n\n<!-- TODO: Action  Actions  -->\n\n<!-- TODO:  -->\n\nActionManager  Action  Action \n\n\n\n##### 2.4.5.1.1  Action\n\n<!-- TODO:  Action  -->\n\n init  Action Action \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    // am ,  ActionManager \n    ActionManager& am = ActionManager::GetInstance();\n\n    ...\n\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n\n    //  Action:  early-init [2.4.4.1.2.1]\n    am.QueueEventTrigger(\"early-init\");\n\n    //  Action:  coldboot \n    am.QueueBuiltinAction(wait_for_coldboot_done_action, \"wait_for_coldboot_done\");\n\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n    am.QueueBuiltinAction(SetMmapRndBitsAction, \"SetMmapRndBits\");\n    am.QueueBuiltinAction(SetKptrRestrictAction, \"SetKptrRestrict\");\n    Keychords keychords;\n    am.QueueBuiltinAction(\n        [&epoll, &keychords](const BuiltinArguments& args) -> Result<Success> {\n            for (const auto& svc : ServiceList::GetInstance()) {\n                keychords.Register(svc->keycodes());\n            }\n            keychords.Start(&epoll, HandleKeychord);\n            return Success();\n        },\n        \"KeychordInit\");\n    am.QueueBuiltinAction(console_init_action, \"console_init\");\n\n    //  Action:  init [2.4.4.1.2.1]\n    am.QueueEventTrigger(\"init\");\n\n    am.QueueBuiltinAction(StartBoringSslSelfTest, \"StartBoringSslSelfTest\");\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n\n    //  Action:  init  binder\n    am.QueueBuiltinAction(InitBinder, \"InitBinder\");\n\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        // ,  Action:  charger [2.4.4.1.2.1]\n        am.QueueEventTrigger(\"charger\");\n    } else {\n        // ,  Action:  late-init [2.4.4.1.2.1]\n        am.QueueEventTrigger(\"late-init\");\n    }\n\n    //  Action: \n    am.QueueBuiltinAction(queue_property_triggers_action, \"queue_property_triggers\");\n\n    ...\n\n}\n```\n\n ActionManager  Action\n\n\n\n#### 2.4.5.2 HandleProcessActions\n\n<!-- ((s->flags() & SVC_RUNNING) && s->timeout_period()) -->\n\n<!--  service  -->\n\n```c++\nstatic std::optional<boot_clock::time_point> HandleProcessActions() {\n    std::optional<boot_clock::time_point> next_process_action_time;\n\n    //  ServiceList\n    for (const auto& s : ServiceList::GetInstance()) {\n        // , \n        if ((s->flags() & SVC_RUNNING) && s->timeout_period()) {\n            // \n            auto timeout_time = s->time_started() + *s->timeout_period();\n\n            if (boot_clock::now() > timeout_time) {\n                // , \n                s->Timeout();\n            } else {\n                //  next_process_action_time\n                // , next_process_action_time , \n                if (!next_process_action_time || timeout_time < *next_process_action_time) {\n                    next_process_action_time = timeout_time;\n                }\n            }\n        }\n\n        //  SVC_RESTARTING, ,  for \n        if (!(s->flags() & SVC_RESTARTING)) continue;\n\n        // \n        auto restart_time = s->time_started() + s->restart_period();\n\n        // , \n        if (boot_clock::now() > restart_time) {\n            // , \n            if (auto result = s->Start(); !result) {\n                LOG(ERROR) << \"Could not restart process '\" << s->name() << \"': \" << result.error();\n            }\n        } else {\n            //  next_process_action_time\n            // , next_process_action_time , \n            if (!next_process_action_time || restart_time < *next_process_action_time) {\n                next_process_action_time = restart_time;\n            }\n        }\n    }\n    return next_process_action_time;\n}\n```\n\n\n\n1.  `SVC_RUNNING`  `Timeout` \n2.  `SVC_RESTARTING`  \n\n`next_process_action_time` \n\n [2.4.3.1.4.3]  init  `SVC_RESTARTING` init  `SVC_RESTARTING` \n\n\n\n# \n\n[Android-](http://gityuan.com/2016/02/01/android-booting/)\n\n[Android-Init](http://gityuan.com/2016/02/05/android-init/)\n\n[epoll(7)](https://man7.org/linux/man-pages/man7/epoll.7.html)\n\n[Signal](https://en.wikipedia.org/wiki/Signal_(IPC))\n\n[signal(7)](https://man7.org/linux/man-pages/man7/signal.7.html)\n\n[wait(2)](https://man7.org/linux/man-pages/man2/wait.2.html)\n\n[signalfd(2)](https://man7.org/linux/man-pages/man2/signalfd.2.html)\n\n","slug":"exploring-init-process-startup-process","published":0,"date":"2021-11-05T08:35:16.619Z","updated":"2021-11-09T11:56:14.735Z","_id":"cksol4flf00000cprd5ks579o","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>android-security-10.0.0_r56</p>\n</blockquote>\n<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><!-- TODO:  init  -->\n\n<p>Android  Linux  init </p>\n<p>init  pid = 1</p>\n<a id=\"more\"></a>\n\n\n\n<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><!-- TODO:  -->\n\n\n\n<h2 id=\"2-1-init-\"><a href=\"#2-1-init-\" class=\"headerlink\" title=\"2.1 init \"></a>2.1 init </h2><!-- TODO:  -->\n\n<!-- TODO: init ,  /system/core/init -->\n\n<p> Android 9init  <code>system/core/init/init.cpp</code>  main </p>\n<p> Android 10 init  <code>system/core/init/main.cpp</code>  main </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(basename(argv[<span class=\"number\">0</span>]), <span class=\"string\">&quot;ueventd&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ueventd_main(argc, argv);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;subcontext&quot;</span>)) &#123;</span><br><span class=\"line\">            android::base::InitLogging(argv, &amp;android::base::KernelLogger);</span><br><span class=\"line\">            <span class=\"keyword\">const</span> BuiltinFunctionMap&amp; function_map = GetBuiltinFunctionMap();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> SubcontextMain(argc, argv, &amp;function_map);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;selinux_setup&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SetupSelinux(argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;second_stage&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SecondStageMain(argc, argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> FirstStageMain(argc, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>basename</code>  <code>strcmp</code> </p>\n<ul>\n<li><code>basename</code>  <code>char* basename(char* __path)</code> /system/bin/ueventd ueventd</li>\n<li><code>strcmp</code>  <code>int strcmp(const char* __lhs, const char* __rhs)</code> 0</li>\n</ul>\n<p> main  <code>argc</code>  <code>argv</code> <code>FirstStageMain</code> </p>\n<h2 id=\"2-2-\"><a href=\"#2-2-\" class=\"headerlink\" title=\"2.2 \"></a>2.2 </h2><!-- TODO: mkdir, mknod, tmpfs -->\n\n<!-- TODO:  -->\n\n<!-- TODO: KernelLogging(/dev/kmsg) -->\n\n<!-- TODO: InstallRebootSignalHandlers -->\n\n<p> <code>int FirstStageMain(int argc, char** argv)</code>  <code>system/core/init/first_stage_init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">FirstStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(clearenv());</span><br><span class=\"line\">    CHECKCALL(setenv(<span class=\"string\">&quot;PATH&quot;</span>, _PATH_DEFPATH, <span class=\"number\">1</span>));</span><br><span class=\"line\">    <span class=\"comment\">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class=\"line\">    <span class=\"comment\">// on / and then we&#x27;ll let the rc file figure out the rest.</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/dev&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class=\"string\">&quot;mode=0755&quot;</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/socket&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/dm-user&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;devpts&quot;</span>, <span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"string\">&quot;devpts&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> MAKE_STR(x) __STRING(x)</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;proc&quot;</span>, <span class=\"string\">&quot;/proc&quot;</span>, <span class=\"string\">&quot;proc&quot;</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;hidepid=2,gid=&quot;</span> MAKE_STR(AID_READPROC)));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> MAKE_STR</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">    <span class=\"comment\">//  [2.2.1]</span></span><br><span class=\"line\">    CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> cmdline;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, &amp;cmdline);</span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">    chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootconfig;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, &amp;bootconfig);</span><br><span class=\"line\">    <span class=\"keyword\">gid_t</span> groups[] = &#123;AID_READPROC&#125;;</span><br><span class=\"line\">    CHECKCALL(setgroups(arraysize(groups), groups));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"string\">&quot;/sys&quot;</span>, <span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"string\">&quot;/sys/fs/selinux&quot;</span>, <span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, S_IFCHR | <span class=\"number\">0600</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">if</span> <span class=\"title\">constexpr</span> <span class=\"params\">(WORLD_WRITABLE_KMSG)</span> </span>&#123;</span><br><span class=\"line\">        CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg_debug&quot;</span>, S_IFCHR | <span class=\"number\">0622</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/random&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">8</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/urandom&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">9</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// This is needed for log wrapper, which gets called before ueventd runs.</span></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/ptmx&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">5</span>, <span class=\"number\">2</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/null&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">3</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// These below mounts are done in first stage init so that first stage mount can mount</span></span><br><span class=\"line\">    <span class=\"comment\">// subdirectories of /mnt/&#123;vendor,product&#125;/.  Other mounts, not required by first stage mount,</span></span><br><span class=\"line\">    <span class=\"comment\">// should be done in rc files.</span></span><br><span class=\"line\">    <span class=\"comment\">// Mount staging areas for devices managed by vold</span></span><br><span class=\"line\">    <span class=\"comment\">// See storage config details at http://source.android.com/devices/storage/</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/mnt&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=1000&quot;</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/vendor is used to mount vendor-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the vendor partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/vendor&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/product is used to mount product-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the product partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/product&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /debug_ramdisk is used to preserve additional files from the debug ramdisk</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/debug_ramdisk&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /second_stage_resources is used to preserve files from first to second</span></span><br><span class=\"line\">    <span class=\"comment\">// stage init</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, kSecondStageRes, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>))</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> CHECKCALL</span></span><br><span class=\"line\"></span><br><span class=\"line\">    SetStdioToDevNull(argv);</span><br><span class=\"line\">    <span class=\"comment\">// Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually</span></span><br><span class=\"line\">    <span class=\"comment\">// talk to the outside world...</span></span><br><span class=\"line\">    InitKernelLogging(argv);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!errors.empty()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; [error_string, error_errno] : errors) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; error_string &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; strerror(error_errno);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Init encountered errors starting first stage, aborting&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    LOG(INFO) &lt;&lt; <span class=\"string\">&quot;init first stage started!&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init</span></span><br><span class=\"line\">    <span class=\"comment\">//  selinux_setup,  SetupSelinux  SELinux  [2.3]</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;selinux_setup&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">auto</span> fd = open(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, O_WRONLY | O_CLOEXEC);</span><br><span class=\"line\">    dup2(fd, STDOUT_FILENO);</span><br><span class=\"line\">    dup2(fd, STDERR_FILENO);</span><br><span class=\"line\">    close(fd);</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// execv() only returns if an error happened, in which case we</span></span><br><span class=\"line\">    <span class=\"comment\">// panic and never fall through this conditional.</span></span><br><span class=\"line\">    PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;execv(\\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class=\"string\">&quot;\\&quot;) failed&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>/system/bin/init</code> main  <code>&quot;selinux_setup&quot;</code> SetupSelinux  SELinux </p>\n<h3 id=\"2-2-1-\"><a href=\"#2-2-1-\" class=\"headerlink\" title=\"2.2.1 \"></a>2.2.1 </h3><p> Linux <code>chmod</code> </p>\n<p></p>\n<h4 id=\"2-2-1-1-\"><a href=\"#2-2-1-1-\" class=\"headerlink\" title=\"2.2.1.1 \"></a>2.2.1.1 </h4><p> 10 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-rwxrwxrwx</span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li><code>-</code></li>\n<li><code>d</code></li>\n<li><code>c</code></li>\n</ul>\n<p> 9  3 </p>\n<p>3  1  2  3 </p>\n<ul>\n<li> 1  <code>r</code> <code>-</code></li>\n<li> 2  <code>w</code> <code>-</code></li>\n<li> 3  <code>x</code> <code>-</code></li>\n</ul>\n<p><code>-rwxrw-r--</code> </p>\n<h4 id=\"2-2-1-2-\"><a href=\"#2-2-1-2-\" class=\"headerlink\" title=\"2.2.1.2 \"></a>2.2.1.2 </h4><p> 4  1  3 </p>\n<p> 3  3 </p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1004</td>\n<td align=\"center\">r</td>\n</tr>\n<tr>\n<td align=\"center\">0102</td>\n<td align=\"center\">w</td>\n</tr>\n<tr>\n<td align=\"center\">0011</td>\n<td align=\"center\">x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\">-</td>\n</tr>\n</tbody></table>\n<p> 0~7</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1117</td>\n<td align=\"center\">rwx</td>\n</tr>\n<tr>\n<td align=\"center\">1106</td>\n<td align=\"center\">rw-</td>\n</tr>\n<tr>\n<td align=\"center\">1015</td>\n<td align=\"center\">r-x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">-rwxrwxrwx</td>\n<td align=\"center\">0777</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">-rwxrw-r</td>\n<td align=\"center\">0764</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<h4 id=\"2-2-1-3-\"><a href=\"#2-2-1-3-\" class=\"headerlink\" title=\"2.2.1.3 \"></a>2.2.1.3 </h4><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br></pre></td></tr></table></figure>\n<p> <code>chmod</code>  <code>/proc/cmdline</code><code>/proc/bootconfig</code>  <code>0440</code> root  () </p>\n<h2 id=\"2-3--SELinux\"><a href=\"#2-3--SELinux\" class=\"headerlink\" title=\"2.3  SELinux\"></a>2.3  SELinux</h2><!-- TODO:  SELinux -->\n\n<p> <code>int SetupSelinux(char** argv)</code>  SELinux  <code>system/core/init/selinux.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// This function initializes SELinux then execs init to run in the init SELinux context.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SetupSelinux</span><span class=\"params\">(<span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Set up SELinux, loading the SELinux policy.</span></span><br><span class=\"line\">    <span class=\"comment\">//  SELinux</span></span><br><span class=\"line\">    SelinuxSetupKernelLogging();</span><br><span class=\"line\">    SelinuxInitialize();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init</span></span><br><span class=\"line\">    <span class=\"comment\">//  second_stage,  SecondStageMain  [2.4]</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;second_stage&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> SELinux <code>/system/bin/init</code> main  <code>&quot;second_stage&quot;</code> SecondStageMain </p>\n<h2 id=\"2-4-\"><a href=\"#2-4-\" class=\"headerlink\" title=\"2.4 \"></a>2.4 </h2><!-- TODO: property_load_boot_defaults -->\n\n<!-- TODO: , android  build.prop  -->\n\n<!-- TODO: SELinux  -->\n\n<!-- TODO: keyctl_get_keyring_ID(KEY_SPEC_SESSION_KEYRING, 1) -->\n\n<!-- TODO: InitializeSubcontext() -->\n\n<!-- TODO: ActionManager  ServiceList  -->\n\n<p> <code>int SecondStageMain(int argc, char** argv)</code>  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Set init and its forked children&#x27;s oom_adj.</span></span><br><span class=\"line\">    <span class=\"comment\">//  init  fork  oom_score_adj </span></span><br><span class=\"line\">    <span class=\"comment\">// , </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = WriteFile(<span class=\"string\">&quot;/proc/1/oom_score_adj&quot;</span>, <span class=\"string\">&quot;-1000&quot;</span>); !result) &#123;</span><br><span class=\"line\">        LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to write -1000 to /proc/1/oom_score_adj: &quot;</span> &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.2.1]</span></span><br><span class=\"line\">    property_init();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll [2.4.1.1]</span></span><br><span class=\"line\">    Epoll epoll;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Open(); !result) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll  init  [2.4.3.1.3]</span></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    InstallSignalFdHandler(&amp;epoll);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.2.2]</span></span><br><span class=\"line\">    StartPropertyService(&amp;epoll);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\">    ServiceList&amp; sm = ServiceList::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.4]</span></span><br><span class=\"line\">    LoadBootScripts(am, sm);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action [2.4.5.1]</span></span><br><span class=\"line\">    am.QueueBuiltinAction(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class=\"string\">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    am.QueueBuiltinAction(queue_property_triggers_action, <span class=\"string\">&quot;queue_property_triggers&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.5]</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = <span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (do_shutdown &amp;&amp; !shutting_down) &#123;</span><br><span class=\"line\">            do_shutdown = <span class=\"literal\">false</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (HandlePowerctlMessage(shutdown_command)) &#123;</span><br><span class=\"line\">                shutting_down = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            am.ExecuteOneCommand();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!shutting_down) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">auto</span> next_process_action_time = HandleProcessActions();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (next_process_action_time) &#123;</span><br><span class=\"line\">                    epoll_timeout = <span class=\"built_in\">std</span>::chrono::<span class=\"built_in\">ceil</span>&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;(</span><br><span class=\"line\">                            *next_process_action_time - boot_clock::now());</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (*epoll_timeout &lt; <span class=\"number\">0</span>ms) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (am.HasMoreCommands()) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> 5 </p>\n<ul>\n<li><p>epoll</p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p> 5 </p>\n<h3 id=\"2-4-1-epoll\"><a href=\"#2-4-1-epoll\" class=\"headerlink\" title=\"2.4.1 epoll\"></a>2.4.1 epoll</h3><p>epoll  Linux  I/O epoll </p>\n<h4 id=\"2-4-1-1-\"><a href=\"#2-4-1-1-\" class=\"headerlink\" title=\"2.4.1.1 \"></a>2.4.1.1 </h4><p> init epoll </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Epoll epoll;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Open(); !result) &#123;</span><br><span class=\"line\">    PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>epoll  Open  <code>system/core/init/epoll.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::Open</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_fd_ &gt;= <span class=\"number\">0</span>) <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    epoll_fd_.reset(epoll_create1(EPOLL_CLOEXEC));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_fd_ == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_create1 failed&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>epoll_create1</code><code>epoll_create1</code>  epoll </p>\n<h4 id=\"2-4-1-2--epoll-\"><a href=\"#2-4-1-2--epoll-\" class=\"headerlink\" title=\"2.4.1.2  epoll \"></a>2.4.1.2  epoll </h4><p> epoll  RegisterHandler  epoll</p>\n<p> <code>system/core/init/epoll.cpp</code> epoll_ctl</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler, <span class=\"keyword\">uint32_t</span> events)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &amp;ev) == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> epoll_ctl </p>\n<h5 id=\"2-4-1-2-1--epoll-ctl\"><a href=\"#2-4-1-2-1--epoll-ctl\" class=\"headerlink\" title=\"2.4.1.2.1  epoll_ctl\"></a>2.4.1.2.1  epoll_ctl</h5><p><strong>epoll_ctl</strong>  <code>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)</code> fd </p>\n<h6 id=\"2-4-1-2-1-1-\"><a href=\"#2-4-1-2-1-1-\" class=\"headerlink\" title=\"2.4.1.2.1.1 \"></a>2.4.1.2.1.1 </h6><p> epoll_ctl </p>\n<ul>\n<li><p><strong>epfd</strong>  epoll </p>\n</li>\n<li><p><strong>op</strong> </p>\n<ul>\n<li><p><strong>EPOLL_CTL_ADD</strong></p>\n<p> epoll </p>\n</li>\n<li><p><strong>EPOLL_CTL_MOD</strong></p>\n<p> epoll </p>\n</li>\n<li><p><strong>EPOLL_CTL_DEL</strong></p>\n<p> epoll </p>\n</li>\n</ul>\n</li>\n<li><p><strong>fd</strong> </p>\n</li>\n<li><p><strong>event</strong>  epoll_event  epoll_event </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">epoll_event</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">uint32_t</span>     events;      <span class=\"comment\">/* Epoll events */</span></span><br><span class=\"line\">   <span class=\"keyword\">epoll_data_t</span> data;        <span class=\"comment\">/* User data variable */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code> </p>\n<ul>\n<li><p>\u0015\u0015<strong>EPOLLIN</strong><br></p>\n</li>\n<li><p><strong>EPOLLOUT</strong><br></p>\n</li>\n<li><p><strong>EPOLLPRI</strong><br></p>\n</li>\n<li><p><strong>EPOLLERR</strong><br></p>\n</li>\n<li><p><strong>EPOLLHUP</strong><br></p>\n</li>\n<li><p><strong>EPOLLONESHOT</strong><br>epoll <br> epoll_ctl EPOLL_CTL_MOD </p>\n</li>\n</ul>\n<p> <code>data</code>  [2.4.1.3]<code>epoll_data_t</code> </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">epoll_data</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">void</span>        *ptr;</span><br><span class=\"line\">   <span class=\"keyword\">int</span>          fd;</span><br><span class=\"line\">   <span class=\"keyword\">uint32_t</span>     u32;</span><br><span class=\"line\">   <span class=\"keyword\">uint64_t</span>     u64;</span><br><span class=\"line\">&#125; <span class=\"keyword\">epoll_data_t</span>;</span><br></pre></td></tr></table></figure>\n\n\n</li>\n</ul>\n<h6 id=\"2-4-1-2-1-2-\"><a href=\"#2-4-1-2-1-2-\" class=\"headerlink\" title=\"2.4.1.2.1.2 \"></a>2.4.1.2.1.2 </h6><p> epoll_ctl </p>\n<ul>\n<li><p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-1-2-2--RegisterHandler-\"><a href=\"#2-4-1-2-2--RegisterHandler-\" class=\"headerlink\" title=\"2.4.1.2.2  RegisterHandler \"></a>2.4.1.2.2  RegisterHandler </h5><p> epoll_ctl  RegisterHandler  <code>system/core/init/epoll.h</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Epoll</span> &#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\">Result&lt;Success&gt; <span class=\"title\">RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                    <span class=\"keyword\">uint32_t</span> events = EPOLLIN)</span></span>;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code>  <code>EPOLLIN</code></p>\n<p> RegisterHandler </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler, <span class=\"keyword\">uint32_t</span> events)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// handler </span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> [it, inserted] = epoll_handlers_.emplace(fd, <span class=\"built_in\">std</span>::move(handler));</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_event ev;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"comment\">//  events  EPOLLIN, </span></span><br><span class=\"line\">    ev.events = events;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">// ,  [2.4.1.3.2]</span></span><br><span class=\"line\">    ev.data.ptr = <span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"keyword\">void</span>*&gt;(&amp;it-&gt;second);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll_ctl </span></span><br><span class=\"line\">    <span class=\"comment\">//  EPOLL_CTL_ADD, </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &amp;ev) == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        Result&lt;Success&gt; result = ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_ctl failed to add fd&quot;</span>;</span><br><span class=\"line\">        epoll_handlers_.erase(fd);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code>  <code>handler</code> <code>epoll_ctl</code>  epoll </p>\n<h4 id=\"2-4-1-3-\"><a href=\"#2-4-1-3-\" class=\"headerlink\" title=\"2.4.1.3 \"></a>2.4.1.3 </h4><p> epoll  epoll </p>\n<p> init </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Wait </p>\n<h5 id=\"2-4-1-3-1--epoll-wait\"><a href=\"#2-4-1-3-1--epoll-wait\" class=\"headerlink\" title=\"2.4.1.3.1  epoll_wait\"></a>2.4.1.3.1  epoll_wait</h5><p> Wait  epoll_wait Wait </p>\n<p><strong>epoll_wait</strong>  <code>int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout)</code> epoll </p>\n<p> epoll_wait </p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<h6 id=\"2-4-1-3-1-1-\"><a href=\"#2-4-1-3-1-1-\" class=\"headerlink\" title=\"2.4.1.3.1.1 \"></a>2.4.1.3.1.1 </h6><p> epoll_wait </p>\n<ul>\n<li><p><strong>epfd</strong>  epoll </p>\n</li>\n<li><p><strong>events</strong>  epoll_event  epoll_event  [2.4.1.2.1] </p>\n<p> events  epoll_event  data  epoll_ctl  data  epoll_ctl  event.data  epoll_wait </p>\n</li>\n<li><p><strong>maxevents</strong>  events  maxevents</p>\n</li>\n<li><p><strong>timeout</strong>  timeout = -1  timeout = 0 </p>\n</li>\n</ul>\n<h6 id=\"2-4-1-3-1-2-\"><a href=\"#2-4-1-3-1-2-\" class=\"headerlink\" title=\"2.4.1.3.1.2 \"></a>2.4.1.3.1.2 </h6><p> epoll_wait </p>\n<ul>\n<li><p> I/O </p>\n<p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-1-3-2--Wait-\"><a href=\"#2-4-1-3-2--Wait-\" class=\"headerlink\" title=\"2.4.1.3.2  Wait \"></a>2.4.1.3.2  Wait </h5><p> epoll_wait  Wait  <code>system/core/init/epoll.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::Wait</span><span class=\"params\">(<span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt; timeout)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  -1</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> timeout_ms = <span class=\"number\">-1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout &amp;&amp; timeout-&gt;count() &lt; INT_MAX) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  timeout  0 , </span></span><br><span class=\"line\">        timeout_ms = timeout-&gt;count();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_event ev;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll_wait </span></span><br><span class=\"line\">    <span class=\"comment\">//  1,  1 </span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd_, &amp;ev, <span class=\"number\">1</span>, timeout_ms));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nr == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  -1, </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_wait failed&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (nr == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  1, ,  1 </span></span><br><span class=\"line\">        <span class=\"comment\">// ev.data.ptr  epoll_ctl , </span></span><br><span class=\"line\">        <span class=\"built_in\">std</span>::invoke(*<span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt;*&gt;(ev.data.ptr));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>epoll_wait</code>  <code>epoll_wait</code>  epoll_ctl </p>\n<h3 id=\"2-4-2-\"><a href=\"#2-4-2-\" class=\"headerlink\" title=\"2.4.2 \"></a>2.4.2 </h3><p> Android  key-value </p>\n<p> adb <code>getprop</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ro.product.brand]: [Redmi]</span><br><span class=\"line\">[ro.product.manufacturer]: [Xiaomi]</span><br><span class=\"line\">[ro.product.marketname]: [Redmi K30S Ultra]</span><br><span class=\"line\">[ro.product.model]: [M2007J3SC]</span><br><span class=\"line\">[ro.product.name]: [apollo]</span><br><span class=\"line\"></span><br><span class=\"line\">[ro.product.cpu.abi]: [arm64-v8a]</span><br><span class=\"line\">[ro.product.cpu.abilist]: [arm64-v8a,armeabi-v7a,armeabi]</span><br><span class=\"line\">[ro.product.cpu.abilist32]: [armeabi-v7a,armeabi]</span><br><span class=\"line\">[ro.product.cpu.abilist64]: [arm64-v8a]</span><br><span class=\"line\"></span><br><span class=\"line\">[dalvik.vm.heapsize]: [512m]</span><br><span class=\"line\">[dalvik.vm.heapstartsize]: [8m]</span><br></pre></td></tr></table></figure>\n<p>CPU </p>\n<p> Java  <code>SystemProperties.get(String, String)</code>  ActivityManager </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">staticGetLargeMemoryClass</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  dalvik.vm.heapsize, </span></span><br><span class=\"line\">    String vmHeapSize = SystemProperties.get(<span class=\"string\">&quot;dalvik.vm.heapsize&quot;</span>, <span class=\"string\">&quot;16m&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> Integer.parseInt(vmHeapSize.substring(<span class=\"number\">0</span>, vmHeapSize.length() - <span class=\"number\">1</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>SystemProperties.set(String, String)</code>  ActivityManagerService </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">finishBooting</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Tell anyone interested that we are done booting!</span></span><br><span class=\"line\">        <span class=\"comment\">//  sys.boot_completed = 1, </span></span><br><span class=\"line\">        SystemProperties.set(<span class=\"string\">&quot;sys.boot_completed&quot;</span>, <span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"2-4-2-1-\"><a href=\"#2-4-2-1-\" class=\"headerlink\" title=\"2.4.2.1 \"></a>2.4.2.1 </h4><!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: CreateSerializedPropertyInfo() -->\n\n<!-- TODO: property_info_area.LoadDefaultPath() -->\n\n<p> property_init  <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">property_init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    mkdir(<span class=\"string\">&quot;/dev/__properties__&quot;</span>, S_IRWXU | S_IXGRP | S_IXOTH);</span><br><span class=\"line\">    CreateSerializedPropertyInfo();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (__system_property_area_init()) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Failed to initialize property area&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!property_info_area.LoadDefaultPath()) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Failed to load serialized property info file&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>__system_property_area_init</code> </p>\n<h4 id=\"2-4-2-2-\"><a href=\"#2-4-2-2-\" class=\"headerlink\" title=\"2.4.2.2 \"></a>2.4.2.2 </h4><!-- TODO: socket  -->\n\n<!-- TODO: listen(property_set_fd, 8) -->\n\n<!-- TODO:  init  -->\n\n<p> StartPropertyService  <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">StartPropertyService</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  socket ,  PROP_SERVICE_NAME = &quot;property_service&quot;</span></span><br><span class=\"line\">    property_set_fd = CreateSocket(PROP_SERVICE_NAME, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK,</span><br><span class=\"line\">                                   <span class=\"literal\">false</span>, <span class=\"number\">0666</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"literal\">nullptr</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (property_set_fd == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;start_property_service socket creation failed&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    listen(property_set_fd, <span class=\"number\">8</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  socket  epoll,  [2.4.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">// handle_property_set_fd  [2.4.2.3]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll-&gt;RegisterHandler(property_set_fd, handle_property_set_fd); !result) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> property_service  socket socket  epoll</p>\n<p> <code>handle_property_set_fd</code></p>\n<h4 id=\"2-4-2-3--handle-property-set-fd\"><a href=\"#2-4-2-3--handle-property-set-fd\" class=\"headerlink\" title=\"2.4.2.3  handle_property_set_fd\"></a>2.4.2.3  handle_property_set_fd</h4><!-- TODO: ucred cr; socklen_t cr_size = sizeof(cr); -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  init ,  -->\n\n<!-- TODO:  -->\n\n<p> <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">handle_property_set_fd</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 2000ms</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">constexpr</span> <span class=\"keyword\">uint32_t</span> kDefaultSocketTimeout = <span class=\"number\">2000</span>; <span class=\"comment\">/* ms */</span></span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">SocketConnection <span class=\"title\">socket</span><span class=\"params\">(s, cr)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  2000ms </span></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> timeout_ms = kDefaultSocketTimeout;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> cmd = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!socket.RecvUint32(&amp;cmd, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop: error while reading command from the socket&quot;</span>;</span><br><span class=\"line\">        socket.SendUint32(PROP_ERROR_READ_CMD);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (cmd) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//  PROP_MSG_SETPROP </span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> PROP_MSG_SETPROP: &#123;</span><br><span class=\"line\">        <span class=\"comment\">// PROP_NAME_MAX = 32</span></span><br><span class=\"line\">        <span class=\"keyword\">char</span> prop_name[PROP_NAME_MAX];</span><br><span class=\"line\">        <span class=\"keyword\">char</span> prop_value[PROP_VALUE_MAX];</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ,  prop_name  prop_value </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!socket.RecvChars(prop_name, PROP_NAME_MAX, &amp;timeout_ms) ||</span><br><span class=\"line\">            !socket.RecvChars(prop_value, PROP_VALUE_MAX, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">          PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop(PROP_MSG_SETPROP): error while reading name/value from the socket&quot;</span>;</span><br><span class=\"line\">          <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  0</span></span><br><span class=\"line\">        prop_name[PROP_NAME_MAX<span class=\"number\">-1</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\">        prop_value[PROP_VALUE_MAX<span class=\"number\">-1</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; cr = socket.cred();</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> error;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> result =</span><br><span class=\"line\">            HandlePropertySet(prop_name, prop_value, socket.source_context(), cr, &amp;error);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != PROP_SUCCESS) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to set property &#x27;&quot;</span> &lt;&lt; prop_name &lt;&lt; <span class=\"string\">&quot;&#x27; to &#x27;&quot;</span> &lt;&lt; prop_value</span><br><span class=\"line\">                       &lt;&lt; <span class=\"string\">&quot;&#x27; from uid:&quot;</span> &lt;&lt; cr.uid &lt;&lt; <span class=\"string\">&quot; gid:&quot;</span> &lt;&lt; cr.gid &lt;&lt; <span class=\"string\">&quot; pid:&quot;</span> &lt;&lt; cr.pid &lt;&lt; <span class=\"string\">&quot;: &quot;</span></span><br><span class=\"line\">                       &lt;&lt; error;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  PROP_MSG_SETPROP2 </span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> PROP_MSG_SETPROP2: &#123;</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> name;</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!socket.RecvString(&amp;name, &amp;timeout_ms) ||</span><br><span class=\"line\">            !socket.RecvString(&amp;value, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">          PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop(PROP_MSG_SETPROP2): error while reading name/value from the socket&quot;</span>;</span><br><span class=\"line\">          socket.SendUint32(PROP_ERROR_READ_DATA);</span><br><span class=\"line\">          <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; cr = socket.cred();</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> error;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> result = HandlePropertySet(name, value, socket.source_context(), cr, &amp;error);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != PROP_SUCCESS) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to set property &#x27;&quot;</span> &lt;&lt; name &lt;&lt; <span class=\"string\">&quot;&#x27; to &#x27;&quot;</span> &lt;&lt; value</span><br><span class=\"line\">                       &lt;&lt; <span class=\"string\">&quot;&#x27; from uid:&quot;</span> &lt;&lt; cr.uid &lt;&lt; <span class=\"string\">&quot; gid:&quot;</span> &lt;&lt; cr.gid &lt;&lt; <span class=\"string\">&quot; pid:&quot;</span> &lt;&lt; cr.pid &lt;&lt; <span class=\"string\">&quot;: &quot;</span></span><br><span class=\"line\">                       &lt;&lt; error;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        socket.SendUint32(result);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop: invalid command &quot;</span> &lt;&lt; cmd;</span><br><span class=\"line\">        socket.SendUint32(PROP_ERROR_INVALID_CMD);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> socket  <code>cmd</code> </p>\n<ul>\n<li> <code>PROP_MSG_SETPROP</code>  <code>PROP_NAME_MAX</code>  0 <code>PROP_NAME_MAX - 1</code> </li>\n<li> <code>PROP_MSG_SETPROP2</code>  <code>std::string</code> </li>\n</ul>\n<p> <code>PROP_MSG_SETPROP</code>  <code>PROP_MSG_SETPROP2</code>  <code>HandlePropertySet</code> </p>\n<h3 id=\"2-4-3-\"><a href=\"#2-4-3-\" class=\"headerlink\" title=\"2.4.3 \"></a>2.4.3 </h3><p><strong> (Signals)</strong>  IPC </p>\n<p><strong></strong></p>\n<h4 id=\"2-4-3-1-\"><a href=\"#2-4-3-1-\" class=\"headerlink\" title=\"2.4.3.1 \"></a>2.4.3.1 </h4><p> Linux (PID) waitwaitpid  waitid ** (Zombie process)**</p>\n<p> init init </p>\n<p> [2.4.4] init  fork servicemanager zygote  Android init </p>\n<p>init </p>\n<p> Android Linux </p>\n<h5 id=\"2-4-3-1-1-\"><a href=\"#2-4-3-1-1-\" class=\"headerlink\" title=\"2.4.3.1.1 \"></a>2.4.3.1.1 </h5><!-- :  -->\n\n<p></p>\n<ul>\n<li>\u0015\u0015<strong></strong></li>\n<li><strong></strong></li>\n<li><strong></strong></li>\n</ul>\n<p>init </p>\n<p></p>\n<h5 id=\"2-4-3-1-2--sigaction\"><a href=\"#2-4-3-1-2--sigaction\" class=\"headerlink\" title=\"2.4.3.1.2  sigaction\"></a>2.4.3.1.2  sigaction</h5><p> init  sigaction</p>\n<p><strong>sigaction</strong>  <code>int sigaction(int signum, const struct sigaction *restrict act, struct sigaction *restrict oldact)</code></p>\n<h6 id=\"2-4-3-1-2-1-\"><a href=\"#2-4-3-1-2-1-\" class=\"headerlink\" title=\"2.4.3.1.2.1 \"></a>2.4.3.1.2.1 </h6><p> sigaction </p>\n<ul>\n<li><p><strong>signum</strong> </p>\n<p> AndroidARM  <code>bionic/libc/kernel/uapi/asm-arm/asm/signal.h</code> </p>\n</li>\n<li><p><strong>act</strong>  sigaction  sigaction </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_handler)(<span class=\"keyword\">int</span>);</span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_sigaction)(<span class=\"keyword\">int</span>, <span class=\"keyword\">siginfo_t</span> *, <span class=\"keyword\">void</span> *);</span><br><span class=\"line\">   <span class=\"keyword\">sigset_t</span>   sa_mask;</span><br><span class=\"line\">   <span class=\"keyword\">int</span>        sa_flags;</span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_restorer)(<span class=\"keyword\">void</span>);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>sa_handler</code>  <code>sa_flags</code></p>\n<p> <code>sa_handler</code> </p>\n<ul>\n<li><p><strong>SIG_DFL</strong></p>\n<p></p>\n</li>\n<li><p><strong>SIG_IGN</strong></p>\n<p></p>\n</li>\n<li><p><strong></strong></p>\n<p> signum </p>\n</li>\n</ul>\n<p> <code>sa_flags</code> </p>\n<ul>\n<li><p><strong>SA_NOCLDSTOP</strong></p>\n<p> signum = SIGCHLD </p>\n</li>\n<li><p><strong>SA_RESETHAND</strong></p>\n<p></p>\n</li>\n<li><p><strong>SA_SIGINFO</strong></p>\n<p> sa_handler  sa_sigaction</p>\n</li>\n</ul>\n</li>\n<li><p><strong>oldact</strong>  sigaction  sigaction  act</p>\n</li>\n</ul>\n<h6 id=\"2-4-3-1-2-2-\"><a href=\"#2-4-3-1-2-2-\" class=\"headerlink\" title=\"2.4.3.1.2.2 \"></a>2.4.3.1.2.2 </h6><p> sigaction </p>\n<ul>\n<li><p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-3-1-3-init-\"><a href=\"#2-4-3-1-3-init-\" class=\"headerlink\" title=\"2.4.3.1.3 init \"></a>2.4.3.1.3 init </h5><p> sigaction  init </p>\n<h6 id=\"2-4-3-1-3-1--sigaction\"><a href=\"#2-4-3-1-3-1--sigaction\" class=\"headerlink\" title=\"2.4.3.1.3.1  sigaction\"></a>2.4.3.1.3.1  sigaction</h6><p>init  InstallSignalFdHandler  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">InstallSignalFdHandler</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  sigaction</span></span><br><span class=\"line\">    <span class=\"comment\">//  sa_handler ,  sa_handler = SIG_DFL </span></span><br><span class=\"line\">    <span class=\"comment\">//  sa_flags ,  sa_flags = SA_NOCLDSTOP  init , </span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> <span class=\"title\">act</span> &#123;</span> .sa_handler = SIG_DFL, .sa_flags = SA_NOCLDSTOP &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sigaction ,  [2.4.3.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">//  SIGCHLD,  SIGCHLD, , , , </span></span><br><span class=\"line\">    sigaction(SIGCHLD, &amp;act, <span class=\"literal\">nullptr</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> sigaction <code>SIGCHLD</code>  <code>SIGCHLD</code> </p>\n<p> <code>SIGCHLD</code>  <code>SA_NOCLDSTOP</code>  init </p>\n<p>init  signal  InstallSignalFdHandler </p>\n<h6 id=\"2-4-3-1-3-2--signal-\"><a href=\"#2-4-3-1-3-2--signal-\" class=\"headerlink\" title=\"2.4.3.1.3.2  signal \"></a>2.4.3.1.3.2  signal </h6><p></p>\n<p>Linux  signalfd</p>\n<p>init </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">InstallSignalFdHandler</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// mask , </span></span><br><span class=\"line\">    <span class=\"comment\">// ,  SIGCHLD</span></span><br><span class=\"line\">    <span class=\"keyword\">sigset_t</span> mask;</span><br><span class=\"line\">    sigemptyset(&amp;mask);</span><br><span class=\"line\">    sigaddset(&amp;mask, SIGCHLD);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal </span></span><br><span class=\"line\">    <span class=\"comment\">// ,  signalfd ,  -1, </span></span><br><span class=\"line\">    signal_fd = signalfd(<span class=\"number\">-1</span>, &amp;mask, SFD_CLOEXEC);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (signal_fd == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;failed to create signalfd&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal  epoll,  [2.4.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">// HandleSignalFd  [2.4.3.1.4]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll-&gt;RegisterHandler(signal_fd, HandleSignalFd); !result) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>SIGCHLD</code> signal  epoll</p>\n<p> signal  HandleSignalFd </p>\n<h5 id=\"2-4-3-1-4--HandleSignalFd\"><a href=\"#2-4-3-1-4--HandleSignalFd\" class=\"headerlink\" title=\"2.4.3.1.4  HandleSignalFd\"></a>2.4.3.1.4  HandleSignalFd</h5><p> <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">HandleSignalFd</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    signalfd_siginfo siginfo;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal  signalfd_siginfo, </span></span><br><span class=\"line\">    <span class=\"keyword\">ssize_t</span> bytes_read = TEMP_FAILURE_RETRY(read(signal_fd, &amp;siginfo, <span class=\"keyword\">sizeof</span>(siginfo)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bytes_read != <span class=\"keyword\">sizeof</span>(siginfo)) &#123;</span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Failed to read siginfo from signal_fd&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (siginfo.ssi_signo) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SIGCHLD:</span><br><span class=\"line\">            ReapAnyOutstandingChildren();</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SIGTERM:</span><br><span class=\"line\">            HandleSigtermSignal(siginfo);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;signal_fd: received unexpected signal &quot;</span> &lt;&lt; siginfo.ssi_signo;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>signal  signalfd_siginfo HandleSignalFd  signal  signalfd_siginfo</p>\n<p> <code>SIGCHLD</code> ReapAnyOutstandingChildren </p>\n<h6 id=\"2-4-3-1-4-1--ReapAnyOutstandingChildren-\"><a href=\"#2-4-3-1-4-1--ReapAnyOutstandingChildren-\" class=\"headerlink\" title=\"2.4.3.1.4.1  ReapAnyOutstandingChildren \"></a>2.4.3.1.4.1  ReapAnyOutstandingChildren </h6><p> <code>system/core/init/sigchld_handler.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">ReapAnyOutstandingChildren</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (ReapOneProcess()) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> ReapOneProcess  ReapOneProcess  false  ReapOneProcess </p>\n<h6 id=\"2-4-3-1-4-2--ReapOneProcess-\"><a href=\"#2-4-3-1-4-2--ReapOneProcess-\" class=\"headerlink\" title=\"2.4.3.1.4.2  ReapOneProcess \"></a>2.4.3.1.4.2  ReapOneProcess </h6><!-- TODO:  service->flags() -->\n\n<!-- TODO:  ServiceList::GetInstance().RemoveService(*service) -->\n\n<p> <code>system/core/init/sigchld_handler.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">bool</span> <span class=\"title\">ReapOneProcess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">siginfo_t</span> siginfo = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  waitid, </span></span><br><span class=\"line\">    <span class=\"comment\">//  init , ,  siginfo </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (TEMP_FAILURE_RETRY(waitid(P_ALL, <span class=\"number\">0</span>, &amp;siginfo, WEXITED | WNOHANG | WNOWAIT)) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  false</span></span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;waitid failed&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  pid</span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> pid = siginfo.si_pid;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  pid ,  false</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> name;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> wait_string;</span><br><span class=\"line\">    Service* service = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (PropertyChildReap(pid)) &#123;</span><br><span class=\"line\">        name = <span class=\"string\">&quot;Async property child&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (SubcontextChildReap(pid)) &#123;</span><br><span class=\"line\">        name = <span class=\"string\">&quot;Subcontext&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  pid  service</span></span><br><span class=\"line\">        service = ServiceList::GetInstance().FindService(pid, &amp;Service::pid);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (service) &#123;</span><br><span class=\"line\">            name = StringPrintf(<span class=\"string\">&quot;Service &#x27;%s&#x27; (pid %d)&quot;</span>, service-&gt;name().c_str(), pid);</span><br><span class=\"line\"></span><br><span class=\"line\">            ...</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            name = StringPrintf(<span class=\"string\">&quot;Untracked pid %d&quot;</span>, pid);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service,  true</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!service) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service  Reap </span></span><br><span class=\"line\">    service-&gt;Reap(siginfo);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ReapOneProcess  waitid pid  service service  service  Reap  Reap </p>\n<h6 id=\"2-4-3-1-4-3--Reap-\"><a href=\"#2-4-3-1-4-3--Reap-\" class=\"headerlink\" title=\"2.4.3.1.4.3  Reap \"></a>2.4.3.1.4.3  Reap </h6><p> <code>system/core/init/service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Service::Reap</span><span class=\"params\">(<span class=\"keyword\">const</span> <span class=\"keyword\">siginfo_t</span>&amp; siginfo)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(flags_ &amp; SVC_ONESHOT) || (flags_ &amp; SVC_RESTART)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_ONESHOT  SVC_RESTART, </span></span><br><span class=\"line\">        KillProcessGroup(SIGKILL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_TEMPORARY, </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (flags_ &amp; SVC_TEMPORARY) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    pid_ = <span class=\"number\">0</span>;</span><br><span class=\"line\">    flags_ &amp;= (~SVC_RUNNING);</span><br><span class=\"line\">    start_order_ = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((flags_ &amp; SVC_ONESHOT) &amp;&amp; !(flags_ &amp; SVC_RESTART) &amp;&amp; !(flags_ &amp; SVC_RESET)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_ONESHOT </span></span><br><span class=\"line\">        flags_ |= SVC_DISABLED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (flags_ &amp; (SVC_DISABLED | SVC_RESET))  &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_DISABLED  SVC_RESET,  stopped , </span></span><br><span class=\"line\">        NotifyStateChange(<span class=\"string\">&quot;stopped&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_CRITICAL </span></span><br><span class=\"line\">    <span class=\"comment\">//  4  4 , </span></span><br><span class=\"line\">    <span class=\"comment\">//  bootloader </span></span><br><span class=\"line\">    boot_clock::time_point now = boot_clock::now();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (((flags_ &amp; SVC_CRITICAL) || !pre_apexd_) &amp;&amp; !(flags_ &amp; SVC_RESTART)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">bool</span> boot_completed = android::base::GetBoolProperty(<span class=\"string\">&quot;sys.boot_completed&quot;</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (now &lt; time_crashed_ + <span class=\"number\">4</span>min || !boot_completed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (++crash_count_ &gt; <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (flags_ &amp; SVC_CRITICAL) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// Aborts into bootloader</span></span><br><span class=\"line\">                    LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;critical process &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class=\"string\">&quot;&#x27; exited 4 times &quot;</span></span><br><span class=\"line\">                               &lt;&lt; (boot_completed ? <span class=\"string\">&quot;in 4 minutes&quot;</span> : <span class=\"string\">&quot;before boot completed&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;updatable process &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class=\"string\">&quot;&#x27; exited 4 times &quot;</span></span><br><span class=\"line\">                               &lt;&lt; (boot_completed ? <span class=\"string\">&quot;in 4 minutes&quot;</span> : <span class=\"string\">&quot;before boot completed&quot;</span>);</span><br><span class=\"line\">                    <span class=\"comment\">// Notifies update_verifier and apexd</span></span><br><span class=\"line\">                    property_set(<span class=\"string\">&quot;ro.init.updatable_crashing&quot;</span>, <span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            time_crashed_ = now;</span><br><span class=\"line\">            crash_count_ = <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_RESTARTING, init  [2.4.5.2]</span></span><br><span class=\"line\">    flags_ &amp;= (~SVC_RESTART);</span><br><span class=\"line\">    flags_ |= SVC_RESTARTING;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service  onrestart </span></span><br><span class=\"line\">    onrestart_.ExecuteAllCommands();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  restarting </span></span><br><span class=\"line\">    NotifyStateChange(<span class=\"string\">&quot;restarting&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Reap  NotifyStateChange </p>\n<h6 id=\"2-4-3-1-4-4--NotifyStateChange-\"><a href=\"#2-4-3-1-4-4--NotifyStateChange-\" class=\"headerlink\" title=\"2.4.3.1.4.4  NotifyStateChange \"></a>2.4.3.1.4.4  NotifyStateChange </h6><p> <code>system/core/init/service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Service::NotifyStateChange</span><span class=\"params\">(<span class=\"keyword\">const</span> <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span>&amp; new_state)</span> <span class=\"keyword\">const</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((flags_ &amp; SVC_TEMPORARY) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_TEMPORARY, </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> prop_name = <span class=\"string\">&quot;init.svc.&quot;</span> + name_;</span><br><span class=\"line\">    property_set(prop_name, new_state);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> key-value  key  init.svc.[service_name]value  adb <code>getprop | grep init.svc.</code> service </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[init.svc.adbd]: [running]</span><br><span class=\"line\">[init.svc.alarm-hal-1-0]: [running]</span><br><span class=\"line\">[init.svc.android.thermal-hal]: [running]</span><br><span class=\"line\">[init.svc.apexd]: [stopped]</span><br><span class=\"line\">[init.svc.apexd-bootstrap]: [stopped]</span><br><span class=\"line\">[init.svc.apexd-snapshotde]: [stopped]</span><br><span class=\"line\">[init.svc.audioserver]: [running]</span><br><span class=\"line\">[init.svc.wifidisplayhalservice]: [running]</span><br><span class=\"line\">[init.svc.wpa_supplicant]: [running]</span><br><span class=\"line\">[init.svc.zygote]: [running]</span><br><span class=\"line\">[init.svc.zygote_secondary]: [running]</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"2-4-4-\"><a href=\"#2-4-4-\" class=\"headerlink\" title=\"2.4.4 \"></a>2.4.4 </h3><!-- TODO:  CreateParser -->\n\n<!-- TODO: .rc  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: /system/etc/init -->\n\n<!-- TODO: /odm/etc/init -->\n\n<!-- TODO: /vendor/etc/init -->\n\n<p> LoadBootScripts  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">LoadBootScripts</span><span class=\"params\">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> </span>&#123;</span><br><span class=\"line\">    Parser parser = CreateParser(action_manager, service_list);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootscript = GetProperty(<span class=\"string\">&quot;ro.boot.init_rc&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootscript.empty()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  init.rc  [2.4.4.1]</span></span><br><span class=\"line\">        parser.ParseConfig(<span class=\"string\">&quot;/init.rc&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /system/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/system/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/system/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /product/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /product_services/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /odm/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/odm/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/odm/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /vendor/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        parser.ParseConfig(bootscript);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li><code>init.rc</code>  .rc </li>\n<li><code>/system/etc/init/</code> SurfaceFlinger, MediaService, logcatd</li>\n<li><code>/vendor/etc/init/</code>  SoC  SoC </li>\n<li><code>/odm/etc/init/</code> </li>\n</ul>\n<p>init.rc </p>\n<h4 id=\"2-4-4-1-init-rc-\"><a href=\"#2-4-4-1-init-rc-\" class=\"headerlink\" title=\"2.4.4.1 init.rc \"></a>2.4.4.1 init.rc </h4><p> Android .rc  Android Init Language <a href=\"https://cs.android.com/android/platform/superproject/+/android-security-10.0.0_r56:system/core/init/README.md\"> Android Init Language </a>  AOSP  <code>system/core/init/README.md</code></p>\n<p></p>\n<h5 id=\"2-4-4-1-1-Android-Init-Language\"><a href=\"#2-4-4-1-1-Android-Init-Language\" class=\"headerlink\" title=\"2.4.4.1.1 Android Init Language\"></a>2.4.4.1.1 Android Init Language</h5><p>Android Init Language <code>Actions</code><code>Commands</code><code>Services</code><code>Options</code><code>Imports</code></p>\n<p></p>\n<ul>\n<li> token token </li>\n<li> token  c  <code>\\</code>  token</li>\n<li> <code>\\</code></li>\n<li> <code>#</code> </li>\n<li> <code>$&#123;property.name&#125;</code> <code>import /init.recovery.$&#123;ro.hardware&#125;.rc</code></li>\n<li> section <code>Actions</code>  <code>Services</code>  section <code>Commands</code>  <code>Options</code>  section section  <code>Commands</code>  <code>Options</code> </li>\n<li><code>Services</code>  <code>Services</code> </li>\n</ul>\n<p></p>\n<h6 id=\"2-4-4-1-1-1-Actions\"><a href=\"#2-4-4-1-1-1-Actions\" class=\"headerlink\" title=\"2.4.4.1.1.1 Actions\"></a>2.4.4.1.1.1 Actions</h6><p><code>Actions</code>   <code>Commands</code>  <code>Triggers</code>  <code>Actions</code> </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]*</span><br><span class=\"line\">   &lt;command&gt;</span><br><span class=\"line\">   &lt;command&gt;</span><br><span class=\"line\">   &lt;command&gt;</span><br></pre></td></tr></table></figure>\n<p> <code>Actions</code>   <code>Triggers</code> <code>Actions</code> </p>\n<p> <code>Actions</code>  <code>Actions</code>  <code>Commands</code></p>\n<p> Zygote </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unencrypted</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br></pre></td></tr></table></figure>\n<p></p>\n<p> <code>Actions</code>  <code>Triggers</code> <code>zygote-start</code>  <code>property:ro.crypto.state=unencrypted</code> <code>Command</code></p>\n<p> <code>zygote-start</code>  <code>property:ro.crypto.state=unencrypted</code> <code>Actions</code>  <code>Actions</code>  <code>Commands</code>  <code>Actions</code>  <code>Commands</code></p>\n<h6 id=\"2-4-4-1-1-2-Triggers\"><a href=\"#2-4-4-1-1-2-Triggers\" class=\"headerlink\" title=\"2.4.4.1.1.2 Triggers\"></a>2.4.4.1.1.2 Triggers</h6><p><code>Triggers</code>  <code>Actions</code>  <code>Commands</code></p>\n<p>Triggers </p>\n<ul>\n<li><p><strong>Event triggers</strong></p>\n<p> <code>trigger</code>   <code>QueueEventTrigger()</code> </p>\n</li>\n<li><p><strong>Property triggers</strong></p>\n<p> <code>property:&lt;key&gt;=&lt;value&gt;</code></p>\n</li>\n</ul>\n<p> <code>Actions</code> </p>\n<p></p>\n<p><code>on init &amp;&amp; property:a=b</code><code>on property:a=b &amp;&amp; property:c=d</code> </p>\n<p><code>on boot &amp;&amp; on init</code> </p>\n<h6 id=\"2-4-4-1-1-3-Commands\"><a href=\"#2-4-4-1-1-3-Commands\" class=\"headerlink\" title=\"2.4.4.1.1.3 Commands\"></a>2.4.4.1.1.3 Commands</h6><p> <code>Commands</code></p>\n<ul>\n<li><p><strong>trigger <event></strong></p>\n<p></p>\n</li>\n<li><p><strong>write <path> <content></strong></p>\n<p> path </p>\n</li>\n<li><p><strong>chown <owner> <group> <path></strong></p>\n<p></p>\n</li>\n<li><p><strong>mkdir <path> [mode] [owner] [group]</strong></p>\n<p> </p>\n<p> 755 root  root </p>\n<p></p>\n</li>\n<li><p><strong>start <service></strong></p>\n<p></p>\n</li>\n<li><p><strong>exec_start <service></strong></p>\n<p></p>\n</li>\n<li><p><strong>setprop <name> <value></strong></p>\n<p></p>\n</li>\n<li><p><strong>symlink <target> <path></strong></p>\n<p> path  target </p>\n</li>\n</ul>\n<h6 id=\"2-4-4-1-1-4-Services\"><a href=\"#2-4-4-1-1-4-Services\" class=\"headerlink\" title=\"2.4.4.1.1.4 Services\"></a>2.4.4.1.1.4 Services</h6><p><code>Services</code>  init  init  init  <code>Services</code>  fork </p>\n<p><code>Services</code> </p>\n<p><code>Services</code> </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service &lt;name&gt; &lt;pathname&gt; [ &lt;argument&gt; ]*</span><br><span class=\"line\">   &lt;option&gt;</span><br><span class=\"line\">   &lt;option&gt;</span><br><span class=\"line\">   ...</span><br></pre></td></tr></table></figure>\n<p> Zygote 64 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service zygote &#x2F;system&#x2F;bin&#x2F;app_process64 -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server</span><br><span class=\"line\">    class main</span><br><span class=\"line\">    priority -20</span><br><span class=\"line\">    user root</span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\">    socket zygote stream 660 root system</span><br><span class=\"line\">    socket usap_pool_primary stream 660 root system</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;android_power&#x2F;request_state wake</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;power&#x2F;state on</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart netd</span><br><span class=\"line\">    onrestart restart wificond</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br></pre></td></tr></table></figure>\n<p><code>zygote</code>  <code>Services</code> <code>/system/bin/app_process64</code> <code>-Xzygote /system/bin --zygote --start-system-server</code>  <code>Options</code></p>\n<h6 id=\"2-4-4-1-1-5-Options\"><a href=\"#2-4-4-1-1-5-Options\" class=\"headerlink\" title=\"2.4.4.1.1.5 Options\"></a>2.4.4.1.1.5 Options</h6><p><code>Options</code>  <code>Services</code>  init  <code>Services</code> </p>\n<p>  <code>Options</code></p>\n<ul>\n<li><p><strong>class <name> [ <name>* ]</strong></p>\n<p> <code>Services</code>  <code>Services</code>  () <code>Services</code>  ()  default</p>\n</li>\n<li><p><strong>class_start <serviceclass></strong></p>\n<p> <code>serviceclass</code>  <code>Services</code></p>\n</li>\n<li><p><strong>priority <priority></strong></p>\n<p> <code>Services</code>  -20 ~ 19 0</p>\n</li>\n<li><p><strong>user <username></strong></p>\n<p> <code>Services</code>  root</p>\n</li>\n<li><p><strong>group <groupname> [ <groupname>* ]</strong></p>\n<p> <code>Services</code>  root</p>\n</li>\n<li><p><strong>socket <name> <type> <perm> [ <user> [ <group> [ <seclabel> ] ] ]</strong></p>\n<p> unix  socket <code>/dev/socket/&lt;name&gt;</code> socket </p>\n</li>\n<li><p><strong>onrestart</strong></p>\n<p> <code>Services</code>  <code>Commands</code></p>\n</li>\n<li><p><strong>oneshot</strong></p>\n<p> <code>Services</code> </p>\n</li>\n<li><p><strong>writepid <file> [ <file>* ]</strong></p>\n<p> fork  pid </p>\n</li>\n</ul>\n<h5 id=\"2-4-4-1-2--init-rc-\"><a href=\"#2-4-4-1-2--init-rc-\" class=\"headerlink\" title=\"2.4.4.1.2  init.rc \"></a>2.4.4.1.2  init.rc </h5><p> init.rc  <code>system/core/rootdir/init.rc</code></p>\n<p>  <code>Actions</code>  <code>Services</code>  init.rc  <code>Actions</code> [2.4.4.1.1.2]  <code>QueueEventTrigger()</code>   <code>Actions</code>   <code>Triggers</code> <code>Actions</code> </p>\n<h6 id=\"2-4-4-1-2-1-\"><a href=\"#2-4-4-1-2-1-\" class=\"headerlink\" title=\"2.4.4.1.2.1 \"></a>2.4.4.1.2.1 </h6><p> init  <code>system/core/init/init.cpp</code>  SecondStageMain </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  early-init  ActionManager</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Trigger all the boot actions to get us started.</span></span><br><span class=\"line\">    <span class=\"comment\">//  init  ActionManager</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t mount filesystems or start core system services in charger mode.</span></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootmode = GetProperty(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  charger  ActionManager</span></span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  late-init  ActionManager</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ActionManager  [2.4.5.x]</p>\n<ul>\n<li>early-init -&gt; init -&gt; late-init</li>\n<li>early-init -&gt; init -&gt; charger</li>\n</ul>\n<p></p>\n<h6 id=\"2-4-4-1-2-2-init-rc-\"><a href=\"#2-4-4-1-2-2-init-rc-\" class=\"headerlink\" title=\"2.4.4.1.2.2 init.rc \"></a>2.4.4.1.2.2 init.rc </h6><!-- TODO: trigger boot -->\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on early-init</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    #  start  ueventd</span><br><span class=\"line\">    start ueventd</span><br><span class=\"line\"></span><br><span class=\"line\">    #  exec_start  apexd-bootstrap, ,  APEX </span><br><span class=\"line\">    exec_start apexd-bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\">on init</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    #  start </span><br><span class=\"line\">    #  servicemanager [2.4.4.1.2.3]</span><br><span class=\"line\">    start servicemanager</span><br><span class=\"line\">    start hwservicemanager</span><br><span class=\"line\">    start vndservicemanager</span><br><span class=\"line\"></span><br><span class=\"line\"># </span><br><span class=\"line\">#  trigger  [2.4.4.1.1.2]</span><br><span class=\"line\">on late-init</span><br><span class=\"line\">    trigger early-fs</span><br><span class=\"line\">    trigger fs</span><br><span class=\"line\">    trigger post-fs</span><br><span class=\"line\">    trigger late-fs</span><br><span class=\"line\">    trigger post-fs-data</span><br><span class=\"line\">    trigger load_persist_props_action</span><br><span class=\"line\"></span><br><span class=\"line\">    #  zygote-start,  zygote [2.4.4.1.2.4]</span><br><span class=\"line\">    trigger zygote-start</span><br><span class=\"line\"></span><br><span class=\"line\">    trigger firmware_mounts_complete</span><br><span class=\"line\">    trigger early-boot</span><br><span class=\"line\">    trigger boot</span><br></pre></td></tr></table></figure>\n<p> servicemanager  zygote </p>\n<h6 id=\"2-4-4-1-2-3--servicemanager\"><a href=\"#2-4-4-1-2-3--servicemanager\" class=\"headerlink\" title=\"2.4.4.1.2.3  servicemanager\"></a>2.4.4.1.2.3  servicemanager</h6><p>servicemanager  <code>frameworks/native/cmds/servicemanager/servicemanager.rc</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># servicemanager  Services </span><br><span class=\"line\"># &#x2F;system&#x2F;bin&#x2F;servicemanager </span><br><span class=\"line\">service servicemanager &#x2F;system&#x2F;bin&#x2F;servicemanager</span><br><span class=\"line\">    #  core  animation</span><br><span class=\"line\">    #  core  animation  () , servicemanager  ()</span><br><span class=\"line\">    class core animation</span><br><span class=\"line\"></span><br><span class=\"line\">    #  system</span><br><span class=\"line\">    user system</span><br><span class=\"line\"></span><br><span class=\"line\">    #  system  readproc</span><br><span class=\"line\">    group system readproc</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    # ,  bootloader</span><br><span class=\"line\">    critical</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    #  Commands</span><br><span class=\"line\">    onrestart restart healthd</span><br><span class=\"line\">    onrestart restart zygote</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart surfaceflinger</span><br><span class=\"line\">    onrestart restart inputflinger</span><br><span class=\"line\">    onrestart restart drm</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart keystore</span><br><span class=\"line\">    onrestart restart gatekeeperd</span><br><span class=\"line\">    onrestart restart thermalservice</span><br><span class=\"line\"></span><br><span class=\"line\">    #  fork  pid  &#x2F;dev&#x2F;cpuset&#x2F;system-background&#x2F;tasks</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;system-background&#x2F;tasks</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    # shutdown critical , </span><br><span class=\"line\">    shutdown critical</span><br></pre></td></tr></table></figure>\n<p> servicemanager  <code>frameworks/native/cmds/servicemanager/service_manager.c</code>  main </p>\n<h6 id=\"2-4-4-1-2-4--zygote\"><a href=\"#2-4-4-1-2-4--zygote\" class=\"headerlink\" title=\"2.4.4.1.2.4  zygote\"></a>2.4.4.1.2.4  zygote</h6><p> init.rc  <code>zygote-start</code>  3  <code>Actions</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unencrypted</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br><span class=\"line\"></span><br><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unsupported</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br><span class=\"line\"></span><br><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;encrypted &amp;&amp; property:ro.crypto.type&#x3D;file</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br></pre></td></tr></table></figure>\n<p>zygote </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &#x2F;init.$&#123;ro.zygote&#125;.rc</span><br></pre></td></tr></table></figure>\n<p> <code>ro.zygote</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote32.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote32_64.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote64.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote64_32.rc</span><br></pre></td></tr></table></figure>\n<p>zygote  <code>zygote-start</code>  <code>Actions</code>  zygote</p>\n<p> Zygote 64  <code>system/core/rootdir/init.zygote64.rc</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># zygote  Services </span><br><span class=\"line\"># &#x2F;system&#x2F;bin&#x2F;app_process64 </span><br><span class=\"line\"># -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server </span><br><span class=\"line\">service zygote &#x2F;system&#x2F;bin&#x2F;app_process64 -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server</span><br><span class=\"line\">    #  main</span><br><span class=\"line\">    #  main  () , zygote  ()</span><br><span class=\"line\">    class main</span><br><span class=\"line\"></span><br><span class=\"line\">    #  -20</span><br><span class=\"line\">    #  -20 ~ 19, , ,  zygote </span><br><span class=\"line\">    priority -20</span><br><span class=\"line\"></span><br><span class=\"line\">    #  root</span><br><span class=\"line\">    user root</span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\"></span><br><span class=\"line\">    #  socket</span><br><span class=\"line\">    socket zygote stream 660 root system</span><br><span class=\"line\">    socket usap_pool_primary stream 660 root system</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    #  Commands</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;android_power&#x2F;request_state wake</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;power&#x2F;state on</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart netd</span><br><span class=\"line\">    onrestart restart wificond</span><br><span class=\"line\"></span><br><span class=\"line\">    #  zygote  fork  pid  &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br></pre></td></tr></table></figure>\n<p> zygote  <code>frameworks/base/cmds/app_process/app_main.cpp</code>  main </p>\n<h3 id=\"2-4-5-\"><a href=\"#2-4-5-\" class=\"headerlink\" title=\"2.4.5 \"></a>2.4.5 </h3><p>init  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  epoll </span></span><br><span class=\"line\">        <span class=\"comment\">// , ,  epoll_timeout  -1</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = <span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// am ,  ActionManager </span></span><br><span class=\"line\">            <span class=\"comment\">//  ActionManager  [2.4.5.1]</span></span><br><span class=\"line\">            am.ExecuteOneCommand();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!shutting_down) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//  HandleProcessActions  [2.4.5.2]</span></span><br><span class=\"line\">                <span class=\"keyword\">auto</span> next_process_action_time = HandleProcessActions();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (next_process_action_time) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//  next_process_action_time </span></span><br><span class=\"line\">                    epoll_timeout = <span class=\"built_in\">std</span>::chrono::<span class=\"built_in\">ceil</span>&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;(</span><br><span class=\"line\">                            *next_process_action_time - boot_clock::now());</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//  0, </span></span><br><span class=\"line\">                    <span class=\"comment\">//  epoll  0,  Wait , </span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (*epoll_timeout &lt; <span class=\"number\">0</span>ms) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//  ActionManager ,  init , </span></span><br><span class=\"line\">            <span class=\"comment\">//  epoll  0,  Wait , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (am.HasMoreCommands()) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  Wait ,  [2.4.1.3]</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>init  3 </p>\n<ul>\n<li> ActionManager </li>\n<li></li>\n<li> epoll  init  init  <code>SIGCHLD</code> </li>\n</ul>\n<h4 id=\"2-4-5-1-ActionManager\"><a href=\"#2-4-5-1-ActionManager\" class=\"headerlink\" title=\"2.4.5.1 ActionManager\"></a>2.4.5.1 ActionManager</h4><!-- TODO:  Action? -->\n\n<!-- TODO: Action  Actions  -->\n\n<!-- TODO:  -->\n\n<p>ActionManager  Action  Action </p>\n<h5 id=\"2-4-5-1-1--Action\"><a href=\"#2-4-5-1-1--Action\" class=\"headerlink\" title=\"2.4.5.1.1  Action\"></a>2.4.5.1.1  Action</h5><!-- TODO:  Action  -->\n\n<p> init  Action Action </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// am ,  ActionManager </span></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  early-init [2.4.4.1.2.1]</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  coldboot </span></span><br><span class=\"line\">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class=\"string\">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetMmapRndBitsAction, <span class=\"string\">&quot;SetMmapRndBits&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetKptrRestrictAction, <span class=\"string\">&quot;SetKptrRestrict&quot;</span>);</span><br><span class=\"line\">    Keychords keychords;</span><br><span class=\"line\">    am.QueueBuiltinAction(</span><br><span class=\"line\">        [&amp;epoll, &amp;keychords](<span class=\"keyword\">const</span> BuiltinArguments&amp; args) -&gt; Result&lt;Success&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; svc : ServiceList::GetInstance()) &#123;</span><br><span class=\"line\">                keychords.Register(svc-&gt;keycodes());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            keychords.Start(&amp;epoll, HandleKeychord);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;KeychordInit&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(console_init_action, <span class=\"string\">&quot;console_init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  init [2.4.4.1.2.1]</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(StartBoringSslSelfTest, <span class=\"string\">&quot;StartBoringSslSelfTest&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  init  binder</span></span><br><span class=\"line\">    am.QueueBuiltinAction(InitBinder, <span class=\"string\">&quot;InitBinder&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootmode = GetProperty(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  Action:  charger [2.4.4.1.2.1]</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  Action:  late-init [2.4.4.1.2.1]</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action: </span></span><br><span class=\"line\">    am.QueueBuiltinAction(queue_property_triggers_action, <span class=\"string\">&quot;queue_property_triggers&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> ActionManager  Action</p>\n<h4 id=\"2-4-5-2-HandleProcessActions\"><a href=\"#2-4-5-2-HandleProcessActions\" class=\"headerlink\" title=\"2.4.5.2 HandleProcessActions\"></a>2.4.5.2 HandleProcessActions</h4><!-- ((s->flags() & SVC_RUNNING) && s->timeout_period()) -->\n\n<!--  service  -->\n\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"built_in\">std</span>::optional&lt;boot_clock::time_point&gt; <span class=\"title\">HandleProcessActions</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::optional&lt;boot_clock::time_point&gt; next_process_action_time;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  ServiceList</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; s : ServiceList::GetInstance()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((s-&gt;flags() &amp; SVC_RUNNING) &amp;&amp; s-&gt;timeout_period()) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">auto</span> timeout_time = s-&gt;time_started() + *s-&gt;timeout_period();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (boot_clock::now() &gt; timeout_time) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// , </span></span><br><span class=\"line\">                s-&gt;Timeout();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//  next_process_action_time</span></span><br><span class=\"line\">                <span class=\"comment\">// , next_process_action_time , </span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!next_process_action_time || timeout_time &lt; *next_process_action_time) &#123;</span><br><span class=\"line\">                    next_process_action_time = timeout_time;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  SVC_RESTARTING, ,  for </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(s-&gt;flags() &amp; SVC_RESTARTING)) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> restart_time = s-&gt;time_started() + s-&gt;restart_period();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (boot_clock::now() &gt; restart_time) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = s-&gt;Start(); !result) &#123;</span><br><span class=\"line\">                LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Could not restart process &#x27;&quot;</span> &lt;&lt; s-&gt;name() &lt;&lt; <span class=\"string\">&quot;&#x27;: &quot;</span> &lt;&lt; result.error();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//  next_process_action_time</span></span><br><span class=\"line\">            <span class=\"comment\">// , next_process_action_time , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!next_process_action_time || restart_time &lt; *next_process_action_time) &#123;</span><br><span class=\"line\">                next_process_action_time = restart_time;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> next_process_action_time;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p></p>\n<ol>\n<li> <code>SVC_RUNNING</code>  <code>Timeout</code> </li>\n<li> <code>SVC_RESTARTING</code>  </li>\n</ol>\n<p><code>next_process_action_time</code> </p>\n<p> [2.4.3.1.4.3]  init  <code>SVC_RESTARTING</code> init  <code>SVC_RESTARTING</code> </p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"http://gityuan.com/2016/02/01/android-booting/\">Android-</a></p>\n<p><a href=\"http://gityuan.com/2016/02/05/android-init/\">Android-Init</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man7/epoll.7.html\">epoll(7)</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Signal_(IPC)\">Signal</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man7/signal.7.html\">signal(7)</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man2/wait.2.html\">wait(2)</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man2/signalfd.2.html\">signalfd(2)</a></p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>android-security-10.0.0_r56</p>\n</blockquote>\n<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><!-- TODO:  init  -->\n\n<p>Android  Linux  init </p>\n<p>init  pid = 1</p>","more":"<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><!-- TODO:  -->\n\n\n\n<h2 id=\"2-1-init-\"><a href=\"#2-1-init-\" class=\"headerlink\" title=\"2.1 init \"></a>2.1 init </h2><!-- TODO:  -->\n\n<!-- TODO: init ,  /system/core/init -->\n\n<p> Android 9init  <code>system/core/init/init.cpp</code>  main </p>\n<p> Android 10 init  <code>system/core/init/main.cpp</code>  main </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(basename(argv[<span class=\"number\">0</span>]), <span class=\"string\">&quot;ueventd&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ueventd_main(argc, argv);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;subcontext&quot;</span>)) &#123;</span><br><span class=\"line\">            android::base::InitLogging(argv, &amp;android::base::KernelLogger);</span><br><span class=\"line\">            <span class=\"keyword\">const</span> BuiltinFunctionMap&amp; function_map = GetBuiltinFunctionMap();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> SubcontextMain(argc, argv, &amp;function_map);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;selinux_setup&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SetupSelinux(argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;second_stage&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SecondStageMain(argc, argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> FirstStageMain(argc, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>basename</code>  <code>strcmp</code> </p>\n<ul>\n<li><code>basename</code>  <code>char* basename(char* __path)</code> /system/bin/ueventd ueventd</li>\n<li><code>strcmp</code>  <code>int strcmp(const char* __lhs, const char* __rhs)</code> 0</li>\n</ul>\n<p> main  <code>argc</code>  <code>argv</code> <code>FirstStageMain</code> </p>\n<h2 id=\"2-2-\"><a href=\"#2-2-\" class=\"headerlink\" title=\"2.2 \"></a>2.2 </h2><!-- TODO: mkdir, mknod, tmpfs -->\n\n<!-- TODO:  -->\n\n<!-- TODO: KernelLogging(/dev/kmsg) -->\n\n<!-- TODO: InstallRebootSignalHandlers -->\n\n<p> <code>int FirstStageMain(int argc, char** argv)</code>  <code>system/core/init/first_stage_init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">FirstStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(clearenv());</span><br><span class=\"line\">    CHECKCALL(setenv(<span class=\"string\">&quot;PATH&quot;</span>, _PATH_DEFPATH, <span class=\"number\">1</span>));</span><br><span class=\"line\">    <span class=\"comment\">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class=\"line\">    <span class=\"comment\">// on / and then we&#x27;ll let the rc file figure out the rest.</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/dev&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class=\"string\">&quot;mode=0755&quot;</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/socket&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/dm-user&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;devpts&quot;</span>, <span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"string\">&quot;devpts&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> MAKE_STR(x) __STRING(x)</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;proc&quot;</span>, <span class=\"string\">&quot;/proc&quot;</span>, <span class=\"string\">&quot;proc&quot;</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;hidepid=2,gid=&quot;</span> MAKE_STR(AID_READPROC)));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> MAKE_STR</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">    <span class=\"comment\">//  [2.2.1]</span></span><br><span class=\"line\">    CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> cmdline;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, &amp;cmdline);</span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">    chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootconfig;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, &amp;bootconfig);</span><br><span class=\"line\">    <span class=\"keyword\">gid_t</span> groups[] = &#123;AID_READPROC&#125;;</span><br><span class=\"line\">    CHECKCALL(setgroups(arraysize(groups), groups));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"string\">&quot;/sys&quot;</span>, <span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"string\">&quot;/sys/fs/selinux&quot;</span>, <span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, S_IFCHR | <span class=\"number\">0600</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">if</span> <span class=\"title\">constexpr</span> <span class=\"params\">(WORLD_WRITABLE_KMSG)</span> </span>&#123;</span><br><span class=\"line\">        CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg_debug&quot;</span>, S_IFCHR | <span class=\"number\">0622</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/random&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">8</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/urandom&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">9</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// This is needed for log wrapper, which gets called before ueventd runs.</span></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/ptmx&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">5</span>, <span class=\"number\">2</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/null&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">3</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// These below mounts are done in first stage init so that first stage mount can mount</span></span><br><span class=\"line\">    <span class=\"comment\">// subdirectories of /mnt/&#123;vendor,product&#125;/.  Other mounts, not required by first stage mount,</span></span><br><span class=\"line\">    <span class=\"comment\">// should be done in rc files.</span></span><br><span class=\"line\">    <span class=\"comment\">// Mount staging areas for devices managed by vold</span></span><br><span class=\"line\">    <span class=\"comment\">// See storage config details at http://source.android.com/devices/storage/</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/mnt&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=1000&quot;</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/vendor is used to mount vendor-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the vendor partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/vendor&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/product is used to mount product-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the product partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/product&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /debug_ramdisk is used to preserve additional files from the debug ramdisk</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/debug_ramdisk&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /second_stage_resources is used to preserve files from first to second</span></span><br><span class=\"line\">    <span class=\"comment\">// stage init</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, kSecondStageRes, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>))</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> CHECKCALL</span></span><br><span class=\"line\"></span><br><span class=\"line\">    SetStdioToDevNull(argv);</span><br><span class=\"line\">    <span class=\"comment\">// Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually</span></span><br><span class=\"line\">    <span class=\"comment\">// talk to the outside world...</span></span><br><span class=\"line\">    InitKernelLogging(argv);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!errors.empty()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; [error_string, error_errno] : errors) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; error_string &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; strerror(error_errno);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Init encountered errors starting first stage, aborting&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    LOG(INFO) &lt;&lt; <span class=\"string\">&quot;init first stage started!&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init</span></span><br><span class=\"line\">    <span class=\"comment\">//  selinux_setup,  SetupSelinux  SELinux  [2.3]</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;selinux_setup&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">auto</span> fd = open(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, O_WRONLY | O_CLOEXEC);</span><br><span class=\"line\">    dup2(fd, STDOUT_FILENO);</span><br><span class=\"line\">    dup2(fd, STDERR_FILENO);</span><br><span class=\"line\">    close(fd);</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// execv() only returns if an error happened, in which case we</span></span><br><span class=\"line\">    <span class=\"comment\">// panic and never fall through this conditional.</span></span><br><span class=\"line\">    PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;execv(\\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class=\"string\">&quot;\\&quot;) failed&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>/system/bin/init</code> main  <code>&quot;selinux_setup&quot;</code> SetupSelinux  SELinux </p>\n<h3 id=\"2-2-1-\"><a href=\"#2-2-1-\" class=\"headerlink\" title=\"2.2.1 \"></a>2.2.1 </h3><p> Linux <code>chmod</code> </p>\n<p></p>\n<h4 id=\"2-2-1-1-\"><a href=\"#2-2-1-1-\" class=\"headerlink\" title=\"2.2.1.1 \"></a>2.2.1.1 </h4><p> 10 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-rwxrwxrwx</span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li><code>-</code></li>\n<li><code>d</code></li>\n<li><code>c</code></li>\n</ul>\n<p> 9  3 </p>\n<p>3  1  2  3 </p>\n<ul>\n<li> 1  <code>r</code> <code>-</code></li>\n<li> 2  <code>w</code> <code>-</code></li>\n<li> 3  <code>x</code> <code>-</code></li>\n</ul>\n<p><code>-rwxrw-r--</code> </p>\n<h4 id=\"2-2-1-2-\"><a href=\"#2-2-1-2-\" class=\"headerlink\" title=\"2.2.1.2 \"></a>2.2.1.2 </h4><p> 4  1  3 </p>\n<p> 3  3 </p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1004</td>\n<td align=\"center\">r</td>\n</tr>\n<tr>\n<td align=\"center\">0102</td>\n<td align=\"center\">w</td>\n</tr>\n<tr>\n<td align=\"center\">0011</td>\n<td align=\"center\">x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\">-</td>\n</tr>\n</tbody></table>\n<p> 0~7</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1117</td>\n<td align=\"center\">rwx</td>\n</tr>\n<tr>\n<td align=\"center\">1106</td>\n<td align=\"center\">rw-</td>\n</tr>\n<tr>\n<td align=\"center\">1015</td>\n<td align=\"center\">r-x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">-rwxrwxrwx</td>\n<td align=\"center\">0777</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">-rwxrw-r</td>\n<td align=\"center\">0764</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<h4 id=\"2-2-1-3-\"><a href=\"#2-2-1-3-\" class=\"headerlink\" title=\"2.2.1.3 \"></a>2.2.1.3 </h4><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br></pre></td></tr></table></figure>\n<p> <code>chmod</code>  <code>/proc/cmdline</code><code>/proc/bootconfig</code>  <code>0440</code> root  () </p>\n<h2 id=\"2-3--SELinux\"><a href=\"#2-3--SELinux\" class=\"headerlink\" title=\"2.3  SELinux\"></a>2.3  SELinux</h2><!-- TODO:  SELinux -->\n\n<p> <code>int SetupSelinux(char** argv)</code>  SELinux  <code>system/core/init/selinux.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// This function initializes SELinux then execs init to run in the init SELinux context.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SetupSelinux</span><span class=\"params\">(<span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Set up SELinux, loading the SELinux policy.</span></span><br><span class=\"line\">    <span class=\"comment\">//  SELinux</span></span><br><span class=\"line\">    SelinuxSetupKernelLogging();</span><br><span class=\"line\">    SelinuxInitialize();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init</span></span><br><span class=\"line\">    <span class=\"comment\">//  second_stage,  SecondStageMain  [2.4]</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;second_stage&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> SELinux <code>/system/bin/init</code> main  <code>&quot;second_stage&quot;</code> SecondStageMain </p>\n<h2 id=\"2-4-\"><a href=\"#2-4-\" class=\"headerlink\" title=\"2.4 \"></a>2.4 </h2><!-- TODO: property_load_boot_defaults -->\n\n<!-- TODO: , android  build.prop  -->\n\n<!-- TODO: SELinux  -->\n\n<!-- TODO: keyctl_get_keyring_ID(KEY_SPEC_SESSION_KEYRING, 1) -->\n\n<!-- TODO: InitializeSubcontext() -->\n\n<!-- TODO: ActionManager  ServiceList  -->\n\n<p> <code>int SecondStageMain(int argc, char** argv)</code>  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Set init and its forked children&#x27;s oom_adj.</span></span><br><span class=\"line\">    <span class=\"comment\">//  init  fork  oom_score_adj </span></span><br><span class=\"line\">    <span class=\"comment\">// , </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = WriteFile(<span class=\"string\">&quot;/proc/1/oom_score_adj&quot;</span>, <span class=\"string\">&quot;-1000&quot;</span>); !result) &#123;</span><br><span class=\"line\">        LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to write -1000 to /proc/1/oom_score_adj: &quot;</span> &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.2.1]</span></span><br><span class=\"line\">    property_init();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll [2.4.1.1]</span></span><br><span class=\"line\">    Epoll epoll;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Open(); !result) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll  init  [2.4.3.1.3]</span></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    InstallSignalFdHandler(&amp;epoll);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.2.2]</span></span><br><span class=\"line\">    StartPropertyService(&amp;epoll);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\">    ServiceList&amp; sm = ServiceList::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.4]</span></span><br><span class=\"line\">    LoadBootScripts(am, sm);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action [2.4.5.1]</span></span><br><span class=\"line\">    am.QueueBuiltinAction(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class=\"string\">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    am.QueueBuiltinAction(queue_property_triggers_action, <span class=\"string\">&quot;queue_property_triggers&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.5]</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = <span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (do_shutdown &amp;&amp; !shutting_down) &#123;</span><br><span class=\"line\">            do_shutdown = <span class=\"literal\">false</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (HandlePowerctlMessage(shutdown_command)) &#123;</span><br><span class=\"line\">                shutting_down = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            am.ExecuteOneCommand();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!shutting_down) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">auto</span> next_process_action_time = HandleProcessActions();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (next_process_action_time) &#123;</span><br><span class=\"line\">                    epoll_timeout = <span class=\"built_in\">std</span>::chrono::<span class=\"built_in\">ceil</span>&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;(</span><br><span class=\"line\">                            *next_process_action_time - boot_clock::now());</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (*epoll_timeout &lt; <span class=\"number\">0</span>ms) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (am.HasMoreCommands()) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> 5 </p>\n<ul>\n<li><p>epoll</p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p> 5 </p>\n<h3 id=\"2-4-1-epoll\"><a href=\"#2-4-1-epoll\" class=\"headerlink\" title=\"2.4.1 epoll\"></a>2.4.1 epoll</h3><p>epoll  Linux  I/O epoll </p>\n<h4 id=\"2-4-1-1-\"><a href=\"#2-4-1-1-\" class=\"headerlink\" title=\"2.4.1.1 \"></a>2.4.1.1 </h4><p> init epoll </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Epoll epoll;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Open(); !result) &#123;</span><br><span class=\"line\">    PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>epoll  Open  <code>system/core/init/epoll.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::Open</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_fd_ &gt;= <span class=\"number\">0</span>) <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    epoll_fd_.reset(epoll_create1(EPOLL_CLOEXEC));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_fd_ == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_create1 failed&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>epoll_create1</code><code>epoll_create1</code>  epoll </p>\n<h4 id=\"2-4-1-2--epoll-\"><a href=\"#2-4-1-2--epoll-\" class=\"headerlink\" title=\"2.4.1.2  epoll \"></a>2.4.1.2  epoll </h4><p> epoll  RegisterHandler  epoll</p>\n<p> <code>system/core/init/epoll.cpp</code> epoll_ctl</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler, <span class=\"keyword\">uint32_t</span> events)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &amp;ev) == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> epoll_ctl </p>\n<h5 id=\"2-4-1-2-1--epoll-ctl\"><a href=\"#2-4-1-2-1--epoll-ctl\" class=\"headerlink\" title=\"2.4.1.2.1  epoll_ctl\"></a>2.4.1.2.1  epoll_ctl</h5><p><strong>epoll_ctl</strong>  <code>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)</code> fd </p>\n<h6 id=\"2-4-1-2-1-1-\"><a href=\"#2-4-1-2-1-1-\" class=\"headerlink\" title=\"2.4.1.2.1.1 \"></a>2.4.1.2.1.1 </h6><p> epoll_ctl </p>\n<ul>\n<li><p><strong>epfd</strong>  epoll </p>\n</li>\n<li><p><strong>op</strong> </p>\n<ul>\n<li><p><strong>EPOLL_CTL_ADD</strong></p>\n<p> epoll </p>\n</li>\n<li><p><strong>EPOLL_CTL_MOD</strong></p>\n<p> epoll </p>\n</li>\n<li><p><strong>EPOLL_CTL_DEL</strong></p>\n<p> epoll </p>\n</li>\n</ul>\n</li>\n<li><p><strong>fd</strong> </p>\n</li>\n<li><p><strong>event</strong>  epoll_event  epoll_event </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">epoll_event</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">uint32_t</span>     events;      <span class=\"comment\">/* Epoll events */</span></span><br><span class=\"line\">   <span class=\"keyword\">epoll_data_t</span> data;        <span class=\"comment\">/* User data variable */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code> </p>\n<ul>\n<li><p>\u0015\u0015<strong>EPOLLIN</strong><br></p>\n</li>\n<li><p><strong>EPOLLOUT</strong><br></p>\n</li>\n<li><p><strong>EPOLLPRI</strong><br></p>\n</li>\n<li><p><strong>EPOLLERR</strong><br></p>\n</li>\n<li><p><strong>EPOLLHUP</strong><br></p>\n</li>\n<li><p><strong>EPOLLONESHOT</strong><br>epoll <br> epoll_ctl EPOLL_CTL_MOD </p>\n</li>\n</ul>\n<p> <code>data</code>  [2.4.1.3]<code>epoll_data_t</code> </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">epoll_data</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">void</span>        *ptr;</span><br><span class=\"line\">   <span class=\"keyword\">int</span>          fd;</span><br><span class=\"line\">   <span class=\"keyword\">uint32_t</span>     u32;</span><br><span class=\"line\">   <span class=\"keyword\">uint64_t</span>     u64;</span><br><span class=\"line\">&#125; <span class=\"keyword\">epoll_data_t</span>;</span><br></pre></td></tr></table></figure>\n\n\n</li>\n</ul>\n<h6 id=\"2-4-1-2-1-2-\"><a href=\"#2-4-1-2-1-2-\" class=\"headerlink\" title=\"2.4.1.2.1.2 \"></a>2.4.1.2.1.2 </h6><p> epoll_ctl </p>\n<ul>\n<li><p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-1-2-2--RegisterHandler-\"><a href=\"#2-4-1-2-2--RegisterHandler-\" class=\"headerlink\" title=\"2.4.1.2.2  RegisterHandler \"></a>2.4.1.2.2  RegisterHandler </h5><p> epoll_ctl  RegisterHandler  <code>system/core/init/epoll.h</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Epoll</span> &#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\">Result&lt;Success&gt; <span class=\"title\">RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                    <span class=\"keyword\">uint32_t</span> events = EPOLLIN)</span></span>;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code>  <code>EPOLLIN</code></p>\n<p> RegisterHandler </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler, <span class=\"keyword\">uint32_t</span> events)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// handler </span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> [it, inserted] = epoll_handlers_.emplace(fd, <span class=\"built_in\">std</span>::move(handler));</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_event ev;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"comment\">//  events  EPOLLIN, </span></span><br><span class=\"line\">    ev.events = events;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">// ,  [2.4.1.3.2]</span></span><br><span class=\"line\">    ev.data.ptr = <span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"keyword\">void</span>*&gt;(&amp;it-&gt;second);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll_ctl </span></span><br><span class=\"line\">    <span class=\"comment\">//  EPOLL_CTL_ADD, </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &amp;ev) == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        Result&lt;Success&gt; result = ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_ctl failed to add fd&quot;</span>;</span><br><span class=\"line\">        epoll_handlers_.erase(fd);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code>  <code>handler</code> <code>epoll_ctl</code>  epoll </p>\n<h4 id=\"2-4-1-3-\"><a href=\"#2-4-1-3-\" class=\"headerlink\" title=\"2.4.1.3 \"></a>2.4.1.3 </h4><p> epoll  epoll </p>\n<p> init </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Wait </p>\n<h5 id=\"2-4-1-3-1--epoll-wait\"><a href=\"#2-4-1-3-1--epoll-wait\" class=\"headerlink\" title=\"2.4.1.3.1  epoll_wait\"></a>2.4.1.3.1  epoll_wait</h5><p> Wait  epoll_wait Wait </p>\n<p><strong>epoll_wait</strong>  <code>int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout)</code> epoll </p>\n<p> epoll_wait </p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<h6 id=\"2-4-1-3-1-1-\"><a href=\"#2-4-1-3-1-1-\" class=\"headerlink\" title=\"2.4.1.3.1.1 \"></a>2.4.1.3.1.1 </h6><p> epoll_wait </p>\n<ul>\n<li><p><strong>epfd</strong>  epoll </p>\n</li>\n<li><p><strong>events</strong>  epoll_event  epoll_event  [2.4.1.2.1] </p>\n<p> events  epoll_event  data  epoll_ctl  data  epoll_ctl  event.data  epoll_wait </p>\n</li>\n<li><p><strong>maxevents</strong>  events  maxevents</p>\n</li>\n<li><p><strong>timeout</strong>  timeout = -1  timeout = 0 </p>\n</li>\n</ul>\n<h6 id=\"2-4-1-3-1-2-\"><a href=\"#2-4-1-3-1-2-\" class=\"headerlink\" title=\"2.4.1.3.1.2 \"></a>2.4.1.3.1.2 </h6><p> epoll_wait </p>\n<ul>\n<li><p> I/O </p>\n<p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-1-3-2--Wait-\"><a href=\"#2-4-1-3-2--Wait-\" class=\"headerlink\" title=\"2.4.1.3.2  Wait \"></a>2.4.1.3.2  Wait </h5><p> epoll_wait  Wait  <code>system/core/init/epoll.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::Wait</span><span class=\"params\">(<span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt; timeout)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  -1</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> timeout_ms = <span class=\"number\">-1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout &amp;&amp; timeout-&gt;count() &lt; INT_MAX) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  timeout  0 , </span></span><br><span class=\"line\">        timeout_ms = timeout-&gt;count();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_event ev;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll_wait </span></span><br><span class=\"line\">    <span class=\"comment\">//  1,  1 </span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd_, &amp;ev, <span class=\"number\">1</span>, timeout_ms));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nr == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  -1, </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_wait failed&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (nr == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  1, ,  1 </span></span><br><span class=\"line\">        <span class=\"comment\">// ev.data.ptr  epoll_ctl , </span></span><br><span class=\"line\">        <span class=\"built_in\">std</span>::invoke(*<span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt;*&gt;(ev.data.ptr));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>epoll_wait</code>  <code>epoll_wait</code>  epoll_ctl </p>\n<h3 id=\"2-4-2-\"><a href=\"#2-4-2-\" class=\"headerlink\" title=\"2.4.2 \"></a>2.4.2 </h3><p> Android  key-value </p>\n<p> adb <code>getprop</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ro.product.brand]: [Redmi]</span><br><span class=\"line\">[ro.product.manufacturer]: [Xiaomi]</span><br><span class=\"line\">[ro.product.marketname]: [Redmi K30S Ultra]</span><br><span class=\"line\">[ro.product.model]: [M2007J3SC]</span><br><span class=\"line\">[ro.product.name]: [apollo]</span><br><span class=\"line\"></span><br><span class=\"line\">[ro.product.cpu.abi]: [arm64-v8a]</span><br><span class=\"line\">[ro.product.cpu.abilist]: [arm64-v8a,armeabi-v7a,armeabi]</span><br><span class=\"line\">[ro.product.cpu.abilist32]: [armeabi-v7a,armeabi]</span><br><span class=\"line\">[ro.product.cpu.abilist64]: [arm64-v8a]</span><br><span class=\"line\"></span><br><span class=\"line\">[dalvik.vm.heapsize]: [512m]</span><br><span class=\"line\">[dalvik.vm.heapstartsize]: [8m]</span><br></pre></td></tr></table></figure>\n<p>CPU </p>\n<p> Java  <code>SystemProperties.get(String, String)</code>  ActivityManager </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">staticGetLargeMemoryClass</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  dalvik.vm.heapsize, </span></span><br><span class=\"line\">    String vmHeapSize = SystemProperties.get(<span class=\"string\">&quot;dalvik.vm.heapsize&quot;</span>, <span class=\"string\">&quot;16m&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> Integer.parseInt(vmHeapSize.substring(<span class=\"number\">0</span>, vmHeapSize.length() - <span class=\"number\">1</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>SystemProperties.set(String, String)</code>  ActivityManagerService </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">finishBooting</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Tell anyone interested that we are done booting!</span></span><br><span class=\"line\">        <span class=\"comment\">//  sys.boot_completed = 1, </span></span><br><span class=\"line\">        SystemProperties.set(<span class=\"string\">&quot;sys.boot_completed&quot;</span>, <span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"2-4-2-1-\"><a href=\"#2-4-2-1-\" class=\"headerlink\" title=\"2.4.2.1 \"></a>2.4.2.1 </h4><!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: CreateSerializedPropertyInfo() -->\n\n<!-- TODO: property_info_area.LoadDefaultPath() -->\n\n<p> property_init  <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">property_init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    mkdir(<span class=\"string\">&quot;/dev/__properties__&quot;</span>, S_IRWXU | S_IXGRP | S_IXOTH);</span><br><span class=\"line\">    CreateSerializedPropertyInfo();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (__system_property_area_init()) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Failed to initialize property area&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!property_info_area.LoadDefaultPath()) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Failed to load serialized property info file&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>__system_property_area_init</code> </p>\n<h4 id=\"2-4-2-2-\"><a href=\"#2-4-2-2-\" class=\"headerlink\" title=\"2.4.2.2 \"></a>2.4.2.2 </h4><!-- TODO: socket  -->\n\n<!-- TODO: listen(property_set_fd, 8) -->\n\n<!-- TODO:  init  -->\n\n<p> StartPropertyService  <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">StartPropertyService</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  socket ,  PROP_SERVICE_NAME = &quot;property_service&quot;</span></span><br><span class=\"line\">    property_set_fd = CreateSocket(PROP_SERVICE_NAME, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK,</span><br><span class=\"line\">                                   <span class=\"literal\">false</span>, <span class=\"number\">0666</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"literal\">nullptr</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (property_set_fd == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;start_property_service socket creation failed&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    listen(property_set_fd, <span class=\"number\">8</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  socket  epoll,  [2.4.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">// handle_property_set_fd  [2.4.2.3]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll-&gt;RegisterHandler(property_set_fd, handle_property_set_fd); !result) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> property_service  socket socket  epoll</p>\n<p> <code>handle_property_set_fd</code></p>\n<h4 id=\"2-4-2-3--handle-property-set-fd\"><a href=\"#2-4-2-3--handle-property-set-fd\" class=\"headerlink\" title=\"2.4.2.3  handle_property_set_fd\"></a>2.4.2.3  handle_property_set_fd</h4><!-- TODO: ucred cr; socklen_t cr_size = sizeof(cr); -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  init ,  -->\n\n<!-- TODO:  -->\n\n<p> <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">handle_property_set_fd</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 2000ms</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">constexpr</span> <span class=\"keyword\">uint32_t</span> kDefaultSocketTimeout = <span class=\"number\">2000</span>; <span class=\"comment\">/* ms */</span></span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">SocketConnection <span class=\"title\">socket</span><span class=\"params\">(s, cr)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  2000ms </span></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> timeout_ms = kDefaultSocketTimeout;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> cmd = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!socket.RecvUint32(&amp;cmd, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop: error while reading command from the socket&quot;</span>;</span><br><span class=\"line\">        socket.SendUint32(PROP_ERROR_READ_CMD);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (cmd) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//  PROP_MSG_SETPROP </span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> PROP_MSG_SETPROP: &#123;</span><br><span class=\"line\">        <span class=\"comment\">// PROP_NAME_MAX = 32</span></span><br><span class=\"line\">        <span class=\"keyword\">char</span> prop_name[PROP_NAME_MAX];</span><br><span class=\"line\">        <span class=\"keyword\">char</span> prop_value[PROP_VALUE_MAX];</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ,  prop_name  prop_value </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!socket.RecvChars(prop_name, PROP_NAME_MAX, &amp;timeout_ms) ||</span><br><span class=\"line\">            !socket.RecvChars(prop_value, PROP_VALUE_MAX, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">          PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop(PROP_MSG_SETPROP): error while reading name/value from the socket&quot;</span>;</span><br><span class=\"line\">          <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  0</span></span><br><span class=\"line\">        prop_name[PROP_NAME_MAX<span class=\"number\">-1</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\">        prop_value[PROP_VALUE_MAX<span class=\"number\">-1</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; cr = socket.cred();</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> error;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> result =</span><br><span class=\"line\">            HandlePropertySet(prop_name, prop_value, socket.source_context(), cr, &amp;error);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != PROP_SUCCESS) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to set property &#x27;&quot;</span> &lt;&lt; prop_name &lt;&lt; <span class=\"string\">&quot;&#x27; to &#x27;&quot;</span> &lt;&lt; prop_value</span><br><span class=\"line\">                       &lt;&lt; <span class=\"string\">&quot;&#x27; from uid:&quot;</span> &lt;&lt; cr.uid &lt;&lt; <span class=\"string\">&quot; gid:&quot;</span> &lt;&lt; cr.gid &lt;&lt; <span class=\"string\">&quot; pid:&quot;</span> &lt;&lt; cr.pid &lt;&lt; <span class=\"string\">&quot;: &quot;</span></span><br><span class=\"line\">                       &lt;&lt; error;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  PROP_MSG_SETPROP2 </span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> PROP_MSG_SETPROP2: &#123;</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> name;</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!socket.RecvString(&amp;name, &amp;timeout_ms) ||</span><br><span class=\"line\">            !socket.RecvString(&amp;value, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">          PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop(PROP_MSG_SETPROP2): error while reading name/value from the socket&quot;</span>;</span><br><span class=\"line\">          socket.SendUint32(PROP_ERROR_READ_DATA);</span><br><span class=\"line\">          <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; cr = socket.cred();</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> error;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> result = HandlePropertySet(name, value, socket.source_context(), cr, &amp;error);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != PROP_SUCCESS) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to set property &#x27;&quot;</span> &lt;&lt; name &lt;&lt; <span class=\"string\">&quot;&#x27; to &#x27;&quot;</span> &lt;&lt; value</span><br><span class=\"line\">                       &lt;&lt; <span class=\"string\">&quot;&#x27; from uid:&quot;</span> &lt;&lt; cr.uid &lt;&lt; <span class=\"string\">&quot; gid:&quot;</span> &lt;&lt; cr.gid &lt;&lt; <span class=\"string\">&quot; pid:&quot;</span> &lt;&lt; cr.pid &lt;&lt; <span class=\"string\">&quot;: &quot;</span></span><br><span class=\"line\">                       &lt;&lt; error;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        socket.SendUint32(result);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop: invalid command &quot;</span> &lt;&lt; cmd;</span><br><span class=\"line\">        socket.SendUint32(PROP_ERROR_INVALID_CMD);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> socket  <code>cmd</code> </p>\n<ul>\n<li> <code>PROP_MSG_SETPROP</code>  <code>PROP_NAME_MAX</code>  0 <code>PROP_NAME_MAX - 1</code> </li>\n<li> <code>PROP_MSG_SETPROP2</code>  <code>std::string</code> </li>\n</ul>\n<p> <code>PROP_MSG_SETPROP</code>  <code>PROP_MSG_SETPROP2</code>  <code>HandlePropertySet</code> </p>\n<h3 id=\"2-4-3-\"><a href=\"#2-4-3-\" class=\"headerlink\" title=\"2.4.3 \"></a>2.4.3 </h3><p><strong> (Signals)</strong>  IPC </p>\n<p><strong></strong></p>\n<h4 id=\"2-4-3-1-\"><a href=\"#2-4-3-1-\" class=\"headerlink\" title=\"2.4.3.1 \"></a>2.4.3.1 </h4><p> Linux (PID) waitwaitpid  waitid ** (Zombie process)**</p>\n<p> init init </p>\n<p> [2.4.4] init  fork servicemanager zygote  Android init </p>\n<p>init </p>\n<p> Android Linux </p>\n<h5 id=\"2-4-3-1-1-\"><a href=\"#2-4-3-1-1-\" class=\"headerlink\" title=\"2.4.3.1.1 \"></a>2.4.3.1.1 </h5><!-- :  -->\n\n<p></p>\n<ul>\n<li>\u0015\u0015<strong></strong></li>\n<li><strong></strong></li>\n<li><strong></strong></li>\n</ul>\n<p>init </p>\n<p></p>\n<h5 id=\"2-4-3-1-2--sigaction\"><a href=\"#2-4-3-1-2--sigaction\" class=\"headerlink\" title=\"2.4.3.1.2  sigaction\"></a>2.4.3.1.2  sigaction</h5><p> init  sigaction</p>\n<p><strong>sigaction</strong>  <code>int sigaction(int signum, const struct sigaction *restrict act, struct sigaction *restrict oldact)</code></p>\n<h6 id=\"2-4-3-1-2-1-\"><a href=\"#2-4-3-1-2-1-\" class=\"headerlink\" title=\"2.4.3.1.2.1 \"></a>2.4.3.1.2.1 </h6><p> sigaction </p>\n<ul>\n<li><p><strong>signum</strong> </p>\n<p> AndroidARM  <code>bionic/libc/kernel/uapi/asm-arm/asm/signal.h</code> </p>\n</li>\n<li><p><strong>act</strong>  sigaction  sigaction </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_handler)(<span class=\"keyword\">int</span>);</span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_sigaction)(<span class=\"keyword\">int</span>, <span class=\"keyword\">siginfo_t</span> *, <span class=\"keyword\">void</span> *);</span><br><span class=\"line\">   <span class=\"keyword\">sigset_t</span>   sa_mask;</span><br><span class=\"line\">   <span class=\"keyword\">int</span>        sa_flags;</span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_restorer)(<span class=\"keyword\">void</span>);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>sa_handler</code>  <code>sa_flags</code></p>\n<p> <code>sa_handler</code> </p>\n<ul>\n<li><p><strong>SIG_DFL</strong></p>\n<p></p>\n</li>\n<li><p><strong>SIG_IGN</strong></p>\n<p></p>\n</li>\n<li><p><strong></strong></p>\n<p> signum </p>\n</li>\n</ul>\n<p> <code>sa_flags</code> </p>\n<ul>\n<li><p><strong>SA_NOCLDSTOP</strong></p>\n<p> signum = SIGCHLD </p>\n</li>\n<li><p><strong>SA_RESETHAND</strong></p>\n<p></p>\n</li>\n<li><p><strong>SA_SIGINFO</strong></p>\n<p> sa_handler  sa_sigaction</p>\n</li>\n</ul>\n</li>\n<li><p><strong>oldact</strong>  sigaction  sigaction  act</p>\n</li>\n</ul>\n<h6 id=\"2-4-3-1-2-2-\"><a href=\"#2-4-3-1-2-2-\" class=\"headerlink\" title=\"2.4.3.1.2.2 \"></a>2.4.3.1.2.2 </h6><p> sigaction </p>\n<ul>\n<li><p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-3-1-3-init-\"><a href=\"#2-4-3-1-3-init-\" class=\"headerlink\" title=\"2.4.3.1.3 init \"></a>2.4.3.1.3 init </h5><p> sigaction  init </p>\n<h6 id=\"2-4-3-1-3-1--sigaction\"><a href=\"#2-4-3-1-3-1--sigaction\" class=\"headerlink\" title=\"2.4.3.1.3.1  sigaction\"></a>2.4.3.1.3.1  sigaction</h6><p>init  InstallSignalFdHandler  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">InstallSignalFdHandler</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  sigaction</span></span><br><span class=\"line\">    <span class=\"comment\">//  sa_handler ,  sa_handler = SIG_DFL </span></span><br><span class=\"line\">    <span class=\"comment\">//  sa_flags ,  sa_flags = SA_NOCLDSTOP  init , </span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> <span class=\"title\">act</span> &#123;</span> .sa_handler = SIG_DFL, .sa_flags = SA_NOCLDSTOP &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sigaction ,  [2.4.3.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">//  SIGCHLD,  SIGCHLD, , , , </span></span><br><span class=\"line\">    sigaction(SIGCHLD, &amp;act, <span class=\"literal\">nullptr</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> sigaction <code>SIGCHLD</code>  <code>SIGCHLD</code> </p>\n<p> <code>SIGCHLD</code>  <code>SA_NOCLDSTOP</code>  init </p>\n<p>init  signal  InstallSignalFdHandler </p>\n<h6 id=\"2-4-3-1-3-2--signal-\"><a href=\"#2-4-3-1-3-2--signal-\" class=\"headerlink\" title=\"2.4.3.1.3.2  signal \"></a>2.4.3.1.3.2  signal </h6><p></p>\n<p>Linux  signalfd</p>\n<p>init </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">InstallSignalFdHandler</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// mask , </span></span><br><span class=\"line\">    <span class=\"comment\">// ,  SIGCHLD</span></span><br><span class=\"line\">    <span class=\"keyword\">sigset_t</span> mask;</span><br><span class=\"line\">    sigemptyset(&amp;mask);</span><br><span class=\"line\">    sigaddset(&amp;mask, SIGCHLD);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal </span></span><br><span class=\"line\">    <span class=\"comment\">// ,  signalfd ,  -1, </span></span><br><span class=\"line\">    signal_fd = signalfd(<span class=\"number\">-1</span>, &amp;mask, SFD_CLOEXEC);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (signal_fd == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;failed to create signalfd&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal  epoll,  [2.4.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">// HandleSignalFd  [2.4.3.1.4]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll-&gt;RegisterHandler(signal_fd, HandleSignalFd); !result) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>SIGCHLD</code> signal  epoll</p>\n<p> signal  HandleSignalFd </p>\n<h5 id=\"2-4-3-1-4--HandleSignalFd\"><a href=\"#2-4-3-1-4--HandleSignalFd\" class=\"headerlink\" title=\"2.4.3.1.4  HandleSignalFd\"></a>2.4.3.1.4  HandleSignalFd</h5><p> <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">HandleSignalFd</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    signalfd_siginfo siginfo;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal  signalfd_siginfo, </span></span><br><span class=\"line\">    <span class=\"keyword\">ssize_t</span> bytes_read = TEMP_FAILURE_RETRY(read(signal_fd, &amp;siginfo, <span class=\"keyword\">sizeof</span>(siginfo)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bytes_read != <span class=\"keyword\">sizeof</span>(siginfo)) &#123;</span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Failed to read siginfo from signal_fd&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (siginfo.ssi_signo) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SIGCHLD:</span><br><span class=\"line\">            ReapAnyOutstandingChildren();</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SIGTERM:</span><br><span class=\"line\">            HandleSigtermSignal(siginfo);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;signal_fd: received unexpected signal &quot;</span> &lt;&lt; siginfo.ssi_signo;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>signal  signalfd_siginfo HandleSignalFd  signal  signalfd_siginfo</p>\n<p> <code>SIGCHLD</code> ReapAnyOutstandingChildren </p>\n<h6 id=\"2-4-3-1-4-1--ReapAnyOutstandingChildren-\"><a href=\"#2-4-3-1-4-1--ReapAnyOutstandingChildren-\" class=\"headerlink\" title=\"2.4.3.1.4.1  ReapAnyOutstandingChildren \"></a>2.4.3.1.4.1  ReapAnyOutstandingChildren </h6><p> <code>system/core/init/sigchld_handler.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">ReapAnyOutstandingChildren</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (ReapOneProcess()) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> ReapOneProcess  ReapOneProcess  false  ReapOneProcess </p>\n<h6 id=\"2-4-3-1-4-2--ReapOneProcess-\"><a href=\"#2-4-3-1-4-2--ReapOneProcess-\" class=\"headerlink\" title=\"2.4.3.1.4.2  ReapOneProcess \"></a>2.4.3.1.4.2  ReapOneProcess </h6><!-- TODO:  service->flags() -->\n\n<!-- TODO:  ServiceList::GetInstance().RemoveService(*service) -->\n\n<p> <code>system/core/init/sigchld_handler.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">bool</span> <span class=\"title\">ReapOneProcess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">siginfo_t</span> siginfo = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  waitid, </span></span><br><span class=\"line\">    <span class=\"comment\">//  init , ,  siginfo </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (TEMP_FAILURE_RETRY(waitid(P_ALL, <span class=\"number\">0</span>, &amp;siginfo, WEXITED | WNOHANG | WNOWAIT)) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  false</span></span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;waitid failed&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  pid</span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> pid = siginfo.si_pid;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  pid ,  false</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> name;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> wait_string;</span><br><span class=\"line\">    Service* service = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (PropertyChildReap(pid)) &#123;</span><br><span class=\"line\">        name = <span class=\"string\">&quot;Async property child&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (SubcontextChildReap(pid)) &#123;</span><br><span class=\"line\">        name = <span class=\"string\">&quot;Subcontext&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  pid  service</span></span><br><span class=\"line\">        service = ServiceList::GetInstance().FindService(pid, &amp;Service::pid);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (service) &#123;</span><br><span class=\"line\">            name = StringPrintf(<span class=\"string\">&quot;Service &#x27;%s&#x27; (pid %d)&quot;</span>, service-&gt;name().c_str(), pid);</span><br><span class=\"line\"></span><br><span class=\"line\">            ...</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            name = StringPrintf(<span class=\"string\">&quot;Untracked pid %d&quot;</span>, pid);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service,  true</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!service) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service  Reap </span></span><br><span class=\"line\">    service-&gt;Reap(siginfo);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ReapOneProcess  waitid pid  service service  service  Reap  Reap </p>\n<h6 id=\"2-4-3-1-4-3--Reap-\"><a href=\"#2-4-3-1-4-3--Reap-\" class=\"headerlink\" title=\"2.4.3.1.4.3  Reap \"></a>2.4.3.1.4.3  Reap </h6><p> <code>system/core/init/service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Service::Reap</span><span class=\"params\">(<span class=\"keyword\">const</span> <span class=\"keyword\">siginfo_t</span>&amp; siginfo)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(flags_ &amp; SVC_ONESHOT) || (flags_ &amp; SVC_RESTART)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_ONESHOT  SVC_RESTART, </span></span><br><span class=\"line\">        KillProcessGroup(SIGKILL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_TEMPORARY, </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (flags_ &amp; SVC_TEMPORARY) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    pid_ = <span class=\"number\">0</span>;</span><br><span class=\"line\">    flags_ &amp;= (~SVC_RUNNING);</span><br><span class=\"line\">    start_order_ = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((flags_ &amp; SVC_ONESHOT) &amp;&amp; !(flags_ &amp; SVC_RESTART) &amp;&amp; !(flags_ &amp; SVC_RESET)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_ONESHOT </span></span><br><span class=\"line\">        flags_ |= SVC_DISABLED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (flags_ &amp; (SVC_DISABLED | SVC_RESET))  &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_DISABLED  SVC_RESET,  stopped , </span></span><br><span class=\"line\">        NotifyStateChange(<span class=\"string\">&quot;stopped&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_CRITICAL </span></span><br><span class=\"line\">    <span class=\"comment\">//  4  4 , </span></span><br><span class=\"line\">    <span class=\"comment\">//  bootloader </span></span><br><span class=\"line\">    boot_clock::time_point now = boot_clock::now();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (((flags_ &amp; SVC_CRITICAL) || !pre_apexd_) &amp;&amp; !(flags_ &amp; SVC_RESTART)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">bool</span> boot_completed = android::base::GetBoolProperty(<span class=\"string\">&quot;sys.boot_completed&quot;</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (now &lt; time_crashed_ + <span class=\"number\">4</span>min || !boot_completed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (++crash_count_ &gt; <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (flags_ &amp; SVC_CRITICAL) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// Aborts into bootloader</span></span><br><span class=\"line\">                    LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;critical process &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class=\"string\">&quot;&#x27; exited 4 times &quot;</span></span><br><span class=\"line\">                               &lt;&lt; (boot_completed ? <span class=\"string\">&quot;in 4 minutes&quot;</span> : <span class=\"string\">&quot;before boot completed&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;updatable process &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class=\"string\">&quot;&#x27; exited 4 times &quot;</span></span><br><span class=\"line\">                               &lt;&lt; (boot_completed ? <span class=\"string\">&quot;in 4 minutes&quot;</span> : <span class=\"string\">&quot;before boot completed&quot;</span>);</span><br><span class=\"line\">                    <span class=\"comment\">// Notifies update_verifier and apexd</span></span><br><span class=\"line\">                    property_set(<span class=\"string\">&quot;ro.init.updatable_crashing&quot;</span>, <span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            time_crashed_ = now;</span><br><span class=\"line\">            crash_count_ = <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_RESTARTING, init  [2.4.5.2]</span></span><br><span class=\"line\">    flags_ &amp;= (~SVC_RESTART);</span><br><span class=\"line\">    flags_ |= SVC_RESTARTING;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service  onrestart </span></span><br><span class=\"line\">    onrestart_.ExecuteAllCommands();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  restarting </span></span><br><span class=\"line\">    NotifyStateChange(<span class=\"string\">&quot;restarting&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Reap  NotifyStateChange </p>\n<h6 id=\"2-4-3-1-4-4--NotifyStateChange-\"><a href=\"#2-4-3-1-4-4--NotifyStateChange-\" class=\"headerlink\" title=\"2.4.3.1.4.4  NotifyStateChange \"></a>2.4.3.1.4.4  NotifyStateChange </h6><p> <code>system/core/init/service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Service::NotifyStateChange</span><span class=\"params\">(<span class=\"keyword\">const</span> <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span>&amp; new_state)</span> <span class=\"keyword\">const</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((flags_ &amp; SVC_TEMPORARY) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_TEMPORARY, </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> prop_name = <span class=\"string\">&quot;init.svc.&quot;</span> + name_;</span><br><span class=\"line\">    property_set(prop_name, new_state);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> key-value  key  init.svc.[service_name]value  adb <code>getprop | grep init.svc.</code> service </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[init.svc.adbd]: [running]</span><br><span class=\"line\">[init.svc.alarm-hal-1-0]: [running]</span><br><span class=\"line\">[init.svc.android.thermal-hal]: [running]</span><br><span class=\"line\">[init.svc.apexd]: [stopped]</span><br><span class=\"line\">[init.svc.apexd-bootstrap]: [stopped]</span><br><span class=\"line\">[init.svc.apexd-snapshotde]: [stopped]</span><br><span class=\"line\">[init.svc.audioserver]: [running]</span><br><span class=\"line\">[init.svc.wifidisplayhalservice]: [running]</span><br><span class=\"line\">[init.svc.wpa_supplicant]: [running]</span><br><span class=\"line\">[init.svc.zygote]: [running]</span><br><span class=\"line\">[init.svc.zygote_secondary]: [running]</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"2-4-4-\"><a href=\"#2-4-4-\" class=\"headerlink\" title=\"2.4.4 \"></a>2.4.4 </h3><!-- TODO:  CreateParser -->\n\n<!-- TODO: .rc  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: /system/etc/init -->\n\n<!-- TODO: /odm/etc/init -->\n\n<!-- TODO: /vendor/etc/init -->\n\n<p> LoadBootScripts  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">LoadBootScripts</span><span class=\"params\">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> </span>&#123;</span><br><span class=\"line\">    Parser parser = CreateParser(action_manager, service_list);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootscript = GetProperty(<span class=\"string\">&quot;ro.boot.init_rc&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootscript.empty()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  init.rc  [2.4.4.1]</span></span><br><span class=\"line\">        parser.ParseConfig(<span class=\"string\">&quot;/init.rc&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /system/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/system/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/system/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /product/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /product_services/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /odm/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/odm/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/odm/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /vendor/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        parser.ParseConfig(bootscript);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li><code>init.rc</code>  .rc </li>\n<li><code>/system/etc/init/</code> SurfaceFlinger, MediaService, logcatd</li>\n<li><code>/vendor/etc/init/</code>  SoC  SoC </li>\n<li><code>/odm/etc/init/</code> </li>\n</ul>\n<p>init.rc </p>\n<h4 id=\"2-4-4-1-init-rc-\"><a href=\"#2-4-4-1-init-rc-\" class=\"headerlink\" title=\"2.4.4.1 init.rc \"></a>2.4.4.1 init.rc </h4><p> Android .rc  Android Init Language <a href=\"https://cs.android.com/android/platform/superproject/+/android-security-10.0.0_r56:system/core/init/README.md\"> Android Init Language </a>  AOSP  <code>system/core/init/README.md</code></p>\n<p></p>\n<h5 id=\"2-4-4-1-1-Android-Init-Language\"><a href=\"#2-4-4-1-1-Android-Init-Language\" class=\"headerlink\" title=\"2.4.4.1.1 Android Init Language\"></a>2.4.4.1.1 Android Init Language</h5><p>Android Init Language <code>Actions</code><code>Commands</code><code>Services</code><code>Options</code><code>Imports</code></p>\n<p></p>\n<ul>\n<li> token token </li>\n<li> token  c  <code>\\</code>  token</li>\n<li> <code>\\</code></li>\n<li> <code>#</code> </li>\n<li> <code>$&#123;property.name&#125;</code> <code>import /init.recovery.$&#123;ro.hardware&#125;.rc</code></li>\n<li> section <code>Actions</code>  <code>Services</code>  section <code>Commands</code>  <code>Options</code>  section section  <code>Commands</code>  <code>Options</code> </li>\n<li><code>Services</code>  <code>Services</code> </li>\n</ul>\n<p></p>\n<h6 id=\"2-4-4-1-1-1-Actions\"><a href=\"#2-4-4-1-1-1-Actions\" class=\"headerlink\" title=\"2.4.4.1.1.1 Actions\"></a>2.4.4.1.1.1 Actions</h6><p><code>Actions</code>   <code>Commands</code>  <code>Triggers</code>  <code>Actions</code> </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]*</span><br><span class=\"line\">   &lt;command&gt;</span><br><span class=\"line\">   &lt;command&gt;</span><br><span class=\"line\">   &lt;command&gt;</span><br></pre></td></tr></table></figure>\n<p> <code>Actions</code>   <code>Triggers</code> <code>Actions</code> </p>\n<p> <code>Actions</code>  <code>Actions</code>  <code>Commands</code></p>\n<p> Zygote </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unencrypted</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br></pre></td></tr></table></figure>\n<p></p>\n<p> <code>Actions</code>  <code>Triggers</code> <code>zygote-start</code>  <code>property:ro.crypto.state=unencrypted</code> <code>Command</code></p>\n<p> <code>zygote-start</code>  <code>property:ro.crypto.state=unencrypted</code> <code>Actions</code>  <code>Actions</code>  <code>Commands</code>  <code>Actions</code>  <code>Commands</code></p>\n<h6 id=\"2-4-4-1-1-2-Triggers\"><a href=\"#2-4-4-1-1-2-Triggers\" class=\"headerlink\" title=\"2.4.4.1.1.2 Triggers\"></a>2.4.4.1.1.2 Triggers</h6><p><code>Triggers</code>  <code>Actions</code>  <code>Commands</code></p>\n<p>Triggers </p>\n<ul>\n<li><p><strong>Event triggers</strong></p>\n<p> <code>trigger</code>   <code>QueueEventTrigger()</code> </p>\n</li>\n<li><p><strong>Property triggers</strong></p>\n<p> <code>property:&lt;key&gt;=&lt;value&gt;</code></p>\n</li>\n</ul>\n<p> <code>Actions</code> </p>\n<p></p>\n<p><code>on init &amp;&amp; property:a=b</code><code>on property:a=b &amp;&amp; property:c=d</code> </p>\n<p><code>on boot &amp;&amp; on init</code> </p>\n<h6 id=\"2-4-4-1-1-3-Commands\"><a href=\"#2-4-4-1-1-3-Commands\" class=\"headerlink\" title=\"2.4.4.1.1.3 Commands\"></a>2.4.4.1.1.3 Commands</h6><p> <code>Commands</code></p>\n<ul>\n<li><p><strong>trigger <event></strong></p>\n<p></p>\n</li>\n<li><p><strong>write <path> <content></strong></p>\n<p> path </p>\n</li>\n<li><p><strong>chown <owner> <group> <path></strong></p>\n<p></p>\n</li>\n<li><p><strong>mkdir <path> [mode] [owner] [group]</strong></p>\n<p> </p>\n<p> 755 root  root </p>\n<p></p>\n</li>\n<li><p><strong>start <service></strong></p>\n<p></p>\n</li>\n<li><p><strong>exec_start <service></strong></p>\n<p></p>\n</li>\n<li><p><strong>setprop <name> <value></strong></p>\n<p></p>\n</li>\n<li><p><strong>symlink <target> <path></strong></p>\n<p> path  target </p>\n</li>\n</ul>\n<h6 id=\"2-4-4-1-1-4-Services\"><a href=\"#2-4-4-1-1-4-Services\" class=\"headerlink\" title=\"2.4.4.1.1.4 Services\"></a>2.4.4.1.1.4 Services</h6><p><code>Services</code>  init  init  init  <code>Services</code>  fork </p>\n<p><code>Services</code> </p>\n<p><code>Services</code> </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service &lt;name&gt; &lt;pathname&gt; [ &lt;argument&gt; ]*</span><br><span class=\"line\">   &lt;option&gt;</span><br><span class=\"line\">   &lt;option&gt;</span><br><span class=\"line\">   ...</span><br></pre></td></tr></table></figure>\n<p> Zygote 64 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service zygote &#x2F;system&#x2F;bin&#x2F;app_process64 -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server</span><br><span class=\"line\">    class main</span><br><span class=\"line\">    priority -20</span><br><span class=\"line\">    user root</span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\">    socket zygote stream 660 root system</span><br><span class=\"line\">    socket usap_pool_primary stream 660 root system</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;android_power&#x2F;request_state wake</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;power&#x2F;state on</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart netd</span><br><span class=\"line\">    onrestart restart wificond</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br></pre></td></tr></table></figure>\n<p><code>zygote</code>  <code>Services</code> <code>/system/bin/app_process64</code> <code>-Xzygote /system/bin --zygote --start-system-server</code>  <code>Options</code></p>\n<h6 id=\"2-4-4-1-1-5-Options\"><a href=\"#2-4-4-1-1-5-Options\" class=\"headerlink\" title=\"2.4.4.1.1.5 Options\"></a>2.4.4.1.1.5 Options</h6><p><code>Options</code>  <code>Services</code>  init  <code>Services</code> </p>\n<p>  <code>Options</code></p>\n<ul>\n<li><p><strong>class <name> [ <name>* ]</strong></p>\n<p> <code>Services</code>  <code>Services</code>  () <code>Services</code>  ()  default</p>\n</li>\n<li><p><strong>class_start <serviceclass></strong></p>\n<p> <code>serviceclass</code>  <code>Services</code></p>\n</li>\n<li><p><strong>priority <priority></strong></p>\n<p> <code>Services</code>  -20 ~ 19 0</p>\n</li>\n<li><p><strong>user <username></strong></p>\n<p> <code>Services</code>  root</p>\n</li>\n<li><p><strong>group <groupname> [ <groupname>* ]</strong></p>\n<p> <code>Services</code>  root</p>\n</li>\n<li><p><strong>socket <name> <type> <perm> [ <user> [ <group> [ <seclabel> ] ] ]</strong></p>\n<p> unix  socket <code>/dev/socket/&lt;name&gt;</code> socket </p>\n</li>\n<li><p><strong>onrestart</strong></p>\n<p> <code>Services</code>  <code>Commands</code></p>\n</li>\n<li><p><strong>oneshot</strong></p>\n<p> <code>Services</code> </p>\n</li>\n<li><p><strong>writepid <file> [ <file>* ]</strong></p>\n<p> fork  pid </p>\n</li>\n</ul>\n<h5 id=\"2-4-4-1-2--init-rc-\"><a href=\"#2-4-4-1-2--init-rc-\" class=\"headerlink\" title=\"2.4.4.1.2  init.rc \"></a>2.4.4.1.2  init.rc </h5><p> init.rc  <code>system/core/rootdir/init.rc</code></p>\n<p>  <code>Actions</code>  <code>Services</code>  init.rc  <code>Actions</code> [2.4.4.1.1.2]  <code>QueueEventTrigger()</code>   <code>Actions</code>   <code>Triggers</code> <code>Actions</code> </p>\n<h6 id=\"2-4-4-1-2-1-\"><a href=\"#2-4-4-1-2-1-\" class=\"headerlink\" title=\"2.4.4.1.2.1 \"></a>2.4.4.1.2.1 </h6><p> init  <code>system/core/init/init.cpp</code>  SecondStageMain </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  early-init  ActionManager</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Trigger all the boot actions to get us started.</span></span><br><span class=\"line\">    <span class=\"comment\">//  init  ActionManager</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t mount filesystems or start core system services in charger mode.</span></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootmode = GetProperty(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  charger  ActionManager</span></span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  late-init  ActionManager</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ActionManager  [2.4.5.x]</p>\n<ul>\n<li>early-init -&gt; init -&gt; late-init</li>\n<li>early-init -&gt; init -&gt; charger</li>\n</ul>\n<p></p>\n<h6 id=\"2-4-4-1-2-2-init-rc-\"><a href=\"#2-4-4-1-2-2-init-rc-\" class=\"headerlink\" title=\"2.4.4.1.2.2 init.rc \"></a>2.4.4.1.2.2 init.rc </h6><!-- TODO: trigger boot -->\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on early-init</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    #  start  ueventd</span><br><span class=\"line\">    start ueventd</span><br><span class=\"line\"></span><br><span class=\"line\">    #  exec_start  apexd-bootstrap, ,  APEX </span><br><span class=\"line\">    exec_start apexd-bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\">on init</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    #  start </span><br><span class=\"line\">    #  servicemanager [2.4.4.1.2.3]</span><br><span class=\"line\">    start servicemanager</span><br><span class=\"line\">    start hwservicemanager</span><br><span class=\"line\">    start vndservicemanager</span><br><span class=\"line\"></span><br><span class=\"line\"># </span><br><span class=\"line\">#  trigger  [2.4.4.1.1.2]</span><br><span class=\"line\">on late-init</span><br><span class=\"line\">    trigger early-fs</span><br><span class=\"line\">    trigger fs</span><br><span class=\"line\">    trigger post-fs</span><br><span class=\"line\">    trigger late-fs</span><br><span class=\"line\">    trigger post-fs-data</span><br><span class=\"line\">    trigger load_persist_props_action</span><br><span class=\"line\"></span><br><span class=\"line\">    #  zygote-start,  zygote [2.4.4.1.2.4]</span><br><span class=\"line\">    trigger zygote-start</span><br><span class=\"line\"></span><br><span class=\"line\">    trigger firmware_mounts_complete</span><br><span class=\"line\">    trigger early-boot</span><br><span class=\"line\">    trigger boot</span><br></pre></td></tr></table></figure>\n<p> servicemanager  zygote </p>\n<h6 id=\"2-4-4-1-2-3--servicemanager\"><a href=\"#2-4-4-1-2-3--servicemanager\" class=\"headerlink\" title=\"2.4.4.1.2.3  servicemanager\"></a>2.4.4.1.2.3  servicemanager</h6><p>servicemanager  <code>frameworks/native/cmds/servicemanager/servicemanager.rc</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># servicemanager  Services </span><br><span class=\"line\"># &#x2F;system&#x2F;bin&#x2F;servicemanager </span><br><span class=\"line\">service servicemanager &#x2F;system&#x2F;bin&#x2F;servicemanager</span><br><span class=\"line\">    #  core  animation</span><br><span class=\"line\">    #  core  animation  () , servicemanager  ()</span><br><span class=\"line\">    class core animation</span><br><span class=\"line\"></span><br><span class=\"line\">    #  system</span><br><span class=\"line\">    user system</span><br><span class=\"line\"></span><br><span class=\"line\">    #  system  readproc</span><br><span class=\"line\">    group system readproc</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    # ,  bootloader</span><br><span class=\"line\">    critical</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    #  Commands</span><br><span class=\"line\">    onrestart restart healthd</span><br><span class=\"line\">    onrestart restart zygote</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart surfaceflinger</span><br><span class=\"line\">    onrestart restart inputflinger</span><br><span class=\"line\">    onrestart restart drm</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart keystore</span><br><span class=\"line\">    onrestart restart gatekeeperd</span><br><span class=\"line\">    onrestart restart thermalservice</span><br><span class=\"line\"></span><br><span class=\"line\">    #  fork  pid  &#x2F;dev&#x2F;cpuset&#x2F;system-background&#x2F;tasks</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;system-background&#x2F;tasks</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    # shutdown critical , </span><br><span class=\"line\">    shutdown critical</span><br></pre></td></tr></table></figure>\n<p> servicemanager  <code>frameworks/native/cmds/servicemanager/service_manager.c</code>  main </p>\n<h6 id=\"2-4-4-1-2-4--zygote\"><a href=\"#2-4-4-1-2-4--zygote\" class=\"headerlink\" title=\"2.4.4.1.2.4  zygote\"></a>2.4.4.1.2.4  zygote</h6><p> init.rc  <code>zygote-start</code>  3  <code>Actions</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unencrypted</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br><span class=\"line\"></span><br><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unsupported</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br><span class=\"line\"></span><br><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;encrypted &amp;&amp; property:ro.crypto.type&#x3D;file</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br></pre></td></tr></table></figure>\n<p>zygote </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &#x2F;init.$&#123;ro.zygote&#125;.rc</span><br></pre></td></tr></table></figure>\n<p> <code>ro.zygote</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote32.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote32_64.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote64.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote64_32.rc</span><br></pre></td></tr></table></figure>\n<p>zygote  <code>zygote-start</code>  <code>Actions</code>  zygote</p>\n<p> Zygote 64  <code>system/core/rootdir/init.zygote64.rc</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># zygote  Services </span><br><span class=\"line\"># &#x2F;system&#x2F;bin&#x2F;app_process64 </span><br><span class=\"line\"># -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server </span><br><span class=\"line\">service zygote &#x2F;system&#x2F;bin&#x2F;app_process64 -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server</span><br><span class=\"line\">    #  main</span><br><span class=\"line\">    #  main  () , zygote  ()</span><br><span class=\"line\">    class main</span><br><span class=\"line\"></span><br><span class=\"line\">    #  -20</span><br><span class=\"line\">    #  -20 ~ 19, , ,  zygote </span><br><span class=\"line\">    priority -20</span><br><span class=\"line\"></span><br><span class=\"line\">    #  root</span><br><span class=\"line\">    user root</span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\"></span><br><span class=\"line\">    #  socket</span><br><span class=\"line\">    socket zygote stream 660 root system</span><br><span class=\"line\">    socket usap_pool_primary stream 660 root system</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    #  Commands</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;android_power&#x2F;request_state wake</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;power&#x2F;state on</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart netd</span><br><span class=\"line\">    onrestart restart wificond</span><br><span class=\"line\"></span><br><span class=\"line\">    #  zygote  fork  pid  &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br></pre></td></tr></table></figure>\n<p> zygote  <code>frameworks/base/cmds/app_process/app_main.cpp</code>  main </p>\n<h3 id=\"2-4-5-\"><a href=\"#2-4-5-\" class=\"headerlink\" title=\"2.4.5 \"></a>2.4.5 </h3><p>init  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  epoll </span></span><br><span class=\"line\">        <span class=\"comment\">// , ,  epoll_timeout  -1</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = <span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// am ,  ActionManager </span></span><br><span class=\"line\">            <span class=\"comment\">//  ActionManager  [2.4.5.1]</span></span><br><span class=\"line\">            am.ExecuteOneCommand();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!shutting_down) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//  HandleProcessActions  [2.4.5.2]</span></span><br><span class=\"line\">                <span class=\"keyword\">auto</span> next_process_action_time = HandleProcessActions();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (next_process_action_time) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//  next_process_action_time </span></span><br><span class=\"line\">                    epoll_timeout = <span class=\"built_in\">std</span>::chrono::<span class=\"built_in\">ceil</span>&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;(</span><br><span class=\"line\">                            *next_process_action_time - boot_clock::now());</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//  0, </span></span><br><span class=\"line\">                    <span class=\"comment\">//  epoll  0,  Wait , </span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (*epoll_timeout &lt; <span class=\"number\">0</span>ms) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//  ActionManager ,  init , </span></span><br><span class=\"line\">            <span class=\"comment\">//  epoll  0,  Wait , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (am.HasMoreCommands()) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  Wait ,  [2.4.1.3]</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>init  3 </p>\n<ul>\n<li> ActionManager </li>\n<li></li>\n<li> epoll  init  init  <code>SIGCHLD</code> </li>\n</ul>\n<h4 id=\"2-4-5-1-ActionManager\"><a href=\"#2-4-5-1-ActionManager\" class=\"headerlink\" title=\"2.4.5.1 ActionManager\"></a>2.4.5.1 ActionManager</h4><!-- TODO:  Action? -->\n\n<!-- TODO: Action  Actions  -->\n\n<!-- TODO:  -->\n\n<p>ActionManager  Action  Action </p>\n<h5 id=\"2-4-5-1-1--Action\"><a href=\"#2-4-5-1-1--Action\" class=\"headerlink\" title=\"2.4.5.1.1  Action\"></a>2.4.5.1.1  Action</h5><!-- TODO:  Action  -->\n\n<p> init  Action Action </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// am ,  ActionManager </span></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  early-init [2.4.4.1.2.1]</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  coldboot </span></span><br><span class=\"line\">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class=\"string\">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetMmapRndBitsAction, <span class=\"string\">&quot;SetMmapRndBits&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetKptrRestrictAction, <span class=\"string\">&quot;SetKptrRestrict&quot;</span>);</span><br><span class=\"line\">    Keychords keychords;</span><br><span class=\"line\">    am.QueueBuiltinAction(</span><br><span class=\"line\">        [&amp;epoll, &amp;keychords](<span class=\"keyword\">const</span> BuiltinArguments&amp; args) -&gt; Result&lt;Success&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; svc : ServiceList::GetInstance()) &#123;</span><br><span class=\"line\">                keychords.Register(svc-&gt;keycodes());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            keychords.Start(&amp;epoll, HandleKeychord);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;KeychordInit&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(console_init_action, <span class=\"string\">&quot;console_init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  init [2.4.4.1.2.1]</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(StartBoringSslSelfTest, <span class=\"string\">&quot;StartBoringSslSelfTest&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  init  binder</span></span><br><span class=\"line\">    am.QueueBuiltinAction(InitBinder, <span class=\"string\">&quot;InitBinder&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootmode = GetProperty(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  Action:  charger [2.4.4.1.2.1]</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  Action:  late-init [2.4.4.1.2.1]</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action: </span></span><br><span class=\"line\">    am.QueueBuiltinAction(queue_property_triggers_action, <span class=\"string\">&quot;queue_property_triggers&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> ActionManager  Action</p>\n<h4 id=\"2-4-5-2-HandleProcessActions\"><a href=\"#2-4-5-2-HandleProcessActions\" class=\"headerlink\" title=\"2.4.5.2 HandleProcessActions\"></a>2.4.5.2 HandleProcessActions</h4><!-- ((s->flags() & SVC_RUNNING) && s->timeout_period()) -->\n\n<!--  service  -->\n\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"built_in\">std</span>::optional&lt;boot_clock::time_point&gt; <span class=\"title\">HandleProcessActions</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::optional&lt;boot_clock::time_point&gt; next_process_action_time;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  ServiceList</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; s : ServiceList::GetInstance()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((s-&gt;flags() &amp; SVC_RUNNING) &amp;&amp; s-&gt;timeout_period()) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">auto</span> timeout_time = s-&gt;time_started() + *s-&gt;timeout_period();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (boot_clock::now() &gt; timeout_time) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// , </span></span><br><span class=\"line\">                s-&gt;Timeout();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//  next_process_action_time</span></span><br><span class=\"line\">                <span class=\"comment\">// , next_process_action_time , </span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!next_process_action_time || timeout_time &lt; *next_process_action_time) &#123;</span><br><span class=\"line\">                    next_process_action_time = timeout_time;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  SVC_RESTARTING, ,  for </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(s-&gt;flags() &amp; SVC_RESTARTING)) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> restart_time = s-&gt;time_started() + s-&gt;restart_period();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (boot_clock::now() &gt; restart_time) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = s-&gt;Start(); !result) &#123;</span><br><span class=\"line\">                LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Could not restart process &#x27;&quot;</span> &lt;&lt; s-&gt;name() &lt;&lt; <span class=\"string\">&quot;&#x27;: &quot;</span> &lt;&lt; result.error();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//  next_process_action_time</span></span><br><span class=\"line\">            <span class=\"comment\">// , next_process_action_time , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!next_process_action_time || restart_time &lt; *next_process_action_time) &#123;</span><br><span class=\"line\">                next_process_action_time = restart_time;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> next_process_action_time;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p></p>\n<ol>\n<li> <code>SVC_RUNNING</code>  <code>Timeout</code> </li>\n<li> <code>SVC_RESTARTING</code>  </li>\n</ol>\n<p><code>next_process_action_time</code> </p>\n<p> [2.4.3.1.4.3]  init  <code>SVC_RESTARTING</code> init  <code>SVC_RESTARTING</code> </p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"http://gityuan.com/2016/02/01/android-booting/\">Android-</a></p>\n<p><a href=\"http://gityuan.com/2016/02/05/android-init/\">Android-Init</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man7/epoll.7.html\">epoll(7)</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Signal_(IPC)\">Signal</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man7/signal.7.html\">signal(7)</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man2/wait.2.html\">wait(2)</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man2/signalfd.2.html\">signalfd(2)</a></p>"},{"title":"Android ","_content":"\n\n\n<!-- more -->\n\n## ViewRootImpl::scheduleTraversals()\n\n```java\nvoid scheduleTraversals() {\n    //  mTraversalScheduled [3.1]\n    if (!mTraversalScheduled) {\n        //  mTraversalScheduled  true, \n        mTraversalScheduled = true;          \n\n        // , [3.2]\n        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();\n\n        // 2 mTraversalRunnable  Runnable, [3.3]\n        //  Choreographer [4]\n        mChoreographer.postCallback(\n                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);\n\n        if (!mUnbufferedInputDispatch) {\n            scheduleConsumeBatchedInput();\n        }\n        notifyRendererOfFramePending();\n        pokeDrawLockIfNeeded();\n    }\n}\n```\n\n\n\n### ViewRootImpl::mTraversalScheduled\n\n mTraversalScheduled \n\n```java\npublic boolean mTraversalScheduled;\n```\n\nmTraversalScheduled  boolean \n\n scheduleTraversals()  mTraversalScheduled \n\n mTraversalScheduled  Android UI  mTraversalScheduled \n\nmTraversalScheduled   scheduleTraversals()  mTraversalScheduled  true\n\n\n\n### MessageQueue::postSyncBarrier()\n\n```java\npublic int postSyncBarrier() {\n    return postSyncBarrier(SystemClock.uptimeMillis());\n}\n\nprivate int postSyncBarrier(long when) {\n    synchronized (this) {\n        final int token = mNextBarrierToken++;\n        final Message msg = Message.obtain();\n        msg.markInUse();\n        msg.when = when;\n        msg.arg1 = token;\n\n        Message prev = null;\n        Message p = mMessages;\n        if (when != 0) {\n            while (p != null && p.when <= when) {\n                prev = p;\n                p = p.next;\n            }\n        }\n        if (prev != null) {\n            msg.next = p;\n            prev.next = msg;\n        } else {\n            msg.next = p;\n            mMessages = msg;\n        }\n        return token;\n    }\n}\n```\n\n [Android ](https://hasssssssh.github.io/2021/03/25/android-sync-barrier/) UIViewRootImpl::mTraversalRunnable \n\n\n\n### ViewRootImpl::mTraversalRunnable\n\n mTraversalRunnable  TraversalRunnable TraversalRunnable \n\n```java\nfinal class TraversalRunnable implements Runnable {\n    @Override\n    public void run() {\n        doTraversal();\n    }\n}\n```\n\n Runnable  doTraversal() \n\n#### ViewRootImpl::doTraversal()\n\n```java\nvoid doTraversal() {\n    if (mTraversalScheduled) {\n        // TODO\n        //  doTraversal ,  mTraversalScheduled  false\n        //  scheduleTraversals() , \n        mTraversalScheduled = false;\n\n        // \n        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);\n\n        // ...\n\n        //  View \n        performTraversals();\n\n        // ...\n    }\n}\n```\n\nperformTraversals()  (// TODO) View \n\nView  doTraversal()  doTraversal()  Runnable Runnable \n\n\n\n## Choreographer\n\n\n\n### Choreographer::postCallback(int, Runnable, Object)\n\n```java\npublic void postCallback(int callbackType, Runnable action, Object token) {\n    postCallbackDelayed(callbackType, action, token, 0);\n}\n```\n\n\n\n\n\n","source":"_drafts/android-display-refresh.md","raw":"---\ntitle: Android \ntags:\n- Graphics\ncategories:\n- [Android, Framework, Graphics]\n---\n\n\n\n<!-- more -->\n\n## ViewRootImpl::scheduleTraversals()\n\n```java\nvoid scheduleTraversals() {\n    //  mTraversalScheduled [3.1]\n    if (!mTraversalScheduled) {\n        //  mTraversalScheduled  true, \n        mTraversalScheduled = true;          \n\n        // , [3.2]\n        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();\n\n        // 2 mTraversalRunnable  Runnable, [3.3]\n        //  Choreographer [4]\n        mChoreographer.postCallback(\n                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);\n\n        if (!mUnbufferedInputDispatch) {\n            scheduleConsumeBatchedInput();\n        }\n        notifyRendererOfFramePending();\n        pokeDrawLockIfNeeded();\n    }\n}\n```\n\n\n\n### ViewRootImpl::mTraversalScheduled\n\n mTraversalScheduled \n\n```java\npublic boolean mTraversalScheduled;\n```\n\nmTraversalScheduled  boolean \n\n scheduleTraversals()  mTraversalScheduled \n\n mTraversalScheduled  Android UI  mTraversalScheduled \n\nmTraversalScheduled   scheduleTraversals()  mTraversalScheduled  true\n\n\n\n### MessageQueue::postSyncBarrier()\n\n```java\npublic int postSyncBarrier() {\n    return postSyncBarrier(SystemClock.uptimeMillis());\n}\n\nprivate int postSyncBarrier(long when) {\n    synchronized (this) {\n        final int token = mNextBarrierToken++;\n        final Message msg = Message.obtain();\n        msg.markInUse();\n        msg.when = when;\n        msg.arg1 = token;\n\n        Message prev = null;\n        Message p = mMessages;\n        if (when != 0) {\n            while (p != null && p.when <= when) {\n                prev = p;\n                p = p.next;\n            }\n        }\n        if (prev != null) {\n            msg.next = p;\n            prev.next = msg;\n        } else {\n            msg.next = p;\n            mMessages = msg;\n        }\n        return token;\n    }\n}\n```\n\n [Android ](https://hasssssssh.github.io/2021/03/25/android-sync-barrier/) UIViewRootImpl::mTraversalRunnable \n\n\n\n### ViewRootImpl::mTraversalRunnable\n\n mTraversalRunnable  TraversalRunnable TraversalRunnable \n\n```java\nfinal class TraversalRunnable implements Runnable {\n    @Override\n    public void run() {\n        doTraversal();\n    }\n}\n```\n\n Runnable  doTraversal() \n\n#### ViewRootImpl::doTraversal()\n\n```java\nvoid doTraversal() {\n    if (mTraversalScheduled) {\n        // TODO\n        //  doTraversal ,  mTraversalScheduled  false\n        //  scheduleTraversals() , \n        mTraversalScheduled = false;\n\n        // \n        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);\n\n        // ...\n\n        //  View \n        performTraversals();\n\n        // ...\n    }\n}\n```\n\nperformTraversals()  (// TODO) View \n\nView  doTraversal()  doTraversal()  Runnable Runnable \n\n\n\n## Choreographer\n\n\n\n### Choreographer::postCallback(int, Runnable, Object)\n\n```java\npublic void postCallback(int callbackType, Runnable action, Object token) {\n    postCallbackDelayed(callbackType, action, token, 0);\n}\n```\n\n\n\n\n\n","slug":"android-display-refresh","published":0,"date":"2021-03-24T08:26:52.327Z","updated":"2021-11-09T12:27:37.503Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckvt7aq4g0000elpre24685ab","content":"<a id=\"more\"></a>\n\n<h2 id=\"ViewRootImpl-scheduleTraversals\"><a href=\"#ViewRootImpl-scheduleTraversals\" class=\"headerlink\" title=\"ViewRootImpl::scheduleTraversals()\"></a>ViewRootImpl::scheduleTraversals()</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">scheduleTraversals</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  mTraversalScheduled [3.1]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!mTraversalScheduled) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  mTraversalScheduled  true, </span></span><br><span class=\"line\">        mTraversalScheduled = <span class=\"keyword\">true</span>;          </span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// , [3.2]</span></span><br><span class=\"line\">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 2 mTraversalRunnable  Runnable, [3.3]</span></span><br><span class=\"line\">        <span class=\"comment\">//  Choreographer [4]</span></span><br><span class=\"line\">        mChoreographer.postCallback(</span><br><span class=\"line\">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mUnbufferedInputDispatch) &#123;</span><br><span class=\"line\">            scheduleConsumeBatchedInput();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        notifyRendererOfFramePending();</span><br><span class=\"line\">        pokeDrawLockIfNeeded();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"ViewRootImpl-mTraversalScheduled\"><a href=\"#ViewRootImpl-mTraversalScheduled\" class=\"headerlink\" title=\"ViewRootImpl::mTraversalScheduled\"></a>ViewRootImpl::mTraversalScheduled</h3><p> mTraversalScheduled </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> mTraversalScheduled;</span><br></pre></td></tr></table></figure>\n<p>mTraversalScheduled  boolean </p>\n<p> scheduleTraversals()  mTraversalScheduled </p>\n<p> mTraversalScheduled  Android UI  mTraversalScheduled </p>\n<p>mTraversalScheduled   scheduleTraversals()  mTraversalScheduled  true</p>\n<h3 id=\"MessageQueue-postSyncBarrier\"><a href=\"#MessageQueue-postSyncBarrier\" class=\"headerlink\" title=\"MessageQueue::postSyncBarrier()\"></a>MessageQueue::postSyncBarrier()</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">postSyncBarrier</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> postSyncBarrier(SystemClock.uptimeMillis());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">postSyncBarrier</span><span class=\"params\">(<span class=\"keyword\">long</span> when)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> token = mNextBarrierToken++;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Message msg = Message.obtain();</span><br><span class=\"line\">        msg.markInUse();</span><br><span class=\"line\">        msg.when = when;</span><br><span class=\"line\">        msg.arg1 = token;</span><br><span class=\"line\"></span><br><span class=\"line\">        Message prev = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Message p = mMessages;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (when != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (p != <span class=\"keyword\">null</span> &amp;&amp; p.when &lt;= when) &#123;</span><br><span class=\"line\">                prev = p;</span><br><span class=\"line\">                p = p.next;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (prev != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            msg.next = p;</span><br><span class=\"line\">            prev.next = msg;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            msg.next = p;</span><br><span class=\"line\">            mMessages = msg;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> token;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <a href=\"https://hasssssssh.github.io/2021/03/25/android-sync-barrier/\">Android </a> UIViewRootImpl::mTraversalRunnable </p>\n<h3 id=\"ViewRootImpl-mTraversalRunnable\"><a href=\"#ViewRootImpl-mTraversalRunnable\" class=\"headerlink\" title=\"ViewRootImpl::mTraversalRunnable\"></a>ViewRootImpl::mTraversalRunnable</h3><p> mTraversalRunnable  TraversalRunnable TraversalRunnable </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TraversalRunnable</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        doTraversal();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Runnable  doTraversal() </p>\n<h4 id=\"ViewRootImpl-doTraversal\"><a href=\"#ViewRootImpl-doTraversal\" class=\"headerlink\" title=\"ViewRootImpl::doTraversal()\"></a>ViewRootImpl::doTraversal()</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">doTraversal</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mTraversalScheduled) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// TODO</span></span><br><span class=\"line\">        <span class=\"comment\">//  doTraversal ,  mTraversalScheduled  false</span></span><br><span class=\"line\">        <span class=\"comment\">//  scheduleTraversals() , </span></span><br><span class=\"line\">        mTraversalScheduled = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  View </span></span><br><span class=\"line\">        performTraversals();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>performTraversals()  (// TODO) View </p>\n<p>View  doTraversal()  doTraversal()  Runnable Runnable </p>\n<h2 id=\"Choreographer\"><a href=\"#Choreographer\" class=\"headerlink\" title=\"Choreographer\"></a>Choreographer</h2><h3 id=\"Choreographer-postCallback-int-Runnable-Object\"><a href=\"#Choreographer-postCallback-int-Runnable-Object\" class=\"headerlink\" title=\"Choreographer::postCallback(int, Runnable, Object)\"></a>Choreographer::postCallback(int, Runnable, Object)</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">postCallback</span><span class=\"params\">(<span class=\"keyword\">int</span> callbackType, Runnable action, Object token)</span> </span>&#123;</span><br><span class=\"line\">    postCallbackDelayed(callbackType, action, token, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"ViewRootImpl-scheduleTraversals\"><a href=\"#ViewRootImpl-scheduleTraversals\" class=\"headerlink\" title=\"ViewRootImpl::scheduleTraversals()\"></a>ViewRootImpl::scheduleTraversals()</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">scheduleTraversals</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  mTraversalScheduled [3.1]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!mTraversalScheduled) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  mTraversalScheduled  true, </span></span><br><span class=\"line\">        mTraversalScheduled = <span class=\"keyword\">true</span>;          </span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// , [3.2]</span></span><br><span class=\"line\">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 2 mTraversalRunnable  Runnable, [3.3]</span></span><br><span class=\"line\">        <span class=\"comment\">//  Choreographer [4]</span></span><br><span class=\"line\">        mChoreographer.postCallback(</span><br><span class=\"line\">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class=\"keyword\">null</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!mUnbufferedInputDispatch) &#123;</span><br><span class=\"line\">            scheduleConsumeBatchedInput();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        notifyRendererOfFramePending();</span><br><span class=\"line\">        pokeDrawLockIfNeeded();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"ViewRootImpl-mTraversalScheduled\"><a href=\"#ViewRootImpl-mTraversalScheduled\" class=\"headerlink\" title=\"ViewRootImpl::mTraversalScheduled\"></a>ViewRootImpl::mTraversalScheduled</h3><p> mTraversalScheduled </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> mTraversalScheduled;</span><br></pre></td></tr></table></figure>\n<p>mTraversalScheduled  boolean </p>\n<p> scheduleTraversals()  mTraversalScheduled </p>\n<p> mTraversalScheduled  Android UI  mTraversalScheduled </p>\n<p>mTraversalScheduled   scheduleTraversals()  mTraversalScheduled  true</p>\n<h3 id=\"MessageQueue-postSyncBarrier\"><a href=\"#MessageQueue-postSyncBarrier\" class=\"headerlink\" title=\"MessageQueue::postSyncBarrier()\"></a>MessageQueue::postSyncBarrier()</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">postSyncBarrier</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> postSyncBarrier(SystemClock.uptimeMillis());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">postSyncBarrier</span><span class=\"params\">(<span class=\"keyword\">long</span> when)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> token = mNextBarrierToken++;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Message msg = Message.obtain();</span><br><span class=\"line\">        msg.markInUse();</span><br><span class=\"line\">        msg.when = when;</span><br><span class=\"line\">        msg.arg1 = token;</span><br><span class=\"line\"></span><br><span class=\"line\">        Message prev = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Message p = mMessages;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (when != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (p != <span class=\"keyword\">null</span> &amp;&amp; p.when &lt;= when) &#123;</span><br><span class=\"line\">                prev = p;</span><br><span class=\"line\">                p = p.next;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (prev != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            msg.next = p;</span><br><span class=\"line\">            prev.next = msg;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            msg.next = p;</span><br><span class=\"line\">            mMessages = msg;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> token;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <a href=\"https://hasssssssh.github.io/2021/03/25/android-sync-barrier/\">Android </a> UIViewRootImpl::mTraversalRunnable </p>\n<h3 id=\"ViewRootImpl-mTraversalRunnable\"><a href=\"#ViewRootImpl-mTraversalRunnable\" class=\"headerlink\" title=\"ViewRootImpl::mTraversalRunnable\"></a>ViewRootImpl::mTraversalRunnable</h3><p> mTraversalRunnable  TraversalRunnable TraversalRunnable </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TraversalRunnable</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        doTraversal();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Runnable  doTraversal() </p>\n<h4 id=\"ViewRootImpl-doTraversal\"><a href=\"#ViewRootImpl-doTraversal\" class=\"headerlink\" title=\"ViewRootImpl::doTraversal()\"></a>ViewRootImpl::doTraversal()</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">doTraversal</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mTraversalScheduled) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// TODO</span></span><br><span class=\"line\">        <span class=\"comment\">//  doTraversal ,  mTraversalScheduled  false</span></span><br><span class=\"line\">        <span class=\"comment\">//  scheduleTraversals() , </span></span><br><span class=\"line\">        mTraversalScheduled = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  View </span></span><br><span class=\"line\">        performTraversals();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ...</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>performTraversals()  (// TODO) View </p>\n<p>View  doTraversal()  doTraversal()  Runnable Runnable </p>\n<h2 id=\"Choreographer\"><a href=\"#Choreographer\" class=\"headerlink\" title=\"Choreographer\"></a>Choreographer</h2><h3 id=\"Choreographer-postCallback-int-Runnable-Object\"><a href=\"#Choreographer-postCallback-int-Runnable-Object\" class=\"headerlink\" title=\"Choreographer::postCallback(int, Runnable, Object)\"></a>Choreographer::postCallback(int, Runnable, Object)</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">postCallback</span><span class=\"params\">(<span class=\"keyword\">int</span> callbackType, Runnable action, Object token)</span> </span>&#123;</span><br><span class=\"line\">    postCallbackDelayed(callbackType, action, token, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"Android ","mathjax":true,"_content":"\n\n\n\n\n<!-- more -->\n\n\n\n# 1. \n\n\n\n- \n- CPUGPU\n- \n\nCPU  GPU GPU \n\n\n\n# 2. \n\n (Frame rate) fps(frames per second) \n\n\n\n# 3. \n\n (Refresh rate) HZ \n\n 60HZ  60  $\\frac{1}{60}$  \n\n G-sync  freesync \n\n\n\n# 4. \n\n\n\n\n\n# 5. \n\n (Screen tearing)\n\n<img src=\"https://upload.wikimedia.org/wikipedia/commons/0/03/Tearing_%28simulated%29.jpg\" alt=\"A typical video tearing artifact (simulated image)\" style=\"zoom:30%;\" />\n\n## 5.1 \n\n\n\n 100FPS 60HZ\n\n1.  $\\frac{1}{100}$(0.01)  A\n2.  $\\frac{1}{60}$(0.016)  A $\\frac{2}{60}$(0.032) \n3.  $\\frac{2}{100}$(0.02)  B A  B  A  $\\frac{2}{60}$(0.032)  A  B  B  A  B \n\n\n\n# 6. \n\n [5.1]  \"\"\n\n\n\n## 6.1 \n\n (Vertical synchronization)\n\n\n\n### 6.1.1 ****\n\n (Vertical Blank Interval)\n\n\n\n### 6.1.2 \n\n#### 6.1.2.1 \n\n\n\n 60HZ 60FPS\n\n#### 6.1.2.2 \n\n (Input lag)\n\n 60HZ 16ms \n\n## 6.2 \n\n (variable refresh rate)\n\n### 6.2.1 \n\n[Nvidia G-Sync](https://en.wikipedia.org/wiki/Nvidia_G-Sync)\n\n[FreeSync](https://en.wikipedia.org/wiki/FreeSync)\n\n\n\n# 7. \n\n\n\n## 7.1 \n\n \"\" \"\"\n\n \"\"  \"\"  \"\" \n\n// TODO: \n\n\n\n\n\n## \n\n\n\n# \n\n[](https://www.cnblogs.com/wkfvawl/p/11559508.html)\n\n[Frame rate](https://en.wikipedia.org/wiki/Frame_rate)\n\n[Refresh rate](https://en.wikipedia.org/wiki/Refresh_rate)\n\n[Screen tearing](https://en.wikipedia.org/wiki/Screen_tearing)\n\n[Vertical blanking interval](https://en.wikipedia.org/wiki/Vertical_blanking_interval)\n\n[Input lag](https://en.wikipedia.org/wiki/Input_lag)\n\n[Multiple buffering](https://en.wikipedia.org/wiki/Multiple_buffering#Double_buffering_in_computer_graphics)\n\n","source":"_drafts/android-graphics-basis.md","raw":"---\ntitle: Android \ntags:\n- Basis\n- Graphics\ncategories:\n- [Graphics]\nmathjax: true\n---\n\n\n\n\n\n<!-- more -->\n\n\n\n# 1. \n\n\n\n- \n- CPUGPU\n- \n\nCPU  GPU GPU \n\n\n\n# 2. \n\n (Frame rate) fps(frames per second) \n\n\n\n# 3. \n\n (Refresh rate) HZ \n\n 60HZ  60  $\\frac{1}{60}$  \n\n G-sync  freesync \n\n\n\n# 4. \n\n\n\n\n\n# 5. \n\n (Screen tearing)\n\n<img src=\"https://upload.wikimedia.org/wikipedia/commons/0/03/Tearing_%28simulated%29.jpg\" alt=\"A typical video tearing artifact (simulated image)\" style=\"zoom:30%;\" />\n\n## 5.1 \n\n\n\n 100FPS 60HZ\n\n1.  $\\frac{1}{100}$(0.01)  A\n2.  $\\frac{1}{60}$(0.016)  A $\\frac{2}{60}$(0.032) \n3.  $\\frac{2}{100}$(0.02)  B A  B  A  $\\frac{2}{60}$(0.032)  A  B  B  A  B \n\n\n\n# 6. \n\n [5.1]  \"\"\n\n\n\n## 6.1 \n\n (Vertical synchronization)\n\n\n\n### 6.1.1 ****\n\n (Vertical Blank Interval)\n\n\n\n### 6.1.2 \n\n#### 6.1.2.1 \n\n\n\n 60HZ 60FPS\n\n#### 6.1.2.2 \n\n (Input lag)\n\n 60HZ 16ms \n\n## 6.2 \n\n (variable refresh rate)\n\n### 6.2.1 \n\n[Nvidia G-Sync](https://en.wikipedia.org/wiki/Nvidia_G-Sync)\n\n[FreeSync](https://en.wikipedia.org/wiki/FreeSync)\n\n\n\n# 7. \n\n\n\n## 7.1 \n\n \"\" \"\"\n\n \"\"  \"\"  \"\" \n\n// TODO: \n\n\n\n\n\n## \n\n\n\n# \n\n[](https://www.cnblogs.com/wkfvawl/p/11559508.html)\n\n[Frame rate](https://en.wikipedia.org/wiki/Frame_rate)\n\n[Refresh rate](https://en.wikipedia.org/wiki/Refresh_rate)\n\n[Screen tearing](https://en.wikipedia.org/wiki/Screen_tearing)\n\n[Vertical blanking interval](https://en.wikipedia.org/wiki/Vertical_blanking_interval)\n\n[Input lag](https://en.wikipedia.org/wiki/Input_lag)\n\n[Multiple buffering](https://en.wikipedia.org/wiki/Multiple_buffering#Double_buffering_in_computer_graphics)\n\n","slug":"android-graphics-basis","published":0,"date":"2021-05-18T12:58:52.142Z","updated":"2021-11-09T12:25:44.683Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckvt7aq4k0001elprgcal1w0y","content":"<p></p>\n<a id=\"more\"></a>\n\n\n\n<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><p></p>\n<ul>\n<li></li>\n<li>CPUGPU</li>\n<li></li>\n</ul>\n<p>CPU  GPU GPU </p>\n<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><p> (Frame rate) fps(frames per second) </p>\n<h1 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3. \"></a>3. </h1><p> (Refresh rate) HZ </p>\n<p> 60HZ  60  $\\frac{1}{60}$  </p>\n<p> G-sync  freesync </p>\n<h1 id=\"4-\"><a href=\"#4-\" class=\"headerlink\" title=\"4. \"></a>4. </h1><p></p>\n<h1 id=\"5-\"><a href=\"#5-\" class=\"headerlink\" title=\"5. \"></a>5. </h1><p> (Screen tearing)</p>\n<img src=\"https://upload.wikimedia.org/wikipedia/commons/0/03/Tearing_%28simulated%29.jpg\" alt=\"A typical video tearing artifact (simulated image)\" style=\"zoom:30%;\" />\n\n<h2 id=\"5-1-\"><a href=\"#5-1-\" class=\"headerlink\" title=\"5.1 \"></a>5.1 </h2><p></p>\n<p> 100FPS 60HZ</p>\n<ol>\n<li> $\\frac{1}{100}$(0.01)  A</li>\n<li> $\\frac{1}{60}$(0.016)  A $\\frac{2}{60}$(0.032) </li>\n<li> $\\frac{2}{100}$(0.02)  B A  B  A  $\\frac{2}{60}$(0.032)  A  B  B  A  B </li>\n</ol>\n<h1 id=\"6-\"><a href=\"#6-\" class=\"headerlink\" title=\"6. \"></a>6. </h1><p> [5.1]  </p>\n<p></p>\n<h2 id=\"6-1-\"><a href=\"#6-1-\" class=\"headerlink\" title=\"6.1 \"></a>6.1 </h2><p> (Vertical synchronization)</p>\n<p></p>\n<h3 id=\"6-1-1-\"><a href=\"#6-1-1-\" class=\"headerlink\" title=\"6.1.1 \"></a>6.1.1 <strong></strong></h3><p> (Vertical Blank Interval)</p>\n<p></p>\n<h3 id=\"6-1-2-\"><a href=\"#6-1-2-\" class=\"headerlink\" title=\"6.1.2 \"></a>6.1.2 </h3><h4 id=\"6-1-2-1-\"><a href=\"#6-1-2-1-\" class=\"headerlink\" title=\"6.1.2.1 \"></a>6.1.2.1 </h4><p></p>\n<p> 60HZ 60FPS</p>\n<h4 id=\"6-1-2-2-\"><a href=\"#6-1-2-2-\" class=\"headerlink\" title=\"6.1.2.2 \"></a>6.1.2.2 </h4><p> (Input lag)</p>\n<p> 60HZ 16ms </p>\n<h2 id=\"6-2-\"><a href=\"#6-2-\" class=\"headerlink\" title=\"6.2 \"></a>6.2 </h2><p> (variable refresh rate)</p>\n<h3 id=\"6-2-1-\"><a href=\"#6-2-1-\" class=\"headerlink\" title=\"6.2.1 \"></a>6.2.1 </h3><p><a href=\"https://en.wikipedia.org/wiki/Nvidia_G-Sync\">Nvidia G-Sync</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/FreeSync\">FreeSync</a></p>\n<h1 id=\"7-\"><a href=\"#7-\" class=\"headerlink\" title=\"7. \"></a>7. </h1><p></p>\n<h2 id=\"7-1-\"><a href=\"#7-1-\" class=\"headerlink\" title=\"7.1 \"></a>7.1 </h2><p>  </p>\n<p>      </p>\n<p>// TODO: </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"https://www.cnblogs.com/wkfvawl/p/11559508.html\"></a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Frame_rate\">Frame rate</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Refresh_rate\">Refresh rate</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Screen_tearing\">Screen tearing</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Vertical_blanking_interval\">Vertical blanking interval</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Input_lag\">Input lag</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Multiple_buffering#Double_buffering_in_computer_graphics\">Multiple buffering</a></p>\n","site":{"data":{}},"excerpt":"<p></p>","more":"<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><p></p>\n<ul>\n<li></li>\n<li>CPUGPU</li>\n<li></li>\n</ul>\n<p>CPU  GPU GPU </p>\n<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><p> (Frame rate) fps(frames per second) </p>\n<h1 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3. \"></a>3. </h1><p> (Refresh rate) HZ </p>\n<p> 60HZ  60  $\\frac{1}{60}$  </p>\n<p> G-sync  freesync </p>\n<h1 id=\"4-\"><a href=\"#4-\" class=\"headerlink\" title=\"4. \"></a>4. </h1><p></p>\n<h1 id=\"5-\"><a href=\"#5-\" class=\"headerlink\" title=\"5. \"></a>5. </h1><p> (Screen tearing)</p>\n<img src=\"https://upload.wikimedia.org/wikipedia/commons/0/03/Tearing_%28simulated%29.jpg\" alt=\"A typical video tearing artifact (simulated image)\" style=\"zoom:30%;\" />\n\n<h2 id=\"5-1-\"><a href=\"#5-1-\" class=\"headerlink\" title=\"5.1 \"></a>5.1 </h2><p></p>\n<p> 100FPS 60HZ</p>\n<ol>\n<li> $\\frac{1}{100}$(0.01)  A</li>\n<li> $\\frac{1}{60}$(0.016)  A $\\frac{2}{60}$(0.032) </li>\n<li> $\\frac{2}{100}$(0.02)  B A  B  A  $\\frac{2}{60}$(0.032)  A  B  B  A  B </li>\n</ol>\n<h1 id=\"6-\"><a href=\"#6-\" class=\"headerlink\" title=\"6. \"></a>6. </h1><p> [5.1]  </p>\n<p></p>\n<h2 id=\"6-1-\"><a href=\"#6-1-\" class=\"headerlink\" title=\"6.1 \"></a>6.1 </h2><p> (Vertical synchronization)</p>\n<p></p>\n<h3 id=\"6-1-1-\"><a href=\"#6-1-1-\" class=\"headerlink\" title=\"6.1.1 \"></a>6.1.1 <strong></strong></h3><p> (Vertical Blank Interval)</p>\n<p></p>\n<h3 id=\"6-1-2-\"><a href=\"#6-1-2-\" class=\"headerlink\" title=\"6.1.2 \"></a>6.1.2 </h3><h4 id=\"6-1-2-1-\"><a href=\"#6-1-2-1-\" class=\"headerlink\" title=\"6.1.2.1 \"></a>6.1.2.1 </h4><p></p>\n<p> 60HZ 60FPS</p>\n<h4 id=\"6-1-2-2-\"><a href=\"#6-1-2-2-\" class=\"headerlink\" title=\"6.1.2.2 \"></a>6.1.2.2 </h4><p> (Input lag)</p>\n<p> 60HZ 16ms </p>\n<h2 id=\"6-2-\"><a href=\"#6-2-\" class=\"headerlink\" title=\"6.2 \"></a>6.2 </h2><p> (variable refresh rate)</p>\n<h3 id=\"6-2-1-\"><a href=\"#6-2-1-\" class=\"headerlink\" title=\"6.2.1 \"></a>6.2.1 </h3><p><a href=\"https://en.wikipedia.org/wiki/Nvidia_G-Sync\">Nvidia G-Sync</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/FreeSync\">FreeSync</a></p>\n<h1 id=\"7-\"><a href=\"#7-\" class=\"headerlink\" title=\"7. \"></a>7. </h1><p></p>\n<h2 id=\"7-1-\"><a href=\"#7-1-\" class=\"headerlink\" title=\"7.1 \"></a>7.1 </h2><p>  </p>\n<p>      </p>\n<p>// TODO: </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"https://www.cnblogs.com/wkfvawl/p/11559508.html\"></a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Frame_rate\">Frame rate</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Refresh_rate\">Refresh rate</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Screen_tearing\">Screen tearing</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Vertical_blanking_interval\">Vertical blanking interval</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Input_lag\">Input lag</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Multiple_buffering#Double_buffering_in_computer_graphics\">Multiple buffering</a></p>"},{"title":"","mathjax":true,"_content":"\n\n\n\n\n<!-- more -->\n\n\n\n# 1. \n\n\n\n- \n- CPUGPU\n- \n\nCPU  GPU GPU \n\n\n\n# 2. \n\n (Frame rate) fps(frames per second) \n\n\n\n# 3. \n\n (Refresh rate) HZ \n\n 60HZ  60  $\\frac{1}{60}$  \n\n G-sync  freesync \n\n\n\n# 4. \n\n\n\n\n\n# 5. \n\n (Screen tearing)\n\n<img src=\"https://upload.wikimedia.org/wikipedia/commons/0/03/Tearing_%28simulated%29.jpg\" alt=\"A typical video tearing artifact (simulated image)\" style=\"zoom:30%;\" />\n\n## 5.1 \n\n\n\n 100FPS 60HZ\n\n1.  $\\frac{1}{100}$(0.01)  A\n2.  $\\frac{1}{60}$(0.016)  A $\\frac{2}{60}$(0.032) \n3.  $\\frac{2}{100}$(0.02)  B A  B  A  $\\frac{2}{60}$(0.032)  A  B  B  A  B \n\n\n\n# 6. \n\n [5.1]  \"\"\n\n\n\n## 6.1 \n\n (Vertical synchronization)\n\n\n\n### 6.1.1 ****\n\n (Vertical Blank Interval)\n\n\n\n### 6.1.2 \n\n#### 6.1.2.1 \n\n\n\n 60HZ 60FPS\n\n#### 6.1.2.2 \n\n (Input lag)\n\n 60HZ 16ms \n\n## 6.2 \n\n (variable refresh rate)\n\n### 6.2.1 \n\n[Nvidia G-Sync](https://en.wikipedia.org/wiki/Nvidia_G-Sync)\n\n[FreeSync](https://en.wikipedia.org/wiki/FreeSync)\n\n\n\n# 7. \n\n\n\n## 7.1 \n\n \"\" \"\"\n\n \"\"  \"\"  \"\" \n\n// TODO: \n\n\n\n\n\n## \n\n\n\n# \n\n[](https://www.cnblogs.com/wkfvawl/p/11559508.html)\n\n[Frame rate](https://en.wikipedia.org/wiki/Frame_rate)\n\n[Refresh rate](https://en.wikipedia.org/wiki/Refresh_rate)\n\n[Screen tearing](https://en.wikipedia.org/wiki/Screen_tearing)\n\n[Vertical blanking interval](https://en.wikipedia.org/wiki/Vertical_blanking_interval)\n\n[Input lag](https://en.wikipedia.org/wiki/Input_lag)\n\n[Multiple buffering](https://en.wikipedia.org/wiki/Multiple_buffering#Double_buffering_in_computer_graphics)\n\n","source":"_drafts/graphics-basis.md","raw":"---\ntitle: \ntags:\n- Basis\n- Graphics\ncategories:\n- [Graphics]\nmathjax: true\n---\n\n\n\n\n\n<!-- more -->\n\n\n\n# 1. \n\n\n\n- \n- CPUGPU\n- \n\nCPU  GPU GPU \n\n\n\n# 2. \n\n (Frame rate) fps(frames per second) \n\n\n\n# 3. \n\n (Refresh rate) HZ \n\n 60HZ  60  $\\frac{1}{60}$  \n\n G-sync  freesync \n\n\n\n# 4. \n\n\n\n\n\n# 5. \n\n (Screen tearing)\n\n<img src=\"https://upload.wikimedia.org/wikipedia/commons/0/03/Tearing_%28simulated%29.jpg\" alt=\"A typical video tearing artifact (simulated image)\" style=\"zoom:30%;\" />\n\n## 5.1 \n\n\n\n 100FPS 60HZ\n\n1.  $\\frac{1}{100}$(0.01)  A\n2.  $\\frac{1}{60}$(0.016)  A $\\frac{2}{60}$(0.032) \n3.  $\\frac{2}{100}$(0.02)  B A  B  A  $\\frac{2}{60}$(0.032)  A  B  B  A  B \n\n\n\n# 6. \n\n [5.1]  \"\"\n\n\n\n## 6.1 \n\n (Vertical synchronization)\n\n\n\n### 6.1.1 ****\n\n (Vertical Blank Interval)\n\n\n\n### 6.1.2 \n\n#### 6.1.2.1 \n\n\n\n 60HZ 60FPS\n\n#### 6.1.2.2 \n\n (Input lag)\n\n 60HZ 16ms \n\n## 6.2 \n\n (variable refresh rate)\n\n### 6.2.1 \n\n[Nvidia G-Sync](https://en.wikipedia.org/wiki/Nvidia_G-Sync)\n\n[FreeSync](https://en.wikipedia.org/wiki/FreeSync)\n\n\n\n# 7. \n\n\n\n## 7.1 \n\n \"\" \"\"\n\n \"\"  \"\"  \"\" \n\n// TODO: \n\n\n\n\n\n## \n\n\n\n# \n\n[](https://www.cnblogs.com/wkfvawl/p/11559508.html)\n\n[Frame rate](https://en.wikipedia.org/wiki/Frame_rate)\n\n[Refresh rate](https://en.wikipedia.org/wiki/Refresh_rate)\n\n[Screen tearing](https://en.wikipedia.org/wiki/Screen_tearing)\n\n[Vertical blanking interval](https://en.wikipedia.org/wiki/Vertical_blanking_interval)\n\n[Input lag](https://en.wikipedia.org/wiki/Input_lag)\n\n[Multiple buffering](https://en.wikipedia.org/wiki/Multiple_buffering#Double_buffering_in_computer_graphics)\n\n","slug":"graphics-basis","published":0,"date":"2021-03-29T09:27:18.242Z","updated":"2021-11-09T12:28:10.293Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckvt7aq4m0003elpr3t86bkmy","content":"<p></p>\n<a id=\"more\"></a>\n\n\n\n<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><p></p>\n<ul>\n<li></li>\n<li>CPUGPU</li>\n<li></li>\n</ul>\n<p>CPU  GPU GPU </p>\n<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><p> (Frame rate) fps(frames per second) </p>\n<h1 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3. \"></a>3. </h1><p> (Refresh rate) HZ </p>\n<p> 60HZ  60  $\\frac{1}{60}$  </p>\n<p> G-sync  freesync </p>\n<h1 id=\"4-\"><a href=\"#4-\" class=\"headerlink\" title=\"4. \"></a>4. </h1><p></p>\n<h1 id=\"5-\"><a href=\"#5-\" class=\"headerlink\" title=\"5. \"></a>5. </h1><p> (Screen tearing)</p>\n<img src=\"https://upload.wikimedia.org/wikipedia/commons/0/03/Tearing_%28simulated%29.jpg\" alt=\"A typical video tearing artifact (simulated image)\" style=\"zoom:30%;\" />\n\n<h2 id=\"5-1-\"><a href=\"#5-1-\" class=\"headerlink\" title=\"5.1 \"></a>5.1 </h2><p></p>\n<p> 100FPS 60HZ</p>\n<ol>\n<li> $\\frac{1}{100}$(0.01)  A</li>\n<li> $\\frac{1}{60}$(0.016)  A $\\frac{2}{60}$(0.032) </li>\n<li> $\\frac{2}{100}$(0.02)  B A  B  A  $\\frac{2}{60}$(0.032)  A  B  B  A  B </li>\n</ol>\n<h1 id=\"6-\"><a href=\"#6-\" class=\"headerlink\" title=\"6. \"></a>6. </h1><p> [5.1]  </p>\n<p></p>\n<h2 id=\"6-1-\"><a href=\"#6-1-\" class=\"headerlink\" title=\"6.1 \"></a>6.1 </h2><p> (Vertical synchronization)</p>\n<p></p>\n<h3 id=\"6-1-1-\"><a href=\"#6-1-1-\" class=\"headerlink\" title=\"6.1.1 \"></a>6.1.1 <strong></strong></h3><p> (Vertical Blank Interval)</p>\n<p></p>\n<h3 id=\"6-1-2-\"><a href=\"#6-1-2-\" class=\"headerlink\" title=\"6.1.2 \"></a>6.1.2 </h3><h4 id=\"6-1-2-1-\"><a href=\"#6-1-2-1-\" class=\"headerlink\" title=\"6.1.2.1 \"></a>6.1.2.1 </h4><p></p>\n<p> 60HZ 60FPS</p>\n<h4 id=\"6-1-2-2-\"><a href=\"#6-1-2-2-\" class=\"headerlink\" title=\"6.1.2.2 \"></a>6.1.2.2 </h4><p> (Input lag)</p>\n<p> 60HZ 16ms </p>\n<h2 id=\"6-2-\"><a href=\"#6-2-\" class=\"headerlink\" title=\"6.2 \"></a>6.2 </h2><p> (variable refresh rate)</p>\n<h3 id=\"6-2-1-\"><a href=\"#6-2-1-\" class=\"headerlink\" title=\"6.2.1 \"></a>6.2.1 </h3><p><a href=\"https://en.wikipedia.org/wiki/Nvidia_G-Sync\">Nvidia G-Sync</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/FreeSync\">FreeSync</a></p>\n<h1 id=\"7-\"><a href=\"#7-\" class=\"headerlink\" title=\"7. \"></a>7. </h1><p></p>\n<h2 id=\"7-1-\"><a href=\"#7-1-\" class=\"headerlink\" title=\"7.1 \"></a>7.1 </h2><p>  </p>\n<p>      </p>\n<p>// TODO: </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"https://www.cnblogs.com/wkfvawl/p/11559508.html\"></a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Frame_rate\">Frame rate</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Refresh_rate\">Refresh rate</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Screen_tearing\">Screen tearing</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Vertical_blanking_interval\">Vertical blanking interval</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Input_lag\">Input lag</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Multiple_buffering#Double_buffering_in_computer_graphics\">Multiple buffering</a></p>\n","site":{"data":{}},"excerpt":"<p></p>","more":"<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><p></p>\n<ul>\n<li></li>\n<li>CPUGPU</li>\n<li></li>\n</ul>\n<p>CPU  GPU GPU </p>\n<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><p> (Frame rate) fps(frames per second) </p>\n<h1 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3. \"></a>3. </h1><p> (Refresh rate) HZ </p>\n<p> 60HZ  60  $\\frac{1}{60}$  </p>\n<p> G-sync  freesync </p>\n<h1 id=\"4-\"><a href=\"#4-\" class=\"headerlink\" title=\"4. \"></a>4. </h1><p></p>\n<h1 id=\"5-\"><a href=\"#5-\" class=\"headerlink\" title=\"5. \"></a>5. </h1><p> (Screen tearing)</p>\n<img src=\"https://upload.wikimedia.org/wikipedia/commons/0/03/Tearing_%28simulated%29.jpg\" alt=\"A typical video tearing artifact (simulated image)\" style=\"zoom:30%;\" />\n\n<h2 id=\"5-1-\"><a href=\"#5-1-\" class=\"headerlink\" title=\"5.1 \"></a>5.1 </h2><p></p>\n<p> 100FPS 60HZ</p>\n<ol>\n<li> $\\frac{1}{100}$(0.01)  A</li>\n<li> $\\frac{1}{60}$(0.016)  A $\\frac{2}{60}$(0.032) </li>\n<li> $\\frac{2}{100}$(0.02)  B A  B  A  $\\frac{2}{60}$(0.032)  A  B  B  A  B </li>\n</ol>\n<h1 id=\"6-\"><a href=\"#6-\" class=\"headerlink\" title=\"6. \"></a>6. </h1><p> [5.1]  </p>\n<p></p>\n<h2 id=\"6-1-\"><a href=\"#6-1-\" class=\"headerlink\" title=\"6.1 \"></a>6.1 </h2><p> (Vertical synchronization)</p>\n<p></p>\n<h3 id=\"6-1-1-\"><a href=\"#6-1-1-\" class=\"headerlink\" title=\"6.1.1 \"></a>6.1.1 <strong></strong></h3><p> (Vertical Blank Interval)</p>\n<p></p>\n<h3 id=\"6-1-2-\"><a href=\"#6-1-2-\" class=\"headerlink\" title=\"6.1.2 \"></a>6.1.2 </h3><h4 id=\"6-1-2-1-\"><a href=\"#6-1-2-1-\" class=\"headerlink\" title=\"6.1.2.1 \"></a>6.1.2.1 </h4><p></p>\n<p> 60HZ 60FPS</p>\n<h4 id=\"6-1-2-2-\"><a href=\"#6-1-2-2-\" class=\"headerlink\" title=\"6.1.2.2 \"></a>6.1.2.2 </h4><p> (Input lag)</p>\n<p> 60HZ 16ms </p>\n<h2 id=\"6-2-\"><a href=\"#6-2-\" class=\"headerlink\" title=\"6.2 \"></a>6.2 </h2><p> (variable refresh rate)</p>\n<h3 id=\"6-2-1-\"><a href=\"#6-2-1-\" class=\"headerlink\" title=\"6.2.1 \"></a>6.2.1 </h3><p><a href=\"https://en.wikipedia.org/wiki/Nvidia_G-Sync\">Nvidia G-Sync</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/FreeSync\">FreeSync</a></p>\n<h1 id=\"7-\"><a href=\"#7-\" class=\"headerlink\" title=\"7. \"></a>7. </h1><p></p>\n<h2 id=\"7-1-\"><a href=\"#7-1-\" class=\"headerlink\" title=\"7.1 \"></a>7.1 </h2><p>  </p>\n<p>      </p>\n<p>// TODO: </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"https://www.cnblogs.com/wkfvawl/p/11559508.html\"></a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Frame_rate\">Frame rate</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Refresh_rate\">Refresh rate</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Screen_tearing\">Screen tearing</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Vertical_blanking_interval\">Vertical blanking interval</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Input_lag\">Input lag</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Multiple_buffering#Double_buffering_in_computer_graphics\">Multiple buffering</a></p>"},{"title":" init ","date":"2021-07-10T08:28:09.000Z","_content":"\n\n\n> android-security-10.0.0_r56\n\n\n\n# 1. \n\n<!-- TODO:  init  -->\n\nAndroid  Linux  init \n\ninit  pid = 1\n\n<!-- more -->\n\n\n\n# 2. \n\n<!-- TODO:  -->\n\n\n\n## 2.1 init \n\n<!-- TODO:  -->\n\n<!-- TODO: init ,  /system/core/init -->\n\n Android 9init  `system/core/init/init.cpp`  main \n\n Android 10 init  `system/core/init/main.cpp`  main \n\n```c++\nint main(int argc, char** argv) {\n    ...\n\n    if (!strcmp(basename(argv[0]), \"ueventd\")) {\n        return ueventd_main(argc, argv);\n    }\n\n    if (argc > 1) {\n        if (!strcmp(argv[1], \"subcontext\")) {\n            android::base::InitLogging(argv, &android::base::KernelLogger);\n            const BuiltinFunctionMap& function_map = GetBuiltinFunctionMap();\n\n            return SubcontextMain(argc, argv, &function_map);\n        }\n\n        if (!strcmp(argv[1], \"selinux_setup\")) {\n            return SetupSelinux(argv);\n        }\n\n        if (!strcmp(argv[1], \"second_stage\")) {\n            return SecondStageMain(argc, argv);\n        }\n    }\n\n    return FirstStageMain(argc, argv);\n}\n```\n\n`basename`  `strcmp` \n\n- `basename`  `char* basename(char* __path)` \"/system/bin/ueventd\" \"ueventd\"\n- `strcmp`  `int strcmp(const char* __lhs, const char* __rhs)` 0\n\n main  `argc`  `argv` `FirstStageMain` \n\n\n\n## 2.2 \n\n<!-- TODO: mkdir, mknod, tmpfs -->\n\n<!-- TODO:  -->\n\n<!-- TODO: KernelLogging(/dev/kmsg) -->\n\n<!-- TODO: InstallRebootSignalHandlers -->\n\n `int FirstStageMain(int argc, char** argv)`  `system/core/init/first_stage_init.cpp`\n\n```c++\nint FirstStageMain(int argc, char** argv) {\n    ...\n\n    CHECKCALL(clearenv());\n    CHECKCALL(setenv(\"PATH\", _PATH_DEFPATH, 1));\n    // Get the basic filesystem setup we need put together in the initramdisk\n    // on / and then we'll let the rc file figure out the rest.\n    CHECKCALL(mount(\"tmpfs\", \"/dev\", \"tmpfs\", MS_NOSUID, \"mode=0755\"));\n    CHECKCALL(mkdir(\"/dev/pts\", 0755));\n    CHECKCALL(mkdir(\"/dev/socket\", 0755));\n    CHECKCALL(mkdir(\"/dev/dm-user\", 0755));\n    CHECKCALL(mount(\"devpts\", \"/dev/pts\", \"devpts\", 0, NULL));\n#define MAKE_STR(x) __STRING(x)\n    CHECKCALL(mount(\"proc\", \"/proc\", \"proc\", 0, \"hidepid=2,gid=\" MAKE_STR(AID_READPROC)));\n#undef MAKE_STR\n\n    // Don't expose the raw commandline to unprivileged processes.\n    //  [2.2.1]\n    CHECKCALL(chmod(\"/proc/cmdline\", 0440));\n    std::string cmdline;\n    android::base::ReadFileToString(\"/proc/cmdline\", &cmdline);\n    // Don't expose the raw bootconfig to unprivileged processes.\n    chmod(\"/proc/bootconfig\", 0440);\n    std::string bootconfig;\n    android::base::ReadFileToString(\"/proc/bootconfig\", &bootconfig);\n    gid_t groups[] = {AID_READPROC};\n    CHECKCALL(setgroups(arraysize(groups), groups));\n    CHECKCALL(mount(\"sysfs\", \"/sys\", \"sysfs\", 0, NULL));\n    CHECKCALL(mount(\"selinuxfs\", \"/sys/fs/selinux\", \"selinuxfs\", 0, NULL));\n\n    CHECKCALL(mknod(\"/dev/kmsg\", S_IFCHR | 0600, makedev(1, 11)));\n\n    if constexpr (WORLD_WRITABLE_KMSG) {\n        CHECKCALL(mknod(\"/dev/kmsg_debug\", S_IFCHR | 0622, makedev(1, 11)));\n    }\n\n    CHECKCALL(mknod(\"/dev/random\", S_IFCHR | 0666, makedev(1, 8)));\n    CHECKCALL(mknod(\"/dev/urandom\", S_IFCHR | 0666, makedev(1, 9)));\n\n    // This is needed for log wrapper, which gets called before ueventd runs.\n    CHECKCALL(mknod(\"/dev/ptmx\", S_IFCHR | 0666, makedev(5, 2)));\n    CHECKCALL(mknod(\"/dev/null\", S_IFCHR | 0666, makedev(1, 3)));\n\n    // These below mounts are done in first stage init so that first stage mount can mount\n    // subdirectories of /mnt/{vendor,product}/.  Other mounts, not required by first stage mount,\n    // should be done in rc files.\n    // Mount staging areas for devices managed by vold\n    // See storage config details at http://source.android.com/devices/storage/\n    CHECKCALL(mount(\"tmpfs\", \"/mnt\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=1000\"));\n    // /mnt/vendor is used to mount vendor-specific partitions that can not be\n    // part of the vendor partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/vendor\", 0755));\n    // /mnt/product is used to mount product-specific partitions that can not be\n    // part of the product partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/product\", 0755));\n\n    // /debug_ramdisk is used to preserve additional files from the debug ramdisk\n    CHECKCALL(mount(\"tmpfs\", \"/debug_ramdisk\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"));\n\n    // /second_stage_resources is used to preserve files from first to second\n    // stage init\n    CHECKCALL(mount(\"tmpfs\", kSecondStageRes, \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"))\n#undef CHECKCALL\n\n    SetStdioToDevNull(argv);\n    // Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually\n    // talk to the outside world...\n    InitKernelLogging(argv);\n\n    if (!errors.empty()) {\n        for (const auto& [error_string, error_errno] : errors) {\n            LOG(ERROR) << error_string << \" \" << strerror(error_errno);\n        }\n        LOG(FATAL) << \"Init encountered errors starting first stage, aborting\";\n    }\n\n    LOG(INFO) << \"init first stage started!\";\n\n    ...\n\n    //  /system/bin/init\n    //  selinux_setup,  SetupSelinux  SELinux  [2.3]\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"selinux_setup\", nullptr};\n    auto fd = open(\"/dev/kmsg\", O_WRONLY | O_CLOEXEC);\n    dup2(fd, STDOUT_FILENO);\n    dup2(fd, STDERR_FILENO);\n    close(fd);\n    execv(path, const_cast<char**>(args));\n\n    // execv() only returns if an error happened, in which case we\n    // panic and never fall through this conditional.\n    PLOG(FATAL) << \"execv(\\\"\" << path << \"\\\") failed\";\n\n    return 1;\n}\n```\n\n `/system/bin/init` main  `\"selinux_setup\"` SetupSelinux  SELinux \n\n\n\n### 2.2.1 \n\n Linux `chmod` \n\n\n\n\n\n#### 2.2.1.1 \n\n 10 \n\n```\n-rwxrwxrwx\n```\n\n\n\n- `-`\n- `d`\n- `c`\n\n 9  3 \n\n3  1  2  3 \n\n-  1  `r` `-`\n-  2  `w` `-`\n-  3  `x` `-`\n\n`-rwxrw-r--` \n\n\n\n#### 2.2.1.2 \n\n 4  1  3 \n\n 3  3 \n\n|                    |  |\n| :--------------------: | :--: |\n| 1004 |  r   |\n| 0102 |  w   |\n| 0011 |  x   |\n| 0000 |  -   |\n\n 0~7\n\n|                    |  |\n| :--------------------: | :--: |\n| 1117 | rwx  |\n| 1106 | rw-  |\n| 1015 | r-x  |\n| 0000 | ---  |\n\n\n\n|  |  |                                                          |\n| :--------: | :--------: | :----------------------------------------------------------: |\n| -rwxrwxrwx |    0777    |  |\n| -rwxrw-r-- |    0764    |  |\n\n\n\n#### 2.2.1.3 \n\n```c++\n// Don't expose the raw commandline to unprivileged processes.\nCHECKCALL(chmod(\"/proc/cmdline\", 0440));\n\n// Don't expose the raw bootconfig to unprivileged processes.\nchmod(\"/proc/bootconfig\", 0440);\n```\n\n `chmod`  `/proc/cmdline``/proc/bootconfig`  `0440` root  () \n\n\n\n## 2.3  SELinux\n\n<!-- TODO:  SELinux -->\n\n `int SetupSelinux(char** argv)`  SELinux  `system/core/init/selinux.cpp`\n\n```c++\n// This function initializes SELinux then execs init to run in the init SELinux context.\nint SetupSelinux(char** argv) {\n    ...\n\n    // Set up SELinux, loading the SELinux policy.\n    //  SELinux\n    SelinuxSetupKernelLogging();\n    SelinuxInitialize();\n\n    ...\n\n    //  /system/bin/init\n    //  second_stage,  SecondStageMain  [2.4]\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"second_stage\", nullptr};\n    execv(path, const_cast<char**>(args));\n\n    ...\n\n    return 1;\n}\n```\n\n SELinux `/system/bin/init` main  `\"second_stage\"` SecondStageMain \n\n\n\n## 2.4 \n\n<!-- TODO: property_load_boot_defaults -->\n\n<!-- TODO: , android  build.prop  -->\n\n<!-- TODO: SELinux  -->\n\n<!-- TODO: keyctl_get_keyring_ID(KEY_SPEC_SESSION_KEYRING, 1) -->\n\n<!-- TODO: InitializeSubcontext() -->\n\n<!-- TODO: ActionManager  ServiceList  -->\n\n `int SecondStageMain(int argc, char** argv)`  `system/core/init/init.cpp`\n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    // Set init and its forked children's oom_adj.\n    //  init  fork  oom_score_adj \n    // , \n    if (auto result = WriteFile(\"/proc/1/oom_score_adj\", \"-1000\"); !result) {\n        LOG(ERROR) << \"Unable to write -1000 to /proc/1/oom_score_adj: \" << result.error();\n    }\n\n    ...\n\n    //  [2.4.2.1]\n    property_init();\n\n    ...\n\n    //  epoll [2.4.1.1]\n    Epoll epoll;\n    if (auto result = epoll.Open(); !result) {\n        PLOG(FATAL) << result.error();\n    }\n\n    //  epoll  init  [2.4.3.1.3]\n    // \n    InstallSignalFdHandler(&epoll);\n\n    ...\n\n    //  [2.4.2.2]\n    StartPropertyService(&epoll);\n\n    ...\n\n    ActionManager& am = ActionManager::GetInstance();\n    ServiceList& sm = ServiceList::GetInstance();\n\n    //  [2.4.4]\n    LoadBootScripts(am, sm);\n\n    ...\n\n    //  Action [2.4.5.1]\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n    am.QueueEventTrigger(\"early-init\");\n    am.QueueBuiltinAction(wait_for_coldboot_done_action, \"wait_for_coldboot_done\");\n    ...\n    am.QueueBuiltinAction(queue_property_triggers_action, \"queue_property_triggers\");\n\n    //  [2.4.5]\n    while (true) {\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{};\n\n        if (do_shutdown && !shutting_down) {\n            do_shutdown = false;\n            if (HandlePowerctlMessage(shutdown_command)) {\n                shutting_down = true;\n            }\n        }\n\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            am.ExecuteOneCommand();\n        }\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            if (!shutting_down) {\n                auto next_process_action_time = HandleProcessActions();\n\n                if (next_process_action_time) {\n                    epoll_timeout = std::chrono::ceil<std::chrono::milliseconds>(\n                            *next_process_action_time - boot_clock::now());\n                    if (*epoll_timeout < 0ms) epoll_timeout = 0ms;\n                }\n            }\n\n            if (am.HasMoreCommands()) epoll_timeout = 0ms;\n        }\n\n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\n 5 \n\n- epoll\n\n- \n\n- \n\n- \n\n- \n\n 5 \n\n\n\n### 2.4.1 epoll\n\nepoll  Linux  I/O epoll \n\n\n\n#### 2.4.1.1 \n\n init epoll \n\n```c++\nEpoll epoll;\nif (auto result = epoll.Open(); !result) {\n    PLOG(FATAL) << result.error();\n}\n```\n\nepoll  Open  `system/core/init/epoll.cpp`\n\n```c++\nResult<Success> Epoll::Open() {\n    if (epoll_fd_ >= 0) return Success();\n\n    // \n    epoll_fd_.reset(epoll_create1(EPOLL_CLOEXEC));\n\n    if (epoll_fd_ == -1) {\n        return ErrnoError() << \"epoll_create1 failed\";\n    }\n    return Success();\n}\n```\n\n `epoll_create1``epoll_create1`  epoll \n\n\n\n#### 2.4.1.2  epoll \n\n epoll  RegisterHandler  epoll\n\n `system/core/init/epoll.cpp` epoll_ctl\n\n```c++\nResult<Success> Epoll::RegisterHandler(int fd, std::function<void()> handler, uint32_t events) {\n    ...\n\n    // \n    if (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &ev) == -1) {\n\n        ...\n\n        return result;\n    }\n    return Success();\n}\n```\n\n epoll_ctl \n\n\n\n##### 2.4.1.2.1  epoll_ctl\n\n**epoll_ctl**  `int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)` fd \n\n\n\n###### 2.4.1.2.1.1 \n\n epoll_ctl \n\n- **epfd**  epoll \n\n- **op** \n\n  - **EPOLL_CTL_ADD**\n\n     epoll \n\n  - **EPOLL_CTL_MOD**\n\n     epoll \n\n  - **EPOLL_CTL_DEL**\n\n     epoll \n\n- **fd** \n\n- **event**  epoll_event  epoll_event \n\n  ```c++\n  struct epoll_event {\n     uint32_t     events;      /* Epoll events */\n     epoll_data_t data;        /* User data variable */\n  };\n  ```\n\n   `events` \n\n  - \u0015\u0015**EPOLLIN**\n    \n\n  - **EPOLLOUT**\n    \n\n  - **EPOLLPRI**\n    \n\n  - **EPOLLERR**\n    \n\n  - **EPOLLHUP**\n    \n\n  - **EPOLLONESHOT**\n    epoll \n     epoll_ctl EPOLL_CTL_MOD \n\n   `data`  [2.4.1.3]`epoll_data_t` \n\n  ```c++\n  typedef union epoll_data {\n     void        *ptr;\n     int          fd;\n     uint32_t     u32;\n     uint64_t     u64;\n  } epoll_data_t;\n  ```\n\n\n\n###### 2.4.1.2.1.2 \n\n epoll_ctl \n\n-  0\n\n-  -1\n\n\n\n##### 2.4.1.2.2  RegisterHandler \n\n epoll_ctl  RegisterHandler  `system/core/init/epoll.h`\n\n```c++\nclass Epoll {\n  public:\n    Result<Success> RegisterHandler(int fd, std::function<void()> handler,\n                                    uint32_t events = EPOLLIN);\n};\n```\n\n `events`  `EPOLLIN`\n\n RegisterHandler \n\n```c++\nResult<Success> Epoll::RegisterHandler(int fd, std::function<void()> handler, uint32_t events) {\n    ...\n\n    // handler \n    auto [it, inserted] = epoll_handlers_.emplace(fd, std::move(handler));\n\n    ...\n\n    epoll_event ev;\n\n    // \n    //  events  EPOLLIN, \n    ev.events = events;\n  \n    // ,  [2.4.1.3.2]\n    ev.data.ptr = reinterpret_cast<void*>(&it->second);\n\n    //  epoll_ctl \n    //  EPOLL_CTL_ADD, \n    if (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &ev) == -1) {\n        Result<Success> result = ErrnoError() << \"epoll_ctl failed to add fd\";\n        epoll_handlers_.erase(fd);\n        return result;\n    }\n    return Success();\n}\n```\n\n `events`  `handler` `epoll_ctl`  epoll \n\n\n\n#### 2.4.1.3 \n\n epoll  epoll \n\n init \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    while (true) {\n        ...\n\n        // \n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\n Wait \n\n\n\n##### 2.4.1.3.1  epoll_wait\n\n Wait  epoll_wait Wait \n\n**epoll_wait**  `int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout)` epoll \n\n epoll_wait \n\n- \n- \n- \n\n\n\n###### 2.4.1.3.1.1 \n\n epoll_wait \n\n- **epfd**  epoll \n\n- **events**  epoll_event  epoll_event  [2.4.1.2.1] \n\n   events  epoll_event  data  epoll_ctl  data  epoll_ctl  event.data  epoll_wait \n\n- **maxevents**  events  maxevents\n\n- **timeout**  timeout = -1  timeout = 0 \n\n\n\n###### 2.4.1.3.1.2 \n\n epoll_wait \n\n-  I/O \n\n   0\n\n-  -1\n\n\n\n##### 2.4.1.3.2  Wait \n\n epoll_wait  Wait  `system/core/init/epoll.cpp`\n\n```c++\nResult<Success> Epoll::Wait(std::optional<std::chrono::milliseconds> timeout) {\n    //  -1\n    int timeout_ms = -1;\n\n    if (timeout && timeout->count() < INT_MAX) {\n        //  timeout  0 , \n        timeout_ms = timeout->count();\n    }\n\n    epoll_event ev;\n\n    //  epoll_wait \n    //  1,  1 \n    auto nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd_, &ev, 1, timeout_ms));\n\n    if (nr == -1) {\n        //  -1, \n        return ErrnoError() << \"epoll_wait failed\";\n    } else if (nr == 1) {\n        //  1, ,  1 \n        // ev.data.ptr  epoll_ctl , \n        std::invoke(*reinterpret_cast<std::function<void()>*>(ev.data.ptr));\n    }\n    return Success();\n}\n```\n\n `epoll_wait`  `epoll_wait`  epoll_ctl \n\n\n\n### 2.4.2 \n\n Android  key-value \n\n adb `getprop`\n\n```\n[ro.product.brand]: [Redmi]\n[ro.product.manufacturer]: [Xiaomi]\n[ro.product.marketname]: [Redmi K30S Ultra]\n[ro.product.model]: [M2007J3SC]\n[ro.product.name]: [apollo]\n\n[ro.product.cpu.abi]: [arm64-v8a]\n[ro.product.cpu.abilist]: [arm64-v8a,armeabi-v7a,armeabi]\n[ro.product.cpu.abilist32]: [armeabi-v7a,armeabi]\n[ro.product.cpu.abilist64]: [arm64-v8a]\n\n[dalvik.vm.heapsize]: [512m]\n[dalvik.vm.heapstartsize]: [8m]\n```\n\nCPU \n\n Java  `SystemProperties.get(String, String)`  ActivityManager \n\n```java\nstatic public int staticGetLargeMemoryClass() {\n    //  dalvik.vm.heapsize, \n    String vmHeapSize = SystemProperties.get(\"dalvik.vm.heapsize\", \"16m\");\n\n    return Integer.parseInt(vmHeapSize.substring(0, vmHeapSize.length() - 1));\n}\n```\n\n `SystemProperties.set(String, String)`  ActivityManagerService \n\n```java\nfinal void finishBooting() {\n    ...\n\n    synchronized (this) {\n\n        ...\n\n        // Tell anyone interested that we are done booting!\n        //  sys.boot_completed = 1, \n        SystemProperties.set(\"sys.boot_completed\", \"1\");\n\n        ...\n    }\n\n    ...\n}\n```\n\n\n\n#### 2.4.2.1 \n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: CreateSerializedPropertyInfo() -->\n\n<!-- TODO: property_info_area.LoadDefaultPath() -->\n\n property_init  `system/core/init/property_service.cpp`\n\n```c++\nvoid property_init() {\n    mkdir(\"/dev/__properties__\", S_IRWXU | S_IXGRP | S_IXOTH);\n    CreateSerializedPropertyInfo();\n\n    // \n    if (__system_property_area_init()) {\n        LOG(FATAL) << \"Failed to initialize property area\";\n    }\n\n    if (!property_info_area.LoadDefaultPath()) {\n        LOG(FATAL) << \"Failed to load serialized property info file\";\n    }\n}\n```\n\n `__system_property_area_init` \n\n\n\n#### 2.4.2.2 \n\n<!-- TODO: socket  -->\n\n<!-- TODO: listen(property_set_fd, 8) -->\n\n<!-- TODO:  init  -->\n\n StartPropertyService  `system/core/init/property_service.cpp`\n\n```c++\nvoid StartPropertyService(Epoll* epoll) {\n\n    ...\n\n    //  socket ,  PROP_SERVICE_NAME = \"property_service\"\n    property_set_fd = CreateSocket(PROP_SERVICE_NAME, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK,\n                                   false, 0666, 0, 0, nullptr);\n    if (property_set_fd == -1) {\n        PLOG(FATAL) << \"start_property_service socket creation failed\";\n    }\n\n    listen(property_set_fd, 8);\n\n    //  socket  epoll,  [2.4.1.2]\n    // handle_property_set_fd  [2.4.2.3]\n    if (auto result = epoll->RegisterHandler(property_set_fd, handle_property_set_fd); !result) {\n        PLOG(FATAL) << result.error();\n    }\n}\n```\n\n property_service  socket socket  epoll\n\n `handle_property_set_fd`\n\n\n\n#### 2.4.2.3  handle_property_set_fd\n\n<!-- TODO: ucred cr; socklen_t cr_size = sizeof(cr); -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  init ,  -->\n\n<!-- TODO:  -->\n\n `system/core/init/property_service.cpp`\n\n```c++\nstatic void handle_property_set_fd() {\n    // 2000ms\n    static constexpr uint32_t kDefaultSocketTimeout = 2000; /* ms */\n\n    ...\n\n    SocketConnection socket(s, cr);\n\n    //  2000ms \n    uint32_t timeout_ms = kDefaultSocketTimeout;\n\n    uint32_t cmd = 0;\n    if (!socket.RecvUint32(&cmd, &timeout_ms)) {\n        PLOG(ERROR) << \"sys_prop: error while reading command from the socket\";\n        socket.SendUint32(PROP_ERROR_READ_CMD);\n        return;\n    }\n\n    switch (cmd) {\n    //  PROP_MSG_SETPROP \n    case PROP_MSG_SETPROP: {\n        // PROP_NAME_MAX = 32\n        char prop_name[PROP_NAME_MAX];\n        char prop_value[PROP_VALUE_MAX];\n\n        // ,  prop_name  prop_value \n        if (!socket.RecvChars(prop_name, PROP_NAME_MAX, &timeout_ms) ||\n            !socket.RecvChars(prop_value, PROP_VALUE_MAX, &timeout_ms)) {\n          PLOG(ERROR) << \"sys_prop(PROP_MSG_SETPROP): error while reading name/value from the socket\";\n          return;\n        }\n\n        //  0\n        prop_name[PROP_NAME_MAX-1] = 0;\n        prop_value[PROP_VALUE_MAX-1] = 0;\n\n        const auto& cr = socket.cred();\n        std::string error;\n\n        // \n        uint32_t result =\n            HandlePropertySet(prop_name, prop_value, socket.source_context(), cr, &error);\n\n        if (result != PROP_SUCCESS) {\n            LOG(ERROR) << \"Unable to set property '\" << prop_name << \"' to '\" << prop_value\n                       << \"' from uid:\" << cr.uid << \" gid:\" << cr.gid << \" pid:\" << cr.pid << \": \"\n                       << error;\n        }\n\n        break;\n      }\n\n    //  PROP_MSG_SETPROP2 \n    case PROP_MSG_SETPROP2: {\n        std::string name;\n        std::string value;\n\n        // \n        if (!socket.RecvString(&name, &timeout_ms) ||\n            !socket.RecvString(&value, &timeout_ms)) {\n          PLOG(ERROR) << \"sys_prop(PROP_MSG_SETPROP2): error while reading name/value from the socket\";\n          socket.SendUint32(PROP_ERROR_READ_DATA);\n          return;\n        }\n\n        const auto& cr = socket.cred();\n        std::string error;\n\n        // \n        uint32_t result = HandlePropertySet(name, value, socket.source_context(), cr, &error);\n\n        if (result != PROP_SUCCESS) {\n            LOG(ERROR) << \"Unable to set property '\" << name << \"' to '\" << value\n                       << \"' from uid:\" << cr.uid << \" gid:\" << cr.gid << \" pid:\" << cr.pid << \": \"\n                       << error;\n        }\n        socket.SendUint32(result);\n        break;\n      }\n\n    default:\n        LOG(ERROR) << \"sys_prop: invalid command \" << cmd;\n        socket.SendUint32(PROP_ERROR_INVALID_CMD);\n        break;\n    }\n}\n```\n\n socket  `cmd` \n\n-  `PROP_MSG_SETPROP`  `PROP_NAME_MAX`  0 `PROP_NAME_MAX - 1` \n-  `PROP_MSG_SETPROP2`  `std::string` \n\n `PROP_MSG_SETPROP`  `PROP_MSG_SETPROP2`  `HandlePropertySet` \n\n\n\n### 2.4.3 \n\n** (Signals)**  IPC \n\n****\n\n\n\n#### 2.4.3.1 \n\n Linux (PID) waitwaitpid  waitid ** (Zombie process)**\n\n init init \n\n [2.4.4] init  fork servicemanager zygote  Android init \n\ninit \n\n Android Linux \n\n\n\n##### 2.4.3.1.1 \n\n<!-- :  -->\n\n\n\n- ****\n- ****\n- ****\n\ninit \n\n\n\n\n\n##### 2.4.3.1.2  sigaction\n\n init  sigaction\n\n**sigaction**  `int sigaction(int signum, const struct sigaction *restrict act, struct sigaction *restrict oldact)`\n\n\n\n###### 2.4.3.1.2.1 \n\n sigaction \n\n- **signum** \n\n   AndroidARM  `bionic/libc/kernel/uapi/asm-arm/asm/signal.h` \n\n- **act**  sigaction  sigaction \n\n  ```c++\n  struct sigaction {\n     void     (*sa_handler)(int);\n     void     (*sa_sigaction)(int, siginfo_t *, void *);\n     sigset_t   sa_mask;\n     int        sa_flags;\n     void     (*sa_restorer)(void);\n  };\n  ```\n\n   `sa_handler`  `sa_flags`\n\n   `sa_handler` \n\n  - **SIG_DFL**\n\n    \n\n  - **SIG_IGN**\n\n    \n\n  - ****\n\n     signum \n\n   `sa_flags` \n\n  - **SA_NOCLDSTOP**\n\n     signum = SIGCHLD \n\n  - **SA_RESETHAND**\n\n    \n\n  - **SA_SIGINFO**\n\n     sa_handler  sa_sigaction\n\n- **oldact**  sigaction  sigaction  act\n\n\n\n###### 2.4.3.1.2.2 \n\n sigaction \n\n-  0\n\n-  -1\n\n\n\n##### 2.4.3.1.3 init \n\n sigaction  init \n\n\n\n###### 2.4.3.1.3.1  sigaction\n\ninit  InstallSignalFdHandler  `system/core/init/init.cpp`\n\n```c++\nstatic void InstallSignalFdHandler(Epoll* epoll) {\n    //  sigaction\n    //  sa_handler ,  sa_handler = SIG_DFL \n    //  sa_flags ,  sa_flags = SA_NOCLDSTOP  init , \n    const struct sigaction act { .sa_handler = SIG_DFL, .sa_flags = SA_NOCLDSTOP };\n\n    // sigaction ,  [2.4.3.1.2]\n    //  SIGCHLD,  SIGCHLD, , , , \n    sigaction(SIGCHLD, &act, nullptr);\n\n    ...\n\n}\n```\n\n sigaction `SIGCHLD`  `SIGCHLD` \n\n `SIGCHLD`  `SA_NOCLDSTOP`  init \n\ninit  signal  InstallSignalFdHandler \n\n\n\n###### 2.4.3.1.3.2  signal \n\n\n\nLinux  signalfd\n\ninit \n\n```c++\nstatic void InstallSignalFdHandler(Epoll* epoll) {\n\n    ...\n\n    // mask , \n    // ,  SIGCHLD\n    sigset_t mask;\n    sigemptyset(&mask);\n    sigaddset(&mask, SIGCHLD);\n\n    ...\n\n    //  signal \n    // ,  signalfd ,  -1, \n    signal_fd = signalfd(-1, &mask, SFD_CLOEXEC);\n\n    if (signal_fd == -1) {\n        PLOG(FATAL) << \"failed to create signalfd\";\n    }\n\n    //  signal  epoll,  [2.4.1.2]\n    // HandleSignalFd  [2.4.3.1.4]\n    if (auto result = epoll->RegisterHandler(signal_fd, HandleSignalFd); !result) {\n        LOG(FATAL) << result.error();\n    }\n}\n```\n\n `SIGCHLD` signal  epoll\n\n signal  HandleSignalFd \n\n\n\n##### 2.4.3.1.4  HandleSignalFd\n\n `system/core/init/init.cpp`\n\n```c++\nstatic void HandleSignalFd() {\n    signalfd_siginfo siginfo;\n\n    //  signal  signalfd_siginfo, \n    ssize_t bytes_read = TEMP_FAILURE_RETRY(read(signal_fd, &siginfo, sizeof(siginfo)));\n\n    if (bytes_read != sizeof(siginfo)) {\n        PLOG(ERROR) << \"Failed to read siginfo from signal_fd\";\n        return;\n    }\n\n    // \n    switch (siginfo.ssi_signo) {\n        case SIGCHLD:\n            ReapAnyOutstandingChildren();\n            break;\n        case SIGTERM:\n            HandleSigtermSignal(siginfo);\n            break;\n        default:\n            PLOG(ERROR) << \"signal_fd: received unexpected signal \" << siginfo.ssi_signo;\n            break;\n    }\n}\n```\n\nsignal  signalfd_siginfo HandleSignalFd  signal  signalfd_siginfo\n\n `SIGCHLD` ReapAnyOutstandingChildren \n\n\n\n###### 2.4.3.1.4.1  ReapAnyOutstandingChildren \n\n `system/core/init/sigchld_handler.cpp`\n\n```c++\nvoid ReapAnyOutstandingChildren() {\n    while (ReapOneProcess()) {\n    }\n}\n```\n\n ReapOneProcess  ReapOneProcess  false  ReapOneProcess \n\n\n\n###### 2.4.3.1.4.2  ReapOneProcess \n\n<!-- TODO:  service->flags() -->\n\n<!-- TODO:  ServiceList::GetInstance().RemoveService(*service) -->\n\n `system/core/init/sigchld_handler.cpp`\n\n```c++\nstatic bool ReapOneProcess() {\n    siginfo_t siginfo = {};\n\n    //  waitid, \n    //  init , ,  siginfo \n    if (TEMP_FAILURE_RETRY(waitid(P_ALL, 0, &siginfo, WEXITED | WNOHANG | WNOWAIT)) != 0) {\n        // ,  false\n        PLOG(ERROR) << \"waitid failed\";\n        return false;\n    }\n\n    //  pid\n    auto pid = siginfo.si_pid;\n\n    //  pid ,  false\n    if (pid == 0) return false;\n\n    ...\n\n    std::string name;\n    std::string wait_string;\n    Service* service = nullptr;\n\n    if (PropertyChildReap(pid)) {\n        name = \"Async property child\";\n    } else if (SubcontextChildReap(pid)) {\n        name = \"Subcontext\";\n    } else {\n        //  pid  service\n        service = ServiceList::GetInstance().FindService(pid, &Service::pid);\n\n        if (service) {\n            name = StringPrintf(\"Service '%s' (pid %d)\", service->name().c_str(), pid);\n\n            ...\n\n        } else {\n            name = StringPrintf(\"Untracked pid %d\", pid);\n        }\n    }\n\n    ...\n\n    //  service,  true\n    if (!service) return true;\n\n    //  service  Reap \n    service->Reap(siginfo);\n\n    ...\n\n    return true;\n}\n```\n\nReapOneProcess  waitid pid  service service  service  Reap  Reap \n\n\n\n###### 2.4.3.1.4.3  Reap \n\n `system/core/init/service.cpp`\n\n```c++\nvoid Service::Reap(const siginfo_t& siginfo) {\n    if (!(flags_ & SVC_ONESHOT) || (flags_ & SVC_RESTART)) {\n        //  SVC_ONESHOT  SVC_RESTART, \n        KillProcessGroup(SIGKILL);\n    }\n\n    ...\n\n    //  SVC_TEMPORARY, \n    if (flags_ & SVC_TEMPORARY) return;\n\n    // \n    pid_ = 0;\n    flags_ &= (~SVC_RUNNING);\n    start_order_ = 0;\n\n    if ((flags_ & SVC_ONESHOT) && !(flags_ & SVC_RESTART) && !(flags_ & SVC_RESET)) {\n        //  SVC_ONESHOT \n        flags_ |= SVC_DISABLED;\n    }\n\n    if (flags_ & (SVC_DISABLED | SVC_RESET))  {\n        //  SVC_DISABLED  SVC_RESET,  stopped , \n        NotifyStateChange(\"stopped\");\n        return;\n    }\n\n    //  SVC_CRITICAL \n    //  4  4 , \n    //  bootloader \n    boot_clock::time_point now = boot_clock::now();\n    if (((flags_ & SVC_CRITICAL) || !pre_apexd_) && !(flags_ & SVC_RESTART)) {\n        bool boot_completed = android::base::GetBoolProperty(\"sys.boot_completed\", false);\n        if (now < time_crashed_ + 4min || !boot_completed) {\n            if (++crash_count_ > 4) {\n                if (flags_ & SVC_CRITICAL) {\n                    // Aborts into bootloader\n                    LOG(FATAL) << \"critical process '\" << name_ << \"' exited 4 times \"\n                               << (boot_completed ? \"in 4 minutes\" : \"before boot completed\");\n                } else {\n                    LOG(ERROR) << \"updatable process '\" << name_ << \"' exited 4 times \"\n                               << (boot_completed ? \"in 4 minutes\" : \"before boot completed\");\n                    // Notifies update_verifier and apexd\n                    property_set(\"ro.init.updatable_crashing\", \"1\");\n                }\n            }\n        } else {\n            time_crashed_ = now;\n            crash_count_ = 1;\n        }\n    }\n\n    //  SVC_RESTARTING, init  [2.4.5.2]\n    flags_ &= (~SVC_RESTART);\n    flags_ |= SVC_RESTARTING;\n\n    //  service  onrestart \n    onrestart_.ExecuteAllCommands();\n\n    //  restarting \n    NotifyStateChange(\"restarting\");\n    return;\n}\n```\n\nReap  NotifyStateChange \n\n\n\n###### 2.4.3.1.4.4  NotifyStateChange \n\n `system/core/init/service.cpp`\n\n```c++\nvoid Service::NotifyStateChange(const std::string& new_state) const {\n    if ((flags_ & SVC_TEMPORARY) != 0) {\n        //  SVC_TEMPORARY, \n        return;\n    }\n\n    // \n    std::string prop_name = \"init.svc.\" + name_;\n    property_set(prop_name, new_state);\n\n    ...\n}\n```\n\n key-value  key  init.svc.[service_name]value  adb `getprop | grep init.svc.` service \n\n```\n[init.svc.adbd]: [running]\n[init.svc.alarm-hal-1-0]: [running]\n[init.svc.android.thermal-hal]: [running]\n[init.svc.apexd]: [stopped]\n[init.svc.apexd-bootstrap]: [stopped]\n[init.svc.apexd-snapshotde]: [stopped]\n[init.svc.audioserver]: [running]\n[init.svc.wifidisplayhalservice]: [running]\n[init.svc.wpa_supplicant]: [running]\n[init.svc.zygote]: [running]\n[init.svc.zygote_secondary]: [running]\n```\n\n\n\n### 2.4.4 \n\n<!-- TODO:  CreateParser -->\n\n<!-- TODO: .rc  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: /system/etc/init -->\n\n<!-- TODO: /odm/etc/init -->\n\n<!-- TODO: /vendor/etc/init -->\n\n LoadBootScripts  `system/core/init/init.cpp`\n\n```c++\nstatic void LoadBootScripts(ActionManager& action_manager, ServiceList& service_list) {\n    Parser parser = CreateParser(action_manager, service_list);\n\n    std::string bootscript = GetProperty(\"ro.boot.init_rc\", \"\");\n    if (bootscript.empty()) {\n        //  init.rc  [2.4.4.1]\n        parser.ParseConfig(\"/init.rc\");\n\n        //  /system/etc/init \n        if (!parser.ParseConfig(\"/system/etc/init\")) {\n            late_import_paths.emplace_back(\"/system/etc/init\");\n        }\n\n        //  /product/etc/init \n        if (!parser.ParseConfig(\"/product/etc/init\")) {\n            late_import_paths.emplace_back(\"/product/etc/init\");\n        }\n\n        //  /product_services/etc/init \n        if (!parser.ParseConfig(\"/product_services/etc/init\")) {\n            late_import_paths.emplace_back(\"/product_services/etc/init\");\n        }\n\n        //  /odm/etc/init \n        if (!parser.ParseConfig(\"/odm/etc/init\")) {\n            late_import_paths.emplace_back(\"/odm/etc/init\");\n        }\n\n        //  /vendor/etc/init \n        if (!parser.ParseConfig(\"/vendor/etc/init\")) {\n            late_import_paths.emplace_back(\"/vendor/etc/init\");\n        }\n    } else {\n        parser.ParseConfig(bootscript);\n    }\n}\n```\n\n\n\n- `init.rc`  .rc \n- `/system/etc/init/` SurfaceFlinger, MediaService, logcatd\n- `/vendor/etc/init/`  SoC  SoC \n- `/odm/etc/init/` \n\ninit.rc \n\n\n\n#### 2.4.4.1 init.rc \n\n Android .rc  Android Init Language [ Android Init Language ](https://cs.android.com/android/platform/superproject/+/android-security-10.0.0_r56:system/core/init/README.md)  AOSP  `system/core/init/README.md`\n\n\n\n\n\n##### 2.4.4.1.1 Android Init Language\n\nAndroid Init Language `Actions``Commands``Services``Options``Imports`\n\n\n\n-  token token \n-  token  c  `\\`  token\n-  `\\`\n-  `#` \n-  `${property.name}` `import /init.recovery.${ro.hardware}.rc`\n-  section `Actions`  `Services`  section `Commands`  `Options`  section section  `Commands`  `Options` \n- `Services`  `Services` \n\n\n\n\n\n###### 2.4.4.1.1.1 Actions\n\n`Actions`   `Commands`  `Triggers`  `Actions` \n\n```\non <trigger> [&& <trigger>]*\n   <command>\n   <command>\n   <command>\n```\n\n `Actions`   `Triggers` `Actions` \n\n `Actions`  `Actions`  `Commands`\n\n Zygote \n\n```\non zygote-start && property:ro.crypto.state=unencrypted\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n```\n\n\n\n `Actions`  `Triggers` `zygote-start`  `property:ro.crypto.state=unencrypted` `Command`\n\n `zygote-start`  `property:ro.crypto.state=unencrypted` `Actions`  `Actions`  `Commands`  `Actions`  `Commands`\n\n\n\n###### 2.4.4.1.1.2 Triggers\n\n`Triggers`  `Actions`  `Commands`\n\nTriggers \n\n- **Event triggers**\n\n   `trigger`   `QueueEventTrigger()` \n\n- **Property triggers**\n\n   `property:<key>=<value>`\n\n `Actions` \n\n\n\n`on init && property:a=b``on property:a=b && property:c=d` \n\n`on boot && on init` \n\n\n\n###### 2.4.4.1.1.3 Commands\n\n `Commands`\n\n- **trigger <event>**\n\n  \n\n- **write <path> <content>**\n\n   path \n\n- **chown <owner> <group> <path>**\n\n  \n\n- **mkdir <path> [mode] [owner] [group]**\n\n   \n\n   755 root  root \n\n  \n\n- **start <service>**\n\n  \n\n- **exec_start <service>**\n\n  \n\n- **setprop <name> <value>**\n\n  \n\n- **symlink <target> <path>**\n\n   path  target \n\n\n\n###### 2.4.4.1.1.4 Services\n\n`Services`  init  init  init  `Services`  fork \n\n`Services` \n\n`Services` \n\n```\nservice <name> <pathname> [ <argument> ]*\n   <option>\n   <option>\n   ...\n```\n\n Zygote 64 \n\n```\nservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server\n    class main\n    priority -20\n    user root\n    group root readproc reserved_disk\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n    onrestart write /sys/android_power/request_state wake\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n    writepid /dev/cpuset/foreground/tasks\n```\n\n`zygote`  `Services` `/system/bin/app_process64` `-Xzygote /system/bin --zygote --start-system-server`  `Options`\n\n\n\n###### 2.4.4.1.1.5 Options\n\n`Options`  `Services`  init  `Services` \n\n  `Options`\n\n- **class <name> [ <name>\\* ]**\n\n   `Services`  `Services`  () `Services`  ()  default\n\n- **class_start <serviceclass>**\n\n   `serviceclass`  `Services`\n\n- **priority <priority>**\n\n   `Services`  -20 ~ 19 0\n\n- **user <username>**\n\n   `Services`  root\n\n- **group <groupname> [ <groupname>\\* ]**\n\n   `Services`  root\n\n- **socket <name> <type> <perm> [ <user> [ <group> [ <seclabel> ] ] ]**\n\n   unix  socket `/dev/socket/<name>` socket \n\n- **onrestart**\n\n   `Services`  `Commands`\n\n- **oneshot**\n\n   `Services` \n\n- **writepid <file> [ <file>\\* ]**\n\n   fork  pid \n\n\n\n##### 2.4.4.1.2  init.rc \n\n init.rc  `system/core/rootdir/init.rc`\n\n  `Actions`  `Services`  init.rc  `Actions` [2.4.4.1.1.2]  `QueueEventTrigger()`   `Actions`   `Triggers` `Actions` \n\n\n\n###### 2.4.4.1.2.1 \n\n init  `system/core/init/init.cpp`  SecondStageMain \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n\n    ...\n\n    ActionManager& am = ActionManager::GetInstance();\n\n    ...\n\n    //  early-init  ActionManager\n    am.QueueEventTrigger(\"early-init\");\n\n    ...\n\n    // Trigger all the boot actions to get us started.\n    //  init  ActionManager\n    am.QueueEventTrigger(\"init\");\n\n    ...\n\n    // Don't mount filesystems or start core system services in charger mode.\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        // ,  charger  ActionManager\n        // , \n        am.QueueEventTrigger(\"charger\");\n    } else {\n        // ,  late-init  ActionManager\n        am.QueueEventTrigger(\"late-init\");\n    }\n\n    ...\n\n    return 0;\n}\n```\n\nActionManager  [2.4.5.x]\n\n- early-init -> init -> late-init\n- early-init -> init -> charger\n\n\n\n\n\n###### 2.4.4.1.2.2 init.rc \n\n<!-- TODO: trigger boot -->\n\n\n\n```\non early-init\n    ...\n\n    #  start  ueventd\n    start ueventd\n\n    #  exec_start  apexd-bootstrap, ,  APEX \n    exec_start apexd-bootstrap\n\non init\n    ...\n\n    #  start \n    #  servicemanager [2.4.4.1.2.3]\n    start servicemanager\n    start hwservicemanager\n    start vndservicemanager\n\n# \n#  trigger  [2.4.4.1.1.2]\non late-init\n    trigger early-fs\n    trigger fs\n    trigger post-fs\n    trigger late-fs\n    trigger post-fs-data\n    trigger load_persist_props_action\n\n    #  zygote-start,  zygote [2.4.4.1.2.4]\n    trigger zygote-start\n\n    trigger firmware_mounts_complete\n    trigger early-boot\n    trigger boot\n```\n\n servicemanager  zygote \n\n\n\n###### 2.4.4.1.2.3  servicemanager\n\nservicemanager  `frameworks/native/cmds/servicemanager/servicemanager.rc`\n\n```\n# servicemanager  Services \n# /system/bin/servicemanager \nservice servicemanager /system/bin/servicemanager\n    #  core  animation\n    #  core  animation  () , servicemanager  ()\n    class core animation\n\n    #  system\n    user system\n\n    #  system  readproc\n    group system readproc\n\n    # \n    # ,  bootloader\n    critical\n\n    # \n    #  Commands\n    onrestart restart healthd\n    onrestart restart zygote\n    onrestart restart audioserver\n    onrestart restart media\n    onrestart restart surfaceflinger\n    onrestart restart inputflinger\n    onrestart restart drm\n    onrestart restart cameraserver\n    onrestart restart keystore\n    onrestart restart gatekeeperd\n    onrestart restart thermalservice\n\n    #  fork  pid  /dev/cpuset/system-background/tasks\n    writepid /dev/cpuset/system-background/tasks\n\n    # \n    # shutdown critical , \n    shutdown critical\n```\n\n servicemanager  `frameworks/native/cmds/servicemanager/service_manager.c`  main \n\n\n\n###### 2.4.4.1.2.4  zygote\n\n init.rc  `zygote-start`  3  `Actions`\n\n```\non zygote-start && property:ro.crypto.state=unencrypted\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n\non zygote-start && property:ro.crypto.state=unsupported\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n\non zygote-start && property:ro.crypto.state=encrypted && property:ro.crypto.type=file\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n```\n\nzygote \n\n```\nimport /init.${ro.zygote}.rc\n```\n\n `ro.zygote`\n\n```\nsystem/core/rootdir/init.zygote32.rc\nsystem/core/rootdir/init.zygote32_64.rc\nsystem/core/rootdir/init.zygote64.rc\nsystem/core/rootdir/init.zygote64_32.rc\n```\n\nzygote  `zygote-start`  `Actions`  zygote\n\n Zygote 64  `system/core/rootdir/init.zygote64.rc`\n\n```\n# zygote  Services \n# /system/bin/app_process64 \n# -Xzygote /system/bin --zygote --start-system-server \nservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server\n    #  main\n    #  main  () , zygote  ()\n    class main\n\n    #  -20\n    #  -20 ~ 19, , ,  zygote \n    priority -20\n\n    #  root\n    user root\n    group root readproc reserved_disk\n\n    #  socket\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n\n    # \n    #  Commands\n    onrestart write /sys/android_power/request_state wake\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n\n    #  zygote  fork  pid  /dev/cpuset/foreground/tasks\n    writepid /dev/cpuset/foreground/tasks\n```\n\n zygote  `frameworks/base/cmds/app_process/app_main.cpp`  main \n\n\n\n### 2.4.5 \n\ninit  `system/core/init/init.cpp`\n\n```c++\nint SecondStageMain(int argc, char** argv) {\n\n    ...\n\n    while (true) {\n        //  epoll \n        // , ,  epoll_timeout  -1\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{};\n\n        ...\n\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            // am ,  ActionManager \n            //  ActionManager  [2.4.5.1]\n            am.ExecuteOneCommand();\n        }\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            if (!shutting_down) {\n                //  HandleProcessActions  [2.4.5.2]\n                auto next_process_action_time = HandleProcessActions();\n\n                if (next_process_action_time) {\n                    //  next_process_action_time \n                    epoll_timeout = std::chrono::ceil<std::chrono::milliseconds>(\n                            *next_process_action_time - boot_clock::now());\n\n                    //  0, \n                    //  epoll  0,  Wait , \n                    if (*epoll_timeout < 0ms) epoll_timeout = 0ms;\n                }\n            }\n\n            //  ActionManager ,  init , \n            //  epoll  0,  Wait , \n            if (am.HasMoreCommands()) epoll_timeout = 0ms;\n        }\n\n        //  Wait ,  [2.4.1.3]\n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\ninit  3 \n\n-  ActionManager \n- \n-  epoll  init  init  `SIGCHLD` \n\n\n\n#### 2.4.5.1 ActionManager\n\n<!-- TODO:  Action? -->\n\n<!-- TODO: Action  Actions  -->\n\n<!-- TODO:  -->\n\nActionManager  Action  Action \n\n\n\n##### 2.4.5.1.1  Action\n\n<!-- TODO:  Action  -->\n\n init  Action Action \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    // am ,  ActionManager \n    ActionManager& am = ActionManager::GetInstance();\n\n    ...\n\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n\n    //  Action:  early-init [2.4.4.1.2.1]\n    am.QueueEventTrigger(\"early-init\");\n\n    //  Action:  coldboot \n    am.QueueBuiltinAction(wait_for_coldboot_done_action, \"wait_for_coldboot_done\");\n\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n    am.QueueBuiltinAction(SetMmapRndBitsAction, \"SetMmapRndBits\");\n    am.QueueBuiltinAction(SetKptrRestrictAction, \"SetKptrRestrict\");\n    Keychords keychords;\n    am.QueueBuiltinAction(\n        [&epoll, &keychords](const BuiltinArguments& args) -> Result<Success> {\n            for (const auto& svc : ServiceList::GetInstance()) {\n                keychords.Register(svc->keycodes());\n            }\n            keychords.Start(&epoll, HandleKeychord);\n            return Success();\n        },\n        \"KeychordInit\");\n    am.QueueBuiltinAction(console_init_action, \"console_init\");\n\n    //  Action:  init [2.4.4.1.2.1]\n    am.QueueEventTrigger(\"init\");\n\n    am.QueueBuiltinAction(StartBoringSslSelfTest, \"StartBoringSslSelfTest\");\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n\n    //  Action:  init  binder\n    am.QueueBuiltinAction(InitBinder, \"InitBinder\");\n\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        // ,  Action:  charger [2.4.4.1.2.1]\n        am.QueueEventTrigger(\"charger\");\n    } else {\n        // ,  Action:  late-init [2.4.4.1.2.1]\n        am.QueueEventTrigger(\"late-init\");\n    }\n\n    //  Action: \n    am.QueueBuiltinAction(queue_property_triggers_action, \"queue_property_triggers\");\n\n    ...\n\n}\n```\n\n ActionManager  Action\n\n\n\n#### 2.4.5.2 HandleProcessActions\n\n<!-- ((s->flags() & SVC_RUNNING) && s->timeout_period()) -->\n\n<!--  service  -->\n\n```c++\nstatic std::optional<boot_clock::time_point> HandleProcessActions() {\n    std::optional<boot_clock::time_point> next_process_action_time;\n\n    //  ServiceList\n    for (const auto& s : ServiceList::GetInstance()) {\n        // , \n        if ((s->flags() & SVC_RUNNING) && s->timeout_period()) {\n            // \n            auto timeout_time = s->time_started() + *s->timeout_period();\n\n            if (boot_clock::now() > timeout_time) {\n                // , \n                s->Timeout();\n            } else {\n                //  next_process_action_time\n                // , next_process_action_time , \n                if (!next_process_action_time || timeout_time < *next_process_action_time) {\n                    next_process_action_time = timeout_time;\n                }\n            }\n        }\n\n        //  SVC_RESTARTING, ,  for \n        if (!(s->flags() & SVC_RESTARTING)) continue;\n\n        // \n        auto restart_time = s->time_started() + s->restart_period();\n\n        // , \n        if (boot_clock::now() > restart_time) {\n            // , \n            if (auto result = s->Start(); !result) {\n                LOG(ERROR) << \"Could not restart process '\" << s->name() << \"': \" << result.error();\n            }\n        } else {\n            //  next_process_action_time\n            // , next_process_action_time , \n            if (!next_process_action_time || restart_time < *next_process_action_time) {\n                next_process_action_time = restart_time;\n            }\n        }\n    }\n    return next_process_action_time;\n}\n```\n\n\n\n1.  `SVC_RUNNING`  `Timeout` \n2.  `SVC_RESTARTING`  \n\n`next_process_action_time` \n\n [2.4.3.1.4.3]  init  `SVC_RESTARTING` init  `SVC_RESTARTING` \n\n\n\n# \n\n[Android-](http://gityuan.com/2016/02/01/android-booting/)\n\n[Android-Init](http://gityuan.com/2016/02/05/android-init/)\n\n[epoll(7)](https://man7.org/linux/man-pages/man7/epoll.7.html)\n\n[Signal](https://en.wikipedia.org/wiki/Signal_(IPC))\n\n[signal(7)](https://man7.org/linux/man-pages/man7/signal.7.html)\n\n[wait(2)](https://man7.org/linux/man-pages/man2/wait.2.html)\n\n[signalfd(2)](https://man7.org/linux/man-pages/man2/signalfd.2.html)\n\n","source":"_posts/2021-07-10-exploring-init-process-startup-process.md","raw":"---\ntitle:  init \ndate: 2021-07-10 16:28:09\ncategories:\n- [Android]\n---\n\n\n\n> android-security-10.0.0_r56\n\n\n\n# 1. \n\n<!-- TODO:  init  -->\n\nAndroid  Linux  init \n\ninit  pid = 1\n\n<!-- more -->\n\n\n\n# 2. \n\n<!-- TODO:  -->\n\n\n\n## 2.1 init \n\n<!-- TODO:  -->\n\n<!-- TODO: init ,  /system/core/init -->\n\n Android 9init  `system/core/init/init.cpp`  main \n\n Android 10 init  `system/core/init/main.cpp`  main \n\n```c++\nint main(int argc, char** argv) {\n    ...\n\n    if (!strcmp(basename(argv[0]), \"ueventd\")) {\n        return ueventd_main(argc, argv);\n    }\n\n    if (argc > 1) {\n        if (!strcmp(argv[1], \"subcontext\")) {\n            android::base::InitLogging(argv, &android::base::KernelLogger);\n            const BuiltinFunctionMap& function_map = GetBuiltinFunctionMap();\n\n            return SubcontextMain(argc, argv, &function_map);\n        }\n\n        if (!strcmp(argv[1], \"selinux_setup\")) {\n            return SetupSelinux(argv);\n        }\n\n        if (!strcmp(argv[1], \"second_stage\")) {\n            return SecondStageMain(argc, argv);\n        }\n    }\n\n    return FirstStageMain(argc, argv);\n}\n```\n\n`basename`  `strcmp` \n\n- `basename`  `char* basename(char* __path)` \"/system/bin/ueventd\" \"ueventd\"\n- `strcmp`  `int strcmp(const char* __lhs, const char* __rhs)` 0\n\n main  `argc`  `argv` `FirstStageMain` \n\n\n\n## 2.2 \n\n<!-- TODO: mkdir, mknod, tmpfs -->\n\n<!-- TODO:  -->\n\n<!-- TODO: KernelLogging(/dev/kmsg) -->\n\n<!-- TODO: InstallRebootSignalHandlers -->\n\n `int FirstStageMain(int argc, char** argv)`  `system/core/init/first_stage_init.cpp`\n\n```c++\nint FirstStageMain(int argc, char** argv) {\n    ...\n\n    CHECKCALL(clearenv());\n    CHECKCALL(setenv(\"PATH\", _PATH_DEFPATH, 1));\n    // Get the basic filesystem setup we need put together in the initramdisk\n    // on / and then we'll let the rc file figure out the rest.\n    CHECKCALL(mount(\"tmpfs\", \"/dev\", \"tmpfs\", MS_NOSUID, \"mode=0755\"));\n    CHECKCALL(mkdir(\"/dev/pts\", 0755));\n    CHECKCALL(mkdir(\"/dev/socket\", 0755));\n    CHECKCALL(mkdir(\"/dev/dm-user\", 0755));\n    CHECKCALL(mount(\"devpts\", \"/dev/pts\", \"devpts\", 0, NULL));\n#define MAKE_STR(x) __STRING(x)\n    CHECKCALL(mount(\"proc\", \"/proc\", \"proc\", 0, \"hidepid=2,gid=\" MAKE_STR(AID_READPROC)));\n#undef MAKE_STR\n\n    // Don't expose the raw commandline to unprivileged processes.\n    //  [2.2.1]\n    CHECKCALL(chmod(\"/proc/cmdline\", 0440));\n    std::string cmdline;\n    android::base::ReadFileToString(\"/proc/cmdline\", &cmdline);\n    // Don't expose the raw bootconfig to unprivileged processes.\n    chmod(\"/proc/bootconfig\", 0440);\n    std::string bootconfig;\n    android::base::ReadFileToString(\"/proc/bootconfig\", &bootconfig);\n    gid_t groups[] = {AID_READPROC};\n    CHECKCALL(setgroups(arraysize(groups), groups));\n    CHECKCALL(mount(\"sysfs\", \"/sys\", \"sysfs\", 0, NULL));\n    CHECKCALL(mount(\"selinuxfs\", \"/sys/fs/selinux\", \"selinuxfs\", 0, NULL));\n\n    CHECKCALL(mknod(\"/dev/kmsg\", S_IFCHR | 0600, makedev(1, 11)));\n\n    if constexpr (WORLD_WRITABLE_KMSG) {\n        CHECKCALL(mknod(\"/dev/kmsg_debug\", S_IFCHR | 0622, makedev(1, 11)));\n    }\n\n    CHECKCALL(mknod(\"/dev/random\", S_IFCHR | 0666, makedev(1, 8)));\n    CHECKCALL(mknod(\"/dev/urandom\", S_IFCHR | 0666, makedev(1, 9)));\n\n    // This is needed for log wrapper, which gets called before ueventd runs.\n    CHECKCALL(mknod(\"/dev/ptmx\", S_IFCHR | 0666, makedev(5, 2)));\n    CHECKCALL(mknod(\"/dev/null\", S_IFCHR | 0666, makedev(1, 3)));\n\n    // These below mounts are done in first stage init so that first stage mount can mount\n    // subdirectories of /mnt/{vendor,product}/.  Other mounts, not required by first stage mount,\n    // should be done in rc files.\n    // Mount staging areas for devices managed by vold\n    // See storage config details at http://source.android.com/devices/storage/\n    CHECKCALL(mount(\"tmpfs\", \"/mnt\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=1000\"));\n    // /mnt/vendor is used to mount vendor-specific partitions that can not be\n    // part of the vendor partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/vendor\", 0755));\n    // /mnt/product is used to mount product-specific partitions that can not be\n    // part of the product partition, e.g. because they are mounted read-write.\n    CHECKCALL(mkdir(\"/mnt/product\", 0755));\n\n    // /debug_ramdisk is used to preserve additional files from the debug ramdisk\n    CHECKCALL(mount(\"tmpfs\", \"/debug_ramdisk\", \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"));\n\n    // /second_stage_resources is used to preserve files from first to second\n    // stage init\n    CHECKCALL(mount(\"tmpfs\", kSecondStageRes, \"tmpfs\", MS_NOEXEC | MS_NOSUID | MS_NODEV,\n                    \"mode=0755,uid=0,gid=0\"))\n#undef CHECKCALL\n\n    SetStdioToDevNull(argv);\n    // Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually\n    // talk to the outside world...\n    InitKernelLogging(argv);\n\n    if (!errors.empty()) {\n        for (const auto& [error_string, error_errno] : errors) {\n            LOG(ERROR) << error_string << \" \" << strerror(error_errno);\n        }\n        LOG(FATAL) << \"Init encountered errors starting first stage, aborting\";\n    }\n\n    LOG(INFO) << \"init first stage started!\";\n\n    ...\n\n    //  /system/bin/init\n    //  selinux_setup,  SetupSelinux  SELinux  [2.3]\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"selinux_setup\", nullptr};\n    auto fd = open(\"/dev/kmsg\", O_WRONLY | O_CLOEXEC);\n    dup2(fd, STDOUT_FILENO);\n    dup2(fd, STDERR_FILENO);\n    close(fd);\n    execv(path, const_cast<char**>(args));\n\n    // execv() only returns if an error happened, in which case we\n    // panic and never fall through this conditional.\n    PLOG(FATAL) << \"execv(\\\"\" << path << \"\\\") failed\";\n\n    return 1;\n}\n```\n\n `/system/bin/init` main  `\"selinux_setup\"` SetupSelinux  SELinux \n\n\n\n### 2.2.1 \n\n Linux `chmod` \n\n\n\n\n\n#### 2.2.1.1 \n\n 10 \n\n```\n-rwxrwxrwx\n```\n\n\n\n- `-`\n- `d`\n- `c`\n\n 9  3 \n\n3  1  2  3 \n\n-  1  `r` `-`\n-  2  `w` `-`\n-  3  `x` `-`\n\n`-rwxrw-r--` \n\n\n\n#### 2.2.1.2 \n\n 4  1  3 \n\n 3  3 \n\n|                    |  |\n| :--------------------: | :--: |\n| 1004 |  r   |\n| 0102 |  w   |\n| 0011 |  x   |\n| 0000 |  -   |\n\n 0~7\n\n|                    |  |\n| :--------------------: | :--: |\n| 1117 | rwx  |\n| 1106 | rw-  |\n| 1015 | r-x  |\n| 0000 | ---  |\n\n\n\n|  |  |                                                          |\n| :--------: | :--------: | :----------------------------------------------------------: |\n| -rwxrwxrwx |    0777    |  |\n| -rwxrw-r-- |    0764    |  |\n\n\n\n#### 2.2.1.3 \n\n```c++\n// Don't expose the raw commandline to unprivileged processes.\nCHECKCALL(chmod(\"/proc/cmdline\", 0440));\n\n// Don't expose the raw bootconfig to unprivileged processes.\nchmod(\"/proc/bootconfig\", 0440);\n```\n\n `chmod`  `/proc/cmdline``/proc/bootconfig`  `0440` root  () \n\n\n\n## 2.3  SELinux\n\n<!-- TODO:  SELinux -->\n\n `int SetupSelinux(char** argv)`  SELinux  `system/core/init/selinux.cpp`\n\n```c++\n// This function initializes SELinux then execs init to run in the init SELinux context.\nint SetupSelinux(char** argv) {\n    ...\n\n    // Set up SELinux, loading the SELinux policy.\n    //  SELinux\n    SelinuxSetupKernelLogging();\n    SelinuxInitialize();\n\n    ...\n\n    //  /system/bin/init\n    //  second_stage,  SecondStageMain  [2.4]\n    const char* path = \"/system/bin/init\";\n    const char* args[] = {path, \"second_stage\", nullptr};\n    execv(path, const_cast<char**>(args));\n\n    ...\n\n    return 1;\n}\n```\n\n SELinux `/system/bin/init` main  `\"second_stage\"` SecondStageMain \n\n\n\n## 2.4 \n\n<!-- TODO: property_load_boot_defaults -->\n\n<!-- TODO: , android  build.prop  -->\n\n<!-- TODO: SELinux  -->\n\n<!-- TODO: keyctl_get_keyring_ID(KEY_SPEC_SESSION_KEYRING, 1) -->\n\n<!-- TODO: InitializeSubcontext() -->\n\n<!-- TODO: ActionManager  ServiceList  -->\n\n `int SecondStageMain(int argc, char** argv)`  `system/core/init/init.cpp`\n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    // Set init and its forked children's oom_adj.\n    //  init  fork  oom_score_adj \n    // , \n    if (auto result = WriteFile(\"/proc/1/oom_score_adj\", \"-1000\"); !result) {\n        LOG(ERROR) << \"Unable to write -1000 to /proc/1/oom_score_adj: \" << result.error();\n    }\n\n    ...\n\n    //  [2.4.2.1]\n    property_init();\n\n    ...\n\n    //  epoll [2.4.1.1]\n    Epoll epoll;\n    if (auto result = epoll.Open(); !result) {\n        PLOG(FATAL) << result.error();\n    }\n\n    //  epoll  init  [2.4.3.1.3]\n    // \n    InstallSignalFdHandler(&epoll);\n\n    ...\n\n    //  [2.4.2.2]\n    StartPropertyService(&epoll);\n\n    ...\n\n    ActionManager& am = ActionManager::GetInstance();\n    ServiceList& sm = ServiceList::GetInstance();\n\n    //  [2.4.4]\n    LoadBootScripts(am, sm);\n\n    ...\n\n    //  Action [2.4.5.1]\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n    am.QueueEventTrigger(\"early-init\");\n    am.QueueBuiltinAction(wait_for_coldboot_done_action, \"wait_for_coldboot_done\");\n    ...\n    am.QueueBuiltinAction(queue_property_triggers_action, \"queue_property_triggers\");\n\n    //  [2.4.5]\n    while (true) {\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{};\n\n        if (do_shutdown && !shutting_down) {\n            do_shutdown = false;\n            if (HandlePowerctlMessage(shutdown_command)) {\n                shutting_down = true;\n            }\n        }\n\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            am.ExecuteOneCommand();\n        }\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            if (!shutting_down) {\n                auto next_process_action_time = HandleProcessActions();\n\n                if (next_process_action_time) {\n                    epoll_timeout = std::chrono::ceil<std::chrono::milliseconds>(\n                            *next_process_action_time - boot_clock::now());\n                    if (*epoll_timeout < 0ms) epoll_timeout = 0ms;\n                }\n            }\n\n            if (am.HasMoreCommands()) epoll_timeout = 0ms;\n        }\n\n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\n 5 \n\n- epoll\n\n- \n\n- \n\n- \n\n- \n\n 5 \n\n\n\n### 2.4.1 epoll\n\nepoll  Linux  I/O epoll \n\n\n\n#### 2.4.1.1 \n\n init epoll \n\n```c++\nEpoll epoll;\nif (auto result = epoll.Open(); !result) {\n    PLOG(FATAL) << result.error();\n}\n```\n\nepoll  Open  `system/core/init/epoll.cpp`\n\n```c++\nResult<Success> Epoll::Open() {\n    if (epoll_fd_ >= 0) return Success();\n\n    // \n    epoll_fd_.reset(epoll_create1(EPOLL_CLOEXEC));\n\n    if (epoll_fd_ == -1) {\n        return ErrnoError() << \"epoll_create1 failed\";\n    }\n    return Success();\n}\n```\n\n `epoll_create1``epoll_create1`  epoll \n\n\n\n#### 2.4.1.2  epoll \n\n epoll  RegisterHandler  epoll\n\n `system/core/init/epoll.cpp` epoll_ctl\n\n```c++\nResult<Success> Epoll::RegisterHandler(int fd, std::function<void()> handler, uint32_t events) {\n    ...\n\n    // \n    if (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &ev) == -1) {\n\n        ...\n\n        return result;\n    }\n    return Success();\n}\n```\n\n epoll_ctl \n\n\n\n##### 2.4.1.2.1  epoll_ctl\n\n**epoll_ctl**  `int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)` fd \n\n\n\n###### 2.4.1.2.1.1 \n\n epoll_ctl \n\n- **epfd**  epoll \n\n- **op** \n\n  - **EPOLL_CTL_ADD**\n\n     epoll \n\n  - **EPOLL_CTL_MOD**\n\n     epoll \n\n  - **EPOLL_CTL_DEL**\n\n     epoll \n\n- **fd** \n\n- **event**  epoll_event  epoll_event \n\n  ```c++\n  struct epoll_event {\n     uint32_t     events;      /* Epoll events */\n     epoll_data_t data;        /* User data variable */\n  };\n  ```\n\n   `events` \n\n  - \u0015\u0015**EPOLLIN**\n    \n\n  - **EPOLLOUT**\n    \n\n  - **EPOLLPRI**\n    \n\n  - **EPOLLERR**\n    \n\n  - **EPOLLHUP**\n    \n\n  - **EPOLLONESHOT**\n    epoll \n     epoll_ctl EPOLL_CTL_MOD \n\n   `data`  [2.4.1.3]`epoll_data_t` \n\n  ```c++\n  typedef union epoll_data {\n     void        *ptr;\n     int          fd;\n     uint32_t     u32;\n     uint64_t     u64;\n  } epoll_data_t;\n  ```\n\n\n\n###### 2.4.1.2.1.2 \n\n epoll_ctl \n\n-  0\n\n-  -1\n\n\n\n##### 2.4.1.2.2  RegisterHandler \n\n epoll_ctl  RegisterHandler  `system/core/init/epoll.h`\n\n```c++\nclass Epoll {\n  public:\n    Result<Success> RegisterHandler(int fd, std::function<void()> handler,\n                                    uint32_t events = EPOLLIN);\n};\n```\n\n `events`  `EPOLLIN`\n\n RegisterHandler \n\n```c++\nResult<Success> Epoll::RegisterHandler(int fd, std::function<void()> handler, uint32_t events) {\n    ...\n\n    // handler \n    auto [it, inserted] = epoll_handlers_.emplace(fd, std::move(handler));\n\n    ...\n\n    epoll_event ev;\n\n    // \n    //  events  EPOLLIN, \n    ev.events = events;\n  \n    // ,  [2.4.1.3.2]\n    ev.data.ptr = reinterpret_cast<void*>(&it->second);\n\n    //  epoll_ctl \n    //  EPOLL_CTL_ADD, \n    if (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &ev) == -1) {\n        Result<Success> result = ErrnoError() << \"epoll_ctl failed to add fd\";\n        epoll_handlers_.erase(fd);\n        return result;\n    }\n    return Success();\n}\n```\n\n `events`  `handler` `epoll_ctl`  epoll \n\n\n\n#### 2.4.1.3 \n\n epoll  epoll \n\n init \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    while (true) {\n        ...\n\n        // \n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\n Wait \n\n\n\n##### 2.4.1.3.1  epoll_wait\n\n Wait  epoll_wait Wait \n\n**epoll_wait**  `int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout)` epoll \n\n epoll_wait \n\n- \n- \n- \n\n\n\n###### 2.4.1.3.1.1 \n\n epoll_wait \n\n- **epfd**  epoll \n\n- **events**  epoll_event  epoll_event  [2.4.1.2.1] \n\n   events  epoll_event  data  epoll_ctl  data  epoll_ctl  event.data  epoll_wait \n\n- **maxevents**  events  maxevents\n\n- **timeout**  timeout = -1  timeout = 0 \n\n\n\n###### 2.4.1.3.1.2 \n\n epoll_wait \n\n-  I/O \n\n   0\n\n-  -1\n\n\n\n##### 2.4.1.3.2  Wait \n\n epoll_wait  Wait  `system/core/init/epoll.cpp`\n\n```c++\nResult<Success> Epoll::Wait(std::optional<std::chrono::milliseconds> timeout) {\n    //  -1\n    int timeout_ms = -1;\n\n    if (timeout && timeout->count() < INT_MAX) {\n        //  timeout  0 , \n        timeout_ms = timeout->count();\n    }\n\n    epoll_event ev;\n\n    //  epoll_wait \n    //  1,  1 \n    auto nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd_, &ev, 1, timeout_ms));\n\n    if (nr == -1) {\n        //  -1, \n        return ErrnoError() << \"epoll_wait failed\";\n    } else if (nr == 1) {\n        //  1, ,  1 \n        // ev.data.ptr  epoll_ctl , \n        std::invoke(*reinterpret_cast<std::function<void()>*>(ev.data.ptr));\n    }\n    return Success();\n}\n```\n\n `epoll_wait`  `epoll_wait`  epoll_ctl \n\n\n\n### 2.4.2 \n\n Android  key-value \n\n adb `getprop`\n\n```\n[ro.product.brand]: [Redmi]\n[ro.product.manufacturer]: [Xiaomi]\n[ro.product.marketname]: [Redmi K30S Ultra]\n[ro.product.model]: [M2007J3SC]\n[ro.product.name]: [apollo]\n\n[ro.product.cpu.abi]: [arm64-v8a]\n[ro.product.cpu.abilist]: [arm64-v8a,armeabi-v7a,armeabi]\n[ro.product.cpu.abilist32]: [armeabi-v7a,armeabi]\n[ro.product.cpu.abilist64]: [arm64-v8a]\n\n[dalvik.vm.heapsize]: [512m]\n[dalvik.vm.heapstartsize]: [8m]\n```\n\nCPU \n\n Java  `SystemProperties.get(String, String)`  ActivityManager \n\n```java\nstatic public int staticGetLargeMemoryClass() {\n    //  dalvik.vm.heapsize, \n    String vmHeapSize = SystemProperties.get(\"dalvik.vm.heapsize\", \"16m\");\n\n    return Integer.parseInt(vmHeapSize.substring(0, vmHeapSize.length() - 1));\n}\n```\n\n `SystemProperties.set(String, String)`  ActivityManagerService \n\n```java\nfinal void finishBooting() {\n    ...\n\n    synchronized (this) {\n\n        ...\n\n        // Tell anyone interested that we are done booting!\n        //  sys.boot_completed = 1, \n        SystemProperties.set(\"sys.boot_completed\", \"1\");\n\n        ...\n    }\n\n    ...\n}\n```\n\n\n\n#### 2.4.2.1 \n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: CreateSerializedPropertyInfo() -->\n\n<!-- TODO: property_info_area.LoadDefaultPath() -->\n\n property_init  `system/core/init/property_service.cpp`\n\n```c++\nvoid property_init() {\n    mkdir(\"/dev/__properties__\", S_IRWXU | S_IXGRP | S_IXOTH);\n    CreateSerializedPropertyInfo();\n\n    // \n    if (__system_property_area_init()) {\n        LOG(FATAL) << \"Failed to initialize property area\";\n    }\n\n    if (!property_info_area.LoadDefaultPath()) {\n        LOG(FATAL) << \"Failed to load serialized property info file\";\n    }\n}\n```\n\n `__system_property_area_init` \n\n\n\n#### 2.4.2.2 \n\n<!-- TODO: socket  -->\n\n<!-- TODO: listen(property_set_fd, 8) -->\n\n<!-- TODO:  init  -->\n\n StartPropertyService  `system/core/init/property_service.cpp`\n\n```c++\nvoid StartPropertyService(Epoll* epoll) {\n\n    ...\n\n    //  socket ,  PROP_SERVICE_NAME = \"property_service\"\n    property_set_fd = CreateSocket(PROP_SERVICE_NAME, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK,\n                                   false, 0666, 0, 0, nullptr);\n    if (property_set_fd == -1) {\n        PLOG(FATAL) << \"start_property_service socket creation failed\";\n    }\n\n    listen(property_set_fd, 8);\n\n    //  socket  epoll,  [2.4.1.2]\n    // handle_property_set_fd  [2.4.2.3]\n    if (auto result = epoll->RegisterHandler(property_set_fd, handle_property_set_fd); !result) {\n        PLOG(FATAL) << result.error();\n    }\n}\n```\n\n property_service  socket socket  epoll\n\n `handle_property_set_fd`\n\n\n\n#### 2.4.2.3  handle_property_set_fd\n\n<!-- TODO: ucred cr; socklen_t cr_size = sizeof(cr); -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  init ,  -->\n\n<!-- TODO:  -->\n\n `system/core/init/property_service.cpp`\n\n```c++\nstatic void handle_property_set_fd() {\n    // 2000ms\n    static constexpr uint32_t kDefaultSocketTimeout = 2000; /* ms */\n\n    ...\n\n    SocketConnection socket(s, cr);\n\n    //  2000ms \n    uint32_t timeout_ms = kDefaultSocketTimeout;\n\n    uint32_t cmd = 0;\n    if (!socket.RecvUint32(&cmd, &timeout_ms)) {\n        PLOG(ERROR) << \"sys_prop: error while reading command from the socket\";\n        socket.SendUint32(PROP_ERROR_READ_CMD);\n        return;\n    }\n\n    switch (cmd) {\n    //  PROP_MSG_SETPROP \n    case PROP_MSG_SETPROP: {\n        // PROP_NAME_MAX = 32\n        char prop_name[PROP_NAME_MAX];\n        char prop_value[PROP_VALUE_MAX];\n\n        // ,  prop_name  prop_value \n        if (!socket.RecvChars(prop_name, PROP_NAME_MAX, &timeout_ms) ||\n            !socket.RecvChars(prop_value, PROP_VALUE_MAX, &timeout_ms)) {\n          PLOG(ERROR) << \"sys_prop(PROP_MSG_SETPROP): error while reading name/value from the socket\";\n          return;\n        }\n\n        //  0\n        prop_name[PROP_NAME_MAX-1] = 0;\n        prop_value[PROP_VALUE_MAX-1] = 0;\n\n        const auto& cr = socket.cred();\n        std::string error;\n\n        // \n        uint32_t result =\n            HandlePropertySet(prop_name, prop_value, socket.source_context(), cr, &error);\n\n        if (result != PROP_SUCCESS) {\n            LOG(ERROR) << \"Unable to set property '\" << prop_name << \"' to '\" << prop_value\n                       << \"' from uid:\" << cr.uid << \" gid:\" << cr.gid << \" pid:\" << cr.pid << \": \"\n                       << error;\n        }\n\n        break;\n      }\n\n    //  PROP_MSG_SETPROP2 \n    case PROP_MSG_SETPROP2: {\n        std::string name;\n        std::string value;\n\n        // \n        if (!socket.RecvString(&name, &timeout_ms) ||\n            !socket.RecvString(&value, &timeout_ms)) {\n          PLOG(ERROR) << \"sys_prop(PROP_MSG_SETPROP2): error while reading name/value from the socket\";\n          socket.SendUint32(PROP_ERROR_READ_DATA);\n          return;\n        }\n\n        const auto& cr = socket.cred();\n        std::string error;\n\n        // \n        uint32_t result = HandlePropertySet(name, value, socket.source_context(), cr, &error);\n\n        if (result != PROP_SUCCESS) {\n            LOG(ERROR) << \"Unable to set property '\" << name << \"' to '\" << value\n                       << \"' from uid:\" << cr.uid << \" gid:\" << cr.gid << \" pid:\" << cr.pid << \": \"\n                       << error;\n        }\n        socket.SendUint32(result);\n        break;\n      }\n\n    default:\n        LOG(ERROR) << \"sys_prop: invalid command \" << cmd;\n        socket.SendUint32(PROP_ERROR_INVALID_CMD);\n        break;\n    }\n}\n```\n\n socket  `cmd` \n\n-  `PROP_MSG_SETPROP`  `PROP_NAME_MAX`  0 `PROP_NAME_MAX - 1` \n-  `PROP_MSG_SETPROP2`  `std::string` \n\n `PROP_MSG_SETPROP`  `PROP_MSG_SETPROP2`  `HandlePropertySet` \n\n\n\n### 2.4.3 \n\n** (Signals)**  IPC \n\n****\n\n\n\n#### 2.4.3.1 \n\n Linux (PID) waitwaitpid  waitid ** (Zombie process)**\n\n init init \n\n [2.4.4] init  fork servicemanager zygote  Android init \n\ninit \n\n Android Linux \n\n\n\n##### 2.4.3.1.1 \n\n<!-- :  -->\n\n\n\n- ****\n- ****\n- ****\n\ninit \n\n\n\n\n\n##### 2.4.3.1.2  sigaction\n\n init  sigaction\n\n**sigaction**  `int sigaction(int signum, const struct sigaction *restrict act, struct sigaction *restrict oldact)`\n\n\n\n###### 2.4.3.1.2.1 \n\n sigaction \n\n- **signum** \n\n   AndroidARM  `bionic/libc/kernel/uapi/asm-arm/asm/signal.h` \n\n- **act**  sigaction  sigaction \n\n  ```c++\n  struct sigaction {\n     void     (*sa_handler)(int);\n     void     (*sa_sigaction)(int, siginfo_t *, void *);\n     sigset_t   sa_mask;\n     int        sa_flags;\n     void     (*sa_restorer)(void);\n  };\n  ```\n\n   `sa_handler`  `sa_flags`\n\n   `sa_handler` \n\n  - **SIG_DFL**\n\n    \n\n  - **SIG_IGN**\n\n    \n\n  - ****\n\n     signum \n\n   `sa_flags` \n\n  - **SA_NOCLDSTOP**\n\n     signum = SIGCHLD \n\n  - **SA_RESETHAND**\n\n    \n\n  - **SA_SIGINFO**\n\n     sa_handler  sa_sigaction\n\n- **oldact**  sigaction  sigaction  act\n\n\n\n###### 2.4.3.1.2.2 \n\n sigaction \n\n-  0\n\n-  -1\n\n\n\n##### 2.4.3.1.3 init \n\n sigaction  init \n\n\n\n###### 2.4.3.1.3.1  sigaction\n\ninit  InstallSignalFdHandler  `system/core/init/init.cpp`\n\n```c++\nstatic void InstallSignalFdHandler(Epoll* epoll) {\n    //  sigaction\n    //  sa_handler ,  sa_handler = SIG_DFL \n    //  sa_flags ,  sa_flags = SA_NOCLDSTOP  init , \n    const struct sigaction act { .sa_handler = SIG_DFL, .sa_flags = SA_NOCLDSTOP };\n\n    // sigaction ,  [2.4.3.1.2]\n    //  SIGCHLD,  SIGCHLD, , , , \n    sigaction(SIGCHLD, &act, nullptr);\n\n    ...\n\n}\n```\n\n sigaction `SIGCHLD`  `SIGCHLD` \n\n `SIGCHLD`  `SA_NOCLDSTOP`  init \n\ninit  signal  InstallSignalFdHandler \n\n\n\n###### 2.4.3.1.3.2  signal \n\n\n\nLinux  signalfd\n\ninit \n\n```c++\nstatic void InstallSignalFdHandler(Epoll* epoll) {\n\n    ...\n\n    // mask , \n    // ,  SIGCHLD\n    sigset_t mask;\n    sigemptyset(&mask);\n    sigaddset(&mask, SIGCHLD);\n\n    ...\n\n    //  signal \n    // ,  signalfd ,  -1, \n    signal_fd = signalfd(-1, &mask, SFD_CLOEXEC);\n\n    if (signal_fd == -1) {\n        PLOG(FATAL) << \"failed to create signalfd\";\n    }\n\n    //  signal  epoll,  [2.4.1.2]\n    // HandleSignalFd  [2.4.3.1.4]\n    if (auto result = epoll->RegisterHandler(signal_fd, HandleSignalFd); !result) {\n        LOG(FATAL) << result.error();\n    }\n}\n```\n\n `SIGCHLD` signal  epoll\n\n signal  HandleSignalFd \n\n\n\n##### 2.4.3.1.4  HandleSignalFd\n\n `system/core/init/init.cpp`\n\n```c++\nstatic void HandleSignalFd() {\n    signalfd_siginfo siginfo;\n\n    //  signal  signalfd_siginfo, \n    ssize_t bytes_read = TEMP_FAILURE_RETRY(read(signal_fd, &siginfo, sizeof(siginfo)));\n\n    if (bytes_read != sizeof(siginfo)) {\n        PLOG(ERROR) << \"Failed to read siginfo from signal_fd\";\n        return;\n    }\n\n    // \n    switch (siginfo.ssi_signo) {\n        case SIGCHLD:\n            ReapAnyOutstandingChildren();\n            break;\n        case SIGTERM:\n            HandleSigtermSignal(siginfo);\n            break;\n        default:\n            PLOG(ERROR) << \"signal_fd: received unexpected signal \" << siginfo.ssi_signo;\n            break;\n    }\n}\n```\n\nsignal  signalfd_siginfo HandleSignalFd  signal  signalfd_siginfo\n\n `SIGCHLD` ReapAnyOutstandingChildren \n\n\n\n###### 2.4.3.1.4.1  ReapAnyOutstandingChildren \n\n `system/core/init/sigchld_handler.cpp`\n\n```c++\nvoid ReapAnyOutstandingChildren() {\n    while (ReapOneProcess()) {\n    }\n}\n```\n\n ReapOneProcess  ReapOneProcess  false  ReapOneProcess \n\n\n\n###### 2.4.3.1.4.2  ReapOneProcess \n\n<!-- TODO:  service->flags() -->\n\n<!-- TODO:  ServiceList::GetInstance().RemoveService(*service) -->\n\n `system/core/init/sigchld_handler.cpp`\n\n```c++\nstatic bool ReapOneProcess() {\n    siginfo_t siginfo = {};\n\n    //  waitid, \n    //  init , ,  siginfo \n    if (TEMP_FAILURE_RETRY(waitid(P_ALL, 0, &siginfo, WEXITED | WNOHANG | WNOWAIT)) != 0) {\n        // ,  false\n        PLOG(ERROR) << \"waitid failed\";\n        return false;\n    }\n\n    //  pid\n    auto pid = siginfo.si_pid;\n\n    //  pid ,  false\n    if (pid == 0) return false;\n\n    ...\n\n    std::string name;\n    std::string wait_string;\n    Service* service = nullptr;\n\n    if (PropertyChildReap(pid)) {\n        name = \"Async property child\";\n    } else if (SubcontextChildReap(pid)) {\n        name = \"Subcontext\";\n    } else {\n        //  pid  service\n        service = ServiceList::GetInstance().FindService(pid, &Service::pid);\n\n        if (service) {\n            name = StringPrintf(\"Service '%s' (pid %d)\", service->name().c_str(), pid);\n\n            ...\n\n        } else {\n            name = StringPrintf(\"Untracked pid %d\", pid);\n        }\n    }\n\n    ...\n\n    //  service,  true\n    if (!service) return true;\n\n    //  service  Reap \n    service->Reap(siginfo);\n\n    ...\n\n    return true;\n}\n```\n\nReapOneProcess  waitid pid  service service  service  Reap  Reap \n\n\n\n###### 2.4.3.1.4.3  Reap \n\n `system/core/init/service.cpp`\n\n```c++\nvoid Service::Reap(const siginfo_t& siginfo) {\n    if (!(flags_ & SVC_ONESHOT) || (flags_ & SVC_RESTART)) {\n        //  SVC_ONESHOT  SVC_RESTART, \n        KillProcessGroup(SIGKILL);\n    }\n\n    ...\n\n    //  SVC_TEMPORARY, \n    if (flags_ & SVC_TEMPORARY) return;\n\n    // \n    pid_ = 0;\n    flags_ &= (~SVC_RUNNING);\n    start_order_ = 0;\n\n    if ((flags_ & SVC_ONESHOT) && !(flags_ & SVC_RESTART) && !(flags_ & SVC_RESET)) {\n        //  SVC_ONESHOT \n        flags_ |= SVC_DISABLED;\n    }\n\n    if (flags_ & (SVC_DISABLED | SVC_RESET))  {\n        //  SVC_DISABLED  SVC_RESET,  stopped , \n        NotifyStateChange(\"stopped\");\n        return;\n    }\n\n    //  SVC_CRITICAL \n    //  4  4 , \n    //  bootloader \n    boot_clock::time_point now = boot_clock::now();\n    if (((flags_ & SVC_CRITICAL) || !pre_apexd_) && !(flags_ & SVC_RESTART)) {\n        bool boot_completed = android::base::GetBoolProperty(\"sys.boot_completed\", false);\n        if (now < time_crashed_ + 4min || !boot_completed) {\n            if (++crash_count_ > 4) {\n                if (flags_ & SVC_CRITICAL) {\n                    // Aborts into bootloader\n                    LOG(FATAL) << \"critical process '\" << name_ << \"' exited 4 times \"\n                               << (boot_completed ? \"in 4 minutes\" : \"before boot completed\");\n                } else {\n                    LOG(ERROR) << \"updatable process '\" << name_ << \"' exited 4 times \"\n                               << (boot_completed ? \"in 4 minutes\" : \"before boot completed\");\n                    // Notifies update_verifier and apexd\n                    property_set(\"ro.init.updatable_crashing\", \"1\");\n                }\n            }\n        } else {\n            time_crashed_ = now;\n            crash_count_ = 1;\n        }\n    }\n\n    //  SVC_RESTARTING, init  [2.4.5.2]\n    flags_ &= (~SVC_RESTART);\n    flags_ |= SVC_RESTARTING;\n\n    //  service  onrestart \n    onrestart_.ExecuteAllCommands();\n\n    //  restarting \n    NotifyStateChange(\"restarting\");\n    return;\n}\n```\n\nReap  NotifyStateChange \n\n\n\n###### 2.4.3.1.4.4  NotifyStateChange \n\n `system/core/init/service.cpp`\n\n```c++\nvoid Service::NotifyStateChange(const std::string& new_state) const {\n    if ((flags_ & SVC_TEMPORARY) != 0) {\n        //  SVC_TEMPORARY, \n        return;\n    }\n\n    // \n    std::string prop_name = \"init.svc.\" + name_;\n    property_set(prop_name, new_state);\n\n    ...\n}\n```\n\n key-value  key  init.svc.[service_name]value  adb `getprop | grep init.svc.` service \n\n```\n[init.svc.adbd]: [running]\n[init.svc.alarm-hal-1-0]: [running]\n[init.svc.android.thermal-hal]: [running]\n[init.svc.apexd]: [stopped]\n[init.svc.apexd-bootstrap]: [stopped]\n[init.svc.apexd-snapshotde]: [stopped]\n[init.svc.audioserver]: [running]\n[init.svc.wifidisplayhalservice]: [running]\n[init.svc.wpa_supplicant]: [running]\n[init.svc.zygote]: [running]\n[init.svc.zygote_secondary]: [running]\n```\n\n\n\n### 2.4.4 \n\n<!-- TODO:  CreateParser -->\n\n<!-- TODO: .rc  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: /system/etc/init -->\n\n<!-- TODO: /odm/etc/init -->\n\n<!-- TODO: /vendor/etc/init -->\n\n LoadBootScripts  `system/core/init/init.cpp`\n\n```c++\nstatic void LoadBootScripts(ActionManager& action_manager, ServiceList& service_list) {\n    Parser parser = CreateParser(action_manager, service_list);\n\n    std::string bootscript = GetProperty(\"ro.boot.init_rc\", \"\");\n    if (bootscript.empty()) {\n        //  init.rc  [2.4.4.1]\n        parser.ParseConfig(\"/init.rc\");\n\n        //  /system/etc/init \n        if (!parser.ParseConfig(\"/system/etc/init\")) {\n            late_import_paths.emplace_back(\"/system/etc/init\");\n        }\n\n        //  /product/etc/init \n        if (!parser.ParseConfig(\"/product/etc/init\")) {\n            late_import_paths.emplace_back(\"/product/etc/init\");\n        }\n\n        //  /product_services/etc/init \n        if (!parser.ParseConfig(\"/product_services/etc/init\")) {\n            late_import_paths.emplace_back(\"/product_services/etc/init\");\n        }\n\n        //  /odm/etc/init \n        if (!parser.ParseConfig(\"/odm/etc/init\")) {\n            late_import_paths.emplace_back(\"/odm/etc/init\");\n        }\n\n        //  /vendor/etc/init \n        if (!parser.ParseConfig(\"/vendor/etc/init\")) {\n            late_import_paths.emplace_back(\"/vendor/etc/init\");\n        }\n    } else {\n        parser.ParseConfig(bootscript);\n    }\n}\n```\n\n\n\n- `init.rc`  .rc \n- `/system/etc/init/` SurfaceFlinger, MediaService, logcatd\n- `/vendor/etc/init/`  SoC  SoC \n- `/odm/etc/init/` \n\ninit.rc \n\n\n\n#### 2.4.4.1 init.rc \n\n Android .rc  Android Init Language [ Android Init Language ](https://cs.android.com/android/platform/superproject/+/android-security-10.0.0_r56:system/core/init/README.md)  AOSP  `system/core/init/README.md`\n\n\n\n\n\n##### 2.4.4.1.1 Android Init Language\n\nAndroid Init Language `Actions``Commands``Services``Options``Imports`\n\n\n\n-  token token \n-  token  c  `\\`  token\n-  `\\`\n-  `#` \n-  `${property.name}` `import /init.recovery.${ro.hardware}.rc`\n-  section `Actions`  `Services`  section `Commands`  `Options`  section section  `Commands`  `Options` \n- `Services`  `Services` \n\n\n\n\n\n###### 2.4.4.1.1.1 Actions\n\n`Actions`   `Commands`  `Triggers`  `Actions` \n\n```\non <trigger> [&& <trigger>]*\n   <command>\n   <command>\n   <command>\n```\n\n `Actions`   `Triggers` `Actions` \n\n `Actions`  `Actions`  `Commands`\n\n Zygote \n\n```\non zygote-start && property:ro.crypto.state=unencrypted\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n```\n\n\n\n `Actions`  `Triggers` `zygote-start`  `property:ro.crypto.state=unencrypted` `Command`\n\n `zygote-start`  `property:ro.crypto.state=unencrypted` `Actions`  `Actions`  `Commands`  `Actions`  `Commands`\n\n\n\n###### 2.4.4.1.1.2 Triggers\n\n`Triggers`  `Actions`  `Commands`\n\nTriggers \n\n- **Event triggers**\n\n   `trigger`   `QueueEventTrigger()` \n\n- **Property triggers**\n\n   `property:<key>=<value>`\n\n `Actions` \n\n\n\n`on init && property:a=b``on property:a=b && property:c=d` \n\n`on boot && on init` \n\n\n\n###### 2.4.4.1.1.3 Commands\n\n `Commands`\n\n- **trigger <event>**\n\n  \n\n- **write <path> <content>**\n\n   path \n\n- **chown <owner> <group> <path>**\n\n  \n\n- **mkdir <path> [mode] [owner] [group]**\n\n   \n\n   755 root  root \n\n  \n\n- **start <service>**\n\n  \n\n- **exec_start <service>**\n\n  \n\n- **setprop <name> <value>**\n\n  \n\n- **symlink <target> <path>**\n\n   path  target \n\n\n\n###### 2.4.4.1.1.4 Services\n\n`Services`  init  init  init  `Services`  fork \n\n`Services` \n\n`Services` \n\n```\nservice <name> <pathname> [ <argument> ]*\n   <option>\n   <option>\n   ...\n```\n\n Zygote 64 \n\n```\nservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server\n    class main\n    priority -20\n    user root\n    group root readproc reserved_disk\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n    onrestart write /sys/android_power/request_state wake\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n    writepid /dev/cpuset/foreground/tasks\n```\n\n`zygote`  `Services` `/system/bin/app_process64` `-Xzygote /system/bin --zygote --start-system-server`  `Options`\n\n\n\n###### 2.4.4.1.1.5 Options\n\n`Options`  `Services`  init  `Services` \n\n  `Options`\n\n- **class <name> [ <name>\\* ]**\n\n   `Services`  `Services`  () `Services`  ()  default\n\n- **class_start <serviceclass>**\n\n   `serviceclass`  `Services`\n\n- **priority <priority>**\n\n   `Services`  -20 ~ 19 0\n\n- **user <username>**\n\n   `Services`  root\n\n- **group <groupname> [ <groupname>\\* ]**\n\n   `Services`  root\n\n- **socket <name> <type> <perm> [ <user> [ <group> [ <seclabel> ] ] ]**\n\n   unix  socket `/dev/socket/<name>` socket \n\n- **onrestart**\n\n   `Services`  `Commands`\n\n- **oneshot**\n\n   `Services` \n\n- **writepid <file> [ <file>\\* ]**\n\n   fork  pid \n\n\n\n##### 2.4.4.1.2  init.rc \n\n init.rc  `system/core/rootdir/init.rc`\n\n  `Actions`  `Services`  init.rc  `Actions` [2.4.4.1.1.2]  `QueueEventTrigger()`   `Actions`   `Triggers` `Actions` \n\n\n\n###### 2.4.4.1.2.1 \n\n init  `system/core/init/init.cpp`  SecondStageMain \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n\n    ...\n\n    ActionManager& am = ActionManager::GetInstance();\n\n    ...\n\n    //  early-init  ActionManager\n    am.QueueEventTrigger(\"early-init\");\n\n    ...\n\n    // Trigger all the boot actions to get us started.\n    //  init  ActionManager\n    am.QueueEventTrigger(\"init\");\n\n    ...\n\n    // Don't mount filesystems or start core system services in charger mode.\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        // ,  charger  ActionManager\n        // , \n        am.QueueEventTrigger(\"charger\");\n    } else {\n        // ,  late-init  ActionManager\n        am.QueueEventTrigger(\"late-init\");\n    }\n\n    ...\n\n    return 0;\n}\n```\n\nActionManager  [2.4.5.x]\n\n- early-init -> init -> late-init\n- early-init -> init -> charger\n\n\n\n\n\n###### 2.4.4.1.2.2 init.rc \n\n<!-- TODO: trigger boot -->\n\n\n\n```\non early-init\n    ...\n\n    #  start  ueventd\n    start ueventd\n\n    #  exec_start  apexd-bootstrap, ,  APEX \n    exec_start apexd-bootstrap\n\non init\n    ...\n\n    #  start \n    #  servicemanager [2.4.4.1.2.3]\n    start servicemanager\n    start hwservicemanager\n    start vndservicemanager\n\n# \n#  trigger  [2.4.4.1.1.2]\non late-init\n    trigger early-fs\n    trigger fs\n    trigger post-fs\n    trigger late-fs\n    trigger post-fs-data\n    trigger load_persist_props_action\n\n    #  zygote-start,  zygote [2.4.4.1.2.4]\n    trigger zygote-start\n\n    trigger firmware_mounts_complete\n    trigger early-boot\n    trigger boot\n```\n\n servicemanager  zygote \n\n\n\n###### 2.4.4.1.2.3  servicemanager\n\nservicemanager  `frameworks/native/cmds/servicemanager/servicemanager.rc`\n\n```\n# servicemanager  Services \n# /system/bin/servicemanager \nservice servicemanager /system/bin/servicemanager\n    #  core  animation\n    #  core  animation  () , servicemanager  ()\n    class core animation\n\n    #  system\n    user system\n\n    #  system  readproc\n    group system readproc\n\n    # \n    # ,  bootloader\n    critical\n\n    # \n    #  Commands\n    onrestart restart healthd\n    onrestart restart zygote\n    onrestart restart audioserver\n    onrestart restart media\n    onrestart restart surfaceflinger\n    onrestart restart inputflinger\n    onrestart restart drm\n    onrestart restart cameraserver\n    onrestart restart keystore\n    onrestart restart gatekeeperd\n    onrestart restart thermalservice\n\n    #  fork  pid  /dev/cpuset/system-background/tasks\n    writepid /dev/cpuset/system-background/tasks\n\n    # \n    # shutdown critical , \n    shutdown critical\n```\n\n servicemanager  `frameworks/native/cmds/servicemanager/service_manager.c`  main \n\n\n\n###### 2.4.4.1.2.4  zygote\n\n init.rc  `zygote-start`  3  `Actions`\n\n```\non zygote-start && property:ro.crypto.state=unencrypted\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n\non zygote-start && property:ro.crypto.state=unsupported\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n\non zygote-start && property:ro.crypto.state=encrypted && property:ro.crypto.type=file\n    exec_start update_verifier_nonencrypted\n    start netd\n    start zygote\n    start zygote_secondary\n```\n\nzygote \n\n```\nimport /init.${ro.zygote}.rc\n```\n\n `ro.zygote`\n\n```\nsystem/core/rootdir/init.zygote32.rc\nsystem/core/rootdir/init.zygote32_64.rc\nsystem/core/rootdir/init.zygote64.rc\nsystem/core/rootdir/init.zygote64_32.rc\n```\n\nzygote  `zygote-start`  `Actions`  zygote\n\n Zygote 64  `system/core/rootdir/init.zygote64.rc`\n\n```\n# zygote  Services \n# /system/bin/app_process64 \n# -Xzygote /system/bin --zygote --start-system-server \nservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server\n    #  main\n    #  main  () , zygote  ()\n    class main\n\n    #  -20\n    #  -20 ~ 19, , ,  zygote \n    priority -20\n\n    #  root\n    user root\n    group root readproc reserved_disk\n\n    #  socket\n    socket zygote stream 660 root system\n    socket usap_pool_primary stream 660 root system\n\n    # \n    #  Commands\n    onrestart write /sys/android_power/request_state wake\n    onrestart write /sys/power/state on\n    onrestart restart audioserver\n    onrestart restart cameraserver\n    onrestart restart media\n    onrestart restart netd\n    onrestart restart wificond\n\n    #  zygote  fork  pid  /dev/cpuset/foreground/tasks\n    writepid /dev/cpuset/foreground/tasks\n```\n\n zygote  `frameworks/base/cmds/app_process/app_main.cpp`  main \n\n\n\n### 2.4.5 \n\ninit  `system/core/init/init.cpp`\n\n```c++\nint SecondStageMain(int argc, char** argv) {\n\n    ...\n\n    while (true) {\n        //  epoll \n        // , ,  epoll_timeout  -1\n        auto epoll_timeout = std::optional<std::chrono::milliseconds>{};\n\n        ...\n\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            // am ,  ActionManager \n            //  ActionManager  [2.4.5.1]\n            am.ExecuteOneCommand();\n        }\n        if (!(waiting_for_prop || Service::is_exec_service_running())) {\n            if (!shutting_down) {\n                //  HandleProcessActions  [2.4.5.2]\n                auto next_process_action_time = HandleProcessActions();\n\n                if (next_process_action_time) {\n                    //  next_process_action_time \n                    epoll_timeout = std::chrono::ceil<std::chrono::milliseconds>(\n                            *next_process_action_time - boot_clock::now());\n\n                    //  0, \n                    //  epoll  0,  Wait , \n                    if (*epoll_timeout < 0ms) epoll_timeout = 0ms;\n                }\n            }\n\n            //  ActionManager ,  init , \n            //  epoll  0,  Wait , \n            if (am.HasMoreCommands()) epoll_timeout = 0ms;\n        }\n\n        //  Wait ,  [2.4.1.3]\n        if (auto result = epoll.Wait(epoll_timeout); !result) {\n            LOG(ERROR) << result.error();\n        }\n    }\n\n    return 0;\n}\n```\n\ninit  3 \n\n-  ActionManager \n- \n-  epoll  init  init  `SIGCHLD` \n\n\n\n#### 2.4.5.1 ActionManager\n\n<!-- TODO:  Action? -->\n\n<!-- TODO: Action  Actions  -->\n\n<!-- TODO:  -->\n\nActionManager  Action  Action \n\n\n\n##### 2.4.5.1.1  Action\n\n<!-- TODO:  Action  -->\n\n init  Action Action \n\n```c++\nint SecondStageMain(int argc, char** argv) {\n    ...\n\n    // am ,  ActionManager \n    ActionManager& am = ActionManager::GetInstance();\n\n    ...\n\n    am.QueueBuiltinAction(SetupCgroupsAction, \"SetupCgroups\");\n\n    //  Action:  early-init [2.4.4.1.2.1]\n    am.QueueEventTrigger(\"early-init\");\n\n    //  Action:  coldboot \n    am.QueueBuiltinAction(wait_for_coldboot_done_action, \"wait_for_coldboot_done\");\n\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n    am.QueueBuiltinAction(SetMmapRndBitsAction, \"SetMmapRndBits\");\n    am.QueueBuiltinAction(SetKptrRestrictAction, \"SetKptrRestrict\");\n    Keychords keychords;\n    am.QueueBuiltinAction(\n        [&epoll, &keychords](const BuiltinArguments& args) -> Result<Success> {\n            for (const auto& svc : ServiceList::GetInstance()) {\n                keychords.Register(svc->keycodes());\n            }\n            keychords.Start(&epoll, HandleKeychord);\n            return Success();\n        },\n        \"KeychordInit\");\n    am.QueueBuiltinAction(console_init_action, \"console_init\");\n\n    //  Action:  init [2.4.4.1.2.1]\n    am.QueueEventTrigger(\"init\");\n\n    am.QueueBuiltinAction(StartBoringSslSelfTest, \"StartBoringSslSelfTest\");\n    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, \"MixHwrngIntoLinuxRng\");\n\n    //  Action:  init  binder\n    am.QueueBuiltinAction(InitBinder, \"InitBinder\");\n\n    std::string bootmode = GetProperty(\"ro.bootmode\", \"\");\n    if (bootmode == \"charger\") {\n        // ,  Action:  charger [2.4.4.1.2.1]\n        am.QueueEventTrigger(\"charger\");\n    } else {\n        // ,  Action:  late-init [2.4.4.1.2.1]\n        am.QueueEventTrigger(\"late-init\");\n    }\n\n    //  Action: \n    am.QueueBuiltinAction(queue_property_triggers_action, \"queue_property_triggers\");\n\n    ...\n\n}\n```\n\n ActionManager  Action\n\n\n\n#### 2.4.5.2 HandleProcessActions\n\n<!-- ((s->flags() & SVC_RUNNING) && s->timeout_period()) -->\n\n<!--  service  -->\n\n```c++\nstatic std::optional<boot_clock::time_point> HandleProcessActions() {\n    std::optional<boot_clock::time_point> next_process_action_time;\n\n    //  ServiceList\n    for (const auto& s : ServiceList::GetInstance()) {\n        // , \n        if ((s->flags() & SVC_RUNNING) && s->timeout_period()) {\n            // \n            auto timeout_time = s->time_started() + *s->timeout_period();\n\n            if (boot_clock::now() > timeout_time) {\n                // , \n                s->Timeout();\n            } else {\n                //  next_process_action_time\n                // , next_process_action_time , \n                if (!next_process_action_time || timeout_time < *next_process_action_time) {\n                    next_process_action_time = timeout_time;\n                }\n            }\n        }\n\n        //  SVC_RESTARTING, ,  for \n        if (!(s->flags() & SVC_RESTARTING)) continue;\n\n        // \n        auto restart_time = s->time_started() + s->restart_period();\n\n        // , \n        if (boot_clock::now() > restart_time) {\n            // , \n            if (auto result = s->Start(); !result) {\n                LOG(ERROR) << \"Could not restart process '\" << s->name() << \"': \" << result.error();\n            }\n        } else {\n            //  next_process_action_time\n            // , next_process_action_time , \n            if (!next_process_action_time || restart_time < *next_process_action_time) {\n                next_process_action_time = restart_time;\n            }\n        }\n    }\n    return next_process_action_time;\n}\n```\n\n\n\n1.  `SVC_RUNNING`  `Timeout` \n2.  `SVC_RESTARTING`  \n\n`next_process_action_time` \n\n [2.4.3.1.4.3]  init  `SVC_RESTARTING` init  `SVC_RESTARTING` \n\n\n\n# \n\n[Android-](http://gityuan.com/2016/02/01/android-booting/)\n\n[Android-Init](http://gityuan.com/2016/02/05/android-init/)\n\n[epoll(7)](https://man7.org/linux/man-pages/man7/epoll.7.html)\n\n[Signal](https://en.wikipedia.org/wiki/Signal_(IPC))\n\n[signal(7)](https://man7.org/linux/man-pages/man7/signal.7.html)\n\n[wait(2)](https://man7.org/linux/man-pages/man2/wait.2.html)\n\n[signalfd(2)](https://man7.org/linux/man-pages/man2/signalfd.2.html)\n\n","slug":"exploring-init-process-startup-process","published":1,"updated":"2021-11-10T07:43:55.775Z","_id":"ckvt7ngc6000felprc7r9ejwx","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>android-security-10.0.0_r56</p>\n</blockquote>\n<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><!-- TODO:  init  -->\n\n<p>Android  Linux  init </p>\n<p>init  pid = 1</p>\n<a id=\"more\"></a>\n\n\n\n<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><!-- TODO:  -->\n\n\n\n<h2 id=\"2-1-init-\"><a href=\"#2-1-init-\" class=\"headerlink\" title=\"2.1 init \"></a>2.1 init </h2><!-- TODO:  -->\n\n<!-- TODO: init ,  /system/core/init -->\n\n<p> Android 9init  <code>system/core/init/init.cpp</code>  main </p>\n<p> Android 10 init  <code>system/core/init/main.cpp</code>  main </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(basename(argv[<span class=\"number\">0</span>]), <span class=\"string\">&quot;ueventd&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ueventd_main(argc, argv);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;subcontext&quot;</span>)) &#123;</span><br><span class=\"line\">            android::base::InitLogging(argv, &amp;android::base::KernelLogger);</span><br><span class=\"line\">            <span class=\"keyword\">const</span> BuiltinFunctionMap&amp; function_map = GetBuiltinFunctionMap();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> SubcontextMain(argc, argv, &amp;function_map);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;selinux_setup&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SetupSelinux(argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;second_stage&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SecondStageMain(argc, argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> FirstStageMain(argc, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>basename</code>  <code>strcmp</code> </p>\n<ul>\n<li><code>basename</code>  <code>char* basename(char* __path)</code> /system/bin/ueventd ueventd</li>\n<li><code>strcmp</code>  <code>int strcmp(const char* __lhs, const char* __rhs)</code> 0</li>\n</ul>\n<p> main  <code>argc</code>  <code>argv</code> <code>FirstStageMain</code> </p>\n<h2 id=\"2-2-\"><a href=\"#2-2-\" class=\"headerlink\" title=\"2.2 \"></a>2.2 </h2><!-- TODO: mkdir, mknod, tmpfs -->\n\n<!-- TODO:  -->\n\n<!-- TODO: KernelLogging(/dev/kmsg) -->\n\n<!-- TODO: InstallRebootSignalHandlers -->\n\n<p> <code>int FirstStageMain(int argc, char** argv)</code>  <code>system/core/init/first_stage_init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">FirstStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(clearenv());</span><br><span class=\"line\">    CHECKCALL(setenv(<span class=\"string\">&quot;PATH&quot;</span>, _PATH_DEFPATH, <span class=\"number\">1</span>));</span><br><span class=\"line\">    <span class=\"comment\">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class=\"line\">    <span class=\"comment\">// on / and then we&#x27;ll let the rc file figure out the rest.</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/dev&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class=\"string\">&quot;mode=0755&quot;</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/socket&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/dm-user&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;devpts&quot;</span>, <span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"string\">&quot;devpts&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> MAKE_STR(x) __STRING(x)</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;proc&quot;</span>, <span class=\"string\">&quot;/proc&quot;</span>, <span class=\"string\">&quot;proc&quot;</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;hidepid=2,gid=&quot;</span> MAKE_STR(AID_READPROC)));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> MAKE_STR</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">    <span class=\"comment\">//  [2.2.1]</span></span><br><span class=\"line\">    CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> cmdline;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, &amp;cmdline);</span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">    chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootconfig;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, &amp;bootconfig);</span><br><span class=\"line\">    <span class=\"keyword\">gid_t</span> groups[] = &#123;AID_READPROC&#125;;</span><br><span class=\"line\">    CHECKCALL(setgroups(arraysize(groups), groups));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"string\">&quot;/sys&quot;</span>, <span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"string\">&quot;/sys/fs/selinux&quot;</span>, <span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, S_IFCHR | <span class=\"number\">0600</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">if</span> <span class=\"title\">constexpr</span> <span class=\"params\">(WORLD_WRITABLE_KMSG)</span> </span>&#123;</span><br><span class=\"line\">        CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg_debug&quot;</span>, S_IFCHR | <span class=\"number\">0622</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/random&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">8</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/urandom&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">9</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// This is needed for log wrapper, which gets called before ueventd runs.</span></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/ptmx&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">5</span>, <span class=\"number\">2</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/null&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">3</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// These below mounts are done in first stage init so that first stage mount can mount</span></span><br><span class=\"line\">    <span class=\"comment\">// subdirectories of /mnt/&#123;vendor,product&#125;/.  Other mounts, not required by first stage mount,</span></span><br><span class=\"line\">    <span class=\"comment\">// should be done in rc files.</span></span><br><span class=\"line\">    <span class=\"comment\">// Mount staging areas for devices managed by vold</span></span><br><span class=\"line\">    <span class=\"comment\">// See storage config details at http://source.android.com/devices/storage/</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/mnt&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=1000&quot;</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/vendor is used to mount vendor-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the vendor partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/vendor&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/product is used to mount product-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the product partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/product&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /debug_ramdisk is used to preserve additional files from the debug ramdisk</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/debug_ramdisk&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /second_stage_resources is used to preserve files from first to second</span></span><br><span class=\"line\">    <span class=\"comment\">// stage init</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, kSecondStageRes, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>))</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> CHECKCALL</span></span><br><span class=\"line\"></span><br><span class=\"line\">    SetStdioToDevNull(argv);</span><br><span class=\"line\">    <span class=\"comment\">// Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually</span></span><br><span class=\"line\">    <span class=\"comment\">// talk to the outside world...</span></span><br><span class=\"line\">    InitKernelLogging(argv);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!errors.empty()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; [error_string, error_errno] : errors) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; error_string &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; strerror(error_errno);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Init encountered errors starting first stage, aborting&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    LOG(INFO) &lt;&lt; <span class=\"string\">&quot;init first stage started!&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init</span></span><br><span class=\"line\">    <span class=\"comment\">//  selinux_setup,  SetupSelinux  SELinux  [2.3]</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;selinux_setup&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">auto</span> fd = open(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, O_WRONLY | O_CLOEXEC);</span><br><span class=\"line\">    dup2(fd, STDOUT_FILENO);</span><br><span class=\"line\">    dup2(fd, STDERR_FILENO);</span><br><span class=\"line\">    close(fd);</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// execv() only returns if an error happened, in which case we</span></span><br><span class=\"line\">    <span class=\"comment\">// panic and never fall through this conditional.</span></span><br><span class=\"line\">    PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;execv(\\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class=\"string\">&quot;\\&quot;) failed&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>/system/bin/init</code> main  <code>&quot;selinux_setup&quot;</code> SetupSelinux  SELinux </p>\n<h3 id=\"2-2-1-\"><a href=\"#2-2-1-\" class=\"headerlink\" title=\"2.2.1 \"></a>2.2.1 </h3><p> Linux <code>chmod</code> </p>\n<p></p>\n<h4 id=\"2-2-1-1-\"><a href=\"#2-2-1-1-\" class=\"headerlink\" title=\"2.2.1.1 \"></a>2.2.1.1 </h4><p> 10 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-rwxrwxrwx</span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li><code>-</code></li>\n<li><code>d</code></li>\n<li><code>c</code></li>\n</ul>\n<p> 9  3 </p>\n<p>3  1  2  3 </p>\n<ul>\n<li> 1  <code>r</code> <code>-</code></li>\n<li> 2  <code>w</code> <code>-</code></li>\n<li> 3  <code>x</code> <code>-</code></li>\n</ul>\n<p><code>-rwxrw-r--</code> </p>\n<h4 id=\"2-2-1-2-\"><a href=\"#2-2-1-2-\" class=\"headerlink\" title=\"2.2.1.2 \"></a>2.2.1.2 </h4><p> 4  1  3 </p>\n<p> 3  3 </p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1004</td>\n<td align=\"center\">r</td>\n</tr>\n<tr>\n<td align=\"center\">0102</td>\n<td align=\"center\">w</td>\n</tr>\n<tr>\n<td align=\"center\">0011</td>\n<td align=\"center\">x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\">-</td>\n</tr>\n</tbody></table>\n<p> 0~7</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1117</td>\n<td align=\"center\">rwx</td>\n</tr>\n<tr>\n<td align=\"center\">1106</td>\n<td align=\"center\">rw-</td>\n</tr>\n<tr>\n<td align=\"center\">1015</td>\n<td align=\"center\">r-x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">-rwxrwxrwx</td>\n<td align=\"center\">0777</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">-rwxrw-r</td>\n<td align=\"center\">0764</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<h4 id=\"2-2-1-3-\"><a href=\"#2-2-1-3-\" class=\"headerlink\" title=\"2.2.1.3 \"></a>2.2.1.3 </h4><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br></pre></td></tr></table></figure>\n<p> <code>chmod</code>  <code>/proc/cmdline</code><code>/proc/bootconfig</code>  <code>0440</code> root  () </p>\n<h2 id=\"2-3--SELinux\"><a href=\"#2-3--SELinux\" class=\"headerlink\" title=\"2.3  SELinux\"></a>2.3  SELinux</h2><!-- TODO:  SELinux -->\n\n<p> <code>int SetupSelinux(char** argv)</code>  SELinux  <code>system/core/init/selinux.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// This function initializes SELinux then execs init to run in the init SELinux context.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SetupSelinux</span><span class=\"params\">(<span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Set up SELinux, loading the SELinux policy.</span></span><br><span class=\"line\">    <span class=\"comment\">//  SELinux</span></span><br><span class=\"line\">    SelinuxSetupKernelLogging();</span><br><span class=\"line\">    SelinuxInitialize();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init</span></span><br><span class=\"line\">    <span class=\"comment\">//  second_stage,  SecondStageMain  [2.4]</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;second_stage&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> SELinux <code>/system/bin/init</code> main  <code>&quot;second_stage&quot;</code> SecondStageMain </p>\n<h2 id=\"2-4-\"><a href=\"#2-4-\" class=\"headerlink\" title=\"2.4 \"></a>2.4 </h2><!-- TODO: property_load_boot_defaults -->\n\n<!-- TODO: , android  build.prop  -->\n\n<!-- TODO: SELinux  -->\n\n<!-- TODO: keyctl_get_keyring_ID(KEY_SPEC_SESSION_KEYRING, 1) -->\n\n<!-- TODO: InitializeSubcontext() -->\n\n<!-- TODO: ActionManager  ServiceList  -->\n\n<p> <code>int SecondStageMain(int argc, char** argv)</code>  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Set init and its forked children&#x27;s oom_adj.</span></span><br><span class=\"line\">    <span class=\"comment\">//  init  fork  oom_score_adj </span></span><br><span class=\"line\">    <span class=\"comment\">// , </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = WriteFile(<span class=\"string\">&quot;/proc/1/oom_score_adj&quot;</span>, <span class=\"string\">&quot;-1000&quot;</span>); !result) &#123;</span><br><span class=\"line\">        LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to write -1000 to /proc/1/oom_score_adj: &quot;</span> &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.2.1]</span></span><br><span class=\"line\">    property_init();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll [2.4.1.1]</span></span><br><span class=\"line\">    Epoll epoll;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Open(); !result) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll  init  [2.4.3.1.3]</span></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    InstallSignalFdHandler(&amp;epoll);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.2.2]</span></span><br><span class=\"line\">    StartPropertyService(&amp;epoll);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\">    ServiceList&amp; sm = ServiceList::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.4]</span></span><br><span class=\"line\">    LoadBootScripts(am, sm);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action [2.4.5.1]</span></span><br><span class=\"line\">    am.QueueBuiltinAction(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class=\"string\">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    am.QueueBuiltinAction(queue_property_triggers_action, <span class=\"string\">&quot;queue_property_triggers&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.5]</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = <span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (do_shutdown &amp;&amp; !shutting_down) &#123;</span><br><span class=\"line\">            do_shutdown = <span class=\"literal\">false</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (HandlePowerctlMessage(shutdown_command)) &#123;</span><br><span class=\"line\">                shutting_down = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            am.ExecuteOneCommand();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!shutting_down) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">auto</span> next_process_action_time = HandleProcessActions();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (next_process_action_time) &#123;</span><br><span class=\"line\">                    epoll_timeout = <span class=\"built_in\">std</span>::chrono::<span class=\"built_in\">ceil</span>&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;(</span><br><span class=\"line\">                            *next_process_action_time - boot_clock::now());</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (*epoll_timeout &lt; <span class=\"number\">0</span>ms) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (am.HasMoreCommands()) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> 5 </p>\n<ul>\n<li><p>epoll</p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p> 5 </p>\n<h3 id=\"2-4-1-epoll\"><a href=\"#2-4-1-epoll\" class=\"headerlink\" title=\"2.4.1 epoll\"></a>2.4.1 epoll</h3><p>epoll  Linux  I/O epoll </p>\n<h4 id=\"2-4-1-1-\"><a href=\"#2-4-1-1-\" class=\"headerlink\" title=\"2.4.1.1 \"></a>2.4.1.1 </h4><p> init epoll </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Epoll epoll;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Open(); !result) &#123;</span><br><span class=\"line\">    PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>epoll  Open  <code>system/core/init/epoll.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::Open</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_fd_ &gt;= <span class=\"number\">0</span>) <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    epoll_fd_.reset(epoll_create1(EPOLL_CLOEXEC));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_fd_ == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_create1 failed&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>epoll_create1</code><code>epoll_create1</code>  epoll </p>\n<h4 id=\"2-4-1-2--epoll-\"><a href=\"#2-4-1-2--epoll-\" class=\"headerlink\" title=\"2.4.1.2  epoll \"></a>2.4.1.2  epoll </h4><p> epoll  RegisterHandler  epoll</p>\n<p> <code>system/core/init/epoll.cpp</code> epoll_ctl</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler, <span class=\"keyword\">uint32_t</span> events)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &amp;ev) == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> epoll_ctl </p>\n<h5 id=\"2-4-1-2-1--epoll-ctl\"><a href=\"#2-4-1-2-1--epoll-ctl\" class=\"headerlink\" title=\"2.4.1.2.1  epoll_ctl\"></a>2.4.1.2.1  epoll_ctl</h5><p><strong>epoll_ctl</strong>  <code>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)</code> fd </p>\n<h6 id=\"2-4-1-2-1-1-\"><a href=\"#2-4-1-2-1-1-\" class=\"headerlink\" title=\"2.4.1.2.1.1 \"></a>2.4.1.2.1.1 </h6><p> epoll_ctl </p>\n<ul>\n<li><p><strong>epfd</strong>  epoll </p>\n</li>\n<li><p><strong>op</strong> </p>\n<ul>\n<li><p><strong>EPOLL_CTL_ADD</strong></p>\n<p> epoll </p>\n</li>\n<li><p><strong>EPOLL_CTL_MOD</strong></p>\n<p> epoll </p>\n</li>\n<li><p><strong>EPOLL_CTL_DEL</strong></p>\n<p> epoll </p>\n</li>\n</ul>\n</li>\n<li><p><strong>fd</strong> </p>\n</li>\n<li><p><strong>event</strong>  epoll_event  epoll_event </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">epoll_event</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">uint32_t</span>     events;      <span class=\"comment\">/* Epoll events */</span></span><br><span class=\"line\">   <span class=\"keyword\">epoll_data_t</span> data;        <span class=\"comment\">/* User data variable */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code> </p>\n<ul>\n<li><p>\u0015\u0015<strong>EPOLLIN</strong><br></p>\n</li>\n<li><p><strong>EPOLLOUT</strong><br></p>\n</li>\n<li><p><strong>EPOLLPRI</strong><br></p>\n</li>\n<li><p><strong>EPOLLERR</strong><br></p>\n</li>\n<li><p><strong>EPOLLHUP</strong><br></p>\n</li>\n<li><p><strong>EPOLLONESHOT</strong><br>epoll <br> epoll_ctl EPOLL_CTL_MOD </p>\n</li>\n</ul>\n<p> <code>data</code>  [2.4.1.3]<code>epoll_data_t</code> </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">epoll_data</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">void</span>        *ptr;</span><br><span class=\"line\">   <span class=\"keyword\">int</span>          fd;</span><br><span class=\"line\">   <span class=\"keyword\">uint32_t</span>     u32;</span><br><span class=\"line\">   <span class=\"keyword\">uint64_t</span>     u64;</span><br><span class=\"line\">&#125; <span class=\"keyword\">epoll_data_t</span>;</span><br></pre></td></tr></table></figure>\n\n\n</li>\n</ul>\n<h6 id=\"2-4-1-2-1-2-\"><a href=\"#2-4-1-2-1-2-\" class=\"headerlink\" title=\"2.4.1.2.1.2 \"></a>2.4.1.2.1.2 </h6><p> epoll_ctl </p>\n<ul>\n<li><p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-1-2-2--RegisterHandler-\"><a href=\"#2-4-1-2-2--RegisterHandler-\" class=\"headerlink\" title=\"2.4.1.2.2  RegisterHandler \"></a>2.4.1.2.2  RegisterHandler </h5><p> epoll_ctl  RegisterHandler  <code>system/core/init/epoll.h</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Epoll</span> &#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\">Result&lt;Success&gt; <span class=\"title\">RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                    <span class=\"keyword\">uint32_t</span> events = EPOLLIN)</span></span>;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code>  <code>EPOLLIN</code></p>\n<p> RegisterHandler </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler, <span class=\"keyword\">uint32_t</span> events)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// handler </span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> [it, inserted] = epoll_handlers_.emplace(fd, <span class=\"built_in\">std</span>::move(handler));</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_event ev;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"comment\">//  events  EPOLLIN, </span></span><br><span class=\"line\">    ev.events = events;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">// ,  [2.4.1.3.2]</span></span><br><span class=\"line\">    ev.data.ptr = <span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"keyword\">void</span>*&gt;(&amp;it-&gt;second);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll_ctl </span></span><br><span class=\"line\">    <span class=\"comment\">//  EPOLL_CTL_ADD, </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &amp;ev) == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        Result&lt;Success&gt; result = ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_ctl failed to add fd&quot;</span>;</span><br><span class=\"line\">        epoll_handlers_.erase(fd);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code>  <code>handler</code> <code>epoll_ctl</code>  epoll </p>\n<h4 id=\"2-4-1-3-\"><a href=\"#2-4-1-3-\" class=\"headerlink\" title=\"2.4.1.3 \"></a>2.4.1.3 </h4><p> epoll  epoll </p>\n<p> init </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Wait </p>\n<h5 id=\"2-4-1-3-1--epoll-wait\"><a href=\"#2-4-1-3-1--epoll-wait\" class=\"headerlink\" title=\"2.4.1.3.1  epoll_wait\"></a>2.4.1.3.1  epoll_wait</h5><p> Wait  epoll_wait Wait </p>\n<p><strong>epoll_wait</strong>  <code>int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout)</code> epoll </p>\n<p> epoll_wait </p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<h6 id=\"2-4-1-3-1-1-\"><a href=\"#2-4-1-3-1-1-\" class=\"headerlink\" title=\"2.4.1.3.1.1 \"></a>2.4.1.3.1.1 </h6><p> epoll_wait </p>\n<ul>\n<li><p><strong>epfd</strong>  epoll </p>\n</li>\n<li><p><strong>events</strong>  epoll_event  epoll_event  [2.4.1.2.1] </p>\n<p> events  epoll_event  data  epoll_ctl  data  epoll_ctl  event.data  epoll_wait </p>\n</li>\n<li><p><strong>maxevents</strong>  events  maxevents</p>\n</li>\n<li><p><strong>timeout</strong>  timeout = -1  timeout = 0 </p>\n</li>\n</ul>\n<h6 id=\"2-4-1-3-1-2-\"><a href=\"#2-4-1-3-1-2-\" class=\"headerlink\" title=\"2.4.1.3.1.2 \"></a>2.4.1.3.1.2 </h6><p> epoll_wait </p>\n<ul>\n<li><p> I/O </p>\n<p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-1-3-2--Wait-\"><a href=\"#2-4-1-3-2--Wait-\" class=\"headerlink\" title=\"2.4.1.3.2  Wait \"></a>2.4.1.3.2  Wait </h5><p> epoll_wait  Wait  <code>system/core/init/epoll.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::Wait</span><span class=\"params\">(<span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt; timeout)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  -1</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> timeout_ms = <span class=\"number\">-1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout &amp;&amp; timeout-&gt;count() &lt; INT_MAX) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  timeout  0 , </span></span><br><span class=\"line\">        timeout_ms = timeout-&gt;count();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_event ev;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll_wait </span></span><br><span class=\"line\">    <span class=\"comment\">//  1,  1 </span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd_, &amp;ev, <span class=\"number\">1</span>, timeout_ms));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nr == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  -1, </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_wait failed&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (nr == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  1, ,  1 </span></span><br><span class=\"line\">        <span class=\"comment\">// ev.data.ptr  epoll_ctl , </span></span><br><span class=\"line\">        <span class=\"built_in\">std</span>::invoke(*<span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt;*&gt;(ev.data.ptr));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>epoll_wait</code>  <code>epoll_wait</code>  epoll_ctl </p>\n<h3 id=\"2-4-2-\"><a href=\"#2-4-2-\" class=\"headerlink\" title=\"2.4.2 \"></a>2.4.2 </h3><p> Android  key-value </p>\n<p> adb <code>getprop</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ro.product.brand]: [Redmi]</span><br><span class=\"line\">[ro.product.manufacturer]: [Xiaomi]</span><br><span class=\"line\">[ro.product.marketname]: [Redmi K30S Ultra]</span><br><span class=\"line\">[ro.product.model]: [M2007J3SC]</span><br><span class=\"line\">[ro.product.name]: [apollo]</span><br><span class=\"line\"></span><br><span class=\"line\">[ro.product.cpu.abi]: [arm64-v8a]</span><br><span class=\"line\">[ro.product.cpu.abilist]: [arm64-v8a,armeabi-v7a,armeabi]</span><br><span class=\"line\">[ro.product.cpu.abilist32]: [armeabi-v7a,armeabi]</span><br><span class=\"line\">[ro.product.cpu.abilist64]: [arm64-v8a]</span><br><span class=\"line\"></span><br><span class=\"line\">[dalvik.vm.heapsize]: [512m]</span><br><span class=\"line\">[dalvik.vm.heapstartsize]: [8m]</span><br></pre></td></tr></table></figure>\n<p>CPU </p>\n<p> Java  <code>SystemProperties.get(String, String)</code>  ActivityManager </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">staticGetLargeMemoryClass</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  dalvik.vm.heapsize, </span></span><br><span class=\"line\">    String vmHeapSize = SystemProperties.get(<span class=\"string\">&quot;dalvik.vm.heapsize&quot;</span>, <span class=\"string\">&quot;16m&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> Integer.parseInt(vmHeapSize.substring(<span class=\"number\">0</span>, vmHeapSize.length() - <span class=\"number\">1</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>SystemProperties.set(String, String)</code>  ActivityManagerService </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">finishBooting</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Tell anyone interested that we are done booting!</span></span><br><span class=\"line\">        <span class=\"comment\">//  sys.boot_completed = 1, </span></span><br><span class=\"line\">        SystemProperties.set(<span class=\"string\">&quot;sys.boot_completed&quot;</span>, <span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"2-4-2-1-\"><a href=\"#2-4-2-1-\" class=\"headerlink\" title=\"2.4.2.1 \"></a>2.4.2.1 </h4><!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: CreateSerializedPropertyInfo() -->\n\n<!-- TODO: property_info_area.LoadDefaultPath() -->\n\n<p> property_init  <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">property_init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    mkdir(<span class=\"string\">&quot;/dev/__properties__&quot;</span>, S_IRWXU | S_IXGRP | S_IXOTH);</span><br><span class=\"line\">    CreateSerializedPropertyInfo();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (__system_property_area_init()) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Failed to initialize property area&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!property_info_area.LoadDefaultPath()) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Failed to load serialized property info file&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>__system_property_area_init</code> </p>\n<h4 id=\"2-4-2-2-\"><a href=\"#2-4-2-2-\" class=\"headerlink\" title=\"2.4.2.2 \"></a>2.4.2.2 </h4><!-- TODO: socket  -->\n\n<!-- TODO: listen(property_set_fd, 8) -->\n\n<!-- TODO:  init  -->\n\n<p> StartPropertyService  <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">StartPropertyService</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  socket ,  PROP_SERVICE_NAME = &quot;property_service&quot;</span></span><br><span class=\"line\">    property_set_fd = CreateSocket(PROP_SERVICE_NAME, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK,</span><br><span class=\"line\">                                   <span class=\"literal\">false</span>, <span class=\"number\">0666</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"literal\">nullptr</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (property_set_fd == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;start_property_service socket creation failed&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    listen(property_set_fd, <span class=\"number\">8</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  socket  epoll,  [2.4.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">// handle_property_set_fd  [2.4.2.3]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll-&gt;RegisterHandler(property_set_fd, handle_property_set_fd); !result) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> property_service  socket socket  epoll</p>\n<p> <code>handle_property_set_fd</code></p>\n<h4 id=\"2-4-2-3--handle-property-set-fd\"><a href=\"#2-4-2-3--handle-property-set-fd\" class=\"headerlink\" title=\"2.4.2.3  handle_property_set_fd\"></a>2.4.2.3  handle_property_set_fd</h4><!-- TODO: ucred cr; socklen_t cr_size = sizeof(cr); -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  init ,  -->\n\n<!-- TODO:  -->\n\n<p> <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">handle_property_set_fd</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 2000ms</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">constexpr</span> <span class=\"keyword\">uint32_t</span> kDefaultSocketTimeout = <span class=\"number\">2000</span>; <span class=\"comment\">/* ms */</span></span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">SocketConnection <span class=\"title\">socket</span><span class=\"params\">(s, cr)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  2000ms </span></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> timeout_ms = kDefaultSocketTimeout;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> cmd = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!socket.RecvUint32(&amp;cmd, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop: error while reading command from the socket&quot;</span>;</span><br><span class=\"line\">        socket.SendUint32(PROP_ERROR_READ_CMD);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (cmd) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//  PROP_MSG_SETPROP </span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> PROP_MSG_SETPROP: &#123;</span><br><span class=\"line\">        <span class=\"comment\">// PROP_NAME_MAX = 32</span></span><br><span class=\"line\">        <span class=\"keyword\">char</span> prop_name[PROP_NAME_MAX];</span><br><span class=\"line\">        <span class=\"keyword\">char</span> prop_value[PROP_VALUE_MAX];</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ,  prop_name  prop_value </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!socket.RecvChars(prop_name, PROP_NAME_MAX, &amp;timeout_ms) ||</span><br><span class=\"line\">            !socket.RecvChars(prop_value, PROP_VALUE_MAX, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">          PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop(PROP_MSG_SETPROP): error while reading name/value from the socket&quot;</span>;</span><br><span class=\"line\">          <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  0</span></span><br><span class=\"line\">        prop_name[PROP_NAME_MAX<span class=\"number\">-1</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\">        prop_value[PROP_VALUE_MAX<span class=\"number\">-1</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; cr = socket.cred();</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> error;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> result =</span><br><span class=\"line\">            HandlePropertySet(prop_name, prop_value, socket.source_context(), cr, &amp;error);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != PROP_SUCCESS) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to set property &#x27;&quot;</span> &lt;&lt; prop_name &lt;&lt; <span class=\"string\">&quot;&#x27; to &#x27;&quot;</span> &lt;&lt; prop_value</span><br><span class=\"line\">                       &lt;&lt; <span class=\"string\">&quot;&#x27; from uid:&quot;</span> &lt;&lt; cr.uid &lt;&lt; <span class=\"string\">&quot; gid:&quot;</span> &lt;&lt; cr.gid &lt;&lt; <span class=\"string\">&quot; pid:&quot;</span> &lt;&lt; cr.pid &lt;&lt; <span class=\"string\">&quot;: &quot;</span></span><br><span class=\"line\">                       &lt;&lt; error;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  PROP_MSG_SETPROP2 </span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> PROP_MSG_SETPROP2: &#123;</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> name;</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!socket.RecvString(&amp;name, &amp;timeout_ms) ||</span><br><span class=\"line\">            !socket.RecvString(&amp;value, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">          PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop(PROP_MSG_SETPROP2): error while reading name/value from the socket&quot;</span>;</span><br><span class=\"line\">          socket.SendUint32(PROP_ERROR_READ_DATA);</span><br><span class=\"line\">          <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; cr = socket.cred();</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> error;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> result = HandlePropertySet(name, value, socket.source_context(), cr, &amp;error);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != PROP_SUCCESS) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to set property &#x27;&quot;</span> &lt;&lt; name &lt;&lt; <span class=\"string\">&quot;&#x27; to &#x27;&quot;</span> &lt;&lt; value</span><br><span class=\"line\">                       &lt;&lt; <span class=\"string\">&quot;&#x27; from uid:&quot;</span> &lt;&lt; cr.uid &lt;&lt; <span class=\"string\">&quot; gid:&quot;</span> &lt;&lt; cr.gid &lt;&lt; <span class=\"string\">&quot; pid:&quot;</span> &lt;&lt; cr.pid &lt;&lt; <span class=\"string\">&quot;: &quot;</span></span><br><span class=\"line\">                       &lt;&lt; error;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        socket.SendUint32(result);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop: invalid command &quot;</span> &lt;&lt; cmd;</span><br><span class=\"line\">        socket.SendUint32(PROP_ERROR_INVALID_CMD);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> socket  <code>cmd</code> </p>\n<ul>\n<li> <code>PROP_MSG_SETPROP</code>  <code>PROP_NAME_MAX</code>  0 <code>PROP_NAME_MAX - 1</code> </li>\n<li> <code>PROP_MSG_SETPROP2</code>  <code>std::string</code> </li>\n</ul>\n<p> <code>PROP_MSG_SETPROP</code>  <code>PROP_MSG_SETPROP2</code>  <code>HandlePropertySet</code> </p>\n<h3 id=\"2-4-3-\"><a href=\"#2-4-3-\" class=\"headerlink\" title=\"2.4.3 \"></a>2.4.3 </h3><p><strong> (Signals)</strong>  IPC </p>\n<p><strong></strong></p>\n<h4 id=\"2-4-3-1-\"><a href=\"#2-4-3-1-\" class=\"headerlink\" title=\"2.4.3.1 \"></a>2.4.3.1 </h4><p> Linux (PID) waitwaitpid  waitid ** (Zombie process)**</p>\n<p> init init </p>\n<p> [2.4.4] init  fork servicemanager zygote  Android init </p>\n<p>init </p>\n<p> Android Linux </p>\n<h5 id=\"2-4-3-1-1-\"><a href=\"#2-4-3-1-1-\" class=\"headerlink\" title=\"2.4.3.1.1 \"></a>2.4.3.1.1 </h5><!-- :  -->\n\n<p></p>\n<ul>\n<li><strong></strong></li>\n<li><strong></strong></li>\n<li><strong></strong></li>\n</ul>\n<p>init </p>\n<p></p>\n<h5 id=\"2-4-3-1-2--sigaction\"><a href=\"#2-4-3-1-2--sigaction\" class=\"headerlink\" title=\"2.4.3.1.2  sigaction\"></a>2.4.3.1.2  sigaction</h5><p> init  sigaction</p>\n<p><strong>sigaction</strong>  <code>int sigaction(int signum, const struct sigaction *restrict act, struct sigaction *restrict oldact)</code></p>\n<h6 id=\"2-4-3-1-2-1-\"><a href=\"#2-4-3-1-2-1-\" class=\"headerlink\" title=\"2.4.3.1.2.1 \"></a>2.4.3.1.2.1 </h6><p> sigaction </p>\n<ul>\n<li><p><strong>signum</strong> </p>\n<p> AndroidARM  <code>bionic/libc/kernel/uapi/asm-arm/asm/signal.h</code> </p>\n</li>\n<li><p><strong>act</strong>  sigaction  sigaction </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_handler)(<span class=\"keyword\">int</span>);</span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_sigaction)(<span class=\"keyword\">int</span>, <span class=\"keyword\">siginfo_t</span> *, <span class=\"keyword\">void</span> *);</span><br><span class=\"line\">   <span class=\"keyword\">sigset_t</span>   sa_mask;</span><br><span class=\"line\">   <span class=\"keyword\">int</span>        sa_flags;</span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_restorer)(<span class=\"keyword\">void</span>);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>sa_handler</code>  <code>sa_flags</code></p>\n<p> <code>sa_handler</code> </p>\n<ul>\n<li><p><strong>SIG_DFL</strong></p>\n<p></p>\n</li>\n<li><p><strong>SIG_IGN</strong></p>\n<p></p>\n</li>\n<li><p><strong></strong></p>\n<p> signum </p>\n</li>\n</ul>\n<p> <code>sa_flags</code> </p>\n<ul>\n<li><p><strong>SA_NOCLDSTOP</strong></p>\n<p> signum = SIGCHLD </p>\n</li>\n<li><p><strong>SA_RESETHAND</strong></p>\n<p></p>\n</li>\n<li><p><strong>SA_SIGINFO</strong></p>\n<p> sa_handler  sa_sigaction</p>\n</li>\n</ul>\n</li>\n<li><p><strong>oldact</strong>  sigaction  sigaction  act</p>\n</li>\n</ul>\n<h6 id=\"2-4-3-1-2-2-\"><a href=\"#2-4-3-1-2-2-\" class=\"headerlink\" title=\"2.4.3.1.2.2 \"></a>2.4.3.1.2.2 </h6><p> sigaction </p>\n<ul>\n<li><p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-3-1-3-init-\"><a href=\"#2-4-3-1-3-init-\" class=\"headerlink\" title=\"2.4.3.1.3 init \"></a>2.4.3.1.3 init </h5><p> sigaction  init </p>\n<h6 id=\"2-4-3-1-3-1--sigaction\"><a href=\"#2-4-3-1-3-1--sigaction\" class=\"headerlink\" title=\"2.4.3.1.3.1  sigaction\"></a>2.4.3.1.3.1  sigaction</h6><p>init  InstallSignalFdHandler  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">InstallSignalFdHandler</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  sigaction</span></span><br><span class=\"line\">    <span class=\"comment\">//  sa_handler ,  sa_handler = SIG_DFL </span></span><br><span class=\"line\">    <span class=\"comment\">//  sa_flags ,  sa_flags = SA_NOCLDSTOP  init , </span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> <span class=\"title\">act</span> &#123;</span> .sa_handler = SIG_DFL, .sa_flags = SA_NOCLDSTOP &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sigaction ,  [2.4.3.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">//  SIGCHLD,  SIGCHLD, , , , </span></span><br><span class=\"line\">    sigaction(SIGCHLD, &amp;act, <span class=\"literal\">nullptr</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> sigaction <code>SIGCHLD</code>  <code>SIGCHLD</code> </p>\n<p> <code>SIGCHLD</code>  <code>SA_NOCLDSTOP</code>  init </p>\n<p>init  signal  InstallSignalFdHandler </p>\n<h6 id=\"2-4-3-1-3-2--signal-\"><a href=\"#2-4-3-1-3-2--signal-\" class=\"headerlink\" title=\"2.4.3.1.3.2  signal \"></a>2.4.3.1.3.2  signal </h6><p></p>\n<p>Linux  signalfd</p>\n<p>init </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">InstallSignalFdHandler</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// mask , </span></span><br><span class=\"line\">    <span class=\"comment\">// ,  SIGCHLD</span></span><br><span class=\"line\">    <span class=\"keyword\">sigset_t</span> mask;</span><br><span class=\"line\">    sigemptyset(&amp;mask);</span><br><span class=\"line\">    sigaddset(&amp;mask, SIGCHLD);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal </span></span><br><span class=\"line\">    <span class=\"comment\">// ,  signalfd ,  -1, </span></span><br><span class=\"line\">    signal_fd = signalfd(<span class=\"number\">-1</span>, &amp;mask, SFD_CLOEXEC);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (signal_fd == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;failed to create signalfd&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal  epoll,  [2.4.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">// HandleSignalFd  [2.4.3.1.4]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll-&gt;RegisterHandler(signal_fd, HandleSignalFd); !result) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>SIGCHLD</code> signal  epoll</p>\n<p> signal  HandleSignalFd </p>\n<h5 id=\"2-4-3-1-4--HandleSignalFd\"><a href=\"#2-4-3-1-4--HandleSignalFd\" class=\"headerlink\" title=\"2.4.3.1.4  HandleSignalFd\"></a>2.4.3.1.4  HandleSignalFd</h5><p> <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">HandleSignalFd</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    signalfd_siginfo siginfo;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal  signalfd_siginfo, </span></span><br><span class=\"line\">    <span class=\"keyword\">ssize_t</span> bytes_read = TEMP_FAILURE_RETRY(read(signal_fd, &amp;siginfo, <span class=\"keyword\">sizeof</span>(siginfo)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bytes_read != <span class=\"keyword\">sizeof</span>(siginfo)) &#123;</span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Failed to read siginfo from signal_fd&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (siginfo.ssi_signo) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SIGCHLD:</span><br><span class=\"line\">            ReapAnyOutstandingChildren();</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SIGTERM:</span><br><span class=\"line\">            HandleSigtermSignal(siginfo);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;signal_fd: received unexpected signal &quot;</span> &lt;&lt; siginfo.ssi_signo;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>signal  signalfd_siginfo HandleSignalFd  signal  signalfd_siginfo</p>\n<p> <code>SIGCHLD</code> ReapAnyOutstandingChildren </p>\n<h6 id=\"2-4-3-1-4-1--ReapAnyOutstandingChildren-\"><a href=\"#2-4-3-1-4-1--ReapAnyOutstandingChildren-\" class=\"headerlink\" title=\"2.4.3.1.4.1  ReapAnyOutstandingChildren \"></a>2.4.3.1.4.1  ReapAnyOutstandingChildren </h6><p> <code>system/core/init/sigchld_handler.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">ReapAnyOutstandingChildren</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (ReapOneProcess()) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> ReapOneProcess  ReapOneProcess  false  ReapOneProcess </p>\n<h6 id=\"2-4-3-1-4-2--ReapOneProcess-\"><a href=\"#2-4-3-1-4-2--ReapOneProcess-\" class=\"headerlink\" title=\"2.4.3.1.4.2  ReapOneProcess \"></a>2.4.3.1.4.2  ReapOneProcess </h6><!-- TODO:  service->flags() -->\n\n<!-- TODO:  ServiceList::GetInstance().RemoveService(*service) -->\n\n<p> <code>system/core/init/sigchld_handler.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">bool</span> <span class=\"title\">ReapOneProcess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">siginfo_t</span> siginfo = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  waitid, </span></span><br><span class=\"line\">    <span class=\"comment\">//  init , ,  siginfo </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (TEMP_FAILURE_RETRY(waitid(P_ALL, <span class=\"number\">0</span>, &amp;siginfo, WEXITED | WNOHANG | WNOWAIT)) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  false</span></span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;waitid failed&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  pid</span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> pid = siginfo.si_pid;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  pid ,  false</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> name;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> wait_string;</span><br><span class=\"line\">    Service* service = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (PropertyChildReap(pid)) &#123;</span><br><span class=\"line\">        name = <span class=\"string\">&quot;Async property child&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (SubcontextChildReap(pid)) &#123;</span><br><span class=\"line\">        name = <span class=\"string\">&quot;Subcontext&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  pid  service</span></span><br><span class=\"line\">        service = ServiceList::GetInstance().FindService(pid, &amp;Service::pid);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (service) &#123;</span><br><span class=\"line\">            name = StringPrintf(<span class=\"string\">&quot;Service &#x27;%s&#x27; (pid %d)&quot;</span>, service-&gt;name().c_str(), pid);</span><br><span class=\"line\"></span><br><span class=\"line\">            ...</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            name = StringPrintf(<span class=\"string\">&quot;Untracked pid %d&quot;</span>, pid);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service,  true</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!service) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service  Reap </span></span><br><span class=\"line\">    service-&gt;Reap(siginfo);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ReapOneProcess  waitid pid  service service  service  Reap  Reap </p>\n<h6 id=\"2-4-3-1-4-3--Reap-\"><a href=\"#2-4-3-1-4-3--Reap-\" class=\"headerlink\" title=\"2.4.3.1.4.3  Reap \"></a>2.4.3.1.4.3  Reap </h6><p> <code>system/core/init/service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Service::Reap</span><span class=\"params\">(<span class=\"keyword\">const</span> <span class=\"keyword\">siginfo_t</span>&amp; siginfo)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(flags_ &amp; SVC_ONESHOT) || (flags_ &amp; SVC_RESTART)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_ONESHOT  SVC_RESTART, </span></span><br><span class=\"line\">        KillProcessGroup(SIGKILL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_TEMPORARY, </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (flags_ &amp; SVC_TEMPORARY) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    pid_ = <span class=\"number\">0</span>;</span><br><span class=\"line\">    flags_ &amp;= (~SVC_RUNNING);</span><br><span class=\"line\">    start_order_ = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((flags_ &amp; SVC_ONESHOT) &amp;&amp; !(flags_ &amp; SVC_RESTART) &amp;&amp; !(flags_ &amp; SVC_RESET)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_ONESHOT </span></span><br><span class=\"line\">        flags_ |= SVC_DISABLED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (flags_ &amp; (SVC_DISABLED | SVC_RESET))  &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_DISABLED  SVC_RESET,  stopped , </span></span><br><span class=\"line\">        NotifyStateChange(<span class=\"string\">&quot;stopped&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_CRITICAL </span></span><br><span class=\"line\">    <span class=\"comment\">//  4  4 , </span></span><br><span class=\"line\">    <span class=\"comment\">//  bootloader </span></span><br><span class=\"line\">    boot_clock::time_point now = boot_clock::now();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (((flags_ &amp; SVC_CRITICAL) || !pre_apexd_) &amp;&amp; !(flags_ &amp; SVC_RESTART)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">bool</span> boot_completed = android::base::GetBoolProperty(<span class=\"string\">&quot;sys.boot_completed&quot;</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (now &lt; time_crashed_ + <span class=\"number\">4</span>min || !boot_completed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (++crash_count_ &gt; <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (flags_ &amp; SVC_CRITICAL) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// Aborts into bootloader</span></span><br><span class=\"line\">                    LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;critical process &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class=\"string\">&quot;&#x27; exited 4 times &quot;</span></span><br><span class=\"line\">                               &lt;&lt; (boot_completed ? <span class=\"string\">&quot;in 4 minutes&quot;</span> : <span class=\"string\">&quot;before boot completed&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;updatable process &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class=\"string\">&quot;&#x27; exited 4 times &quot;</span></span><br><span class=\"line\">                               &lt;&lt; (boot_completed ? <span class=\"string\">&quot;in 4 minutes&quot;</span> : <span class=\"string\">&quot;before boot completed&quot;</span>);</span><br><span class=\"line\">                    <span class=\"comment\">// Notifies update_verifier and apexd</span></span><br><span class=\"line\">                    property_set(<span class=\"string\">&quot;ro.init.updatable_crashing&quot;</span>, <span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            time_crashed_ = now;</span><br><span class=\"line\">            crash_count_ = <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_RESTARTING, init  [2.4.5.2]</span></span><br><span class=\"line\">    flags_ &amp;= (~SVC_RESTART);</span><br><span class=\"line\">    flags_ |= SVC_RESTARTING;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service  onrestart </span></span><br><span class=\"line\">    onrestart_.ExecuteAllCommands();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  restarting </span></span><br><span class=\"line\">    NotifyStateChange(<span class=\"string\">&quot;restarting&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Reap  NotifyStateChange </p>\n<h6 id=\"2-4-3-1-4-4--NotifyStateChange-\"><a href=\"#2-4-3-1-4-4--NotifyStateChange-\" class=\"headerlink\" title=\"2.4.3.1.4.4  NotifyStateChange \"></a>2.4.3.1.4.4  NotifyStateChange </h6><p> <code>system/core/init/service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Service::NotifyStateChange</span><span class=\"params\">(<span class=\"keyword\">const</span> <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span>&amp; new_state)</span> <span class=\"keyword\">const</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((flags_ &amp; SVC_TEMPORARY) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_TEMPORARY, </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> prop_name = <span class=\"string\">&quot;init.svc.&quot;</span> + name_;</span><br><span class=\"line\">    property_set(prop_name, new_state);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> key-value  key  init.svc.[service_name]value  adb <code>getprop | grep init.svc.</code> service </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[init.svc.adbd]: [running]</span><br><span class=\"line\">[init.svc.alarm-hal-1-0]: [running]</span><br><span class=\"line\">[init.svc.android.thermal-hal]: [running]</span><br><span class=\"line\">[init.svc.apexd]: [stopped]</span><br><span class=\"line\">[init.svc.apexd-bootstrap]: [stopped]</span><br><span class=\"line\">[init.svc.apexd-snapshotde]: [stopped]</span><br><span class=\"line\">[init.svc.audioserver]: [running]</span><br><span class=\"line\">[init.svc.wifidisplayhalservice]: [running]</span><br><span class=\"line\">[init.svc.wpa_supplicant]: [running]</span><br><span class=\"line\">[init.svc.zygote]: [running]</span><br><span class=\"line\">[init.svc.zygote_secondary]: [running]</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"2-4-4-\"><a href=\"#2-4-4-\" class=\"headerlink\" title=\"2.4.4 \"></a>2.4.4 </h3><!-- TODO:  CreateParser -->\n\n<!-- TODO: .rc  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: /system/etc/init -->\n\n<!-- TODO: /odm/etc/init -->\n\n<!-- TODO: /vendor/etc/init -->\n\n<p> LoadBootScripts  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">LoadBootScripts</span><span class=\"params\">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> </span>&#123;</span><br><span class=\"line\">    Parser parser = CreateParser(action_manager, service_list);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootscript = GetProperty(<span class=\"string\">&quot;ro.boot.init_rc&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootscript.empty()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  init.rc  [2.4.4.1]</span></span><br><span class=\"line\">        parser.ParseConfig(<span class=\"string\">&quot;/init.rc&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /system/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/system/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/system/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /product/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /product_services/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /odm/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/odm/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/odm/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /vendor/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        parser.ParseConfig(bootscript);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li><code>init.rc</code>  .rc </li>\n<li><code>/system/etc/init/</code> SurfaceFlinger, MediaService, logcatd</li>\n<li><code>/vendor/etc/init/</code>  SoC  SoC </li>\n<li><code>/odm/etc/init/</code> </li>\n</ul>\n<p>init.rc </p>\n<h4 id=\"2-4-4-1-init-rc-\"><a href=\"#2-4-4-1-init-rc-\" class=\"headerlink\" title=\"2.4.4.1 init.rc \"></a>2.4.4.1 init.rc </h4><p> Android .rc  Android Init Language <a href=\"https://cs.android.com/android/platform/superproject/+/android-security-10.0.0_r56:system/core/init/README.md\"> Android Init Language </a>  AOSP  <code>system/core/init/README.md</code></p>\n<p></p>\n<h5 id=\"2-4-4-1-1-Android-Init-Language\"><a href=\"#2-4-4-1-1-Android-Init-Language\" class=\"headerlink\" title=\"2.4.4.1.1 Android Init Language\"></a>2.4.4.1.1 Android Init Language</h5><p>Android Init Language <code>Actions</code><code>Commands</code><code>Services</code><code>Options</code><code>Imports</code></p>\n<p></p>\n<ul>\n<li> token token </li>\n<li> token  c  <code>\\</code>  token</li>\n<li> <code>\\</code></li>\n<li> <code>#</code> </li>\n<li> <code>$&#123;property.name&#125;</code> <code>import /init.recovery.$&#123;ro.hardware&#125;.rc</code></li>\n<li> section <code>Actions</code>  <code>Services</code>  section <code>Commands</code>  <code>Options</code>  section section  <code>Commands</code>  <code>Options</code> </li>\n<li><code>Services</code>  <code>Services</code> </li>\n</ul>\n<p></p>\n<h6 id=\"2-4-4-1-1-1-Actions\"><a href=\"#2-4-4-1-1-1-Actions\" class=\"headerlink\" title=\"2.4.4.1.1.1 Actions\"></a>2.4.4.1.1.1 Actions</h6><p><code>Actions</code>   <code>Commands</code>  <code>Triggers</code>  <code>Actions</code> </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]*</span><br><span class=\"line\">   &lt;command&gt;</span><br><span class=\"line\">   &lt;command&gt;</span><br><span class=\"line\">   &lt;command&gt;</span><br></pre></td></tr></table></figure>\n<p> <code>Actions</code>   <code>Triggers</code> <code>Actions</code> </p>\n<p> <code>Actions</code>  <code>Actions</code>  <code>Commands</code></p>\n<p> Zygote </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unencrypted</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br></pre></td></tr></table></figure>\n<p></p>\n<p> <code>Actions</code>  <code>Triggers</code> <code>zygote-start</code>  <code>property:ro.crypto.state=unencrypted</code> <code>Command</code></p>\n<p> <code>zygote-start</code>  <code>property:ro.crypto.state=unencrypted</code> <code>Actions</code>  <code>Actions</code>  <code>Commands</code>  <code>Actions</code>  <code>Commands</code></p>\n<h6 id=\"2-4-4-1-1-2-Triggers\"><a href=\"#2-4-4-1-1-2-Triggers\" class=\"headerlink\" title=\"2.4.4.1.1.2 Triggers\"></a>2.4.4.1.1.2 Triggers</h6><p><code>Triggers</code>  <code>Actions</code>  <code>Commands</code></p>\n<p>Triggers </p>\n<ul>\n<li><p><strong>Event triggers</strong></p>\n<p> <code>trigger</code>   <code>QueueEventTrigger()</code> </p>\n</li>\n<li><p><strong>Property triggers</strong></p>\n<p> <code>property:&lt;key&gt;=&lt;value&gt;</code></p>\n</li>\n</ul>\n<p> <code>Actions</code> </p>\n<p></p>\n<p><code>on init &amp;&amp; property:a=b</code><code>on property:a=b &amp;&amp; property:c=d</code> </p>\n<p><code>on boot &amp;&amp; on init</code> </p>\n<h6 id=\"2-4-4-1-1-3-Commands\"><a href=\"#2-4-4-1-1-3-Commands\" class=\"headerlink\" title=\"2.4.4.1.1.3 Commands\"></a>2.4.4.1.1.3 Commands</h6><p> <code>Commands</code></p>\n<ul>\n<li><p><strong>trigger <event></strong></p>\n<p></p>\n</li>\n<li><p><strong>write <path> <content></strong></p>\n<p> path </p>\n</li>\n<li><p><strong>chown <owner> <group> <path></strong></p>\n<p></p>\n</li>\n<li><p><strong>mkdir <path> [mode] [owner] [group]</strong></p>\n<p> </p>\n<p> 755 root  root </p>\n<p></p>\n</li>\n<li><p><strong>start <service></strong></p>\n<p></p>\n</li>\n<li><p><strong>exec_start <service></strong></p>\n<p></p>\n</li>\n<li><p><strong>setprop <name> <value></strong></p>\n<p></p>\n</li>\n<li><p><strong>symlink <target> <path></strong></p>\n<p> path  target </p>\n</li>\n</ul>\n<h6 id=\"2-4-4-1-1-4-Services\"><a href=\"#2-4-4-1-1-4-Services\" class=\"headerlink\" title=\"2.4.4.1.1.4 Services\"></a>2.4.4.1.1.4 Services</h6><p><code>Services</code>  init  init  init  <code>Services</code>  fork </p>\n<p><code>Services</code> </p>\n<p><code>Services</code> </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service &lt;name&gt; &lt;pathname&gt; [ &lt;argument&gt; ]*</span><br><span class=\"line\">   &lt;option&gt;</span><br><span class=\"line\">   &lt;option&gt;</span><br><span class=\"line\">   ...</span><br></pre></td></tr></table></figure>\n<p> Zygote 64 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service zygote &#x2F;system&#x2F;bin&#x2F;app_process64 -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server</span><br><span class=\"line\">    class main</span><br><span class=\"line\">    priority -20</span><br><span class=\"line\">    user root</span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\">    socket zygote stream 660 root system</span><br><span class=\"line\">    socket usap_pool_primary stream 660 root system</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;android_power&#x2F;request_state wake</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;power&#x2F;state on</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart netd</span><br><span class=\"line\">    onrestart restart wificond</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br></pre></td></tr></table></figure>\n<p><code>zygote</code>  <code>Services</code> <code>/system/bin/app_process64</code> <code>-Xzygote /system/bin --zygote --start-system-server</code>  <code>Options</code></p>\n<h6 id=\"2-4-4-1-1-5-Options\"><a href=\"#2-4-4-1-1-5-Options\" class=\"headerlink\" title=\"2.4.4.1.1.5 Options\"></a>2.4.4.1.1.5 Options</h6><p><code>Options</code>  <code>Services</code>  init  <code>Services</code> </p>\n<p>  <code>Options</code></p>\n<ul>\n<li><p><strong>class <name> [ <name>* ]</strong></p>\n<p> <code>Services</code>  <code>Services</code>  () <code>Services</code>  ()  default</p>\n</li>\n<li><p><strong>class_start <serviceclass></strong></p>\n<p> <code>serviceclass</code>  <code>Services</code></p>\n</li>\n<li><p><strong>priority <priority></strong></p>\n<p> <code>Services</code>  -20 ~ 19 0</p>\n</li>\n<li><p><strong>user <username></strong></p>\n<p> <code>Services</code>  root</p>\n</li>\n<li><p><strong>group <groupname> [ <groupname>* ]</strong></p>\n<p> <code>Services</code>  root</p>\n</li>\n<li><p><strong>socket <name> <type> <perm> [ <user> [ <group> [ <seclabel> ] ] ]</strong></p>\n<p> unix  socket <code>/dev/socket/&lt;name&gt;</code> socket </p>\n</li>\n<li><p><strong>onrestart</strong></p>\n<p> <code>Services</code>  <code>Commands</code></p>\n</li>\n<li><p><strong>oneshot</strong></p>\n<p> <code>Services</code> </p>\n</li>\n<li><p><strong>writepid <file> [ <file>* ]</strong></p>\n<p> fork  pid </p>\n</li>\n</ul>\n<h5 id=\"2-4-4-1-2--init-rc-\"><a href=\"#2-4-4-1-2--init-rc-\" class=\"headerlink\" title=\"2.4.4.1.2  init.rc \"></a>2.4.4.1.2  init.rc </h5><p> init.rc  <code>system/core/rootdir/init.rc</code></p>\n<p>  <code>Actions</code>  <code>Services</code>  init.rc  <code>Actions</code> [2.4.4.1.1.2]  <code>QueueEventTrigger()</code>   <code>Actions</code>   <code>Triggers</code> <code>Actions</code> </p>\n<h6 id=\"2-4-4-1-2-1-\"><a href=\"#2-4-4-1-2-1-\" class=\"headerlink\" title=\"2.4.4.1.2.1 \"></a>2.4.4.1.2.1 </h6><p> init  <code>system/core/init/init.cpp</code>  SecondStageMain </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  early-init  ActionManager</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Trigger all the boot actions to get us started.</span></span><br><span class=\"line\">    <span class=\"comment\">//  init  ActionManager</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t mount filesystems or start core system services in charger mode.</span></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootmode = GetProperty(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  charger  ActionManager</span></span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  late-init  ActionManager</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ActionManager  [2.4.5.x]</p>\n<ul>\n<li>early-init -&gt; init -&gt; late-init</li>\n<li>early-init -&gt; init -&gt; charger</li>\n</ul>\n<p></p>\n<h6 id=\"2-4-4-1-2-2-init-rc-\"><a href=\"#2-4-4-1-2-2-init-rc-\" class=\"headerlink\" title=\"2.4.4.1.2.2 init.rc \"></a>2.4.4.1.2.2 init.rc </h6><!-- TODO: trigger boot -->\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on early-init</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    #  start  ueventd</span><br><span class=\"line\">    start ueventd</span><br><span class=\"line\"></span><br><span class=\"line\">    #  exec_start  apexd-bootstrap, ,  APEX </span><br><span class=\"line\">    exec_start apexd-bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\">on init</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    #  start </span><br><span class=\"line\">    #  servicemanager [2.4.4.1.2.3]</span><br><span class=\"line\">    start servicemanager</span><br><span class=\"line\">    start hwservicemanager</span><br><span class=\"line\">    start vndservicemanager</span><br><span class=\"line\"></span><br><span class=\"line\"># </span><br><span class=\"line\">#  trigger  [2.4.4.1.1.2]</span><br><span class=\"line\">on late-init</span><br><span class=\"line\">    trigger early-fs</span><br><span class=\"line\">    trigger fs</span><br><span class=\"line\">    trigger post-fs</span><br><span class=\"line\">    trigger late-fs</span><br><span class=\"line\">    trigger post-fs-data</span><br><span class=\"line\">    trigger load_persist_props_action</span><br><span class=\"line\"></span><br><span class=\"line\">    #  zygote-start,  zygote [2.4.4.1.2.4]</span><br><span class=\"line\">    trigger zygote-start</span><br><span class=\"line\"></span><br><span class=\"line\">    trigger firmware_mounts_complete</span><br><span class=\"line\">    trigger early-boot</span><br><span class=\"line\">    trigger boot</span><br></pre></td></tr></table></figure>\n<p> servicemanager  zygote </p>\n<h6 id=\"2-4-4-1-2-3--servicemanager\"><a href=\"#2-4-4-1-2-3--servicemanager\" class=\"headerlink\" title=\"2.4.4.1.2.3  servicemanager\"></a>2.4.4.1.2.3  servicemanager</h6><p>servicemanager  <code>frameworks/native/cmds/servicemanager/servicemanager.rc</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># servicemanager  Services </span><br><span class=\"line\"># &#x2F;system&#x2F;bin&#x2F;servicemanager </span><br><span class=\"line\">service servicemanager &#x2F;system&#x2F;bin&#x2F;servicemanager</span><br><span class=\"line\">    #  core  animation</span><br><span class=\"line\">    #  core  animation  () , servicemanager  ()</span><br><span class=\"line\">    class core animation</span><br><span class=\"line\"></span><br><span class=\"line\">    #  system</span><br><span class=\"line\">    user system</span><br><span class=\"line\"></span><br><span class=\"line\">    #  system  readproc</span><br><span class=\"line\">    group system readproc</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    # ,  bootloader</span><br><span class=\"line\">    critical</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    #  Commands</span><br><span class=\"line\">    onrestart restart healthd</span><br><span class=\"line\">    onrestart restart zygote</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart surfaceflinger</span><br><span class=\"line\">    onrestart restart inputflinger</span><br><span class=\"line\">    onrestart restart drm</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart keystore</span><br><span class=\"line\">    onrestart restart gatekeeperd</span><br><span class=\"line\">    onrestart restart thermalservice</span><br><span class=\"line\"></span><br><span class=\"line\">    #  fork  pid  &#x2F;dev&#x2F;cpuset&#x2F;system-background&#x2F;tasks</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;system-background&#x2F;tasks</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    # shutdown critical , </span><br><span class=\"line\">    shutdown critical</span><br></pre></td></tr></table></figure>\n<p> servicemanager  <code>frameworks/native/cmds/servicemanager/service_manager.c</code>  main </p>\n<h6 id=\"2-4-4-1-2-4--zygote\"><a href=\"#2-4-4-1-2-4--zygote\" class=\"headerlink\" title=\"2.4.4.1.2.4  zygote\"></a>2.4.4.1.2.4  zygote</h6><p> init.rc  <code>zygote-start</code>  3  <code>Actions</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unencrypted</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br><span class=\"line\"></span><br><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unsupported</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br><span class=\"line\"></span><br><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;encrypted &amp;&amp; property:ro.crypto.type&#x3D;file</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br></pre></td></tr></table></figure>\n<p>zygote </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &#x2F;init.$&#123;ro.zygote&#125;.rc</span><br></pre></td></tr></table></figure>\n<p> <code>ro.zygote</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote32.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote32_64.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote64.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote64_32.rc</span><br></pre></td></tr></table></figure>\n<p>zygote  <code>zygote-start</code>  <code>Actions</code>  zygote</p>\n<p> Zygote 64  <code>system/core/rootdir/init.zygote64.rc</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># zygote  Services </span><br><span class=\"line\"># &#x2F;system&#x2F;bin&#x2F;app_process64 </span><br><span class=\"line\"># -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server </span><br><span class=\"line\">service zygote &#x2F;system&#x2F;bin&#x2F;app_process64 -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server</span><br><span class=\"line\">    #  main</span><br><span class=\"line\">    #  main  () , zygote  ()</span><br><span class=\"line\">    class main</span><br><span class=\"line\"></span><br><span class=\"line\">    #  -20</span><br><span class=\"line\">    #  -20 ~ 19, , ,  zygote </span><br><span class=\"line\">    priority -20</span><br><span class=\"line\"></span><br><span class=\"line\">    #  root</span><br><span class=\"line\">    user root</span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\"></span><br><span class=\"line\">    #  socket</span><br><span class=\"line\">    socket zygote stream 660 root system</span><br><span class=\"line\">    socket usap_pool_primary stream 660 root system</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    #  Commands</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;android_power&#x2F;request_state wake</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;power&#x2F;state on</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart netd</span><br><span class=\"line\">    onrestart restart wificond</span><br><span class=\"line\"></span><br><span class=\"line\">    #  zygote  fork  pid  &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br></pre></td></tr></table></figure>\n<p> zygote  <code>frameworks/base/cmds/app_process/app_main.cpp</code>  main </p>\n<h3 id=\"2-4-5-\"><a href=\"#2-4-5-\" class=\"headerlink\" title=\"2.4.5 \"></a>2.4.5 </h3><p>init  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  epoll </span></span><br><span class=\"line\">        <span class=\"comment\">// , ,  epoll_timeout  -1</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = <span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// am ,  ActionManager </span></span><br><span class=\"line\">            <span class=\"comment\">//  ActionManager  [2.4.5.1]</span></span><br><span class=\"line\">            am.ExecuteOneCommand();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!shutting_down) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//  HandleProcessActions  [2.4.5.2]</span></span><br><span class=\"line\">                <span class=\"keyword\">auto</span> next_process_action_time = HandleProcessActions();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (next_process_action_time) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//  next_process_action_time </span></span><br><span class=\"line\">                    epoll_timeout = <span class=\"built_in\">std</span>::chrono::<span class=\"built_in\">ceil</span>&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;(</span><br><span class=\"line\">                            *next_process_action_time - boot_clock::now());</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//  0, </span></span><br><span class=\"line\">                    <span class=\"comment\">//  epoll  0,  Wait , </span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (*epoll_timeout &lt; <span class=\"number\">0</span>ms) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//  ActionManager ,  init , </span></span><br><span class=\"line\">            <span class=\"comment\">//  epoll  0,  Wait , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (am.HasMoreCommands()) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  Wait ,  [2.4.1.3]</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>init  3 </p>\n<ul>\n<li> ActionManager </li>\n<li></li>\n<li> epoll  init  init  <code>SIGCHLD</code> </li>\n</ul>\n<h4 id=\"2-4-5-1-ActionManager\"><a href=\"#2-4-5-1-ActionManager\" class=\"headerlink\" title=\"2.4.5.1 ActionManager\"></a>2.4.5.1 ActionManager</h4><!-- TODO:  Action? -->\n\n<!-- TODO: Action  Actions  -->\n\n<!-- TODO:  -->\n\n<p>ActionManager  Action  Action </p>\n<h5 id=\"2-4-5-1-1--Action\"><a href=\"#2-4-5-1-1--Action\" class=\"headerlink\" title=\"2.4.5.1.1  Action\"></a>2.4.5.1.1  Action</h5><!-- TODO:  Action  -->\n\n<p> init  Action Action </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// am ,  ActionManager </span></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  early-init [2.4.4.1.2.1]</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  coldboot </span></span><br><span class=\"line\">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class=\"string\">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetMmapRndBitsAction, <span class=\"string\">&quot;SetMmapRndBits&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetKptrRestrictAction, <span class=\"string\">&quot;SetKptrRestrict&quot;</span>);</span><br><span class=\"line\">    Keychords keychords;</span><br><span class=\"line\">    am.QueueBuiltinAction(</span><br><span class=\"line\">        [&amp;epoll, &amp;keychords](<span class=\"keyword\">const</span> BuiltinArguments&amp; args) -&gt; Result&lt;Success&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; svc : ServiceList::GetInstance()) &#123;</span><br><span class=\"line\">                keychords.Register(svc-&gt;keycodes());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            keychords.Start(&amp;epoll, HandleKeychord);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;KeychordInit&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(console_init_action, <span class=\"string\">&quot;console_init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  init [2.4.4.1.2.1]</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(StartBoringSslSelfTest, <span class=\"string\">&quot;StartBoringSslSelfTest&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  init  binder</span></span><br><span class=\"line\">    am.QueueBuiltinAction(InitBinder, <span class=\"string\">&quot;InitBinder&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootmode = GetProperty(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  Action:  charger [2.4.4.1.2.1]</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  Action:  late-init [2.4.4.1.2.1]</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action: </span></span><br><span class=\"line\">    am.QueueBuiltinAction(queue_property_triggers_action, <span class=\"string\">&quot;queue_property_triggers&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> ActionManager  Action</p>\n<h4 id=\"2-4-5-2-HandleProcessActions\"><a href=\"#2-4-5-2-HandleProcessActions\" class=\"headerlink\" title=\"2.4.5.2 HandleProcessActions\"></a>2.4.5.2 HandleProcessActions</h4><!-- ((s->flags() & SVC_RUNNING) && s->timeout_period()) -->\n\n<!--  service  -->\n\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"built_in\">std</span>::optional&lt;boot_clock::time_point&gt; <span class=\"title\">HandleProcessActions</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::optional&lt;boot_clock::time_point&gt; next_process_action_time;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  ServiceList</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; s : ServiceList::GetInstance()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((s-&gt;flags() &amp; SVC_RUNNING) &amp;&amp; s-&gt;timeout_period()) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">auto</span> timeout_time = s-&gt;time_started() + *s-&gt;timeout_period();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (boot_clock::now() &gt; timeout_time) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// , </span></span><br><span class=\"line\">                s-&gt;Timeout();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//  next_process_action_time</span></span><br><span class=\"line\">                <span class=\"comment\">// , next_process_action_time , </span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!next_process_action_time || timeout_time &lt; *next_process_action_time) &#123;</span><br><span class=\"line\">                    next_process_action_time = timeout_time;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  SVC_RESTARTING, ,  for </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(s-&gt;flags() &amp; SVC_RESTARTING)) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> restart_time = s-&gt;time_started() + s-&gt;restart_period();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (boot_clock::now() &gt; restart_time) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = s-&gt;Start(); !result) &#123;</span><br><span class=\"line\">                LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Could not restart process &#x27;&quot;</span> &lt;&lt; s-&gt;name() &lt;&lt; <span class=\"string\">&quot;&#x27;: &quot;</span> &lt;&lt; result.error();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//  next_process_action_time</span></span><br><span class=\"line\">            <span class=\"comment\">// , next_process_action_time , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!next_process_action_time || restart_time &lt; *next_process_action_time) &#123;</span><br><span class=\"line\">                next_process_action_time = restart_time;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> next_process_action_time;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p></p>\n<ol>\n<li> <code>SVC_RUNNING</code>  <code>Timeout</code> </li>\n<li> <code>SVC_RESTARTING</code>  </li>\n</ol>\n<p><code>next_process_action_time</code> </p>\n<p> [2.4.3.1.4.3]  init  <code>SVC_RESTARTING</code> init  <code>SVC_RESTARTING</code> </p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"http://gityuan.com/2016/02/01/android-booting/\">Android-</a></p>\n<p><a href=\"http://gityuan.com/2016/02/05/android-init/\">Android-Init</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man7/epoll.7.html\">epoll(7)</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Signal_(IPC)\">Signal</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man7/signal.7.html\">signal(7)</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man2/wait.2.html\">wait(2)</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man2/signalfd.2.html\">signalfd(2)</a></p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>android-security-10.0.0_r56</p>\n</blockquote>\n<h1 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h1><!-- TODO:  init  -->\n\n<p>Android  Linux  init </p>\n<p>init  pid = 1</p>","more":"<h1 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h1><!-- TODO:  -->\n\n\n\n<h2 id=\"2-1-init-\"><a href=\"#2-1-init-\" class=\"headerlink\" title=\"2.1 init \"></a>2.1 init </h2><!-- TODO:  -->\n\n<!-- TODO: init ,  /system/core/init -->\n\n<p> Android 9init  <code>system/core/init/init.cpp</code>  main </p>\n<p> Android 10 init  <code>system/core/init/main.cpp</code>  main </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(basename(argv[<span class=\"number\">0</span>]), <span class=\"string\">&quot;ueventd&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ueventd_main(argc, argv);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;subcontext&quot;</span>)) &#123;</span><br><span class=\"line\">            android::base::InitLogging(argv, &amp;android::base::KernelLogger);</span><br><span class=\"line\">            <span class=\"keyword\">const</span> BuiltinFunctionMap&amp; function_map = GetBuiltinFunctionMap();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> SubcontextMain(argc, argv, &amp;function_map);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;selinux_setup&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SetupSelinux(argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"built_in\">strcmp</span>(argv[<span class=\"number\">1</span>], <span class=\"string\">&quot;second_stage&quot;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> SecondStageMain(argc, argv);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> FirstStageMain(argc, argv);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>basename</code>  <code>strcmp</code> </p>\n<ul>\n<li><code>basename</code>  <code>char* basename(char* __path)</code> /system/bin/ueventd ueventd</li>\n<li><code>strcmp</code>  <code>int strcmp(const char* __lhs, const char* __rhs)</code> 0</li>\n</ul>\n<p> main  <code>argc</code>  <code>argv</code> <code>FirstStageMain</code> </p>\n<h2 id=\"2-2-\"><a href=\"#2-2-\" class=\"headerlink\" title=\"2.2 \"></a>2.2 </h2><!-- TODO: mkdir, mknod, tmpfs -->\n\n<!-- TODO:  -->\n\n<!-- TODO: KernelLogging(/dev/kmsg) -->\n\n<!-- TODO: InstallRebootSignalHandlers -->\n\n<p> <code>int FirstStageMain(int argc, char** argv)</code>  <code>system/core/init/first_stage_init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">FirstStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(clearenv());</span><br><span class=\"line\">    CHECKCALL(setenv(<span class=\"string\">&quot;PATH&quot;</span>, _PATH_DEFPATH, <span class=\"number\">1</span>));</span><br><span class=\"line\">    <span class=\"comment\">// Get the basic filesystem setup we need put together in the initramdisk</span></span><br><span class=\"line\">    <span class=\"comment\">// on / and then we&#x27;ll let the rc file figure out the rest.</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/dev&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class=\"string\">&quot;mode=0755&quot;</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/socket&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/dev/dm-user&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;devpts&quot;</span>, <span class=\"string\">&quot;/dev/pts&quot;</span>, <span class=\"string\">&quot;devpts&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> MAKE_STR(x) __STRING(x)</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;proc&quot;</span>, <span class=\"string\">&quot;/proc&quot;</span>, <span class=\"string\">&quot;proc&quot;</span>, <span class=\"number\">0</span>, <span class=\"string\">&quot;hidepid=2,gid=&quot;</span> MAKE_STR(AID_READPROC)));</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> MAKE_STR</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">    <span class=\"comment\">//  [2.2.1]</span></span><br><span class=\"line\">    CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> cmdline;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, &amp;cmdline);</span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">    chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootconfig;</span><br><span class=\"line\">    android::base::ReadFileToString(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, &amp;bootconfig);</span><br><span class=\"line\">    <span class=\"keyword\">gid_t</span> groups[] = &#123;AID_READPROC&#125;;</span><br><span class=\"line\">    CHECKCALL(setgroups(arraysize(groups), groups));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"string\">&quot;/sys&quot;</span>, <span class=\"string\">&quot;sysfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"string\">&quot;/sys/fs/selinux&quot;</span>, <span class=\"string\">&quot;selinuxfs&quot;</span>, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, S_IFCHR | <span class=\"number\">0600</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">if</span> <span class=\"title\">constexpr</span> <span class=\"params\">(WORLD_WRITABLE_KMSG)</span> </span>&#123;</span><br><span class=\"line\">        CHECKCALL(mknod(<span class=\"string\">&quot;/dev/kmsg_debug&quot;</span>, S_IFCHR | <span class=\"number\">0622</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">11</span>)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/random&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">8</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/urandom&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">9</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// This is needed for log wrapper, which gets called before ueventd runs.</span></span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/ptmx&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">5</span>, <span class=\"number\">2</span>)));</span><br><span class=\"line\">    CHECKCALL(mknod(<span class=\"string\">&quot;/dev/null&quot;</span>, S_IFCHR | <span class=\"number\">0666</span>, makedev(<span class=\"number\">1</span>, <span class=\"number\">3</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// These below mounts are done in first stage init so that first stage mount can mount</span></span><br><span class=\"line\">    <span class=\"comment\">// subdirectories of /mnt/&#123;vendor,product&#125;/.  Other mounts, not required by first stage mount,</span></span><br><span class=\"line\">    <span class=\"comment\">// should be done in rc files.</span></span><br><span class=\"line\">    <span class=\"comment\">// Mount staging areas for devices managed by vold</span></span><br><span class=\"line\">    <span class=\"comment\">// See storage config details at http://source.android.com/devices/storage/</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/mnt&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=1000&quot;</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/vendor is used to mount vendor-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the vendor partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/vendor&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\">    <span class=\"comment\">// /mnt/product is used to mount product-specific partitions that can not be</span></span><br><span class=\"line\">    <span class=\"comment\">// part of the product partition, e.g. because they are mounted read-write.</span></span><br><span class=\"line\">    CHECKCALL(mkdir(<span class=\"string\">&quot;/mnt/product&quot;</span>, <span class=\"number\">0755</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /debug_ramdisk is used to preserve additional files from the debug ramdisk</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, <span class=\"string\">&quot;/debug_ramdisk&quot;</span>, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// /second_stage_resources is used to preserve files from first to second</span></span><br><span class=\"line\">    <span class=\"comment\">// stage init</span></span><br><span class=\"line\">    CHECKCALL(mount(<span class=\"string\">&quot;tmpfs&quot;</span>, kSecondStageRes, <span class=\"string\">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class=\"line\">                    <span class=\"string\">&quot;mode=0755,uid=0,gid=0&quot;</span>))</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">undef</span> CHECKCALL</span></span><br><span class=\"line\"></span><br><span class=\"line\">    SetStdioToDevNull(argv);</span><br><span class=\"line\">    <span class=\"comment\">// Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually</span></span><br><span class=\"line\">    <span class=\"comment\">// talk to the outside world...</span></span><br><span class=\"line\">    InitKernelLogging(argv);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!errors.empty()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; [error_string, error_errno] : errors) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; error_string &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; strerror(error_errno);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Init encountered errors starting first stage, aborting&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    LOG(INFO) &lt;&lt; <span class=\"string\">&quot;init first stage started!&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init</span></span><br><span class=\"line\">    <span class=\"comment\">//  selinux_setup,  SetupSelinux  SELinux  [2.3]</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;selinux_setup&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">auto</span> fd = open(<span class=\"string\">&quot;/dev/kmsg&quot;</span>, O_WRONLY | O_CLOEXEC);</span><br><span class=\"line\">    dup2(fd, STDOUT_FILENO);</span><br><span class=\"line\">    dup2(fd, STDERR_FILENO);</span><br><span class=\"line\">    close(fd);</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// execv() only returns if an error happened, in which case we</span></span><br><span class=\"line\">    <span class=\"comment\">// panic and never fall through this conditional.</span></span><br><span class=\"line\">    PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;execv(\\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class=\"string\">&quot;\\&quot;) failed&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>/system/bin/init</code> main  <code>&quot;selinux_setup&quot;</code> SetupSelinux  SELinux </p>\n<h3 id=\"2-2-1-\"><a href=\"#2-2-1-\" class=\"headerlink\" title=\"2.2.1 \"></a>2.2.1 </h3><p> Linux <code>chmod</code> </p>\n<p></p>\n<h4 id=\"2-2-1-1-\"><a href=\"#2-2-1-1-\" class=\"headerlink\" title=\"2.2.1.1 \"></a>2.2.1.1 </h4><p> 10 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-rwxrwxrwx</span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li><code>-</code></li>\n<li><code>d</code></li>\n<li><code>c</code></li>\n</ul>\n<p> 9  3 </p>\n<p>3  1  2  3 </p>\n<ul>\n<li> 1  <code>r</code> <code>-</code></li>\n<li> 2  <code>w</code> <code>-</code></li>\n<li> 3  <code>x</code> <code>-</code></li>\n</ul>\n<p><code>-rwxrw-r--</code> </p>\n<h4 id=\"2-2-1-2-\"><a href=\"#2-2-1-2-\" class=\"headerlink\" title=\"2.2.1.2 \"></a>2.2.1.2 </h4><p> 4  1  3 </p>\n<p> 3  3 </p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1004</td>\n<td align=\"center\">r</td>\n</tr>\n<tr>\n<td align=\"center\">0102</td>\n<td align=\"center\">w</td>\n</tr>\n<tr>\n<td align=\"center\">0011</td>\n<td align=\"center\">x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\">-</td>\n</tr>\n</tbody></table>\n<p> 0~7</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1117</td>\n<td align=\"center\">rwx</td>\n</tr>\n<tr>\n<td align=\"center\">1106</td>\n<td align=\"center\">rw-</td>\n</tr>\n<tr>\n<td align=\"center\">1015</td>\n<td align=\"center\">r-x</td>\n</tr>\n<tr>\n<td align=\"center\">0000</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">-rwxrwxrwx</td>\n<td align=\"center\">0777</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">-rwxrw-r</td>\n<td align=\"center\">0764</td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<h4 id=\"2-2-1-3-\"><a href=\"#2-2-1-3-\" class=\"headerlink\" title=\"2.2.1.3 \"></a>2.2.1.3 </h4><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw commandline to unprivileged processes.</span></span><br><span class=\"line\">CHECKCALL(chmod(<span class=\"string\">&quot;/proc/cmdline&quot;</span>, <span class=\"number\">0440</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Don&#x27;t expose the raw bootconfig to unprivileged processes.</span></span><br><span class=\"line\">chmod(<span class=\"string\">&quot;/proc/bootconfig&quot;</span>, <span class=\"number\">0440</span>);</span><br></pre></td></tr></table></figure>\n<p> <code>chmod</code>  <code>/proc/cmdline</code><code>/proc/bootconfig</code>  <code>0440</code> root  () </p>\n<h2 id=\"2-3--SELinux\"><a href=\"#2-3--SELinux\" class=\"headerlink\" title=\"2.3  SELinux\"></a>2.3  SELinux</h2><!-- TODO:  SELinux -->\n\n<p> <code>int SetupSelinux(char** argv)</code>  SELinux  <code>system/core/init/selinux.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// This function initializes SELinux then execs init to run in the init SELinux context.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SetupSelinux</span><span class=\"params\">(<span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Set up SELinux, loading the SELinux policy.</span></span><br><span class=\"line\">    <span class=\"comment\">//  SELinux</span></span><br><span class=\"line\">    SelinuxSetupKernelLogging();</span><br><span class=\"line\">    SelinuxInitialize();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  /system/bin/init</span></span><br><span class=\"line\">    <span class=\"comment\">//  second_stage,  SecondStageMain  [2.4]</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* path = <span class=\"string\">&quot;/system/bin/init&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* args[] = &#123;path, <span class=\"string\">&quot;second_stage&quot;</span>, <span class=\"literal\">nullptr</span>&#125;;</span><br><span class=\"line\">    execv(path, <span class=\"keyword\">const_cast</span>&lt;<span class=\"keyword\">char</span>**&gt;(args));</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> SELinux <code>/system/bin/init</code> main  <code>&quot;second_stage&quot;</code> SecondStageMain </p>\n<h2 id=\"2-4-\"><a href=\"#2-4-\" class=\"headerlink\" title=\"2.4 \"></a>2.4 </h2><!-- TODO: property_load_boot_defaults -->\n\n<!-- TODO: , android  build.prop  -->\n\n<!-- TODO: SELinux  -->\n\n<!-- TODO: keyctl_get_keyring_ID(KEY_SPEC_SESSION_KEYRING, 1) -->\n\n<!-- TODO: InitializeSubcontext() -->\n\n<!-- TODO: ActionManager  ServiceList  -->\n\n<p> <code>int SecondStageMain(int argc, char** argv)</code>  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Set init and its forked children&#x27;s oom_adj.</span></span><br><span class=\"line\">    <span class=\"comment\">//  init  fork  oom_score_adj </span></span><br><span class=\"line\">    <span class=\"comment\">// , </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = WriteFile(<span class=\"string\">&quot;/proc/1/oom_score_adj&quot;</span>, <span class=\"string\">&quot;-1000&quot;</span>); !result) &#123;</span><br><span class=\"line\">        LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to write -1000 to /proc/1/oom_score_adj: &quot;</span> &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.2.1]</span></span><br><span class=\"line\">    property_init();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll [2.4.1.1]</span></span><br><span class=\"line\">    Epoll epoll;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Open(); !result) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll  init  [2.4.3.1.3]</span></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    InstallSignalFdHandler(&amp;epoll);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.2.2]</span></span><br><span class=\"line\">    StartPropertyService(&amp;epoll);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\">    ServiceList&amp; sm = ServiceList::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.4]</span></span><br><span class=\"line\">    LoadBootScripts(am, sm);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action [2.4.5.1]</span></span><br><span class=\"line\">    am.QueueBuiltinAction(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class=\"string\">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    am.QueueBuiltinAction(queue_property_triggers_action, <span class=\"string\">&quot;queue_property_triggers&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  [2.4.5]</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = <span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (do_shutdown &amp;&amp; !shutting_down) &#123;</span><br><span class=\"line\">            do_shutdown = <span class=\"literal\">false</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (HandlePowerctlMessage(shutdown_command)) &#123;</span><br><span class=\"line\">                shutting_down = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            am.ExecuteOneCommand();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!shutting_down) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">auto</span> next_process_action_time = HandleProcessActions();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (next_process_action_time) &#123;</span><br><span class=\"line\">                    epoll_timeout = <span class=\"built_in\">std</span>::chrono::<span class=\"built_in\">ceil</span>&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;(</span><br><span class=\"line\">                            *next_process_action_time - boot_clock::now());</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (*epoll_timeout &lt; <span class=\"number\">0</span>ms) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (am.HasMoreCommands()) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> 5 </p>\n<ul>\n<li><p>epoll</p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p> 5 </p>\n<h3 id=\"2-4-1-epoll\"><a href=\"#2-4-1-epoll\" class=\"headerlink\" title=\"2.4.1 epoll\"></a>2.4.1 epoll</h3><p>epoll  Linux  I/O epoll </p>\n<h4 id=\"2-4-1-1-\"><a href=\"#2-4-1-1-\" class=\"headerlink\" title=\"2.4.1.1 \"></a>2.4.1.1 </h4><p> init epoll </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Epoll epoll;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Open(); !result) &#123;</span><br><span class=\"line\">    PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>epoll  Open  <code>system/core/init/epoll.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::Open</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_fd_ &gt;= <span class=\"number\">0</span>) <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    epoll_fd_.reset(epoll_create1(EPOLL_CLOEXEC));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_fd_ == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_create1 failed&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>epoll_create1</code><code>epoll_create1</code>  epoll </p>\n<h4 id=\"2-4-1-2--epoll-\"><a href=\"#2-4-1-2--epoll-\" class=\"headerlink\" title=\"2.4.1.2  epoll \"></a>2.4.1.2  epoll </h4><p> epoll  RegisterHandler  epoll</p>\n<p> <code>system/core/init/epoll.cpp</code> epoll_ctl</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler, <span class=\"keyword\">uint32_t</span> events)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &amp;ev) == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> epoll_ctl </p>\n<h5 id=\"2-4-1-2-1--epoll-ctl\"><a href=\"#2-4-1-2-1--epoll-ctl\" class=\"headerlink\" title=\"2.4.1.2.1  epoll_ctl\"></a>2.4.1.2.1  epoll_ctl</h5><p><strong>epoll_ctl</strong>  <code>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)</code> fd </p>\n<h6 id=\"2-4-1-2-1-1-\"><a href=\"#2-4-1-2-1-1-\" class=\"headerlink\" title=\"2.4.1.2.1.1 \"></a>2.4.1.2.1.1 </h6><p> epoll_ctl </p>\n<ul>\n<li><p><strong>epfd</strong>  epoll </p>\n</li>\n<li><p><strong>op</strong> </p>\n<ul>\n<li><p><strong>EPOLL_CTL_ADD</strong></p>\n<p> epoll </p>\n</li>\n<li><p><strong>EPOLL_CTL_MOD</strong></p>\n<p> epoll </p>\n</li>\n<li><p><strong>EPOLL_CTL_DEL</strong></p>\n<p> epoll </p>\n</li>\n</ul>\n</li>\n<li><p><strong>fd</strong> </p>\n</li>\n<li><p><strong>event</strong>  epoll_event  epoll_event </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">epoll_event</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">uint32_t</span>     events;      <span class=\"comment\">/* Epoll events */</span></span><br><span class=\"line\">   <span class=\"keyword\">epoll_data_t</span> data;        <span class=\"comment\">/* User data variable */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code> </p>\n<ul>\n<li><p>\u0015\u0015<strong>EPOLLIN</strong><br></p>\n</li>\n<li><p><strong>EPOLLOUT</strong><br></p>\n</li>\n<li><p><strong>EPOLLPRI</strong><br></p>\n</li>\n<li><p><strong>EPOLLERR</strong><br></p>\n</li>\n<li><p><strong>EPOLLHUP</strong><br></p>\n</li>\n<li><p><strong>EPOLLONESHOT</strong><br>epoll <br> epoll_ctl EPOLL_CTL_MOD </p>\n</li>\n</ul>\n<p> <code>data</code>  [2.4.1.3]<code>epoll_data_t</code> </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">epoll_data</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">void</span>        *ptr;</span><br><span class=\"line\">   <span class=\"keyword\">int</span>          fd;</span><br><span class=\"line\">   <span class=\"keyword\">uint32_t</span>     u32;</span><br><span class=\"line\">   <span class=\"keyword\">uint64_t</span>     u64;</span><br><span class=\"line\">&#125; <span class=\"keyword\">epoll_data_t</span>;</span><br></pre></td></tr></table></figure>\n\n\n</li>\n</ul>\n<h6 id=\"2-4-1-2-1-2-\"><a href=\"#2-4-1-2-1-2-\" class=\"headerlink\" title=\"2.4.1.2.1.2 \"></a>2.4.1.2.1.2 </h6><p> epoll_ctl </p>\n<ul>\n<li><p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-1-2-2--RegisterHandler-\"><a href=\"#2-4-1-2-2--RegisterHandler-\" class=\"headerlink\" title=\"2.4.1.2.2  RegisterHandler \"></a>2.4.1.2.2  RegisterHandler </h5><p> epoll_ctl  RegisterHandler  <code>system/core/init/epoll.h</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Epoll</span> &#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\">Result&lt;Success&gt; <span class=\"title\">RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                    <span class=\"keyword\">uint32_t</span> events = EPOLLIN)</span></span>;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code>  <code>EPOLLIN</code></p>\n<p> RegisterHandler </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::RegisterHandler</span><span class=\"params\">(<span class=\"keyword\">int</span> fd, <span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt; handler, <span class=\"keyword\">uint32_t</span> events)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// handler </span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> [it, inserted] = epoll_handlers_.emplace(fd, <span class=\"built_in\">std</span>::move(handler));</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_event ev;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"comment\">//  events  EPOLLIN, </span></span><br><span class=\"line\">    ev.events = events;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">// ,  [2.4.1.3.2]</span></span><br><span class=\"line\">    ev.data.ptr = <span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"keyword\">void</span>*&gt;(&amp;it-&gt;second);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll_ctl </span></span><br><span class=\"line\">    <span class=\"comment\">//  EPOLL_CTL_ADD, </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (epoll_ctl(epoll_fd_, EPOLL_CTL_ADD, fd, &amp;ev) == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        Result&lt;Success&gt; result = ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_ctl failed to add fd&quot;</span>;</span><br><span class=\"line\">        epoll_handlers_.erase(fd);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>events</code>  <code>handler</code> <code>epoll_ctl</code>  epoll </p>\n<h4 id=\"2-4-1-3-\"><a href=\"#2-4-1-3-\" class=\"headerlink\" title=\"2.4.1.3 \"></a>2.4.1.3 </h4><p> epoll  epoll </p>\n<p> init </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> Wait </p>\n<h5 id=\"2-4-1-3-1--epoll-wait\"><a href=\"#2-4-1-3-1--epoll-wait\" class=\"headerlink\" title=\"2.4.1.3.1  epoll_wait\"></a>2.4.1.3.1  epoll_wait</h5><p> Wait  epoll_wait Wait </p>\n<p><strong>epoll_wait</strong>  <code>int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout)</code> epoll </p>\n<p> epoll_wait </p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<h6 id=\"2-4-1-3-1-1-\"><a href=\"#2-4-1-3-1-1-\" class=\"headerlink\" title=\"2.4.1.3.1.1 \"></a>2.4.1.3.1.1 </h6><p> epoll_wait </p>\n<ul>\n<li><p><strong>epfd</strong>  epoll </p>\n</li>\n<li><p><strong>events</strong>  epoll_event  epoll_event  [2.4.1.2.1] </p>\n<p> events  epoll_event  data  epoll_ctl  data  epoll_ctl  event.data  epoll_wait </p>\n</li>\n<li><p><strong>maxevents</strong>  events  maxevents</p>\n</li>\n<li><p><strong>timeout</strong>  timeout = -1  timeout = 0 </p>\n</li>\n</ul>\n<h6 id=\"2-4-1-3-1-2-\"><a href=\"#2-4-1-3-1-2-\" class=\"headerlink\" title=\"2.4.1.3.1.2 \"></a>2.4.1.3.1.2 </h6><p> epoll_wait </p>\n<ul>\n<li><p> I/O </p>\n<p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-1-3-2--Wait-\"><a href=\"#2-4-1-3-2--Wait-\" class=\"headerlink\" title=\"2.4.1.3.2  Wait \"></a>2.4.1.3.2  Wait </h5><p> epoll_wait  Wait  <code>system/core/init/epoll.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">Result&lt;Success&gt; <span class=\"title\">Epoll::Wait</span><span class=\"params\">(<span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt; timeout)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  -1</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> timeout_ms = <span class=\"number\">-1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (timeout &amp;&amp; timeout-&gt;count() &lt; INT_MAX) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  timeout  0 , </span></span><br><span class=\"line\">        timeout_ms = timeout-&gt;count();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    epoll_event ev;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  epoll_wait </span></span><br><span class=\"line\">    <span class=\"comment\">//  1,  1 </span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd_, &amp;ev, <span class=\"number\">1</span>, timeout_ms));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (nr == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  -1, </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> ErrnoError() &lt;&lt; <span class=\"string\">&quot;epoll_wait failed&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (nr == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  1, ,  1 </span></span><br><span class=\"line\">        <span class=\"comment\">// ev.data.ptr  epoll_ctl , </span></span><br><span class=\"line\">        <span class=\"built_in\">std</span>::invoke(*<span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"built_in\">std</span>::function&lt;<span class=\"keyword\">void</span>()&gt;*&gt;(ev.data.ptr));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>epoll_wait</code>  <code>epoll_wait</code>  epoll_ctl </p>\n<h3 id=\"2-4-2-\"><a href=\"#2-4-2-\" class=\"headerlink\" title=\"2.4.2 \"></a>2.4.2 </h3><p> Android  key-value </p>\n<p> adb <code>getprop</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ro.product.brand]: [Redmi]</span><br><span class=\"line\">[ro.product.manufacturer]: [Xiaomi]</span><br><span class=\"line\">[ro.product.marketname]: [Redmi K30S Ultra]</span><br><span class=\"line\">[ro.product.model]: [M2007J3SC]</span><br><span class=\"line\">[ro.product.name]: [apollo]</span><br><span class=\"line\"></span><br><span class=\"line\">[ro.product.cpu.abi]: [arm64-v8a]</span><br><span class=\"line\">[ro.product.cpu.abilist]: [arm64-v8a,armeabi-v7a,armeabi]</span><br><span class=\"line\">[ro.product.cpu.abilist32]: [armeabi-v7a,armeabi]</span><br><span class=\"line\">[ro.product.cpu.abilist64]: [arm64-v8a]</span><br><span class=\"line\"></span><br><span class=\"line\">[dalvik.vm.heapsize]: [512m]</span><br><span class=\"line\">[dalvik.vm.heapstartsize]: [8m]</span><br></pre></td></tr></table></figure>\n<p>CPU </p>\n<p> Java  <code>SystemProperties.get(String, String)</code>  ActivityManager </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">staticGetLargeMemoryClass</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  dalvik.vm.heapsize, </span></span><br><span class=\"line\">    String vmHeapSize = SystemProperties.get(<span class=\"string\">&quot;dalvik.vm.heapsize&quot;</span>, <span class=\"string\">&quot;16m&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> Integer.parseInt(vmHeapSize.substring(<span class=\"number\">0</span>, vmHeapSize.length() - <span class=\"number\">1</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>SystemProperties.set(String, String)</code>  ActivityManagerService </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">finishBooting</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Tell anyone interested that we are done booting!</span></span><br><span class=\"line\">        <span class=\"comment\">//  sys.boot_completed = 1, </span></span><br><span class=\"line\">        SystemProperties.set(<span class=\"string\">&quot;sys.boot_completed&quot;</span>, <span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"2-4-2-1-\"><a href=\"#2-4-2-1-\" class=\"headerlink\" title=\"2.4.2.1 \"></a>2.4.2.1 </h4><!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: CreateSerializedPropertyInfo() -->\n\n<!-- TODO: property_info_area.LoadDefaultPath() -->\n\n<p> property_init  <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">property_init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    mkdir(<span class=\"string\">&quot;/dev/__properties__&quot;</span>, S_IRWXU | S_IXGRP | S_IXOTH);</span><br><span class=\"line\">    CreateSerializedPropertyInfo();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (__system_property_area_init()) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Failed to initialize property area&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!property_info_area.LoadDefaultPath()) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;Failed to load serialized property info file&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>__system_property_area_init</code> </p>\n<h4 id=\"2-4-2-2-\"><a href=\"#2-4-2-2-\" class=\"headerlink\" title=\"2.4.2.2 \"></a>2.4.2.2 </h4><!-- TODO: socket  -->\n\n<!-- TODO: listen(property_set_fd, 8) -->\n\n<!-- TODO:  init  -->\n\n<p> StartPropertyService  <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">StartPropertyService</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  socket ,  PROP_SERVICE_NAME = &quot;property_service&quot;</span></span><br><span class=\"line\">    property_set_fd = CreateSocket(PROP_SERVICE_NAME, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK,</span><br><span class=\"line\">                                   <span class=\"literal\">false</span>, <span class=\"number\">0666</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"literal\">nullptr</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (property_set_fd == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;start_property_service socket creation failed&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    listen(property_set_fd, <span class=\"number\">8</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  socket  epoll,  [2.4.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">// handle_property_set_fd  [2.4.2.3]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll-&gt;RegisterHandler(property_set_fd, handle_property_set_fd); !result) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> property_service  socket socket  epoll</p>\n<p> <code>handle_property_set_fd</code></p>\n<h4 id=\"2-4-2-3--handle-property-set-fd\"><a href=\"#2-4-2-3--handle-property-set-fd\" class=\"headerlink\" title=\"2.4.2.3  handle_property_set_fd\"></a>2.4.2.3  handle_property_set_fd</h4><!-- TODO: ucred cr; socklen_t cr_size = sizeof(cr); -->\n\n<!-- TODO:  -->\n\n<!-- TODO:  init ,  -->\n\n<!-- TODO:  -->\n\n<p> <code>system/core/init/property_service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">handle_property_set_fd</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 2000ms</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">constexpr</span> <span class=\"keyword\">uint32_t</span> kDefaultSocketTimeout = <span class=\"number\">2000</span>; <span class=\"comment\">/* ms */</span></span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">SocketConnection <span class=\"title\">socket</span><span class=\"params\">(s, cr)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  2000ms </span></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> timeout_ms = kDefaultSocketTimeout;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> cmd = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!socket.RecvUint32(&amp;cmd, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop: error while reading command from the socket&quot;</span>;</span><br><span class=\"line\">        socket.SendUint32(PROP_ERROR_READ_CMD);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (cmd) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//  PROP_MSG_SETPROP </span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> PROP_MSG_SETPROP: &#123;</span><br><span class=\"line\">        <span class=\"comment\">// PROP_NAME_MAX = 32</span></span><br><span class=\"line\">        <span class=\"keyword\">char</span> prop_name[PROP_NAME_MAX];</span><br><span class=\"line\">        <span class=\"keyword\">char</span> prop_value[PROP_VALUE_MAX];</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ,  prop_name  prop_value </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!socket.RecvChars(prop_name, PROP_NAME_MAX, &amp;timeout_ms) ||</span><br><span class=\"line\">            !socket.RecvChars(prop_value, PROP_VALUE_MAX, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">          PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop(PROP_MSG_SETPROP): error while reading name/value from the socket&quot;</span>;</span><br><span class=\"line\">          <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  0</span></span><br><span class=\"line\">        prop_name[PROP_NAME_MAX<span class=\"number\">-1</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\">        prop_value[PROP_VALUE_MAX<span class=\"number\">-1</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; cr = socket.cred();</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> error;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> result =</span><br><span class=\"line\">            HandlePropertySet(prop_name, prop_value, socket.source_context(), cr, &amp;error);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != PROP_SUCCESS) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to set property &#x27;&quot;</span> &lt;&lt; prop_name &lt;&lt; <span class=\"string\">&quot;&#x27; to &#x27;&quot;</span> &lt;&lt; prop_value</span><br><span class=\"line\">                       &lt;&lt; <span class=\"string\">&quot;&#x27; from uid:&quot;</span> &lt;&lt; cr.uid &lt;&lt; <span class=\"string\">&quot; gid:&quot;</span> &lt;&lt; cr.gid &lt;&lt; <span class=\"string\">&quot; pid:&quot;</span> &lt;&lt; cr.pid &lt;&lt; <span class=\"string\">&quot;: &quot;</span></span><br><span class=\"line\">                       &lt;&lt; error;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  PROP_MSG_SETPROP2 </span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> PROP_MSG_SETPROP2: &#123;</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> name;</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!socket.RecvString(&amp;name, &amp;timeout_ms) ||</span><br><span class=\"line\">            !socket.RecvString(&amp;value, &amp;timeout_ms)) &#123;</span><br><span class=\"line\">          PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop(PROP_MSG_SETPROP2): error while reading name/value from the socket&quot;</span>;</span><br><span class=\"line\">          socket.SendUint32(PROP_ERROR_READ_DATA);</span><br><span class=\"line\">          <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; cr = socket.cred();</span><br><span class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> error;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">uint32_t</span> result = HandlePropertySet(name, value, socket.source_context(), cr, &amp;error);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result != PROP_SUCCESS) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Unable to set property &#x27;&quot;</span> &lt;&lt; name &lt;&lt; <span class=\"string\">&quot;&#x27; to &#x27;&quot;</span> &lt;&lt; value</span><br><span class=\"line\">                       &lt;&lt; <span class=\"string\">&quot;&#x27; from uid:&quot;</span> &lt;&lt; cr.uid &lt;&lt; <span class=\"string\">&quot; gid:&quot;</span> &lt;&lt; cr.gid &lt;&lt; <span class=\"string\">&quot; pid:&quot;</span> &lt;&lt; cr.pid &lt;&lt; <span class=\"string\">&quot;: &quot;</span></span><br><span class=\"line\">                       &lt;&lt; error;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        socket.SendUint32(result);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;sys_prop: invalid command &quot;</span> &lt;&lt; cmd;</span><br><span class=\"line\">        socket.SendUint32(PROP_ERROR_INVALID_CMD);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> socket  <code>cmd</code> </p>\n<ul>\n<li> <code>PROP_MSG_SETPROP</code>  <code>PROP_NAME_MAX</code>  0 <code>PROP_NAME_MAX - 1</code> </li>\n<li> <code>PROP_MSG_SETPROP2</code>  <code>std::string</code> </li>\n</ul>\n<p> <code>PROP_MSG_SETPROP</code>  <code>PROP_MSG_SETPROP2</code>  <code>HandlePropertySet</code> </p>\n<h3 id=\"2-4-3-\"><a href=\"#2-4-3-\" class=\"headerlink\" title=\"2.4.3 \"></a>2.4.3 </h3><p><strong> (Signals)</strong>  IPC </p>\n<p><strong></strong></p>\n<h4 id=\"2-4-3-1-\"><a href=\"#2-4-3-1-\" class=\"headerlink\" title=\"2.4.3.1 \"></a>2.4.3.1 </h4><p> Linux (PID) waitwaitpid  waitid ** (Zombie process)**</p>\n<p> init init </p>\n<p> [2.4.4] init  fork servicemanager zygote  Android init </p>\n<p>init </p>\n<p> Android Linux </p>\n<h5 id=\"2-4-3-1-1-\"><a href=\"#2-4-3-1-1-\" class=\"headerlink\" title=\"2.4.3.1.1 \"></a>2.4.3.1.1 </h5><!-- :  -->\n\n<p></p>\n<ul>\n<li><strong></strong></li>\n<li><strong></strong></li>\n<li><strong></strong></li>\n</ul>\n<p>init </p>\n<p></p>\n<h5 id=\"2-4-3-1-2--sigaction\"><a href=\"#2-4-3-1-2--sigaction\" class=\"headerlink\" title=\"2.4.3.1.2  sigaction\"></a>2.4.3.1.2  sigaction</h5><p> init  sigaction</p>\n<p><strong>sigaction</strong>  <code>int sigaction(int signum, const struct sigaction *restrict act, struct sigaction *restrict oldact)</code></p>\n<h6 id=\"2-4-3-1-2-1-\"><a href=\"#2-4-3-1-2-1-\" class=\"headerlink\" title=\"2.4.3.1.2.1 \"></a>2.4.3.1.2.1 </h6><p> sigaction </p>\n<ul>\n<li><p><strong>signum</strong> </p>\n<p> AndroidARM  <code>bionic/libc/kernel/uapi/asm-arm/asm/signal.h</code> </p>\n</li>\n<li><p><strong>act</strong>  sigaction  sigaction </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> &#123;</span></span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_handler)(<span class=\"keyword\">int</span>);</span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_sigaction)(<span class=\"keyword\">int</span>, <span class=\"keyword\">siginfo_t</span> *, <span class=\"keyword\">void</span> *);</span><br><span class=\"line\">   <span class=\"keyword\">sigset_t</span>   sa_mask;</span><br><span class=\"line\">   <span class=\"keyword\">int</span>        sa_flags;</span><br><span class=\"line\">   <span class=\"keyword\">void</span>     (*sa_restorer)(<span class=\"keyword\">void</span>);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p> <code>sa_handler</code>  <code>sa_flags</code></p>\n<p> <code>sa_handler</code> </p>\n<ul>\n<li><p><strong>SIG_DFL</strong></p>\n<p></p>\n</li>\n<li><p><strong>SIG_IGN</strong></p>\n<p></p>\n</li>\n<li><p><strong></strong></p>\n<p> signum </p>\n</li>\n</ul>\n<p> <code>sa_flags</code> </p>\n<ul>\n<li><p><strong>SA_NOCLDSTOP</strong></p>\n<p> signum = SIGCHLD </p>\n</li>\n<li><p><strong>SA_RESETHAND</strong></p>\n<p></p>\n</li>\n<li><p><strong>SA_SIGINFO</strong></p>\n<p> sa_handler  sa_sigaction</p>\n</li>\n</ul>\n</li>\n<li><p><strong>oldact</strong>  sigaction  sigaction  act</p>\n</li>\n</ul>\n<h6 id=\"2-4-3-1-2-2-\"><a href=\"#2-4-3-1-2-2-\" class=\"headerlink\" title=\"2.4.3.1.2.2 \"></a>2.4.3.1.2.2 </h6><p> sigaction </p>\n<ul>\n<li><p> 0</p>\n</li>\n<li><p> -1</p>\n</li>\n</ul>\n<h5 id=\"2-4-3-1-3-init-\"><a href=\"#2-4-3-1-3-init-\" class=\"headerlink\" title=\"2.4.3.1.3 init \"></a>2.4.3.1.3 init </h5><p> sigaction  init </p>\n<h6 id=\"2-4-3-1-3-1--sigaction\"><a href=\"#2-4-3-1-3-1--sigaction\" class=\"headerlink\" title=\"2.4.3.1.3.1  sigaction\"></a>2.4.3.1.3.1  sigaction</h6><p>init  InstallSignalFdHandler  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">InstallSignalFdHandler</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//  sigaction</span></span><br><span class=\"line\">    <span class=\"comment\">//  sa_handler ,  sa_handler = SIG_DFL </span></span><br><span class=\"line\">    <span class=\"comment\">//  sa_flags ,  sa_flags = SA_NOCLDSTOP  init , </span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> <span class=\"title\">act</span> &#123;</span> .sa_handler = SIG_DFL, .sa_flags = SA_NOCLDSTOP &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// sigaction ,  [2.4.3.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">//  SIGCHLD,  SIGCHLD, , , , </span></span><br><span class=\"line\">    sigaction(SIGCHLD, &amp;act, <span class=\"literal\">nullptr</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> sigaction <code>SIGCHLD</code>  <code>SIGCHLD</code> </p>\n<p> <code>SIGCHLD</code>  <code>SA_NOCLDSTOP</code>  init </p>\n<p>init  signal  InstallSignalFdHandler </p>\n<h6 id=\"2-4-3-1-3-2--signal-\"><a href=\"#2-4-3-1-3-2--signal-\" class=\"headerlink\" title=\"2.4.3.1.3.2  signal \"></a>2.4.3.1.3.2  signal </h6><p></p>\n<p>Linux  signalfd</p>\n<p>init </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">InstallSignalFdHandler</span><span class=\"params\">(Epoll* epoll)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// mask , </span></span><br><span class=\"line\">    <span class=\"comment\">// ,  SIGCHLD</span></span><br><span class=\"line\">    <span class=\"keyword\">sigset_t</span> mask;</span><br><span class=\"line\">    sigemptyset(&amp;mask);</span><br><span class=\"line\">    sigaddset(&amp;mask, SIGCHLD);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal </span></span><br><span class=\"line\">    <span class=\"comment\">// ,  signalfd ,  -1, </span></span><br><span class=\"line\">    signal_fd = signalfd(<span class=\"number\">-1</span>, &amp;mask, SFD_CLOEXEC);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (signal_fd == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        PLOG(FATAL) &lt;&lt; <span class=\"string\">&quot;failed to create signalfd&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal  epoll,  [2.4.1.2]</span></span><br><span class=\"line\">    <span class=\"comment\">// HandleSignalFd  [2.4.3.1.4]</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll-&gt;RegisterHandler(signal_fd, HandleSignalFd); !result) &#123;</span><br><span class=\"line\">        LOG(FATAL) &lt;&lt; result.error();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> <code>SIGCHLD</code> signal  epoll</p>\n<p> signal  HandleSignalFd </p>\n<h5 id=\"2-4-3-1-4--HandleSignalFd\"><a href=\"#2-4-3-1-4--HandleSignalFd\" class=\"headerlink\" title=\"2.4.3.1.4  HandleSignalFd\"></a>2.4.3.1.4  HandleSignalFd</h5><p> <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">HandleSignalFd</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    signalfd_siginfo siginfo;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  signal  signalfd_siginfo, </span></span><br><span class=\"line\">    <span class=\"keyword\">ssize_t</span> bytes_read = TEMP_FAILURE_RETRY(read(signal_fd, &amp;siginfo, <span class=\"keyword\">sizeof</span>(siginfo)));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bytes_read != <span class=\"keyword\">sizeof</span>(siginfo)) &#123;</span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Failed to read siginfo from signal_fd&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (siginfo.ssi_signo) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SIGCHLD:</span><br><span class=\"line\">            ReapAnyOutstandingChildren();</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SIGTERM:</span><br><span class=\"line\">            HandleSigtermSignal(siginfo);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;signal_fd: received unexpected signal &quot;</span> &lt;&lt; siginfo.ssi_signo;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>signal  signalfd_siginfo HandleSignalFd  signal  signalfd_siginfo</p>\n<p> <code>SIGCHLD</code> ReapAnyOutstandingChildren </p>\n<h6 id=\"2-4-3-1-4-1--ReapAnyOutstandingChildren-\"><a href=\"#2-4-3-1-4-1--ReapAnyOutstandingChildren-\" class=\"headerlink\" title=\"2.4.3.1.4.1  ReapAnyOutstandingChildren \"></a>2.4.3.1.4.1  ReapAnyOutstandingChildren </h6><p> <code>system/core/init/sigchld_handler.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">ReapAnyOutstandingChildren</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (ReapOneProcess()) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> ReapOneProcess  ReapOneProcess  false  ReapOneProcess </p>\n<h6 id=\"2-4-3-1-4-2--ReapOneProcess-\"><a href=\"#2-4-3-1-4-2--ReapOneProcess-\" class=\"headerlink\" title=\"2.4.3.1.4.2  ReapOneProcess \"></a>2.4.3.1.4.2  ReapOneProcess </h6><!-- TODO:  service->flags() -->\n\n<!-- TODO:  ServiceList::GetInstance().RemoveService(*service) -->\n\n<p> <code>system/core/init/sigchld_handler.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">bool</span> <span class=\"title\">ReapOneProcess</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">siginfo_t</span> siginfo = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  waitid, </span></span><br><span class=\"line\">    <span class=\"comment\">//  init , ,  siginfo </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (TEMP_FAILURE_RETRY(waitid(P_ALL, <span class=\"number\">0</span>, &amp;siginfo, WEXITED | WNOHANG | WNOWAIT)) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  false</span></span><br><span class=\"line\">        PLOG(ERROR) &lt;&lt; <span class=\"string\">&quot;waitid failed&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  pid</span></span><br><span class=\"line\">    <span class=\"keyword\">auto</span> pid = siginfo.si_pid;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  pid ,  false</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> name;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> wait_string;</span><br><span class=\"line\">    Service* service = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (PropertyChildReap(pid)) &#123;</span><br><span class=\"line\">        name = <span class=\"string\">&quot;Async property child&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (SubcontextChildReap(pid)) &#123;</span><br><span class=\"line\">        name = <span class=\"string\">&quot;Subcontext&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  pid  service</span></span><br><span class=\"line\">        service = ServiceList::GetInstance().FindService(pid, &amp;Service::pid);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (service) &#123;</span><br><span class=\"line\">            name = StringPrintf(<span class=\"string\">&quot;Service &#x27;%s&#x27; (pid %d)&quot;</span>, service-&gt;name().c_str(), pid);</span><br><span class=\"line\"></span><br><span class=\"line\">            ...</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            name = StringPrintf(<span class=\"string\">&quot;Untracked pid %d&quot;</span>, pid);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service,  true</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!service) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service  Reap </span></span><br><span class=\"line\">    service-&gt;Reap(siginfo);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ReapOneProcess  waitid pid  service service  service  Reap  Reap </p>\n<h6 id=\"2-4-3-1-4-3--Reap-\"><a href=\"#2-4-3-1-4-3--Reap-\" class=\"headerlink\" title=\"2.4.3.1.4.3  Reap \"></a>2.4.3.1.4.3  Reap </h6><p> <code>system/core/init/service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Service::Reap</span><span class=\"params\">(<span class=\"keyword\">const</span> <span class=\"keyword\">siginfo_t</span>&amp; siginfo)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(flags_ &amp; SVC_ONESHOT) || (flags_ &amp; SVC_RESTART)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_ONESHOT  SVC_RESTART, </span></span><br><span class=\"line\">        KillProcessGroup(SIGKILL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_TEMPORARY, </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (flags_ &amp; SVC_TEMPORARY) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    pid_ = <span class=\"number\">0</span>;</span><br><span class=\"line\">    flags_ &amp;= (~SVC_RUNNING);</span><br><span class=\"line\">    start_order_ = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((flags_ &amp; SVC_ONESHOT) &amp;&amp; !(flags_ &amp; SVC_RESTART) &amp;&amp; !(flags_ &amp; SVC_RESET)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_ONESHOT </span></span><br><span class=\"line\">        flags_ |= SVC_DISABLED;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (flags_ &amp; (SVC_DISABLED | SVC_RESET))  &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_DISABLED  SVC_RESET,  stopped , </span></span><br><span class=\"line\">        NotifyStateChange(<span class=\"string\">&quot;stopped&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_CRITICAL </span></span><br><span class=\"line\">    <span class=\"comment\">//  4  4 , </span></span><br><span class=\"line\">    <span class=\"comment\">//  bootloader </span></span><br><span class=\"line\">    boot_clock::time_point now = boot_clock::now();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (((flags_ &amp; SVC_CRITICAL) || !pre_apexd_) &amp;&amp; !(flags_ &amp; SVC_RESTART)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">bool</span> boot_completed = android::base::GetBoolProperty(<span class=\"string\">&quot;sys.boot_completed&quot;</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (now &lt; time_crashed_ + <span class=\"number\">4</span>min || !boot_completed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (++crash_count_ &gt; <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (flags_ &amp; SVC_CRITICAL) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// Aborts into bootloader</span></span><br><span class=\"line\">                    LOG(FATAL) &lt;&lt; <span class=\"string\">&quot;critical process &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class=\"string\">&quot;&#x27; exited 4 times &quot;</span></span><br><span class=\"line\">                               &lt;&lt; (boot_completed ? <span class=\"string\">&quot;in 4 minutes&quot;</span> : <span class=\"string\">&quot;before boot completed&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;updatable process &#x27;&quot;</span> &lt;&lt; name_ &lt;&lt; <span class=\"string\">&quot;&#x27; exited 4 times &quot;</span></span><br><span class=\"line\">                               &lt;&lt; (boot_completed ? <span class=\"string\">&quot;in 4 minutes&quot;</span> : <span class=\"string\">&quot;before boot completed&quot;</span>);</span><br><span class=\"line\">                    <span class=\"comment\">// Notifies update_verifier and apexd</span></span><br><span class=\"line\">                    property_set(<span class=\"string\">&quot;ro.init.updatable_crashing&quot;</span>, <span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            time_crashed_ = now;</span><br><span class=\"line\">            crash_count_ = <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  SVC_RESTARTING, init  [2.4.5.2]</span></span><br><span class=\"line\">    flags_ &amp;= (~SVC_RESTART);</span><br><span class=\"line\">    flags_ |= SVC_RESTARTING;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  service  onrestart </span></span><br><span class=\"line\">    onrestart_.ExecuteAllCommands();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  restarting </span></span><br><span class=\"line\">    NotifyStateChange(<span class=\"string\">&quot;restarting&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Reap  NotifyStateChange </p>\n<h6 id=\"2-4-3-1-4-4--NotifyStateChange-\"><a href=\"#2-4-3-1-4-4--NotifyStateChange-\" class=\"headerlink\" title=\"2.4.3.1.4.4  NotifyStateChange \"></a>2.4.3.1.4.4  NotifyStateChange </h6><p> <code>system/core/init/service.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">Service::NotifyStateChange</span><span class=\"params\">(<span class=\"keyword\">const</span> <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span>&amp; new_state)</span> <span class=\"keyword\">const</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((flags_ &amp; SVC_TEMPORARY) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  SVC_TEMPORARY, </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> prop_name = <span class=\"string\">&quot;init.svc.&quot;</span> + name_;</span><br><span class=\"line\">    property_set(prop_name, new_state);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> key-value  key  init.svc.[service_name]value  adb <code>getprop | grep init.svc.</code> service </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[init.svc.adbd]: [running]</span><br><span class=\"line\">[init.svc.alarm-hal-1-0]: [running]</span><br><span class=\"line\">[init.svc.android.thermal-hal]: [running]</span><br><span class=\"line\">[init.svc.apexd]: [stopped]</span><br><span class=\"line\">[init.svc.apexd-bootstrap]: [stopped]</span><br><span class=\"line\">[init.svc.apexd-snapshotde]: [stopped]</span><br><span class=\"line\">[init.svc.audioserver]: [running]</span><br><span class=\"line\">[init.svc.wifidisplayhalservice]: [running]</span><br><span class=\"line\">[init.svc.wpa_supplicant]: [running]</span><br><span class=\"line\">[init.svc.zygote]: [running]</span><br><span class=\"line\">[init.svc.zygote_secondary]: [running]</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"2-4-4-\"><a href=\"#2-4-4-\" class=\"headerlink\" title=\"2.4.4 \"></a>2.4.4 </h3><!-- TODO:  CreateParser -->\n\n<!-- TODO: .rc  -->\n\n<!-- TODO:  -->\n\n<!-- TODO: /system/etc/init -->\n\n<!-- TODO: /odm/etc/init -->\n\n<!-- TODO: /vendor/etc/init -->\n\n<p> LoadBootScripts  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">LoadBootScripts</span><span class=\"params\">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> </span>&#123;</span><br><span class=\"line\">    Parser parser = CreateParser(action_manager, service_list);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootscript = GetProperty(<span class=\"string\">&quot;ro.boot.init_rc&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootscript.empty()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  init.rc  [2.4.4.1]</span></span><br><span class=\"line\">        parser.ParseConfig(<span class=\"string\">&quot;/init.rc&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /system/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/system/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/system/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /product/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /product_services/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/product_services/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /odm/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/odm/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/odm/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  /vendor/etc/init </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!parser.ParseConfig(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>)) &#123;</span><br><span class=\"line\">            late_import_paths.emplace_back(<span class=\"string\">&quot;/vendor/etc/init&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        parser.ParseConfig(bootscript);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p></p>\n<ul>\n<li><code>init.rc</code>  .rc </li>\n<li><code>/system/etc/init/</code> SurfaceFlinger, MediaService, logcatd</li>\n<li><code>/vendor/etc/init/</code>  SoC  SoC </li>\n<li><code>/odm/etc/init/</code> </li>\n</ul>\n<p>init.rc </p>\n<h4 id=\"2-4-4-1-init-rc-\"><a href=\"#2-4-4-1-init-rc-\" class=\"headerlink\" title=\"2.4.4.1 init.rc \"></a>2.4.4.1 init.rc </h4><p> Android .rc  Android Init Language <a href=\"https://cs.android.com/android/platform/superproject/+/android-security-10.0.0_r56:system/core/init/README.md\"> Android Init Language </a>  AOSP  <code>system/core/init/README.md</code></p>\n<p></p>\n<h5 id=\"2-4-4-1-1-Android-Init-Language\"><a href=\"#2-4-4-1-1-Android-Init-Language\" class=\"headerlink\" title=\"2.4.4.1.1 Android Init Language\"></a>2.4.4.1.1 Android Init Language</h5><p>Android Init Language <code>Actions</code><code>Commands</code><code>Services</code><code>Options</code><code>Imports</code></p>\n<p></p>\n<ul>\n<li> token token </li>\n<li> token  c  <code>\\</code>  token</li>\n<li> <code>\\</code></li>\n<li> <code>#</code> </li>\n<li> <code>$&#123;property.name&#125;</code> <code>import /init.recovery.$&#123;ro.hardware&#125;.rc</code></li>\n<li> section <code>Actions</code>  <code>Services</code>  section <code>Commands</code>  <code>Options</code>  section section  <code>Commands</code>  <code>Options</code> </li>\n<li><code>Services</code>  <code>Services</code> </li>\n</ul>\n<p></p>\n<h6 id=\"2-4-4-1-1-1-Actions\"><a href=\"#2-4-4-1-1-1-Actions\" class=\"headerlink\" title=\"2.4.4.1.1.1 Actions\"></a>2.4.4.1.1.1 Actions</h6><p><code>Actions</code>   <code>Commands</code>  <code>Triggers</code>  <code>Actions</code> </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]*</span><br><span class=\"line\">   &lt;command&gt;</span><br><span class=\"line\">   &lt;command&gt;</span><br><span class=\"line\">   &lt;command&gt;</span><br></pre></td></tr></table></figure>\n<p> <code>Actions</code>   <code>Triggers</code> <code>Actions</code> </p>\n<p> <code>Actions</code>  <code>Actions</code>  <code>Commands</code></p>\n<p> Zygote </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unencrypted</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br></pre></td></tr></table></figure>\n<p></p>\n<p> <code>Actions</code>  <code>Triggers</code> <code>zygote-start</code>  <code>property:ro.crypto.state=unencrypted</code> <code>Command</code></p>\n<p> <code>zygote-start</code>  <code>property:ro.crypto.state=unencrypted</code> <code>Actions</code>  <code>Actions</code>  <code>Commands</code>  <code>Actions</code>  <code>Commands</code></p>\n<h6 id=\"2-4-4-1-1-2-Triggers\"><a href=\"#2-4-4-1-1-2-Triggers\" class=\"headerlink\" title=\"2.4.4.1.1.2 Triggers\"></a>2.4.4.1.1.2 Triggers</h6><p><code>Triggers</code>  <code>Actions</code>  <code>Commands</code></p>\n<p>Triggers </p>\n<ul>\n<li><p><strong>Event triggers</strong></p>\n<p> <code>trigger</code>   <code>QueueEventTrigger()</code> </p>\n</li>\n<li><p><strong>Property triggers</strong></p>\n<p> <code>property:&lt;key&gt;=&lt;value&gt;</code></p>\n</li>\n</ul>\n<p> <code>Actions</code> </p>\n<p></p>\n<p><code>on init &amp;&amp; property:a=b</code><code>on property:a=b &amp;&amp; property:c=d</code> </p>\n<p><code>on boot &amp;&amp; on init</code> </p>\n<h6 id=\"2-4-4-1-1-3-Commands\"><a href=\"#2-4-4-1-1-3-Commands\" class=\"headerlink\" title=\"2.4.4.1.1.3 Commands\"></a>2.4.4.1.1.3 Commands</h6><p> <code>Commands</code></p>\n<ul>\n<li><p><strong>trigger <event></strong></p>\n<p></p>\n</li>\n<li><p><strong>write <path> <content></strong></p>\n<p> path </p>\n</li>\n<li><p><strong>chown <owner> <group> <path></strong></p>\n<p></p>\n</li>\n<li><p><strong>mkdir <path> [mode] [owner] [group]</strong></p>\n<p> </p>\n<p> 755 root  root </p>\n<p></p>\n</li>\n<li><p><strong>start <service></strong></p>\n<p></p>\n</li>\n<li><p><strong>exec_start <service></strong></p>\n<p></p>\n</li>\n<li><p><strong>setprop <name> <value></strong></p>\n<p></p>\n</li>\n<li><p><strong>symlink <target> <path></strong></p>\n<p> path  target </p>\n</li>\n</ul>\n<h6 id=\"2-4-4-1-1-4-Services\"><a href=\"#2-4-4-1-1-4-Services\" class=\"headerlink\" title=\"2.4.4.1.1.4 Services\"></a>2.4.4.1.1.4 Services</h6><p><code>Services</code>  init  init  init  <code>Services</code>  fork </p>\n<p><code>Services</code> </p>\n<p><code>Services</code> </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service &lt;name&gt; &lt;pathname&gt; [ &lt;argument&gt; ]*</span><br><span class=\"line\">   &lt;option&gt;</span><br><span class=\"line\">   &lt;option&gt;</span><br><span class=\"line\">   ...</span><br></pre></td></tr></table></figure>\n<p> Zygote 64 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service zygote &#x2F;system&#x2F;bin&#x2F;app_process64 -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server</span><br><span class=\"line\">    class main</span><br><span class=\"line\">    priority -20</span><br><span class=\"line\">    user root</span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\">    socket zygote stream 660 root system</span><br><span class=\"line\">    socket usap_pool_primary stream 660 root system</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;android_power&#x2F;request_state wake</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;power&#x2F;state on</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart netd</span><br><span class=\"line\">    onrestart restart wificond</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br></pre></td></tr></table></figure>\n<p><code>zygote</code>  <code>Services</code> <code>/system/bin/app_process64</code> <code>-Xzygote /system/bin --zygote --start-system-server</code>  <code>Options</code></p>\n<h6 id=\"2-4-4-1-1-5-Options\"><a href=\"#2-4-4-1-1-5-Options\" class=\"headerlink\" title=\"2.4.4.1.1.5 Options\"></a>2.4.4.1.1.5 Options</h6><p><code>Options</code>  <code>Services</code>  init  <code>Services</code> </p>\n<p>  <code>Options</code></p>\n<ul>\n<li><p><strong>class <name> [ <name>* ]</strong></p>\n<p> <code>Services</code>  <code>Services</code>  () <code>Services</code>  ()  default</p>\n</li>\n<li><p><strong>class_start <serviceclass></strong></p>\n<p> <code>serviceclass</code>  <code>Services</code></p>\n</li>\n<li><p><strong>priority <priority></strong></p>\n<p> <code>Services</code>  -20 ~ 19 0</p>\n</li>\n<li><p><strong>user <username></strong></p>\n<p> <code>Services</code>  root</p>\n</li>\n<li><p><strong>group <groupname> [ <groupname>* ]</strong></p>\n<p> <code>Services</code>  root</p>\n</li>\n<li><p><strong>socket <name> <type> <perm> [ <user> [ <group> [ <seclabel> ] ] ]</strong></p>\n<p> unix  socket <code>/dev/socket/&lt;name&gt;</code> socket </p>\n</li>\n<li><p><strong>onrestart</strong></p>\n<p> <code>Services</code>  <code>Commands</code></p>\n</li>\n<li><p><strong>oneshot</strong></p>\n<p> <code>Services</code> </p>\n</li>\n<li><p><strong>writepid <file> [ <file>* ]</strong></p>\n<p> fork  pid </p>\n</li>\n</ul>\n<h5 id=\"2-4-4-1-2--init-rc-\"><a href=\"#2-4-4-1-2--init-rc-\" class=\"headerlink\" title=\"2.4.4.1.2  init.rc \"></a>2.4.4.1.2  init.rc </h5><p> init.rc  <code>system/core/rootdir/init.rc</code></p>\n<p>  <code>Actions</code>  <code>Services</code>  init.rc  <code>Actions</code> [2.4.4.1.1.2]  <code>QueueEventTrigger()</code>   <code>Actions</code>   <code>Triggers</code> <code>Actions</code> </p>\n<h6 id=\"2-4-4-1-2-1-\"><a href=\"#2-4-4-1-2-1-\" class=\"headerlink\" title=\"2.4.4.1.2.1 \"></a>2.4.4.1.2.1 </h6><p> init  <code>system/core/init/init.cpp</code>  SecondStageMain </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  early-init  ActionManager</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Trigger all the boot actions to get us started.</span></span><br><span class=\"line\">    <span class=\"comment\">//  init  ActionManager</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Don&#x27;t mount filesystems or start core system services in charger mode.</span></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootmode = GetProperty(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  charger  ActionManager</span></span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  late-init  ActionManager</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ActionManager  [2.4.5.x]</p>\n<ul>\n<li>early-init -&gt; init -&gt; late-init</li>\n<li>early-init -&gt; init -&gt; charger</li>\n</ul>\n<p></p>\n<h6 id=\"2-4-4-1-2-2-init-rc-\"><a href=\"#2-4-4-1-2-2-init-rc-\" class=\"headerlink\" title=\"2.4.4.1.2.2 init.rc \"></a>2.4.4.1.2.2 init.rc </h6><!-- TODO: trigger boot -->\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on early-init</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    #  start  ueventd</span><br><span class=\"line\">    start ueventd</span><br><span class=\"line\"></span><br><span class=\"line\">    #  exec_start  apexd-bootstrap, ,  APEX </span><br><span class=\"line\">    exec_start apexd-bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\">on init</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    #  start </span><br><span class=\"line\">    #  servicemanager [2.4.4.1.2.3]</span><br><span class=\"line\">    start servicemanager</span><br><span class=\"line\">    start hwservicemanager</span><br><span class=\"line\">    start vndservicemanager</span><br><span class=\"line\"></span><br><span class=\"line\"># </span><br><span class=\"line\">#  trigger  [2.4.4.1.1.2]</span><br><span class=\"line\">on late-init</span><br><span class=\"line\">    trigger early-fs</span><br><span class=\"line\">    trigger fs</span><br><span class=\"line\">    trigger post-fs</span><br><span class=\"line\">    trigger late-fs</span><br><span class=\"line\">    trigger post-fs-data</span><br><span class=\"line\">    trigger load_persist_props_action</span><br><span class=\"line\"></span><br><span class=\"line\">    #  zygote-start,  zygote [2.4.4.1.2.4]</span><br><span class=\"line\">    trigger zygote-start</span><br><span class=\"line\"></span><br><span class=\"line\">    trigger firmware_mounts_complete</span><br><span class=\"line\">    trigger early-boot</span><br><span class=\"line\">    trigger boot</span><br></pre></td></tr></table></figure>\n<p> servicemanager  zygote </p>\n<h6 id=\"2-4-4-1-2-3--servicemanager\"><a href=\"#2-4-4-1-2-3--servicemanager\" class=\"headerlink\" title=\"2.4.4.1.2.3  servicemanager\"></a>2.4.4.1.2.3  servicemanager</h6><p>servicemanager  <code>frameworks/native/cmds/servicemanager/servicemanager.rc</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># servicemanager  Services </span><br><span class=\"line\"># &#x2F;system&#x2F;bin&#x2F;servicemanager </span><br><span class=\"line\">service servicemanager &#x2F;system&#x2F;bin&#x2F;servicemanager</span><br><span class=\"line\">    #  core  animation</span><br><span class=\"line\">    #  core  animation  () , servicemanager  ()</span><br><span class=\"line\">    class core animation</span><br><span class=\"line\"></span><br><span class=\"line\">    #  system</span><br><span class=\"line\">    user system</span><br><span class=\"line\"></span><br><span class=\"line\">    #  system  readproc</span><br><span class=\"line\">    group system readproc</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    # ,  bootloader</span><br><span class=\"line\">    critical</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    #  Commands</span><br><span class=\"line\">    onrestart restart healthd</span><br><span class=\"line\">    onrestart restart zygote</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart surfaceflinger</span><br><span class=\"line\">    onrestart restart inputflinger</span><br><span class=\"line\">    onrestart restart drm</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart keystore</span><br><span class=\"line\">    onrestart restart gatekeeperd</span><br><span class=\"line\">    onrestart restart thermalservice</span><br><span class=\"line\"></span><br><span class=\"line\">    #  fork  pid  &#x2F;dev&#x2F;cpuset&#x2F;system-background&#x2F;tasks</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;system-background&#x2F;tasks</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    # shutdown critical , </span><br><span class=\"line\">    shutdown critical</span><br></pre></td></tr></table></figure>\n<p> servicemanager  <code>frameworks/native/cmds/servicemanager/service_manager.c</code>  main </p>\n<h6 id=\"2-4-4-1-2-4--zygote\"><a href=\"#2-4-4-1-2-4--zygote\" class=\"headerlink\" title=\"2.4.4.1.2.4  zygote\"></a>2.4.4.1.2.4  zygote</h6><p> init.rc  <code>zygote-start</code>  3  <code>Actions</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unencrypted</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br><span class=\"line\"></span><br><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;unsupported</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br><span class=\"line\"></span><br><span class=\"line\">on zygote-start &amp;&amp; property:ro.crypto.state&#x3D;encrypted &amp;&amp; property:ro.crypto.type&#x3D;file</span><br><span class=\"line\">    exec_start update_verifier_nonencrypted</span><br><span class=\"line\">    start netd</span><br><span class=\"line\">    start zygote</span><br><span class=\"line\">    start zygote_secondary</span><br></pre></td></tr></table></figure>\n<p>zygote </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &#x2F;init.$&#123;ro.zygote&#125;.rc</span><br></pre></td></tr></table></figure>\n<p> <code>ro.zygote</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote32.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote32_64.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote64.rc</span><br><span class=\"line\">system&#x2F;core&#x2F;rootdir&#x2F;init.zygote64_32.rc</span><br></pre></td></tr></table></figure>\n<p>zygote  <code>zygote-start</code>  <code>Actions</code>  zygote</p>\n<p> Zygote 64  <code>system/core/rootdir/init.zygote64.rc</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># zygote  Services </span><br><span class=\"line\"># &#x2F;system&#x2F;bin&#x2F;app_process64 </span><br><span class=\"line\"># -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server </span><br><span class=\"line\">service zygote &#x2F;system&#x2F;bin&#x2F;app_process64 -Xzygote &#x2F;system&#x2F;bin --zygote --start-system-server</span><br><span class=\"line\">    #  main</span><br><span class=\"line\">    #  main  () , zygote  ()</span><br><span class=\"line\">    class main</span><br><span class=\"line\"></span><br><span class=\"line\">    #  -20</span><br><span class=\"line\">    #  -20 ~ 19, , ,  zygote </span><br><span class=\"line\">    priority -20</span><br><span class=\"line\"></span><br><span class=\"line\">    #  root</span><br><span class=\"line\">    user root</span><br><span class=\"line\">    group root readproc reserved_disk</span><br><span class=\"line\"></span><br><span class=\"line\">    #  socket</span><br><span class=\"line\">    socket zygote stream 660 root system</span><br><span class=\"line\">    socket usap_pool_primary stream 660 root system</span><br><span class=\"line\"></span><br><span class=\"line\">    # </span><br><span class=\"line\">    #  Commands</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;android_power&#x2F;request_state wake</span><br><span class=\"line\">    onrestart write &#x2F;sys&#x2F;power&#x2F;state on</span><br><span class=\"line\">    onrestart restart audioserver</span><br><span class=\"line\">    onrestart restart cameraserver</span><br><span class=\"line\">    onrestart restart media</span><br><span class=\"line\">    onrestart restart netd</span><br><span class=\"line\">    onrestart restart wificond</span><br><span class=\"line\"></span><br><span class=\"line\">    #  zygote  fork  pid  &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br><span class=\"line\">    writepid &#x2F;dev&#x2F;cpuset&#x2F;foreground&#x2F;tasks</span><br></pre></td></tr></table></figure>\n<p> zygote  <code>frameworks/base/cmds/app_process/app_main.cpp</code>  main </p>\n<h3 id=\"2-4-5-\"><a href=\"#2-4-5-\" class=\"headerlink\" title=\"2.4.5 \"></a>2.4.5 </h3><p>init  <code>system/core/init/init.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//  epoll </span></span><br><span class=\"line\">        <span class=\"comment\">// , ,  epoll_timeout  -1</span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> epoll_timeout = <span class=\"built_in\">std</span>::optional&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// am ,  ActionManager </span></span><br><span class=\"line\">            <span class=\"comment\">//  ActionManager  [2.4.5.1]</span></span><br><span class=\"line\">            am.ExecuteOneCommand();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(waiting_for_prop || Service::is_exec_service_running())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!shutting_down) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//  HandleProcessActions  [2.4.5.2]</span></span><br><span class=\"line\">                <span class=\"keyword\">auto</span> next_process_action_time = HandleProcessActions();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (next_process_action_time) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//  next_process_action_time </span></span><br><span class=\"line\">                    epoll_timeout = <span class=\"built_in\">std</span>::chrono::<span class=\"built_in\">ceil</span>&lt;<span class=\"built_in\">std</span>::chrono::milliseconds&gt;(</span><br><span class=\"line\">                            *next_process_action_time - boot_clock::now());</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//  0, </span></span><br><span class=\"line\">                    <span class=\"comment\">//  epoll  0,  Wait , </span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (*epoll_timeout &lt; <span class=\"number\">0</span>ms) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//  ActionManager ,  init , </span></span><br><span class=\"line\">            <span class=\"comment\">//  epoll  0,  Wait , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (am.HasMoreCommands()) epoll_timeout = <span class=\"number\">0</span>ms;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  Wait ,  [2.4.1.3]</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = epoll.Wait(epoll_timeout); !result) &#123;</span><br><span class=\"line\">            LOG(ERROR) &lt;&lt; result.error();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>init  3 </p>\n<ul>\n<li> ActionManager </li>\n<li></li>\n<li> epoll  init  init  <code>SIGCHLD</code> </li>\n</ul>\n<h4 id=\"2-4-5-1-ActionManager\"><a href=\"#2-4-5-1-ActionManager\" class=\"headerlink\" title=\"2.4.5.1 ActionManager\"></a>2.4.5.1 ActionManager</h4><!-- TODO:  Action? -->\n\n<!-- TODO: Action  Actions  -->\n\n<!-- TODO:  -->\n\n<p>ActionManager  Action  Action </p>\n<h5 id=\"2-4-5-1-1--Action\"><a href=\"#2-4-5-1-1--Action\" class=\"headerlink\" title=\"2.4.5.1.1  Action\"></a>2.4.5.1.1  Action</h5><!-- TODO:  Action  -->\n\n<p> init  Action Action </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">SecondStageMain</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>** argv)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// am ,  ActionManager </span></span><br><span class=\"line\">    ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(SetupCgroupsAction, <span class=\"string\">&quot;SetupCgroups&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  early-init [2.4.4.1.2.1]</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;early-init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  coldboot </span></span><br><span class=\"line\">    am.QueueBuiltinAction(wait_for_coldboot_done_action, <span class=\"string\">&quot;wait_for_coldboot_done&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetMmapRndBitsAction, <span class=\"string\">&quot;SetMmapRndBits&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(SetKptrRestrictAction, <span class=\"string\">&quot;SetKptrRestrict&quot;</span>);</span><br><span class=\"line\">    Keychords keychords;</span><br><span class=\"line\">    am.QueueBuiltinAction(</span><br><span class=\"line\">        [&amp;epoll, &amp;keychords](<span class=\"keyword\">const</span> BuiltinArguments&amp; args) -&gt; Result&lt;Success&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; svc : ServiceList::GetInstance()) &#123;</span><br><span class=\"line\">                keychords.Register(svc-&gt;keycodes());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            keychords.Start(&amp;epoll, HandleKeychord);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Success();</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;KeychordInit&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(console_init_action, <span class=\"string\">&quot;console_init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  init [2.4.4.1.2.1]</span></span><br><span class=\"line\">    am.QueueEventTrigger(<span class=\"string\">&quot;init&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    am.QueueBuiltinAction(StartBoringSslSelfTest, <span class=\"string\">&quot;StartBoringSslSelfTest&quot;</span>);</span><br><span class=\"line\">    am.QueueBuiltinAction(MixHwrngIntoLinuxRngAction, <span class=\"string\">&quot;MixHwrngIntoLinuxRng&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action:  init  binder</span></span><br><span class=\"line\">    am.QueueBuiltinAction(InitBinder, <span class=\"string\">&quot;InitBinder&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> bootmode = GetProperty(<span class=\"string\">&quot;ro.bootmode&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (bootmode == <span class=\"string\">&quot;charger&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  Action:  charger [2.4.4.1.2.1]</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;charger&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// ,  Action:  late-init [2.4.4.1.2.1]</span></span><br><span class=\"line\">        am.QueueEventTrigger(<span class=\"string\">&quot;late-init&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  Action: </span></span><br><span class=\"line\">    am.QueueBuiltinAction(queue_property_triggers_action, <span class=\"string\">&quot;queue_property_triggers&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> ActionManager  Action</p>\n<h4 id=\"2-4-5-2-HandleProcessActions\"><a href=\"#2-4-5-2-HandleProcessActions\" class=\"headerlink\" title=\"2.4.5.2 HandleProcessActions\"></a>2.4.5.2 HandleProcessActions</h4><!-- ((s->flags() & SVC_RUNNING) && s->timeout_period()) -->\n\n<!--  service  -->\n\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"built_in\">std</span>::optional&lt;boot_clock::time_point&gt; <span class=\"title\">HandleProcessActions</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::optional&lt;boot_clock::time_point&gt; next_process_action_time;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  ServiceList</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> <span class=\"keyword\">auto</span>&amp; s : ServiceList::GetInstance()) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((s-&gt;flags() &amp; SVC_RUNNING) &amp;&amp; s-&gt;timeout_period()) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">auto</span> timeout_time = s-&gt;time_started() + *s-&gt;timeout_period();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (boot_clock::now() &gt; timeout_time) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// , </span></span><br><span class=\"line\">                s-&gt;Timeout();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//  next_process_action_time</span></span><br><span class=\"line\">                <span class=\"comment\">// , next_process_action_time , </span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!next_process_action_time || timeout_time &lt; *next_process_action_time) &#123;</span><br><span class=\"line\">                    next_process_action_time = timeout_time;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//  SVC_RESTARTING, ,  for </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(s-&gt;flags() &amp; SVC_RESTARTING)) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// </span></span><br><span class=\"line\">        <span class=\"keyword\">auto</span> restart_time = s-&gt;time_started() + s-&gt;restart_period();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// , </span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (boot_clock::now() &gt; restart_time) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">auto</span> result = s-&gt;Start(); !result) &#123;</span><br><span class=\"line\">                LOG(ERROR) &lt;&lt; <span class=\"string\">&quot;Could not restart process &#x27;&quot;</span> &lt;&lt; s-&gt;name() &lt;&lt; <span class=\"string\">&quot;&#x27;: &quot;</span> &lt;&lt; result.error();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//  next_process_action_time</span></span><br><span class=\"line\">            <span class=\"comment\">// , next_process_action_time , </span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!next_process_action_time || restart_time &lt; *next_process_action_time) &#123;</span><br><span class=\"line\">                next_process_action_time = restart_time;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> next_process_action_time;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p></p>\n<ol>\n<li> <code>SVC_RUNNING</code>  <code>Timeout</code> </li>\n<li> <code>SVC_RESTARTING</code>  </li>\n</ol>\n<p><code>next_process_action_time</code> </p>\n<p> [2.4.3.1.4.3]  init  <code>SVC_RESTARTING</code> init  <code>SVC_RESTARTING</code> </p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p><a href=\"http://gityuan.com/2016/02/01/android-booting/\">Android-</a></p>\n<p><a href=\"http://gityuan.com/2016/02/05/android-init/\">Android-Init</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man7/epoll.7.html\">epoll(7)</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/Signal_(IPC)\">Signal</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man7/signal.7.html\">signal(7)</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man2/wait.2.html\">wait(2)</a></p>\n<p><a href=\"https://man7.org/linux/man-pages/man2/signalfd.2.html\">signalfd(2)</a></p>"}],"PostAsset":[{"_id":"source/_posts/2021-03-10-elementary-function/constant-function-example-1.png","slug":"constant-function-example-1.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/exponential-function-example-1.png","slug":"exponential-function-example-1.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/exponential-function-example-2.png","slug":"exponential-function-example-2.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/logarithmic-function-example-1.png","slug":"logarithmic-function-example-1.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/logarithmic-function-example-2.png","slug":"logarithmic-function-example-2.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/logarithmic-function-example-3.png","slug":"logarithmic-function-example-3.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-1.png","slug":"power-function-example-1.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-2.png","slug":"power-function-example-2.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-3.png","slug":"power-function-example-3.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-4.png","slug":"power-function-example-4.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-5.png","slug":"power-function-example-5.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-6.png","slug":"power-function-example-6.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0},{"_id":"source/_posts/2021-03-10-elementary-function/power-function-example-7.png","slug":"power-function-example-7.png","post":"ckmsyc4rc00075npr842r5mu3","modified":0,"renderable":0}],"PostCategory":[{"post_id":"ckmsyc4rc00075npr842r5mu3","category_id":"ckmsyc4re00095npr7a605gff","_id":"ckmsyc4ri000h5nprehnabbfb"},{"post_id":"ckmsyc4r400015nprahox2qqz","category_id":"ckmsyc4ra00055nprdp3d27gx","_id":"ckmsyc4rj000k5npr320783gc"},{"post_id":"ckmsyc4r400015nprahox2qqz","category_id":"ckmsyc4rh000f5npr8h940wmh","_id":"ckmsyc4rk000l5nprezqbgn2y"},{"post_id":"ckmsyc4rg000d5nprei90h7bk","category_id":"ckmsyc4ri000i5nprffv13va1","_id":"ckmsyc4rm000t5npr7w6738m6"},{"post_id":"ckmsyc4rg000d5nprei90h7bk","category_id":"ckmsyc4rk000m5npr6wjm0y3r","_id":"ckmsyc4rm000u5npr8r2oe4me"},{"post_id":"ckmsyc4rg000d5nprei90h7bk","category_id":"ckmsyc4rl000p5npr5xe96pw7","_id":"ckmsyc4rm000v5npr8nbdbd84"},{"post_id":"cksh4umd7000cqkprfer8avcg","category_id":"cksftg56z0001hlpr9ry98ndj","_id":"cksh4umd9000dqkpr88dfebo7"},{"post_id":"cksh4vd82000eqkpr503zbpok","category_id":"ckmsyc4ri000i5nprffv13va1","_id":"cksh4vd83000gqkpr7ibr1zwe"},{"post_id":"cksh4vtpi000hqkprcbem8gz5","category_id":"ckmsyc4ri000i5nprffv13va1","_id":"cksh4vtpk000iqkpr6e5khz3u"},{"post_id":"cksh4vtpi000hqkprcbem8gz5","category_id":"ckmsyc4rk000m5npr6wjm0y3r","_id":"cksh4vtpk000jqkpreg0bgv4h"},{"post_id":"cksh4vtpi000hqkprcbem8gz5","category_id":"ckrzsw20000076spr2i0g1ol0","_id":"cksh4vtpk000kqkpr65034ih4"},{"post_id":"cksh4x6tu000lqkprd6fo4ta8","category_id":"ckmsyc4ri000i5nprffv13va1","_id":"cksh4x6tw000nqkprclpo6mli"},{"post_id":"cksol4flf00000cprd5ks579o","category_id":"ckmsyc4ri000i5nprffv13va1","_id":"cksol4fli00010cpr5tmrc70r"},{"post_id":"ckvt7aq4g0000elpre24685ab","category_id":"ckmsyc4ri000i5nprffv13va1","_id":"ckvt7aq4o0006elpr646t3y4w"},{"post_id":"ckvt7aq4g0000elpre24685ab","category_id":"ckmsyc4rk000m5npr6wjm0y3r","_id":"ckvt7aq4p0008elpr7y0ralia"},{"post_id":"ckvt7aq4g0000elpre24685ab","category_id":"ckmsyc4rl000o5npr0v7gbch2","_id":"ckvt7aq4p000aelprdp0f43dy"},{"post_id":"ckvt7aq4k0001elprgcal1w0y","category_id":"ckoifpt4j0006m1pr7zm18tlb","_id":"ckvt7aq4p000belpr8c5ohhed"},{"post_id":"ckvt7aq4m0003elpr3t86bkmy","category_id":"ckoifpt4j0006m1pr7zm18tlb","_id":"ckvt7aq4p000celpr0ica8k3i"},{"post_id":"ckvt7ngc6000felprc7r9ejwx","category_id":"ckmsyc4ri000i5nprffv13va1","_id":"ckvt7ngc7000gelprhm6gfx5v"}],"PostTag":[{"post_id":"ckmsyc4rd00085npr5cpiccvy","tag_id":"ckmsyc4rc00065nprab0eb47i","_id":"ckmsyc4rg000c5npr9dhff62k"},{"post_id":"ckmsyc4r700035npr5dbfdrkh","tag_id":"ckmsyc4rc00065nprab0eb47i","_id":"ckmsyc4rh000e5npr4ww55qqb"},{"post_id":"ckmsyc4r900045nprbgj32va1","tag_id":"ckmsyc4rf000b5npr0usmgdhg","_id":"ckmsyc4rh000g5npr28u2f6vd"},{"post_id":"cksh4vd82000eqkpr503zbpok","tag_id":"ckrzsw1zu00016spr8o8bfriv","_id":"cksh4vd83000fqkpr9fr9h451"},{"post_id":"cksh4x6tu000lqkprd6fo4ta8","tag_id":"ckrzsw1zu00016spr8o8bfriv","_id":"cksh4x6tw000mqkprfbq3cfzj"},{"post_id":"ckvt7aq4g0000elpre24685ab","tag_id":"ckmue52pw00015hpr5k9idsoy","_id":"ckvt7aq4m0002elprcutjfte4"},{"post_id":"ckvt7aq4k0001elprgcal1w0y","tag_id":"ckmue52pz00025hprh9my49dd","_id":"ckvt7aq4n0004elpr4byq0zw9"},{"post_id":"ckvt7aq4k0001elprgcal1w0y","tag_id":"ckmue52pw00015hpr5k9idsoy","_id":"ckvt7aq4o0005elpr7gurg1dd"},{"post_id":"ckvt7aq4m0003elpr3t86bkmy","tag_id":"ckmue52pz00025hprh9my49dd","_id":"ckvt7aq4p0007elpr0iwmah7s"},{"post_id":"ckvt7aq4m0003elpr3t86bkmy","tag_id":"ckmue52pw00015hpr5k9idsoy","_id":"ckvt7aq4p0009elpr5jupdxw0"}],"Tag":[{"name":"Test","_id":"ckmsyc4rc00065nprab0eb47i"},{"name":"ComputerScience","_id":"ckmsyc4rf000b5npr0usmgdhg"},{"name":"Graphics","_id":"ckmue52pw00015hpr5k9idsoy"},{"name":"Basis","_id":"ckmue52pz00025hprh9my49dd"},{"name":"Zygote","_id":"ckrzsw1zu00016spr8o8bfriv"}]}}